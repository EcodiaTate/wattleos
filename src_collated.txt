

===== D:\.code\wattleos\src\app\(app)\admin\appearance\page.tsx =====

// src/app/(app)/admin/appearance/page.tsx
//
// ============================================================
// WattleOS V2 â€” Admin: School Appearance Settings
// ============================================================
// Permission-gated to MANAGE_TENANT_SETTINGS.
// Allows admins to configure brand color, default density,
// and default theme for their entire school.
//
// WHY a separate page from /admin/settings:
//   Appearance is conceptually distinct from operational settings
//   (timezone, billing, etc.) and benefits from a live preview.
// ============================================================

import { AppearanceSettingsClient } from "@/components/domain/admin/appearance-settings-client";
import { getTenantDisplaySettings } from "@/lib/actions/display-settings";
import { getTenantContext, hasPermission } from "@/lib/auth/tenant-context";
import { Permissions } from "@/lib/constants/permissions";
import { redirect } from "next/navigation";

export const metadata = {
  title: "School Appearance",
};

export default async function AppearancePage() {
  const context = await getTenantContext();

  if (!hasPermission(context, Permissions.MANAGE_TENANT_SETTINGS)) {
    redirect("/dashboard");
  }

  const result = await getTenantDisplaySettings();
  const settings = result.data ?? {
    brandHue: null,
    brandSaturation: null,
    defaultDensity: "comfortable" as const,
    defaultTheme: "light" as const,
    faviconUrl: null,
  };

  return (
    <div className="space-y-[var(--density-section-gap)]">
      <div>
        <h1 className="text-[var(--text-2xl)] font-semibold text-foreground">
          School Appearance
        </h1>
        <p className="mt-1 text-[var(--text-sm)] text-muted-foreground">
          Customise how WattleOS looks for everyone at {context.tenant.name}.
          Individual users can override theme and density in their own settings.
        </p>
      </div>

      <AppearanceSettingsClient initialSettings={settings} />
    </div>
  );
}



===== D:\.code\wattleos\src\app\(app)\admin\billing\page.tsx =====

// src/app/(app)/admin/billing/page.tsx
//
// ============================================================
// WattleOS V2 - Admin: Billing Dashboard
// ============================================================
// Server Component. Permission-gated to MANAGE_INTEGRATIONS.
// Loads invoices, fee schedules, and student/guardian data for
// the billing management UI.
// ============================================================

import { getTenantContext, hasPermission } from "@/lib/auth/tenant-context";
import { Permissions } from "@/lib/constants/permissions";
import { listInvoices, listFeeSchedules } from "@/lib/actions/billing";
import { redirect } from "next/navigation";
import { createSupabaseServerClient } from "@/lib/supabase/server";
import { BillingDashboardClient } from "@/components/domain/billing/billing-dashboard-client";

export default async function BillingPage() {
  const context = await getTenantContext();

  if (!hasPermission(context, Permissions.MANAGE_INTEGRATIONS)) {
    redirect("/dashboard");
  }

  // Load data in parallel
  const [invoicesResult, feeSchedulesResult, supabase] = await Promise.all([
    listInvoices(),
    listFeeSchedules(),
    createSupabaseServerClient(),
  ]);

  // Load students with active enrollments + their guardians for invoice creation
  const { data: studentsRaw } = await supabase
    .from("students")
    .select(
      `
      id, first_name, last_name,
      guardians(
        id, relationship, user_id,
        user:users(id, first_name, last_name, email)
      )
    `
    )
    .eq("enrollment_status", "active")
    .is("deleted_at", null)
    .order("last_name");

  // Normalize the raw PostgREST shape (user sometimes comes back as an array)
  const students: StudentWithGuardians[] = (studentsRaw ?? []).map((s: any) => {
    const guardians = Array.isArray(s.guardians) ? s.guardians : [];

    const normalizedGuardians: StudentWithGuardians["guardians"] = guardians
      .map((g: any) => {
        const u = Array.isArray(g.user) ? g.user[0] : g.user; // <-- fix: array -> single
        if (!u) return null;

        return {
          id: String(g.id),
          relationship: String(g.relationship ?? ""),
          user_id: String(g.user_id ?? ""),
          user: {
            id: String(u.id),
            first_name: u.first_name ?? null,
            last_name: u.last_name ?? null,
            email: String(u.email ?? ""),
          },
        };
      })
      .filter(Boolean) as StudentWithGuardians["guardians"];

    return {
      id: String(s.id),
      first_name: String(s.first_name ?? ""),
      last_name: String(s.last_name ?? ""),
      guardians: normalizedGuardians,
    };
  });

  // Load classes for fee schedule linking
  const { data: classesRaw } = await supabase
    .from("classes")
    .select("id, name, cycle_level")
    .eq("is_active", true)
    .is("deleted_at", null)
    .order("name");

  const classes: ClassOption[] = (classesRaw ?? []).map((c: any) => ({
    id: String(c.id),
    name: String(c.name ?? ""),
    cycle_level: c.cycle_level ?? null,
  }));

  return (
    <div className="space-y-6">
      <div>
        <h1 className="text-2xl font-semibold text-gray-900">Billing</h1>
        <p className="mt-1 text-sm text-gray-500">
          Manage tuition fees, create invoices, and track payments.
        </p>
      </div>

      <BillingDashboardClient
        invoices={invoicesResult.data ?? []}
        feeSchedules={feeSchedulesResult.data ?? []}
        students={students}
        classes={classes}
        currency={context.tenant.currency.toLowerCase()}
      />
    </div>
  );
}

// Local types for the page data shape
interface StudentWithGuardians {
  id: string;
  first_name: string;
  last_name: string;
  guardians: Array<{
    id: string;
    relationship: string;
    user_id: string;
    user: {
      id: string;
      first_name: string | null;
      last_name: string | null;
      email: string;
    };
  }>;
}

interface ClassOption {
  id: string;
  name: string;
  cycle_level: string | null;
}



===== D:\.code\wattleos\src\app\(app)\admin\integrations\page.tsx =====

// src/app/(app)/admin/integrations/page.tsx
//
// ============================================================
// WattleOS V2 - Admin: Integration Settings
// ============================================================
// Server Component. Permission-gated to MANAGE_INTEGRATIONS.
// Shows all available integrations as cards with enable/disable
// toggle and configuration status.
// ============================================================

import { getTenantContext, hasPermission } from '@/lib/auth/tenant-context';
import { Permissions } from '@/lib/constants/permissions';
import { listIntegrationConfigs } from '@/lib/actions/integrations';
import { redirect } from 'next/navigation';
import { IntegrationDashboardClient } from '@/components/domain/admin/integration-dashboard-client';

export default async function IntegrationsPage() {
  const context = await getTenantContext();

  if (!hasPermission(context, Permissions.MANAGE_INTEGRATIONS)) {
    redirect('/dashboard');
  }

  const result = await listIntegrationConfigs();
  const configs = result.data ?? [];

  return (
    <div className="space-y-6">
      <div>
        <h1 className="text-2xl font-semibold text-gray-900">Integrations</h1>
        <p className="mt-1 text-sm text-gray-500">
          Connect WattleOS to external services for billing, storage, and payroll.
        </p>
      </div>

      <IntegrationDashboardClient existingConfigs={configs} />
    </div>
  );
}


===== D:\.code\wattleos\src\app\(app)\admin\page.tsx =====

// src/app/(app)/admin/page.tsx
//
// ============================================================
// WattleOS V2 - Admin Settings Landing Page
// ============================================================
// Permission-gated. Shows cards linking to admin sub-sections:
// integrations, user management, tenant settings, timesheet
// approvals, and payroll configuration.
//
// MODIFIED IN PHASE 9c: Added Timesheet Approvals card
// (gated on APPROVE_TIMESHEETS) and Payroll Settings card
// (gated on MANAGE_INTEGRATIONS).
// ============================================================

import { getTenantContext, hasPermission } from '@/lib/auth/tenant-context';
import { Permissions } from '@/lib/constants/permissions';
import { redirect } from 'next/navigation';
import Link from 'next/link';

export default async function AdminPage() {
  const context = await getTenantContext();

  const canManageUsers = hasPermission(context, Permissions.MANAGE_USERS);
  const canManageTenant = hasPermission(context, Permissions.MANAGE_TENANT_SETTINGS);
  const canManageIntegrations = hasPermission(context, Permissions.MANAGE_INTEGRATIONS);
  const canApproveTimesheets = hasPermission(context, Permissions.APPROVE_TIMESHEETS);

  if (!canManageUsers && !canManageTenant && !canManageIntegrations && !canApproveTimesheets) {
    redirect('/dashboard');
  }

  const cards: Array<{
    label: string;
    description: string;
    href: string;
    icon: string;
    visible: boolean;
  }> = [
    {
      label: 'Integrations',
      description: 'Connect Google Drive, Stripe, Xero, and other services.',
      href: '/admin/integrations',
      icon: 'ðŸ”Œ',
      visible: canManageIntegrations,
    },
    {
      label: 'User Management',
      description: 'Manage staff accounts, roles, and permissions.',
      href: '/admin/users',
      icon: 'ðŸ‘¥',
      visible: canManageUsers,
    },
    {
      label: 'School Settings',
      description: 'School name, logo, timezone, and billing plan.',
      href: '/admin/settings',
      icon: 'ðŸ«',
      visible: canManageTenant,
    },
    {
      label: 'School Branding',
      description: 'Colours, fonts, spacing.',
      href: '/admin/appearance',
      icon: 'ðŸ«',
      visible: canManageTenant,
    },
    // Phase 9c: Timesheet Approvals
    // WHY here: Approvers (Head of School) need quick access to
    // pending timesheets from the admin hub.
    {
      label: 'Timesheet Approvals',
      description: 'Review and approve staff timesheets and manage pay periods.',
      href: '/admin/timesheets',
      icon: 'â±ï¸',
      visible: canApproveTimesheets,
    },
    // Phase 9c: Payroll Settings
    // WHY separate card: Payroll config (frequency, defaults, provider)
    // is a distinct concern from timesheet approval workflow.
    {
      label: 'Payroll Settings',
      description: 'Pay frequency, default hours, provider integration, and employee mapping.',
      href: '/admin/settings/payroll',
      icon: 'ðŸ’°',
      visible: canManageIntegrations,
    },
  ];

  const visibleCards = cards.filter((c) => c.visible);

  return (
    <div className="space-y-6">
      <div>
        <h1 className="text-2xl font-semibold text-gray-900">Settings</h1>
        <p className="mt-1 text-sm text-gray-500">
          Manage your school&apos;s configuration and integrations.
        </p>
      </div>

      <div className="grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-3">
        {visibleCards.map((card) => (
          <Link
            key={card.href}
            href={card.href}
            className="group rounded-lg border border-gray-200 bg-white p-6 shadow-sm transition-all hover:border-amber-300 hover:shadow-md"
          >
            <span className="text-2xl">{card.icon}</span>
            <h3 className="mt-3 text-sm font-semibold text-gray-900 group-hover:text-amber-700">
              {card.label}
            </h3>
            <p className="mt-1 text-xs text-gray-500">{card.description}</p>
          </Link>
        ))}
      </div>
    </div>
  );
}


===== D:\.code\wattleos\src\app\(app)\admin\settings\payroll\page.tsx =====

// src/app/(app)/admin/settings/payroll/page.tsx
//
// ============================================================
// WattleOS V2 - Payroll Settings Page
// ============================================================
// Server Component. Admin can configure:
//   â€¢ Pay frequency (weekly/fortnightly/monthly)
//   â€¢ Cycle start day
//   â€¢ Default work hours (start, end, break)
//   â€¢ Payroll provider (None/Xero/KeyPay)
//   â€¢ Auto-create periods toggle
//
// WHY separate from general settings: Payroll config is
// complex enough to warrant its own page and is gated to
// MANAGE_INTEGRATIONS rather than MANAGE_TENANT_SETTINGS.
// ============================================================

import { getTenantContext, hasPermission } from '@/lib/auth/tenant-context';
import { Permissions } from '@/lib/constants/permissions';
import { redirect } from 'next/navigation';
import { getPayrollSettings } from '@/lib/actions/payroll-integration';
import { PayrollSettingsClient } from '@/components/domain/timesheets/payroll-settings-client';
import Link from 'next/link';
import type { PayrollSettings } from '@/types/domain';

export default async function PayrollSettingsPage() {
  const context = await getTenantContext();

  if (!hasPermission(context, Permissions.MANAGE_INTEGRATIONS)) {
    redirect('/dashboard');
  }

  const settingsResult = await getPayrollSettings();
  const settings: PayrollSettings | null = settingsResult.data ?? null;

  return (
    <div className="mx-auto max-w-3xl space-y-6">
      {/* Header */}
      <div>
        <nav className="flex items-center gap-2 text-sm text-gray-500">
          <Link href="/admin" className="hover:text-gray-700">Settings</Link>
          <span>/</span>
          <span className="text-gray-900">Payroll</span>
        </nav>
        <h1 className="mt-1 text-2xl font-bold text-gray-900">Payroll Settings</h1>
        <p className="mt-1 text-sm text-gray-500">
          Configure pay cycles, default work hours, and payroll integration
        </p>
      </div>

      {/* Quick links */}
      <div className="flex flex-wrap gap-3">
        <Link
          href="/admin/timesheets"
          className="inline-flex items-center gap-2 rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50"
        >
          <svg className="h-4 w-4" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor">
            <path strokeLinecap="round" strokeLinejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
          </svg>
          Approvals
        </Link>
        <Link
          href="/admin/timesheets/periods"
          className="inline-flex items-center gap-2 rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50"
        >
          <svg className="h-4 w-4" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor">
            <path strokeLinecap="round" strokeLinejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 0 1 2.25-2.25h13.5A2.25 2.25 0 0 1 21 7.5v11.25m-18 0A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75m-18 0v-7.5A2.25 2.25 0 0 1 5.25 9h13.5A2.25 2.25 0 0 1 21 11.25v7.5" />
          </svg>
          Pay Periods
        </Link>
        <Link
          href="/admin/settings/payroll/employees"
          className="inline-flex items-center gap-2 rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50"
        >
          <svg className="h-4 w-4" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor">
            <path strokeLinecap="round" strokeLinejoin="round" d="M15 19.128a9.38 9.38 0 0 0 2.625.372 9.337 9.337 0 0 0 4.121-.952 4.125 4.125 0 0 0-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 0 1 8.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0 1 11.964-3.07M12 6.375a3.375 3.375 0 1 1-6.75 0 3.375 3.375 0 0 1 6.75 0Zm8.25 2.25a2.625 2.625 0 1 1-5.25 0 2.625 2.625 0 0 1 5.25 0Z" />
          </svg>
          Employee Mapping
        </Link>
      </div>

      {/* Settings form */}
      {settings ? (
        <PayrollSettingsClient settings={settings} />
      ) : (
        <div className="rounded-lg border border-red-200 bg-red-50 p-4 text-sm text-red-800">
          Failed to load payroll settings. Please try refreshing the page.
        </div>
      )}
    </div>
  );
}


===== D:\.code\wattleos\src\app\(app)\admin\timesheets\page.tsx =====

// src/app/(app)/admin/timesheets/page.tsx
//
// ============================================================
// WattleOS V2 - Admin Timesheet Approvals Page
// ============================================================
// Server Component. Lists submitted timesheets grouped by pay
// period. Approvers can view details, approve, or reject with
// notes. Batch approve is supported for efficiency.
//
// WHY Server Component shell: Fetches pending timesheets and
// pay period context on the server, then hands to an interactive
// client component for approve/reject actions.
// ============================================================

import { getTenantContext, hasPermission } from "@/lib/auth/tenant-context";
import { Permissions } from "@/lib/constants/permissions";
import { redirect } from "next/navigation";
import { listPendingTimesheets } from "@/lib/actions/timesheets";
import { listPayPeriods } from "@/lib/actions/pay-periods";
import { PendingApprovalsClient } from "@/components/domain/timesheets/pending-approvals-client";
import Link from "next/link";
import type { PayPeriod } from "@/types/domain";

type PendingResult = Awaited<ReturnType<typeof listPendingTimesheets>>;
type PendingTimesheet = NonNullable<PendingResult["data"]>[number];

export default async function AdminTimesheetsPage() {
  const context = await getTenantContext();

  if (!hasPermission(context, Permissions.APPROVE_TIMESHEETS)) {
    redirect("/dashboard");
  }

  const [pendingResult, periodsResult] = await Promise.all([
    listPendingTimesheets(),
    listPayPeriods({ perPage: 5 }),
  ]);

  const pendingTimesheets: PendingTimesheet[] = pendingResult.data ?? [];
  const recentPeriods: PayPeriod[] = periodsResult.data?.periods ?? [];

  // Group timesheets by pay period for display
  const groupedByPeriod: Record<
    string,
    {
      period: PayPeriod | null;
      timesheets: PendingTimesheet[];
    }
  > = {};

  for (const ts of pendingTimesheets) {
    const periodId = ts.pay_period_id;

    if (!groupedByPeriod[periodId]) {
      const period = recentPeriods.find((p) => p.id === periodId) ?? null;
      groupedByPeriod[periodId] = { period, timesheets: [] };
    }

    groupedByPeriod[periodId].timesheets.push(ts);
  }

  const canManageIntegrations = hasPermission(
    context,
    Permissions.MANAGE_INTEGRATIONS
  );

  return (
    <div className="mx-auto max-w-5xl space-y-6">
      {/* Header */}
      <div className="flex items-center justify-between">
        <div>
          <nav className="flex items-center gap-2 text-sm text-gray-500">
            <Link href="/admin" className="hover:text-gray-700">
              Settings
            </Link>
            <span>/</span>
            <span className="text-gray-900">Timesheet Approvals</span>
          </nav>
          <h1 className="mt-1 text-2xl font-bold text-gray-900">
            Timesheet Approvals
          </h1>
          <p className="mt-1 text-sm text-gray-500">
            Review and approve staff timesheets
          </p>
        </div>

        <div className="flex items-center gap-3">
          <Link
            href="/admin/timesheets/periods"
            className="inline-flex items-center gap-2 rounded-lg border border-gray-300 bg-white px-4 py-2.5 text-sm font-medium text-gray-700 shadow-sm transition-colors hover:bg-gray-50"
          >
            <svg
              className="h-4 w-4"
              fill="none"
              viewBox="0 0 24 24"
              strokeWidth={1.5}
              stroke="currentColor"
            >
              <path
                strokeLinecap="round"
                strokeLinejoin="round"
                d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 0 1 2.25-2.25h13.5A2.25 2.25 0 0 1 21 7.5v11.25m-18 0A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75m-18 0v-7.5A2.25 2.25 0 0 1 5.25 9h13.5A2.25 2.25 0 0 1 21 11.25v7.5"
              />
            </svg>
            Pay Periods
          </Link>

          {canManageIntegrations && (
            <Link
              href="/admin/settings/payroll"
              className="inline-flex items-center gap-2 rounded-lg border border-gray-300 bg-white px-4 py-2.5 text-sm font-medium text-gray-700 shadow-sm transition-colors hover:bg-gray-50"
            >
              <svg
                className="h-4 w-4"
                fill="none"
                viewBox="0 0 24 24"
                strokeWidth={1.5}
                stroke="currentColor"
              >
                <path
                  strokeLinecap="round"
                  strokeLinejoin="round"
                  d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.325.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 0 1 1.37.49l1.296 2.247a1.125 1.125 0 0 1-.26 1.431l-1.003.827c-.293.241-.438.613-.43.992a7.723 7.723 0 0 1 0 .255c-.008.378.137.75.43.991l1.004.827c.424.35.534.955.26 1.43l-1.298 2.247a1.125 1.125 0 0 1-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.47 6.47 0 0 1-.22.128c-.331.183-.581.495-.644.869l-.213 1.281c-.09.543-.56.94-1.11.94h-2.594c-.55 0-1.019-.398-1.11-.94l-.213-1.281c-.062-.374-.312-.686-.644-.87a6.52 6.52 0 0 1-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 0 1-1.369-.49l-1.297-2.247a1.125 1.125 0 0 1 .26-1.431l1.004-.827c.292-.24.437-.613.43-.991a6.932 6.932 0 0 1 0-.255c.007-.38-.138-.751-.43-.992l-1.004-.827a1.125 1.125 0 0 1-.26-1.43l1.297-2.247a1.125 1.125 0 0 1 1.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.086.22-.128.332-.183.582-.495.644-.869l.214-1.28Z"
                />
                <path
                  strokeLinecap="round"
                  strokeLinejoin="round"
                  d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z"
                />
              </svg>
              Payroll Settings
            </Link>
          )}
        </div>
      </div>

      {/* Summary stats */}
      <div className="grid grid-cols-1 gap-4 sm:grid-cols-3">
        <div className="rounded-lg border border-gray-200 bg-white p-4">
          <p className="text-sm text-gray-500">Pending Approval</p>
          <p className="mt-1 text-2xl font-bold text-amber-600">
            {pendingTimesheets.length}
          </p>
        </div>

        <div className="rounded-lg border border-gray-200 bg-white p-4">
          <p className="text-sm text-gray-500">Total Hours (Pending)</p>
          <p className="mt-1 text-2xl font-bold text-gray-900">
            {pendingTimesheets
              .reduce((sum, ts) => sum + (ts.total_hours ?? 0), 0)
              .toFixed(1)}
          </p>
        </div>

        <div className="rounded-lg border border-gray-200 bg-white p-4">
          <p className="text-sm text-gray-500">Pay Periods With Submissions</p>
          <p className="mt-1 text-2xl font-bold text-gray-900">
            {Object.keys(groupedByPeriod).length}
          </p>
        </div>
      </div>

      {/* Pending timesheets */}
      {pendingTimesheets.length === 0 ? (
        <div className="rounded-lg border border-gray-200 bg-white p-12 text-center">
          <svg
            className="mx-auto h-12 w-12 text-gray-300"
            fill="none"
            viewBox="0 0 24 24"
            strokeWidth={1}
            stroke="currentColor"
          >
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"
            />
          </svg>
          <p className="mt-4 text-sm font-medium text-gray-900">All caught up</p>
          <p className="mt-1 text-sm text-gray-500">
            No timesheets waiting for approval right now.
          </p>
        </div>
      ) : (
        <PendingApprovalsClient groupedByPeriod={groupedByPeriod as any} />
      )}
    </div>
  );
}



===== D:\.code\wattleos\src\app\(app)\admin\timesheets\periods\page.tsx =====

// src/app/(app)/admin/timesheets/periods/page.tsx
//
// ============================================================
// WattleOS V2 - Pay Period Management Page
// ============================================================
// Server Component. Lists all pay periods with status badges.
// Admin can create new periods, lock open periods, and see
// sync status. Pay periods are explicit records because they
// handle edge cases (holidays, mid-cycle starts) that pure
// date arithmetic cannot.
// ============================================================

import { getTenantContext, hasPermission } from '@/lib/auth/tenant-context';
import { Permissions } from '@/lib/constants/permissions';
import { redirect } from 'next/navigation';
import { listPayPeriods } from '@/lib/actions/pay-periods';
import { getPayrollSettings } from '@/lib/actions/payroll-integration';
import { PayPeriodManagementClient } from '@/components/domain/timesheets/pay-period-management-client';
import Link from 'next/link';
import type { PayPeriod, PayrollSettings } from '@/types/domain';

export default async function PayPeriodManagementPage() {
  const context = await getTenantContext();

  if (!hasPermission(context, Permissions.APPROVE_TIMESHEETS)) {
    redirect('/dashboard');
  }

  const [periodsResult, settingsResult] = await Promise.all([
    listPayPeriods({ perPage: 50 }),
    getPayrollSettings(),
  ]);

  const periods: PayPeriod[] = periodsResult.data?.periods ?? [];
  const settings: PayrollSettings | null = settingsResult.data ?? null;
  const canManageIntegrations = hasPermission(context, Permissions.MANAGE_INTEGRATIONS);

  return (
    <div className="mx-auto max-w-4xl space-y-6">
      {/* Header */}
      <div className="flex items-center justify-between">
        <div>
          <nav className="flex items-center gap-2 text-sm text-gray-500">
            <Link href="/admin" className="hover:text-gray-700">Settings</Link>
            <span>/</span>
            <Link href="/admin/timesheets" className="hover:text-gray-700">Timesheets</Link>
            <span>/</span>
            <span className="text-gray-900">Pay Periods</span>
          </nav>
          <h1 className="mt-1 text-2xl font-bold text-gray-900">Pay Periods</h1>
          <p className="mt-1 text-sm text-gray-500">
            Manage pay cycles for timesheet submissions
          </p>
        </div>
        <Link
          href="/admin/timesheets"
          className="inline-flex items-center gap-2 rounded-lg border border-gray-300 bg-white px-4 py-2.5 text-sm font-medium text-gray-700 shadow-sm transition-colors hover:bg-gray-50"
        >
          <svg className="h-4 w-4" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor">
            <path strokeLinecap="round" strokeLinejoin="round" d="M9 15 3 9m0 0 6-6M3 9h12a6 6 0 0 1 0 12h-3" />
          </svg>
          Back to Approvals
        </Link>
      </div>

      <PayPeriodManagementClient
        periods={periods}
        defaultFrequency={settings?.pay_frequency ?? 'fortnightly'}
        canCreate={canManageIntegrations}
      />
    </div>
  );
}


===== D:\.code\wattleos\src\app\(app)\attendance\absences\page.tsx =====

// src/app/(app)/attendance/absences/page.tsx
//
// ============================================================
// WattleOS V2 - Absence Report Page
// ============================================================
// Shows absent/late records with filtering for unexplained
// absences. Regulatory requirement: Australian schools must
// follow up on unexplained absences within 3 days.
// ============================================================

import { getTenantContext, hasPermission } from '@/lib/auth/tenant-context';
import { Permissions } from '@/lib/constants/permissions';
import { listClasses } from '@/lib/actions/classes';
import { redirect } from 'next/navigation';
import Link from 'next/link';
import { AbsenceReportClient } from '@/components/domain/attendance/absence-report-client';

export default async function AbsenceReportPage() {
  const context = await getTenantContext();

  if (!hasPermission(context, Permissions.VIEW_ATTENDANCE_REPORTS)) {
    redirect('/dashboard');
  }

  const classesResult = await listClasses();
  const classes = (classesResult.data ?? []).filter((c) => c.is_active);

  return (
    <div className="mx-auto max-w-5xl space-y-6">
      <div className="flex items-center justify-between">
        <div>
          <nav className="flex items-center gap-2 text-sm text-gray-500">
            <Link href="/attendance" className="hover:text-gray-700">
              Attendance
            </Link>
            <span>/</span>
            <span className="text-gray-900">Absence Report</span>
          </nav>
          <h1 className="mt-1 text-xl font-bold text-gray-900">
            Absence Report
          </h1>
          <p className="mt-1 text-sm text-gray-500">
            Track and follow up on unexplained absences.
          </p>
        </div>
        <Link
          href="/attendance/history"
          className="rounded-lg border border-gray-300 px-3 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50"
        >
          Full History
        </Link>
      </div>

      <AbsenceReportClient
        classes={classes.map((c) => ({
          id: c.id,
          name: c.name,
        }))}
      />
    </div>
  );
}


===== D:\.code\wattleos\src\app\(app)\attendance\history\page.tsx =====

// src/app/(app)/attendance/history/page.tsx
//
// ============================================================
// WattleOS V2 - Attendance History Page
// ============================================================
// Server Component with client-side filtering. Shows attendance
// records for a class over a date range, with summary stats.
//
// WHY separate from roll call: Roll call is today's workflow.
// History is a reporting/review tool - different mental model,
// different layout (table vs tap-to-mark).
// ============================================================

import { getTenantContext, hasPermission } from '@/lib/auth/tenant-context';
import { Permissions } from '@/lib/constants/permissions';
import { listClasses } from '@/lib/actions/classes';
import { redirect } from 'next/navigation';
import Link from 'next/link';
import { AttendanceHistoryClient } from '@/components/domain/attendance/attendance-history-client';

export default async function AttendanceHistoryPage() {
  const context = await getTenantContext();

  if (
    !hasPermission(context, Permissions.MANAGE_ATTENDANCE) &&
    !hasPermission(context, Permissions.VIEW_ATTENDANCE_REPORTS)
  ) {
    redirect('/dashboard');
  }

  const classesResult = await listClasses();
  const classes = (classesResult.data ?? []).filter((c) => c.is_active);

  return (
    <div className="mx-auto max-w-5xl space-y-6">
      {/* Breadcrumb */}
      <div className="flex items-center justify-between">
        <div>
          <nav className="flex items-center gap-2 text-sm text-gray-500">
            <Link href="/attendance" className="hover:text-gray-700">
              Attendance
            </Link>
            <span>/</span>
            <span className="text-gray-900">History</span>
          </nav>
          <h1 className="mt-1 text-xl font-bold text-gray-900">
            Attendance History
          </h1>
        </div>
        <Link
          href="/attendance/absences"
          className="rounded-lg border border-gray-300 px-3 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50"
        >
          Absence Report
        </Link>
      </div>

      <AttendanceHistoryClient
        classes={classes.map((c) => ({
          id: c.id,
          name: c.name,
          room: c.room,
          cycleLevel: c.cycle_level,
        }))}
      />
    </div>
  );
}


===== D:\.code\wattleos\src\app\(app)\attendance\page.tsx =====

// src/app/(app)/attendance/page.tsx
//
// ============================================================
// WattleOS V2 - Attendance Page (Roll Call Landing)
// ============================================================
// Server Component. Loads available classes for the current
// tenant, then renders the interactive RollCallClient.
//
// The guide's workflow:
// 1. Arrive at /attendance (linked from sidebar + dashboard)
// 2. Select their class (defaults to first if only one)
// 3. See today's date (can change)
// 4. Tap each student's status
// 5. Submit
//
// WHY server component wrapper: Class list is a static query
// that doesn't need client-side interactivity. Keeping it in
// a server component avoids shipping the Supabase client to
// the browser.
// ============================================================

import { getTenantContext, hasPermission } from '@/lib/auth/tenant-context';
import { Permissions } from '@/lib/constants/permissions';
import { listClasses } from '@/lib/actions/classes';
import { redirect } from 'next/navigation';
import Link from 'next/link';
import { RollCallClient } from '@/components/domain/attendance/roll-call-client';

export default async function AttendancePage() {
  const context = await getTenantContext();

  if (!hasPermission(context, Permissions.MANAGE_ATTENDANCE)) {
    redirect('/dashboard');
  }

  const classesResult = await listClasses();
  const classes = (classesResult.data ?? []).filter((c) => c.is_active);

  return (
    <div className="mx-auto max-w-4xl space-y-6">
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-xl font-bold text-gray-900">Attendance</h1>
          <p className="mt-1 text-sm text-gray-500">
            Take the daily roll for your class.
          </p>
        </div>
        <div className="flex gap-2">
          <Link
            href="/attendance/history"
            className="rounded-lg border border-gray-300 px-3 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50"
          >
            History
          </Link>
          <Link
            href="/attendance/absences"
            className="rounded-lg border border-gray-300 px-3 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50"
          >
            Absences
          </Link>
        </div>
      </div>

      {classes.length === 0 ? (
        <div className="rounded-lg border border-gray-200 bg-white p-12 text-center">
          <svg
            className="mx-auto h-12 w-12 text-gray-300"
            fill="none"
            viewBox="0 0 24 24"
            strokeWidth={1}
            stroke="currentColor"
          >
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              d="M9 12h3.75M9 15h3.75M9 18h3.75m3 .75H18a2.25 2.25 0 0 0 2.25-2.25V6.108c0-1.135-.845-2.098-1.976-2.192a48.424 48.424 0 0 0-1.123-.08m-5.801 0c-.065.21-.1.433-.1.664 0 .414.336.75.75.75h4.5a.75.75 0 0 0 .75-.75 2.25 2.25 0 0 0-.1-.664m-5.8 0A2.251 2.251 0 0 1 13.5 2.25H15a2.25 2.25 0 0 1 2.15 1.586m-5.8 0c-.376.023-.75.05-1.124.08C9.095 4.01 8.25 4.973 8.25 6.108V8.25m0 0H4.875c-.621 0-1.125.504-1.125 1.125v11.25c0 .621.504 1.125 1.125 1.125h9.75c.621 0 1.125-.504 1.125-1.125V9.375c0-.621-.504-1.125-1.125-1.125H8.25Z"
            />
          </svg>
          <p className="mt-4 text-sm font-medium text-gray-900">No classes found</p>
          <p className="mt-1 text-sm text-gray-500">
            Create a class first before taking attendance.
          </p>
        </div>
      ) : (
        <RollCallClient
          classes={classes.map((c) => ({
            id: c.id,
            name: c.name,
            room: c.room,
            cycleLevel: c.cycle_level,
          }))}
        />
      )}
    </div>
  );
}


===== D:\.code\wattleos\src\app\(app)\classes\[id]\edit\page.tsx =====

// src/app/(app)/classes/[id]/edit/page.tsx
//
// ============================================================
// WattleOS V2 - Edit Class Page
// ============================================================
// Server Component. Loads class, renders ClassForm pre-filled.
// ============================================================

import { getTenantContext } from '@/lib/auth/tenant-context';
import { Permissions } from '@/lib/constants/permissions';
import { getClass } from '@/lib/actions/classes';
import { redirect } from 'next/navigation';
import { notFound } from 'next/navigation';
import { ClassForm } from '@/components/domain/sis/ClassForm';
import Link from 'next/link';

interface EditClassPageProps {
  params: Promise<{ id: string }>;
}

export default async function EditClassPage({ params }: EditClassPageProps) {
  const { id } = await params;
  const context = await getTenantContext();

  // Gate: manage_enrollment or manage_students to edit classes
  if (
    !context.permissions.includes(Permissions.MANAGE_ENROLLMENT) &&
    !context.permissions.includes(Permissions.MANAGE_STUDENTS)
  ) {
    redirect(`/classes/${id}`);
  }

  const result = await getClass(id);

  if (result.error || !result.data) {
    notFound();
  }

  const classData = result.data;

  return (
    <div className="space-y-6">
      {/* Breadcrumb */}
      <nav className="flex items-center gap-2 text-sm text-gray-500">
        <Link href="/classes" className="hover:text-gray-700">
          Classes
        </Link>
        <span>/</span>
        <Link href={`/classes/${id}`} className="hover:text-gray-700">
          {classData.name}
        </Link>
        <span>/</span>
        <span className="text-gray-900">Edit</span>
      </nav>

      {/* Page header */}
      <div>
        <h1 className="text-2xl font-semibold text-gray-900">
          Edit {classData.name}
        </h1>
        <p className="mt-1 text-sm text-gray-500">
          Update classroom details. Changes take effect immediately.
        </p>
      </div>

      {/* Form - pre-filled */}
      <ClassForm initialData={classData} />
    </div>
  );
}


===== D:\.code\wattleos\src\app\(app)\classes\[id]\enroll\page.tsx =====

// src/app/(app)/classes/[id]/enroll/page.tsx
//
// ============================================================
// WattleOS V2 - Enroll Student in Class Page
// ============================================================
// Server Component wrapper. Loads class info and passes to
// the client enrollment form.
//
// Why a dedicated page: Enrollment needs a student search/picker
// and a date input. That's enough complexity to warrant its own
// page rather than a modal - especially on mobile/iPad where
// modals are painful.
// ============================================================

import { getTenantContext } from '@/lib/auth/tenant-context';
import { Permissions } from '@/lib/constants/permissions';
import { getClass } from '@/lib/actions/classes';
import { redirect } from 'next/navigation';
import { notFound } from 'next/navigation';
import { EnrollStudentForm } from '@/components/domain/sis/EnrollStudentForm';
import Link from 'next/link';

interface EnrollPageProps {
  params: Promise<{ id: string }>;
}

export default async function EnrollStudentPage({ params }: EnrollPageProps) {
  const { id } = await params;
  const context = await getTenantContext();

  if (!context.permissions.includes(Permissions.MANAGE_ENROLLMENT)) {
    redirect(`/classes/${id}`);
  }

  const result = await getClass(id);
  if (result.error || !result.data) {
    notFound();
  }

  const classData = result.data;

  return (
    <div className="space-y-6">
      {/* Breadcrumb */}
      <nav className="flex items-center gap-2 text-sm text-gray-500">
        <Link href="/classes" className="hover:text-gray-700">
          Classes
        </Link>
        <span>/</span>
        <Link href={`/classes/${id}`} className="hover:text-gray-700">
          {classData.name}
        </Link>
        <span>/</span>
        <span className="text-gray-900">Enroll Student</span>
      </nav>

      {/* Page header */}
      <div>
        <h1 className="text-2xl font-semibold text-gray-900">
          Enroll Student in {classData.name}
        </h1>
        <p className="mt-1 text-sm text-gray-500">
          Search for an existing student and set their enrollment start date.
          {classData.cycle_level && (
            <span className="ml-1 text-gray-400">
              (Ages {classData.cycle_level})
            </span>
          )}
        </p>
      </div>

      {/* Form */}
      <EnrollStudentForm classId={id} className={classData.name} />
    </div>
  );
}


===== D:\.code\wattleos\src\app\(app)\classes\[id]\page.tsx =====

// src/app/(app)/classes/[id]/page.tsx
//
// ============================================================
// WattleOS V2 - Class Detail Page
// ============================================================
// Server Component. Shows class information and the active
// student roster with enrollment management actions.
//
// Why this page matters: Without it, admins can see a list of
// classes but can't drill into one to see who's enrolled or
// manage the roster. This is the hub for enrollment operations.
// ============================================================

import { ClassRosterActions } from "@/components/domain/sis/ClassRosterActions";
import { getClass, getClassRoster } from "@/lib/actions/classes";
import { getTenantContext } from "@/lib/auth/tenant-context";
import { Permissions } from "@/lib/constants/permissions";
import { calculateAge, formatDate, formatStudentName } from "@/lib/utils";
import Link from "next/link";
import { notFound } from "next/navigation";

interface ClassDetailPageProps {
  params: Promise<{ id: string }>;
}

export default async function ClassDetailPage({
  params,
}: ClassDetailPageProps) {
  const { id } = await params;
  const context = await getTenantContext();

  const [classResult, rosterResult] = await Promise.all([
    getClass(id),
    getClassRoster(id),
  ]);

  if (classResult.error || !classResult.data) {
    notFound();
  }

  const classData = classResult.data;
  const roster = rosterResult.data ?? [];
  const canManageEnrollment = context.permissions.includes(
    Permissions.MANAGE_ENROLLMENT,
  );
  const canManageStudents = context.permissions.includes(
    Permissions.MANAGE_STUDENTS,
  );

  return (
    <div className="space-y-6">
      {/* Breadcrumb */}
      <nav className="flex items-center gap-2 text-sm text-gray-500">
        <Link href="/classes" className="hover:text-gray-700">
          Classes
        </Link>
        <span>/</span>
        <span className="text-gray-900">{classData.name}</span>
      </nav>

      {/* â”€â”€ Class Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */}
      <div className="rounded-lg border border-gray-200 bg-white p-6">
        <div className="flex items-start justify-between">
          <div>
            <div className="flex items-center gap-3">
              <h1 className="text-2xl font-semibold text-gray-900">
                {classData.name}
              </h1>
              <span
                className={`inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium ${
                  classData.is_active
                    ? "bg-green-50 text-green-700"
                    : "bg-gray-100 text-gray-600"
                }`}
              >
                {classData.is_active ? "Active" : "Inactive"}
              </span>
            </div>

            <div className="mt-2 flex flex-wrap gap-4 text-sm text-gray-500">
              {classData.cycle_level && (
                <span className="flex items-center gap-1">
                  <svg
                    className="h-4 w-4"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      strokeLinecap="round"
                      strokeLinejoin="round"
                      strokeWidth={2}
                      d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"
                    />
                  </svg>
                  Ages {classData.cycle_level}
                </span>
              )}
              {classData.room && (
                <span className="flex items-center gap-1">
                  <svg
                    className="h-4 w-4"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      strokeLinecap="round"
                      strokeLinejoin="round"
                      strokeWidth={2}
                      d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"
                    />
                  </svg>
                  {classData.room}
                </span>
              )}
              <span className="flex items-center gap-1">
                <svg
                  className="h-4 w-4"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    strokeLinecap="round"
                    strokeLinejoin="round"
                    strokeWidth={2}
                    d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"
                  />
                </svg>
                {roster.length} student{roster.length !== 1 ? "s" : ""} enrolled
              </span>
            </div>
          </div>

          {/* Edit button */}
          {(canManageEnrollment || canManageStudents) && (
            <Link
              href={`/classes/${id}/edit`}
              className="rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2"
            >
              Edit Class
            </Link>
          )}
        </div>
      </div>

      {/* â”€â”€ Student Roster â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */}
      <div className="rounded-lg border border-gray-200 bg-white">
        <div className="flex items-center justify-between border-b border-gray-200 px-6 py-4">
          <h2 className="text-lg font-semibold text-gray-900">
            Student Roster
          </h2>
          {canManageEnrollment && (
            <Link
              href={`/classes/${id}/enroll`}
              className="inline-flex items-center rounded-md bg-amber-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-amber-700 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2"
            >
              + Enroll Student
            </Link>
          )}
        </div>

        {roster.length === 0 ? (
          <div className="p-12 text-center">
            <svg
              className="mx-auto h-12 w-12 text-gray-300"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                strokeLinecap="round"
                strokeLinejoin="round"
                strokeWidth={1.5}
                d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"
              />
            </svg>
            <p className="mt-3 text-sm text-gray-500">
              No students enrolled in this class yet.
            </p>
            {canManageEnrollment && (
              <Link
                href={`/classes/${id}/enroll`}
                className="mt-4 inline-flex items-center text-sm font-medium text-amber-600 hover:text-amber-700"
              >
                Enroll your first student â†’
              </Link>
            )}
          </div>
        ) : (
          <div className="divide-y divide-gray-100">
            {roster.map((enrollment) => {
              const student = enrollment.student;
              const displayName = formatStudentName(
                student.first_name,
                student.last_name,
                student.preferred_name,
              );
              const age = calculateAge(student.dob);

              return (
                <div
                  key={enrollment.id}
                  className="flex items-center justify-between px-6 py-4 hover:bg-gray-50"
                >
                  <div className="flex items-center gap-4">
                    {/* Avatar placeholder */}
                    <div className="flex h-10 w-10 items-center justify-center rounded-full bg-amber-100 text-sm font-medium text-amber-700">
                      {student.first_name[0]}
                      {student.last_name[0]}
                    </div>
                    <div>
                      <Link
                        href={`/students/${student.id}`}
                        className="text-sm font-medium text-gray-900 hover:text-amber-700"
                      >
                        {displayName}
                      </Link>
                      <div className="flex gap-3 text-xs text-gray-500">
                        {age !== null && <span>Age {age}</span>}
                        <span>
                          Enrolled {formatDate(enrollment.start_date)}
                        </span>
                      </div>
                    </div>
                  </div>

                  {/* Roster actions (withdraw/transfer) */}
                  {canManageEnrollment && (
                    <ClassRosterActions
                      studentId={student.id}
                      studentName={displayName}
                      classId={id}
                      enrollmentId={enrollment.id}
                    />
                  )}
                </div>
              );
            })}
          </div>
        )}
      </div>
    </div>
  );
}



===== D:\.code\wattleos\src\app\(app)\classes\new\page.tsx =====

// src/app/(app)/classes/new/page.tsx
//
// ============================================================
// WattleOS V2 - Create Class Page
// ============================================================
// Server Component. Renders ClassForm in create mode.
//
// Why permission gate: Only users who can manage enrollment
// should be able to create new classrooms.
// ============================================================

import { getTenantContext } from '@/lib/auth/tenant-context';
import { Permissions } from '@/lib/constants/permissions';
import { redirect } from 'next/navigation';
import { ClassForm } from '@/components/domain/sis/ClassForm';
import Link from 'next/link';

export default async function CreateClassPage() {
  const context = await getTenantContext();

  // Gate: manage_enrollment or manage_students to create classes
  if (
    !context.permissions.includes(Permissions.MANAGE_ENROLLMENT) &&
    !context.permissions.includes(Permissions.MANAGE_STUDENTS)
  ) {
    redirect('/classes');
  }

  return (
    <div className="space-y-6">
      {/* Breadcrumb */}
      <nav className="flex items-center gap-2 text-sm text-gray-500">
        <Link href="/classes" className="hover:text-gray-700">
          Classes
        </Link>
        <span>/</span>
        <span className="text-gray-900">New Class</span>
      </nav>

      {/* Page header */}
      <div>
        <h1 className="text-2xl font-semibold text-gray-900">
          Create New Class
        </h1>
        <p className="mt-1 text-sm text-gray-500">
          Set up a new Montessori classroom or environment. You can enroll
          students and link a curriculum after creating the class.
        </p>
      </div>

      {/* Form */}
      <ClassForm />
    </div>
  );
}


===== D:\.code\wattleos\src\app\(app)\classes\page.tsx =====

// src/app/(app)/classes/page.tsx
//
// ============================================================
// WattleOS V2 - Class Management Page
// ============================================================
// Server Component. Shows all Montessori classrooms/environments
// with their active enrollment counts.
//
// Fix: Removed `params.tenant` - the (app) route group has no
// [tenant] dynamic segment. All links now use absolute paths
// without a tenant prefix. Tenant isolation is handled by
// RLS + JWT, not URL segments.
// ============================================================

import { listClasses } from '@/lib/actions/classes';
import Link from 'next/link';

export default async function ClassesPage() {
  const result = await listClasses();

  const classes = result.data ?? [];
  const activeClasses = classes.filter((c) => c.is_active);
  const inactiveClasses = classes.filter((c) => !c.is_active);

  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-2xl font-semibold text-gray-900">Classes</h1>
          <p className="mt-1 text-sm text-gray-500">
            Montessori classrooms and environments
          </p>
        </div>
        <Link
          href="/classes/new"
          className="inline-flex items-center rounded-md bg-indigo-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2"
        >
          + New Class
        </Link>
      </div>

      {result.error ? (
        <div className="rounded-md bg-red-50 p-4">
          <p className="text-sm text-red-700">{result.error.message}</p>
        </div>
      ) : classes.length === 0 ? (
        <div className="rounded-lg border-2 border-dashed border-gray-300 p-12 text-center">
          <p className="text-sm text-gray-500">
            No classes yet. Create your first classroom to start enrolling students.
          </p>
        </div>
      ) : (
        <>
          {/* Active Classes */}
          <div className="grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-3">
            {activeClasses.map((cls) => (
              <Link
                key={cls.id}
                href={`/classes/${cls.id}`}
                className="group rounded-lg border border-gray-200 bg-white p-5 shadow-sm transition hover:border-indigo-300 hover:shadow-md"
              >
                <div className="flex items-start justify-between">
                  <div>
                    <h3 className="text-base font-semibold text-gray-900 group-hover:text-indigo-600">
                      {cls.name}
                    </h3>
                    {cls.cycle_level && (
                      <span className="mt-1 inline-block rounded-full bg-indigo-50 px-2 py-0.5 text-xs font-medium text-indigo-700">
                        Ages {cls.cycle_level}
                      </span>
                    )}
                  </div>
                  <div className="text-right">
                    <p className="text-2xl font-bold text-gray-900">{cls.active_enrollment_count}</p>
                    <p className="text-xs text-gray-500">students</p>
                  </div>
                </div>
                {cls.room && (
                  <p className="mt-3 text-sm text-gray-500">Room: {cls.room}</p>
                )}
              </Link>
            ))}
          </div>

          {/* Inactive Classes */}
          {inactiveClasses.length > 0 && (
            <div>
              <h2 className="mb-3 text-sm font-medium uppercase tracking-wider text-gray-500">
                Inactive Classes
              </h2>
              <div className="grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-3">
                {inactiveClasses.map((cls) => (
                  <div
                    key={cls.id}
                    className="rounded-lg border border-gray-200 bg-gray-50 p-5 opacity-60"
                  >
                    <h3 className="text-base font-semibold text-gray-700">{cls.name}</h3>
                    {cls.cycle_level && (
                      <span className="mt-1 inline-block rounded-full bg-gray-100 px-2 py-0.5 text-xs font-medium text-gray-500">
                        Ages {cls.cycle_level}
                      </span>
                    )}
                    {cls.room && (
                      <p className="mt-3 text-sm text-gray-400">Room: {cls.room}</p>
                    )}
                  </div>
                ))}
              </div>
            </div>
          )}
        </>
      )}
    </div>
  );
}


===== D:\.code\wattleos\src\app\(app)\comms\announcements\page.tsx =====

// src/app/(app)/comms/announcements/page.tsx
//
// ============================================================
// WattleOS V2 - Staff Announcements Page
// ============================================================
// Server Component. Permission-gated to SEND_ANNOUNCEMENTS.
// Loads existing announcements and class list (for targeting),
// renders the interactive feed + create form.
// ============================================================

import { getTenantContext, hasPermission } from '@/lib/auth/tenant-context';
import { Permissions } from '@/lib/constants/permissions';
import { listAnnouncements } from '@/lib/actions/announcements';
import { listClasses } from '@/lib/actions/classes';
import { redirect } from 'next/navigation';
import Link from 'next/link';
import { AnnouncementFeedClient } from '@/components/domain/comms/announcement-feed-client';

export default async function AnnouncementsPage() {
  const context = await getTenantContext();

  if (!hasPermission(context, Permissions.SEND_ANNOUNCEMENTS)) {
    redirect('/dashboard');
  }

  const [announcementsResult, classesResult] = await Promise.all([
    listAnnouncements({ limit: 50 }),
    listClasses(),
  ]);

  const announcements = announcementsResult.data ?? [];
  const classes = (classesResult.data ?? []).filter((c) => c.is_active);

  return (
    <div className="space-y-6">
      {/* Header + nav */}
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-2xl font-semibold text-gray-900">Communications</h1>
          <p className="mt-1 text-sm text-gray-500">
            Announcements and messaging for your school community
          </p>
        </div>
      </div>

      {/* Tab nav */}
      <div className="flex gap-1 rounded-lg bg-gray-100 p-1">
        <Link
          href="/comms/announcements"
          className="flex-1 rounded-md bg-white px-4 py-2 text-center text-sm font-medium text-gray-900 shadow-sm"
        >
          Announcements
        </Link>
        <Link
          href="/comms/messages"
          className="flex-1 rounded-md px-4 py-2 text-center text-sm font-medium text-gray-500 hover:text-gray-700"
        >
          Messages
        </Link>
      </div>

      <AnnouncementFeedClient
        initialAnnouncements={announcements}
        classes={classes}
      />
    </div>
  );
}


===== D:\.code\wattleos\src\app\(app)\comms\messages\[threadId]\page.tsx =====

// src/app/(app)/comms/messages/[threadId]/page.tsx
//
// ============================================================
// WattleOS V2 - Thread View Page (Staff)
// ============================================================
// Server Component. Loads the full message thread with all
// messages and recipient list. Renders the conversation client.
// ============================================================

import { getTenantContext } from '@/lib/auth/tenant-context';
import { getThreadMessages } from '@/lib/actions/messaging';
import { redirect } from 'next/navigation';
import Link from 'next/link';
import { ThreadViewClient } from '@/components/domain/comms/thread-view-client';

interface ThreadPageProps {
  params: Promise<{ threadId: string }>;
}

export default async function ThreadPage({ params }: ThreadPageProps) {
  const { threadId } = await params;
  const context = await getTenantContext();

  const result = await getThreadMessages(threadId);

  if (result.error) {
    redirect('/comms/messages');
  }

  const { thread, messages, recipients } = result.data!;

  return (
    <div className="space-y-4">
      {/* Back link */}
      <Link
        href="/comms/messages"
        className="inline-flex items-center gap-1 text-sm text-gray-500 hover:text-gray-700"
      >
        <svg className="h-4 w-4" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor">
          <path strokeLinecap="round" strokeLinejoin="round" d="M15.75 19.5 8.25 12l7.5-7.5" />
        </svg>
        Back to Messages
      </Link>

      {/* Thread header */}
      <div className="rounded-lg border border-gray-200 bg-white px-6 py-4 shadow-sm">
        <h1 className="text-lg font-semibold text-gray-900">
          {thread.subject || 'Conversation'}
        </h1>
        <div className="mt-1 flex items-center gap-2 text-sm text-gray-500">
          <span className="inline-flex items-center rounded-full bg-blue-100 px-2 py-0.5 text-[10px] font-medium text-blue-700">
            {thread.thread_type === 'class_broadcast' ? 'ðŸ‘¥ Class Message' : 'ðŸ’¬ Direct'}
          </span>
          <span>Â·</span>
          <span>{recipients.length} recipients</span>
        </div>
      </div>

      <ThreadViewClient
        threadId={thread.id}
        initialMessages={messages}
        recipients={recipients}
        currentUserId={context.user.id}
      />
    </div>
  );
}


===== D:\.code\wattleos\src\app\(app)\comms\messages\page.tsx =====

// src/app/(app)/comms/messages/page.tsx
//
// ============================================================
// WattleOS V2 - Staff Messages Inbox
// ============================================================
// Server Component. Permission-gated to SEND_CLASS_MESSAGES.
// Shows all message threads the user participates in.
// ============================================================

import { getTenantContext, hasPermission } from '@/lib/auth/tenant-context';
import { Permissions } from '@/lib/constants/permissions';
import { getInbox } from '@/lib/actions/messaging';
import { listClasses } from '@/lib/actions/classes';
import { redirect } from 'next/navigation';
import Link from 'next/link';
import { MessageInboxClient } from '@/components/domain/comms/message-inbox-client';

export default async function MessagesPage() {
  const context = await getTenantContext();

  if (!hasPermission(context, Permissions.SEND_CLASS_MESSAGES)) {
    redirect('/dashboard');
  }

  const [inboxResult, classesResult] = await Promise.all([
    getInbox({ limit: 30 }),
    listClasses(),
  ]);

  const threads = inboxResult.data ?? [];
  const classes = (classesResult.data ?? []).filter((c) => c.is_active);

  return (
    <div className="space-y-6">
      {/* Header */}
      <div>
        <h1 className="text-2xl font-semibold text-gray-900">Communications</h1>
        <p className="mt-1 text-sm text-gray-500">
          Announcements and messaging for your school community
        </p>
      </div>

      {/* Tab nav */}
      <div className="flex gap-1 rounded-lg bg-gray-100 p-1">
        <Link
          href="/comms/announcements"
          className="flex-1 rounded-md px-4 py-2 text-center text-sm font-medium text-gray-500 hover:text-gray-700"
        >
          Announcements
        </Link>
        <Link
          href="/comms/messages"
          className="flex-1 rounded-md bg-white px-4 py-2 text-center text-sm font-medium text-gray-900 shadow-sm"
        >
          Messages
        </Link>
      </div>

      <MessageInboxClient
        initialThreads={threads}
        classes={classes}
        currentUserId={context.user.id}
      />
    </div>
  );
}


===== D:\.code\wattleos\src\app\(app)\dashboard\page.tsx =====

import { getTenantContext, hasPermission } from '@/lib/auth/tenant-context';
import { Permissions } from '@/lib/constants/permissions';

export default async function DashboardPage() {
  const context = await getTenantContext();

  return (
    <div className="space-y-8">
      {/* Welcome header */}
      <div>
        <h1 className="text-2xl font-bold text-gray-900">
          Welcome back
          {context.user.first_name ? `, ${context.user.first_name}` : ''}
        </h1>
        <p className="mt-1 text-sm text-gray-500">
          {context.tenant.name} &middot; {context.role.name}
        </p>
      </div>

      {/* Quick action cards */}
      <div className="grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
        {hasPermission(context, Permissions.CREATE_OBSERVATION) && (
          <QuickActionCard
            title="New Observation"
            description="Capture a learning moment"
            href="/pedagogy/observations/new"
            icon="eye"
            color="amber"
          />
        )}

        {hasPermission(context, Permissions.MANAGE_ATTENDANCE) && (
          <QuickActionCard
            title="Today's Attendance"
            description="Mark the daily roll"
            href="/attendance"
            icon="clipboard"
            color="green"
          />
        )}

        {hasPermission(context, Permissions.VIEW_STUDENTS) && (
          <QuickActionCard
            title="Student Profiles"
            description="View and manage students"
            href="/students"
            icon="users"
            color="blue"
          />
        )}

        {hasPermission(context, Permissions.MANAGE_CURRICULUM) && (
          <QuickActionCard
            title="Curriculum"
            description="Manage learning outcomes"
            href="/pedagogy/curriculum"
            icon="book"
            color="purple"
          />
        )}

        {hasPermission(context, Permissions.MANAGE_MASTERY) && (
          <QuickActionCard
            title="Mastery Tracking"
            description="Update student progress"
            href="/pedagogy/mastery"
            icon="chart"
            color="teal"
          />
        )}

        {hasPermission(context, Permissions.MANAGE_REPORTS) && (
          <QuickActionCard
            title="Reports"
            description="Create term reports"
            href="/reports"
            icon="file"
            color="orange"
          />
        )}
      </div>

      {/* Module status - shows what's been built */}
      <div className="rounded-lg border border-gray-200 bg-white p-6">
        <h2 className="text-lg font-semibold text-gray-900">System Status</h2>
        <p className="mt-1 text-sm text-gray-500">
          WattleOS V2 build progress
        </p>
        <div className="mt-4 space-y-3">
          <ModuleStatus name="Core Platform & Identity" status="active" module={1} />
          <ModuleStatus name="Curriculum Engine" status="pending" module={2} />
          <ModuleStatus name="Observation Engine" status="pending" module={3} />
          <ModuleStatus name="Mastery & Portfolios" status="pending" module={4} />
          <ModuleStatus name="Student Information System" status="pending" module={5} />
          <ModuleStatus name="Attendance & Safety" status="pending" module={6} />
          <ModuleStatus name="Reporting & Communications" status="pending" module={7} />
          <ModuleStatus name="Integration Pipes" status="pending" module={8} />
        </div>
      </div>
    </div>
  );
}

// ============================================================
// Sub-components (co-located, Server Components)
// ============================================================

const COLOR_MAP: Record<string, string> = {
  amber: 'bg-amber-50 text-amber-700 border-amber-200',
  green: 'bg-green-50 text-green-700 border-green-200',
  blue: 'bg-blue-50 text-blue-700 border-blue-200',
  purple: 'bg-purple-50 text-purple-700 border-purple-200',
  teal: 'bg-teal-50 text-teal-700 border-teal-200',
  orange: 'bg-orange-50 text-orange-700 border-orange-200',
};

function QuickActionCard({
  title,
  description,
  href,
  icon,
  color,
}: {
  title: string;
  description: string;
  href: string;
  icon: string;
  color: string;
}) {
  return (
    <a
      href={href}
      className={`block rounded-lg border p-5 transition-shadow hover:shadow-md ${COLOR_MAP[color] ?? COLOR_MAP.amber}`}
    >
      <h3 className="text-sm font-semibold">{title}</h3>
      <p className="mt-1 text-xs opacity-75">{description}</p>
    </a>
  );
}

function ModuleStatus({
  name,
  status,
  module,
}: {
  name: string;
  status: 'active' | 'pending' | 'complete';
  module: number;
}) {
  return (
    <div className="flex items-center gap-3">
      <div
        className={`flex h-7 w-7 flex-shrink-0 items-center justify-center rounded-full text-xs font-bold ${
          status === 'active'
            ? 'bg-amber-100 text-amber-700'
            : status === 'complete'
              ? 'bg-green-100 text-green-700'
              : 'bg-gray-100 text-gray-400'
        }`}
      >
        {module}
      </div>
      <span
        className={`text-sm ${
          status === 'active'
            ? 'font-medium text-gray-900'
            : status === 'complete'
              ? 'text-green-700'
              : 'text-gray-400'
        }`}
      >
        {name}
      </span>
      {status === 'active' && (
        <span className="rounded-full bg-amber-100 px-2 py-0.5 text-xs font-medium text-amber-700">
          In Progress
        </span>
      )}
      {status === 'complete' && (
        <span className="rounded-full bg-green-100 px-2 py-0.5 text-xs font-medium text-green-700">
          Complete
        </span>
      )}
    </div>
  );
}



===== D:\.code\wattleos\src\app\(app)\layout.tsx =====

// src/app/(app)/layout.tsx
//
// ============================================================
// WattleOS V2 â€” App Layout (UPDATED: Display Settings + Comms + Timesheets)
// ============================================================
// CHANGES from previous version:
// â€¢ Calls getResolvedDisplayConfig() to sync the display cookie
//   on every authenticated page load. This ensures the root
//   layout always has current theme/density/brand data.
// â€¢ Replaced hardcoded bg-gray-50 and text classes with design
//   system tokens (bg-background, etc.)
// â€¢ All previous nav items preserved (comms, timesheets, parent)
// ============================================================

import { getTenantContext, hasPermission } from '@/lib/auth/tenant-context';
import { Permissions } from '@/lib/constants/permissions';
import { Sidebar } from '@/components/domain/sidebar';
import { getUnreadAnnouncementCount } from '@/lib/actions/announcements';
import { getUnreadMessageCount } from '@/lib/actions/messaging';
import { getResolvedDisplayConfig } from '@/lib/actions/display-settings';

export default async function AppLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  const context = await getTenantContext();

  // Sync the display cookie on every authenticated page load.
  // This is a lightweight read (one select) + cookie write.
  // Non-blocking: we don't need the result, just the side effect.
  getResolvedDisplayConfig().catch(() => {
    // Non-critical â€” layout will use whatever cookie already exists
  });

  // Fetch unread counts for badge display (runs server-side, no client overhead)
  let totalUnreadComms = 0;
  try {
    const [announcementResult, messageResult] = await Promise.all([
      getUnreadAnnouncementCount(),
      getUnreadMessageCount(),
    ]);
    totalUnreadComms =
      (announcementResult.data ?? 0) + (messageResult.data ?? 0);
  } catch {
    // Non-critical â€” badges just won't show
  }

  const navItems = buildNavItems(context.permissions, totalUnreadComms);

  return (
    <div className="flex h-screen bg-background">
      <Sidebar
        tenantName={context.tenant.name}
        tenantLogo={context.tenant.logo_url}
        userName={
          [context.user.first_name, context.user.last_name]
            .filter(Boolean)
            .join(' ') || context.user.email
        }
        userEmail={context.user.email}
        userAvatar={context.user.avatar_url}
        roleName={context.role.name}
        navItems={navItems}
      />
      <main className="flex-1 overflow-y-auto">
        <div className="content-grid py-[var(--density-page-padding)]">
          {children}
        </div>
      </main>
    </div>
  );
}

interface NavItem {
  label: string;
  href: string;
  icon: string;
  badge?: number;
}

function buildNavItems(permissions: string[], unreadComms: number): NavItem[] {
  const items: NavItem[] = [
    { label: 'Dashboard', href: '/dashboard', icon: 'home' },
  ];

  // â€”â€” Pedagogy section â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
  if (
    permissions.includes(Permissions.CREATE_OBSERVATION) ||
    permissions.includes(Permissions.VIEW_ALL_OBSERVATIONS)
  ) {
    items.push({
      label: 'Observations',
      href: '/pedagogy/observations',
      icon: 'eye',
    });
  }

  if (permissions.includes(Permissions.MANAGE_CURRICULUM)) {
    items.push({
      label: 'Curriculum',
      href: '/pedagogy/curriculum',
      icon: 'book',
    });
  }

  if (permissions.includes(Permissions.MANAGE_MASTERY)) {
    items.push({
      label: 'Mastery',
      href: '/pedagogy/mastery',
      icon: 'chart',
    });
  }

  // â€”â€” SIS section â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
  if (permissions.includes(Permissions.VIEW_STUDENTS)) {
    items.push({
      label: 'Students',
      href: '/students',
      icon: 'users',
    });
  }

  if (
    permissions.includes(Permissions.VIEW_STUDENTS) ||
    permissions.includes(Permissions.MANAGE_ENROLLMENT)
  ) {
    items.push({
      label: 'Classes',
      href: '/classes',
      icon: 'book',
    });
  }

  // â€”â€” Attendance â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
  if (permissions.includes(Permissions.MANAGE_ATTENDANCE)) {
    items.push({
      label: 'Attendance',
      href: '/attendance',
      icon: 'clipboard',
    });
  }

  // â€”â€” Reports â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
  if (permissions.includes(Permissions.MANAGE_REPORTS)) {
    items.push({
      label: 'Reports',
      href: '/reports',
      icon: 'file',
    });
  }

  // â€”â€” Communications â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
  if (
    permissions.includes(Permissions.SEND_ANNOUNCEMENTS) ||
    permissions.includes(Permissions.SEND_CLASS_MESSAGES)
  ) {
    items.push({
      label: 'Communications',
      href: '/comms/announcements',
      icon: 'megaphone',
      badge: unreadComms > 0 ? unreadComms : undefined,
    });
  }

  // â€”â€” Timesheets (Phase 9b) â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
  if (permissions.includes(Permissions.LOG_TIME)) {
    items.push({
      label: 'Timesheets',
      href: '/timesheets',
      icon: 'clock',
    });
  }

  // â€”â€” Parent Portal â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
  const isParent =
    !permissions.includes(Permissions.CREATE_OBSERVATION) &&
    !permissions.includes(Permissions.VIEW_ALL_OBSERVATIONS) &&
    !permissions.includes(Permissions.VIEW_STUDENTS) &&
    !permissions.includes(Permissions.MANAGE_ATTENDANCE);

  if (isParent) {
    items.push({
      label: 'My Children',
      href: '/parent',
      icon: 'heart',
    });
    items.push({
      label: 'Announcements',
      href: '/parent/announcements',
      icon: 'megaphone',
      badge: unreadComms > 0 ? unreadComms : undefined,
    });
    items.push({
      label: 'Messages',
      href: '/parent/messages',
      icon: 'chat',
    });
  }

  // â€”â€” Admin section â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
  if (
    permissions.includes(Permissions.MANAGE_USERS) ||
    permissions.includes(Permissions.MANAGE_TENANT_SETTINGS)
  ) {
    items.push({
      label: 'Settings',
      href: '/admin',
      icon: 'settings',
    });
  }

  return items;
}


===== D:\.code\wattleos\src\app\(app)\parent\[studentId]\attendance\page.tsx =====

// src/app/(app)/parent/[studentId]/attendance/page.tsx
//
// ============================================================
// WattleOS V2 - Child Attendance Page (Parent View)
// ============================================================
// Server Component. Shows attendance records for a child with
// summary stats and date range filtering.
// ============================================================

import { getTenantContext } from '@/lib/auth/tenant-context';
import {
  isGuardianOf,
  getMyChildren,
  getChildAttendance,
} from '@/lib/actions/parent';
import { redirect } from 'next/navigation';
import Link from 'next/link';

interface PageProps {
  params: Promise<{ studentId: string }>;
  searchParams: Promise<{ start?: string; end?: string }>;
}

const STATUS_STYLES: Record<string, { bg: string; text: string; label: string }> = {
  present: { bg: 'bg-green-100', text: 'text-green-700', label: 'Present' },
  absent: { bg: 'bg-red-100', text: 'text-red-700', label: 'Absent' },
  late: { bg: 'bg-amber-100', text: 'text-amber-700', label: 'Late' },
  excused: { bg: 'bg-blue-100', text: 'text-blue-700', label: 'Excused' },
  half_day: { bg: 'bg-gray-100', text: 'text-gray-700', label: 'Half Day' },
};

export default async function ChildAttendancePage({
  params,
  searchParams,
}: PageProps) {
  const { studentId } = await params;
  const query = await searchParams;
  await getTenantContext();

  const isGuardian = await isGuardianOf(studentId);
  if (!isGuardian) redirect('/parent');

  const childrenResult = await getMyChildren();
  const child = (childrenResult.data ?? []).find((c) => c.id === studentId);
  if (!child) redirect('/parent');
  const displayName = child.preferredName ?? child.firstName;

  const result = await getChildAttendance(studentId, {
    startDate: query.start || undefined,
    endDate: query.end || undefined,
  });

  const records = result.data?.records ?? [];
  const summary = result.data?.summary ?? {
    totalDays: 0,
    present: 0,
    absent: 0,
    late: 0,
    excused: 0,
    halfDay: 0,
    attendanceRate: 0,
  };

  return (
    <div className="space-y-6">
      {/* Header */}
      <div>
        <div className="flex items-center gap-2 text-sm text-gray-500">
          <Link href="/parent" className="hover:text-gray-700">
            My Children
          </Link>
          <span className="text-gray-400">/</span>
          <Link href={`/parent/${studentId}`} className="hover:text-gray-700">
            {displayName} {child.lastName}
          </Link>
          <span className="text-gray-400">/</span>
          <span className="text-gray-900">Attendance</span>
        </div>
        <h1 className="mt-2 text-2xl font-bold text-gray-900">
          {displayName}&apos;s Attendance
        </h1>

        {/* Sub-nav */}
        <div className="mt-4 flex gap-4 border-b border-gray-200">
          <Link
            href={`/parent/${studentId}`}
            className="border-b-2 border-transparent px-1 pb-3 text-sm font-medium text-gray-500 hover:text-gray-700"
          >
            Portfolio
          </Link>
          <Link
            href={`/parent/${studentId}/attendance`}
            className="border-b-2 border-amber-500 px-1 pb-3 text-sm font-medium text-amber-700"
          >
            Attendance
          </Link>
          <Link
            href={`/parent/${studentId}/reports`}
            className="border-b-2 border-transparent px-1 pb-3 text-sm font-medium text-gray-500 hover:text-gray-700"
          >
            Reports
          </Link>
        </div>
      </div>

      {/* Summary cards */}
      <div className="grid grid-cols-2 gap-3 sm:grid-cols-3 lg:grid-cols-6">
        <SummaryCard label="Total Days" value={summary.totalDays} />
        <SummaryCard label="Present" value={summary.present} color="green" />
        <SummaryCard label="Absent" value={summary.absent} color="red" />
        <SummaryCard label="Late" value={summary.late} color="amber" />
        <SummaryCard label="Excused" value={summary.excused} color="blue" />
        <SummaryCard label="Attendance Rate" value={`${summary.attendanceRate}%`} color="green" large />
      </div>

      {/* Records table */}
      {records.length === 0 ? (
        <div className="rounded-lg border border-gray-200 bg-white p-8 text-center">
          <p className="text-sm text-gray-500">
            No attendance records found for this period.
          </p>
        </div>
      ) : (
        <div className="overflow-hidden rounded-lg border border-gray-200 bg-white">
          <table className="min-w-full divide-y divide-gray-200">
            <thead className="bg-gray-50">
              <tr>
                <th className="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">
                  Date
                </th>
                <th className="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">
                  Status
                </th>
                <th className="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">
                  Check In
                </th>
                <th className="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">
                  Check Out
                </th>
                <th className="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">
                  Notes
                </th>
              </tr>
            </thead>
            <tbody className="divide-y divide-gray-100">
              {records.map((record) => {
                const style = STATUS_STYLES[record.status] ?? STATUS_STYLES.present;
                return (
                  <tr key={record.id} className="hover:bg-gray-50">
                    <td className="whitespace-nowrap px-4 py-3 text-sm text-gray-900">
                      {formatDate(record.date)}
                    </td>
                    <td className="px-4 py-3">
                      <span
                        className={`inline-flex rounded-full px-2 py-0.5 text-xs font-medium ${style.bg} ${style.text}`}
                      >
                        {style.label}
                      </span>
                    </td>
                    <td className="whitespace-nowrap px-4 py-3 text-sm text-gray-500">
                      {record.checkInAt ? formatTime(record.checkInAt) : 'â€”'}
                    </td>
                    <td className="whitespace-nowrap px-4 py-3 text-sm text-gray-500">
                      {record.checkOutAt ? formatTime(record.checkOutAt) : 'â€”'}
                    </td>
                    <td className="px-4 py-3 text-sm text-gray-500">
                      {record.notes ?? 'â€”'}
                    </td>
                  </tr>
                );
              })}
            </tbody>
          </table>
        </div>
      )}
    </div>
  );
}

// ============================================================
// Sub-components
// ============================================================

function SummaryCard({
  label,
  value,
  color,
  large,
}: {
  label: string;
  value: number | string;
  color?: 'green' | 'red' | 'amber' | 'blue';
  large?: boolean;
}) {
  const colorMap: Record<string, string> = {
    green: 'text-green-700',
    red: 'text-red-700',
    amber: 'text-amber-700',
    blue: 'text-blue-700',
  };

  return (
    <div className="rounded-lg border border-gray-200 bg-white p-4 text-center">
      <p className={`${large ? 'text-2xl' : 'text-xl'} font-bold ${color ? colorMap[color] : 'text-gray-900'}`}>
        {value}
      </p>
      <p className="mt-1 text-[10px] font-medium uppercase tracking-wider text-gray-500">
        {label}
      </p>
    </div>
  );
}

function formatDate(dateStr: string): string {
  const date = new Date(dateStr + 'T00:00:00');
  return date.toLocaleDateString('en-AU', {
    weekday: 'short',
    day: 'numeric',
    month: 'short',
  });
}

function formatTime(dateStr: string): string {
  const date = new Date(dateStr);
  return date.toLocaleTimeString('en-AU', {
    hour: '2-digit',
    minute: '2-digit',
  });
}


===== D:\.code\wattleos\src\app\(app)\parent\[studentId]\page.tsx =====

// src/app/(app)/parent/[studentId]/page.tsx
//
// ============================================================
// WattleOS V2 - Child Portfolio Page
// ============================================================
// Server Component. Shows published observations and mastery
// progress for a single child. This is the parent's primary
// window into their child's learning journey.
//
// WHY single page: Observations and mastery together tell the
// story of learning. Parents see "what happened" (observations)
// alongside "what's been achieved" (mastery).
// ============================================================

import { getTenantContext } from '@/lib/auth/tenant-context';
import {
  isGuardianOf,
  getMyChildren,
  getChildObservations,
  getChildMastery,
} from '@/lib/actions/parent';
import { redirect } from 'next/navigation';
import Link from 'next/link';

interface PageProps {
  params: Promise<{ studentId: string }>;
  searchParams: Promise<{ page?: string }>;
}

export default async function ChildPortfolioPage({
  params,
  searchParams,
}: PageProps) {
  const { studentId } = await params;
  const query = await searchParams;
  await getTenantContext();

  const isGuardian = await isGuardianOf(studentId);
  if (!isGuardian) {
    redirect('/parent');
  }

  // Get child info
  const childrenResult = await getMyChildren();
  const child = (childrenResult.data ?? []).find((c) => c.id === studentId);
  if (!child) redirect('/parent');
  const displayName = child.preferredName ?? child.firstName;

  const page = parseInt(query.page ?? '1', 10);

  // Load observations and mastery in parallel
  const [obsResult, masteryResult] = await Promise.all([
    getChildObservations(studentId, { page, perPage: 10 }),
    getChildMastery(studentId),
  ]);

  const observations = obsResult.data ?? [];
  const obsPagination = obsResult.pagination;
  const masterySummaries = masteryResult.data ?? [];

  return (
    <div className="space-y-6">
      {/* Header */}
      <div>
        <div className="flex items-center gap-2 text-sm text-gray-500">
          <Link href="/parent" className="hover:text-gray-700">
            My Children
          </Link>
          <span className="text-gray-400">/</span>
          <span className="text-gray-900">
            {displayName} {child.lastName}
          </span>
        </div>
        <div className="mt-2 flex items-center gap-4">
          {child.photoUrl ? (
            <img
              src={child.photoUrl}
              alt=""
              className="h-12 w-12 rounded-full object-cover"
            />
          ) : (
            <div className="flex h-12 w-12 items-center justify-center rounded-full bg-amber-100 text-lg font-bold text-amber-700">
              {child.firstName[0]}
              {child.lastName[0]}
            </div>
          )}
          <div>
            <h1 className="text-2xl font-bold text-gray-900">
              {displayName}&apos;s Portfolio
            </h1>
            <div className="flex items-center gap-3 text-sm text-gray-500">
              {child.className && <span>{child.className}</span>}
            </div>
          </div>
        </div>
        {/* Sub-nav */}
        <div className="mt-4 flex gap-4 border-b border-gray-200">
          <Link
            href={`/parent/${studentId}`}
            className="border-b-2 border-amber-500 px-1 pb-3 text-sm font-medium text-amber-700"
          >
            Portfolio
          </Link>
          <Link
            href={`/parent/${studentId}/attendance`}
            className="border-b-2 border-transparent px-1 pb-3 text-sm font-medium text-gray-500 hover:text-gray-700"
          >
            Attendance
          </Link>
          <Link
            href={`/parent/${studentId}/reports`}
            className="border-b-2 border-transparent px-1 pb-3 text-sm font-medium text-gray-500 hover:text-gray-700"
          >
            Reports
          </Link>
        </div>
      </div>

      <div className="grid gap-6 lg:grid-cols-3">
        {/* Observations - 2/3 width */}
        <div className="space-y-4 lg:col-span-2">
          <h2 className="text-sm font-semibold text-gray-900">
            Observations
          </h2>

          {observations.length === 0 ? (
            <div className="rounded-lg border border-gray-200 bg-white p-8 text-center">
              <p className="text-sm text-gray-500">
                No published observations yet for this period.
              </p>
            </div>
          ) : (
            <div className="space-y-3">
              {observations.map((obs) => (
                <div
                  key={obs.id}
                  className="rounded-lg border border-gray-200 bg-white p-4"
                >
                  {/* Media thumbnails */}
                  {obs.media.length > 0 && (
                    <div className="mb-3 flex gap-2 overflow-x-auto">
                      {obs.media.map((m) =>
                        m.mediaType === 'image' ? (
                          <img
                            key={m.id}
                            src={m.thumbnailUrl ?? m.storageUrl}
                            alt={m.caption ?? 'Observation photo'}
                            className="h-24 w-24 flex-shrink-0 rounded-md object-cover"
                          />
                        ) : (
                          <div
                            key={m.id}
                            className="flex h-24 w-24 flex-shrink-0 items-center justify-center rounded-md bg-gray-100 text-xs text-gray-500"
                          >
                            ðŸŽ¥ Video
                          </div>
                        )
                      )}
                    </div>
                  )}

                  {/* Content */}
                  {obs.content && (
                    <p className="text-sm leading-relaxed text-gray-700">
                      {obs.content}
                    </p>
                  )}

                  {/* Outcomes */}
                  {obs.outcomes.length > 0 && (
                    <div className="mt-3 flex flex-wrap gap-1">
                      {obs.outcomes.map((o) => (
                        <span
                          key={o.nodeId}
                          className="rounded-full bg-amber-50 px-2 py-0.5 text-xs font-medium text-amber-700"
                        >
                          {o.title}
                        </span>
                      ))}
                    </div>
                  )}

                  {/* Meta */}
                  <div className="mt-3 flex items-center gap-3 text-xs text-gray-400">
                    <span>{obs.authorName}</span>
                    <span>&middot;</span>
                    <span>
                      {new Date(obs.publishedAt ?? obs.createdAt).toLocaleDateString(
                        'en-AU',
                        { day: 'numeric', month: 'short', year: 'numeric' }
                      )}
                    </span>
                    {obs.media.length > 0 && (
                      <>
                        <span>&middot;</span>
                        <span>
                          ðŸ“· {obs.media.length} photo{obs.media.length !== 1 ? 's' : ''}
                        </span>
                      </>
                    )}
                  </div>
                </div>
              ))}

              {/* Pagination */}
              {obsPagination && obsPagination.totalPages > 1 && (
                <div className="flex items-center justify-between pt-2">
                  <p className="text-xs text-gray-500">
                    Page {obsPagination.page} of {obsPagination.totalPages}
                  </p>
                  <div className="flex gap-2">
                    {obsPagination.page > 1 && (
                      <Link
                        href={`/parent/${studentId}?page=${obsPagination.page - 1}`}
                        className="rounded-md border border-gray-300 bg-white px-3 py-1 text-xs text-gray-700 hover:bg-gray-50"
                      >
                        Previous
                      </Link>
                    )}
                    {obsPagination.page < obsPagination.totalPages && (
                      <Link
                        href={`/parent/${studentId}?page=${obsPagination.page + 1}`}
                        className="rounded-md border border-gray-300 bg-white px-3 py-1 text-xs text-gray-700 hover:bg-gray-50"
                      >
                        Next
                      </Link>
                    )}
                  </div>
                </div>
              )}
            </div>
          )}
        </div>

        {/* Mastery sidebar - 1/3 width */}
        <div className="space-y-4">
          <h2 className="text-sm font-semibold text-gray-900">
            Learning Progress
          </h2>

          {masterySummaries.length === 0 ? (
            <div className="rounded-lg border border-gray-200 bg-white p-6 text-center">
              <p className="text-sm text-gray-500">
                No mastery data recorded yet.
              </p>
            </div>
          ) : (
            <div className="space-y-3">
              {masterySummaries.map((ms) => (
                <div
                  key={ms.instanceId}
                  className="rounded-lg border border-gray-200 bg-white p-4"
                >
                  <p className="text-sm font-medium text-gray-900">
                    {ms.instanceName}
                  </p>

                  {/* Progress bar */}
                  <div className="mt-3 flex items-center gap-2">
                    <div className="h-2 flex-1 overflow-hidden rounded-full bg-gray-100">
                      <div
                        className="h-full rounded-full bg-green-500 transition-all"
                        style={{ width: `${ms.percentMastered}%` }}
                      />
                    </div>
                    <span className="text-xs font-medium text-gray-700">
                      {ms.percentMastered}%
                    </span>
                  </div>

                  {/* Breakdown */}
                  <div className="mt-3 grid grid-cols-4 gap-2">
                    <div className="text-center">
                      <p className="text-sm font-bold text-green-600">{ms.mastered}</p>
                      <p className="text-[10px] text-gray-500">Mastered</p>
                    </div>
                    <div className="text-center">
                      <p className="text-sm font-bold text-amber-600">{ms.practicing}</p>
                      <p className="text-[10px] text-gray-500">Practicing</p>
                    </div>
                    <div className="text-center">
                      <p className="text-sm font-bold text-blue-600">{ms.presented}</p>
                      <p className="text-[10px] text-gray-500">Presented</p>
                    </div>
                    <div className="text-center">
                      <p className="text-sm font-bold text-gray-400">{ms.notStarted}</p>
                      <p className="text-[10px] text-gray-500">Not Started</p>
                    </div>
                  </div>

                  <p className="mt-2 text-xs text-gray-400">
                    {ms.total} outcomes tracked
                  </p>
                </div>
              ))}
            </div>
          )}
        </div>
      </div>
    </div>
  );
}


===== D:\.code\wattleos\src\app\(app)\parent\[studentId]\reports\[reportId]\page.tsx =====

// src/app/(app)/parent/[studentId]/reports/[reportId]/page.tsx
//
// ============================================================
// WattleOS V2 - Report Viewer (Parent View)
// ============================================================
// Server Component. Read-only display of a published student
// report. Shows all sections - auto data and teacher narratives.
//
// WHY separate from staff editor: No editing, no workflow
// buttons, no status transitions. Just clean reading.
// ============================================================

import { getTenantContext } from "@/lib/auth/tenant-context";
import { isGuardianOf, getMyChildren, getChildReport } from "@/lib/actions/parent";
import type {
  ReportContent,
  ReportSectionContent,
  ReportAutoData,
  TemplateSectionType,
} from "@/lib/reports/types";
import { redirect } from "next/navigation";
import Link from "next/link";
import { ReportPdfActions } from "@/components/domain/reports/report-pdf-actions";

interface PageProps {
  params: Promise<{ studentId: string; reportId: string }>;
}

export default async function ReportViewerPage({ params }: PageProps) {
  const { studentId, reportId } = await params;
  await getTenantContext();

  const isGuardian = await isGuardianOf(studentId);
  if (!isGuardian) redirect("/parent");

  const childrenResult = await getMyChildren();
  const child = (childrenResult.data ?? []).find((c) => c.id === studentId);
  if (!child) redirect("/parent");
  const displayName = child.preferredName ?? child.firstName;

  const reportResult = await getChildReport(reportId, studentId);
  if (reportResult.error || !reportResult.data) {
    redirect(`/parent/${studentId}/reports`);
  }

  const report = reportResult.data;

  // Parent view is published-only. If you ever allow other statuses here,
  // switch this to a real field from the API response.
  const reportStatus: string =
    (report as any).status ?? ((report as any).publishedAt ? "published" : "published");

  // Parent report detail types vary (camel vs snake). Support both.
  const pdfStoragePath =
    (report as any).pdfStoragePath ??
    (report as any).pdf_storage_path ??
    (report as any).pdf_storage_path; // duplicate ok, explicit

  const hasPdf = Boolean(pdfStoragePath);

  const content: ReportContent = (report as any).content;
  const sections = content?.sections ?? [];

  return (
    <div className="mx-auto max-w-3xl space-y-6">
      {/* Header */}
      <div>
        <div className="flex items-center gap-2 text-sm text-gray-500">
          <Link href="/parent" className="hover:text-gray-700">
            My Children
          </Link>
          <span className="text-gray-400">/</span>
          <Link href={`/parent/${studentId}`} className="hover:text-gray-700">
            {displayName}
          </Link>
          <span className="text-gray-400">/</span>
          <Link href={`/parent/${studentId}/reports`} className="hover:text-gray-700">
            Reports
          </Link>
          <span className="text-gray-400">/</span>
          <span className="text-gray-900">{(report as any).term ?? "Report"}</span>
        </div>

        <div className="mt-4 rounded-lg border border-gray-200 bg-white px-6 py-5">
          <div className="flex items-start justify-between gap-4">
            <div>
              <h1 className="text-xl font-bold text-gray-900">
                {(report as any).term ?? "Student Report"} - {displayName} {child.lastName}
              </h1>
              <div className="mt-2 flex flex-wrap items-center gap-3 text-sm text-gray-500">
                {(report as any).templateName && <span>{(report as any).templateName}</span>}
                <span>&middot;</span>
                <span>By {(report as any).authorName}</span>
                {(report as any).publishedAt && (
                  <>
                    <span>&middot;</span>
                    <span>
                      Published{" "}
                      {new Date((report as any).publishedAt).toLocaleDateString("en-AU", {
                        day: "numeric",
                        month: "long",
                        year: "numeric",
                      })}
                    </span>
                  </>
                )}
              </div>
              {content?.reportingPeriod && (
                <p className="mt-1 text-xs text-gray-400">
                  Reporting period: {formatDate(content.reportingPeriod.startDate)} â€”{" "}
                  {formatDate(content.reportingPeriod.endDate)}
                </p>
              )}
            </div>

            {/* PDF Download Button */}
            <div className="shrink-0">
              <ReportPdfActions
                reportId={reportId}
                reportStatus={reportStatus}
                hasPdf={hasPdf}
                isParentView={true}
              />
            </div>
          </div>
        </div>
      </div>

      {/* Sections */}
      <div className="space-y-4">
        {sections.map((section) => (
          <ReportSectionView key={section.templateSectionId} section={section} />
        ))}
      </div>

      {/* Back link */}
      <div className="pb-8">
        <Link
          href={`/parent/${studentId}/reports`}
          className="text-sm font-medium text-amber-600 hover:text-amber-700"
        >
          â† Back to reports
        </Link>
      </div>
    </div>
  );
}

// ============================================================
// Section renderer (read-only)
// ============================================================

function ReportSectionView({ section }: { section: ReportSectionContent }) {
  return (
    <div className="rounded-lg border border-gray-200 bg-white">
      <div className="border-b border-gray-100 px-6 py-4">
        <h2 className="text-base font-semibold text-gray-900">{section.title}</h2>
      </div>
      <div className="px-6 py-4">
        {/* Auto data */}
        {section.autoData && <AutoDataView autoData={section.autoData} type={section.type} />}

        {/* Narrative */}
        {section.narrative && (
          <div className={section.autoData ? "mt-4" : ""}>
            <p className="whitespace-pre-wrap text-sm leading-relaxed text-gray-700">
              {section.narrative}
            </p>
          </div>
        )}

        {/* Empty editable section with no content */}
        {!section.autoData && !section.narrative && (
          <p className="text-sm italic text-gray-400">No content for this section.</p>
        )}
      </div>
    </div>
  );
}

// ============================================================
// Auto data renderer (read-only, simplified from staff editor)
// ============================================================

function AutoDataView({
  autoData,
  type,
}: {
  autoData: ReportAutoData;
  type: TemplateSectionType;
}) {
  // Student info
  if (type === "student_info" && autoData.studentInfo) {
    const info = autoData.studentInfo;
    return (
      <div className="flex items-start gap-4">
        {info.photoUrl ? (
          <img src={info.photoUrl} alt="" className="h-16 w-16 rounded-lg object-cover" />
        ) : (
          <div className="flex h-16 w-16 items-center justify-center rounded-lg bg-gray-100 text-lg font-medium text-gray-400">
            {info.firstName[0]}
            {info.lastName[0]}
          </div>
        )}
        <div className="space-y-1 text-sm">
          <p className="font-medium text-gray-900">
            {info.preferredName
              ? `${info.preferredName} (${info.firstName} ${info.lastName})`
              : `${info.firstName} ${info.lastName}`}
          </p>
          {info.className && <p className="text-gray-600">Class: {info.className}</p>}
          {info.dob && <p className="text-gray-500">Date of Birth: {formatDate(info.dob)}</p>}
        </div>
      </div>
    );
  }

  // Mastery summary
  if (type === "mastery_summary" && autoData.masterySummary) {
    const ms = autoData.masterySummary;
    return (
      <div className="space-y-3">
        <div className="grid grid-cols-5 gap-3">
          {[
            { label: "Total", value: ms.total, color: "text-gray-700" },
            { label: "Not Started", value: ms.notStarted, color: "text-gray-500" },
            { label: "Presented", value: ms.presented, color: "text-blue-600" },
            { label: "Practicing", value: ms.practicing, color: "text-amber-600" },
            { label: "Mastered", value: ms.mastered, color: "text-green-600" },
          ].map((stat) => (
            <div key={stat.label} className="rounded-md bg-gray-50 p-2 text-center">
              <p className={`text-lg font-bold ${stat.color}`}>{stat.value}</p>
              <p className="text-[10px] uppercase tracking-wide text-gray-500">{stat.label}</p>
            </div>
          ))}
        </div>
        <div className="flex items-center gap-2">
          <div className="h-2 flex-1 overflow-hidden rounded-full bg-gray-100">
            <div className="h-full rounded-full bg-green-500" style={{ width: `${ms.percentMastered}%` }} />
          </div>
          <span className="text-sm font-medium text-gray-700">{ms.percentMastered}% mastered</span>
        </div>
      </div>
    );
  }

  // Mastery grid
  if (type === "mastery_grid" && autoData.masteryGrid) {
    const statusColors: Record<string, string> = {
      not_started: "bg-gray-100 text-gray-500",
      presented: "bg-blue-100 text-blue-700",
      practicing: "bg-amber-100 text-amber-700",
      mastered: "bg-green-100 text-green-700",
    };

    return (
      <div className="space-y-1">
        {autoData.masteryGrid.map((item) => (
          <div
            key={item.nodeId}
            className="flex items-center justify-between rounded px-3 py-1.5 text-sm hover:bg-gray-50"
          >
            <span className="text-gray-700">{item.nodeTitle}</span>
            <span
              className={`rounded-full px-2 py-0.5 text-xs font-medium ${
                statusColors[item.status] ?? statusColors.not_started
              }`}
            >
              {item.status.replace("_", " ")}
            </span>
          </div>
        ))}
        {autoData.masteryGrid.length === 0 && (
          <p className="text-sm italic text-gray-400">No mastery data recorded.</p>
        )}
      </div>
    );
  }

  // Attendance summary
  if (type === "attendance_summary" && autoData.attendanceSummary) {
    const att = autoData.attendanceSummary;
    return (
      <div className="space-y-3">
        <div className="grid grid-cols-3 gap-3 sm:grid-cols-6">
          {[
            { label: "Total", value: att.totalDays },
            { label: "Present", value: att.present, color: "text-green-700" },
            { label: "Absent", value: att.absent, color: "text-red-700" },
            { label: "Late", value: att.late, color: "text-amber-700" },
            { label: "Excused", value: att.excused, color: "text-blue-700" },
            { label: "Half Day", value: att.halfDay },
          ].map((stat) => (
            <div
              key={stat.label}
              className="rounded-md border border-gray-100 bg-gray-50 p-2 text-center"
            >
              <p className={`text-lg font-bold ${stat.color ?? "text-gray-900"}`}>{stat.value}</p>
              <p className="text-[10px] uppercase tracking-wide text-gray-500">{stat.label}</p>
            </div>
          ))}
        </div>
        <p className="text-sm text-gray-600">
          Attendance rate: <span className="font-medium text-gray-900">{att.attendanceRate}%</span>
        </p>
      </div>
    );
  }

  // Observation highlights
  if (type === "observation_highlights" && autoData.observationHighlights) {
    return (
      <div className="space-y-3">
        {autoData.observationHighlights.length === 0 ? (
          <p className="text-sm italic text-gray-400">No observations for this period.</p>
        ) : (
          autoData.observationHighlights.map((obs) => (
            <div key={obs.id} className="rounded-md border border-gray-100 bg-gray-50 p-3">
              <div className="flex items-center justify-between text-xs text-gray-500">
                <span>{formatDate(obs.createdAt)}</span>
                <span>By {obs.authorName}</span>
              </div>
              {obs.content && <p className="mt-1 text-sm text-gray-700">{obs.content}</p>}
              {obs.outcomes.length > 0 && (
                <div className="mt-2 flex flex-wrap gap-1">
                  {obs.outcomes.map((outcome, i) => (
                    <span
                      key={i}
                      className="rounded bg-amber-50 px-1.5 py-0.5 text-[10px] font-medium text-amber-700"
                    >
                      {outcome}
                    </span>
                  ))}
                </div>
              )}
            </div>
          ))
        )}
      </div>
    );
  }

  return null;
}

// ============================================================
// Helpers
// ============================================================

function formatDate(dateStr: string): string {
  try {
    const date = new Date(dateStr);
    return date.toLocaleDateString("en-AU", {
      day: "numeric",
      month: "short",
      year: "numeric",
    });
  } catch {
    return dateStr;
  }
}



===== D:\.code\wattleos\src\app\(app)\parent\[studentId]\reports\page.tsx =====

// src/app/(app)/parent/[studentId]/reports/page.tsx
//
// ============================================================
// WattleOS V2 - Child Reports List (Parent View)
// ============================================================
// Server Component. Shows published reports for a child.
// Clicking a report opens the read-only report viewer.
// ============================================================

import { getTenantContext } from '@/lib/auth/tenant-context';
import {
  isGuardianOf,
  getMyChildren,
  getChildReports,
} from '@/lib/actions/parent';
import { redirect } from 'next/navigation';
import Link from 'next/link';

interface PageProps {
  params: Promise<{ studentId: string }>;
}

export default async function ChildReportsPage({ params }: PageProps) {
  const { studentId } = await params;
  await getTenantContext();

  const isGuardian = await isGuardianOf(studentId);
  if (!isGuardian) redirect('/parent');

  const childrenResult = await getMyChildren();
  const child = (childrenResult.data ?? []).find((c) => c.id === studentId);
  if (!child) redirect('/parent');
  const displayName = child.preferredName ?? child.firstName;

  const reportsResult = await getChildReports(studentId);
  const reports = reportsResult.data ?? [];

  return (
    <div className="space-y-6">
      {/* Header */}
      <div>
        <div className="flex items-center gap-2 text-sm text-gray-500">
          <Link href="/parent" className="hover:text-gray-700">
            My Children
          </Link>
          <span className="text-gray-400">/</span>
          <Link href={`/parent/${studentId}`} className="hover:text-gray-700">
            {displayName} {child.lastName}
          </Link>
          <span className="text-gray-400">/</span>
          <span className="text-gray-900">Reports</span>
        </div>
        <h1 className="mt-2 text-2xl font-bold text-gray-900">
          {displayName}&apos;s Reports
        </h1>

        {/* Sub-nav */}
        <div className="mt-4 flex gap-4 border-b border-gray-200">
          <Link
            href={`/parent/${studentId}`}
            className="border-b-2 border-transparent px-1 pb-3 text-sm font-medium text-gray-500 hover:text-gray-700"
          >
            Portfolio
          </Link>
          <Link
            href={`/parent/${studentId}/attendance`}
            className="border-b-2 border-transparent px-1 pb-3 text-sm font-medium text-gray-500 hover:text-gray-700"
          >
            Attendance
          </Link>
          <Link
            href={`/parent/${studentId}/reports`}
            className="border-b-2 border-amber-500 px-1 pb-3 text-sm font-medium text-amber-700"
          >
            Reports
          </Link>
        </div>
      </div>

      {/* Reports list */}
      {reports.length === 0 ? (
        <div className="rounded-lg border border-gray-200 bg-white p-12 text-center">
          <p className="text-sm text-gray-500">
            No published reports yet. Reports will appear here once your child&apos;s
            teacher completes and publishes them.
          </p>
        </div>
      ) : (
        <div className="space-y-3">
          {reports.map((report) => (
            <Link
              key={report.id}
              href={`/parent/${studentId}/reports/${report.id}`}
              className="block rounded-lg border border-gray-200 bg-white p-5 transition-shadow hover:shadow-md"
            >
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-sm font-semibold text-gray-900">
                    {report.term ?? 'Report'}
                  </p>
                  <div className="mt-1 flex items-center gap-3 text-xs text-gray-500">
                    {report.templateName && <span>{report.templateName}</span>}
                    <span>&middot;</span>
                    <span>By {report.authorName}</span>
                    {report.publishedAt && (
                      <>
                        <span>&middot;</span>
                        <span>
                          Published{' '}
                          {new Date(report.publishedAt).toLocaleDateString('en-AU', {
                            day: 'numeric',
                            month: 'short',
                            year: 'numeric',
                          })}
                        </span>
                      </>
                    )}
                  </div>
                </div>
                <svg
                  className="h-5 w-5 text-gray-400"
                  fill="none"
                  viewBox="0 0 24 24"
                  strokeWidth={1.5}
                  stroke="currentColor"
                >
                  <path
                    strokeLinecap="round"
                    strokeLinejoin="round"
                    d="m8.25 4.5 7.5 7.5-7.5 7.5"
                  />
                </svg>
              </div>
            </Link>
          ))}
        </div>
      )}
    </div>
  );
}


===== D:\.code\wattleos\src\app\(app)\parent\announcements\page.tsx =====

// src/app/(app)/parent/announcements/page.tsx
//
// ============================================================
// WattleOS V2 - Parent Announcements Page
// ============================================================
// Server Component. Shows announcements visible to the current
// parent: school-wide + class-targeted for their children's
// classes. Read status tracked for unread badge accuracy.
// ============================================================

import { getTenantContext } from '@/lib/auth/tenant-context';
import { getAnnouncementsForParent } from '@/lib/actions/announcements';
import { ParentAnnouncementFeed } from '@/components/domain/comms/parent-announcement-feed';

export default async function ParentAnnouncementsPage() {
  const context = await getTenantContext();

  const result = await getAnnouncementsForParent({ limit: 30 });
  const announcements = result.data ?? [];

  return (
    <div className="space-y-6">
      <div>
        <h1 className="text-2xl font-semibold text-gray-900">Announcements</h1>
        <p className="mt-1 text-sm text-gray-500">
          News and updates from your school
        </p>
      </div>

      <ParentAnnouncementFeed
        initialAnnouncements={announcements}
      />
    </div>
  );
}


===== D:\.code\wattleos\src\app\(app)\parent\billing\page.tsx =====

// src/app/(app)/parent/billing/page.tsx
//
// ============================================================
// WattleOS V2 - Parent: Billing & Invoices
// ============================================================
// Server Component. Loads invoices for the logged-in parent.
// Parents see their invoices (excluding drafts) with payment
// status and Stripe hosted payment links.
// ============================================================

import { getParentInvoices } from '@/lib/actions/billing';
import { ParentBillingClient } from '@/components/domain/billing/parent-billing-client';

export default async function ParentBillingPage() {
  const result = await getParentInvoices();
  const invoices = result.data ?? [];

  return (
    <div className="space-y-6">
      <div>
        <h1 className="text-2xl font-semibold text-gray-900">Billing</h1>
        <p className="mt-1 text-sm text-gray-500">
          View your invoices and payment history.
        </p>
      </div>

      <ParentBillingClient invoices={invoices} />
    </div>
  );
}


===== D:\.code\wattleos\src\app\(app)\parent\messages\[threadId]\page.tsx =====

// src/app/(app)/parent/messages/[threadId]/page.tsx
//
// ============================================================
// WattleOS V2 - Parent Thread View Page
// ============================================================
// Server Component. Loads thread messages and renders the
// shared ThreadViewClient. Same conversation experience as
// staff - only the back link points to parent inbox.
// ============================================================

import { getTenantContext } from '@/lib/auth/tenant-context';
import { getThreadMessages } from '@/lib/actions/messaging';
import { redirect } from 'next/navigation';
import Link from 'next/link';
import { ThreadViewClient } from '@/components/domain/comms/thread-view-client';

interface ParentThreadPageProps {
  params: Promise<{ threadId: string }>;
}

export default async function ParentThreadPage({ params }: ParentThreadPageProps) {
  const { threadId } = await params;
  const context = await getTenantContext();

  const result = await getThreadMessages(threadId);

  if (result.error) {
    redirect('/parent/messages');
  }

  const { thread, messages, recipients } = result.data!;

  return (
    <div className="space-y-4">
      {/* Back link */}
      <Link
        href="/parent/messages"
        className="inline-flex items-center gap-1 text-sm text-gray-500 hover:text-gray-700"
      >
        <svg className="h-4 w-4" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor">
          <path strokeLinecap="round" strokeLinejoin="round" d="M15.75 19.5 8.25 12l7.5-7.5" />
        </svg>
        Back to Messages
      </Link>

      {/* Thread header */}
      <div className="rounded-lg border border-gray-200 bg-white px-6 py-4 shadow-sm">
        <h1 className="text-lg font-semibold text-gray-900">
          {thread.subject || 'Conversation'}
        </h1>
        <div className="mt-1 flex items-center gap-2 text-sm text-gray-500">
          <span>
            From {recipients.find((r) => r.id !== context.user.id)?.first_name ?? 'Guide'}{' '}
            {recipients.find((r) => r.id !== context.user.id)?.last_name ?? ''}
          </span>
        </div>
      </div>

      <ThreadViewClient
        threadId={thread.id}
        initialMessages={messages}
        recipients={recipients}
        currentUserId={context.user.id}
      />
    </div>
  );
}


===== D:\.code\wattleos\src\app\(app)\parent\messages\page.tsx =====

// src/app/(app)/parent/messages/page.tsx
//
// ============================================================
// WattleOS V2 - Parent Messages Inbox
// ============================================================
// Server Component. Shows all threads the parent participates
// in - class broadcasts and direct messages from guides.
// No permission check - all authenticated parents can see
// threads they're recipients of (enforced by RLS).
// ============================================================

import { getTenantContext } from '@/lib/auth/tenant-context';
import { getInbox } from '@/lib/actions/messaging';
import Link from 'next/link';
import { ParentInboxClient } from '@/components/domain/comms/parent-inbox-client';

export default async function ParentMessagesPage() {
  const context = await getTenantContext();

  const result = await getInbox({ limit: 30 });
  const threads = result.data ?? [];

  return (
    <div className="space-y-6">
      <div>
        <h1 className="text-2xl font-semibold text-gray-900">Messages</h1>
        <p className="mt-1 text-sm text-gray-500">
          Conversations with your child&apos;s guides
        </p>
      </div>

      <ParentInboxClient
        initialThreads={threads}
        currentUserId={context.user.id}
      />
    </div>
  );
}


===== D:\.code\wattleos\src\app\(app)\parent\page.tsx =====

// src/app/(app)/parent/page.tsx
//
// ============================================================
// WattleOS V2 - Parent Dashboard
// ============================================================
// Server Component. Shows overview cards for each child linked
// to the current parent. Each card has recent observations,
// mastery snapshot, attendance, and published report count.
//
// WHY server: All data loads are independent per-child, run
// in parallel on the server for instant render.
// ============================================================

import { getTenantContext } from '@/lib/auth/tenant-context';
import { getMyChildren, getChildOverview } from '@/lib/actions/parent';
import { redirect } from 'next/navigation';
import Link from 'next/link';

export default async function ParentDashboardPage() {
  const context = await getTenantContext();

  const childrenResult = await getMyChildren();
  const children = childrenResult.data ?? [];

  if (children.length === 0) {
    return (
      <div className="space-y-6">
        <div>
          <h1 className="text-2xl font-bold text-gray-900">My Children</h1>
          <p className="mt-1 text-sm text-gray-500">
            Welcome, {context.user.first_name ?? context.user.email}
          </p>
        </div>
        <div className="rounded-lg border border-gray-200 bg-white p-12 text-center">
          <p className="text-sm text-gray-500">
            No children are linked to your account yet. Please contact the school
            to set up your parent access.
          </p>
        </div>
      </div>
    );
  }

  // Load overviews in parallel
  const overviews = await Promise.all(
    children.map((child) => getChildOverview(child.id))
  );

  return (
    <div className="space-y-6">
      {/* Header */}
      <div>
        <h1 className="text-2xl font-bold text-gray-900">My Children</h1>
        <p className="mt-1 text-sm text-gray-500">
          Welcome, {context.user.first_name ?? context.user.email}. Here&apos;s
          what&apos;s happening with your children.
        </p>
      </div>

      {/* Child cards */}
      <div className="space-y-6">
        {overviews.map((result, index) => {
          const overview = result.data;
          if (!overview) return null;

          return (
            <ChildOverviewCard
              key={children[index].id}
              overview={overview}
            />
          );
        })}
      </div>
    </div>
  );
}

// ============================================================
// ChildOverviewCard
// ============================================================

import type { ChildOverview } from '@/lib/actions/parent';

function ChildOverviewCard({ overview }: { overview: ChildOverview }) {
  const { child, attendance, recentObservations, mastery, publishedReportCount } =
    overview;
  const displayName = child.preferredName ?? child.firstName;

  return (
    <div className="overflow-hidden rounded-lg border border-gray-200 bg-white">
      {/* Child header */}
      <div className="flex items-center gap-4 border-b border-gray-100 px-6 py-4">
        {child.photoUrl ? (
          <img
            src={child.photoUrl}
            alt=""
            className="h-14 w-14 rounded-full object-cover"
          />
        ) : (
          <div className="flex h-14 w-14 items-center justify-center rounded-full bg-amber-100 text-lg font-bold text-amber-700">
            {child.firstName[0]}
            {child.lastName[0]}
          </div>
        )}
        <div className="min-w-0 flex-1">
          <h2 className="text-lg font-semibold text-gray-900">
            {displayName} {child.lastName}
          </h2>
          <div className="flex items-center gap-3 text-sm text-gray-500">
            {child.className && <span>{child.className}</span>}
            {child.relationship && (
              <>
                <span>&middot;</span>
                <span className="capitalize">{child.relationship}</span>
              </>
            )}
          </div>
        </div>
        <Link
          href={`/parent/${child.id}`}
          className="rounded-md bg-amber-600 px-4 py-2 text-sm font-medium text-white transition-colors hover:bg-amber-700"
        >
          View Portfolio
        </Link>
      </div>

      {/* Stats row */}
      <div className="grid grid-cols-2 gap-px bg-gray-100 sm:grid-cols-4">
        {/* Attendance */}
        <div className="bg-white px-4 py-4">
          <p className="text-xs font-medium uppercase tracking-wider text-gray-500">
            Attendance (30d)
          </p>
          <div className="mt-2 flex items-end gap-2">
            <span className="text-2xl font-bold text-gray-900">
              {attendance.attendanceRate}%
            </span>
          </div>
          <p className="mt-1 text-xs text-gray-500">
            {attendance.present} present, {attendance.absent} absent, {attendance.late} late
          </p>
          <Link
            href={`/parent/${child.id}/attendance`}
            className="mt-2 inline-block text-xs font-medium text-amber-600 hover:text-amber-700"
          >
            View details â†’
          </Link>
        </div>

        {/* Mastery */}
        <div className="bg-white px-4 py-4">
          <p className="text-xs font-medium uppercase tracking-wider text-gray-500">
            Learning Progress
          </p>
          <div className="mt-2 flex items-end gap-2">
            <span className="text-2xl font-bold text-gray-900">
              {mastery.percentMastered}%
            </span>
            <span className="mb-0.5 text-xs text-gray-500">mastered</span>
          </div>
          <div className="mt-1 flex gap-2 text-xs text-gray-500">
            <span className="text-green-600">{mastery.mastered} mastered</span>
            <span className="text-amber-600">{mastery.practicing} practicing</span>
            <span className="text-blue-600">{mastery.presented} presented</span>
          </div>
          <Link
            href={`/parent/${child.id}`}
            className="mt-2 inline-block text-xs font-medium text-amber-600 hover:text-amber-700"
          >
            View progress â†’
          </Link>
        </div>

        {/* Observations */}
        <div className="bg-white px-4 py-4">
          <p className="text-xs font-medium uppercase tracking-wider text-gray-500">
            Recent Observations
          </p>
          <div className="mt-2">
            {recentObservations.length === 0 ? (
              <p className="text-sm text-gray-400 italic">None yet</p>
            ) : (
              <div className="space-y-1.5">
                {recentObservations.slice(0, 2).map((obs) => (
                  <div key={obs.id} className="text-xs">
                    <p className="truncate text-gray-700">
                      {obs.content?.slice(0, 80) ?? 'Observation'}
                      {obs.mediaCount > 0 && (
                        <span className="ml-1 text-gray-400">ðŸ“·{obs.mediaCount}</span>
                      )}
                    </p>
                    <p className="text-gray-400">
                      {obs.authorName} &middot;{' '}
                      {formatRelativeDate(obs.createdAt)}
                    </p>
                  </div>
                ))}
              </div>
            )}
          </div>
          <Link
            href={`/parent/${child.id}`}
            className="mt-2 inline-block text-xs font-medium text-amber-600 hover:text-amber-700"
          >
            View all â†’
          </Link>
        </div>

        {/* Reports */}
        <div className="bg-white px-4 py-4">
          <p className="text-xs font-medium uppercase tracking-wider text-gray-500">
            Reports
          </p>
          <div className="mt-2 flex items-end gap-2">
            <span className="text-2xl font-bold text-gray-900">
              {publishedReportCount}
            </span>
            <span className="mb-0.5 text-xs text-gray-500">published</span>
          </div>
          {publishedReportCount > 0 && (
            <Link
              href={`/parent/${child.id}/reports`}
              className="mt-2 inline-block text-xs font-medium text-amber-600 hover:text-amber-700"
            >
              Read reports â†’
            </Link>
          )}
        </div>
      </div>
    </div>
  );
}

// ============================================================
// Helpers
// ============================================================

function formatRelativeDate(dateStr: string): string {
  const date = new Date(dateStr);
  const now = new Date();
  const diffMs = now.getTime() - date.getTime();
  const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

  if (diffDays === 0) return 'Today';
  if (diffDays === 1) return 'Yesterday';
  if (diffDays < 7) return `${diffDays} days ago`;
  if (diffDays < 30) return `${Math.floor(diffDays / 7)} weeks ago`;
  return date.toLocaleDateString('en-AU', { day: 'numeric', month: 'short' });
}


===== D:\.code\wattleos\src\app\(app)\parent\settings\page.tsx =====

// src/app/(app)/parent/settings/page.tsx
//
// ============================================================
// WattleOS V2 - Parent Settings
// ============================================================
// Server Component. Shows consent toggles and contact info
// for each child. Parents can update their own phone number
// and toggle media/directory consent without staff help.
// ============================================================

import { getTenantContext } from '@/lib/auth/tenant-context';
import { getMySettings } from '@/lib/actions/parent';
import Link from 'next/link';
import { ConsentToggle } from '@/components/domain/parent/ConsentToggle';
import { ContactInfoForm } from '@/components/domain/parent/ContactInfoForm';

export default async function ParentSettingsPage() {
  const context = await getTenantContext();

  const settingsResult = await getMySettings();
  const settings = settingsResult.data ?? [];

  return (
    <div className="mx-auto max-w-2xl space-y-6">
      {/* Header */}
      <div>
        <div className="flex items-center gap-2 text-sm text-gray-500">
          <Link href="/parent" className="hover:text-gray-700">
            My Children
          </Link>
          <span className="text-gray-400">/</span>
          <span className="text-gray-900">Settings</span>
        </div>
        <h1 className="mt-2 text-2xl font-bold text-gray-900">My Settings</h1>
        <p className="mt-1 text-sm text-gray-500">
          Manage your contact information and consent preferences for each child.
        </p>
      </div>

      {settings.length === 0 ? (
        <div className="rounded-lg border border-gray-200 bg-white p-8 text-center">
          <p className="text-sm text-gray-500">
            No children linked to your account.
          </p>
        </div>
      ) : (
        <div className="space-y-6">
          {settings.map((guardianSetting) => (
            <div
              key={guardianSetting.guardianId}
              className="rounded-lg border border-gray-200 bg-white"
            >
              {/* Child header */}
              <div className="flex items-center gap-3 border-b border-gray-100 px-6 py-4">
                {guardianSetting.studentPhotoUrl ? (
                  <img
                    src={guardianSetting.studentPhotoUrl}
                    alt=""
                    className="h-10 w-10 rounded-full object-cover"
                  />
                ) : (
                  <div className="flex h-10 w-10 items-center justify-center rounded-full bg-amber-100 text-sm font-bold text-amber-700">
                    {guardianSetting.studentName[0]}
                  </div>
                )}
                <div>
                  <p className="text-sm font-semibold text-gray-900">
                    {guardianSetting.studentName}
                  </p>
                  <p className="text-xs text-gray-500">
                    {guardianSetting.relationship}
                    {guardianSetting.isPrimary && ' Â· Primary contact'}
                  </p>
                </div>
              </div>

              <div className="space-y-5 px-6 py-5">
                {/* Contact info */}
                <div>
                  <h3 className="text-sm font-medium text-gray-900">
                    Contact Information
                  </h3>
                  <ContactInfoForm
                    guardianId={guardianSetting.guardianId}
                    initialPhone={guardianSetting.phone}
                  />
                </div>

                {/* Consent toggles */}
                <div>
                  <h3 className="text-sm font-medium text-gray-900">
                    Consent Preferences
                  </h3>
                  <p className="mt-1 text-xs text-gray-500">
                    These settings control how your child&apos;s information is used.
                  </p>
                  <div className="mt-3 space-y-3">
                    <ConsentToggle
                      guardianId={guardianSetting.guardianId}
                      consentType="media"
                      label="Media Consent"
                      description="Allow the school to publish photos and videos of your child in portfolios and communications."
                      initialValue={guardianSetting.mediaConsent}
                    />
                    <ConsentToggle
                      guardianId={guardianSetting.guardianId}
                      consentType="directory"
                      label="Directory Consent"
                      description="Allow your family to be included in the school directory shared with other families."
                      initialValue={guardianSetting.directoryConsent}
                    />
                  </div>
                </div>

                {/* Pickup status (read-only) */}
                <div>
                  <h3 className="text-sm font-medium text-gray-900">
                    Pickup Authorization
                  </h3>
                  <p className="mt-1 text-xs text-gray-500">
                    {guardianSetting.pickupAuthorized
                      ? 'You are authorized to pick up this child.'
                      : 'You are not currently authorized for pickup. Contact the school to update.'}
                  </p>
                  <div className="mt-2">
                    <span
                      className={`inline-flex rounded-full px-2.5 py-1 text-xs font-medium ${
                        guardianSetting.pickupAuthorized
                          ? 'bg-green-100 text-green-700'
                          : 'bg-red-100 text-red-700'
                      }`}
                    >
                      {guardianSetting.pickupAuthorized ? 'Authorized' : 'Not Authorized'}
                    </span>
                  </div>
                </div>
              </div>
            </div>
          ))}
        </div>
      )}
    </div>
  );
}


===== D:\.code\wattleos\src\app\(app)\pedagogy\curriculum\[instanceId]\page.tsx =====

import { getCurriculumTree } from '@/lib/actions/curriculum';
import { getTenantContext, hasPermission } from '@/lib/auth/tenant-context';
import { Permissions } from '@/lib/constants/permissions';
import { buildTree, countNodes } from '@/lib/utils/curriculum-tree';
import { createSupabaseServerClient } from '@/lib/supabase/server';
import { redirect } from 'next/navigation';
import Link from 'next/link';
import { CurriculumTreeView } from '@/components/domain/curriculum/curriculum-tree-view';
import type { CurriculumInstance } from '@/types/domain';

interface PageProps {
  params: Promise<{ instanceId: string }>;
}

export default async function CurriculumInstancePage({ params }: PageProps) {
  const { instanceId } = await params;
  const context = await getTenantContext();
  const canManage = hasPermission(context, Permissions.MANAGE_CURRICULUM);
  const supabase = await createSupabaseServerClient();

  // Fetch the instance metadata
  const { data: instance, error: instanceError } = await supabase
    .from('curriculum_instances')
    .select('*')
    .eq('id', instanceId)
    .is('deleted_at', null)
    .single();

  if (instanceError || !instance) {
    redirect('/pedagogy/curriculum');
  }

  // Fetch the full node tree
  const treeResult = await getCurriculumTree(instanceId);
  const flatNodes = treeResult.data ?? [];
  const tree = buildTree(flatNodes);
  const totalNodes = countNodes(tree);

  // Count by level
  const areaCt = flatNodes.filter((n) => n.level === 'area').length;
  const strandCt = flatNodes.filter((n) => n.level === 'strand').length;
  const outcomeCt = flatNodes.filter((n) => n.level === 'outcome').length;
  const activityCt = flatNodes.filter((n) => n.level === 'activity').length;

  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="flex items-start justify-between">
        <div>
          <div className="flex items-center gap-2">
            <Link
              href="/pedagogy/curriculum"
              className="text-sm text-gray-500 hover:text-gray-700"
            >
              Curriculum
            </Link>
            <span className="text-sm text-gray-400">/</span>
            <h1 className="text-2xl font-bold text-gray-900">
              {(instance as CurriculumInstance).name}
            </h1>
          </div>
          {(instance as CurriculumInstance).description && (
            <p className="mt-1 text-sm text-gray-500">
              {(instance as CurriculumInstance).description}
            </p>
          )}
        </div>
      </div>

      {/* Stats bar */}
      <div className="flex flex-wrap gap-3">
        <StatBadge label="Total" count={totalNodes} color="gray" />
        <StatBadge label="Areas" count={areaCt} color="purple" />
        <StatBadge label="Strands" count={strandCt} color="blue" />
        <StatBadge label="Outcomes" count={outcomeCt} color="green" />
        {activityCt > 0 && (
          <StatBadge label="Activities" count={activityCt} color="amber" />
        )}
      </div>

      {/* Tree */}
      <CurriculumTreeView
        instanceId={instanceId}
        initialTree={tree}
        canManage={canManage}
      />
    </div>
  );
}

function StatBadge({
  label,
  count,
  color,
}: {
  label: string;
  count: number;
  color: string;
}) {
  const colors: Record<string, string> = {
    gray: 'bg-gray-100 text-gray-700',
    purple: 'bg-purple-100 text-purple-700',
    blue: 'bg-blue-100 text-blue-700',
    green: 'bg-green-100 text-green-700',
    amber: 'bg-amber-100 text-amber-700',
  };

  return (
    <span
      className={`inline-flex items-center gap-1.5 rounded-full px-3 py-1 text-xs font-medium ${colors[color] ?? colors.gray}`}
    >
      <span className="font-bold">{count}</span> {label}
    </span>
  );
}



===== D:\.code\wattleos\src\app\(app)\pedagogy\curriculum\page.tsx =====

import { listCurriculumInstances, listCurriculumTemplates } from '@/lib/actions/curriculum';
import { getTenantContext, hasPermission } from '@/lib/auth/tenant-context';
import { Permissions } from '@/lib/constants/permissions';
import Link from 'next/link';
import { ForkTemplateButton } from '@/components/domain/curriculum/fork-template-button';
import { CreateBlankButton } from '@/components/domain/curriculum/create-blank-button';

export default async function CurriculumPage() {
  const context = await getTenantContext();
  const canManage = hasPermission(context, Permissions.MANAGE_CURRICULUM);

  const [instancesResult, templatesResult] = await Promise.all([
    listCurriculumInstances(),
    listCurriculumTemplates(),
  ]);

  const instances = instancesResult.data ?? [];
  const templates = templatesResult.data ?? [];

  return (
    <div className="space-y-8">
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-2xl font-bold text-gray-900">Curriculum</h1>
          <p className="mt-1 text-sm text-gray-500">
            Manage your school&apos;s curriculum frameworks
          </p>
        </div>
      </div>

      {/* Existing instances */}
      {instances.length > 0 && (
        <div className="space-y-3">
          <h2 className="text-lg font-semibold text-gray-900">
            Your Curricula
          </h2>
          <div className="grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
            {instances.map((instance) => (
              <Link
                key={instance.id}
                href={`/pedagogy/curriculum/${instance.id}`}
                className="block rounded-lg border border-gray-200 bg-white p-5 transition-shadow hover:shadow-md"
              >
                <h3 className="text-sm font-semibold text-gray-900">
                  {instance.name}
                </h3>
                {instance.description && (
                  <p className="mt-1 line-clamp-2 text-xs text-gray-500">
                    {instance.description}
                  </p>
                )}
                <div className="mt-3 flex items-center gap-2">
                  <span
                    className={`inline-flex items-center rounded-full px-2 py-0.5 text-xs font-medium ${
                      instance.is_active
                        ? 'bg-green-100 text-green-700'
                        : 'bg-gray-100 text-gray-500'
                    }`}
                  >
                    {instance.is_active ? 'Active' : 'Inactive'}
                  </span>
                  {instance.source_template_id && (
                    <span className="inline-flex items-center rounded-full bg-purple-100 px-2 py-0.5 text-xs font-medium text-purple-700">
                      From Template
                    </span>
                  )}
                </div>
              </Link>
            ))}
          </div>
        </div>
      )}

      {/* Fork from template or create blank */}
      {canManage && (
        <div className="space-y-3">
          <h2 className="text-lg font-semibold text-gray-900">
            {instances.length > 0
              ? 'Add Another Curriculum'
              : 'Get Started'}
          </h2>
          <p className="text-sm text-gray-500">
            {instances.length > 0
              ? 'Fork from a standard framework or start from scratch.'
              : 'Choose a Montessori curriculum framework to get started instantly, or build your own from scratch.'}
          </p>

          {templates.length > 0 && (
            <div className="grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
              {templates.map((template) => (
                <div
                  key={template.id}
                  className="rounded-lg border border-dashed border-purple-300 bg-purple-50 p-5"
                >
                  <h3 className="text-sm font-semibold text-purple-900">
                    {template.name}
                  </h3>
                  <p className="mt-1 text-xs text-purple-700">
                    {template.framework} &middot; Ages {template.age_range}
                  </p>
                  {template.description && (
                    <p className="mt-2 line-clamp-2 text-xs text-purple-600">
                      {template.description}
                    </p>
                  )}
                  <div className="mt-4">
                    <ForkTemplateButton
                      templateId={template.id}
                      templateName={template.name}
                    />
                  </div>
                </div>
              ))}

              {/* Create blank option */}
              <div className="rounded-lg border border-dashed border-gray-300 bg-gray-50 p-5">
                <h3 className="text-sm font-semibold text-gray-700">
                  Start from Scratch
                </h3>
                <p className="mt-1 text-xs text-gray-500">
                  Build a custom curriculum with your own areas, strands, and
                  outcomes.
                </p>
                <div className="mt-4">
                  <CreateBlankButton />
                </div>
              </div>
            </div>
          )}
        </div>
      )}

      {/* Empty state for non-managers */}
      {!canManage && instances.length === 0 && (
        <div className="rounded-lg border border-gray-200 bg-white p-8 text-center">
          <p className="text-sm text-gray-500">
            No curriculum has been set up yet. Ask your school administrator to
            configure one.
          </p>
        </div>
      )}
    </div>
  );
}



===== D:\.code\wattleos\src\app\(app)\pedagogy\layout.tsx =====

export default function PedagogyLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return <>{children}</>;
}



===== D:\.code\wattleos\src\app\(app)\pedagogy\mastery\heatmap\page.tsx =====

import { getTenantContext, hasPermission } from '@/lib/auth/tenant-context';
import { Permissions } from '@/lib/constants/permissions';
import { listStudents } from '@/lib/actions/students';
import { listCurriculumInstances, getCurriculumTree } from '@/lib/actions/curriculum';
import { getClassMasteryHeatmap } from '@/lib/actions/mastery';
import { buildTree } from '@/lib/utils/curriculum-tree';
import { ClassHeatmap } from '@/components/domain/mastery/class-heatmap';
import Link from 'next/link';

interface PageProps {
  searchParams: Promise<{ instance?: string }>;
}

export default async function HeatmapPage({ searchParams }: PageProps) {
  const { instance: instanceParam } = await searchParams;
  const context = await getTenantContext();
  const canViewStudents = hasPermission(context, Permissions.VIEW_STUDENTS);

  if (!canViewStudents) {
    return (
      <div className="rounded-lg border border-gray-200 bg-white p-8 text-center">
        <p className="text-sm text-gray-500">
          You do not have permission to view student data.
        </p>
      </div>
    );
  }

  const [studentsResult, instancesResult] = await Promise.all([
    listStudents(),
    listCurriculumInstances(),
  ]);

  const students = studentsResult.data ?? [];
  const instances = instancesResult.data ?? [];

  if (instances.length === 0 || students.length === 0) {
    return (
      <div className="space-y-4">
        <div className="flex items-center gap-2">
          <Link
            href="/pedagogy/mastery"
            className="text-sm text-gray-500 hover:text-gray-700"
          >
            Mastery
          </Link>
          <span className="text-sm text-gray-400">/</span>
          <h1 className="text-2xl font-bold text-gray-900">Class Heatmap</h1>
        </div>
        <div className="rounded-lg border border-gray-200 bg-white p-8 text-center">
          <p className="text-sm text-gray-500">
            {instances.length === 0
              ? 'Set up a curriculum first.'
              : 'Add students first.'}
          </p>
        </div>
      </div>
    );
  }

  // Use specified instance or default to first
  const selectedInstanceId = instanceParam ?? instances[0].id;
  const selectedInstance = instances.find((i) => i.id === selectedInstanceId) ?? instances[0];

  // Load tree and heatmap data
  const studentIds = students.map((s) => s.id);
  const [treeResult, heatmapResult] = await Promise.all([
    getCurriculumTree(selectedInstance.id),
    getClassMasteryHeatmap(selectedInstance.id, studentIds),
  ]);

  const tree = buildTree(treeResult.data ?? []);
  const heatmapRows = heatmapResult.data ?? [];

  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
        <div className="flex items-center gap-2">
          <Link
            href="/pedagogy/mastery"
            className="text-sm text-gray-500 hover:text-gray-700"
          >
            Mastery
          </Link>
          <span className="text-sm text-gray-400">/</span>
          <h1 className="text-2xl font-bold text-gray-900">Class Heatmap</h1>
        </div>

        {/* Instance selector */}
        {instances.length > 1 && (
          <div className="flex items-center gap-2">
            <span className="text-sm text-gray-500">Curriculum:</span>
            <div className="flex gap-1">
              {instances.map((inst) => (
                <Link
                  key={inst.id}
                  href={`/pedagogy/mastery/heatmap?instance=${inst.id}`}
                  className={`rounded-md px-3 py-1.5 text-xs font-medium transition-colors ${
                    inst.id === selectedInstance.id
                      ? 'bg-amber-600 text-white'
                      : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                  }`}
                >
                  {inst.name}
                </Link>
              ))}
            </div>
          </div>
        )}
      </div>

      <p className="text-sm text-gray-500">
        Viewing <span className="font-medium">{selectedInstance.name}</span> across{' '}
        <span className="font-medium">{students.length}</span> students.
        Each cell represents a student&apos;s mastery status for one curriculum outcome.
      </p>

      {/* Heatmap */}
      <ClassHeatmap
        rows={heatmapRows}
        tree={tree}
        instanceName={selectedInstance.name}
      />
    </div>
  );
}



===== D:\.code\wattleos\src\app\(app)\pedagogy\mastery\mastery-page-client.tsx =====

"use client";

import { MasteryGrid } from "@/components/domain/mastery/mastery-grid";
import { MasteryHistoryPanel } from "@/components/domain/mastery/mastery-history-panel";
import { StudentPicker } from "@/components/domain/mastery/student-picker";
import { getCurriculumTree } from "@/lib/actions/curriculum";
import type {
  MasteryHistoryWithMeta,
  MasteryWithNode,
} from "@/lib/actions/mastery";
import {
  getStudentMastery,
  getStudentMasteryHistory,
  getStudentMasterySummary,
} from "@/lib/actions/mastery";
import type { CurriculumTreeNode } from "@/lib/utils/curriculum-tree";
import { buildTree } from "@/lib/utils/curriculum-tree";
import type { CurriculumInstance, Student } from "@/types/domain";
import Link from "next/link";
import { useCallback, useEffect, useState } from "react";

interface MasteryPageClientProps {
  students: Student[];
  instances: CurriculumInstance[];
  canManage: boolean;
}

export function MasteryPageClient({
  students,
  instances,
  canManage,
}: MasteryPageClientProps) {
  const [selectedStudentId, setSelectedStudentId] = useState<string | null>(
    students.length > 0 ? students[0].id : null,
  );
  const [selectedInstanceId, setSelectedInstanceId] = useState<string>(
    instances[0]?.id ?? "",
  );
  const [tree, setTree] = useState<CurriculumTreeNode[]>([]);
  const [masteryData, setMasteryData] = useState<MasteryWithNode[]>([]);
  const [summary, setSummary] = useState({
    total: 0,
    not_started: 0,
    presented: 0,
    practicing: 0,
    mastered: 0,
  });
  const [history, setHistory] = useState<MasteryHistoryWithMeta[]>([]);
  const [isLoading, setIsLoading] = useState(false);

  const loadData = useCallback(async () => {
    if (!selectedStudentId || !selectedInstanceId) return;

    setIsLoading(true);

    const [treeResult, masteryResult, summaryResult, historyResult] =
      await Promise.all([
        getCurriculumTree(selectedInstanceId),
        getStudentMastery(selectedStudentId, selectedInstanceId),
        getStudentMasterySummary(selectedStudentId, selectedInstanceId),
        getStudentMasteryHistory(selectedStudentId, 20),
      ]);

    if (treeResult.data) {
      setTree(buildTree(treeResult.data));
    }
    if (masteryResult.data) {
      setMasteryData(masteryResult.data);
    }
    if (summaryResult.data) {
      setSummary(summaryResult.data);
    }
    if (historyResult.data) {
      setHistory(historyResult.data);
    }

    setIsLoading(false);
  }, [selectedStudentId, selectedInstanceId]);

  useEffect(() => {
    loadData();
  }, [loadData]);

  const selectedStudent = students.find((s) => s.id === selectedStudentId);
  const studentName = selectedStudent
    ? `${selectedStudent.preferred_name ?? selectedStudent.first_name} ${selectedStudent.last_name}`
    : "";

  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
        <div>
          <h1 className="text-2xl font-bold text-gray-900">Mastery Tracking</h1>
          <p className="mt-1 text-sm text-gray-500">
            Track student progress across curriculum outcomes
          </p>
        </div>
        {selectedStudentId && (
          <Link
            href={`/pedagogy/portfolio/${selectedStudentId}`}
            className="inline-flex items-center gap-1.5 rounded-md border border-gray-300 px-3 py-1.5 text-sm font-medium text-gray-700 hover:bg-gray-50"
          >
            <svg
              className="h-4 w-4"
              fill="none"
              viewBox="0 0 24 24"
              strokeWidth={1.5}
              stroke="currentColor"
            >
              <path
                strokeLinecap="round"
                strokeLinejoin="round"
                d="M12 6.042A8.967 8.967 0 0 0 6 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 0 1 6 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 0 1 6-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0 0 18 18a8.967 8.967 0 0 0-6 2.292m0-14.25v14.25"
              />
            </svg>
            View Portfolio
          </Link>
        )}
      </div>

      {/* Selectors */}
      <div className="flex flex-col gap-3 sm:flex-row sm:items-center">
        <StudentPicker
          students={students}
          selectedStudentId={selectedStudentId}
          onSelect={setSelectedStudentId}
        />

        {instances.length > 1 && (
          <select
            value={selectedInstanceId}
            onChange={(e) => setSelectedInstanceId(e.target.value)}
            className="rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm focus:border-ring focus:outline-none focus:ring-1 focus:ring-ring"
          >
            {instances.map((inst) => (
              <option key={inst.id} value={inst.id}>
                {inst.name}
              </option>
            ))}
          </select>
        )}

        <Link
          href="/pedagogy/mastery/heatmap"
          className="inline-flex items-center gap-1.5 rounded-md border border-gray-300 px-3 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50"
        >
          <svg
            className="h-4 w-4"
            fill="none"
            viewBox="0 0 24 24"
            strokeWidth={1.5}
            stroke="currentColor"
          >
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              d="M3.75 6A2.25 2.25 0 0 1 6 3.75h2.25A2.25 2.25 0 0 1 10.5 6v2.25a2.25 2.25 0 0 1-2.25 2.25H6a2.25 2.25 0 0 1-2.25-2.25V6ZM3.75 15.75A2.25 2.25 0 0 1 6 13.5h2.25a2.25 2.25 0 0 1 2.25 2.25V18a2.25 2.25 0 0 1-2.25 2.25H6A2.25 2.25 0 0 1 3.75 18v-2.25ZM13.5 6a2.25 2.25 0 0 1 2.25-2.25H18A2.25 2.25 0 0 1 20.25 6v2.25A2.25 2.25 0 0 1 18 10.5h-2.25a2.25 2.25 0 0 1-2.25-2.25V6ZM13.5 15.75a2.25 2.25 0 0 1 2.25-2.25H18a2.25 2.25 0 0 1 2.25 2.25V18A2.25 2.25 0 0 1 18 20.25h-2.25a2.25 2.25 0 0 1-2.25-2.25v-2.25Z"
            />
          </svg>
          Class Heatmap
        </Link>
      </div>

      {/* Loading */}
      {isLoading && (
        <div className="flex items-center justify-center py-12">
          <div className="h-8 w-8 animate-spin rounded-full border-4 border-gray-200 border-t-amber-500" />
        </div>
      )}

      {/* Content */}
      {!isLoading && selectedStudentId && (
        <div className="grid gap-6 lg:grid-cols-[1fr_300px]">
          {/* Main mastery grid */}
          <div>
            <MasteryGrid
              studentId={selectedStudentId}
              studentName={studentName}
              tree={tree}
              masteryData={masteryData}
              canManage={canManage}
              summary={summary}
            />
          </div>

          {/* Sidebar: recent history */}
          <div className="space-y-4">
            <MasteryHistoryPanel history={history} />
          </div>
        </div>
      )}
    </div>
  );
}



===== D:\.code\wattleos\src\app\(app)\pedagogy\mastery\page.tsx =====

import { getTenantContext, hasPermission } from '@/lib/auth/tenant-context';
import { Permissions } from '@/lib/constants/permissions';
import { listStudents } from '@/lib/actions/students';
import { listCurriculumInstances } from '@/lib/actions/curriculum';
import { MasteryPageClient } from './mastery-page-client';

export default async function MasteryPage() {
  const context = await getTenantContext();
  const canManage = hasPermission(context, Permissions.MANAGE_MASTERY);
  const canViewStudents = hasPermission(context, Permissions.VIEW_STUDENTS);

  if (!canViewStudents) {
    return (
      <div className="rounded-lg border border-gray-200 bg-white p-8 text-center">
        <p className="text-sm text-gray-500">
          You do not have permission to view student data.
        </p>
      </div>
    );
  }

  const [studentsResult, instancesResult] = await Promise.all([
    listStudents(),
    listCurriculumInstances(),
  ]);

  const students = studentsResult.data ?? [];
  const instances = instancesResult.data ?? [];

  if (instances.length === 0) {
    return (
      <div className="space-y-4">
        <div>
          <h1 className="text-2xl font-bold text-gray-900">Mastery Tracking</h1>
          <p className="mt-1 text-sm text-gray-500">
            Track student progress across curriculum outcomes
          </p>
        </div>
        <div className="rounded-lg border border-gray-200 bg-white p-8 text-center">
          <p className="text-sm text-gray-500">
            Set up a curriculum first before tracking mastery.
          </p>
          <a
            href="/pedagogy/curriculum"
            className="mt-3 inline-block rounded-md bg-amber-600 px-4 py-2 text-sm font-medium text-white hover:bg-amber-700"
          >
            Go to Curriculum
          </a>
        </div>
      </div>
    );
  }

  if (students.length === 0) {
    return (
      <div className="space-y-4">
        <div>
          <h1 className="text-2xl font-bold text-gray-900">Mastery Tracking</h1>
          <p className="mt-1 text-sm text-gray-500">
            Track student progress across curriculum outcomes
          </p>
        </div>
        <div className="rounded-lg border border-gray-200 bg-white p-8 text-center">
          <p className="text-sm text-gray-500">
            Add students before tracking mastery.
          </p>
          <a
            href="/students"
            className="mt-3 inline-block rounded-md bg-amber-600 px-4 py-2 text-sm font-medium text-white hover:bg-amber-700"
          >
            Manage Students
          </a>
        </div>
      </div>
    );
  }

  return (
    <MasteryPageClient
      students={students}
      instances={instances}
      canManage={canManage}
    />
  );
}



===== D:\.code\wattleos\src\app\(app)\pedagogy\observations\[observationId]\page.tsx =====

// src/app/(app)/pedagogy/observations/[observationId]/page.tsx
//
// ============================================================
// WattleOS V2 - Observation Detail Page
// ============================================================
// Server Component. Shows a single observation with full content,
// media gallery, student tags, outcome tags, and actions.
//
// CHANGES from previous version:
// - Replaced inline media rendering with MediaGallery variant="full"
// - Uses flat .students / .outcomes / .media (Batch 1 type fix)
// ============================================================

import { getObservation } from '@/lib/actions/observations';
import { getTenantContext, hasPermission } from '@/lib/auth/tenant-context';
import { Permissions } from '@/lib/constants/permissions';
import { redirect } from 'next/navigation';
import Link from 'next/link';
import { ObservationDetailActions } from '@/components/domain/observations/observation-detail-actions';
import { MediaGallery } from '@/components/domain/observations/media-gallery';

interface PageProps {
  params: Promise<{ observationId: string }>;
}

export default async function ObservationDetailPage({ params }: PageProps) {
  const { observationId } = await params;
  const context = await getTenantContext();
  const canPublish = hasPermission(context, Permissions.PUBLISH_OBSERVATION);

  const result = await getObservation(observationId);

  if (!result.data) {
    redirect('/pedagogy/observations');
  }

  const obs = result.data;
  const authorName =
    [obs.author.first_name, obs.author.last_name]
      .filter(Boolean)
      .join(' ') || 'Unknown';
  const isAuthor = obs.author.id === context.user.id;

  return (
    <div className="mx-auto max-w-3xl space-y-6">
      {/* Breadcrumb */}
      <div className="flex items-center gap-2 text-sm">
        <Link
          href="/pedagogy/observations"
          className="text-gray-500 hover:text-gray-700"
        >
          Observations
        </Link>
        <span className="text-gray-400">/</span>
        <span className="text-gray-900">Detail</span>
      </div>

      <div className="rounded-lg border border-gray-200 bg-white">
        <div className="p-6">
          {/* Header */}
          <div className="flex items-start justify-between">
            <div className="flex items-center gap-3">
              <div className="flex h-10 w-10 flex-shrink-0 items-center justify-center rounded-full bg-gray-200 text-sm font-medium text-gray-600">
                {obs.author.avatar_url ? (
                  <img
                    src={obs.author.avatar_url}
                    alt={authorName}
                    className="h-10 w-10 rounded-full object-cover"
                  />
                ) : (
                  authorName.charAt(0).toUpperCase()
                )}
              </div>
              <div>
                <p className="text-sm font-medium text-gray-900">
                  {authorName}
                </p>
                <p className="text-xs text-gray-500">
                  {new Date(obs.created_at).toLocaleDateString('en-AU', {
                    weekday: 'long',
                    day: 'numeric',
                    month: 'long',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                  })}
                </p>
              </div>
            </div>

            <span
              className={`inline-flex rounded-full px-3 py-1 text-xs font-medium ${
                obs.status === 'draft'
                  ? 'bg-amber-100 text-amber-700'
                  : obs.status === 'published'
                    ? 'bg-green-100 text-green-700'
                    : 'bg-gray-100 text-gray-500'
              }`}
            >
              {obs.status.charAt(0).toUpperCase() + obs.status.slice(1)}
            </span>
          </div>

          {/* Published date */}
          {obs.published_at && (
            <p className="mt-2 text-xs text-green-600">
              Published{' '}
              {new Date(obs.published_at).toLocaleDateString('en-AU', {
                day: 'numeric',
                month: 'long',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
              })}
            </p>
          )}

          {/* Content */}
          {obs.content && (
            <div className="mt-4">
              <p className="whitespace-pre-wrap text-sm leading-relaxed text-gray-700">
                {obs.content}
              </p>
            </div>
          )}

          {/* Media gallery - full variant with larger thumbnails + lightbox */}
          {obs.media.length > 0 && (
            <MediaGallery media={obs.media} variant="full" />
          )}

          {/* Students */}
          {obs.students.length > 0 && (
            <div className="mt-5 border-t border-gray-100 pt-4">
              <h3 className="text-xs font-semibold uppercase tracking-wider text-gray-500">
                Students
              </h3>
              <div className="mt-2 flex flex-wrap gap-2">
                {obs.students.map((student) => (
                  <Link
                    key={student.id}
                    href={`/students/${student.id}`}
                    className="inline-flex items-center gap-2 rounded-full bg-blue-50 px-3 py-1.5 text-sm font-medium text-blue-700 transition-colors hover:bg-blue-100"
                  >
                    {student.photo_url ? (
                      <img
                        src={student.photo_url}
                        alt=""
                        className="h-5 w-5 rounded-full object-cover"
                      />
                    ) : (
                      <span className="flex h-5 w-5 items-center justify-center rounded-full bg-blue-200 text-xs font-bold">
                        {student.first_name.charAt(0)}
                      </span>
                    )}
                    {student.first_name} {student.last_name}
                  </Link>
                ))}
              </div>
            </div>
          )}

          {/* Outcomes */}
          {obs.outcomes.length > 0 && (
            <div className="mt-4 border-t border-gray-100 pt-4">
              <h3 className="text-xs font-semibold uppercase tracking-wider text-gray-500">
                Curriculum Outcomes
              </h3>
              <div className="mt-2 flex flex-wrap gap-2">
                {obs.outcomes.map((outcome) => (
                  <span
                    key={outcome.id}
                    className="inline-flex items-center gap-1.5 rounded-full bg-green-50 px-3 py-1.5 text-sm font-medium text-green-700"
                  >
                    <span
                      className={`inline-flex rounded px-1 py-0.5 text-[9px] font-semibold uppercase ${
                        outcome.level === 'outcome'
                          ? 'bg-green-200 text-green-800'
                          : 'bg-amber-200 text-amber-800'
                      }`}
                    >
                      {outcome.level}
                    </span>
                    {outcome.title}
                  </span>
                ))}
              </div>
            </div>
          )}

          {/* Actions */}
          <ObservationDetailActions
            observationId={obs.id}
            status={obs.status}
            isAuthor={isAuthor}
            canPublish={canPublish}
          />
        </div>
      </div>
    </div>
  );
}


===== D:\.code\wattleos\src\app\(app)\pedagogy\observations\new\page.tsx =====

// src/app/(app)/pedagogy/observations/new/page.tsx
//
// ============================================================
// WattleOS V2 - New Observation Page
// ============================================================
// Server Component. Loads students, curriculum outcomes, and
// media consent data, then renders the capture form.
//
// CHANGES from previous version:
// - Added getStudentMediaConsentMap() call
// - Passes mediaConsent boolean per student to the form
// ============================================================

import { listStudents } from '@/lib/actions/students';
import {
  listCurriculumInstances,
  getCurriculumTree,
} from '@/lib/actions/curriculum';
import { getStudentMediaConsentMap } from '@/lib/actions/consent';
import { getTenantContext, hasPermission } from '@/lib/auth/tenant-context';
import { Permissions } from '@/lib/constants/permissions';
import { redirect } from 'next/navigation';
import { ObservationCaptureForm } from '@/components/domain/observations/observation-capture-form';

export default async function NewObservationPage() {
  const context = await getTenantContext();

  if (!hasPermission(context, Permissions.CREATE_OBSERVATION)) {
    redirect('/pedagogy/observations');
  }

  const canPublish = hasPermission(context, Permissions.PUBLISH_OBSERVATION);

  // Load students and curriculum data in parallel
  const [studentsResult, instancesResult] = await Promise.all([
    listStudents(),
    listCurriculumInstances(),
  ]);

  const students = studentsResult.data ?? [];
  const instances = instancesResult.data ?? [];

  // Load media consent for all students
  const studentIds = students.map((s) => s.id);
  const consentResult = await getStudentMediaConsentMap(studentIds);
  const consentMap = consentResult.data ?? {};

  // Load all curriculum nodes for all active instances
  // (for outcome tagging - we need a flat searchable list)
  let allOutcomes: Array<{
    id: string;
    title: string;
    level: string;
    instanceName: string;
  }> = [];

  for (const instance of instances.filter((i) => i.is_active)) {
    const treeResult = await getCurriculumTree(instance.id);
    const nodes = treeResult.data ?? [];
    // Only include outcomes and activities (not areas/strands) for tagging
    const outcomes = nodes
      .filter((n) => n.level === 'outcome' || n.level === 'activity')
      .map((n) => ({
        id: n.id,
        title: n.title,
        level: n.level,
        instanceName: instance.name,
      }));
    allOutcomes = [...allOutcomes, ...outcomes];
  }

  return (
    <div className="mx-auto max-w-3xl space-y-6">
      <div>
        <h1 className="text-2xl font-bold text-gray-900">New Observation</h1>
        <p className="mt-1 text-sm text-gray-500">
          Capture a learning moment. Tag students and outcomes.
        </p>
      </div>

      <ObservationCaptureForm
        students={students.map((s) => ({
          id: s.id,
          firstName: s.first_name,
          lastName: s.last_name,
          preferredName: s.preferred_name,
          photoUrl: s.photo_url,
          mediaConsent: consentMap[s.id] ?? false,
        }))}
        outcomes={allOutcomes}
        canPublish={canPublish}
      />
    </div>
  );
}


===== D:\.code\wattleos\src\app\(app)\pedagogy\observations\page.tsx =====

import { getObservationFeed } from '@/lib/actions/observations';
import { listStudents } from '@/lib/actions/students';
import { getTenantContext, hasPermission } from '@/lib/auth/tenant-context';
import { Permissions } from '@/lib/constants/permissions';
import Link from 'next/link';
import { ObservationCard } from '@/components/domain/observations/observation-card';
import { FeedFilters } from '@/components/domain/observations/feed-filters';

interface PageProps {
  searchParams: Promise<{
    status?: string;
    student?: string;
    page?: string;
  }>;
}

export default async function ObservationsPage({ searchParams }: PageProps) {
  const params = await searchParams;
  const context = await getTenantContext();
  const canCreate = hasPermission(context, Permissions.CREATE_OBSERVATION);
  const canPublish = hasPermission(context, Permissions.PUBLISH_OBSERVATION);

  const page = parseInt(params.page ?? '1', 10);
  const status = (params.status as 'draft' | 'published' | 'archived') || undefined;
  const studentId = params.student || undefined;

  const [feedResult, studentsResult] = await Promise.all([
    getObservationFeed({ page, perPage: 20, status, studentId }),
    listStudents(),
  ]);

  const feed = feedResult.data ?? [];
  const students = studentsResult.data ?? [];
  const pagination = feedResult.pagination;

  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-2xl font-bold text-gray-900">Observations</h1>
          <p className="mt-1 text-sm text-gray-500">
            Capture and review learning moments
          </p>
        </div>
        {canCreate && (
          <Link
            href="/pedagogy/observations/new"
            className="inline-flex items-center gap-2 rounded-lg bg-amber-600 px-4 py-2.5 text-sm font-medium text-white shadow-sm transition-colors hover:bg-amber-700"
          >
            <svg className="h-4 w-4" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
            </svg>
            New Observation
          </Link>
        )}
      </div>

      {/* Filters */}
      <FeedFilters
        students={students.map((s) => ({
          id: s.id,
          name: s.preferred_name
            ? `${s.preferred_name} ${s.last_name}`
            : `${s.first_name} ${s.last_name}`,
        }))}
        currentStatus={status}
        currentStudentId={studentId}
      />

      {/* Feed */}
      {feed.length === 0 ? (
        <div className="rounded-lg border border-gray-200 bg-white p-12 text-center">
          <svg className="mx-auto h-12 w-12 text-gray-300" fill="none" viewBox="0 0 24 24" strokeWidth={1} stroke="currentColor">
            <path strokeLinecap="round" strokeLinejoin="round" d="M2.036 12.322a1.012 1.012 0 0 1 0-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178Z" />
            <path strokeLinecap="round" strokeLinejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
          </svg>
          <p className="mt-4 text-sm font-medium text-gray-900">No observations yet</p>
          <p className="mt-1 text-sm text-gray-500">
            {canCreate
              ? 'Create your first observation to get started.'
              : 'Observations will appear here once guides start recording.'}
          </p>
          {canCreate && (
            <Link
              href="/pedagogy/observations/new"
              className="mt-4 inline-flex items-center gap-2 rounded-lg bg-amber-600 px-4 py-2 text-sm font-medium text-white hover:bg-amber-700"
            >
              New Observation
            </Link>
          )}
        </div>
      ) : (
        <div className="space-y-4">
          {feed.map((item) => (
            <ObservationCard
              key={item.id}
              observation={item}
              currentUserId={context.user.id}
              canPublish={canPublish}
            />
          ))}
        </div>
      )}

      {/* Pagination */}
      {pagination.total_pages > 1 && (
        <div className="flex items-center justify-between border-t border-gray-200 pt-4">
          <p className="text-sm text-gray-500">
            Showing {(page - 1) * pagination.per_page + 1} to{' '}
            {Math.min(page * pagination.per_page, pagination.total)} of{' '}
            {pagination.total} observations
          </p>
          <div className="flex gap-2">
            {page > 1 && (
              <Link
                href={`/pedagogy/observations?page=${page - 1}${status ? `&status=${status}` : ''}${studentId ? `&student=${studentId}` : ''}`}
                className="rounded-md border border-gray-300 px-3 py-1.5 text-xs font-medium text-gray-700 hover:bg-gray-50"
              >
                Previous
              </Link>
            )}
            {page < pagination.total_pages && (
              <Link
                href={`/pedagogy/observations?page=${page + 1}${status ? `&status=${status}` : ''}${studentId ? `&student=${studentId}` : ''}`}
                className="rounded-md border border-gray-300 px-3 py-1.5 text-xs font-medium text-gray-700 hover:bg-gray-50"
              >
                Next
              </Link>
            )}
          </div>
        </div>
      )}
    </div>
  );
}



===== D:\.code\wattleos\src\app\(app)\pedagogy\portfolio\[studentId]\page.tsx =====

import { getTenantContext, hasPermission } from '@/lib/auth/tenant-context';
import { Permissions } from '@/lib/constants/permissions';
import { getStudent } from '@/lib/actions/students';
import { listCurriculumInstances } from '@/lib/actions/curriculum';
import {
  getStudentMasterySummary,
  getStudentPortfolioTimeline,
} from '@/lib/actions/mastery';
import { PortfolioTimeline } from '@/components/domain/mastery/portfolio-timeline';
import { MASTERY_STATUS_CONFIG, MASTERY_STATUS_ORDER, masteryPercentage } from '@/lib/utils/mastery-status';
import { redirect } from 'next/navigation';
import Link from 'next/link';

interface PageProps {
  params: Promise<{ studentId: string }>;
}

export default async function StudentPortfolioPage({ params }: PageProps) {
  const { studentId } = await params;
  const context = await getTenantContext();
  const canViewStudents = hasPermission(context, Permissions.VIEW_STUDENTS);

  // Get the student
  const studentResult = await getStudent(studentId);
  if (!studentResult.data) {
    redirect('/pedagogy/mastery');
  }
  const student = studentResult.data;
  const studentName = `${student.preferred_name ?? student.first_name} ${student.last_name}`;

  // Get curriculum instances for summary
  const instancesResult = await listCurriculumInstances();
  const instances = instancesResult.data ?? [];

  // Get mastery summary for each instance
  const summaries = await Promise.all(
    instances.map(async (inst) => {
      const result = await getStudentMasterySummary(studentId, inst.id);
      return {
        instance: inst,
        summary: result.data ?? {
          total: 0,
          not_started: 0,
          presented: 0,
          practicing: 0,
          mastered: 0,
        },
      };
    })
  );

  // Get portfolio timeline
  const timelineResult = await getStudentPortfolioTimeline(studentId, 100);
  const timelineItems = timelineResult.data ?? [];

  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="flex items-start justify-between">
        <div>
          <div className="flex items-center gap-2">
            <Link
              href="/pedagogy/mastery"
              className="text-sm text-gray-500 hover:text-gray-700"
            >
              Mastery
            </Link>
            <span className="text-sm text-gray-400">/</span>
            <h1 className="text-2xl font-bold text-gray-900">
              {studentName}&apos;s Portfolio
            </h1>
          </div>
          <p className="mt-1 text-sm text-gray-500">
            A complete view of {student.preferred_name ?? student.first_name}&apos;s
            learning journey
          </p>
        </div>
        {canViewStudents && (
          <Link
            href={`/pedagogy/mastery?student=${studentId}`}
            className="inline-flex items-center gap-1.5 rounded-md border border-gray-300 px-3 py-1.5 text-sm font-medium text-gray-700 hover:bg-gray-50"
          >
            <svg
              className="h-4 w-4"
              fill="none"
              viewBox="0 0 24 24"
              strokeWidth={1.5}
              stroke="currentColor"
            >
              <path
                strokeLinecap="round"
                strokeLinejoin="round"
                d="M3.75 6A2.25 2.25 0 0 1 6 3.75h2.25A2.25 2.25 0 0 1 10.5 6v2.25a2.25 2.25 0 0 1-2.25 2.25H6a2.25 2.25 0 0 1-2.25-2.25V6ZM3.75 15.75A2.25 2.25 0 0 1 6 13.5h2.25a2.25 2.25 0 0 1 2.25 2.25V18a2.25 2.25 0 0 1-2.25 2.25H6A2.25 2.25 0 0 1 3.75 18v-2.25ZM13.5 6a2.25 2.25 0 0 1 2.25-2.25H18A2.25 2.25 0 0 1 20.25 6v2.25A2.25 2.25 0 0 1 18 10.5h-2.25a2.25 2.25 0 0 1-2.25-2.25V6ZM13.5 15.75a2.25 2.25 0 0 1 2.25-2.25H18a2.25 2.25 0 0 1 2.25 2.25V18A2.25 2.25 0 0 1 18 20.25h-2.25a2.25 2.25 0 0 1-2.25-2.25v-2.25Z"
              />
            </svg>
            Mastery Grid
          </Link>
        )}
      </div>

      {/* Student info card */}
      <div className="rounded-lg border border-gray-200 bg-white p-5">
        <div className="flex items-center gap-4">
          {student.photo_url ? (
            <img
              src={student.photo_url}
              alt={studentName}
              className="h-16 w-16 rounded-full object-cover"
            />
          ) : (
            <div className="flex h-16 w-16 items-center justify-center rounded-full bg-amber-100 text-xl font-bold text-amber-700">
              {student.first_name.charAt(0)}
              {student.last_name.charAt(0)}
            </div>
          )}
          <div>
            <h2 className="text-lg font-semibold text-gray-900">
              {studentName}
            </h2>
            {student.dob && (
              <p className="text-sm text-gray-500">
                Born{' '}
                {new Date(student.dob).toLocaleDateString('en-AU', {
                  year: 'numeric',
                  month: 'long',
                  day: 'numeric',
                })}
              </p>
            )}
            <span
              className={`mt-1 inline-flex rounded-full px-2 py-0.5 text-xs font-medium ${
                student.enrollment_status === 'active'
                  ? 'bg-green-100 text-green-700'
                  : 'bg-gray-100 text-gray-500'
              }`}
            >
              {student.enrollment_status.charAt(0).toUpperCase() +
                student.enrollment_status.slice(1)}
            </span>
          </div>
        </div>
      </div>

      {/* Mastery summaries per curriculum */}
      {summaries.length > 0 && (
        <div className="space-y-3">
          <h2 className="text-lg font-semibold text-gray-900">
            Curriculum Progress
          </h2>
          <div className="grid gap-4 sm:grid-cols-2">
            {summaries.map(({ instance, summary }) => {
              const pct = masteryPercentage(summary);
              return (
                <div
                  key={instance.id}
                  className="rounded-lg border border-gray-200 bg-white p-4"
                >
                  <div className="mb-2 flex items-center justify-between">
                    <h3 className="text-sm font-semibold text-gray-900">
                      {instance.name}
                    </h3>
                    <span className="text-lg font-bold text-amber-600">
                      {pct}%
                    </span>
                  </div>

                  {/* Progress bar */}
                  <div className="mb-3 flex h-2.5 overflow-hidden rounded-full bg-gray-100">
                    {summary.total > 0 && (
                      <>
                        <div
                          className="bg-green-400 transition-all"
                          style={{
                            width: `${(summary.mastered / summary.total) * 100}%`,
                          }}
                        />
                        <div
                          className="bg-amber-400 transition-all"
                          style={{
                            width: `${(summary.practicing / summary.total) * 100}%`,
                          }}
                        />
                        <div
                          className="bg-blue-400 transition-all"
                          style={{
                            width: `${(summary.presented / summary.total) * 100}%`,
                          }}
                        />
                      </>
                    )}
                  </div>

                  {/* Counts */}
                  <div className="flex flex-wrap gap-3">
                    {MASTERY_STATUS_ORDER.map((status) => {
                      const config = MASTERY_STATUS_CONFIG[status];
                      return (
                        <div key={status} className="flex items-center gap-1">
                          <span
                            className={`inline-block h-2 w-2 rounded-full ${config.dotColor}`}
                          />
                          <span className="text-[10px] text-gray-600">
                            {config.shortLabel}:{' '}
                            <span className="font-semibold">
                              {summary[status]}
                            </span>
                          </span>
                        </div>
                      );
                    })}
                  </div>
                </div>
              );
            })}
          </div>
        </div>
      )}

      {/* Timeline */}
      <div className="space-y-3">
        <h2 className="text-lg font-semibold text-gray-900">
          Learning Journey
        </h2>
        <PortfolioTimeline items={timelineItems} studentName={studentName} />
      </div>
    </div>
  );
}



===== D:\.code\wattleos\src\app\(app)\reports\[reportId]\page.tsx =====

// src/app/(app)/reports/[reportId]/page.tsx
//
// ============================================================
// WattleOS V2 - Report Editor Page
// ============================================================
// Server Component. Fetches a single student report with all
// details, then hands off to the ReportEditor client component
// for interactive editing.
//
// WHY server wrapper: Single fetch on the server, instant page
// load. The editor component handles all interactive state
// (editing narratives, toggling completion, status changes).
// ============================================================

import { getTenantContext, hasPermission } from '@/lib/auth/tenant-context';
import { Permissions } from '@/lib/constants/permissions';
import { getStudentReport, getReportCompletionStats } from '@/lib/actions/reports';
import { redirect } from 'next/navigation';
import Link from 'next/link';
import { ReportEditor } from '@/components/domain/reports/ReportEditor';
import { ReportPdfActions } from '@/components/domain/reports/report-pdf-actions';
import type { ReportContent } from '@/lib/reports/types';

interface PageProps {
  params: Promise<{ reportId: string }>;
}

export default async function ReportEditorPage({ params }: PageProps) {
  const { reportId } = await params;
  const context = await getTenantContext();

  if (!hasPermission(context, Permissions.MANAGE_REPORTS)) {
    redirect('/dashboard');
  }

  const result = await getStudentReport(reportId);

  if (result.error || !result.data) {
    redirect('/reports');
  }

  const report = result.data;
  const content = report.content as unknown as ReportContent;
  const stats = getReportCompletionStats(report.content);
  const studentName = `${report.student.preferred_name ?? report.student.first_name} ${report.student.last_name}`;

  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="flex items-start justify-between gap-4">
        <div>
          <div className="flex items-center gap-2 text-sm text-gray-500">
            <Link href="/reports" className="hover:text-gray-700">
              Reports
            </Link>
            <span className="text-gray-400">/</span>
            <span className="text-gray-900">{studentName}</span>
          </div>
          <h1 className="mt-2 text-2xl font-bold text-gray-900">
            {studentName}
          </h1>
          <div className="mt-1 flex items-center gap-3 text-sm text-gray-500">
            {report.term && <span>{report.term}</span>}
            {report.templateName && (
              <>
                <span>&middot;</span>
                <span>{report.templateName}</span>
              </>
            )}
          </div>
        </div>

        {/* PDF Export / Download */}
        <div className="shrink-0 pt-6">
          <ReportPdfActions
            reportId={reportId}
            reportStatus={report.status}
            hasPdf={!!report.pdf_storage_path}
          />
        </div>
      </div>

      <ReportEditor
        reportId={reportId}
        reportStatus={report.status}
        reportContent={content}
        completionStats={stats}
        studentName={studentName}
        studentPhotoUrl={report.student.photo_url}
        authorName={
          [report.author.first_name, report.author.last_name]
            .filter(Boolean)
            .join(' ') || 'Unknown'
        }
        term={report.term}
      />
    </div>
  );
}


===== D:\.code\wattleos\src\app\(app)\reports\generate\page.tsx =====

// src/app/(app)/reports/generate/page.tsx
//
// ============================================================
// WattleOS V2 - Generate Reports Page
// ============================================================
// Server Component. Loads available templates and student lists
// for the generation form. The actual generation happens in the
// client form component via server actions.
//
// WHY server wrapper: We need templates and class/student data
// for the selection UI. Fetching on the server avoids waterfall
// requests and gives instant page load.
// ============================================================

import { getTenantContext, hasPermission } from '@/lib/auth/tenant-context';
import { Permissions } from '@/lib/constants/permissions';
import { listReportTemplates } from '@/lib/actions/reports';
import { listClasses } from '@/lib/actions/sis';
import { redirect } from 'next/navigation';
import Link from 'next/link';
import { GenerateReportsForm } from '@/components/domain/reports/GenerateReportsForm';

export default async function GenerateReportsPage() {
  const context = await getTenantContext();

  if (!hasPermission(context, Permissions.MANAGE_REPORTS)) {
    redirect('/dashboard');
  }

  // Fetch templates and classes in parallel
  const [templatesResult, classesResult] = await Promise.all([
    listReportTemplates({ activeOnly: true }),
    listClasses(),
  ]);

  const templates = templatesResult.data ?? [];
  const classes = classesResult.data ?? [];

  if (templates.length === 0) {
    return (
      <div className="space-y-6">
        <div>
          <div className="flex items-center gap-2 text-sm text-gray-500">
            <Link href="/reports" className="hover:text-gray-700">
              Reports
            </Link>
            <span className="text-gray-400">/</span>
            <span className="text-gray-900">Generate</span>
          </div>
          <h1 className="mt-2 text-2xl font-bold text-gray-900">
            Generate Reports
          </h1>
        </div>
        <div className="rounded-lg border border-gray-200 bg-white p-12 text-center">
          <p className="text-sm text-gray-500">
            You need at least one active report template to generate reports.
          </p>
          <Link
            href="/reports/templates/new"
            className="mt-4 inline-block rounded-md bg-amber-600 px-4 py-2 text-sm font-medium text-white hover:bg-amber-700"
          >
            Create a Template
          </Link>
        </div>
      </div>
    );
  }

  return (
    <div className="space-y-6">
      <div>
        <div className="flex items-center gap-2 text-sm text-gray-500">
          <Link href="/reports" className="hover:text-gray-700">
            Reports
          </Link>
          <span className="text-gray-400">/</span>
          <span className="text-gray-900">Generate</span>
        </div>
        <h1 className="mt-2 text-2xl font-bold text-gray-900">
          Generate Reports
        </h1>
        <p className="mt-1 text-sm text-gray-500">
          Select a template, pick students, and generate pre-populated reports for the term.
        </p>
      </div>

      <GenerateReportsForm
        templates={templates.map((t) => {
          const contentObj = t.content as Record<string, unknown> | null;
          const sectionsArr = contentObj && Array.isArray(contentObj.sections)
            ? contentObj.sections
            : [];
          return {
            id: t.id,
            name: t.name,
            cycleLevel: t.cycle_level,
            sectionCount: sectionsArr.length,
          };
        })}
        classes={classes.map((c) => ({
          id: c.id,
          name: c.name,
          cycleLevel: c.cycle_level,
          studentCount: c.active_enrollment_count,
        }))}
      />
    </div>
  );
}


===== D:\.code\wattleos\src\app\(app)\reports\page.tsx =====

// src/app/(app)/reports/page.tsx
//
// ============================================================
// WattleOS V2 - Reports Landing Page
// ============================================================
// Server Component. Lists student reports with filters by term
// and status. Links to the template manager for building report
// formats.
//
// WHY server component: Initial data load happens on the server.
// Filters use searchParams so the page is URL-shareable.
// ============================================================

import { getTenantContext, hasPermission } from '@/lib/auth/tenant-context';
import { Permissions } from '@/lib/constants/permissions';
import { listStudentReports, getReportTerms, getReportCompletionStats } from '@/lib/actions/reports';
import type { ReportStatus } from '@/types/domain';
import Link from 'next/link';
import { redirect } from 'next/navigation';

interface PageProps {
  searchParams: Promise<{
    term?: string;
    status?: string;
    page?: string;
  }>;
}

export default async function ReportsPage({ searchParams }: PageProps) {
  const context = await getTenantContext();

  if (!hasPermission(context, Permissions.MANAGE_REPORTS)) {
    redirect('/dashboard');
  }

  const params = await searchParams;
  const currentPage = parseInt(params.page ?? '1', 10);

  // Fetch reports and terms in parallel
  const [reportsResult, termsResult] = await Promise.all([
    listStudentReports({
      page: currentPage,
      per_page: 20,
      term: params.term || undefined,
      status: (params.status as ReportStatus) || undefined,
    }),
    getReportTerms(),
  ]);

  const reports = reportsResult.data ?? [];
  const pagination = reportsResult.pagination;
  const terms = termsResult.data ?? [];

  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-2xl font-bold text-gray-900">Reports</h1>
          <p className="mt-1 text-sm text-gray-500">
            Generate and manage student term reports
          </p>
        </div>
        <div className="flex gap-3">
          <Link
            href="/reports/templates"
            className="rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 transition-colors hover:bg-gray-50"
          >
            Manage Templates
          </Link>
          <Link
            href="/reports/generate"
            className="rounded-md bg-amber-600 px-4 py-2 text-sm font-medium text-white transition-colors hover:bg-amber-700"
          >
            Generate Reports
          </Link>
        </div>
      </div>

      {/* Filters */}
      <div className="flex flex-wrap gap-3">
        <FilterSelect
          label="Term"
          paramName="term"
          value={params.term}
          options={terms.map((t) => ({ value: t, label: t }))}
          baseUrl="/reports"
          currentParams={params}
        />
        <FilterSelect
          label="Status"
          paramName="status"
          value={params.status}
          options={[
            { value: 'draft', label: 'Draft' },
            { value: 'review', label: 'In Review' },
            { value: 'approved', label: 'Approved' },
            { value: 'published', label: 'Published' },
          ]}
          baseUrl="/reports"
          currentParams={params}
        />
        {(params.term || params.status) && (
          <Link
            href="/reports"
            className="self-end rounded-md px-3 py-2 text-sm text-gray-500 transition-colors hover:text-gray-700"
          >
            Clear filters
          </Link>
        )}
      </div>

      {/* Reports table */}
      {reports.length === 0 ? (
        <div className="rounded-lg border border-gray-200 bg-white p-12 text-center">
          <p className="text-sm text-gray-500">
            {params.term || params.status
              ? 'No reports match the current filters.'
              : 'No reports yet. Generate reports from a template to get started.'}
          </p>
          {!params.term && !params.status && (
            <Link
              href="/reports/generate"
              className="mt-4 inline-block rounded-md bg-amber-600 px-4 py-2 text-sm font-medium text-white hover:bg-amber-700"
            >
              Generate Reports
            </Link>
          )}
        </div>
      ) : (
        <div className="overflow-hidden rounded-lg border border-gray-200 bg-white">
          <table className="min-w-full divide-y divide-gray-200">
            <thead className="bg-gray-50">
              <tr>
                <th className="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">
                  Student
                </th>
                <th className="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">
                  Term
                </th>
                <th className="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">
                  Template
                </th>
                <th className="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">
                  Status
                </th>
                <th className="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">
                  Progress
                </th>
                <th className="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">
                  Author
                </th>
                <th className="px-4 py-3" />
              </tr>
            </thead>
            <tbody className="divide-y divide-gray-100">
              {reports.map((report) => {
                const stats = getReportCompletionStats(report.content);
                return (
                  <tr key={report.id} className="transition-colors hover:bg-gray-50">
                    <td className="px-4 py-3">
                      <div className="flex items-center gap-3">
                        {report.student.photo_url ? (
                          <img
                            src={report.student.photo_url}
                            alt=""
                            className="h-8 w-8 rounded-full object-cover"
                          />
                        ) : (
                          <div className="flex h-8 w-8 items-center justify-center rounded-full bg-gray-100 text-xs font-medium text-gray-500">
                            {report.student.first_name?.[0]}
                            {report.student.last_name?.[0]}
                          </div>
                        )}
                        <div>
                          <p className="text-sm font-medium text-gray-900">
                            {report.student.preferred_name ?? report.student.first_name}{' '}
                            {report.student.last_name}
                          </p>
                        </div>
                      </div>
                    </td>
                    <td className="px-4 py-3 text-sm text-gray-600">
                      {report.term ?? 'â€”'}
                    </td>
                    <td className="px-4 py-3 text-sm text-gray-600">
                      {report.templateName ?? 'â€”'}
                    </td>
                    <td className="px-4 py-3">
                      <ReportStatusBadge status={report.status} />
                    </td>
                    <td className="px-4 py-3">
                      <div className="flex items-center gap-2">
                        <div className="h-2 w-20 overflow-hidden rounded-full bg-gray-100">
                          <div
                            className="h-full rounded-full bg-amber-500 transition-all"
                            style={{ width: `${stats.percentComplete}%` }}
                          />
                        </div>
                        <span className="text-xs text-gray-500">
                          {stats.percentComplete}%
                        </span>
                      </div>
                    </td>
                    <td className="px-4 py-3 text-sm text-gray-600">
                      {[report.author.first_name, report.author.last_name]
                        .filter(Boolean)
                        .join(' ') || 'â€”'}
                    </td>
                    <td className="px-4 py-3 text-right">
                      <Link
                        href={`/reports/${report.id}`}
                        className="text-sm font-medium text-amber-600 hover:text-amber-700"
                      >
                        Edit
                      </Link>
                    </td>
                  </tr>
                );
              })}
            </tbody>
          </table>

          {/* Pagination */}
          {pagination.total_pages > 1 && (
            <div className="flex items-center justify-between border-t border-gray-200 bg-gray-50 px-4 py-3">
              <p className="text-sm text-gray-500">
                Page {pagination.page} of {pagination.total_pages} ({pagination.total} reports)
              </p>
              <div className="flex gap-2">
                {pagination.page > 1 && (
                  <Link
                    href={buildFilterUrl('/reports', { ...params, page: String(pagination.page - 1) })}
                    className="rounded-md border border-gray-300 bg-white px-3 py-1 text-sm text-gray-700 hover:bg-gray-50"
                  >
                    Previous
                  </Link>
                )}
                {pagination.page < pagination.total_pages && (
                  <Link
                    href={buildFilterUrl('/reports', { ...params, page: String(pagination.page + 1) })}
                    className="rounded-md border border-gray-300 bg-white px-3 py-1 text-sm text-gray-700 hover:bg-gray-50"
                  >
                    Next
                  </Link>
                )}
              </div>
            </div>
          )}
        </div>
      )}
    </div>
  );
}

// ============================================================
// Sub-components (co-located, Server Components)
// ============================================================

const STATUS_STYLES: Record<string, string> = {
  draft: 'bg-gray-100 text-gray-700',
  review: 'bg-blue-100 text-blue-700',
  approved: 'bg-amber-100 text-amber-700',
  published: 'bg-green-100 text-green-700',
};

const STATUS_LABELS: Record<string, string> = {
  draft: 'Draft',
  review: 'In Review',
  approved: 'Approved',
  published: 'Published',
};

function ReportStatusBadge({ status }: { status: string }) {
  return (
    <span
      className={`inline-flex rounded-full px-2 py-0.5 text-xs font-medium ${STATUS_STYLES[status] ?? STATUS_STYLES.draft}`}
    >
      {STATUS_LABELS[status] ?? status}
    </span>
  );
}

function FilterSelect({
  label,
  paramName,
  value,
  options,
  baseUrl,
  currentParams,
}: {
  label: string;
  paramName: string;
  value: string | undefined;
  options: Array<{ value: string; label: string }>;
  baseUrl: string;
  currentParams: Record<string, string | undefined>;
}) {
  return (
    <div className="flex flex-col gap-1">
      <label className="text-xs font-medium text-gray-500">{label}</label>
      <div className="flex gap-1">
        <a
          href={buildFilterUrl(baseUrl, { ...currentParams, [paramName]: undefined, page: undefined })}
          className={`rounded-md px-3 py-1.5 text-xs font-medium transition-colors ${
            !value
              ? 'bg-amber-100 text-amber-800'
              : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
          }`}
        >
          All
        </a>
        {options.map((opt) => (
          <a
            key={opt.value}
            href={buildFilterUrl(baseUrl, { ...currentParams, [paramName]: opt.value, page: undefined })}
            className={`rounded-md px-3 py-1.5 text-xs font-medium transition-colors ${
              value === opt.value
                ? 'bg-amber-100 text-amber-800'
                : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
            }`}
          >
            {opt.label}
          </a>
        ))}
      </div>
    </div>
  );
}

function buildFilterUrl(
  base: string,
  params: Record<string, string | undefined>
): string {
  const searchParams = new URLSearchParams();
  for (const [key, val] of Object.entries(params)) {
    if (val) searchParams.set(key, val);
  }
  const qs = searchParams.toString();
  return qs ? `${base}?${qs}` : base;
}


===== D:\.code\wattleos\src\app\(app)\reports\templates\[templateId]\page.tsx =====

// src/app/(app)/reports/templates/[templateId]/page.tsx
//
// ============================================================
// WattleOS V2 - Report Template Builder Page
// ============================================================
// Server Component. Fetches the template, then hands off to
// the TemplateBuilder client component for interactive editing.
//
// WHY server wrapper: Template data is fetched once on the
// server. The builder client component handles all interactive
// state (reordering, adding/removing sections, config panels).
// ============================================================

import { getTenantContext, hasPermission } from '@/lib/auth/tenant-context';
import { Permissions } from '@/lib/constants/permissions';
import { getReportTemplate } from '@/lib/actions/reports';
import { redirect } from 'next/navigation';
import Link from 'next/link';
import { TemplateBuilder } from '@/components/domain/reports/TemplateBuilder';
import type { TemplateContent } from '@/lib/reports/types';

interface PageProps {
  params: Promise<{ templateId: string }>;
}

export default async function TemplateBuilderPage({ params }: PageProps) {
  const { templateId } = await params;
  const context = await getTenantContext();

  if (!hasPermission(context, Permissions.MANAGE_REPORTS)) {
    redirect('/dashboard');
  }

  const result = await getReportTemplate(templateId);

  if (result.error || !result.data) {
    redirect('/reports/templates');
  }

  const template = result.data;
  const content = template.content as unknown as TemplateContent;

  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="flex items-center justify-between">
        <div>
          <div className="flex items-center gap-2 text-sm text-gray-500">
            <Link href="/reports" className="hover:text-gray-700">
              Reports
            </Link>
            <span className="text-gray-400">/</span>
            <Link href="/reports/templates" className="hover:text-gray-700">
              Templates
            </Link>
            <span className="text-gray-400">/</span>
            <span className="text-gray-900">{template.name}</span>
          </div>
          <h1 className="mt-2 text-2xl font-bold text-gray-900">
            {template.name}
          </h1>
          {template.cycle_level && (
            <p className="mt-1 text-sm text-gray-500">
              Cycle: {template.cycle_level}
            </p>
          )}
        </div>
      </div>

      {/* Builder */}
      <TemplateBuilder
        templateId={templateId}
        templateName={template.name}
        cycleLevel={template.cycle_level}
        initialContent={content}
      />
    </div>
  );
}


===== D:\.code\wattleos\src\app\(app)\reports\templates\new\page.tsx =====

// src/app/(app)/reports/templates/new/page.tsx
//
// ============================================================
// WattleOS V2 - Create New Report Template
// ============================================================
// Simple form: name + optional cycle level. On submit, creates
// the template with default sections and redirects to the
// builder for customization.
//
// WHY separate page: Gives schools a clean entry point rather
// than dumping them directly into the builder with an unnamed
// template. The name is required upfront.
// ============================================================

import { getTenantContext, hasPermission } from '@/lib/auth/tenant-context';
import { Permissions } from '@/lib/constants/permissions';
import { redirect } from 'next/navigation';
import Link from 'next/link';
import { NewTemplateForm } from '@/components/domain/reports/NewTemplateForm';

export default async function NewTemplatePage() {
  const context = await getTenantContext();

  if (!hasPermission(context, Permissions.MANAGE_REPORTS)) {
    redirect('/dashboard');
  }

  return (
    <div className="mx-auto max-w-lg space-y-6">
      {/* Header */}
      <div>
        <div className="flex items-center gap-2 text-sm text-gray-500">
          <Link href="/reports" className="hover:text-gray-700">
            Reports
          </Link>
          <span className="text-gray-400">/</span>
          <Link href="/reports/templates" className="hover:text-gray-700">
            Templates
          </Link>
          <span className="text-gray-400">/</span>
          <span className="text-gray-900">New</span>
        </div>
        <h1 className="mt-2 text-2xl font-bold text-gray-900">
          Create Report Template
        </h1>
        <p className="mt-1 text-sm text-gray-500">
          Name your template and choose a cycle level. You&apos;ll customize the sections next.
        </p>
      </div>

      <NewTemplateForm />
    </div>
  );
}


===== D:\.code\wattleos\src\app\(app)\reports\templates\page.tsx =====

// src/app/(app)/reports/templates/page.tsx
//
// ============================================================
// WattleOS V2 - Report Templates List Page
// ============================================================
// Server Component. Lists all report templates with usage stats.
// Create, duplicate, deactivate, and delete templates.
// ============================================================

import { getTenantContext, hasPermission } from '@/lib/auth/tenant-context';
import { Permissions } from '@/lib/constants/permissions';
import { listReportTemplates } from '@/lib/actions/reports';
import type { TemplateWithStats } from '@/lib/actions/reports';
import Link from 'next/link';
import { redirect } from 'next/navigation';
import { TemplateActions } from '@/components/domain/reports/TemplateActions';

export default async function TemplatesPage() {
  const context = await getTenantContext();

  if (!hasPermission(context, Permissions.MANAGE_REPORTS)) {
    redirect('/dashboard');
  }

  const result = await listReportTemplates({ activeOnly: false });
  const templates = result.data ?? [];

  // Separate active and inactive
  const activeTemplates = templates.filter((t) => t.is_active);
  const inactiveTemplates = templates.filter((t) => !t.is_active);

  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="flex items-center justify-between">
        <div>
          <div className="flex items-center gap-2">
            <Link
              href="/reports"
              className="text-sm text-gray-500 transition-colors hover:text-gray-700"
            >
              Reports
            </Link>
            <span className="text-sm text-gray-400">/</span>
            <h1 className="text-2xl font-bold text-gray-900">Templates</h1>
          </div>
          <p className="mt-1 text-sm text-gray-500">
            Design report formats for your school. Each template defines the sections that appear in student reports.
          </p>
        </div>
        <Link
          href="/reports/templates/new"
          className="rounded-md bg-amber-600 px-4 py-2 text-sm font-medium text-white transition-colors hover:bg-amber-700"
        >
          New Template
        </Link>
      </div>

      {/* Active templates */}
      {activeTemplates.length === 0 && inactiveTemplates.length === 0 ? (
        <div className="rounded-lg border border-gray-200 bg-white p-12 text-center">
          <div className="mx-auto mb-4 flex h-12 w-12 items-center justify-center rounded-full bg-amber-50">
            <svg
              className="h-6 w-6 text-amber-600"
              fill="none"
              viewBox="0 0 24 24"
              strokeWidth={1.5}
              stroke="currentColor"
            >
              <path
                strokeLinecap="round"
                strokeLinejoin="round"
                d="M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m3.75 9v6m3-3H9m1.5-12H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 0 0-9-9Z"
              />
            </svg>
          </div>
          <h3 className="text-sm font-semibold text-gray-900">No templates yet</h3>
          <p className="mt-1 text-sm text-gray-500">
            Create your first report template to start generating student reports.
          </p>
          <Link
            href="/reports/templates/new"
            className="mt-4 inline-block rounded-md bg-amber-600 px-4 py-2 text-sm font-medium text-white hover:bg-amber-700"
          >
            Create Template
          </Link>
        </div>
      ) : (
        <>
          <div className="grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
            {activeTemplates.map((template) => (
              <TemplateCard key={template.id} template={template} />
            ))}
          </div>

          {/* Inactive templates */}
          {inactiveTemplates.length > 0 && (
            <div className="space-y-3">
              <h2 className="text-sm font-medium text-gray-500">
                Inactive Templates ({inactiveTemplates.length})
              </h2>
              <div className="grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
                {inactiveTemplates.map((template) => (
                  <TemplateCard key={template.id} template={template} />
                ))}
              </div>
            </div>
          )}
        </>
      )}
    </div>
  );
}

// ============================================================
// TemplateCard - displays a single template with actions
// ============================================================

function TemplateCard({ template }: { template: TemplateWithStats }) {
  // Parse section count from content
  const content = template.content as Record<string, unknown> | null;
  const sections = (content as { sections?: unknown[] } | null)?.sections ?? [];
  const sectionCount = Array.isArray(sections) ? sections.length : 0;

  return (
    <div
      className={`rounded-lg border bg-white p-5 transition-shadow hover:shadow-md ${
        template.is_active ? 'border-gray-200' : 'border-gray-200 opacity-60'
      }`}
    >
      <div className="flex items-start justify-between">
        <div className="min-w-0 flex-1">
          <Link
            href={`/reports/templates/${template.id}`}
            className="text-sm font-semibold text-gray-900 hover:text-amber-700"
          >
            {template.name}
          </Link>
          {template.cycle_level && (
            <span className="ml-2 inline-flex rounded-full bg-gray-100 px-2 py-0.5 text-xs text-gray-600">
              {template.cycle_level}
            </span>
          )}
          {!template.is_active && (
            <span className="ml-2 inline-flex rounded-full bg-red-50 px-2 py-0.5 text-xs text-red-600">
              Inactive
            </span>
          )}
        </div>
        <TemplateActions templateId={template.id} isActive={template.is_active} />
      </div>

      <div className="mt-3 flex items-center gap-4 text-xs text-gray-500">
        <span>{sectionCount} section{sectionCount !== 1 ? 's' : ''}</span>
        <span>&middot;</span>
        <span>
          {template.reportCount} report{template.reportCount !== 1 ? 's' : ''} generated
        </span>
      </div>

      <div className="mt-4">
        <Link
          href={`/reports/templates/${template.id}`}
          className="text-xs font-medium text-amber-600 hover:text-amber-700"
        >
          Edit Template â†’
        </Link>
      </div>
    </div>
  );
}


===== D:\.code\wattleos\src\app\(app)\settings\display\page.tsx =====

// src/app/(app)/settings/display/page.tsx
//
// ============================================================
// WattleOS V2 â€” User Display Settings Page
// ============================================================
// Any authenticated user can access this page to set their
// personal theme, density, and font scale preferences.
//
// WHY /settings/display and not /profile:
//   /settings is the natural home for personal configuration.
//   /profile would be for editing your name, email, avatar.
//   Keeping them separate lets us add more settings tabs later
//   (notifications, calendar sync, etc.) without crowding.
// ============================================================

import { DisplayPreferencesClient } from "@/components/domain/user/display-preferences-client";
import {
  getTenantDisplaySettings,
  getUserDisplayPreferences,
} from "@/lib/actions/display-settings";
import { getTenantContext } from "@/lib/auth/tenant-context";

export const metadata = {
  title: "Display Settings",
};

export default async function UserDisplaySettingsPage() {
  const context = await getTenantContext();

  const [userResult, tenantResult] = await Promise.all([
    getUserDisplayPreferences(),
    getTenantDisplaySettings(),
  ]);

  const userPrefs = userResult.data ?? {
    theme: null,
    density: null,
    fontScale: null,
    sidebarCollapsed: false,
  };

  const tenantDisplay = tenantResult.data ?? {
    brandHue: null,
    brandSaturation: null,
    defaultDensity: "comfortable" as const,
    defaultTheme: "light" as const,
    faviconUrl: null,
  };

  return (
    <div className="space-y-[var(--density-section-gap)]">
      <div>
        <h1 className="text-[var(--text-2xl)] font-semibold text-foreground">
          Display Settings
        </h1>
        <p className="mt-1 text-[var(--text-sm)] text-muted-foreground">
          Personalise how WattleOS looks for you. These settings override the
          school defaults set by your administrator.
        </p>
      </div>

      <DisplayPreferencesClient
        initialPreferences={userPrefs}
        tenantDefaultDensity={tenantDisplay.defaultDensity}
        tenantDefaultTheme={tenantDisplay.defaultTheme}
      />
    </div>
  );
} 


===== D:\.code\wattleos\src\app\(app)\settings\page.tsx =====

// src/app/(app)/settings/page.tsx
//
// ============================================================
// WattleOS V2 â€” User Settings Landing Page
// ============================================================
// Any authenticated user can access this. Shows cards linking
// to personal setting sub-sections.
//
// WHY separate from /admin:
//   /admin is permission-gated for school administrators.
//   /settings is for every user's personal preferences.
// ============================================================

import { getTenantContext } from "@/lib/auth/tenant-context";
import Link from "next/link";

export const metadata = {
  title: "My Settings",
};

export default async function UserSettingsPage() {
  const context = await getTenantContext();

  const cards = [
    {
      label: "Display",
      description: "Theme, layout density, and text size.",
      href: "/settings/display",
      icon: (
        <svg
          className="h-6 w-6 text-muted-foreground"
          fill="none"
          viewBox="0 0 24 24"
          strokeWidth={1.5}
          stroke="currentColor"
        >
          <path
            strokeLinecap="round"
            strokeLinejoin="round"
            d="M4.098 19.902a3.75 3.75 0 0 0 5.304 0l6.401-6.402M6.75 21A3.75 3.75 0 0 1 3 17.25V4.125C3 3.504 3.504 3 4.125 3h5.25c.621 0 1.125.504 1.125 1.125v4.072M6.75 21a3.75 3.75 0 0 0 3.75-3.75V8.197M6.75 21h13.125c.621 0 1.125-.504 1.125-1.125v-5.25c0-.621-.504-1.125-1.125-1.125h-4.072M10.5 8.197l2.88-2.88c.438-.439 1.15-.439 1.59 0l3.712 3.713c.44.44.44 1.152 0 1.59l-2.879 2.88M6.75 17.25h.008v.008H6.75v-.008Z"
          />
        </svg>
      ),
    },
    // Future settings sections can be added here:
    // { label: 'Notifications', description: '...', href: '/settings/notifications', icon: ... },
    // { label: 'Calendar Sync', description: '...', href: '/settings/calendar', icon: ... },
  ];

  return (
    <div className="space-y-[var(--density-section-gap)]">
      <div>
        <h1 className="text-[var(--text-2xl)] font-semibold text-foreground">
          My Settings
        </h1>
        <p className="mt-1 text-[var(--text-sm)] text-muted-foreground">
          Personalise your WattleOS experience.
        </p>
      </div>

      <div className="grid grid-cols-1 gap-[var(--density-sm)] sm:grid-cols-2 lg:grid-cols-3">
        {cards.map((card) => (
          <Link
            key={card.href}
            href={card.href}
            className="group flex items-start gap-3 rounded-lg border border-border bg-card p-[var(--density-card-padding)] transition-all card-interactive"
          >
            {card.icon}
            <div>
              <h3 className="text-[var(--text-sm)] font-semibold text-foreground group-hover:text-primary">
                {card.label}
              </h3>
              <p className="mt-0.5 text-[var(--text-xs)] text-muted-foreground">
                {card.description}
              </p>
            </div>
          </Link>
        ))}
      </div>
    </div>
  );
}



===== D:\.code\wattleos\src\app\(app)\students\[id]\edit\page.tsx =====

// src/app/(app)/students/[id]/edit/page.tsx
//
// ============================================================
// WattleOS V2 - Edit Student Page
// ============================================================
// Server Component. Loads the student record, then renders
// StudentForm pre-filled for editing.
//
// Why server fetch: We need the current student data to
// pre-fill the form. Fetching server-side means no loading
// spinner - the page arrives ready to edit.
// ============================================================

import { getTenantContext } from '@/lib/auth/tenant-context';
import { Permissions } from '@/lib/constants/permissions';
import { getStudent } from '@/lib/actions/students';
import { redirect } from 'next/navigation';
import { notFound } from 'next/navigation';
import { StudentForm } from '@/components/domain/sis/StudentForm';
import { formatStudentName } from '@/lib/utils';
import Link from 'next/link';

interface EditStudentPageProps {
  params: Promise<{ id: string }>;
}

export default async function EditStudentPage({ params }: EditStudentPageProps) {
  const { id } = await params;
  const context = await getTenantContext();

  // Gate: only users with manage_students can edit
  if (!context.permissions.includes(Permissions.MANAGE_STUDENTS)) {
    redirect(`/students/${id}`);
  }

  // Fetch the student
  const result = await getStudent(id);

  if (result.error || !result.data) {
    notFound();
  }

  const student = result.data;
  const displayName = formatStudentName(
    student.first_name,
    student.last_name,
    student.preferred_name
  );
  const canManageEnrollment = context.permissions.includes(Permissions.MANAGE_ENROLLMENT);

  return (
    <div className="space-y-6">
      {/* Breadcrumb */}
      <nav className="flex items-center gap-2 text-sm text-gray-500">
        <Link href="/students" className="hover:text-gray-700">
          Students
        </Link>
        <span>/</span>
        <Link href={`/students/${id}`} className="hover:text-gray-700">
          {displayName}
        </Link>
        <span>/</span>
        <span className="text-gray-900">Edit</span>
      </nav>

      {/* Page header */}
      <div>
        <h1 className="text-2xl font-semibold text-gray-900">
          Edit {displayName}
        </h1>
        <p className="mt-1 text-sm text-gray-500">
          Update this student&apos;s basic information.
        </p>
      </div>

      {/* Form - pre-filled with existing data */}
      <StudentForm
        initialData={student}
        canManageEnrollment={canManageEnrollment}
      />
    </div>
  );
}


===== D:\.code\wattleos\src\app\(app)\students\[id]\page.tsx =====

// src/app/(app)/students/[id]/page.tsx
//
// ============================================================
// WattleOS V2 - Student Detail Page
// ============================================================
// Server Component. Fetches all student data and renders a
// comprehensive profile view with sections for medical,
// guardians, enrollments, safety data, and pickup authorizations.
//
// CHANGES from previous version:
// - Added PickupAuthorizationSection (client component)
// - Added "View Attendance" link in profile header
// ============================================================

import { getStudent } from '@/lib/actions/students';
import { notFound } from 'next/navigation';
import {
  formatStudentName,
  formatDate,
  calculateAge,
  enrollmentStatusColor,
  severityColor,
} from '@/lib/utils';
import Link from 'next/link';
import { PickupAuthorizationSection } from '@/components/domain/attendance/pickup-authorization-section';

interface StudentDetailPageProps {
  params: Promise<{ id: string }>;
}

export default async function StudentDetailPage({ params }: StudentDetailPageProps) {
  const { id } = await params;
  const result = await getStudent(id);

  if (result.error || !result.data) {
    notFound();
  }

  const student = result.data;
  const displayName = formatStudentName(student.first_name, student.last_name, student.preferred_name);
  const age = calculateAge(student.dob);

  // Check for critical medical alerts
  const criticalConditions = student.medical_conditions.filter(
    (c) => c.severity === 'life_threatening' || c.severity === 'severe'
  );

  return (
    <div className="space-y-6">
      {/* Breadcrumb */}
      <nav className="flex items-center gap-2 text-sm text-gray-500">
        <Link href="/students" className="hover:text-gray-700">
          Students
        </Link>
        <span>/</span>
        <span className="text-gray-900">{displayName}</span>
      </nav>

      {/* Critical Medical Alert Banner */}
      {criticalConditions.length > 0 && (
        <div className="rounded-md border border-red-200 bg-red-50 p-4">
          <div className="flex">
            <div className="flex-shrink-0">
              <svg className="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
                <path
                  fillRule="evenodd"
                  d="M8.485 2.495c.673-1.167 2.357-1.167 3.03 0l6.28 10.875c.673 1.167-.168 2.625-1.516 2.625H3.72c-1.347 0-2.189-1.458-1.515-2.625L8.485 2.495zM10 5a.75.75 0 01.75.75v3.5a.75.75 0 01-1.5 0v-3.5A.75.75 0 0110 5zm0 9a1 1 0 100-2 1 1 0 000 2z"
                  clipRule="evenodd"
                />
              </svg>
            </div>
            <div className="ml-3">
              <h3 className="text-sm font-medium text-red-800">Medical Alert</h3>
              <div className="mt-1 text-sm text-red-700">
                {criticalConditions.map((c) => (
                  <p key={c.id}>
                    <strong>{c.condition_name}</strong> ({c.severity.replace('_', ' ')})
                    {c.requires_medication && ` - Requires medication: ${c.medication_name}`}
                    {c.medication_location && ` (${c.medication_location})`}
                  </p>
                ))}
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Profile Header */}
      <div className="overflow-hidden rounded-lg border border-gray-200 bg-white shadow-sm">
        <div className="px-6 py-5">
          <div className="flex items-start gap-6">
            {/* Avatar */}
            <div className="flex-shrink-0">
              {student.photo_url ? (
                <img
                  className="h-20 w-20 rounded-full object-cover"
                  src={student.photo_url}
                  alt={displayName}
                />
              ) : (
                <div className="flex h-20 w-20 items-center justify-center rounded-full bg-indigo-100 text-2xl font-semibold text-indigo-600">
                  {student.first_name[0]}
                  {student.last_name[0]}
                </div>
              )}
            </div>

            {/* Info */}
            <div className="flex-1">
              <div className="flex items-center gap-3">
                <h1 className="text-2xl font-semibold text-gray-900">{displayName}</h1>
                <span
                  className={`inline-flex rounded-full border px-2.5 py-0.5 text-xs font-medium ${enrollmentStatusColor(student.enrollment_status)}`}
                >
                  {student.enrollment_status}
                </span>
              </div>
              {student.preferred_name && (
                <p className="text-sm text-gray-500">
                  Legal name: {student.first_name} {student.last_name}
                </p>
              )}
              <div className="mt-2 flex flex-wrap gap-x-6 gap-y-1 text-sm text-gray-500">
                {student.dob && (
                  <span>Born: {formatDate(student.dob)} ({age} yrs)</span>
                )}
                {student.gender && <span>Gender: {student.gender}</span>}
              </div>
              {student.notes && (
                <p className="mt-3 text-sm text-gray-600">{student.notes}</p>
              )}
            </div>

            {/* Actions */}
            <div className="flex flex-shrink-0 gap-2">
              <Link
                href={`/students/${id}/edit`}
                className="rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50"
              >
                Edit
              </Link>
            </div>
          </div>
        </div>
      </div>

      {/* Content Sections */}
      <div className="grid grid-cols-1 gap-6 lg:grid-cols-2">

        {/* Enrollments */}
        <section className="rounded-lg border border-gray-200 bg-white shadow-sm">
          <div className="border-b border-gray-200 px-6 py-4">
            <h2 className="text-lg font-medium text-gray-900">Enrollments</h2>
          </div>
          <div className="px-6 py-4">
            {student.enrollments.length === 0 ? (
              <p className="text-sm text-gray-500">No enrollment records.</p>
            ) : (
              <div className="space-y-3">
                {student.enrollments.map((enrollment) => (
                  <div
                    key={enrollment.id}
                    className="flex items-center justify-between rounded-md border border-gray-100 p-3"
                  >
                    <div>
                      <p className="text-sm font-medium text-gray-900">
                        {enrollment.class?.name ?? 'Unknown class'}
                      </p>
                      <p className="text-xs text-gray-500">
                        {formatDate(enrollment.start_date)}
                        {enrollment.end_date ? ` - ${formatDate(enrollment.end_date)}` : ' - present'}
                      </p>
                    </div>
                    <span
                      className={`inline-flex rounded-full border px-2 py-0.5 text-xs font-medium ${enrollmentStatusColor(enrollment.status)}`}
                    >
                      {enrollment.status}
                    </span>
                  </div>
                ))}
              </div>
            )}
          </div>
        </section>

        {/* Guardians */}
        <section className="rounded-lg border border-gray-200 bg-white shadow-sm">
          <div className="border-b border-gray-200 px-6 py-4">
            <h2 className="text-lg font-medium text-gray-900">Guardians</h2>
          </div>
          <div className="px-6 py-4">
            {student.guardians.length === 0 ? (
              <p className="text-sm text-gray-500">No guardians linked.</p>
            ) : (
              <div className="space-y-3">
                {student.guardians.map((guardian) => (
                  <div
                    key={guardian.id}
                    className="flex items-center justify-between rounded-md border border-gray-100 p-3"
                  >
                    <div>
                      <p className="text-sm font-medium text-gray-900">
                        {guardian.user?.first_name} {guardian.user?.last_name}
                        {guardian.is_primary && (
                          <span className="ml-2 text-xs font-normal text-indigo-600">Primary</span>
                        )}
                      </p>
                      <p className="text-xs text-gray-500">
                        {guardian.relationship}
                        {guardian.phone && ` Â· ${guardian.phone}`}
                      </p>
                    </div>
                    <div className="flex gap-1">
                      {guardian.pickup_authorized && (
                        <span className="rounded bg-green-50 px-1.5 py-0.5 text-xs text-green-700">
                          Pickup
                        </span>
                      )}
                      {guardian.media_consent && (
                        <span className="rounded bg-blue-50 px-1.5 py-0.5 text-xs text-blue-700">
                          Media
                        </span>
                      )}
                    </div>
                  </div>
                ))}
              </div>
            )}
          </div>
        </section>

        {/* Medical Conditions */}
        <section className="rounded-lg border border-gray-200 bg-white shadow-sm">
          <div className="border-b border-gray-200 px-6 py-4">
            <h2 className="text-lg font-medium text-gray-900">Medical Conditions</h2>
          </div>
          <div className="px-6 py-4">
            {student.medical_conditions.length === 0 ? (
              <p className="text-sm text-gray-500">No medical conditions recorded.</p>
            ) : (
              <div className="space-y-3">
                {student.medical_conditions.map((condition) => (
                  <div
                    key={condition.id}
                    className="rounded-md border border-gray-100 p-3"
                  >
                    <div className="flex items-center gap-2">
                      <p className="text-sm font-medium text-gray-900">{condition.condition_name}</p>
                      <span
                        className={`inline-flex rounded-full border px-2 py-0.5 text-xs font-medium ${severityColor(condition.severity)}`}
                      >
                        {condition.severity.replace('_', ' ')}
                      </span>
                    </div>
                    {condition.description && (
                      <p className="mt-1 text-xs text-gray-600">{condition.description}</p>
                    )}
                    {condition.requires_medication && (
                      <p className="mt-1 text-xs text-amber-700">
                        Medication: {condition.medication_name}
                        {condition.medication_location && ` (${condition.medication_location})`}
                      </p>
                    )}
                    {condition.action_plan && (
                      <p className="mt-1 text-xs text-gray-500">
                        Action plan: {condition.action_plan}
                      </p>
                    )}
                    {condition.expiry_date && (
                      <p className="mt-1 text-xs text-gray-400">
                        Review by: {formatDate(condition.expiry_date)}
                      </p>
                    )}
                  </div>
                ))}
              </div>
            )}
          </div>
        </section>

        {/* Emergency Contacts */}
        <section className="rounded-lg border border-gray-200 bg-white shadow-sm">
          <div className="border-b border-gray-200 px-6 py-4">
            <h2 className="text-lg font-medium text-gray-900">Emergency Contacts</h2>
          </div>
          <div className="px-6 py-4">
            {student.emergency_contacts.length === 0 ? (
              <p className="text-sm text-gray-500">No emergency contacts recorded.</p>
            ) : (
              <div className="space-y-3">
                {student.emergency_contacts.map((contact, index) => (
                  <div
                    key={contact.id}
                    className="flex items-center justify-between rounded-md border border-gray-100 p-3"
                  >
                    <div>
                      <p className="text-sm font-medium text-gray-900">
                        <span className="mr-2 inline-flex h-5 w-5 items-center justify-center rounded-full bg-gray-200 text-xs text-gray-600">
                          {index + 1}
                        </span>
                        {contact.name}
                      </p>
                      <p className="ml-7 text-xs text-gray-500">
                        {contact.relationship} Â· {contact.phone_primary}
                        {contact.phone_secondary && ` / ${contact.phone_secondary}`}
                      </p>
                    </div>
                  </div>
                ))}
              </div>
            )}
          </div>
        </section>

        {/* Pickup Authorizations - NEW */}
        <PickupAuthorizationSection studentId={id} />

        {/* Custody Restrictions */}
        {student.custody_restrictions.length > 0 && (
          <section className="rounded-lg border-2 border-red-200 bg-white shadow-sm lg:col-span-2">
            <div className="border-b border-red-200 bg-red-50 px-6 py-4">
              <h2 className="text-lg font-medium text-red-900">Custody Restrictions</h2>
            </div>
            <div className="px-6 py-4">
              <div className="space-y-3">
                {student.custody_restrictions.map((restriction) => (
                  <div
                    key={restriction.id}
                    className="rounded-md border border-red-100 bg-red-50/50 p-3"
                  >
                    <div className="flex items-center gap-2">
                      <p className="text-sm font-medium text-red-900">
                        {restriction.restricted_person_name}
                      </p>
                      <span className="inline-flex rounded-full border border-red-200 bg-red-100 px-2 py-0.5 text-xs font-medium text-red-800">
                        {restriction.restriction_type.replace(/_/g, ' ')}
                      </span>
                    </div>
                    {restriction.court_order_reference && (
                      <p className="mt-1 text-xs text-red-700">
                        Court order: {restriction.court_order_reference}
                      </p>
                    )}
                    <p className="mt-1 text-xs text-red-600">
                      Effective: {formatDate(restriction.effective_date)}
                      {restriction.expiry_date && ` - Expires: ${formatDate(restriction.expiry_date)}`}
                    </p>
                    {restriction.notes && (
                      <p className="mt-1 text-xs text-red-600">{restriction.notes}</p>
                    )}
                  </div>
                ))}
              </div>
            </div>
          </section>
        )}
      </div>
    </div>
  );
}


===== D:\.code\wattleos\src\app\(app)\students\new\page.tsx =====

// src/app/(app)/students/new/page.tsx
//
// ============================================================
// WattleOS V2 - Create Student Page
// ============================================================
// Server Component. Renders the StudentForm in create mode.
//
// Why server component wrapper: We check permissions server-side
// before rendering the form. If the user can't manage students,
// they shouldn't see the create form at all.
// ============================================================

import { getTenantContext } from '@/lib/auth/tenant-context';
import { Permissions } from '@/lib/constants/permissions';
import { redirect } from 'next/navigation';
import { StudentForm } from '@/components/domain/sis/StudentForm';
import Link from 'next/link';

export default async function CreateStudentPage() {
  const context = await getTenantContext();

  // Gate: only users with manage_students can create
  if (!context.permissions.includes(Permissions.MANAGE_STUDENTS)) {
    redirect('/students');
  }

  const canManageEnrollment = context.permissions.includes(Permissions.MANAGE_ENROLLMENT);

  return (
    <div className="space-y-6">
      {/* Breadcrumb */}
      <nav className="flex items-center gap-2 text-sm text-gray-500">
        <Link href="/students" className="hover:text-gray-700">
          Students
        </Link>
        <span>/</span>
        <span className="text-gray-900">New Student</span>
      </nav>

      {/* Page header */}
      <div>
        <h1 className="text-2xl font-semibold text-gray-900">Add New Student</h1>
        <p className="mt-1 text-sm text-gray-500">
          Enter the student&apos;s details below. You can add guardians, medical
          conditions, and enrollment information after creating the record.
        </p>
      </div>

      {/* Form */}
      <StudentForm canManageEnrollment={canManageEnrollment} />
    </div>
  );
}


===== D:\.code\wattleos\src\app\(app)\students\page.tsx =====

// src/app/(app)/students/page.tsx
//
// ============================================================
// WattleOS V2 - Student List Page
// ============================================================
// Server Component. Fetches students with filters and renders
// a searchable, paginated list. No 'use client' needed here.
//
// Fix: Removed `params.tenant` - the (app) route group has no
// [tenant] dynamic segment. All links now use absolute paths
// without a tenant prefix (e.g., /students, /students/[id]).
// Tenant isolation is handled by RLS + JWT, not URL segments.
// ============================================================

import { listStudents } from '@/lib/actions/students';
import { formatStudentName, enrollmentStatusColor, formatDate, calculateAge } from '@/lib/utils';
import { ENROLLMENT_STATUSES } from '@/lib/constants';
import { EnrollmentStatus } from '@/types/domain';
import Link from 'next/link';
import { StudentSearchBar } from '@/components/domain/students/StudentSearchBar';

interface StudentListPageProps {
  searchParams: Promise<{
    page?: string;
    search?: string;
    status?: string;
    class_id?: string;
  }>;
}

export default async function StudentListPage({ searchParams }: StudentListPageProps) {
  const search = await searchParams;

  const result = await listStudents({
    page: Number(search.page) || 1,
    per_page: 20,
    search: search.search,
    enrollment_status: search.status as EnrollmentStatus | undefined,
    class_id: search.class_id,
  });

  const students = result.data;
  const pagination = result.pagination;

  // Helper to build query strings for filter/pagination links
  function buildQuery(overrides: Record<string, string | undefined>): string {
    const params = new URLSearchParams();
    const merged = { search: search.search, status: search.status, ...overrides };
    for (const [key, value] of Object.entries(merged)) {
      if (value) params.set(key, value);
    }
    const qs = params.toString();
    return qs ? `?${qs}` : '';
  }

  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-2xl font-semibold text-gray-900">Students</h1>
          <p className="mt-1 text-sm text-gray-500">
            {pagination.total} student{pagination.total !== 1 ? 's' : ''} total
          </p>
        </div>
        <Link
          href="/students/new"
          className="inline-flex items-center rounded-md bg-indigo-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2"
        >
          + Add Student
        </Link>
      </div>

      {/* Search & Filters */}
      <div className="flex flex-col gap-4 sm:flex-row sm:items-center">
        <StudentSearchBar defaultValue={search.search ?? ''} />

        {/* Status filter tabs */}
        <div className="flex gap-2 overflow-x-auto">
          <Link
            href="/students"
            className={`whitespace-nowrap rounded-full px-3 py-1 text-sm font-medium ${
              !search.status
                ? 'bg-indigo-100 text-indigo-700'
                : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
            }`}
          >
            All
          </Link>
          {ENROLLMENT_STATUSES.map((s) => (
            <Link
              key={s.value}
              href={`/students${buildQuery({ status: s.value, page: undefined })}`}
              className={`whitespace-nowrap rounded-full px-3 py-1 text-sm font-medium ${
                search.status === s.value
                  ? 'bg-indigo-100 text-indigo-700'
                  : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
              }`}
            >
              {s.label}
            </Link>
          ))}
        </div>
      </div>

      {/* Student Table */}
      {result.error ? (
        <div className="rounded-md bg-red-50 p-4">
          <p className="text-sm text-red-700">{result.error.message}</p>
        </div>
      ) : students.length === 0 ? (
        <div className="rounded-lg border-2 border-dashed border-gray-300 p-12 text-center">
          <p className="text-sm text-gray-500">
            {search.search || search.status
              ? 'No students match your filters.'
              : 'No students yet. Add your first student to get started.'}
          </p>
        </div>
      ) : (
        <div className="overflow-hidden rounded-lg border border-gray-200 bg-white shadow-sm">
          <table className="min-w-full divide-y divide-gray-200">
            <thead className="bg-gray-50">
              <tr>
                <th className="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">
                  Name
                </th>
                <th className="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">
                  Age
                </th>
                <th className="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">
                  Status
                </th>
                <th className="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">
                  Added
                </th>
                <th className="relative px-6 py-3">
                  <span className="sr-only">View</span>
                </th>
              </tr>
            </thead>
            <tbody className="divide-y divide-gray-200 bg-white">
              {students.map((student) => (
                <tr key={student.id} className="hover:bg-gray-50">
                  <td className="whitespace-nowrap px-6 py-4">
                    <div className="flex items-center">
                      <div className="h-10 w-10 flex-shrink-0">
                        {student.photo_url ? (
                          <img
                            className="h-10 w-10 rounded-full object-cover"
                            src={student.photo_url}
                            alt=""
                          />
                        ) : (
                          <div className="flex h-10 w-10 items-center justify-center rounded-full bg-indigo-100 text-sm font-medium text-indigo-600">
                            {student.first_name[0]}
                            {student.last_name[0]}
                          </div>
                        )}
                      </div>
                      <div className="ml-4">
                        <div className="text-sm font-medium text-gray-900">
                          {formatStudentName(student.first_name, student.last_name, student.preferred_name)}
                        </div>
                        {student.preferred_name && (
                          <div className="text-xs text-gray-500">
                            Legal: {student.first_name} {student.last_name}
                          </div>
                        )}
                      </div>
                    </div>
                  </td>
                  <td className="whitespace-nowrap px-6 py-4 text-sm text-gray-500">
                    {calculateAge(student.dob) !== null ? `${calculateAge(student.dob)} yrs` : 'â€”'}
                  </td>
                  <td className="whitespace-nowrap px-6 py-4">
                    <span
                      className={`inline-flex rounded-full border px-2.5 py-0.5 text-xs font-medium ${enrollmentStatusColor(student.enrollment_status)}`}
                    >
                      {student.enrollment_status}
                    </span>
                  </td>
                  <td className="whitespace-nowrap px-6 py-4 text-sm text-gray-500">
                    {formatDate(student.created_at)}
                  </td>
                  <td className="whitespace-nowrap px-6 py-4 text-right text-sm font-medium">
                    <Link
                      href={`/students/${student.id}`}
                      className="text-indigo-600 hover:text-indigo-900"
                    >
                      View
                    </Link>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>

          {/* Pagination */}
          {pagination.total_pages > 1 && (
            <nav className="flex items-center justify-between border-t border-gray-200 bg-white px-4 py-3 sm:px-6">
              <div className="hidden sm:block">
                <p className="text-sm text-gray-700">
                  Showing{' '}
                  <span className="font-medium">{(pagination.page - 1) * pagination.per_page + 1}</span>
                  {' '}to{' '}
                  <span className="font-medium">
                    {Math.min(pagination.page * pagination.per_page, pagination.total)}
                  </span>
                  {' '}of{' '}
                  <span className="font-medium">{pagination.total}</span> results
                </p>
              </div>
              <div className="flex flex-1 justify-between sm:justify-end gap-2">
                {pagination.page > 1 && (
                  <Link
                    href={`/students${buildQuery({ page: String(pagination.page - 1) })}`}
                    className="rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50"
                  >
                    Previous
                  </Link>
                )}
                {pagination.page < pagination.total_pages && (
                  <Link
                    href={`/students${buildQuery({ page: String(pagination.page + 1) })}`}
                    className="rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50"
                  >
                    Next
                  </Link>
                )}
              </div>
            </nav>
          )}
        </div>
      )}
    </div>
  );
}


===== D:\.code\wattleos\src\app\(app)\timesheets\history\page.tsx =====

// ============================================================
// src/app/(app)/timesheets/history/page.tsx
// ============================================================
// My Timesheet History - lists all past timesheets with status
// badges, hours breakdown, and links to detail view.
//
// WHY server component: This is a read-only list page. No
// interactivity needed - pure data fetch and render.
// ============================================================

import { getTenantContext, hasPermission } from '@/lib/auth/tenant-context';
import { Permissions } from '@/lib/constants/permissions';
import { redirect } from 'next/navigation';
import { getMyTimesheets, getTimesheetDetail } from '@/lib/actions/timesheets';
import { TimesheetHistoryList } from '@/components/domain/timesheets/timesheet-history-list';
import Link from 'next/link';
import type { Timesheet } from '@/types/domain';

export default async function TimesheetHistoryPage() {
  const context = await getTenantContext();

  if (!hasPermission(context, Permissions.LOG_TIME)) {
    redirect('/dashboard');
  }

  const result = await getMyTimesheets();
  const timesheets: Array<Timesheet & { pay_period_name?: string }> = result.data ?? [];

  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-2xl font-bold text-gray-900">Timesheet History</h1>
          <p className="mt-1 text-sm text-gray-500">
            Your past timesheets and their approval status
          </p>
        </div>
        <Link
          href="/timesheets"
          className="inline-flex items-center gap-2 rounded-lg border border-gray-300 bg-white px-4 py-2.5 text-sm font-medium text-gray-700 shadow-sm transition-colors hover:bg-gray-50"
        >
          <svg className="h-4 w-4" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor">
            <path strokeLinecap="round" strokeLinejoin="round" d="M9 15 3 9m0 0 6-6M3 9h12a6 6 0 0 1 0 12h-3" />
          </svg>
          Current Period
        </Link>
      </div>

      {/* Content */}
      {timesheets.length === 0 ? (
        <div className="rounded-lg border border-gray-200 bg-white p-12 text-center">
          <svg className="mx-auto h-12 w-12 text-gray-300" fill="none" viewBox="0 0 24 24" strokeWidth={1} stroke="currentColor">
            <path strokeLinecap="round" strokeLinejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
          </svg>
          <p className="mt-4 text-sm font-medium text-gray-900">No timesheet history</p>
          <p className="mt-1 text-sm text-gray-500">
            Your submitted timesheets will appear here.
          </p>
          <Link
            href="/timesheets"
            className="mt-4 inline-flex items-center gap-2 rounded-lg bg-amber-600 px-4 py-2 text-sm font-medium text-white hover:bg-amber-700"
          >
            Go to Current Period
          </Link>
        </div>
      ) : (
        <TimesheetHistoryList timesheets={timesheets} />
      )}
    </div>
  );
}


===== D:\.code\wattleos\src\app\(app)\timesheets\page.tsx =====

// ============================================================
// src/app/(app)/timesheets/page.tsx
// ============================================================
// My Timesheet - shows the current pay period with a daily
// time entry grid. Staff can log hours, pick entry types,
// and submit when all days are filled.
//
// WHY Server Component shell: Fetches pay period + settings +
// entries + existing timesheet in parallel on the server,
// then hands structured data to a client component for
// interactive editing. Minimises client JS bundle.
// ============================================================

import { getTenantContext, hasPermission } from '@/lib/auth/tenant-context';
import { Permissions } from '@/lib/constants/permissions';
import { redirect } from 'next/navigation';
import { getCurrentPayPeriod } from '@/lib/actions/pay-periods';
import { getMyTimeEntries } from '@/lib/actions/time-entries';
import { getMyTimesheets } from '@/lib/actions/timesheets';
import { getPayrollSettings } from '@/lib/actions/payroll-integration';
import { TimesheetGridClient } from '@/components/domain/timesheets/timesheet-grid-client';
import Link from 'next/link';
import type { PayPeriod, PayrollSettings, TimeEntry, Timesheet, TimesheetStatus } from '@/types/domain';

export default async function TimesheetsPage() {
  const context = await getTenantContext();

  // Gate: must have log_time permission
  if (!hasPermission(context, Permissions.LOG_TIME)) {
    redirect('/dashboard');
  }

  // Parallel fetch: pay period, settings, and user's timesheets
  const [periodResult, settingsResult, timesheetsResult] = await Promise.all([
    getCurrentPayPeriod(),
    getPayrollSettings(),
    getMyTimesheets(),
  ]);

  const payPeriod: PayPeriod | null = periodResult.data ?? null;
  const settings: PayrollSettings | null = settingsResult.data ?? null;
  const allTimesheets: Array<Timesheet & { pay_period_name?: string }> = timesheetsResult.data ?? [];

  // If there's a current pay period, fetch time entries for it
  let timeEntries: TimeEntry[] = [];
  let currentTimesheet: (Timesheet & { pay_period_name?: string }) | null = null;

  if (payPeriod) {
    const entriesResult = await getMyTimeEntries({ payPeriodId: payPeriod.id });
    timeEntries = entriesResult.data ?? [];

    // Find existing timesheet for this period (if submitted/approved/rejected)
    currentTimesheet = allTimesheets.find(
      (ts) => ts.pay_period_id === payPeriod.id
    ) ?? null;
  }

  const isAdmin = hasPermission(context, Permissions.MANAGE_INTEGRATIONS);

  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-2xl font-bold text-gray-900">My Timesheet</h1>
          <p className="mt-1 text-sm text-gray-500">
            Log your daily hours and submit for approval
          </p>
        </div>
        <Link
          href="/timesheets/history"
          className="inline-flex items-center gap-2 rounded-lg border border-gray-300 bg-white px-4 py-2.5 text-sm font-medium text-gray-700 shadow-sm transition-colors hover:bg-gray-50"
        >
          <svg className="h-4 w-4" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor">
            <path strokeLinecap="round" strokeLinejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
          </svg>
          History
        </Link>
      </div>

      {/* No pay period state */}
      {!payPeriod && (
        <div className="rounded-lg border border-gray-200 bg-white p-12 text-center">
          <svg className="mx-auto h-12 w-12 text-gray-300" fill="none" viewBox="0 0 24 24" strokeWidth={1} stroke="currentColor">
            <path strokeLinecap="round" strokeLinejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 0 1 2.25-2.25h13.5A2.25 2.25 0 0 1 21 7.5v11.25m-18 0A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75m-18 0v-7.5A2.25 2.25 0 0 1 5.25 9h13.5A2.25 2.25 0 0 1 21 11.25v7.5" />
          </svg>
          <p className="mt-4 text-sm font-medium text-gray-900">No active pay period</p>
          <p className="mt-1 text-sm text-gray-500">
            {isAdmin
              ? 'Create a pay period in Settings â†’ Payroll to get started.'
              : 'Your administrator needs to create a pay period before you can log hours.'}
          </p>
          {isAdmin && (
            <Link
              href="/admin/settings/payroll"
              className="mt-4 inline-flex items-center gap-2 rounded-lg bg-amber-600 px-4 py-2 text-sm font-medium text-white hover:bg-amber-700"
            >
              Payroll Settings
            </Link>
          )}
        </div>
      )}

      {/* Active pay period â†’ interactive grid */}
      {payPeriod && settings && (
        <TimesheetGridClient
          payPeriod={payPeriod}
          defaultStartTime={settings.default_start_time}
          defaultEndTime={settings.default_end_time}
          defaultBreakMinutes={settings.default_break_minutes}
          existingEntries={timeEntries}
          currentTimesheet={currentTimesheet}
        />
      )}
    </div>
  );
}


===== D:\.code\wattleos\src\app\(auth)\auth\callback\route.ts =====

// src/app/(auth)/auth/callback/route.ts
//
// ============================================================
// WattleOS V2 - Google OAuth Callback
// ============================================================
// Supabase redirects here after Google sign-in. We exchange the
// auth code for a session, resolve the user's tenant(s), and
// redirect them to the appropriate page.
//
// BUG FIX: The original version set cookies on a NextResponse.next()
// object but returned a *different* NextResponse.redirect(). The
// redirect response didn't carry the session cookies, so the browser
// never received them â†’ middleware saw no session â†’ redirect to /login.
//
// FIX: We accumulate cookies during exchangeCodeForSession, then
// copy them onto whichever redirect response we return.
// ============================================================

import { NextRequest, NextResponse } from 'next/server';
import { createServerClient } from '@supabase/ssr';
import type { CookieSerializeOptions } from 'cookie';
import { getUserTenants, setUserTenant } from '@/lib/auth/tenant-context';

/**
 * Supabase SSR calls setAll([{ name, value, options }, ...])
 * We store them so we can replay onto the final redirect response.
 */
type CookieToSet = {
  name: string;
  value: string;
  options?: CookieSerializeOptions;
};

export async function GET(request: NextRequest) {
  const { searchParams, origin } = request.nextUrl;
  const code = searchParams.get('code');
  const redirectTo = searchParams.get('redirect') ?? '/dashboard';

  if (!code) {
    return NextResponse.redirect(`${origin}/login?error=missing_code`);
  }

  // â”€â”€ Accumulate cookies set by Supabase during exchangeCodeForSession â”€â”€
  const cookieStore: CookieToSet[] = [];

  const supabase = createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        getAll() {
          return request.cookies.getAll();
        },
        setAll(cookiesToSet: CookieToSet[]) {
          // Store every cookie Supabase wants to set
          cookiesToSet.forEach((cookie) => cookieStore.push(cookie));
        },
      },
    }
  );

  // Exchange the code for a session (this triggers setAll with auth cookies)
  const { data: sessionData, error: sessionError } =
    await supabase.auth.exchangeCodeForSession(code);

  if (sessionError || !sessionData.user) {
    return NextResponse.redirect(`${origin}/login?error=auth_failed`);
  }

  const userId = sessionData.user.id;

  // Check how many tenants this user belongs to
  const tenants = await getUserTenants(userId);

  // â”€â”€ Determine where to send the user â”€â”€
  let redirectUrl: string;

  if (tenants.length === 0) {
    redirectUrl = `${origin}/login?error=no_school`;
  } else if (tenants.length === 1) {
    // Single tenant - stamp it into the JWT and go straight to the app
    await setUserTenant(userId, tenants[0].tenant.id);
    redirectUrl = `${origin}${redirectTo}`;
  } else {
    // Multiple tenants - let them pick
    redirectUrl = `${origin}/tenant-picker`;
  }

  // â”€â”€ Build the redirect response and replay ALL cookies onto it â”€â”€
  const response = NextResponse.redirect(redirectUrl);

  for (const { name, value, options } of cookieStore) {
    response.cookies.set(name, value, options);
  }

  return response;
}


===== D:\.code\wattleos\src\app\(auth)\login\page.tsx =====

"use client";

import { createSupabaseBrowserClient } from "@/lib/supabase/browser";
import { useState } from "react";

export default function LoginPage() {
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);

  async function handleGoogleLogin() {
    setIsLoading(true);
    setError(null);

    const supabase = createSupabaseBrowserClient();

    const siteUrl = process.env.NEXT_PUBLIC_APP_URL ?? window.location.origin;

    const { error } = await supabase.auth.signInWithOAuth({
      provider: "google",
      options: {
        redirectTo: `${siteUrl}/auth/callback`,
        queryParams: {
          access_type: "offline",
          prompt: "consent",
        },
      },
    });

    if (error) {
      setError(error.message);
      setIsLoading(false);
    }
    // If no error, the browser will redirect to Google - no need to set loading false.
  }

  return (
    <div className="flex min-h-screen items-center justify-center bg-gray-50">
      <div className="w-full max-w-md space-y-8 rounded-xl bg-white p-8 shadow-lg">
        <div className="text-center">
          <h1 className="text-3xl font-bold tracking-tight text-gray-900">
            WattleOS
          </h1>
          <p className="mt-2 text-sm text-gray-600">
            Sign in to your school&apos;s operating system
          </p>
        </div>

        {error && (
          <div className="rounded-md bg-red-50 p-4 text-sm text-red-700">
            {error}
          </div>
        )}

        <button
          onClick={handleGoogleLogin}
          disabled={isLoading}
          className="flex w-full items-center justify-center gap-3 rounded-lg border border-gray-300 bg-white px-4 py-3 text-sm font-medium text-gray-700 shadow-sm transition-colors hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50"
        >
          <svg className="h-5 w-5" viewBox="0 0 24 24">
            <path
              d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92a5.06 5.06 0 01-2.2 3.32v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.1z"
              fill="#4285F4"
            />
            <path
              d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"
              fill="#34A853"
            />
            <path
              d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"
              fill="#FBBC05"
            />
            <path
              d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"
              fill="#EA4335"
            />
          </svg>
          {isLoading ? "Signing in..." : "Continue with Google"}
        </button>

        <p className="text-center text-xs text-gray-500">
          By signing in, you agree to our Terms of Service and Privacy Policy.
        </p>
      </div>
    </div>
  );
}



===== D:\.code\wattleos\src\app\(auth)\tenant-picker\page.tsx =====

// src/app/(auth)/tenant-picker/page.tsx
//
// ============================================================
// WattleOS V2 â€” Tenant Picker Page
// ============================================================
// Server Component. Shown when a user belongs to multiple
// tenants and needs to choose which school to work in.
//
// WHY this page exists: Multi-tenant users (relief teachers,
// network admins) need a way to switch context. Single-tenant
// users are auto-selected here and never see the UI.
//
// FIXES APPLIED:
// 1. Import: createClient â†’ createSupabaseServerClient
//    (createClient doesn't exist in server.ts)
// 2. Single-tenant loop: now calls setUserTenant() BEFORE
//    redirecting to /dashboard, so the JWT has a tenant_id
//    when getTenantContext() runs on the dashboard page.
// ============================================================

import { redirect } from 'next/navigation';
import { createSupabaseServerClient } from '@/lib/supabase/server';
import { getUserTenants, setUserTenant } from '@/lib/auth/tenant-context';
import { TenantPickerClient } from './tenant-picker-client';

export default async function TenantPickerPage() {
  const supabase = await createSupabaseServerClient();

  const {
    data: { user },
  } = await supabase.auth.getUser();

  if (!user) {
    redirect('/login');
  }

  const tenants = await getUserTenants(user.id);

  if (tenants.length === 0) {
    redirect('/login?error=no_school');
  }

  if (tenants.length === 1) {
    // Write the tenant_id into the JWT BEFORE redirecting.
    // Without this, /dashboard â†’ getTenantContext() â†’ no tenant_id
    // â†’ redirect back to /tenant-picker â†’ infinite 307 loop.
    await setUserTenant(user.id, tenants[0].tenant.id);
    redirect('/dashboard');
  }

  return (
    <div className="flex min-h-screen items-center justify-center bg-gray-50">
      <div className="w-full max-w-lg space-y-6 rounded-xl bg-white p-8 shadow-lg">
        <div className="text-center">
          <h1 className="text-2xl font-bold tracking-tight text-gray-900">
            Choose a School
          </h1>
          <p className="mt-2 text-sm text-gray-600">
            You have access to multiple schools. Select one to continue.
          </p>
        </div>

        <TenantPickerClient
          tenants={tenants.map((t) => ({
            tenantId: t.tenant.id,
            tenantName: t.tenant.name,
            tenantSlug: t.tenant.slug,
            roleName: t.role.name,
            logoUrl: t.tenant.logo_url,
          }))}
        />
      </div>
    </div>
  );
}


===== D:\.code\wattleos\src\app\(auth)\tenant-picker\tenant-picker-client.tsx =====

"use client";

import { selectTenantAction } from "@/lib/actions/auth";
import { useRouter } from "next/navigation";
import { useState } from "react";

interface TenantOption {
  tenantId: string;
  tenantName: string;
  tenantSlug: string;
  roleName: string;
  logoUrl: string | null;
}

interface TenantPickerClientProps {
  tenants: TenantOption[];
}

export function TenantPickerClient({ tenants }: TenantPickerClientProps) {
  const [isLoading, setIsLoading] = useState<string | null>(null);
  const [error, setError] = useState<string | null>(null);
  const router = useRouter();

  async function handleSelect(tenantId: string) {
    setIsLoading(tenantId);
    setError(null);

    const result = await selectTenantAction(tenantId);

    if (result.error) {
      setError(result.error.message);
      setIsLoading(null);
      return;
    }

    router.push("/dashboard");
    router.refresh();
  }

  return (
    <div className="space-y-3">
      {error && (
        <div className="rounded-md bg-red-50 p-4 text-sm text-red-700">
          {error}
        </div>
      )}

      {tenants.map((tenant) => (
        <button
          key={tenant.tenantId}
          onClick={() => handleSelect(tenant.tenantId)}
          disabled={isLoading !== null}
          className="flex w-full items-center gap-4 rounded-lg border border-gray-200 p-4 text-left transition-colors hover:border-amber-300 hover:bg-amber-50 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50"
        >
          <div className="flex h-12 w-12 flex-shrink-0 items-center justify-center rounded-lg bg-amber-100 text-lg font-bold text-amber-700">
            {tenant.logoUrl ? (
              <img
                src={tenant.logoUrl}
                alt={tenant.tenantName}
                className="h-12 w-12 rounded-lg object-cover"
              />
            ) : (
              tenant.tenantName.charAt(0).toUpperCase()
            )}
          </div>
          <div className="min-w-0 flex-1">
            <p className="truncate text-sm font-medium text-gray-900">
              {tenant.tenantName}
            </p>
            <p className="text-xs text-gray-500">{tenant.roleName}</p>
          </div>
          {isLoading === tenant.tenantId && (
            <div className="h-5 w-5 animate-spin rounded-full border-2 border-amber-500 border-t-transparent" />
          )}
        </button>
      ))}
    </div>
  );
}



===== D:\.code\wattleos\src\app\api\reports\[reportId]\pdf\route.ts =====

// src/app/api/reports/[reportId]/pdf/route.ts
//
// ============================================================
// WattleOS V2 - Report PDF Download Route
// ============================================================
// Returns a fresh signed URL for an exported report PDF.
// - Staff route: requires MANAGE_REPORTS permission
// - Ensures report exists + not deleted
// - Ensures PDF has been exported (pdf_storage_path set)
// - Returns a signed URL (1 hour) and a safe filename
//
// NOTE: We do NOT stream bytes here - Supabase signed URL
// is the simplest + most scalable approach.
// ============================================================

import { NextRequest, NextResponse } from "next/server";
import { createSupabaseServerClient, createSupabaseAdminClient } from "@/lib/supabase/server";
import { requirePermission } from "@/lib/auth/tenant-context";
import { Permissions } from "@/lib/constants/permissions";

// Supabase/PostgREST sometimes returns joined relations as arrays.
// Normalize "object | object[] | null" into "object | null".
function firstOrNull<T>(v: T | T[] | null | undefined): T | null {
  if (!v) return null;
  return Array.isArray(v) ? (v[0] ?? null) : v;
}

function safeFilename(studentName: string, term: string) {
  const safeName = studentName
    .replace(/[^a-zA-Z0-9\s]/g, "")
    .replace(/\s+/g, "_");
  const safeTerm = term
    .replace(/[^a-zA-Z0-9\s]/g, "")
    .replace(/\s+/g, "_");
  return `${safeName}_${safeTerm}_Report.pdf`;
}

export async function GET(
  _req: NextRequest,
  context: { params: Promise<{ reportId: string }> }
) {
  try {
    await requirePermission(Permissions.MANAGE_REPORTS);
    const { reportId } = await context.params;

    const supabase = await createSupabaseServerClient();
    const admin = createSupabaseAdminClient();

    const { data: report, error } = await supabase
      .from("student_reports")
      .select(
        `
        id, pdf_storage_path, term, status,
        student:students(first_name, last_name, preferred_name)
      `
      )
      .eq("id", reportId)
      .is("deleted_at", null)
      .single();

    if (error || !report) {
      return NextResponse.json({ error: "Report not found" }, { status: 404 });
    }

    // Normalize student join (can be object or array)
    const student = firstOrNull(
      report.student as unknown as
        | { first_name: string; last_name: string; preferred_name: string | null }
        | { first_name: string; last_name: string; preferred_name: string | null }[]
        | null
    );

    const pdfPath = (report as any).pdf_storage_path as string | null | undefined;
    if (!pdfPath) {
      return NextResponse.json(
        { error: "PDF not available. Export the report first." },
        { status: 404 }
      );
    }

    // Signed URL (1 hour)
    const { data: signed, error: signedErr } = await admin.storage
      .from("reports")
      .createSignedUrl(pdfPath, 3600);

    if (signedErr || !signed?.signedUrl) {
      return NextResponse.json(
        { error: "Failed to create download URL" },
        { status: 500 }
      );
    }

    const studentName = student
      ? `${student.preferred_name ?? student.first_name} ${student.last_name}`
      : "Student";
    const term = ((report as any).term as string | null) ?? "Report";
    const filename = safeFilename(studentName, term);

    // Option A (best UX): redirect browser straight to the signed URL.
    // You can still read filename from a header if you want.
    return NextResponse.redirect(signed.signedUrl, {
      headers: {
        "x-wattle-filename": filename,
      },
    });

    // Option B (API style): return JSON instead of redirect.
    // return NextResponse.json({ download_url: signed.signedUrl, filename });
  } catch (err) {
    const message = err instanceof Error ? err.message : "Failed to get PDF URL";
    return NextResponse.json({ error: message }, { status: 500 });
  }
}



===== D:\.code\wattleos\src\app\api\webhooks\stripe\route.ts =====

// src/app/api/webhooks/stripe/route.ts
//
// ============================================================
// WattleOS V2 â€” Stripe Webhook Handler
// ============================================================
// Receives events from Stripe and updates WattleOS state.
//
// EVENTS HANDLED:
// â€¢ invoice.paid â€” mark invoice paid, create payment record
// â€¢ invoice.payment_failed â€” mark payment failed, log attempt
// â€¢ charge.refunded â€” create refund payment record
//
// SECURITY: Verifies webhook signature using the secret from
// the tenant's integration config. Uses Supabase admin client
// (service role) since webhooks run outside user auth context.
//
// NOTE: This route must NOT use authentication middleware.
// Stripe calls it directly â€” there's no user session.
// ============================================================

import { NextRequest, NextResponse } from "next/server";
import { createSupabaseAdminClient } from "@/lib/supabase/server";
import type Stripe from "stripe";

// ============================================================
// Helpers
// ============================================================

type SupabaseAdmin = ReturnType<typeof createSupabaseAdminClient>;

/**
 * Stripe has many "expandable" fields that can be:
 *   string | { id: string, ... } | null
 *
 * This helper safely extracts the id string.
 */
function expandableId<T extends { id: string }>(
  v: string | T | null | undefined
): string | null {
  if (!v) return null;
  return typeof v === "string" ? v : v.id;
}

function jsonOk() {
  return NextResponse.json({ received: true });
}

function jsonErr(message: string, status = 500) {
  return NextResponse.json({ error: message }, { status });
}

// ============================================================
// Route
// ============================================================

export async function POST(request: NextRequest) {
  let event: Stripe.Event;
  let rawBody = "";

  try {
    rawBody = await request.text();
    const signature = request.headers.get("stripe-signature");

    if (!signature) return jsonErr("Missing signature", 400);

    // Global webhook secret (single endpoint). Per-tenant secrets would
    // require per-tenant endpoints or Stripe Connect.
    const webhookSecret = process.env.STRIPE_WEBHOOK_SECRET;
    if (!webhookSecret) {
      console.error("STRIPE_WEBHOOK_SECRET not set");
      return jsonErr("Server config error", 500);
    }

    const { verifyWebhookSignature } = await import(
      "@/lib/integrations/stripe/client"
    );

    event = verifyWebhookSignature(rawBody, signature, webhookSecret);
  } catch (err) {
    console.error("Webhook signature verification failed:", err);
    return jsonErr("Invalid signature", 400);
  }

  const supabase = createSupabaseAdminClient();

  try {
    switch (event.type) {
      case "invoice.paid": {
        await handleInvoicePaid(supabase, event.data.object as Stripe.Invoice);
        break;
      }

      case "invoice.payment_failed": {
        await handleInvoicePaymentFailed(
          supabase,
          event.data.object as Stripe.Invoice
        );
        break;
      }

      case "charge.refunded": {
        await handleChargeRefunded(
          supabase,
          event.data.object as Stripe.Charge
        );
        break;
      }

      default:
        // Ignore unhandled events
        break;
    }

    return jsonOk();
  } catch (err) {
    console.error(`Webhook handler error for ${event.type}:`, err);
    return jsonErr("Handler failed", 500);
  }
}

// ============================================================
// Handlers
// ============================================================

async function handleInvoicePaid(
  supabase: SupabaseAdmin,
  stripeInvoice: Stripe.Invoice
) {
  const wattleosInvoiceId = stripeInvoice.metadata?.wattleos_invoice_id;
  if (!wattleosInvoiceId) return; // Not a WattleOS-managed invoice

  const tenantId = stripeInvoice.metadata?.wattleos_tenant_id;
  if (!tenantId) return;

  // Stripe fields can be expandable; types may differ across SDK versions.
  // We avoid hard dependency on Invoice having these properties in types.
  const paymentIntentId = expandableId(
    (stripeInvoice as any).payment_intent as string | { id: string } | null
  );
  const chargeId = expandableId(
    (stripeInvoice as any).charge as string | { id: string } | null
  );

  // Update invoice status
  await supabase
    .from("invoices")
    .update({
      status: "paid",
      amount_paid_cents: stripeInvoice.amount_paid,
      stripe_payment_intent_id: paymentIntentId,
      paid_at: new Date().toISOString(),
    })
    .eq("id", wattleosInvoiceId);

  // Create payment record
  await supabase.from("payments").insert({
    tenant_id: tenantId,
    invoice_id: wattleosInvoiceId,
    amount_cents: stripeInvoice.amount_paid,
    currency: stripeInvoice.currency,
    status: "succeeded",
    stripe_payment_intent_id: paymentIntentId,
    stripe_charge_id: chargeId,
    paid_at: new Date().toISOString(),
  });

  // Log to integration sync
  await supabase.from("integration_sync_logs").insert({
    tenant_id: tenantId,
    provider: "stripe",
    operation: "invoice_paid",
    entity_type: "invoice",
    entity_id: wattleosInvoiceId,
    status: "success",
    response_data: {
      stripe_invoice_id: stripeInvoice.id,
      amount_paid: stripeInvoice.amount_paid,
      stripe_payment_intent_id: paymentIntentId,
      stripe_charge_id: chargeId,
    },
  });
}

async function handleInvoicePaymentFailed(
  supabase: SupabaseAdmin,
  stripeInvoice: Stripe.Invoice
) {
  const wattleosInvoiceId = stripeInvoice.metadata?.wattleos_invoice_id;
  if (!wattleosInvoiceId) return;

  const tenantId = stripeInvoice.metadata?.wattleos_tenant_id;
  if (!tenantId) return;

  const paymentIntentId = expandableId(
    (stripeInvoice as any).payment_intent as string | { id: string } | null
  );

  // Update invoice â€” don't change to 'void', it might retry
  await supabase
    .from("invoices")
    .update({ status: "overdue" })
    .eq("id", wattleosInvoiceId);

  // Create failed payment record
  await supabase.from("payments").insert({
    tenant_id: tenantId,
    invoice_id: wattleosInvoiceId,
    amount_cents: stripeInvoice.amount_due,
    currency: stripeInvoice.currency,
    status: "failed",
    stripe_payment_intent_id: paymentIntentId,
    failure_reason: "Payment declined",
  });

  // Log
  await supabase.from("integration_sync_logs").insert({
    tenant_id: tenantId,
    provider: "stripe",
    operation: "payment_failed",
    entity_type: "invoice",
    entity_id: wattleosInvoiceId,
    status: "failure",
    error_message: "Payment was declined by the card issuer",
    response_data: {
      stripe_invoice_id: stripeInvoice.id,
      stripe_payment_intent_id: paymentIntentId,
    },
  });
}

async function handleChargeRefunded(supabase: SupabaseAdmin, charge: Stripe.Charge) {
  const paymentIntentId = expandableId(
    charge.payment_intent as unknown as string | { id: string } | null
  );
  if (!paymentIntentId) return;

  // Find the payment by stripe_payment_intent_id
  const { data: payment } = await supabase
    .from("payments")
    .select("id, invoice_id, tenant_id")
    .eq("stripe_payment_intent_id", paymentIntentId)
    .limit(1)
    .maybeSingle();

  if (!payment) return;

  const refundAmount = charge.amount_refunded;
  const isFullRefund = charge.amount_refunded >= charge.amount;

  // Update original payment
  await supabase
    .from("payments")
    .update({
      status: isFullRefund ? "refunded" : "partially_refunded",
      refund_amount_cents: refundAmount,
    })
    .eq("id", payment.id);

  // Update invoice status
  await supabase
    .from("invoices")
    .update({
      status: isFullRefund ? "refunded" : "partially_paid",
    })
    .eq("id", payment.invoice_id);

  // Log
  await supabase.from("integration_sync_logs").insert({
    tenant_id: payment.tenant_id,
    provider: "stripe",
    operation: "charge_refunded",
    entity_type: "invoice",
    entity_id: payment.invoice_id,
    status: "success",
    response_data: {
      stripe_charge_id: charge.id,
      stripe_payment_intent_id: paymentIntentId,
      refund_amount: refundAmount,
      full_refund: isFullRefund,
    },
  });
}



===== D:\.code\wattleos\src\app\layout.tsx =====

// src/app/layout.tsx
//
// ============================================================
// WattleOS V2 â€” Root Layout
// ============================================================
// WHY cookie-based theme: This layout wraps BOTH authenticated
// pages (the app) and unauthenticated pages (login, tenant-picker).
// It cannot call getTenantContext(). Instead, it reads a cookie
// that the (app) layout's server action maintains.
//
// The cookie contains the resolved display config (theme, density,
// font scale, brand hue). When no cookie exists (first visit,
// logged out), sensible defaults are used.
//
// WHY no next/font import: DM Sans and Source Serif 4 are loaded
// via @import in globals.css. Using next/font/google would conflict
// with the Google Fonts CDN approach that gives us the full
// optical size (opsz) axis.
//
// DATA ATTRIBUTES ON <html>:
//   data-density  = "compact" | "comfortable" | "spacious"
//   data-font-scale = "sm" | "base" | "lg" | "xl"
//   class         = "" (light) | "dark"
//   style         = --brand-hue: N; --brand-sat: N%;
// ============================================================

import type { Metadata, Viewport } from 'next';
import { cookies } from 'next/headers';
import './globals.css';
import {
  parseDisplayCookie,
  DISPLAY_COOKIE_NAME,
} from '@/types/display';

export const metadata: Metadata = {
  title: {
    default: 'WattleOS',
    template: '%s Â· WattleOS',
  },
  description: 'Montessori-native school operating system',
  applicationName: 'WattleOS',
};

export const viewport: Viewport = {
  width: 'device-width',
  initialScale: 1,
  maximumScale: 5,
  themeColor: [
    { media: '(prefers-color-scheme: light)', color: 'hsl(40, 30%, 98%)' },
    { media: '(prefers-color-scheme: dark)', color: 'hsl(25, 15%, 8%)' },
  ],
};

export default async function RootLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  // Read display config from cookie (set by (app) layout on auth pages)
  const cookieStore = await cookies();
  const displayCookie = cookieStore.get(DISPLAY_COOKIE_NAME)?.value;
  const display = parseDisplayCookie(displayCookie);

  // Resolve theme class.
  // "system" means no class â€” CSS prefers-color-scheme handles it.
  // For "system" to work with .dark class, we'd need client JS.
  // For now, "system" defaults to light on the server; a tiny
  // inline script below handles the flash-free client detection.
  const themeClass = display.theme === 'dark' ? 'dark' : '';

  // Build brand style if custom hue is set
  const brandStyle: React.CSSProperties = {};
  if (display.brandHue !== null) {
    (brandStyle as Record<string, string>)['--brand-hue'] = String(display.brandHue);
  }
  if (display.brandSaturation !== null) {
    (brandStyle as Record<string, string>)['--brand-sat'] = `${display.brandSaturation}%`;
  }

  return (
    <html
      lang="en"
      className={themeClass}
      data-density={display.density}
      data-font-scale={display.fontScale}
      style={Object.keys(brandStyle).length > 0 ? brandStyle : undefined}
      suppressHydrationWarning
    >
      <head>
        {/* Inline script to handle "system" theme without FOUC.
            Runs before paint, checks prefers-color-scheme, adds/removes .dark.
            Only activates when theme is "system". */}
        {display.theme === 'system' && (
          <script
            dangerouslySetInnerHTML={{
              __html: `(function(){try{if(window.matchMedia('(prefers-color-scheme:dark)').matches){document.documentElement.classList.add('dark')}else{document.documentElement.classList.remove('dark')}}catch(e){}})()`,
            }}
          />
        )}
      </head>
      <body>{children}</body>
    </html>
  );
}


===== D:\.code\wattleos\src\components\domain\admin\appearance-settings-client.tsx =====

// src/components/domain/admin/appearance-settings-client.tsx
//
// ============================================================
// WattleOS V2 â€” Appearance Settings Form (Client Component)
// ============================================================
// Interactive form for school appearance configuration.
// Uses 'use client' for the color picker, radio buttons,
// and live preview functionality.
//
// LIVE PREVIEW: Changes are applied to the DOM immediately
// (via data attributes and CSS variables) so the admin sees
// the effect before saving. On save, the server action
// persists to DB and updates the cookie.
// ============================================================

'use client';

import { useState, useTransition, useCallback } from 'react';
import { updateTenantDisplaySettings } from '@/lib/actions/display-settings';
import {
  type TenantDisplaySettings,
  type DensityMode,
  type ThemeMode,
  DENSITY_OPTIONS,
  THEME_OPTIONS,
} from '@/types/display';

interface AppearanceSettingsClientProps {
  initialSettings: TenantDisplaySettings;
}

export function AppearanceSettingsClient({
  initialSettings,
}: AppearanceSettingsClientProps) {
  const [settings, setSettings] = useState<TenantDisplaySettings>(initialSettings);
  const [isPending, startTransition] = useTransition();
  const [saveStatus, setSaveStatus] = useState<'idle' | 'saved' | 'error'>('idle');

  // ---- Live preview helpers ----

  const applyPreview = useCallback((updated: TenantDisplaySettings) => {
    const html = document.documentElement;

    // Brand hue preview
    if (updated.brandHue !== null) {
      html.style.setProperty('--brand-hue', String(updated.brandHue));
    } else {
      html.style.removeProperty('--brand-hue');
    }

    if (updated.brandSaturation !== null) {
      html.style.setProperty('--brand-sat', `${updated.brandSaturation}%`);
    } else {
      html.style.removeProperty('--brand-sat');
    }

    // Density preview
    html.dataset.density = updated.defaultDensity;

    // Theme preview
    if (updated.defaultTheme === 'dark') {
      html.classList.add('dark');
    } else {
      html.classList.remove('dark');
    }
  }, []);

  const updateField = <K extends keyof TenantDisplaySettings>(
    key: K,
    value: TenantDisplaySettings[K]
  ) => {
    const updated = { ...settings, [key]: value };
    setSettings(updated);
    applyPreview(updated);
    setSaveStatus('idle');
  };

  // ---- Save ----

  const handleSave = () => {
    startTransition(async () => {
      const result = await updateTenantDisplaySettings(settings);
      if (result.error) {
        setSaveStatus('error');
      } else {
        setSaveStatus('saved');
        // Force page reload to pick up new cookie in root layout
        setTimeout(() => window.location.reload(), 800);
      }
    });
  };

  // ---- Hue presets (common school brand colors) ----

  const huePresets = [
    { label: 'Wattle Amber', hue: 38, sat: 92 },
    { label: 'Forest Green', hue: 152, sat: 50 },
    { label: 'Ocean Blue', hue: 210, sat: 65 },
    { label: 'Berry Purple', hue: 270, sat: 50 },
    { label: 'Sunset Red', hue: 355, sat: 70 },
    { label: 'Teal', hue: 180, sat: 50 },
    { label: 'Rose', hue: 340, sat: 60 },
    { label: 'Slate', hue: 215, sat: 20 },
  ];

  return (
    <div className="space-y-[var(--density-section-gap)] max-w-[var(--content-narrow-width)]">
      {/* ---- Brand Color ---- */}
      <section className="rounded-lg border border-border bg-card p-[var(--density-card-padding)]">
        <h2 className="text-[var(--text-lg)] font-semibold text-foreground">
          Brand Colour
        </h2>
        <p className="mt-1 text-[var(--text-sm)] text-muted-foreground">
          Pick your school&apos;s primary colour. This tints buttons, links, and
          highlights across the platform.
        </p>

        {/* Preset swatches */}
        <div className="mt-4 flex flex-wrap gap-[var(--density-sm)]">
          {huePresets.map((preset) => {
            const isActive =
              settings.brandHue === preset.hue &&
              settings.brandSaturation === preset.sat;

            return (
              <button
                key={preset.label}
                type="button"
                onClick={() => {
                  updateField('brandHue', preset.hue);
                  updateField('brandSaturation', preset.sat);
                }}
                className={`
                  flex flex-col items-center gap-1 rounded-lg p-2 transition-all
                  ${isActive ? 'ring-2 ring-ring ring-offset-2 ring-offset-background' : 'hover:bg-muted'}
                `}
                title={preset.label}
              >
                <div
                  className="h-10 w-10 rounded-full border border-border"
                  style={{ background: `hsl(${preset.hue} ${preset.sat}% 50%)` }}
                />
                <span className="text-[var(--text-xs)] text-muted-foreground">
                  {preset.label}
                </span>
              </button>
            );
          })}
        </div>

        {/* Custom hue slider */}
        <div className="mt-4 space-y-2">
          <label className="block text-[var(--text-sm)] font-medium text-foreground">
            Custom Hue: {settings.brandHue ?? 38}Â°
          </label>
          <input
            type="range"
            min={0}
            max={360}
            value={settings.brandHue ?? 38}
            onChange={(e) => updateField('brandHue', Number(e.target.value))}
            className="w-full accent-[var(--primary)]"
            style={{
              background: `linear-gradient(to right, 
                hsl(0 80% 50%), hsl(60 80% 50%), hsl(120 80% 50%), 
                hsl(180 80% 50%), hsl(240 80% 50%), hsl(300 80% 50%), hsl(360 80% 50%))`,
              height: '8px',
              borderRadius: '4px',
            }}
          />
          {/* Preview bar showing the resolved primary */}
          <div
            className="h-3 w-full rounded-full"
            style={{
              background: `hsl(${settings.brandHue ?? 38} ${settings.brandSaturation ?? 92}% 50%)`,
            }}
          />
        </div>

        {/* Reset to default */}
        <button
          type="button"
          onClick={() => {
            updateField('brandHue', null);
            updateField('brandSaturation', null);
          }}
          className="mt-3 text-[var(--text-sm)] text-muted-foreground underline decoration-dotted hover:text-foreground"
        >
          Reset to Wattle Amber (default)
        </button>
      </section>

      {/* ---- Default Density ---- */}
      <section className="rounded-lg border border-border bg-card p-[var(--density-card-padding)]">
        <h2 className="text-[var(--text-lg)] font-semibold text-foreground">
          Default Layout Density
        </h2>
        <p className="mt-1 text-[var(--text-sm)] text-muted-foreground">
          Controls spacing and sizing across the platform. Users can override this
          in their personal settings.
        </p>

        <div className="mt-4 grid grid-cols-1 gap-[var(--density-sm)] sm:grid-cols-3">
          {DENSITY_OPTIONS.map((option) => (
            <DensityCard
              key={option.value}
              value={option.value}
              label={option.label}
              description={option.description}
              isSelected={settings.defaultDensity === option.value}
              onSelect={() => updateField('defaultDensity', option.value)}
            />
          ))}
        </div>
      </section>

      {/* ---- Default Theme ---- */}
      <section className="rounded-lg border border-border bg-card p-[var(--density-card-padding)]">
        <h2 className="text-[var(--text-lg)] font-semibold text-foreground">
          Default Theme
        </h2>
        <p className="mt-1 text-[var(--text-sm)] text-muted-foreground">
          The default appearance for all users. Each user can override this in their
          personal settings.
        </p>

        <div className="mt-4 flex flex-wrap gap-[var(--density-sm)]">
          {THEME_OPTIONS.map((option) => (
            <button
              key={option.value}
              type="button"
              onClick={() => updateField('defaultTheme', option.value)}
              className={`
                flex items-center gap-2 rounded-lg border px-4 py-2 text-[var(--text-sm)] font-medium transition-all
                ${settings.defaultTheme === option.value
                  ? 'border-primary bg-primary/10 text-foreground'
                  : 'border-border bg-card text-muted-foreground hover:border-primary/50'
                }
              `}
            >
              <ThemeIcon mode={option.value} />
              {option.label}
            </button>
          ))}
        </div>
      </section>

      {/* ---- Save ---- */}
      <div className="flex items-center gap-4">
        <button
          type="button"
          onClick={handleSave}
          disabled={isPending}
          className={`
            rounded-lg bg-primary px-6 py-2.5 text-[var(--text-sm)] font-semibold
            text-primary-foreground shadow-sm transition-all
            hover:opacity-90 disabled:opacity-50
          `}
        >
          {isPending ? 'Savingâ€¦' : 'Save Appearance'}
        </button>

        {saveStatus === 'saved' && (
          <span className="text-[var(--text-sm)] text-success animate-fade-in">
            Saved! Reloadingâ€¦
          </span>
        )}
        {saveStatus === 'error' && (
          <span className="text-[var(--text-sm)] text-destructive animate-fade-in">
            Failed to save. Please try again.
          </span>
        )}
      </div>
    </div>
  );
}

// ============================================================
// Sub-components
// ============================================================

function DensityCard({
  value,
  label,
  description,
  isSelected,
  onSelect,
}: {
  value: DensityMode;
  label: string;
  description: string;
  isSelected: boolean;
  onSelect: () => void;
}) {
  // Visual density preview: different sized bars
  const barSizes = {
    compact: ['h-1.5 w-12', 'h-1.5 w-8', 'h-1.5 w-10'],
    comfortable: ['h-2 w-14', 'h-2 w-10', 'h-2 w-12'],
    spacious: ['h-3 w-16', 'h-3 w-11', 'h-3 w-14'],
  };

  return (
    <button
      type="button"
      onClick={onSelect}
      className={`
        flex flex-col items-start gap-2 rounded-lg border p-[var(--density-card-padding)] text-left transition-all
        ${isSelected
          ? 'border-primary bg-primary/5 ring-1 ring-primary'
          : 'border-border bg-card hover:border-primary/50'
        }
      `}
    >
      {/* Visual preview */}
      <div className="flex flex-col gap-1">
        {barSizes[value].map((size, i) => (
          <div
            key={i}
            className={`${size} rounded-full ${isSelected ? 'bg-primary/40' : 'bg-muted-foreground/20'}`}
          />
        ))}
      </div>

      <div>
        <span className="block text-[var(--text-sm)] font-semibold text-foreground">
          {label}
        </span>
        <span className="block text-[var(--text-xs)] text-muted-foreground">
          {description}
        </span>
      </div>
    </button>
  );
}

function ThemeIcon({ mode }: { mode: ThemeMode }) {
  if (mode === 'light') {
    return (
      <svg className="h-4 w-4" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor">
        <path strokeLinecap="round" strokeLinejoin="round" d="M12 3v2.25m6.364.386-1.591 1.591M21 12h-2.25m-.386 6.364-1.591-1.591M12 18.75V21m-4.773-4.227-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0Z" />
      </svg>
    );
  }
  if (mode === 'dark') {
    return (
      <svg className="h-4 w-4" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor">
        <path strokeLinecap="round" strokeLinejoin="round" d="M21.752 15.002A9.72 9.72 0 0 1 18 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 0 0 3 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 0 0 9.002-5.998Z" />
      </svg>
    );
  }
  // system
  return (
    <svg className="h-4 w-4" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor">
      <path strokeLinecap="round" strokeLinejoin="round" d="M9 17.25v1.007a3 3 0 0 1-.879 2.122L7.5 21h9l-.621-.621A3 3 0 0 1 15 18.257V17.25m6-12V15a2.25 2.25 0 0 1-2.25 2.25H5.25A2.25 2.25 0 0 1 3 15V5.25m18 0A2.25 2.25 0 0 0 18.75 3H5.25A2.25 2.25 0 0 0 3 5.25m18 0V12a2.25 2.25 0 0 1-2.25 2.25H5.25A2.25 2.25 0 0 1 3 12V5.25" />
    </svg>
  );
}


===== D:\.code\wattleos\src\components\domain\admin\integration-dashboard-client.tsx =====

// src/components/domain/admin/integration-dashboard-client.tsx
//
// ============================================================
// WattleOS V2 - Integration Dashboard (Client Component)
// ============================================================
// Shows all available integrations as cards. Each card can be
// expanded to configure credentials, test connection, and view
// recent sync logs.
//
// Form fields are generated dynamically from the provider
// definitions in constants/integrations.ts - no hardcoded
// forms per provider.
// ============================================================

"use client";

import {
  deleteIntegrationConfig,
  listIntegrationConfigs,
  listSyncLogs,
  saveIntegrationConfig,
  testIntegrationConnection,
} from "@/lib/actions/integrations";
import type {
  CredentialField,
  IntegrationProvider,
  ProviderDefinition,
  SettingField,
} from "@/lib/constants/integrations";
import {
  INTEGRATION_PROVIDER_LIST,
  SYNC_STATUS_CONFIG,
} from "@/lib/constants/integrations";
import type { IntegrationConfig, IntegrationSyncLog } from "@/types/domain";
import { useState } from "react";

interface IntegrationDashboardClientProps {
  existingConfigs: IntegrationConfig[];
}

export function IntegrationDashboardClient({
  existingConfigs,
}: IntegrationDashboardClientProps) {
  const [configs, setConfigs] = useState(existingConfigs);
  const [expandedProvider, setExpandedProvider] =
    useState<IntegrationProvider | null>(null);
  const [syncLogs, setSyncLogs] = useState<IntegrationSyncLog[]>([]);
  const [showLogs, setShowLogs] = useState(false);

  function getConfig(
    provider: IntegrationProvider,
  ): IntegrationConfig | undefined {
    return configs.find((c) => c.provider === provider);
  }

  async function handleLoadLogs(provider: IntegrationProvider) {
    const result = await listSyncLogs({ provider, limit: 20 });
    setSyncLogs(result.data ?? []);
    setShowLogs(true);
  }

  async function handleRefreshConfigs() {
    const result = await listIntegrationConfigs();
    if (result.data) setConfigs(result.data);
  }

  return (
    <div className="space-y-4">
      {/* Provider cards */}
      {INTEGRATION_PROVIDER_LIST.map((provider) => {
        const config = getConfig(provider.key);
        const isExpanded = expandedProvider === provider.key;

        return (
          <div
            key={provider.key}
            className={`rounded-lg border bg-white shadow-sm transition-all ${
              config?.is_enabled ? "border-green-200" : "border-gray-200"
            }`}
          >
            {/* Card header */}
            <div className="flex items-center justify-between px-6 py-4">
              <div className="flex items-center gap-4">
                <span
                  className={`inline-flex h-10 w-10 items-center justify-center rounded-lg text-lg ${provider.bgColor}`}
                >
                  {provider.icon}
                </span>
                <div>
                  <div className="flex items-center gap-2">
                    <h3 className="text-sm font-semibold text-gray-900">
                      {provider.label}
                    </h3>
                    {config?.is_enabled && (
                      <span className="inline-flex items-center rounded-full bg-green-100 px-2 py-0.5 text-[10px] font-semibold text-green-700">
                        Connected
                      </span>
                    )}
                    {!provider.implemented && (
                      <span className="inline-flex items-center rounded-full bg-gray-100 px-2 py-0.5 text-[10px] font-medium text-gray-500">
                        Coming Soon
                      </span>
                    )}
                  </div>
                  <p className="mt-0.5 text-xs text-gray-500">
                    {provider.description}
                  </p>
                </div>
              </div>

              <div className="flex items-center gap-2">
                {config?.is_enabled && (
                  <button
                    onClick={() => handleLoadLogs(provider.key)}
                    className="rounded-md border border-gray-300 px-3 py-1.5 text-xs font-medium text-gray-700 hover:bg-gray-50 transition-colors"
                  >
                    Sync Logs
                  </button>
                )}
                <button
                  onClick={() =>
                    setExpandedProvider(isExpanded ? null : provider.key)
                  }
                  disabled={!provider.implemented}
                  className="rounded-md bg-amber-600 px-3 py-1.5 text-xs font-medium text-white hover:bg-amber-700 disabled:cursor-not-allowed disabled:opacity-50 transition-colors"
                >
                  {isExpanded ? "Close" : config ? "Configure" : "Set Up"}
                </button>
              </div>
            </div>

            {/* Expanded config form */}
            {isExpanded && (
              <div className="border-t border-gray-100 px-6 py-5">
                <IntegrationConfigForm
                  provider={provider}
                  existingConfig={config}
                  onSaved={() => {
                    handleRefreshConfigs();
                    setExpandedProvider(null);
                  }}
                  onDeleted={() => {
                    handleRefreshConfigs();
                    setExpandedProvider(null);
                  }}
                />
              </div>
            )}
          </div>
        );
      })}

      {/* Sync Logs Modal */}
      {showLogs && (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50">
          <div className="mx-4 max-h-[80vh] w-full max-w-2xl overflow-hidden rounded-lg bg-white shadow-xl">
            <div className="flex items-center justify-between border-b border-gray-200 px-6 py-4">
              <h3 className="text-lg font-semibold text-gray-900">Sync Logs</h3>
              <button
                onClick={() => setShowLogs(false)}
                className="rounded-md p-1 text-gray-400 hover:bg-gray-100 hover:text-gray-600"
              >
                <svg
                  className="h-5 w-5"
                  fill="none"
                  viewBox="0 0 24 24"
                  strokeWidth={1.5}
                  stroke="currentColor"
                >
                  <path
                    strokeLinecap="round"
                    strokeLinejoin="round"
                    d="M6 18 18 6M6 6l12 12"
                  />
                </svg>
              </button>
            </div>
            <div className="max-h-[60vh] overflow-y-auto px-6 py-4">
              {syncLogs.length === 0 ? (
                <p className="text-sm text-gray-500">No sync logs found.</p>
              ) : (
                <div className="space-y-3">
                  {syncLogs.map((log) => {
                    const statusConfig = SYNC_STATUS_CONFIG[log.status];
                    return (
                      <div
                        key={log.id}
                        className="rounded-lg border border-gray-100 p-3"
                      >
                        <div className="flex items-center justify-between">
                          <div className="flex items-center gap-2">
                            <span
                              className={`inline-flex items-center rounded-full px-2 py-0.5 text-[10px] font-semibold ${statusConfig.bgColor} ${statusConfig.color}`}
                            >
                              {statusConfig.label}
                            </span>
                            <span className="text-sm font-medium text-gray-900">
                              {log.operation}
                            </span>
                          </div>
                          <span className="text-xs text-gray-400">
                            {new Date(log.created_at).toLocaleString("en-AU")}
                          </span>
                        </div>
                        {log.entity_type && (
                          <p className="mt-1 text-xs text-gray-500">
                            {log.entity_type}{" "}
                            {log.entity_id
                              ? `(${log.entity_id.slice(0, 8)}...)`
                              : ""}
                          </p>
                        )}
                        {log.error_message && (
                          <p className="mt-1 rounded bg-red-50 p-2 text-xs text-red-700">
                            {log.error_message}
                          </p>
                        )}
                      </div>
                    );
                  })}
                </div>
              )}
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

// ============================================================
// CONFIG FORM - dynamically generated from provider definitions
// ============================================================

interface IntegrationConfigFormProps {
  provider: ProviderDefinition;
  existingConfig?: IntegrationConfig;
  onSaved: () => void;
  onDeleted: () => void;
}

function IntegrationConfigForm({
  provider,
  existingConfig,
  onSaved,
  onDeleted,
}: IntegrationConfigFormProps) {
  const existingCreds = (existingConfig?.credentials ?? {}) as Record<
    string,
    string
  >;
  const existingSettings = (existingConfig?.settings ?? {}) as Record<
    string,
    string | boolean
  >;

  const [credentials, setCredentials] = useState<Record<string, string>>(() => {
    const initial: Record<string, string> = {};
    for (const field of provider.credentialFields) {
      initial[field.key] = (existingCreds[field.key] as string) ?? "";
    }
    return initial;
  });

  const [settings, setSettings] = useState<Record<string, string | boolean>>(
    () => {
      const initial: Record<string, string | boolean> = {};
      for (const field of provider.settingFields) {
        initial[field.key] = existingSettings[field.key] ?? field.defaultValue;
      }
      return initial;
    },
  );

  const [isEnabled, setIsEnabled] = useState(
    existingConfig?.is_enabled ?? false,
  );
  const [isSaving, setIsSaving] = useState(false);
  const [isTesting, setIsTesting] = useState(false);
  const [testResult, setTestResult] = useState<{
    connected: boolean;
    message: string;
  } | null>(null);
  const [error, setError] = useState<string | null>(null);

  function updateCredential(key: string, value: string) {
    setCredentials((prev) => ({ ...prev, [key]: value }));
  }

  function updateSetting(key: string, value: string | boolean) {
    setSettings((prev) => ({ ...prev, [key]: value }));
  }

  async function handleSave() {
    setError(null);
    setIsSaving(true);

    // Validate required fields
    for (const field of provider.credentialFields) {
      if (field.required && !credentials[field.key]?.trim()) {
        setError(`${field.label} is required`);
        setIsSaving(false);
        return;
      }
    }

    const result = await saveIntegrationConfig({
      provider: provider.key,
      is_enabled: isEnabled,
      credentials,
      settings,
    });

    setIsSaving(false);

    if (result.error) {
      setError(result.error.message);
      return;
    }

    onSaved();
  }

  async function handleTest() {
    setTestResult(null);
    setIsTesting(true);

    // Save first so the test uses current credentials
    const saveResult = await saveIntegrationConfig({
      provider: provider.key,
      is_enabled: isEnabled,
      credentials,
      settings,
    });

    if (saveResult.error) {
      setTestResult({ connected: false, message: saveResult.error.message });
      setIsTesting(false);
      return;
    }

    const result = await testIntegrationConnection(provider.key);
    setIsTesting(false);

    if (result.data) {
      setTestResult(result.data);
    } else {
      setTestResult({
        connected: false,
        message: result.error?.message ?? "Test failed",
      });
    }
  }

  async function handleDelete() {
    if (
      !confirm(
        `Remove the ${provider.label} integration? This will delete all saved credentials.`,
      )
    ) {
      return;
    }

    const result = await deleteIntegrationConfig(provider.key);
    if (result.data) {
      onDeleted();
    }
  }

  return (
    <div className="space-y-5">
      {error && (
        <div className="rounded-md bg-red-50 p-3">
          <p className="text-sm text-red-700">{error}</p>
        </div>
      )}

      {testResult && (
        <div
          className={`rounded-md p-3 ${testResult.connected ? "bg-green-50" : "bg-red-50"}`}
        >
          <p
            className={`text-sm font-medium ${testResult.connected ? "text-green-700" : "text-red-700"}`}
          >
            {testResult.connected ? "âœ“ " : "âœ— "}
            {testResult.message}
          </p>
        </div>
      )}

      {/* Enable toggle */}
      <label className="flex items-center gap-3">
        <input
          type="checkbox"
          checked={isEnabled}
          onChange={(e) => setIsEnabled(e.target.checked)}
          className="h-4 w-4 rounded border-gray-300 text-amber-600 focus:ring-ring"
        />
        <span className="text-sm font-medium text-gray-700">
          Enable {provider.label} integration
        </span>
      </label>

      {/* Credential fields */}
      <div>
        <h4 className="text-sm font-semibold text-gray-900">Credentials</h4>
        <div className="mt-3 space-y-4">
          {provider.credentialFields.map((field) => (
            <CredentialInput
              key={field.key}
              field={field}
              value={credentials[field.key] ?? ""}
              onChange={(val) => updateCredential(field.key, val)}
            />
          ))}
        </div>
      </div>

      {/* Setting fields */}
      {provider.settingFields.length > 0 && (
        <div>
          <h4 className="text-sm font-semibold text-gray-900">Settings</h4>
          <div className="mt-3 space-y-4">
            {provider.settingFields.map((field) => (
              <SettingInput
                key={field.key}
                field={field}
                value={settings[field.key] ?? field.defaultValue}
                onChange={(val) => updateSetting(field.key, val)}
              />
            ))}
          </div>
        </div>
      )}

      {/* Actions */}
      <div className="flex items-center gap-3 border-t border-gray-100 pt-4">
        <button
          onClick={handleSave}
          disabled={isSaving}
          className="rounded-lg bg-amber-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-amber-700 disabled:opacity-50 transition-colors"
        >
          {isSaving ? "Saving..." : "Save Configuration"}
        </button>
        <button
          onClick={handleTest}
          disabled={isTesting}
          className="rounded-lg border border-gray-300 px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 disabled:opacity-50 transition-colors"
        >
          {isTesting ? "Testing..." : "Test Connection"}
        </button>
        {existingConfig && (
          <button
            onClick={handleDelete}
            className="ml-auto rounded-lg border border-red-300 px-4 py-2 text-sm font-medium text-red-700 hover:bg-red-50 transition-colors"
          >
            Remove Integration
          </button>
        )}
      </div>
    </div>
  );
}

// ============================================================
// FIELD RENDERERS
// ============================================================

function CredentialInput({
  field,
  value,
  onChange,
}: {
  field: CredentialField;
  value: string;
  onChange: (val: string) => void;
}) {
  const baseClasses =
    "mt-1 block w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-ring focus:outline-none focus:ring-1 focus:ring-ring";

  return (
    <div>
      <label className="block text-sm font-medium text-gray-700">
        {field.label}
        {field.required && <span className="ml-1 text-red-500">*</span>}
      </label>
      {field.type === "textarea" ? (
        <textarea
          value={value}
          onChange={(e) => onChange(e.target.value)}
          placeholder={field.placeholder}
          rows={4}
          className={`${baseClasses} font-mono text-xs`}
        />
      ) : (
        <input
          type={field.type}
          value={value}
          onChange={(e) => onChange(e.target.value)}
          placeholder={field.placeholder}
          className={baseClasses}
        />
      )}
      {field.helpText && (
        <p className="mt-1 text-xs text-gray-500">{field.helpText}</p>
      )}
    </div>
  );
}

function SettingInput({
  field,
  value,
  onChange,
}: {
  field: SettingField;
  value: string | boolean;
  onChange: (val: string | boolean) => void;
}) {
  if (field.type === "boolean") {
    return (
      <label className="flex items-center gap-3">
        <input
          type="checkbox"
          checked={!!value}
          onChange={(e) => onChange(e.target.checked)}
          className="h-4 w-4 rounded border-gray-300 text-amber-600 focus:ring-ring"
        />
        <div>
          <span className="text-sm font-medium text-gray-700">
            {field.label}
          </span>
          {field.helpText && (
            <p className="text-xs text-gray-500">{field.helpText}</p>
          )}
        </div>
      </label>
    );
  }

  return (
    <div>
      <label className="block text-sm font-medium text-gray-700">
        {field.label}
      </label>
      <input
        type="text"
        value={value as string}
        onChange={(e) => onChange(e.target.value)}
        className="mt-1 block w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-ring focus:outline-none focus:ring-1 focus:ring-ring"
      />
      {field.helpText && (
        <p className="mt-1 text-xs text-gray-500">{field.helpText}</p>
      )}
    </div>
  );
}



===== D:\.code\wattleos\src\components\domain\attendance\absence-report-client.tsx =====

// src/components/domain/attendance/absence-report-client.tsx
//
// ============================================================
// WattleOS V2 - Absence Report Client
// ============================================================
// Filterable list of absent/late records. Key features:
// - "Unexplained only" toggle (no notes = unexplained)
// - Class filter
// - Date range filter
// - Student links for follow-up
//
// WHY: Australian schools must follow up on unexplained
// absences. This surfaces the records that need action.
// ============================================================

"use client";

import type { AbsenceReportRow } from "@/lib/actions/attendance";
import { getAbsenceReport } from "@/lib/actions/attendance";
import { ATTENDANCE_STATUS_CONFIG } from "@/lib/constants/attendance";
import Link from "next/link";
import { useCallback, useEffect, useState } from "react";

// ============================================================
// Props
// ============================================================

interface ClassOption {
  id: string;
  name: string;
}

interface AbsenceReportClientProps {
  classes: ClassOption[];
}

// ============================================================
// Helpers
// ============================================================

function defaultRange(): { start: string; end: string } {
  const end = new Date();
  const start = new Date();
  start.setDate(start.getDate() - 6); // Last 7 days
  return {
    start: start.toISOString().split("T")[0],
    end: end.toISOString().split("T")[0],
  };
}

function formatDate(dateStr: string): string {
  const d = new Date(dateStr + "T00:00:00");
  return d.toLocaleDateString("en-AU", {
    weekday: "short",
    day: "numeric",
    month: "short",
  });
}

// ============================================================
// Component
// ============================================================

export function AbsenceReportClient({ classes }: AbsenceReportClientProps) {
  const defaults = defaultRange();
  const [classId, setClassId] = useState<string>("");
  const [startDate, setStartDate] = useState(defaults.start);
  const [endDate, setEndDate] = useState(defaults.end);
  const [unexplainedOnly, setUnexplainedOnly] = useState(true);
  const [rows, setRows] = useState<AbsenceReportRow[]>([]);
  const [loading, setLoading] = useState(false);

  const loadData = useCallback(async () => {
    setLoading(true);

    const result = await getAbsenceReport({
      classId: classId || undefined,
      startDate,
      endDate,
      unexplainedOnly,
    });

    if (result.data) {
      setRows(result.data);
    }
    setLoading(false);
  }, [classId, startDate, endDate, unexplainedOnly]);

  useEffect(() => {
    loadData();
  }, [loadData]);

  const unexplainedCount = rows.filter((r) => !r.hasExplanation).length;

  return (
    <div className="space-y-4">
      {/* Filters */}
      <div className="flex flex-wrap items-end gap-4 rounded-lg border border-gray-200 bg-white p-4">
        <div className="min-w-[180px]">
          <label className="block text-xs font-medium text-gray-700">
            Class
          </label>
          <select
            value={classId}
            onChange={(e) => setClassId(e.target.value)}
            className="mt-1 block w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-ring focus:outline-none focus:ring-1 focus:ring-ring"
          >
            <option value="">All classes</option>
            {classes.map((c) => (
              <option key={c.id} value={c.id}>
                {c.name}
              </option>
            ))}
          </select>
        </div>

        <div>
          <label className="block text-xs font-medium text-gray-700">
            From
          </label>
          <input
            type="date"
            value={startDate}
            onChange={(e) => setStartDate(e.target.value)}
            className="mt-1 block rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-ring focus:outline-none focus:ring-1 focus:ring-ring"
          />
        </div>

        <div>
          <label className="block text-xs font-medium text-gray-700">To</label>
          <input
            type="date"
            value={endDate}
            onChange={(e) => setEndDate(e.target.value)}
            className="mt-1 block rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-ring focus:outline-none focus:ring-1 focus:ring-ring"
          />
        </div>

        <label className="flex cursor-pointer items-center gap-2 rounded-lg border border-gray-200 px-3 py-2">
          <input
            type="checkbox"
            checked={unexplainedOnly}
            onChange={(e) => setUnexplainedOnly(e.target.checked)}
            className="h-4 w-4 rounded border-gray-300 text-amber-600 focus:ring-ring"
          />
          <span className="text-sm text-gray-700">Unexplained only</span>
        </label>
      </div>

      {/* Alert banner */}
      {unexplainedCount > 0 && unexplainedOnly && (
        <div className="flex items-center gap-3 rounded-lg border border-red-200 bg-red-50 px-4 py-3">
          <svg
            className="h-5 w-5 flex-shrink-0 text-red-500"
            fill="currentColor"
            viewBox="0 0 20 20"
          >
            <path
              fillRule="evenodd"
              d="M8.485 2.495c.673-1.167 2.357-1.167 3.03 0l6.28 10.875c.673 1.167-.17 2.625-1.516 2.625H3.72c-1.347 0-2.189-1.458-1.515-2.625L8.485 2.495ZM10 6a.75.75 0 0 1 .75.75v3.5a.75.75 0 0 1-1.5 0v-3.5A.75.75 0 0 1 10 6Zm0 9a1 1 0 1 0 0-2 1 1 0 0 0 0 2Z"
              clipRule="evenodd"
            />
          </svg>
          <p className="text-sm font-medium text-red-700">
            {unexplainedCount} unexplained absence
            {unexplainedCount !== 1 ? "s" : ""} require follow-up.
          </p>
        </div>
      )}

      {/* Loading */}
      {loading && (
        <div className="rounded-lg border border-gray-200 bg-white p-12 text-center">
          <div className="mx-auto h-8 w-8 animate-spin rounded-full border-2 border-gray-300 border-t-amber-600" />
        </div>
      )}

      {/* Results */}
      {!loading && rows.length === 0 && (
        <div className="rounded-lg border border-gray-200 bg-white p-12 text-center">
          <svg
            className="mx-auto h-10 w-10 text-green-400"
            fill="none"
            viewBox="0 0 24 24"
            strokeWidth={1.5}
            stroke="currentColor"
          >
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"
            />
          </svg>
          <p className="mt-3 text-sm font-medium text-gray-900">
            {unexplainedOnly ? "No unexplained absences" : "No absences found"}
          </p>
          <p className="mt-1 text-sm text-gray-500">
            {unexplainedOnly
              ? "All absences in this period have been explained."
              : "No absent or late records for this date range."}
          </p>
        </div>
      )}

      {!loading && rows.length > 0 && (
        <div className="overflow-hidden rounded-lg border border-gray-200 bg-white">
          <table className="min-w-full divide-y divide-gray-200">
            <thead className="bg-gray-50">
              <tr>
                <th className="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">
                  Student
                </th>
                <th className="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">
                  Date
                </th>
                <th className="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">
                  Status
                </th>
                <th className="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">
                  Notes
                </th>
              </tr>
            </thead>
            <tbody className="divide-y divide-gray-100">
              {rows.map((row, i) => {
                const displayName =
                  row.student.preferred_name ?? row.student.first_name;
                const config = ATTENDANCE_STATUS_CONFIG[row.status];

                return (
                  <tr
                    key={`${row.student.id}-${row.date}-${i}`}
                    className="hover:bg-gray-50"
                  >
                    <td className="whitespace-nowrap px-4 py-3">
                      <Link
                        href={`/students/${row.student.id}`}
                        className="flex items-center gap-2 text-sm font-medium text-gray-900 hover:text-amber-700"
                      >
                        <div className="flex h-7 w-7 flex-shrink-0 items-center justify-center rounded-full bg-gray-200 text-xs font-medium text-gray-600">
                          {row.student.photo_url ? (
                            <img
                              src={row.student.photo_url}
                              alt=""
                              className="h-7 w-7 rounded-full object-cover"
                            />
                          ) : (
                            displayName.charAt(0).toUpperCase()
                          )}
                        </div>
                        {displayName} {row.student.last_name}
                      </Link>
                    </td>
                    <td className="whitespace-nowrap px-4 py-3 text-sm text-gray-600">
                      {formatDate(row.date)}
                    </td>
                    <td className="px-4 py-3">
                      <span
                        className={`inline-flex rounded-full px-2.5 py-0.5 text-xs font-medium ${config.badgeBg} ${config.badgeText}`}
                      >
                        {config.label}
                      </span>
                    </td>
                    <td className="px-4 py-3">
                      {row.notes ? (
                        <span className="text-sm text-gray-600">
                          {row.notes}
                        </span>
                      ) : (
                        <span className="inline-flex items-center gap-1 text-xs font-medium text-red-600">
                          <svg
                            className="h-3 w-3"
                            fill="currentColor"
                            viewBox="0 0 20 20"
                          >
                            <path
                              fillRule="evenodd"
                              d="M18 10a8 8 0 1 1-16 0 8 8 0 0 1 16 0Zm-8-5a.75.75 0 0 1 .75.75v4.5a.75.75 0 0 1-1.5 0v-4.5A.75.75 0 0 1 10 5Zm0 10a1 1 0 1 0 0-2 1 1 0 0 0 0 2Z"
                              clipRule="evenodd"
                            />
                          </svg>
                          Unexplained
                        </span>
                      )}
                    </td>
                  </tr>
                );
              })}
            </tbody>
          </table>
        </div>
      )}
    </div>
  );
}



===== D:\.code\wattleos\src\components\domain\attendance\attendance-history-client.tsx =====

// src/components/domain/attendance/attendance-history-client.tsx
//
// ============================================================
// WattleOS V2 - Attendance History Client
// ============================================================
// Interactive attendance history view. Loads summary data for
// a class over a date range, then shows per-day breakdowns.
//
// WHY client component: Date range changes need instant
// re-fetching without full page reload.
// ============================================================

"use client";

import type { AttendanceDaySummary } from "@/lib/actions/attendance";
import { getAttendanceSummary } from "@/lib/actions/attendance";
import { ATTENDANCE_STATUS_CONFIG } from "@/lib/constants/attendance";
import { useCallback, useEffect, useState } from "react";

// ============================================================
// Props
// ============================================================

interface ClassOption {
  id: string;
  name: string;
  room: string | null;
  cycleLevel: string | null;
}

interface AttendanceHistoryClientProps {
  classes: ClassOption[];
}

// ============================================================
// Helpers
// ============================================================

function defaultDateRange(): { start: string; end: string } {
  const end = new Date();
  const start = new Date();
  start.setDate(start.getDate() - 13); // Last 2 weeks
  return {
    start: start.toISOString().split("T")[0],
    end: end.toISOString().split("T")[0],
  };
}

function formatDateShort(dateStr: string): string {
  const d = new Date(dateStr + "T00:00:00");
  return d.toLocaleDateString("en-AU", {
    weekday: "short",
    day: "numeric",
    month: "short",
  });
}

// ============================================================
// Component
// ============================================================

export function AttendanceHistoryClient({
  classes,
}: AttendanceHistoryClientProps) {
  const defaults = defaultDateRange();
  const [selectedClassId, setSelectedClassId] = useState<string>(
    classes.length === 1 ? classes[0].id : "",
  );
  const [startDate, setStartDate] = useState(defaults.start);
  const [endDate, setEndDate] = useState(defaults.end);
  const [summaries, setSummaries] = useState<AttendanceDaySummary[]>([]);
  const [loading, setLoading] = useState(false);

  const loadData = useCallback(async () => {
    if (!selectedClassId) return;
    setLoading(true);

    const result = await getAttendanceSummary({
      classId: selectedClassId,
      startDate,
      endDate,
    });

    if (result.data) {
      setSummaries(result.data);
    }
    setLoading(false);
  }, [selectedClassId, startDate, endDate]);

  useEffect(() => {
    loadData();
  }, [loadData]);

  // Aggregate totals
  const totals = summaries.reduce(
    (acc, s) => ({
      total: acc.total + s.total,
      present: acc.present + s.present,
      absent: acc.absent + s.absent,
      late: acc.late + s.late,
      excused: acc.excused + s.excused,
      half_day: acc.half_day + s.half_day,
    }),
    { total: 0, present: 0, absent: 0, late: 0, excused: 0, half_day: 0 },
  );

  const attendanceRate =
    totals.total > 0
      ? (
          ((totals.present + totals.late + totals.half_day) / totals.total) *
          100
        ).toFixed(1)
      : "0";

  return (
    <div className="space-y-4">
      {/* Filters */}
      <div className="flex flex-wrap items-end gap-4 rounded-lg border border-gray-200 bg-white p-4">
        <div className="min-w-[200px] flex-1">
          <label className="block text-xs font-medium text-gray-700">
            Class
          </label>
          <select
            value={selectedClassId}
            onChange={(e) => setSelectedClassId(e.target.value)}
            className="mt-1 block w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-ring focus:outline-none focus:ring-1 focus:ring-ring"
          >
            <option value="">Select a class...</option>
            {classes.map((c) => (
              <option key={c.id} value={c.id}>
                {c.name}
                {c.room ? ` - ${c.room}` : ""}
              </option>
            ))}
          </select>
        </div>

        <div>
          <label className="block text-xs font-medium text-gray-700">
            From
          </label>
          <input
            type="date"
            value={startDate}
            onChange={(e) => setStartDate(e.target.value)}
            className="mt-1 block rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-ring focus:outline-none focus:ring-1 focus:ring-ring"
          />
        </div>

        <div>
          <label className="block text-xs font-medium text-gray-700">To</label>
          <input
            type="date"
            value={endDate}
            onChange={(e) => setEndDate(e.target.value)}
            className="mt-1 block rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-ring focus:outline-none focus:ring-1 focus:ring-ring"
          />
        </div>
      </div>

      {/* No class selected */}
      {!selectedClassId && (
        <div className="rounded-lg border border-gray-200 bg-white p-12 text-center text-sm text-gray-500">
          Select a class to view attendance history.
        </div>
      )}

      {/* Loading */}
      {loading && (
        <div className="rounded-lg border border-gray-200 bg-white p-12 text-center">
          <div className="mx-auto h-8 w-8 animate-spin rounded-full border-2 border-gray-300 border-t-amber-600" />
        </div>
      )}

      {/* Results */}
      {selectedClassId && !loading && (
        <>
          {/* Summary cards */}
          {summaries.length > 0 && (
            <div className="grid grid-cols-2 gap-3 sm:grid-cols-4">
              <SummaryCard
                label="Attendance Rate"
                value={`${attendanceRate}%`}
                sublabel={`${summaries.length} school days`}
                color="green"
              />
              <SummaryCard
                label="Total Present"
                value={String(totals.present)}
                sublabel={`of ${totals.total} records`}
                color="green"
              />
              <SummaryCard
                label="Total Absent"
                value={String(totals.absent)}
                sublabel={totals.absent > 0 ? "Needs follow-up" : "None"}
                color="red"
              />
              <SummaryCard
                label="Total Late"
                value={String(totals.late)}
                sublabel=""
                color="amber"
              />
            </div>
          )}

          {/* Daily table */}
          {summaries.length === 0 ? (
            <div className="rounded-lg border border-gray-200 bg-white p-12 text-center text-sm text-gray-500">
              No attendance records found for this date range.
            </div>
          ) : (
            <div className="overflow-hidden rounded-lg border border-gray-200 bg-white">
              <table className="min-w-full divide-y divide-gray-200">
                <thead className="bg-gray-50">
                  <tr>
                    <th className="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">
                      Date
                    </th>
                    <th className="px-4 py-3 text-center text-xs font-medium uppercase tracking-wider text-gray-500">
                      Total
                    </th>
                    <th className="px-4 py-3 text-center text-xs font-medium uppercase tracking-wider text-green-600">
                      Present
                    </th>
                    <th className="px-4 py-3 text-center text-xs font-medium uppercase tracking-wider text-red-600">
                      Absent
                    </th>
                    <th className="px-4 py-3 text-center text-xs font-medium uppercase tracking-wider text-amber-600">
                      Late
                    </th>
                    <th className="px-4 py-3 text-center text-xs font-medium uppercase tracking-wider text-blue-600">
                      Excused
                    </th>
                    <th className="px-4 py-3 text-center text-xs font-medium uppercase tracking-wider text-purple-600">
                      Half Day
                    </th>
                    <th className="px-4 py-3 text-center text-xs font-medium uppercase tracking-wider text-gray-500">
                      Rate
                    </th>
                  </tr>
                </thead>
                <tbody className="divide-y divide-gray-100">
                  {summaries.map((day) => {
                    const rate =
                      day.total > 0
                        ? (
                            ((day.present + day.late + day.half_day) /
                              day.total) *
                            100
                          ).toFixed(0)
                        : "0";

                    return (
                      <tr key={day.date} className="hover:bg-gray-50">
                        <td className="whitespace-nowrap px-4 py-3 text-sm font-medium text-gray-900">
                          {formatDateShort(day.date)}
                        </td>
                        <td className="px-4 py-3 text-center text-sm text-gray-600">
                          {day.total}
                        </td>
                        <td className="px-4 py-3 text-center text-sm">
                          <StatusCell count={day.present} status="present" />
                        </td>
                        <td className="px-4 py-3 text-center text-sm">
                          <StatusCell count={day.absent} status="absent" />
                        </td>
                        <td className="px-4 py-3 text-center text-sm">
                          <StatusCell count={day.late} status="late" />
                        </td>
                        <td className="px-4 py-3 text-center text-sm">
                          <StatusCell count={day.excused} status="excused" />
                        </td>
                        <td className="px-4 py-3 text-center text-sm">
                          <StatusCell count={day.half_day} status="half_day" />
                        </td>
                        <td className="px-4 py-3 text-center text-sm font-medium text-gray-900">
                          {rate}%
                        </td>
                      </tr>
                    );
                  })}
                </tbody>
              </table>
            </div>
          )}
        </>
      )}
    </div>
  );
}

// ============================================================
// Sub-components
// ============================================================

function StatusCell({
  count,
  status,
}: {
  count: number;
  status: keyof typeof ATTENDANCE_STATUS_CONFIG;
}) {
  if (count === 0) {
    return <span className="text-gray-300">â€”</span>;
  }

  const config = ATTENDANCE_STATUS_CONFIG[status];
  return (
    <span
      className={`inline-flex rounded-full px-2 py-0.5 text-xs font-semibold ${config.badgeBg} ${config.badgeText}`}
    >
      {count}
    </span>
  );
}

interface SummaryCardProps {
  label: string;
  value: string;
  sublabel: string;
  color: "green" | "red" | "amber" | "blue";
}

const CARD_COLORS: Record<SummaryCardProps["color"], string> = {
  green: "border-green-200 bg-green-50",
  red: "border-red-200 bg-red-50",
  amber: "border-amber-200 bg-amber-50",
  blue: "border-blue-200 bg-blue-50",
};

const CARD_TEXT_COLORS: Record<SummaryCardProps["color"], string> = {
  green: "text-green-700",
  red: "text-red-700",
  amber: "text-amber-700",
  blue: "text-blue-700",
};

function SummaryCard({ label, value, sublabel, color }: SummaryCardProps) {
  return (
    <div className={`rounded-lg border p-4 ${CARD_COLORS[color]}`}>
      <p className="text-xs font-medium text-gray-600">{label}</p>
      <p className={`mt-1 text-2xl font-bold ${CARD_TEXT_COLORS[color]}`}>
        {value}
      </p>
      {sublabel && <p className="mt-0.5 text-xs text-gray-500">{sublabel}</p>}
    </div>
  );
}



===== D:\.code\wattleos\src\components\domain\attendance\pickup-authorization-section.tsx =====

// src/components/domain/attendance/pickup-authorization-section.tsx
//
// ============================================================
// WattleOS V2 - Pickup Authorization Section
// ============================================================
// Client component embedded in the student detail page.
// Manages who is authorized to pick up this student.
//
// WHY client component: Inline add/edit form with state
// management. The student detail page is a server component,
// so this section is a client island.
// ============================================================

"use client";

import {
  createPickupAuthorization,
  deletePickupAuthorization,
  listPickupAuthorizations,
} from "@/lib/actions/pickup-authorizations";
import type { PickupAuthorization } from "@/types/domain";
import { useEffect, useState, useTransition } from "react";

interface PickupAuthorizationSectionProps {
  studentId: string;
}

export function PickupAuthorizationSection({
  studentId,
}: PickupAuthorizationSectionProps) {
  const [authorizations, setAuthorizations] = useState<PickupAuthorization[]>(
    [],
  );
  const [loading, setLoading] = useState(true);
  const [showForm, setShowForm] = useState(false);
  const [isPending, startTransition] = useTransition();

  // Form state
  const [formName, setFormName] = useState("");
  const [formRelationship, setFormRelationship] = useState("");
  const [formPhone, setFormPhone] = useState("");
  const [formIsPermanent, setFormIsPermanent] = useState(true);
  const [formValidFrom, setFormValidFrom] = useState("");
  const [formValidUntil, setFormValidUntil] = useState("");
  const [formError, setFormError] = useState<string | null>(null);

  // Load authorizations
  useEffect(() => {
    async function load() {
      setLoading(true);
      const result = await listPickupAuthorizations(studentId);
      if (result.data) {
        setAuthorizations(result.data);
      }
      setLoading(false);
    }
    load();
  }, [studentId]);

  // Reset form
  function resetForm() {
    setFormName("");
    setFormRelationship("");
    setFormPhone("");
    setFormIsPermanent(true);
    setFormValidFrom("");
    setFormValidUntil("");
    setFormError(null);
    setShowForm(false);
  }

  // Create
  async function handleCreate() {
    if (!formName.trim()) {
      setFormError("Name is required.");
      return;
    }

    setFormError(null);

    startTransition(async () => {
      const result = await createPickupAuthorization({
        studentId,
        authorizedName: formName.trim(),
        relationship: formRelationship.trim() || undefined,
        phone: formPhone.trim() || undefined,
        isPermanent: formIsPermanent,
        validFrom: formIsPermanent ? undefined : formValidFrom || undefined,
        validUntil: formIsPermanent ? undefined : formValidUntil || undefined,
      });

      if (result.error) {
        setFormError(result.error.message);
        return;
      }

      if (result.data) {
        setAuthorizations((prev) => [...prev, result.data!]);
        resetForm();
      }
    });
  }

  // Delete
  async function handleDelete(id: string, name: string) {
    if (!confirm(`Remove ${name} from pickup authorizations?`)) return;

    startTransition(async () => {
      const result = await deletePickupAuthorization(id);
      if (result.data?.success) {
        setAuthorizations((prev) => prev.filter((a) => a.id !== id));
      }
    });
  }

  // Check if authorization is currently valid
  function isValid(auth: PickupAuthorization): boolean {
    if (auth.is_permanent) return true;
    const now = new Date().toISOString().split("T")[0];
    if (auth.valid_from && now < auth.valid_from) return false;
    if (auth.valid_until && now > auth.valid_until) return false;
    return true;
  }

  return (
    <section className="rounded-lg border border-gray-200 bg-white shadow-sm">
      <div className="flex items-center justify-between border-b border-gray-200 px-6 py-4">
        <h2 className="text-lg font-medium text-gray-900">
          Pickup Authorizations
        </h2>
        {!showForm && (
          <button
            onClick={() => setShowForm(true)}
            className="rounded-md bg-amber-600 px-3 py-1.5 text-xs font-medium text-white hover:bg-amber-700"
          >
            Add Person
          </button>
        )}
      </div>

      <div className="px-6 py-4">
        {/* Loading */}
        {loading && (
          <div className="flex items-center justify-center py-4">
            <div className="h-5 w-5 animate-spin rounded-full border-2 border-gray-300 border-t-amber-600" />
          </div>
        )}

        {/* Empty state */}
        {!loading && authorizations.length === 0 && !showForm && (
          <p className="text-sm text-gray-500">
            No pickup authorizations. Guardians with pickup permission are shown
            in the Guardians section above.
          </p>
        )}

        {/* List */}
        {!loading && authorizations.length > 0 && (
          <div className="space-y-3">
            {authorizations.map((auth) => {
              const valid = isValid(auth);
              return (
                <div
                  key={auth.id}
                  className={`flex items-center justify-between rounded-md border p-3 ${
                    valid ? "border-gray-100" : "border-gray-100 opacity-60"
                  }`}
                >
                  <div>
                    <div className="flex items-center gap-2">
                      <p className="text-sm font-medium text-gray-900">
                        {auth.authorized_name}
                      </p>
                      {auth.is_permanent ? (
                        <span className="rounded bg-green-50 px-1.5 py-0.5 text-[10px] font-medium text-green-700">
                          Permanent
                        </span>
                      ) : (
                        <span className="rounded bg-amber-50 px-1.5 py-0.5 text-[10px] font-medium text-amber-700">
                          Temporary
                        </span>
                      )}
                      {!valid && (
                        <span className="rounded bg-gray-100 px-1.5 py-0.5 text-[10px] font-medium text-gray-500">
                          Expired
                        </span>
                      )}
                    </div>
                    <p className="mt-0.5 text-xs text-gray-500">
                      {auth.relationship && `${auth.relationship}`}
                      {auth.relationship && auth.phone && " Â· "}
                      {auth.phone && auth.phone}
                    </p>
                    {!auth.is_permanent &&
                      (auth.valid_from || auth.valid_until) && (
                        <p className="mt-0.5 text-xs text-gray-400">
                          {auth.valid_from && `From ${auth.valid_from}`}
                          {auth.valid_from && auth.valid_until && " "}
                          {auth.valid_until && `Until ${auth.valid_until}`}
                        </p>
                      )}
                  </div>
                  <button
                    onClick={() => handleDelete(auth.id, auth.authorized_name)}
                    disabled={isPending}
                    className="flex-shrink-0 text-xs font-medium text-red-500 hover:text-red-700 disabled:opacity-50"
                  >
                    Remove
                  </button>
                </div>
              );
            })}
          </div>
        )}

        {/* Add form */}
        {showForm && (
          <div className="mt-3 space-y-3 rounded-lg border border-amber-200 bg-amber-50/50 p-4">
            <h3 className="text-sm font-medium text-gray-900">
              Add Authorized Person
            </h3>

            {formError && <p className="text-xs text-red-600">{formError}</p>}

            <div className="grid grid-cols-1 gap-3 sm:grid-cols-2">
              <div>
                <label className="block text-xs font-medium text-gray-700">
                  Full Name *
                </label>
                <input
                  type="text"
                  value={formName}
                  onChange={(e) => setFormName(e.target.value)}
                  placeholder="e.g., Sarah Johnson"
                  className="mt-1 block w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-ring focus:outline-none focus:ring-1 focus:ring-ring"
                />
              </div>

              <div>
                <label className="block text-xs font-medium text-gray-700">
                  Relationship
                </label>
                <input
                  type="text"
                  value={formRelationship}
                  onChange={(e) => setFormRelationship(e.target.value)}
                  placeholder="e.g., Grandmother, Nanny"
                  className="mt-1 block w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-ring focus:outline-none focus:ring-1 focus:ring-ring"
                />
              </div>

              <div>
                <label className="block text-xs font-medium text-gray-700">
                  Phone
                </label>
                <input
                  type="tel"
                  value={formPhone}
                  onChange={(e) => setFormPhone(e.target.value)}
                  placeholder="e.g., 0412 345 678"
                  className="mt-1 block w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-ring focus:outline-none focus:ring-1 focus:ring-ring"
                />
              </div>

              <div>
                <label className="flex items-center gap-2 text-xs font-medium text-gray-700">
                  <input
                    type="checkbox"
                    checked={formIsPermanent}
                    onChange={(e) => setFormIsPermanent(e.target.checked)}
                    className="h-4 w-4 rounded border-gray-300 text-amber-600 focus:ring-ring"
                  />
                  Permanent authorization
                </label>
                <p className="mt-1 text-xs text-gray-500">
                  {formIsPermanent
                    ? "Can pick up any time."
                    : "Set a date range below."}
                </p>
              </div>
            </div>

            {/* Date range for temporary auth */}
            {!formIsPermanent && (
              <div className="grid grid-cols-2 gap-3">
                <div>
                  <label className="block text-xs font-medium text-gray-700">
                    Valid From
                  </label>
                  <input
                    type="date"
                    value={formValidFrom}
                    onChange={(e) => setFormValidFrom(e.target.value)}
                    className="mt-1 block w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-ring focus:outline-none focus:ring-1 focus:ring-ring"
                  />
                </div>
                <div>
                  <label className="block text-xs font-medium text-gray-700">
                    Valid Until
                  </label>
                  <input
                    type="date"
                    value={formValidUntil}
                    onChange={(e) => setFormValidUntil(e.target.value)}
                    className="mt-1 block w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-ring focus:outline-none focus:ring-1 focus:ring-ring"
                  />
                </div>
              </div>
            )}

            <div className="flex gap-2 pt-1">
              <button
                onClick={handleCreate}
                disabled={isPending}
                className="rounded-lg bg-amber-600 px-4 py-2 text-sm font-medium text-white hover:bg-amber-700 disabled:opacity-50"
              >
                {isPending ? "Adding..." : "Add"}
              </button>
              <button
                onClick={resetForm}
                disabled={isPending}
                className="rounded-lg border border-gray-300 px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 disabled:opacity-50"
              >
                Cancel
              </button>
            </div>
          </div>
        )}
      </div>
    </section>
  );
}



===== D:\.code\wattleos\src\components\domain\attendance\roll-call-client.tsx =====

// src/components/domain/attendance/roll-call-client.tsx
//
// ============================================================
// WattleOS V2 - Roll Call Client Component
// ============================================================
// The primary daily attendance workflow. A guide:
// 1. Selects their class (auto-selects if only one)
// 2. Sees today's date (can change)
// 3. Taps each student's status (Present / Absent / Late / Excused / Half Day)
// 4. Sees summary bar update in real-time
// 5. Taps "Save Roll" to persist
//
// Design priorities:
// - Thumb-friendly on iPad (large tap targets)
// - Medical alerts visible (âš  badges on student rows)
// - Quick: "Mark All Present" button for good days
// - Optimistic: each tap saves immediately via markAttendance
//
// WHY optimistic single-save (not bulk-only): Guides get
// interrupted constantly. If they mark 15 students present
// then a child falls over, the 15 are already saved.
// The "Save Roll" button is a confirmation + marks any
// remaining unmarked students as absent.
// ============================================================

"use client";

import type { StudentAttendanceRow } from "@/lib/actions/attendance";
import {
  bulkMarkAttendance,
  getClassAttendance,
  markAttendance,
} from "@/lib/actions/attendance";
import {
  ATTENDANCE_STATUS_CONFIG,
  type AttendanceStatusValue,
} from "@/lib/constants/attendance";
import type { AttendanceStatus } from "@/types/domain";
import { useCallback, useEffect, useState, useTransition } from "react";

// ============================================================
// Props
// ============================================================

interface ClassOption {
  id: string;
  name: string;
  room: string | null;
  cycleLevel: string | null;
}

interface RollCallClientProps {
  classes: ClassOption[];
}

// ============================================================
// Helpers
// ============================================================

function todayDateString(): string {
  const d = new Date();
  return d.toISOString().split("T")[0];
}

function formatDateDisplay(dateStr: string): string {
  const d = new Date(dateStr + "T00:00:00");
  return d.toLocaleDateString("en-AU", {
    weekday: "long",
    day: "numeric",
    month: "long",
    year: "numeric",
  });
}

// ============================================================
// Component
// ============================================================

export function RollCallClient({ classes }: RollCallClientProps) {
  const [selectedClassId, setSelectedClassId] = useState<string>(
    classes.length === 1 ? classes[0].id : "",
  );
  const [date, setDate] = useState<string>(todayDateString());
  const [rows, setRows] = useState<StudentAttendanceRow[]>([]);
  const [localStatuses, setLocalStatuses] = useState<
    Record<string, AttendanceStatusValue>
  >({});
  const [localNotes, setLocalNotes] = useState<Record<string, string>>({});
  const [loading, setLoading] = useState(false);
  const [saving, setSaving] = useState<Record<string, boolean>>({});
  const [saveAllPending, startSaveAll] = useTransition();
  const [successMessage, setSuccessMessage] = useState<string | null>(null);

  // ----------------------------------------------------------
  // Load class attendance when class or date changes
  // ----------------------------------------------------------
  const loadAttendance = useCallback(async () => {
    if (!selectedClassId) return;
    setLoading(true);
    setSuccessMessage(null);

    const result = await getClassAttendance(selectedClassId, date);

    if (result.data) {
      setRows(result.data);
      // Initialize local statuses from existing records
      const statuses: Record<string, AttendanceStatusValue> = {};
      const notes: Record<string, string> = {};
      for (const row of result.data) {
        if (row.record) {
          statuses[row.student.id] = row.record.status as AttendanceStatusValue;
          notes[row.student.id] = row.record.notes ?? "";
        }
      }
      setLocalStatuses(statuses);
      setLocalNotes(notes);
    }

    setLoading(false);
  }, [selectedClassId, date]);

  useEffect(() => {
    loadAttendance();
  }, [loadAttendance]);

  // ----------------------------------------------------------
  // Mark single student (optimistic save)
  // ----------------------------------------------------------
  async function handleMark(studentId: string, status: AttendanceStatusValue) {
    // Toggle: if already this status, clear it
    const current = localStatuses[studentId];
    if (current === status) {
      setLocalStatuses((prev) => {
        const next = { ...prev };
        delete next[studentId];
        return next;
      });
      return;
    }

    // Optimistic update
    setLocalStatuses((prev) => ({ ...prev, [studentId]: status }));
    setSaving((prev) => ({ ...prev, [studentId]: true }));

    await markAttendance({
      studentId,
      classId: selectedClassId,
      date,
      status,
      notes: localNotes[studentId] || null,
    });

    setSaving((prev) => ({ ...prev, [studentId]: false }));
  }

  // ----------------------------------------------------------
  // Mark All Present
  // ----------------------------------------------------------
  function handleMarkAllPresent() {
    const newStatuses: Record<string, AttendanceStatusValue> = {
      ...localStatuses,
    };
    for (const row of rows) {
      if (!newStatuses[row.student.id]) {
        newStatuses[row.student.id] = "present";
      }
    }
    setLocalStatuses(newStatuses);

    // Save all in bulk
    startSaveAll(async () => {
      const records = rows
        .filter(
          (r) =>
            !localStatuses[r.student.id] ||
            localStatuses[r.student.id] !== newStatuses[r.student.id],
        )
        .map((r) => ({
          studentId: r.student.id,
          status: newStatuses[r.student.id] as AttendanceStatus,
          notes: localNotes[r.student.id] || null,
        }));

      if (records.length > 0) {
        await bulkMarkAttendance({
          classId: selectedClassId,
          date,
          records,
        });
      }

      setSuccessMessage("All students marked present.");
      setTimeout(() => setSuccessMessage(null), 3000);
    });
  }

  // ----------------------------------------------------------
  // Save entire roll (marks unmarked as absent)
  // ----------------------------------------------------------
  function handleSaveRoll() {
    startSaveAll(async () => {
      const records = rows.map((r) => ({
        studentId: r.student.id,
        status: (localStatuses[r.student.id] ?? "absent") as AttendanceStatus,
        notes: localNotes[r.student.id] || null,
      }));

      const result = await bulkMarkAttendance({
        classId: selectedClassId,
        date,
        records,
      });

      if (result.data) {
        setSuccessMessage(
          `Roll saved - ${result.data.marked} students recorded.`,
        );
        // Refresh to get updated records
        await loadAttendance();
        setTimeout(() => setSuccessMessage(null), 3000);
      }
    });
  }

  // ----------------------------------------------------------
  // Summary stats
  // ----------------------------------------------------------
  const totalStudents = rows.length;
  const marked = Object.keys(localStatuses).length;
  const unmarked = totalStudents - marked;
  const presentCount = Object.values(localStatuses).filter(
    (s) => s === "present",
  ).length;
  const absentCount = Object.values(localStatuses).filter(
    (s) => s === "absent",
  ).length;
  const lateCount = Object.values(localStatuses).filter(
    (s) => s === "late",
  ).length;

  // ----------------------------------------------------------
  // Render
  // ----------------------------------------------------------
  return (
    <div className="space-y-4">
      {/* Controls bar */}
      <div className="flex flex-wrap items-end gap-4 rounded-lg border border-gray-200 bg-white p-4">
        {/* Class selector */}
        <div className="min-w-[200px] flex-1">
          <label className="block text-xs font-medium text-gray-700">
            Class
          </label>
          <select
            value={selectedClassId}
            onChange={(e) => setSelectedClassId(e.target.value)}
            className="mt-1 block w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-ring focus:outline-none focus:ring-1 focus:ring-ring"
          >
            <option value="">Select a class...</option>
            {classes.map((c) => (
              <option key={c.id} value={c.id}>
                {c.name}
                {c.room ? ` - ${c.room}` : ""}
                {c.cycleLevel ? ` (${c.cycleLevel})` : ""}
              </option>
            ))}
          </select>
        </div>

        {/* Date picker */}
        <div>
          <label className="block text-xs font-medium text-gray-700">
            Date
          </label>
          <input
            type="date"
            value={date}
            onChange={(e) => setDate(e.target.value)}
            className="mt-1 block rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-ring focus:outline-none focus:ring-1 focus:ring-ring"
          />
        </div>

        {/* Quick actions */}
        {selectedClassId && rows.length > 0 && (
          <div className="flex gap-2">
            <button
              onClick={handleMarkAllPresent}
              disabled={saveAllPending}
              className="rounded-lg bg-green-600 px-3 py-2 text-sm font-medium text-white transition-colors hover:bg-green-700 disabled:opacity-50"
            >
              Mark All Present
            </button>
          </div>
        )}
      </div>

      {/* Date display */}
      {selectedClassId && (
        <p className="text-sm font-medium text-gray-600">
          {formatDateDisplay(date)}
        </p>
      )}

      {/* Success message */}
      {successMessage && (
        <div className="rounded-lg bg-green-50 px-4 py-3 text-sm font-medium text-green-700">
          {successMessage}
        </div>
      )}

      {/* Loading state */}
      {loading && (
        <div className="rounded-lg border border-gray-200 bg-white p-12 text-center">
          <div className="mx-auto h-8 w-8 animate-spin rounded-full border-2 border-gray-300 border-t-amber-600" />
          <p className="mt-3 text-sm text-gray-500">Loading students...</p>
        </div>
      )}

      {/* No class selected */}
      {!selectedClassId && !loading && (
        <div className="rounded-lg border border-gray-200 bg-white p-12 text-center">
          <p className="text-sm text-gray-500">
            Select a class to begin the roll call.
          </p>
        </div>
      )}

      {/* Empty class */}
      {selectedClassId && !loading && rows.length === 0 && (
        <div className="rounded-lg border border-gray-200 bg-white p-12 text-center">
          <p className="text-sm font-medium text-gray-900">
            No students enrolled
          </p>
          <p className="mt-1 text-sm text-gray-500">
            This class has no active enrollments.
          </p>
        </div>
      )}

      {/* Student list */}
      {selectedClassId && !loading && rows.length > 0 && (
        <>
          {/* Summary bar */}
          <div className="flex flex-wrap gap-3 rounded-lg border border-gray-200 bg-white px-4 py-3">
            <SummaryPill label="Total" count={totalStudents} color="gray" />
            <SummaryPill label="Present" count={presentCount} color="green" />
            <SummaryPill label="Absent" count={absentCount} color="red" />
            <SummaryPill label="Late" count={lateCount} color="amber" />
            {unmarked > 0 && (
              <SummaryPill label="Unmarked" count={unmarked} color="gray" />
            )}
          </div>

          {/* Student rows */}
          <div className="divide-y divide-gray-100 rounded-lg border border-gray-200 bg-white">
            {rows.map((row) => (
              <StudentRow
                key={row.student.id}
                row={row}
                currentStatus={localStatuses[row.student.id] ?? null}
                notes={localNotes[row.student.id] ?? ""}
                isSaving={saving[row.student.id] ?? false}
                onMark={(status) => handleMark(row.student.id, status)}
                onNotesChange={(notes) =>
                  setLocalNotes((prev) => ({
                    ...prev,
                    [row.student.id]: notes,
                  }))
                }
              />
            ))}
          </div>

          {/* Save button */}
          <div className="flex items-center justify-between rounded-lg border border-gray-200 bg-white px-4 py-3">
            <p className="text-sm text-gray-500">
              {unmarked > 0
                ? `${unmarked} student${unmarked !== 1 ? "s" : ""} unmarked - they'll be recorded as absent.`
                : "All students marked."}
            </p>
            <button
              onClick={handleSaveRoll}
              disabled={saveAllPending}
              className="rounded-lg bg-amber-600 px-5 py-2.5 text-sm font-medium text-white shadow-sm transition-colors hover:bg-amber-700 disabled:opacity-50"
            >
              {saveAllPending ? "Saving..." : "Save Roll"}
            </button>
          </div>
        </>
      )}
    </div>
  );
}

// ============================================================
// Student Row
// ============================================================

interface StudentRowProps {
  row: StudentAttendanceRow;
  currentStatus: AttendanceStatusValue | null;
  notes: string;
  isSaving: boolean;
  onMark: (status: AttendanceStatusValue) => void;
  onNotesChange: (notes: string) => void;
}

const STATUS_ORDER: AttendanceStatusValue[] = [
  "present",
  "absent",
  "late",
  "excused",
  "half_day",
];

function StudentRow({
  row,
  currentStatus,
  notes,
  isSaving,
  onMark,
  onNotesChange,
}: StudentRowProps) {
  const [showNotes, setShowNotes] = useState(false);
  const displayName = row.student.preferred_name ?? row.student.first_name;

  return (
    <div className="px-4 py-3">
      <div className="flex items-center gap-3">
        {/* Avatar */}
        <div className="flex h-10 w-10 flex-shrink-0 items-center justify-center rounded-full bg-gray-200 text-sm font-medium text-gray-600">
          {row.student.photo_url ? (
            <img
              src={row.student.photo_url}
              alt=""
              className="h-10 w-10 rounded-full object-cover"
            />
          ) : (
            displayName.charAt(0).toUpperCase()
          )}
        </div>

        {/* Name + medical alerts */}
        <div className="min-w-0 flex-1">
          <div className="flex items-center gap-2">
            <p className="truncate text-sm font-medium text-gray-900">
              {displayName} {row.student.last_name}
            </p>
            {isSaving && (
              <div className="h-3 w-3 animate-spin rounded-full border border-gray-300 border-t-amber-600" />
            )}
          </div>

          {/* Medical alerts */}
          {row.medicalAlerts.length > 0 && (
            <div className="mt-0.5 flex flex-wrap gap-1">
              {row.medicalAlerts.map((alert, i) => (
                <span
                  key={i}
                  className={`inline-flex items-center gap-0.5 rounded px-1.5 py-0.5 text-[10px] font-semibold ${
                    alert.severity === "life_threatening"
                      ? "bg-red-100 text-red-800"
                      : "bg-orange-100 text-orange-800"
                  }`}
                >
                  <svg
                    className="h-2.5 w-2.5"
                    fill="currentColor"
                    viewBox="0 0 20 20"
                  >
                    <path
                      fillRule="evenodd"
                      d="M8.485 2.495c.673-1.167 2.357-1.167 3.03 0l6.28 10.875c.673 1.167-.17 2.625-1.516 2.625H3.72c-1.347 0-2.189-1.458-1.515-2.625L8.485 2.495ZM10 6a.75.75 0 0 1 .75.75v3.5a.75.75 0 0 1-1.5 0v-3.5A.75.75 0 0 1 10 6Zm0 9a1 1 0 1 0 0-2 1 1 0 0 0 0 2Z"
                      clipRule="evenodd"
                    />
                  </svg>
                  {alert.condition_name}
                </span>
              ))}
            </div>
          )}
        </div>

        {/* Status buttons */}
        <div className="flex flex-shrink-0 gap-1.5">
          {STATUS_ORDER.map((status) => {
            const config = ATTENDANCE_STATUS_CONFIG[status];
            const isActive = currentStatus === status;

            return (
              <button
                key={status}
                onClick={() => onMark(status)}
                title={config.label}
                className={`flex h-9 w-9 items-center justify-center rounded-lg text-sm font-medium transition-all sm:h-auto sm:w-auto sm:px-2.5 sm:py-1.5 ${
                  isActive
                    ? `${config.buttonBg} text-white shadow-sm`
                    : "border border-gray-200 bg-white text-gray-500 hover:border-gray-300 hover:bg-gray-50"
                }`}
              >
                {/* Icon on mobile, label on desktop */}
                <span className="sm:hidden">{config.icon}</span>
                <span className="hidden text-xs sm:inline">{config.label}</span>
              </button>
            );
          })}

          {/* Notes toggle */}
          <button
            onClick={() => setShowNotes(!showNotes)}
            title="Add note"
            className={`flex h-9 w-9 items-center justify-center rounded-lg text-sm transition-colors sm:h-auto sm:w-auto sm:px-2 sm:py-1.5 ${
              notes
                ? "bg-blue-100 text-blue-600"
                : "border border-gray-200 bg-white text-gray-400 hover:border-gray-300 hover:text-gray-600"
            }`}
          >
            <svg
              className="h-4 w-4"
              fill="none"
              viewBox="0 0 24 24"
              strokeWidth={1.5}
              stroke="currentColor"
            >
              <path
                strokeLinecap="round"
                strokeLinejoin="round"
                d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10"
              />
            </svg>
          </button>
        </div>
      </div>

      {/* Notes input (collapsible) */}
      {showNotes && (
        <div className="ml-[52px] mt-2">
          <input
            type="text"
            value={notes}
            onChange={(e) => onNotesChange(e.target.value)}
            placeholder="Add a note (e.g., 'Left early at 2pm')"
            className="block w-full rounded-lg border border-gray-200 px-3 py-1.5 text-sm text-gray-700 placeholder:text-gray-400 focus:border-ring focus:outline-none focus:ring-1 focus:ring-ring"
          />
        </div>
      )}
    </div>
  );
}

// ============================================================
// Summary Pill
// ============================================================

interface SummaryPillProps {
  label: string;
  count: number;
  color: "gray" | "green" | "red" | "amber" | "blue" | "purple";
}

const PILL_COLORS: Record<SummaryPillProps["color"], string> = {
  gray: "bg-gray-100 text-gray-700",
  green: "bg-green-100 text-green-700",
  red: "bg-red-100 text-red-700",
  amber: "bg-amber-100 text-amber-700",
  blue: "bg-blue-100 text-blue-700",
  purple: "bg-purple-100 text-purple-700",
};

function SummaryPill({ label, count, color }: SummaryPillProps) {
  return (
    <div
      className={`inline-flex items-center gap-1.5 rounded-full px-3 py-1 text-xs font-medium ${PILL_COLORS[color]}`}
    >
      <span>{label}</span>
      <span className="font-bold">{count}</span>
    </div>
  );
}



===== D:\.code\wattleos\src\components\domain\billing\billing-dashboard-client.tsx =====

// src/components/domain/billing/billing-dashboard-client.tsx
//
// ============================================================
// WattleOS V2 - Billing Dashboard (Client Component)
// ============================================================
// Two tabs: Invoices and Fee Schedules.
//
// Invoices tab: List + create form + Stripe sync/send actions.
// Fee Schedules tab: List + create form for tuition pricing.
// ============================================================

"use client";

import {
  createFeeSchedule,
  createInvoice,
  listFeeSchedules,
  listInvoices,
  sendStripeInvoice,
  syncInvoiceToStripe,
  updateFeeSchedule,
  voidInvoice,
} from "@/lib/actions/billing";
import type { FeeFrequency, InvoiceStatus } from "@/lib/constants/billing";
import {
  FEE_FREQUENCY_CONFIG,
  formatCurrency,
  INVOICE_STATUS_CONFIG,
} from "@/lib/constants/billing";
import type { FeeSchedule, InvoiceWithDetails } from "@/types/domain";
import { useState } from "react";

// ============================================================
// Props
// ============================================================

interface StudentWithGuardians {
  id: string;
  first_name: string;
  last_name: string;
  guardians: Array<{
    id: string;
    relationship: string;
    user_id: string;
    user: {
      id: string;
      first_name: string | null;
      last_name: string | null;
      email: string;
    };
  }>;
}

interface ClassOption {
  id: string;
  name: string;
  cycle_level: string | null;
}

interface BillingDashboardClientProps {
  invoices: InvoiceWithDetails[];
  feeSchedules: FeeSchedule[];
  students: StudentWithGuardians[];
  classes: ClassOption[];
  currency: string;
}

// ============================================================
// COMPONENT
// ============================================================

export function BillingDashboardClient({
  invoices: initialInvoices,
  feeSchedules: initialFeeSchedules,
  students,
  classes,
  currency,
}: BillingDashboardClientProps) {
  const [activeTab, setActiveTab] = useState<"invoices" | "fees">("invoices");
  const [invoices, setInvoices] = useState(initialInvoices);
  const [feeSchedules, setFeeSchedules] = useState(initialFeeSchedules);
  const [showCreateInvoice, setShowCreateInvoice] = useState(false);
  const [showCreateFee, setShowCreateFee] = useState(false);

  async function refreshInvoices() {
    const result = await listInvoices();
    if (result.data) setInvoices(result.data);
  }

  async function refreshFees() {
    const result = await listFeeSchedules();
    if (result.data) setFeeSchedules(result.data);
  }

  // Summary stats
  const totalOutstanding = invoices
    .filter((i) => ["sent", "pending", "overdue"].includes(i.status))
    .reduce((sum, i) => sum + (i.total_cents - i.amount_paid_cents), 0);

  const totalPaid = invoices
    .filter((i) => i.status === "paid")
    .reduce((sum, i) => sum + i.amount_paid_cents, 0);

  const overdueCount = invoices.filter((i) => i.status === "overdue").length;

  const tabs = [
    { key: "invoices" as const, label: "Invoices", count: invoices.length },
    {
      key: "fees" as const,
      label: "Fee Schedules",
      count: feeSchedules.filter((f) => f.is_active).length,
    },
  ];

  return (
    <div className="space-y-6">
      {/* Summary cards */}
      <div className="grid grid-cols-1 gap-4 sm:grid-cols-3">
        <div className="rounded-lg border border-gray-200 bg-white p-4">
          <p className="text-xs font-medium text-gray-500">Outstanding</p>
          <p className="mt-1 text-xl font-bold text-amber-700">
            {formatCurrency(totalOutstanding, currency)}
          </p>
        </div>
        <div className="rounded-lg border border-gray-200 bg-white p-4">
          <p className="text-xs font-medium text-gray-500">Collected</p>
          <p className="mt-1 text-xl font-bold text-green-700">
            {formatCurrency(totalPaid, currency)}
          </p>
        </div>
        <div className="rounded-lg border border-gray-200 bg-white p-4">
          <p className="text-xs font-medium text-gray-500">Overdue</p>
          <p className="mt-1 text-xl font-bold text-red-700">{overdueCount}</p>
        </div>
      </div>

      {/* Tabs */}
      <div className="flex items-center justify-between border-b border-gray-200">
        <div className="flex gap-6">
          {tabs.map((tab) => (
            <button
              key={tab.key}
              onClick={() => setActiveTab(tab.key)}
              className={`border-b-2 pb-3 text-sm font-medium transition-colors ${
                activeTab === tab.key
                  ? "border-amber-600 text-amber-700"
                  : "border-transparent text-gray-500 hover:text-gray-700"
              }`}
            >
              {tab.label}
              <span className="ml-1.5 rounded-full bg-gray-100 px-2 py-0.5 text-xs text-gray-600">
                {tab.count}
              </span>
            </button>
          ))}
        </div>
        <button
          onClick={() =>
            activeTab === "invoices"
              ? setShowCreateInvoice(true)
              : setShowCreateFee(true)
          }
          className="rounded-lg bg-amber-600 px-4 py-2 text-sm font-medium text-white hover:bg-amber-700 transition-colors"
        >
          {activeTab === "invoices" ? "New Invoice" : "New Fee Schedule"}
        </button>
      </div>

      {/* Invoices tab */}
      {activeTab === "invoices" && (
        <div className="space-y-3">
          {showCreateInvoice && (
            <CreateInvoiceForm
              students={students}
              feeSchedules={feeSchedules.filter((f) => f.is_active)}
              currency={currency}
              onCreated={() => {
                setShowCreateInvoice(false);
                refreshInvoices();
              }}
              onCancel={() => setShowCreateInvoice(false)}
            />
          )}

          {invoices.length === 0 ? (
            <div className="rounded-lg border border-dashed border-gray-300 bg-gray-50 py-12 text-center">
              <p className="text-sm text-gray-500">
                No invoices yet. Create one to get started.
              </p>
            </div>
          ) : (
            <div className="overflow-hidden rounded-lg border border-gray-200 bg-white">
              <table className="min-w-full divide-y divide-gray-200">
                <thead className="bg-gray-50">
                  <tr>
                    <th className="px-4 py-3 text-left text-xs font-medium text-gray-500">
                      Invoice
                    </th>
                    <th className="px-4 py-3 text-left text-xs font-medium text-gray-500">
                      Student
                    </th>
                    <th className="px-4 py-3 text-left text-xs font-medium text-gray-500">
                      Guardian
                    </th>
                    <th className="px-4 py-3 text-left text-xs font-medium text-gray-500">
                      Amount
                    </th>
                    <th className="px-4 py-3 text-left text-xs font-medium text-gray-500">
                      Due
                    </th>
                    <th className="px-4 py-3 text-left text-xs font-medium text-gray-500">
                      Status
                    </th>
                    <th className="px-4 py-3 text-right text-xs font-medium text-gray-500">
                      Actions
                    </th>
                  </tr>
                </thead>
                <tbody className="divide-y divide-gray-100">
                  {invoices.map((inv) => (
                    <InvoiceRow
                      key={inv.id}
                      invoice={inv}
                      currency={currency}
                      onRefresh={refreshInvoices}
                    />
                  ))}
                </tbody>
              </table>
            </div>
          )}
        </div>
      )}

      {/* Fee Schedules tab */}
      {activeTab === "fees" && (
        <div className="space-y-3">
          {showCreateFee && (
            <CreateFeeForm
              classes={classes}
              currency={currency}
              onCreated={() => {
                setShowCreateFee(false);
                refreshFees();
              }}
              onCancel={() => setShowCreateFee(false)}
            />
          )}

          {feeSchedules.length === 0 ? (
            <div className="rounded-lg border border-dashed border-gray-300 bg-gray-50 py-12 text-center">
              <p className="text-sm text-gray-500">
                No fee schedules defined. Create one to set tuition pricing.
              </p>
            </div>
          ) : (
            <div className="grid grid-cols-1 gap-3 sm:grid-cols-2 lg:grid-cols-3">
              {feeSchedules.map((fee) => (
                <FeeScheduleCard
                  key={fee.id}
                  fee={fee}
                  currency={currency}
                  onUpdated={refreshFees}
                />
              ))}
            </div>
          )}
        </div>
      )}
    </div>
  );
}

// ============================================================
// INVOICE ROW
// ============================================================

function InvoiceRow({
  invoice,
  currency,
  onRefresh,
}: {
  invoice: InvoiceWithDetails;
  currency: string;
  onRefresh: () => void;
}) {
  const [acting, setActing] = useState(false);
  const statusConfig =
    INVOICE_STATUS_CONFIG[invoice.status as InvoiceStatus] ??
    INVOICE_STATUS_CONFIG.draft;

  const studentName = invoice.student
    ? `${invoice.student.first_name} ${invoice.student.last_name}`
    : "Unknown";

  const guardianName = invoice.guardian?.user
    ? `${invoice.guardian.user.first_name ?? ""} ${invoice.guardian.user.last_name ?? ""}`.trim() ||
      invoice.guardian.user.email
    : "Unknown";

  async function handleAction(action: "sync" | "send" | "void") {
    setActing(true);
    if (action === "sync") await syncInvoiceToStripe(invoice.id);
    else if (action === "send") await sendStripeInvoice(invoice.id);
    else if (action === "void") {
      if (!confirm("Void this invoice? This cannot be undone.")) {
        setActing(false);
        return;
      }
      await voidInvoice(invoice.id);
    }
    setActing(false);
    onRefresh();
  }

  return (
    <tr className="hover:bg-gray-50">
      <td className="px-4 py-3">
        <p className="text-sm font-medium text-gray-900">
          {invoice.invoice_number}
        </p>
        <p className="text-xs text-gray-500">
          {invoice.line_items.length} item
          {invoice.line_items.length !== 1 ? "s" : ""}
        </p>
      </td>
      <td className="px-4 py-3 text-sm text-gray-700">{studentName}</td>
      <td className="px-4 py-3 text-sm text-gray-700">{guardianName}</td>
      <td className="px-4 py-3 text-sm font-medium text-gray-900">
        {formatCurrency(invoice.total_cents, currency)}
      </td>
      <td className="px-4 py-3 text-sm text-gray-700">
        {new Date(invoice.due_date).toLocaleDateString("en-AU")}
      </td>
      <td className="px-4 py-3">
        <span
          className={`inline-flex items-center rounded-full px-2 py-0.5 text-[10px] font-semibold ${statusConfig.bgColor} ${statusConfig.color}`}
        >
          {statusConfig.label}
        </span>
      </td>
      <td className="px-4 py-3 text-right">
        <div className="flex items-center justify-end gap-1">
          {invoice.status === "draft" && !invoice.stripe_invoice_id && (
            <button
              onClick={() => handleAction("sync")}
              disabled={acting}
              className="rounded px-2 py-1 text-xs font-medium text-blue-700 hover:bg-blue-50 disabled:opacity-50"
            >
              Sync to Stripe
            </button>
          )}
          {invoice.status === "pending" && invoice.stripe_invoice_id && (
            <button
              onClick={() => handleAction("send")}
              disabled={acting}
              className="rounded px-2 py-1 text-xs font-medium text-green-700 hover:bg-green-50 disabled:opacity-50"
            >
              Send
            </button>
          )}
          {invoice.stripe_hosted_url && (
            <a
              href={invoice.stripe_hosted_url}
              target="_blank"
              rel="noopener noreferrer"
              className="rounded px-2 py-1 text-xs font-medium text-gray-600 hover:bg-gray-100"
            >
              View
            </a>
          )}
          {!["paid", "void", "refunded"].includes(invoice.status) && (
            <button
              onClick={() => handleAction("void")}
              disabled={acting}
              className="rounded px-2 py-1 text-xs font-medium text-red-600 hover:bg-red-50 disabled:opacity-50"
            >
              Void
            </button>
          )}
        </div>
      </td>
    </tr>
  );
}

// ============================================================
// CREATE INVOICE FORM
// ============================================================

function CreateInvoiceForm({
  students,
  feeSchedules,
  currency,
  onCreated,
  onCancel,
}: {
  students: StudentWithGuardians[];
  feeSchedules: FeeSchedule[];
  currency: string;
  onCreated: () => void;
  onCancel: () => void;
}) {
  const [selectedStudentId, setSelectedStudentId] = useState("");
  const [selectedGuardianId, setSelectedGuardianId] = useState("");
  const [dueDate, setDueDate] = useState("");
  const [periodStart, setPeriodStart] = useState("");
  const [periodEnd, setPeriodEnd] = useState("");
  const [notes, setNotes] = useState("");
  const [lineItems, setLineItems] = useState<
    Array<{
      description: string;
      quantity: number;
      unit_amount_cents: number;
      fee_schedule_id: string;
    }>
  >([
    { description: "", quantity: 1, unit_amount_cents: 0, fee_schedule_id: "" },
  ]);
  const [isSaving, setIsSaving] = useState(false);
  const [error, setError] = useState<string | null>(null);

  const selectedStudent = students.find((s) => s.id === selectedStudentId);
  const guardians = selectedStudent?.guardians ?? [];

  function addLineItem() {
    setLineItems((prev) => [
      ...prev,
      {
        description: "",
        quantity: 1,
        unit_amount_cents: 0,
        fee_schedule_id: "",
      },
    ]);
  }

  function removeLineItem(index: number) {
    setLineItems((prev) => prev.filter((_, i) => i !== index));
  }

  function updateLineItem(
    index: number,
    field: string,
    value: string | number,
  ) {
    setLineItems((prev) =>
      prev.map((item, i) => {
        if (i !== index) return item;
        const updated = { ...item, [field]: value };

        // If fee schedule selected, auto-fill description + amount
        if (field === "fee_schedule_id" && value) {
          const fee = feeSchedules.find((f) => f.id === value);
          if (fee) {
            updated.description = fee.description || fee.name;
            updated.unit_amount_cents = fee.amount_cents;
          }
        }
        return updated;
      }),
    );
  }

  const total = lineItems.reduce(
    (sum, li) => sum + li.quantity * li.unit_amount_cents,
    0,
  );

  async function handleSubmit() {
    setError(null);
    if (!selectedStudentId) {
      setError("Select a student");
      return;
    }
    if (!selectedGuardianId) {
      setError("Select a guardian");
      return;
    }
    if (!dueDate) {
      setError("Set a due date");
      return;
    }
    if (lineItems.some((li) => !li.description.trim())) {
      setError("All line items need a description");
      return;
    }
    if (lineItems.some((li) => li.unit_amount_cents <= 0)) {
      setError("All line items need a positive amount");
      return;
    }

    setIsSaving(true);
    const result = await createInvoice({
      student_id: selectedStudentId,
      guardian_id: selectedGuardianId,
      due_date: dueDate,
      period_start: periodStart || undefined,
      period_end: periodEnd || undefined,
      notes: notes || undefined,
      line_items: lineItems.map((li) => ({
        fee_schedule_id: li.fee_schedule_id || undefined,
        description: li.description,
        quantity: li.quantity,
        unit_amount_cents: li.unit_amount_cents,
      })),
    });
    setIsSaving(false);

    if (result.error) {
      setError(result.error.message);
      return;
    }
    onCreated();
  }

  return (
    <div className="rounded-lg border border-amber-200 bg-amber-50/50 p-5">
      <h3 className="text-sm font-semibold text-gray-900">Create Invoice</h3>

      {error && (
        <div className="mt-3 rounded-md bg-red-50 p-3">
          <p className="text-sm text-red-700">{error}</p>
        </div>
      )}

      <div className="mt-4 grid grid-cols-1 gap-4 sm:grid-cols-2">
        {/* Student */}
        <div>
          <label className="block text-xs font-medium text-gray-700">
            Student *
          </label>
          <select
            value={selectedStudentId}
            onChange={(e) => {
              setSelectedStudentId(e.target.value);
              setSelectedGuardianId("");
            }}
            className="mt-1 block w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-ring focus:outline-none focus:ring-1 focus:ring-ring"
          >
            <option value="">Select student...</option>
            {students.map((s) => (
              <option key={s.id} value={s.id}>
                {s.first_name} {s.last_name}
              </option>
            ))}
          </select>
        </div>

        {/* Guardian */}
        <div>
          <label className="block text-xs font-medium text-gray-700">
            Bill to (Guardian) *
          </label>
          <select
            value={selectedGuardianId}
            onChange={(e) => setSelectedGuardianId(e.target.value)}
            disabled={!selectedStudentId}
            className="mt-1 block w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-ring focus:outline-none focus:ring-1 focus:ring-ring disabled:opacity-50"
          >
            <option value="">Select guardian...</option>
            {guardians.map((g) => (
              <option key={g.id} value={g.id}>
                {g.user.first_name} {g.user.last_name} ({g.relationship}) -{" "}
                {g.user.email}
              </option>
            ))}
          </select>
        </div>

        {/* Due date */}
        <div>
          <label className="block text-xs font-medium text-gray-700">
            Due Date *
          </label>
          <input
            type="date"
            value={dueDate}
            onChange={(e) => setDueDate(e.target.value)}
            className="mt-1 block w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-ring focus:outline-none focus:ring-1 focus:ring-ring"
          />
        </div>

        {/* Period */}
        <div className="flex gap-2">
          <div className="flex-1">
            <label className="block text-xs font-medium text-gray-700">
              Period Start
            </label>
            <input
              type="date"
              value={periodStart}
              onChange={(e) => setPeriodStart(e.target.value)}
              className="mt-1 block w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-ring focus:outline-none focus:ring-1 focus:ring-ring"
            />
          </div>
          <div className="flex-1">
            <label className="block text-xs font-medium text-gray-700">
              Period End
            </label>
            <input
              type="date"
              value={periodEnd}
              onChange={(e) => setPeriodEnd(e.target.value)}
              className="mt-1 block w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-ring focus:outline-none focus:ring-1 focus:ring-ring"
            />
          </div>
        </div>
      </div>

      {/* Line items */}
      <div className="mt-5">
        <div className="flex items-center justify-between">
          <h4 className="text-xs font-semibold text-gray-700">Line Items</h4>
          <button
            onClick={addLineItem}
            className="text-xs font-medium text-amber-700 hover:text-amber-800"
          >
            + Add line
          </button>
        </div>
        <div className="mt-2 space-y-2">
          {lineItems.map((li, idx) => (
            <div key={idx} className="flex items-end gap-2">
              <div className="flex-1">
                {idx === 0 && (
                  <label className="block text-[10px] font-medium text-gray-500">
                    Fee Schedule (optional)
                  </label>
                )}
                <select
                  value={li.fee_schedule_id}
                  onChange={(e) =>
                    updateLineItem(idx, "fee_schedule_id", e.target.value)
                  }
                  className="block w-full rounded-md border border-gray-300 px-2 py-1.5 text-xs focus:border-ring focus:outline-none"
                >
                  <option value="">Manual entry</option>
                  {feeSchedules.map((f) => (
                    <option key={f.id} value={f.id}>
                      {f.name} - {formatCurrency(f.amount_cents, currency)}
                    </option>
                  ))}
                </select>
              </div>
              <div className="flex-[2]">
                {idx === 0 && (
                  <label className="block text-[10px] font-medium text-gray-500">
                    Description
                  </label>
                )}
                <input
                  type="text"
                  value={li.description}
                  onChange={(e) =>
                    updateLineItem(idx, "description", e.target.value)
                  }
                  placeholder="Tuition - Term 1 2026"
                  className="block w-full rounded-md border border-gray-300 px-2 py-1.5 text-xs focus:border-ring focus:outline-none"
                />
              </div>
              <div className="w-16">
                {idx === 0 && (
                  <label className="block text-[10px] font-medium text-gray-500">
                    Qty
                  </label>
                )}
                <input
                  type="number"
                  min={1}
                  value={li.quantity}
                  onChange={(e) =>
                    updateLineItem(
                      idx,
                      "quantity",
                      parseInt(e.target.value) || 1,
                    )
                  }
                  className="block w-full rounded-md border border-gray-300 px-2 py-1.5 text-xs focus:border-ring focus:outline-none"
                />
              </div>
              <div className="w-28">
                {idx === 0 && (
                  <label className="block text-[10px] font-medium text-gray-500">
                    Amount ($)
                  </label>
                )}
                <input
                  type="number"
                  min={0}
                  step={0.01}
                  value={(li.unit_amount_cents / 100).toFixed(2)}
                  onChange={(e) =>
                    updateLineItem(
                      idx,
                      "unit_amount_cents",
                      Math.round(parseFloat(e.target.value || "0") * 100),
                    )
                  }
                  className="block w-full rounded-md border border-gray-300 px-2 py-1.5 text-xs font-mono focus:border-ring focus:outline-none"
                />
              </div>
              <div className="w-24 text-right">
                {idx === 0 && (
                  <label className="block text-[10px] font-medium text-gray-500">
                    Subtotal
                  </label>
                )}
                <span className="inline-block py-1.5 text-xs font-medium text-gray-700">
                  {formatCurrency(li.quantity * li.unit_amount_cents, currency)}
                </span>
              </div>
              {lineItems.length > 1 && (
                <button
                  onClick={() => removeLineItem(idx)}
                  className="rounded p-1 text-gray-400 hover:bg-gray-100 hover:text-red-600"
                >
                  <svg
                    className="h-4 w-4"
                    fill="none"
                    viewBox="0 0 24 24"
                    strokeWidth={1.5}
                    stroke="currentColor"
                  >
                    <path
                      strokeLinecap="round"
                      strokeLinejoin="round"
                      d="M6 18 18 6M6 6l12 12"
                    />
                  </svg>
                </button>
              )}
            </div>
          ))}
        </div>
        <div className="mt-3 flex justify-end border-t border-gray-200 pt-3">
          <p className="text-sm font-semibold text-gray-900">
            Total: {formatCurrency(total, currency)}
          </p>
        </div>
      </div>

      {/* Notes */}
      <div className="mt-4">
        <label className="block text-xs font-medium text-gray-700">
          Notes (optional)
        </label>
        <textarea
          value={notes}
          onChange={(e) => setNotes(e.target.value)}
          rows={2}
          placeholder="Internal notes about this invoice..."
          className="mt-1 block w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-ring focus:outline-none focus:ring-1 focus:ring-ring"
        />
      </div>

      {/* Actions */}
      <div className="mt-4 flex items-center gap-3">
        <button
          onClick={handleSubmit}
          disabled={isSaving}
          className="rounded-lg bg-amber-600 px-4 py-2 text-sm font-medium text-white hover:bg-amber-700 disabled:opacity-50 transition-colors"
        >
          {isSaving ? "Creating..." : "Create Invoice"}
        </button>
        <button
          onClick={onCancel}
          className="rounded-lg border border-gray-300 px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 transition-colors"
        >
          Cancel
        </button>
      </div>
    </div>
  );
}

// ============================================================
// CREATE FEE SCHEDULE FORM
// ============================================================

function CreateFeeForm({
  classes,
  currency,
  onCreated,
  onCancel,
}: {
  classes: ClassOption[];
  currency: string;
  onCreated: () => void;
  onCancel: () => void;
}) {
  const [name, setName] = useState("");
  const [classId, setClassId] = useState("");
  const [amountDollars, setAmountDollars] = useState("");
  const [frequency, setFrequency] = useState("termly");
  const [description, setDescription] = useState("");
  const [isSaving, setIsSaving] = useState(false);
  const [error, setError] = useState<string | null>(null);

  const frequencies: FeeFrequency[] = [
    "weekly",
    "fortnightly",
    "monthly",
    "termly",
    "annually",
    "one_off",
  ];

  async function handleSubmit() {
    setError(null);
    if (!name.trim()) {
      setError("Name is required");
      return;
    }
    const cents = Math.round(parseFloat(amountDollars || "0") * 100);
    if (cents <= 0) {
      setError("Amount must be greater than zero");
      return;
    }

    setIsSaving(true);
    const result = await createFeeSchedule({
      name: name.trim(),
      class_id: classId || null,
      amount_cents: cents,
      currency,
      frequency,
      description: description.trim() || undefined,
    });
    setIsSaving(false);

    if (result.error) {
      setError(result.error.message);
      return;
    }
    onCreated();
  }

  return (
    <div className="rounded-lg border border-amber-200 bg-amber-50/50 p-5">
      <h3 className="text-sm font-semibold text-gray-900">
        Create Fee Schedule
      </h3>

      {error && (
        <div className="mt-3 rounded-md bg-red-50 p-3">
          <p className="text-sm text-red-700">{error}</p>
        </div>
      )}

      <div className="mt-4 grid grid-cols-1 gap-4 sm:grid-cols-2">
        <div>
          <label className="block text-xs font-medium text-gray-700">
            Name *
          </label>
          <input
            type="text"
            value={name}
            onChange={(e) => setName(e.target.value)}
            placeholder="3-6 Primary Tuition - 2026"
            className="mt-1 block w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-ring focus:outline-none focus:ring-1 focus:ring-ring"
          />
        </div>
        <div>
          <label className="block text-xs font-medium text-gray-700">
            Class (optional)
          </label>
          <select
            value={classId}
            onChange={(e) => setClassId(e.target.value)}
            className="mt-1 block w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-ring focus:outline-none focus:ring-1 focus:ring-ring"
          >
            <option value="">School-wide (all classes)</option>
            {classes.map((c) => (
              <option key={c.id} value={c.id}>
                {c.name} {c.cycle_level ? `(${c.cycle_level})` : ""}
              </option>
            ))}
          </select>
        </div>
        <div>
          <label className="block text-xs font-medium text-gray-700">
            Amount ($) *
          </label>
          <input
            type="number"
            min={0}
            step={0.01}
            value={amountDollars}
            onChange={(e) => setAmountDollars(e.target.value)}
            placeholder="2500.00"
            className="mt-1 block w-full rounded-lg border border-gray-300 px-3 py-2 text-sm font-mono focus:border-ring focus:outline-none focus:ring-1 focus:ring-ring"
          />
        </div>
        <div>
          <label className="block text-xs font-medium text-gray-700">
            Frequency *
          </label>
          <select
            value={frequency}
            onChange={(e) => setFrequency(e.target.value)}
            className="mt-1 block w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-ring focus:outline-none focus:ring-1 focus:ring-ring"
          >
            {frequencies.map((f) => (
              <option key={f} value={f}>
                {FEE_FREQUENCY_CONFIG[f].label}
              </option>
            ))}
          </select>
        </div>
      </div>

      <div className="mt-4">
        <label className="block text-xs font-medium text-gray-700">
          Description (appears on invoices)
        </label>
        <input
          type="text"
          value={description}
          onChange={(e) => setDescription(e.target.value)}
          placeholder="Tuition fee for 3-6 Primary program, Term 1 2026"
          className="mt-1 block w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-ring focus:outline-none focus:ring-1 focus:ring-ring"
        />
      </div>

      <div className="mt-4 flex items-center gap-3">
        <button
          onClick={handleSubmit}
          disabled={isSaving}
          className="rounded-lg bg-amber-600 px-4 py-2 text-sm font-medium text-white hover:bg-amber-700 disabled:opacity-50 transition-colors"
        >
          {isSaving ? "Creating..." : "Create Fee Schedule"}
        </button>
        <button
          onClick={onCancel}
          className="rounded-lg border border-gray-300 px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 transition-colors"
        >
          Cancel
        </button>
      </div>
    </div>
  );
}

// ============================================================
// FEE SCHEDULE CARD
// ============================================================

function FeeScheduleCard({
  fee,
  currency,
  onUpdated,
}: {
  fee: FeeSchedule;
  currency: string;
  onUpdated: () => void;
}) {
  const [toggling, setToggling] = useState(false);
  const freqConfig = FEE_FREQUENCY_CONFIG[fee.frequency as FeeFrequency] ?? {
    label: fee.frequency,
    shortLabel: "",
  };

  async function handleToggleActive() {
    setToggling(true);
    await updateFeeSchedule(fee.id, { is_active: !fee.is_active });
    setToggling(false);
    onUpdated();
  }

  return (
    <div
      className={`rounded-lg border bg-white p-4 shadow-sm ${fee.is_active ? "border-gray-200" : "border-gray-100 opacity-60"}`}
    >
      <div className="flex items-start justify-between">
        <div>
          <h4 className="text-sm font-semibold text-gray-900">{fee.name}</h4>
          {fee.description && (
            <p className="mt-0.5 text-xs text-gray-500">{fee.description}</p>
          )}
        </div>
        <span
          className={`inline-flex items-center rounded-full px-2 py-0.5 text-[10px] font-semibold ${fee.is_active ? "bg-green-100 text-green-700" : "bg-gray-100 text-gray-500"}`}
        >
          {fee.is_active ? "Active" : "Inactive"}
        </span>
      </div>
      <div className="mt-3 flex items-baseline gap-1">
        <span className="text-lg font-bold text-gray-900">
          {formatCurrency(fee.amount_cents, currency)}
        </span>
        <span className="text-xs text-gray-500">{freqConfig.shortLabel}</span>
      </div>
      <p className="mt-1 text-xs text-gray-500">{freqConfig.label}</p>
      <div className="mt-3 border-t border-gray-100 pt-3">
        <button
          onClick={handleToggleActive}
          disabled={toggling}
          className="text-xs font-medium text-gray-600 hover:text-gray-900 disabled:opacity-50"
        >
          {fee.is_active ? "Deactivate" : "Reactivate"}
        </button>
      </div>
    </div>
  );
}



===== D:\.code\wattleos\src\components\domain\billing\parent-billing-client.tsx =====

// src/components/domain/billing/parent-billing-client.tsx
//
// ============================================================
// WattleOS V2 - Parent Billing View (Client Component)
// ============================================================
// Read-only invoice list. Parents can:
// â€¢ See all their invoices (excluding drafts)
// â€¢ Click through to Stripe hosted page to pay
// â€¢ See payment status and history
// ============================================================

'use client';

import { useState } from 'react';
import { INVOICE_STATUS_CONFIG, formatCurrency } from '@/lib/constants/billing';
import type { InvoiceStatus } from '@/lib/constants/billing';
import type { InvoiceWithDetails } from '@/types/domain';

interface ParentBillingClientProps {
  invoices: InvoiceWithDetails[];
}

export function ParentBillingClient({ invoices }: ParentBillingClientProps) {
  const [expandedId, setExpandedId] = useState<string | null>(null);

  const outstanding = invoices.filter((i) =>
    ['sent', 'pending', 'overdue'].includes(i.status)
  );
  const paid = invoices.filter((i) => i.status === 'paid');
  const other = invoices.filter((i) =>
    !['sent', 'pending', 'overdue', 'paid'].includes(i.status)
  );

  if (invoices.length === 0) {
    return (
      <div className="rounded-lg border border-dashed border-gray-300 bg-gray-50 py-12 text-center">
        <p className="text-sm text-gray-500">No invoices yet.</p>
      </div>
    );
  }

  return (
    <div className="space-y-6">
      {/* Outstanding */}
      {outstanding.length > 0 && (
        <section>
          <h2 className="mb-3 text-sm font-semibold text-gray-900">
            Outstanding ({outstanding.length})
          </h2>
          <div className="space-y-3">
            {outstanding.map((inv) => (
              <InvoiceCard
                key={inv.id}
                invoice={inv}
                expanded={expandedId === inv.id}
                onToggle={() => setExpandedId(expandedId === inv.id ? null : inv.id)}
              />
            ))}
          </div>
        </section>
      )}

      {/* Paid */}
      {paid.length > 0 && (
        <section>
          <h2 className="mb-3 text-sm font-semibold text-gray-900">
            Paid ({paid.length})
          </h2>
          <div className="space-y-3">
            {paid.map((inv) => (
              <InvoiceCard
                key={inv.id}
                invoice={inv}
                expanded={expandedId === inv.id}
                onToggle={() => setExpandedId(expandedId === inv.id ? null : inv.id)}
              />
            ))}
          </div>
        </section>
      )}

      {/* Other (void, refunded) */}
      {other.length > 0 && (
        <section>
          <h2 className="mb-3 text-sm font-semibold text-gray-900">
            Other ({other.length})
          </h2>
          <div className="space-y-3">
            {other.map((inv) => (
              <InvoiceCard
                key={inv.id}
                invoice={inv}
                expanded={expandedId === inv.id}
                onToggle={() => setExpandedId(expandedId === inv.id ? null : inv.id)}
              />
            ))}
          </div>
        </section>
      )}
    </div>
  );
}

// ============================================================
// INVOICE CARD
// ============================================================

function InvoiceCard({
  invoice,
  expanded,
  onToggle,
}: {
  invoice: InvoiceWithDetails;
  expanded: boolean;
  onToggle: () => void;
}) {
  const statusConfig =
    INVOICE_STATUS_CONFIG[invoice.status as InvoiceStatus] ?? INVOICE_STATUS_CONFIG.draft;

  const studentName = invoice.student
    ? `${invoice.student.first_name} ${invoice.student.last_name}`
    : 'Student';

  const isPayable = ['sent', 'pending', 'overdue'].includes(invoice.status) && invoice.stripe_hosted_url;

  return (
    <div className="overflow-hidden rounded-lg border border-gray-200 bg-white shadow-sm">
      {/* Header - always visible */}
      <button
        onClick={onToggle}
        className="flex w-full items-center justify-between px-5 py-4 text-left hover:bg-gray-50 transition-colors"
      >
        <div className="flex items-center gap-4">
          <div>
            <p className="text-sm font-semibold text-gray-900">{invoice.invoice_number}</p>
            <p className="text-xs text-gray-500">
              {studentName} Â· Due {new Date(invoice.due_date).toLocaleDateString('en-AU')}
            </p>
          </div>
        </div>
        <div className="flex items-center gap-3">
          <span className={`inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-semibold ${statusConfig.bgColor} ${statusConfig.color}`}>
            {statusConfig.label}
          </span>
          <span className="text-sm font-bold text-gray-900">
            {formatCurrency(invoice.total_cents, invoice.currency)}
          </span>
          <svg
            className={`h-4 w-4 text-gray-400 transition-transform ${expanded ? 'rotate-180' : ''}`}
            fill="none"
            viewBox="0 0 24 24"
            strokeWidth={2}
            stroke="currentColor"
          >
            <path strokeLinecap="round" strokeLinejoin="round" d="m19.5 8.25-7.5 7.5-7.5-7.5" />
          </svg>
        </div>
      </button>

      {/* Expanded detail */}
      {expanded && (
        <div className="border-t border-gray-100 px-5 py-4">
          {/* Period */}
          {(invoice.period_start || invoice.period_end) && (
            <p className="mb-3 text-xs text-gray-500">
              Billing period: {invoice.period_start ? new Date(invoice.period_start).toLocaleDateString('en-AU') : 'â€”'} to{' '}
              {invoice.period_end ? new Date(invoice.period_end).toLocaleDateString('en-AU') : 'â€”'}
            </p>
          )}

          {/* Line items */}
          <div className="space-y-2">
            {invoice.line_items.map((li) => (
              <div key={li.id} className="flex items-center justify-between">
                <div>
                  <p className="text-sm text-gray-700">{li.description}</p>
                  {li.quantity > 1 && (
                    <p className="text-xs text-gray-500">
                      {li.quantity} Ã— {formatCurrency(li.unit_amount_cents, invoice.currency)}
                    </p>
                  )}
                </div>
                <span className="text-sm font-medium text-gray-900">
                  {formatCurrency(li.total_cents, invoice.currency)}
                </span>
              </div>
            ))}
          </div>

          {/* Total */}
          <div className="mt-3 flex items-center justify-between border-t border-gray-100 pt-3">
            <span className="text-sm font-semibold text-gray-900">Total</span>
            <span className="text-sm font-bold text-gray-900">
              {formatCurrency(invoice.total_cents, invoice.currency)}
            </span>
          </div>

          {/* Amount paid (if partially paid) */}
          {invoice.amount_paid_cents > 0 && invoice.amount_paid_cents < invoice.total_cents && (
            <div className="mt-1 flex items-center justify-between">
              <span className="text-xs text-green-700">Amount paid</span>
              <span className="text-xs font-medium text-green-700">
                {formatCurrency(invoice.amount_paid_cents, invoice.currency)}
              </span>
            </div>
          )}

          {/* Pay button */}
          {isPayable && (
            <div className="mt-4">
              <a
                href={invoice.stripe_hosted_url!}
                target="_blank"
                rel="noopener noreferrer"
                className="inline-flex w-full items-center justify-center rounded-lg bg-amber-600 px-4 py-2.5 text-sm font-medium text-white shadow-sm hover:bg-amber-700 transition-colors"
              >
                Pay Now - {formatCurrency(invoice.total_cents - invoice.amount_paid_cents, invoice.currency)}
              </a>
            </div>
          )}

          {/* Paid confirmation */}
          {invoice.status === 'paid' && invoice.paid_at && (
            <div className="mt-3 rounded-md bg-green-50 p-3">
              <p className="text-xs font-medium text-green-700">
                âœ“ Paid on {new Date(invoice.paid_at).toLocaleDateString('en-AU')}
              </p>
            </div>
          )}
        </div>
      )}
    </div>
  );
}


===== D:\.code\wattleos\src\components\domain\comms\announcement-feed-client.tsx =====

// src/components/domain/comms/announcement-feed-client.tsx
//
// ============================================================
// WattleOS V2 - Announcement Feed (Client Component)
// ============================================================
// Handles:
// â€¢ Create announcement form (title, content, priority, target)
// â€¢ Announcement feed with read counts
// â€¢ Pin/unpin, edit, delete actions
// ============================================================

"use client";

import {
  createAnnouncement,
  deleteAnnouncement,
  listAnnouncements,
  updateAnnouncement,
} from "@/lib/actions/announcements";
import type {
  AnnouncementPriority,
  AnnouncementTargetType,
} from "@/lib/constants/communications";
import { ANNOUNCEMENT_PRIORITY_CONFIG } from "@/lib/constants/communications";
import type { AnnouncementWithAuthor, ClassWithCounts } from "@/types/domain";
import { useState } from "react";

interface AnnouncementFeedClientProps {
  initialAnnouncements: AnnouncementWithAuthor[];
  classes: ClassWithCounts[];
}

export function AnnouncementFeedClient({
  initialAnnouncements,
  classes,
}: AnnouncementFeedClientProps) {
  const [announcements, setAnnouncements] = useState(initialAnnouncements);
  const [showCreateForm, setShowCreateForm] = useState(false);
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [error, setError] = useState<string | null>(null);

  // Form state
  const [title, setTitle] = useState("");
  const [content, setContent] = useState("");
  const [priority, setPriority] = useState<AnnouncementPriority>("normal");
  const [targetType, setTargetType] =
    useState<AnnouncementTargetType>("school_wide");
  const [targetClassId, setTargetClassId] = useState<string>("");
  const [isPinned, setIsPinned] = useState(false);

  async function handleCreate() {
    setError(null);
    setIsSubmitting(true);

    const result = await createAnnouncement({
      title,
      content,
      priority,
      target_type: targetType,
      target_class_id: targetType === "class" ? targetClassId : null,
      is_pinned: isPinned,
    });

    setIsSubmitting(false);

    if (result.error) {
      setError(result.error.message);
      return;
    }

    // Refresh the list
    const refreshed = await listAnnouncements({ limit: 50 });
    if (refreshed.data) setAnnouncements(refreshed.data);

    // Reset form
    setTitle("");
    setContent("");
    setPriority("normal");
    setTargetType("school_wide");
    setTargetClassId("");
    setIsPinned(false);
    setShowCreateForm(false);
  }

  async function handleTogglePin(
    announcementId: string,
    currentlyPinned: boolean,
  ) {
    const result = await updateAnnouncement(announcementId, {
      is_pinned: !currentlyPinned,
    });
    if (result.data) {
      setAnnouncements((prev) =>
        prev.map((a) =>
          a.id === announcementId ? { ...a, is_pinned: !currentlyPinned } : a,
        ),
      );
    }
  }

  async function handleDelete(announcementId: string) {
    if (!confirm("Delete this announcement? This cannot be undone.")) return;

    const result = await deleteAnnouncement(announcementId);
    if (result.data) {
      setAnnouncements((prev) => prev.filter((a) => a.id !== announcementId));
    }
  }

  return (
    <div className="space-y-6">
      {/* Create button / form */}
      {!showCreateForm ? (
        <button
          onClick={() => setShowCreateForm(true)}
          className="inline-flex items-center gap-2 rounded-lg bg-amber-600 px-4 py-2.5 text-sm font-medium text-white shadow-sm hover:bg-amber-700 transition-colors"
        >
          <svg
            className="h-4 w-4"
            fill="none"
            viewBox="0 0 24 24"
            strokeWidth={2}
            stroke="currentColor"
          >
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              d="M12 4.5v15m7.5-7.5h-15"
            />
          </svg>
          New Announcement
        </button>
      ) : (
        <div className="rounded-lg border border-gray-200 bg-white p-6 shadow-sm">
          <h2 className="text-lg font-semibold text-gray-900">
            New Announcement
          </h2>

          {error && (
            <div className="mt-3 rounded-md bg-red-50 p-3">
              <p className="text-sm text-red-700">{error}</p>
            </div>
          )}

          <div className="mt-4 space-y-4">
            {/* Title */}
            <div>
              <label className="block text-sm font-medium text-gray-700">
                Title
              </label>
              <input
                type="text"
                value={title}
                onChange={(e) => setTitle(e.target.value)}
                placeholder="e.g., School Closure Tomorrow"
                className="mt-1 block w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-ring focus:outline-none focus:ring-1 focus:ring-ring"
              />
            </div>

            {/* Content */}
            <div>
              <label className="block text-sm font-medium text-gray-700">
                Message
              </label>
              <textarea
                value={content}
                onChange={(e) => setContent(e.target.value)}
                rows={4}
                placeholder="Write your announcement..."
                className="mt-1 block w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-ring focus:outline-none focus:ring-1 focus:ring-ring"
              />
            </div>

            {/* Priority + Target row */}
            <div className="grid grid-cols-1 gap-4 sm:grid-cols-3">
              <div>
                <label className="block text-sm font-medium text-gray-700">
                  Priority
                </label>
                <select
                  value={priority}
                  onChange={(e) =>
                    setPriority(e.target.value as AnnouncementPriority)
                  }
                  className="mt-1 block w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-ring focus:outline-none focus:ring-1 focus:ring-ring"
                >
                  <option value="normal">Normal</option>
                  <option value="urgent">Urgent</option>
                </select>
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700">
                  Audience
                </label>
                <select
                  value={targetType}
                  onChange={(e) =>
                    setTargetType(e.target.value as AnnouncementTargetType)
                  }
                  className="mt-1 block w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-ring focus:outline-none focus:ring-1 focus:ring-ring"
                >
                  <option value="school_wide">Entire School</option>
                  <option value="class">Specific Class</option>
                </select>
              </div>

              {targetType === "class" && (
                <div>
                  <label className="block text-sm font-medium text-gray-700">
                    Class
                  </label>
                  <select
                    value={targetClassId}
                    onChange={(e) => setTargetClassId(e.target.value)}
                    className="mt-1 block w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-ring focus:outline-none focus:ring-1 focus:ring-ring"
                  >
                    <option value="">Select a class...</option>
                    {classes.map((cls) => (
                      <option key={cls.id} value={cls.id}>
                        {cls.name} ({cls.active_enrollment_count} students)
                      </option>
                    ))}
                  </select>
                </div>
              )}
            </div>

            {/* Pin toggle */}
            <label className="flex items-center gap-2 text-sm text-gray-700">
              <input
                type="checkbox"
                checked={isPinned}
                onChange={(e) => setIsPinned(e.target.checked)}
                className="h-4 w-4 rounded border-gray-300 text-amber-600 focus:ring-ring"
              />
              Pin this announcement (stays at top of feed)
            </label>

            {/* Actions */}
            <div className="flex gap-3">
              <button
                onClick={handleCreate}
                disabled={isSubmitting || !title.trim() || !content.trim()}
                className="inline-flex items-center rounded-lg bg-amber-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-amber-700 disabled:cursor-not-allowed disabled:opacity-50 transition-colors"
              >
                {isSubmitting ? "Publishing..." : "Publish Announcement"}
              </button>
              <button
                onClick={() => setShowCreateForm(false)}
                className="rounded-lg border border-gray-300 px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 transition-colors"
              >
                Cancel
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Announcement Feed */}
      {announcements.length === 0 ? (
        <div className="rounded-lg border-2 border-dashed border-gray-300 p-12 text-center">
          <p className="text-sm text-gray-500">
            No announcements yet. Create the first one to share news with your
            school community.
          </p>
        </div>
      ) : (
        <div className="space-y-4">
          {announcements.map((announcement) => {
            const config = ANNOUNCEMENT_PRIORITY_CONFIG[announcement.priority];
            const timeAgo = formatRelativeTime(announcement.published_at);

            return (
              <div
                key={announcement.id}
                className={`rounded-lg border bg-white shadow-sm ${
                  announcement.is_pinned
                    ? "border-amber-300 ring-1 ring-amber-100"
                    : "border-gray-200"
                }`}
              >
                <div className="p-5">
                  {/* Header row */}
                  <div className="flex items-start justify-between gap-4">
                    <div className="flex-1">
                      <div className="flex items-center gap-2 flex-wrap">
                        {announcement.is_pinned && (
                          <span className="inline-flex items-center gap-1 rounded-full bg-amber-100 px-2 py-0.5 text-[10px] font-semibold text-amber-700">
                            ðŸ“Œ Pinned
                          </span>
                        )}
                        {announcement.priority === "urgent" && (
                          <span
                            className={`inline-flex items-center gap-1 rounded-full px-2 py-0.5 text-[10px] font-semibold ${config.bgColor} ${config.color}`}
                          >
                            {config.icon} {config.label}
                          </span>
                        )}
                        <span className="inline-flex items-center rounded-full bg-gray-100 px-2 py-0.5 text-[10px] font-medium text-gray-600">
                          {announcement.target_type === "school_wide"
                            ? "ðŸ« School-wide"
                            : `ðŸ“š ${announcement.target_class?.name ?? "Class"}`}
                        </span>
                      </div>
                      <h3 className="mt-2 text-base font-semibold text-gray-900">
                        {announcement.title}
                      </h3>
                    </div>

                    {/* Actions dropdown */}
                    <div className="flex items-center gap-1">
                      <button
                        onClick={() =>
                          handleTogglePin(
                            announcement.id,
                            announcement.is_pinned,
                          )
                        }
                        className="rounded p-1.5 text-gray-400 hover:bg-gray-100 hover:text-gray-600"
                        title={announcement.is_pinned ? "Unpin" : "Pin"}
                      >
                        <svg
                          className="h-4 w-4"
                          fill={
                            announcement.is_pinned ? "currentColor" : "none"
                          }
                          viewBox="0 0 24 24"
                          strokeWidth={1.5}
                          stroke="currentColor"
                        >
                          <path
                            strokeLinecap="round"
                            strokeLinejoin="round"
                            d="M17.593 3.322c1.1.128 1.907 1.077 1.907 2.185V21L12 17.25 4.5 21V5.507c0-1.108.806-2.057 1.907-2.185a48.507 48.507 0 0 1 11.186 0Z"
                          />
                        </svg>
                      </button>
                      <button
                        onClick={() => handleDelete(announcement.id)}
                        className="rounded p-1.5 text-gray-400 hover:bg-red-50 hover:text-red-600"
                        title="Delete"
                      >
                        <svg
                          className="h-4 w-4"
                          fill="none"
                          viewBox="0 0 24 24"
                          strokeWidth={1.5}
                          stroke="currentColor"
                        >
                          <path
                            strokeLinecap="round"
                            strokeLinejoin="round"
                            d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0"
                          />
                        </svg>
                      </button>
                    </div>
                  </div>

                  {/* Content */}
                  <p className="mt-3 whitespace-pre-wrap text-sm text-gray-700">
                    {announcement.content}
                  </p>

                  {/* Footer */}
                  <div className="mt-4 flex items-center justify-between text-xs text-gray-500">
                    <div className="flex items-center gap-2">
                      <span>
                        By {announcement.author.first_name}{" "}
                        {announcement.author.last_name}
                      </span>
                      <span>Â·</span>
                      <span>{timeAgo}</span>
                    </div>
                    <div className="flex items-center gap-1">
                      <svg
                        className="h-3.5 w-3.5"
                        fill="none"
                        viewBox="0 0 24 24"
                        strokeWidth={1.5}
                        stroke="currentColor"
                      >
                        <path
                          strokeLinecap="round"
                          strokeLinejoin="round"
                          d="M2.036 12.322a1.012 1.012 0 0 1 0-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178Z"
                        />
                        <path
                          strokeLinecap="round"
                          strokeLinejoin="round"
                          d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z"
                        />
                      </svg>
                      <span>{announcement.read_count ?? 0} read</span>
                    </div>
                  </div>
                </div>
              </div>
            );
          })}
        </div>
      )}
    </div>
  );
}

function formatRelativeTime(dateString: string): string {
  const date = new Date(dateString);
  const now = new Date();
  const diffMs = now.getTime() - date.getTime();
  const diffMins = Math.floor(diffMs / 60000);
  const diffHours = Math.floor(diffMins / 60);
  const diffDays = Math.floor(diffHours / 24);

  if (diffMins < 1) return "Just now";
  if (diffMins < 60) return `${diffMins}m ago`;
  if (diffHours < 24) return `${diffHours}h ago`;
  if (diffDays < 7) return `${diffDays}d ago`;
  return date.toLocaleDateString("en-AU", { day: "numeric", month: "short" });
}



===== D:\.code\wattleos\src\components\domain\comms\message-inbox-client.tsx =====

// src/components/domain/comms/message-inbox-client.tsx
//
// ============================================================
// WattleOS V2 - Message Inbox (Client Component)
// ============================================================
// Shows message threads with preview, unread indicators,
// and compose form for new class broadcasts.
// ============================================================

"use client";

import { createClassBroadcast, getInbox } from "@/lib/actions/messaging";
import type { MessageThreadType } from "@/lib/constants/communications";
import { THREAD_TYPE_CONFIG } from "@/lib/constants/communications";
import type { ClassWithCounts, MessageThreadWithPreview } from "@/types/domain";
import Link from "next/link";
import { useState } from "react";

interface MessageInboxClientProps {
  initialThreads: MessageThreadWithPreview[];
  classes: ClassWithCounts[];
  currentUserId: string;
}

export function MessageInboxClient({
  initialThreads,
  classes,
  currentUserId,
}: MessageInboxClientProps) {
  const [threads, setThreads] = useState(initialThreads);
  const [showCompose, setShowCompose] = useState(false);
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [error, setError] = useState<string | null>(null);

  // Compose form state
  const [composeClassId, setComposeClassId] = useState("");
  const [composeSubject, setComposeSubject] = useState("");
  const [composeMessage, setComposeMessage] = useState("");

  async function handleSendBroadcast() {
    if (!composeClassId || !composeSubject.trim() || !composeMessage.trim())
      return;

    setError(null);
    setIsSubmitting(true);

    const result = await createClassBroadcast({
      class_id: composeClassId,
      subject: composeSubject,
      initial_message: composeMessage,
    });

    setIsSubmitting(false);

    if (result.error) {
      setError(result.error.message);
      return;
    }

    // Refresh inbox
    const refreshed = await getInbox({ limit: 30 });
    if (refreshed.data) setThreads(refreshed.data);

    // Reset form
    setComposeClassId("");
    setComposeSubject("");
    setComposeMessage("");
    setShowCompose(false);
  }

  return (
    <div className="space-y-4">
      {/* Compose button / form */}
      {!showCompose ? (
        <button
          onClick={() => setShowCompose(true)}
          className="inline-flex items-center gap-2 rounded-lg bg-amber-600 px-4 py-2.5 text-sm font-medium text-white shadow-sm hover:bg-amber-700 transition-colors"
        >
          <svg
            className="h-4 w-4"
            fill="none"
            viewBox="0 0 24 24"
            strokeWidth={2}
            stroke="currentColor"
          >
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              d="M12 4.5v15m7.5-7.5h-15"
            />
          </svg>
          New Class Message
        </button>
      ) : (
        <div className="rounded-lg border border-gray-200 bg-white p-6 shadow-sm">
          <h2 className="text-lg font-semibold text-gray-900">
            Send Class Message
          </h2>
          <p className="mt-1 text-sm text-gray-500">
            This message will be sent to all parents of students in the selected
            class.
          </p>

          {error && (
            <div className="mt-3 rounded-md bg-red-50 p-3">
              <p className="text-sm text-red-700">{error}</p>
            </div>
          )}

          <div className="mt-4 space-y-4">
            <div>
              <label className="block text-sm font-medium text-gray-700">
                Class
              </label>
              <select
                value={composeClassId}
                onChange={(e) => setComposeClassId(e.target.value)}
                className="mt-1 block w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-ring focus:outline-none focus:ring-1 focus:ring-ring"
              >
                <option value="">Select a class...</option>
                {classes.map((cls) => (
                  <option key={cls.id} value={cls.id}>
                    {cls.name} ({cls.active_enrollment_count} students)
                  </option>
                ))}
              </select>
            </div>

            <div>
              <label className="block text-sm font-medium text-gray-700">
                Subject
              </label>
              <input
                type="text"
                value={composeSubject}
                onChange={(e) => setComposeSubject(e.target.value)}
                placeholder="e.g., Field Trip Reminder"
                className="mt-1 block w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-ring focus:outline-none focus:ring-1 focus:ring-ring"
              />
            </div>

            <div>
              <label className="block text-sm font-medium text-gray-700">
                Message
              </label>
              <textarea
                value={composeMessage}
                onChange={(e) => setComposeMessage(e.target.value)}
                rows={4}
                placeholder="Write your message to parents..."
                className="mt-1 block w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-ring focus:outline-none focus:ring-1 focus:ring-ring"
              />
            </div>

            <div className="flex gap-3">
              <button
                onClick={handleSendBroadcast}
                disabled={
                  isSubmitting ||
                  !composeClassId ||
                  !composeSubject.trim() ||
                  !composeMessage.trim()
                }
                className="inline-flex items-center rounded-lg bg-amber-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-amber-700 disabled:cursor-not-allowed disabled:opacity-50 transition-colors"
              >
                {isSubmitting ? "Sending..." : "Send to Class"}
              </button>
              <button
                onClick={() => setShowCompose(false)}
                className="rounded-lg border border-gray-300 px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 transition-colors"
              >
                Cancel
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Thread list */}
      {threads.length === 0 ? (
        <div className="rounded-lg border-2 border-dashed border-gray-300 p-12 text-center">
          <p className="text-sm text-gray-500">
            No messages yet. Send a class message to start communicating with
            parents.
          </p>
        </div>
      ) : (
        <div className="divide-y divide-gray-200 rounded-lg border border-gray-200 bg-white shadow-sm">
          {threads.map((thread) => {
            const typeConfig =
              THREAD_TYPE_CONFIG[thread.thread_type as MessageThreadType];
            const hasUnread = thread.unread_count > 0;
            const lastMsg = thread.last_message;
            const lastSender = thread.last_message_sender;

            // Truncate message preview
            const preview = lastMsg
              ? lastMsg.content.length > 100
                ? lastMsg.content.slice(0, 100) + "..."
                : lastMsg.content
              : "No messages yet";

            const senderName = lastSender
              ? lastSender.id === currentUserId
                ? "You"
                : `${lastSender.first_name} ${lastSender.last_name}`
              : "";

            return (
              <Link
                key={thread.id}
                href={`/comms/messages/${thread.id}`}
                className={`block px-5 py-4 transition-colors hover:bg-gray-50 ${
                  hasUnread ? "bg-amber-50/50" : ""
                }`}
              >
                <div className="flex items-start justify-between gap-4">
                  <div className="min-w-0 flex-1">
                    <div className="flex items-center gap-2">
                      {hasUnread && (
                        <span className="inline-flex h-2 w-2 rounded-full bg-amber-500" />
                      )}
                      <span
                        className={`text-sm ${hasUnread ? "font-semibold text-gray-900" : "font-medium text-gray-700"}`}
                      >
                        {thread.subject || "No subject"}
                      </span>
                      <span
                        className={`inline-flex items-center rounded-full px-1.5 py-0.5 text-[10px] font-medium ${typeConfig.bgColor} ${typeConfig.color}`}
                      >
                        {typeConfig.icon}{" "}
                        {thread.target_class?.name ?? typeConfig.label}
                      </span>
                    </div>
                    <p className="mt-1 truncate text-sm text-gray-500">
                      {senderName && (
                        <span className="font-medium text-gray-600">
                          {senderName}:{" "}
                        </span>
                      )}
                      {preview}
                    </p>
                  </div>
                  <div className="flex flex-col items-end gap-1">
                    <span className="whitespace-nowrap text-xs text-gray-400">
                      {lastMsg ? formatRelativeTime(lastMsg.sent_at) : ""}
                    </span>
                    {hasUnread && (
                      <span className="inline-flex h-5 min-w-[20px] items-center justify-center rounded-full bg-amber-500 px-1.5 text-[10px] font-bold text-white">
                        {thread.unread_count}
                      </span>
                    )}
                    <span className="text-[10px] text-gray-400">
                      {thread.recipient_count} recipients
                    </span>
                  </div>
                </div>
              </Link>
            );
          })}
        </div>
      )}
    </div>
  );
}

function formatRelativeTime(dateString: string): string {
  const date = new Date(dateString);
  const now = new Date();
  const diffMs = now.getTime() - date.getTime();
  const diffMins = Math.floor(diffMs / 60000);
  const diffHours = Math.floor(diffMins / 60);
  const diffDays = Math.floor(diffHours / 24);

  if (diffMins < 1) return "Just now";
  if (diffMins < 60) return `${diffMins}m ago`;
  if (diffHours < 24) return `${diffHours}h ago`;
  if (diffDays < 7) return `${diffDays}d ago`;
  return date.toLocaleDateString("en-AU", { day: "numeric", month: "short" });
}



===== D:\.code\wattleos\src\components\domain\comms\parent-announcement-feed.tsx =====

// src/components/domain/comms/parent-announcement-feed.tsx
//
// ============================================================
// WattleOS V2 - Parent Announcement Feed (Client Component)
// ============================================================
// Read-only announcement display for parents. Marks
// announcements as read when they come into view.
// ============================================================

'use client';

import { useEffect, useState } from 'react';
import { markAnnouncementRead } from '@/lib/actions/announcements';
import type { AnnouncementWithAuthor } from '@/types/domain';
import { ANNOUNCEMENT_PRIORITY_CONFIG } from '@/lib/constants/communications';

interface ParentAnnouncementFeedProps {
  initialAnnouncements: AnnouncementWithAuthor[];
}

export function ParentAnnouncementFeed({
  initialAnnouncements,
}: ParentAnnouncementFeedProps) {
  const [announcements, setAnnouncements] = useState(initialAnnouncements);
  const [markedIds, setMarkedIds] = useState<Set<string>>(new Set());

  // Mark unread announcements as read on mount
  useEffect(() => {
    const unread = announcements.filter((a) => !a.is_read && !markedIds.has(a.id));
    for (const announcement of unread) {
      markAnnouncementRead(announcement.id);
      setMarkedIds((prev) => new Set([...prev, announcement.id]));
    }
  }, [announcements, markedIds]);

  if (announcements.length === 0) {
    return (
      <div className="rounded-lg border-2 border-dashed border-gray-300 p-12 text-center">
        <p className="text-sm text-gray-500">
          No announcements from your school yet.
        </p>
      </div>
    );
  }

  return (
    <div className="space-y-4">
      {announcements.map((announcement) => {
        const config = ANNOUNCEMENT_PRIORITY_CONFIG[announcement.priority];
        const isUnread = !announcement.is_read && !markedIds.has(announcement.id);

        return (
          <div
            key={announcement.id}
            className={`rounded-lg border bg-white shadow-sm ${
              announcement.is_pinned
                ? 'border-amber-300 ring-1 ring-amber-100'
                : isUnread
                ? 'border-amber-200 bg-amber-50/30'
                : 'border-gray-200'
            }`}
          >
            <div className="p-5">
              {/* Badges */}
              <div className="flex items-center gap-2 flex-wrap">
                {announcement.is_pinned && (
                  <span className="inline-flex items-center gap-1 rounded-full bg-amber-100 px-2 py-0.5 text-[10px] font-semibold text-amber-700">
                    ðŸ“Œ Pinned
                  </span>
                )}
                {announcement.priority === 'urgent' && (
                  <span className={`inline-flex items-center gap-1 rounded-full px-2 py-0.5 text-[10px] font-semibold ${config.bgColor} ${config.color}`}>
                    {config.icon} {config.label}
                  </span>
                )}
                {announcement.target_type === 'class' && announcement.target_class && (
                  <span className="inline-flex items-center rounded-full bg-blue-50 px-2 py-0.5 text-[10px] font-medium text-blue-700">
                    ðŸ“š {announcement.target_class.name}
                  </span>
                )}
                {isUnread && (
                  <span className="inline-flex h-2 w-2 rounded-full bg-amber-500" />
                )}
              </div>

              {/* Title + content */}
              <h3 className="mt-2 text-base font-semibold text-gray-900">
                {announcement.title}
              </h3>
              <p className="mt-2 whitespace-pre-wrap text-sm text-gray-700">
                {announcement.content}
              </p>

              {/* Footer */}
              <div className="mt-4 flex items-center gap-2 text-xs text-gray-500">
                <span>
                  {announcement.author.first_name} {announcement.author.last_name}
                </span>
                <span>Â·</span>
                <span>{formatDate(announcement.published_at)}</span>
              </div>
            </div>
          </div>
        );
      })}
    </div>
  );
}

function formatDate(dateString: string): string {
  const date = new Date(dateString);
  const now = new Date();
  const diffMs = now.getTime() - date.getTime();
  const diffMins = Math.floor(diffMs / 60000);
  const diffHours = Math.floor(diffMins / 60);
  const diffDays = Math.floor(diffHours / 24);

  if (diffMins < 1) return 'Just now';
  if (diffMins < 60) return `${diffMins}m ago`;
  if (diffHours < 24) return `${diffHours}h ago`;
  if (diffDays < 7) return `${diffDays}d ago`;
  return date.toLocaleDateString('en-AU', {
    day: 'numeric',
    month: 'short',
    year: date.getFullYear() !== now.getFullYear() ? 'numeric' : undefined,
  });
}


===== D:\.code\wattleos\src\components\domain\comms\parent-inbox-client.tsx =====

// src/components/domain/comms/parent-inbox-client.tsx
//
// ============================================================
// WattleOS V2 - Parent Message Inbox (Client Component)
// ============================================================
// Read-only thread list - parents can view and reply but
// cannot initiate new threads (that's a guide action).
// ============================================================

'use client';

import Link from 'next/link';
import type { MessageThreadWithPreview } from '@/types/domain';
import { THREAD_TYPE_CONFIG } from '@/lib/constants/communications';
import type { MessageThreadType } from '@/lib/constants/communications';

interface ParentInboxClientProps {
  initialThreads: MessageThreadWithPreview[];
  currentUserId: string;
}

export function ParentInboxClient({
  initialThreads,
  currentUserId,
}: ParentInboxClientProps) {
  if (initialThreads.length === 0) {
    return (
      <div className="rounded-lg border-2 border-dashed border-gray-300 p-12 text-center">
        <p className="text-sm text-gray-500">
          No messages yet. Your child&apos;s guides will reach out when they have updates to share.
        </p>
      </div>
    );
  }

  return (
    <div className="divide-y divide-gray-200 rounded-lg border border-gray-200 bg-white shadow-sm">
      {initialThreads.map((thread) => {
        const typeConfig = THREAD_TYPE_CONFIG[thread.thread_type as MessageThreadType];
        const hasUnread = thread.unread_count > 0;
        const lastMsg = thread.last_message;
        const lastSender = thread.last_message_sender;

        const preview = lastMsg
          ? lastMsg.content.length > 100
            ? lastMsg.content.slice(0, 100) + '...'
            : lastMsg.content
          : 'No messages yet';

        const senderName = lastSender
          ? lastSender.id === currentUserId
            ? 'You'
            : `${lastSender.first_name} ${lastSender.last_name}`
          : '';

        return (
          <Link
            key={thread.id}
            href={`/parent/messages/${thread.id}`}
            className={`block px-5 py-4 transition-colors hover:bg-gray-50 ${
              hasUnread ? 'bg-amber-50/50' : ''
            }`}
          >
            <div className="flex items-start justify-between gap-4">
              <div className="min-w-0 flex-1">
                <div className="flex items-center gap-2">
                  {hasUnread && (
                    <span className="inline-flex h-2 w-2 rounded-full bg-amber-500" />
                  )}
                  <span className={`text-sm ${hasUnread ? 'font-semibold text-gray-900' : 'font-medium text-gray-700'}`}>
                    {thread.subject || 'Message'}
                  </span>
                  {thread.target_class && (
                    <span className={`inline-flex items-center rounded-full px-1.5 py-0.5 text-[10px] font-medium ${typeConfig.bgColor} ${typeConfig.color}`}>
                      {thread.target_class.name}
                    </span>
                  )}
                </div>
                <p className="mt-1 truncate text-sm text-gray-500">
                  {senderName && <span className="font-medium text-gray-600">{senderName}: </span>}
                  {preview}
                </p>
                <p className="mt-1 text-xs text-gray-400">
                  From {thread.creator.first_name} {thread.creator.last_name}
                </p>
              </div>
              <div className="flex flex-col items-end gap-1">
                <span className="whitespace-nowrap text-xs text-gray-400">
                  {lastMsg ? formatRelativeTime(lastMsg.sent_at) : ''}
                </span>
                {hasUnread && (
                  <span className="inline-flex h-5 min-w-[20px] items-center justify-center rounded-full bg-amber-500 px-1.5 text-[10px] font-bold text-white">
                    {thread.unread_count}
                  </span>
                )}
              </div>
            </div>
          </Link>
        );
      })}
    </div>
  );
}

function formatRelativeTime(dateString: string): string {
  const date = new Date(dateString);
  const now = new Date();
  const diffMs = now.getTime() - date.getTime();
  const diffMins = Math.floor(diffMs / 60000);
  const diffHours = Math.floor(diffMins / 60);
  const diffDays = Math.floor(diffHours / 24);

  if (diffMins < 1) return 'Just now';
  if (diffMins < 60) return `${diffMins}m ago`;
  if (diffHours < 24) return `${diffHours}h ago`;
  if (diffDays < 7) return `${diffDays}d ago`;
  return date.toLocaleDateString('en-AU', { day: 'numeric', month: 'short' });
}


===== D:\.code\wattleos\src\components\domain\comms\thread-view-client.tsx =====

// src/components/domain/comms/thread-view-client.tsx
//
// ============================================================
// WattleOS V2 - Thread Conversation View (Client Component)
// ============================================================
// Chat-style message display with reply input.
// Messages from current user appear on the right (amber),
// others on the left (gray). Auto-scrolls to newest message.
// ============================================================

"use client";

import { sendMessage } from "@/lib/actions/messaging";
import type { MessageWithSender, User } from "@/types/domain";
import { useEffect, useRef, useState } from "react";

interface ThreadViewClientProps {
  threadId: string;
  initialMessages: MessageWithSender[];
  recipients: Array<
    Pick<User, "id" | "first_name" | "last_name" | "avatar_url">
  >;
  currentUserId: string;
}

export function ThreadViewClient({
  threadId,
  initialMessages,
  recipients,
  currentUserId,
}: ThreadViewClientProps) {
  const [messages, setMessages] = useState(initialMessages);
  const [replyContent, setReplyContent] = useState("");
  const [isSending, setIsSending] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const bottomRef = useRef<HTMLDivElement>(null);

  // Auto-scroll to bottom on new messages
  useEffect(() => {
    bottomRef.current?.scrollIntoView({ behavior: "smooth" });
  }, [messages]);

  async function handleSend() {
    if (!replyContent.trim() || isSending) return;

    setError(null);
    setIsSending(true);

    // Optimistic add
    const optimisticMessage: MessageWithSender = {
      id: `temp-${Date.now()}`,
      tenant_id: "",
      thread_id: threadId,
      sender_id: currentUserId,
      content: replyContent.trim(),
      sent_at: new Date().toISOString(),
      created_at: new Date().toISOString(),
      sender: {
        id: currentUserId,
        first_name: "You",
        last_name: "",
        avatar_url: null,
      },
    };

    setMessages((prev) => [...prev, optimisticMessage]);
    const sentContent = replyContent;
    setReplyContent("");

    const result = await sendMessage({
      thread_id: threadId,
      content: sentContent,
    });

    setIsSending(false);

    if (result.error) {
      setError(result.error.message);
      // Remove optimistic message
      setMessages((prev) => prev.filter((m) => m.id !== optimisticMessage.id));
      setReplyContent(sentContent);
      return;
    }

    // Replace optimistic message with real one
    if (result.data) {
      setMessages((prev) =>
        prev.map((m) =>
          m.id === optimisticMessage.id
            ? {
                ...optimisticMessage,
                id: result.data!.id,
                sent_at: result.data!.sent_at,
              }
            : m,
        ),
      );
    }
  }

  function handleKeyDown(e: React.KeyboardEvent<HTMLTextAreaElement>) {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      handleSend();
    }
  }

  return (
    <div
      className="flex flex-col rounded-lg border border-gray-200 bg-white shadow-sm"
      style={{ height: "calc(100vh - 300px)", minHeight: "400px" }}
    >
      {/* Messages area */}
      <div className="flex-1 overflow-y-auto px-6 py-4">
        {messages.length === 0 ? (
          <div className="flex h-full items-center justify-center">
            <p className="text-sm text-gray-500">
              No messages yet. Start the conversation!
            </p>
          </div>
        ) : (
          <div className="space-y-4">
            {messages.map((msg, idx) => {
              const isOwn = msg.sender_id === currentUserId;
              const showSender =
                idx === 0 || messages[idx - 1].sender_id !== msg.sender_id;
              const senderName = isOwn
                ? "You"
                : `${msg.sender.first_name} ${msg.sender.last_name}`.trim();
              const initials = isOwn
                ? "Y"
                : (msg.sender.first_name?.[0] ?? "?").toUpperCase();

              return (
                <div
                  key={msg.id}
                  className={`flex gap-3 ${isOwn ? "flex-row-reverse" : ""}`}
                >
                  {/* Avatar - only show on first message in a group */}
                  <div className="w-8 flex-shrink-0">
                    {showSender && (
                      <div
                        className={`flex h-8 w-8 items-center justify-center rounded-full text-xs font-bold ${
                          isOwn
                            ? "bg-amber-200 text-amber-800"
                            : "bg-gray-200 text-gray-600"
                        }`}
                      >
                        {msg.sender.avatar_url ? (
                          <img
                            src={msg.sender.avatar_url}
                            alt=""
                            className="h-8 w-8 rounded-full object-cover"
                          />
                        ) : (
                          initials
                        )}
                      </div>
                    )}
                  </div>

                  {/* Message bubble */}
                  <div className={`max-w-[70%] ${isOwn ? "text-right" : ""}`}>
                    {showSender && (
                      <p className="mb-1 text-xs font-medium text-gray-500">
                        {senderName}
                      </p>
                    )}
                    <div
                      className={`inline-block rounded-2xl px-4 py-2.5 text-sm ${
                        isOwn
                          ? "rounded-br-md bg-amber-500 text-white"
                          : "rounded-bl-md bg-gray-100 text-gray-900"
                      }`}
                    >
                      <p className="whitespace-pre-wrap">{msg.content}</p>
                    </div>
                    <p className="mt-1 text-[10px] text-gray-400">
                      {formatTime(msg.sent_at)}
                    </p>
                  </div>
                </div>
              );
            })}
            <div ref={bottomRef} />
          </div>
        )}
      </div>

      {/* Recipients bar */}
      <div className="border-t border-gray-100 px-6 py-2">
        <div className="flex items-center gap-1 overflow-x-auto">
          <span className="flex-shrink-0 text-[10px] font-medium text-gray-400">
            To:
          </span>
          {recipients.slice(0, 8).map((r) => (
            <span
              key={r.id}
              className="inline-flex flex-shrink-0 items-center rounded-full bg-gray-100 px-2 py-0.5 text-[10px] text-gray-600"
            >
              {r.first_name} {r.last_name}
            </span>
          ))}
          {recipients.length > 8 && (
            <span className="text-[10px] text-gray-400">
              +{recipients.length - 8} more
            </span>
          )}
        </div>
      </div>

      {/* Reply input */}
      <div className="border-t border-gray-200 px-4 py-3">
        {error && (
          <div className="mb-2 rounded-md bg-red-50 px-3 py-2">
            <p className="text-xs text-red-700">{error}</p>
          </div>
        )}
        <div className="flex items-end gap-3">
          <textarea
            value={replyContent}
            onChange={(e) => setReplyContent(e.target.value)}
            onKeyDown={handleKeyDown}
            rows={1}
            placeholder="Type a message... (Enter to send, Shift+Enter for new line)"
            className="flex-1 resize-none rounded-xl border border-gray-300 px-4 py-2.5 text-sm focus:border-ring focus:outline-none focus:ring-1 focus:ring-ring"
            style={{ maxHeight: "120px" }}
            onInput={(e) => {
              const target = e.target as HTMLTextAreaElement;
              target.style.height = "auto";
              target.style.height = Math.min(target.scrollHeight, 120) + "px";
            }}
          />
          <button
            onClick={handleSend}
            disabled={isSending || !replyContent.trim()}
            className="flex-shrink-0 rounded-xl bg-amber-600 p-2.5 text-white shadow-sm hover:bg-amber-700 disabled:cursor-not-allowed disabled:opacity-50 transition-colors"
          >
            <svg
              className="h-5 w-5"
              fill="none"
              viewBox="0 0 24 24"
              strokeWidth={1.5}
              stroke="currentColor"
            >
              <path
                strokeLinecap="round"
                strokeLinejoin="round"
                d="M6 12 3.269 3.125A59.769 59.769 0 0 1 21.485 12 59.768 59.768 0 0 1 3.27 20.875L5.999 12Zm0 0h7.5"
              />
            </svg>
          </button>
        </div>
      </div>
    </div>
  );
}

function formatTime(dateString: string): string {
  const date = new Date(dateString);
  const now = new Date();
  const isToday = date.toDateString() === now.toDateString();

  if (isToday) {
    return date.toLocaleTimeString("en-AU", {
      hour: "2-digit",
      minute: "2-digit",
    });
  }

  const yesterday = new Date(now);
  yesterday.setDate(yesterday.getDate() - 1);
  if (date.toDateString() === yesterday.toDateString()) {
    return (
      "Yesterday " +
      date.toLocaleTimeString("en-AU", { hour: "2-digit", minute: "2-digit" })
    );
  }

  return date.toLocaleDateString("en-AU", {
    day: "numeric",
    month: "short",
    hour: "2-digit",
    minute: "2-digit",
  });
}



===== D:\.code\wattleos\src\components\domain\curriculum\create-blank-button.tsx =====

"use client";

import { createBlankCurriculumInstance } from "@/lib/actions/curriculum";
import { useRouter } from "next/navigation";
import { useState } from "react";

export function CreateBlankButton() {
  const [isOpen, setIsOpen] = useState(false);
  const [name, setName] = useState("");
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const router = useRouter();

  async function handleCreate() {
    if (!name.trim()) return;

    setIsLoading(true);
    setError(null);

    const result = await createBlankCurriculumInstance(name.trim());

    if (result.error) {
      setError(result.error.message);
      setIsLoading(false);
      return;
    }

    if (result.data) {
      router.push(`/pedagogy/curriculum/${result.data.id}`);
      router.refresh();
    }
  }

  if (!isOpen) {
    return (
      <button
        onClick={() => setIsOpen(true)}
        className="rounded-md border border-gray-300 bg-white px-3 py-1.5 text-xs font-medium text-gray-700 transition-colors hover:bg-gray-50"
      >
        Create Blank
      </button>
    );
  }

  return (
    <div className="space-y-2">
      <input
        type="text"
        value={name}
        onChange={(e) => setName(e.target.value)}
        placeholder="Curriculum name..."
        autoFocus
        onKeyDown={(e) => {
          if (e.key === "Enter") handleCreate();
          if (e.key === "Escape") setIsOpen(false);
        }}
        className="w-full rounded-md border border-gray-300 px-3 py-1.5 text-xs focus:border-ring focus:outline-none focus:ring-1 focus:ring-ring"
      />
      <div className="flex gap-2">
        <button
          onClick={handleCreate}
          disabled={isLoading || !name.trim()}
          className="rounded-md bg-amber-600 px-3 py-1 text-xs font-medium text-white hover:bg-amber-700 disabled:opacity-50"
        >
          {isLoading ? "Creating..." : "Create"}
        </button>
        <button
          onClick={() => {
            setIsOpen(false);
            setName("");
          }}
          className="rounded-md border border-gray-300 px-3 py-1 text-xs text-gray-600 hover:bg-gray-50"
        >
          Cancel
        </button>
      </div>
      {error && <p className="text-xs text-red-600">{error}</p>}
    </div>
  );
}



===== D:\.code\wattleos\src\components\domain\curriculum\curriculum-tree-view.tsx =====

"use client";

import {
  createCurriculumNode,
  deleteCurriculumNode,
  reorderCurriculumNode,
  searchCurriculumNodes,
  toggleNodeVisibility,
  updateCurriculumNode,
} from "@/lib/actions/curriculum";
import type { CurriculumTreeNode } from "@/lib/utils/curriculum-tree";
import { LEVEL_CONFIG } from "@/lib/utils/curriculum-tree";
import type { CurriculumLevel } from "@/types/domain";
import { useRouter } from "next/navigation";
import { useCallback, useState, useTransition } from "react";

interface CurriculumTreeViewProps {
  instanceId: string;
  initialTree: CurriculumTreeNode[];
  canManage: boolean;
}

export function CurriculumTreeView({
  instanceId,
  initialTree,
  canManage,
}: CurriculumTreeViewProps) {
  const [searchQuery, setSearchQuery] = useState("");
  const [searchResults, setSearchResults] = useState<Set<string> | null>(null);
  const [expandedNodes, setExpandedNodes] = useState<Set<string>>(() => {
    // Start with areas expanded
    const initial = new Set<string>();
    initialTree.forEach((area) => initial.add(area.id));
    return initial;
  });
  const [isPending, startTransition] = useTransition();
  const router = useRouter();

  const toggleExpanded = useCallback((nodeId: string) => {
    setExpandedNodes((prev) => {
      const next = new Set(prev);
      if (next.has(nodeId)) {
        next.delete(nodeId);
      } else {
        next.add(nodeId);
      }
      return next;
    });
  }, []);

  const expandAll = useCallback(() => {
    const all = new Set<string>();
    function walk(nodes: CurriculumTreeNode[]) {
      for (const node of nodes) {
        if (node.children.length > 0) all.add(node.id);
        walk(node.children);
      }
    }
    walk(initialTree);
    setExpandedNodes(all);
  }, [initialTree]);

  const collapseAll = useCallback(() => {
    setExpandedNodes(new Set());
  }, []);

  // Search handler
  async function handleSearch(query: string) {
    setSearchQuery(query);

    if (!query.trim()) {
      setSearchResults(null);
      return;
    }

    const result = await searchCurriculumNodes(instanceId, query.trim());
    if (result.data) {
      const ids = new Set(result.data.map((n) => n.id));
      setSearchResults(ids);

      // Expand all ancestors of matching nodes so they're visible
      // (We need to find parent chains - since we have the flat initial tree,
      //  we can walk the tree structure)
      const toExpand = new Set<string>();
      function findAncestors(
        nodes: CurriculumTreeNode[],
        targetIds: Set<string>,
        ancestors: string[],
      ) {
        for (const node of nodes) {
          const currentPath = [...ancestors, node.id];
          if (targetIds.has(node.id)) {
            ancestors.forEach((a) => toExpand.add(a));
          }
          findAncestors(node.children, targetIds, currentPath);
        }
      }
      findAncestors(initialTree, ids, []);
      setExpandedNodes((prev) => new Set([...prev, ...toExpand]));
    }
  }

  function refresh() {
    startTransition(() => {
      router.refresh();
    });
  }

  return (
    <div className="space-y-4">
      {/* Toolbar */}
      <div className="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
        {/* Search */}
        <div className="relative flex-1 sm:max-w-md">
          <input
            type="text"
            value={searchQuery}
            onChange={(e) => handleSearch(e.target.value)}
            placeholder="Search outcomes..."
            className="w-full rounded-lg border border-gray-300 py-2 pl-9 pr-3 text-sm focus:border-ring focus:outline-none focus:ring-1 focus:ring-ring"
          />
          <svg
            className="absolute left-3 top-2.5 h-4 w-4 text-gray-400"
            fill="none"
            viewBox="0 0 24 24"
            strokeWidth={1.5}
            stroke="currentColor"
          >
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z"
            />
          </svg>
          {searchQuery && (
            <button
              onClick={() => {
                setSearchQuery("");
                setSearchResults(null);
              }}
              className="absolute right-3 top-2.5 text-gray-400 hover:text-gray-600"
            >
              <svg
                className="h-4 w-4"
                fill="none"
                viewBox="0 0 24 24"
                strokeWidth={1.5}
                stroke="currentColor"
              >
                <path
                  strokeLinecap="round"
                  strokeLinejoin="round"
                  d="M6 18 18 6M6 6l12 12"
                />
              </svg>
            </button>
          )}
        </div>

        {/* Expand/collapse controls */}
        <div className="flex items-center gap-2">
          <button
            onClick={expandAll}
            className="rounded-md border border-gray-300 px-3 py-1.5 text-xs font-medium text-gray-700 hover:bg-gray-50"
          >
            Expand All
          </button>
          <button
            onClick={collapseAll}
            className="rounded-md border border-gray-300 px-3 py-1.5 text-xs font-medium text-gray-700 hover:bg-gray-50"
          >
            Collapse All
          </button>
          {canManage && (
            <AddNodeInline
              instanceId={instanceId}
              parentId={null}
              level="area"
              label="Add Area"
              onCreated={refresh}
            />
          )}
        </div>
      </div>

      {/* Search results info */}
      {searchResults && (
        <p className="text-xs text-gray-500">
          {searchResults.size} result{searchResults.size !== 1 ? "s" : ""} found
          for &ldquo;{searchQuery}&rdquo;
        </p>
      )}

      {/* Tree */}
      <div className="rounded-lg border border-gray-200 bg-white">
        {initialTree.length === 0 ? (
          <div className="p-8 text-center text-sm text-gray-500">
            This curriculum is empty. Add an area to get started.
          </div>
        ) : (
          <div className="divide-y divide-gray-100">
            {initialTree.map((node) => (
              <TreeNode
                key={node.id}
                node={node}
                instanceId={instanceId}
                expandedNodes={expandedNodes}
                searchResults={searchResults}
                canManage={canManage}
                onToggleExpand={toggleExpanded}
                onRefresh={refresh}
                isPending={isPending}
              />
            ))}
          </div>
        )}
      </div>
    </div>
  );
}

// ============================================================
// TreeNode - recursive tree node component
// ============================================================
interface TreeNodeProps {
  node: CurriculumTreeNode;
  instanceId: string;
  expandedNodes: Set<string>;
  searchResults: Set<string> | null;
  canManage: boolean;
  onToggleExpand: (id: string) => void;
  onRefresh: () => void;
  isPending: boolean;
}

function TreeNode({
  node,
  instanceId,
  expandedNodes,
  searchResults,
  canManage,
  onToggleExpand,
  onRefresh,
  isPending,
}: TreeNodeProps) {
  const [isEditing, setIsEditing] = useState(false);
  const [editTitle, setEditTitle] = useState(node.title);
  const [isActioning, setIsActioning] = useState(false);

  const config = LEVEL_CONFIG[node.level];
  const isExpanded = expandedNodes.has(node.id);
  const hasChildren = node.children.length > 0;
  const isMatch = searchResults?.has(node.id) ?? false;
  const indent = config.indent;

  // If searching and this node (and none of its descendants) match, hide it
  if (searchResults && !isMatch && !hasDescendantMatch(node, searchResults)) {
    return null;
  }

  async function handleSaveEdit() {
    if (!editTitle.trim() || editTitle.trim() === node.title) {
      setIsEditing(false);
      setEditTitle(node.title);
      return;
    }

    setIsActioning(true);
    await updateCurriculumNode(node.id, { title: editTitle.trim() });
    setIsEditing(false);
    setIsActioning(false);
    onRefresh();
  }

  async function handleDelete() {
    if (!confirm(`Delete "${node.title}" and all its children?`)) return;
    setIsActioning(true);
    await deleteCurriculumNode(node.id);
    setIsActioning(false);
    onRefresh();
  }

  async function handleToggleVisibility() {
    setIsActioning(true);
    await toggleNodeVisibility(node.id);
    setIsActioning(false);
    onRefresh();
  }

  async function handleReorder(direction: "up" | "down") {
    setIsActioning(true);
    await reorderCurriculumNode(node.id, direction);
    setIsActioning(false);
    onRefresh();
  }

  return (
    <div>
      <div
        className={`group flex items-center gap-2 px-4 py-2.5 transition-colors hover:bg-gray-50 ${
          node.is_hidden ? "opacity-50" : ""
        } ${isMatch ? "bg-amber-50" : ""}`}
        style={{ paddingLeft: `${indent * 24 + 16}px` }}
      >
        {/* Expand/collapse toggle */}
        <button
          onClick={() => onToggleExpand(node.id)}
          className={`flex h-5 w-5 flex-shrink-0 items-center justify-center rounded text-gray-400 hover:text-gray-600 ${
            !hasChildren ? "invisible" : ""
          }`}
        >
          <svg
            className={`h-3.5 w-3.5 transition-transform ${isExpanded ? "rotate-90" : ""}`}
            fill="none"
            viewBox="0 0 24 24"
            strokeWidth={2}
            stroke="currentColor"
          >
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              d="m8.25 4.5 7.5 7.5-7.5 7.5"
            />
          </svg>
        </button>

        {/* Level badge */}
        <span
          className={`inline-flex flex-shrink-0 rounded px-1.5 py-0.5 text-[10px] font-semibold uppercase ${config.color} ${config.bgColor} border`}
        >
          {config.label}
        </span>

        {/* Title (editable) */}
        {isEditing ? (
          <input
            type="text"
            value={editTitle}
            onChange={(e) => setEditTitle(e.target.value)}
            onBlur={handleSaveEdit}
            onKeyDown={(e) => {
              if (e.key === "Enter") handleSaveEdit();
              if (e.key === "Escape") {
                setIsEditing(false);
                setEditTitle(node.title);
              }
            }}
            autoFocus
            className="min-w-0 flex-1 rounded border border-amber-300 px-2 py-0.5 text-sm focus:outline-none focus:ring-1 focus:ring-ring"
          />
        ) : (
          <span
            className={`min-w-0 flex-1 truncate text-sm ${
              node.is_hidden
                ? "italic text-gray-400 line-through"
                : "text-gray-900"
            }`}
            onDoubleClick={() => {
              if (canManage) {
                setIsEditing(true);
                setEditTitle(node.title);
              }
            }}
          >
            {node.title}
          </span>
        )}

        {/* Child count */}
        {hasChildren && !isExpanded && (
          <span className="flex-shrink-0 text-xs text-gray-400">
            ({node.children.length})
          </span>
        )}

        {/* Action buttons (visible on hover) */}
        {canManage && !isEditing && (
          <div className="flex flex-shrink-0 items-center gap-1 opacity-0 transition-opacity group-hover:opacity-100">
            {/* Edit */}
            <ActionBtn
              title="Rename"
              onClick={() => {
                setIsEditing(true);
                setEditTitle(node.title);
              }}
              disabled={isActioning}
            >
              <svg
                className="h-3.5 w-3.5"
                fill="none"
                viewBox="0 0 24 24"
                strokeWidth={1.5}
                stroke="currentColor"
              >
                <path
                  strokeLinecap="round"
                  strokeLinejoin="round"
                  d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10"
                />
              </svg>
            </ActionBtn>

            {/* Move up */}
            <ActionBtn
              title="Move up"
              onClick={() => handleReorder("up")}
              disabled={isActioning}
            >
              <svg
                className="h-3.5 w-3.5"
                fill="none"
                viewBox="0 0 24 24"
                strokeWidth={1.5}
                stroke="currentColor"
              >
                <path
                  strokeLinecap="round"
                  strokeLinejoin="round"
                  d="M4.5 15.75l7.5-7.5 7.5 7.5"
                />
              </svg>
            </ActionBtn>

            {/* Move down */}
            <ActionBtn
              title="Move down"
              onClick={() => handleReorder("down")}
              disabled={isActioning}
            >
              <svg
                className="h-3.5 w-3.5"
                fill="none"
                viewBox="0 0 24 24"
                strokeWidth={1.5}
                stroke="currentColor"
              >
                <path
                  strokeLinecap="round"
                  strokeLinejoin="round"
                  d="M19.5 8.25l-7.5 7.5-7.5-7.5"
                />
              </svg>
            </ActionBtn>

            {/* Toggle visibility */}
            <ActionBtn
              title={node.is_hidden ? "Show" : "Hide"}
              onClick={handleToggleVisibility}
              disabled={isActioning}
            >
              {node.is_hidden ? (
                <svg
                  className="h-3.5 w-3.5"
                  fill="none"
                  viewBox="0 0 24 24"
                  strokeWidth={1.5}
                  stroke="currentColor"
                >
                  <path
                    strokeLinecap="round"
                    strokeLinejoin="round"
                    d="M2.036 12.322a1.012 1.012 0 0 1 0-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178Z"
                  />
                  <path
                    strokeLinecap="round"
                    strokeLinejoin="round"
                    d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z"
                  />
                </svg>
              ) : (
                <svg
                  className="h-3.5 w-3.5"
                  fill="none"
                  viewBox="0 0 24 24"
                  strokeWidth={1.5}
                  stroke="currentColor"
                >
                  <path
                    strokeLinecap="round"
                    strokeLinejoin="round"
                    d="M3.98 8.223A10.477 10.477 0 0 0 1.934 12C3.226 16.338 7.244 19.5 12 19.5c.993 0 1.953-.138 2.863-.395M6.228 6.228A10.451 10.451 0 0 1 12 4.5c4.756 0 8.773 3.162 10.065 7.498a10.522 10.522 0 0 1-4.293 5.774M6.228 6.228 3 3m3.228 3.228 3.65 3.65m7.894 7.894L21 21m-3.228-3.228-3.65-3.65m0 0a3 3 0 1 0-4.243-4.243m4.242 4.242L9.88 9.88"
                  />
                </svg>
              )}
            </ActionBtn>

            {/* Delete */}
            <ActionBtn
              title="Delete"
              onClick={handleDelete}
              disabled={isActioning}
              danger
            >
              <svg
                className="h-3.5 w-3.5"
                fill="none"
                viewBox="0 0 24 24"
                strokeWidth={1.5}
                stroke="currentColor"
              >
                <path
                  strokeLinecap="round"
                  strokeLinejoin="round"
                  d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0"
                />
              </svg>
            </ActionBtn>
          </div>
        )}
      </div>

      {/* Children */}
      {isExpanded && hasChildren && (
        <div>
          {node.children.map((child) => (
            <TreeNode
              key={child.id}
              node={child}
              instanceId={instanceId}
              expandedNodes={expandedNodes}
              searchResults={searchResults}
              canManage={canManage}
              onToggleExpand={onToggleExpand}
              onRefresh={onRefresh}
              isPending={isPending}
            />
          ))}
        </div>
      )}

      {/* Add child button (at the bottom of expanded children) */}
      {isExpanded && canManage && config.addChildLevel && (
        <div style={{ paddingLeft: `${(indent + 1) * 24 + 16}px` }}>
          <AddNodeInline
            instanceId={instanceId}
            parentId={node.id}
            level={config.addChildLevel as CurriculumLevel}
            label={config.addChildLabel}
            onCreated={onRefresh}
          />
        </div>
      )}
    </div>
  );
}

// ============================================================
// AddNodeInline - inline form to add a new child node
// ============================================================
interface AddNodeInlineProps {
  instanceId: string;
  parentId: string | null;
  level: CurriculumLevel;
  label: string;
  onCreated: () => void;
}

function AddNodeInline({
  instanceId,
  parentId,
  level,
  label,
  onCreated,
}: AddNodeInlineProps) {
  const [isOpen, setIsOpen] = useState(false);
  const [title, setTitle] = useState("");
  const [isLoading, setIsLoading] = useState(false);

  async function handleCreate() {
    if (!title.trim()) return;

    setIsLoading(true);
    const result = await createCurriculumNode({
      instanceId,
      parentId,
      level,
      title: title.trim(),
    });

    setIsLoading(false);

    if (result.data) {
      setTitle("");
      setIsOpen(false);
      onCreated();
    }
  }

  if (!isOpen) {
    return (
      <button
        onClick={() => setIsOpen(true)}
        className="flex items-center gap-1 px-2 py-1.5 text-xs text-gray-400 transition-colors hover:text-amber-600"
      >
        <svg
          className="h-3.5 w-3.5"
          fill="none"
          viewBox="0 0 24 24"
          strokeWidth={1.5}
          stroke="currentColor"
        >
          <path
            strokeLinecap="round"
            strokeLinejoin="round"
            d="M12 4.5v15m7.5-7.5h-15"
          />
        </svg>
        {label}
      </button>
    );
  }

  return (
    <div className="flex items-center gap-2 px-2 py-1.5">
      <input
        type="text"
        value={title}
        onChange={(e) => setTitle(e.target.value)}
        onKeyDown={(e) => {
          if (e.key === "Enter") handleCreate();
          if (e.key === "Escape") {
            setIsOpen(false);
            setTitle("");
          }
        }}
        placeholder={`New ${level}...`}
        autoFocus
        className="min-w-0 flex-1 rounded border border-gray-300 px-2 py-1 text-xs focus:border-ring focus:outline-none focus:ring-1 focus:ring-ring"
      />
      <button
        onClick={handleCreate}
        disabled={isLoading || !title.trim()}
        className="rounded bg-amber-600 px-2 py-1 text-xs font-medium text-white hover:bg-amber-700 disabled:opacity-50"
      >
        {isLoading ? "..." : "Add"}
      </button>
      <button
        onClick={() => {
          setIsOpen(false);
          setTitle("");
        }}
        className="rounded border border-gray-300 px-2 py-1 text-xs text-gray-600 hover:bg-gray-50"
      >
        Cancel
      </button>
    </div>
  );
}

// ============================================================
// ActionBtn - small icon button for tree node actions
// ============================================================
function ActionBtn({
  title,
  onClick,
  disabled,
  danger,
  children,
}: {
  title: string;
  onClick: () => void;
  disabled?: boolean;
  danger?: boolean;
  children: React.ReactNode;
}) {
  return (
    <button
      title={title}
      onClick={(e) => {
        e.stopPropagation();
        onClick();
      }}
      disabled={disabled}
      className={`rounded p-1 transition-colors disabled:opacity-50 ${
        danger
          ? "text-gray-400 hover:bg-red-50 hover:text-red-600"
          : "text-gray-400 hover:bg-gray-100 hover:text-gray-700"
      }`}
    >
      {children}
    </button>
  );
}

// ============================================================
// Helper: Check if any descendant of a node matches search
// ============================================================
function hasDescendantMatch(
  node: CurriculumTreeNode,
  searchResults: Set<string>,
): boolean {
  for (const child of node.children) {
    if (searchResults.has(child.id)) return true;
    if (hasDescendantMatch(child, searchResults)) return true;
  }
  return false;
}



===== D:\.code\wattleos\src\components\domain\curriculum\fork-template-button.tsx =====

'use client';

import { useState } from 'react';
import { useRouter } from 'next/navigation';
import { forkCurriculumTemplate } from '@/lib/actions/curriculum';

interface ForkTemplateButtonProps {
  templateId: string;
  templateName: string;
}

export function ForkTemplateButton({
  templateId,
  templateName,
}: ForkTemplateButtonProps) {
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const router = useRouter();

  async function handleFork() {
    setIsLoading(true);
    setError(null);

    const result = await forkCurriculumTemplate(
      templateId,
      templateName
    );

    if (result.error) {
      setError(result.error.message);
      setIsLoading(false);
      return;
    }

    if (result.data) {
      router.push(`/pedagogy/curriculum/${result.data.id}`);
      router.refresh();
    }
  }

  return (
    <div>
      <button
        onClick={handleFork}
        disabled={isLoading}
        className="rounded-md bg-purple-600 px-3 py-1.5 text-xs font-medium text-white transition-colors hover:bg-purple-700 disabled:cursor-not-allowed disabled:opacity-50"
      >
        {isLoading ? 'Creating...' : 'Use This Template'}
      </button>
      {error && <p className="mt-1 text-xs text-red-600">{error}</p>}
    </div>
  );
}



===== D:\.code\wattleos\src\components\domain\mastery\class-heatmap.tsx =====

'use client';

import { useState } from 'react';
import type { MasteryStatus } from '@/types/domain';
import type { ClassHeatmapRow } from '@/lib/actions/mastery';
import type { CurriculumTreeNode } from '@/lib/utils/curriculum-tree';
import { MASTERY_STATUS_CONFIG, MASTERY_STATUS_ORDER } from '@/lib/utils/mastery-status';

// ============================================================
// Props
// ============================================================
interface ClassHeatmapProps {
  rows: ClassHeatmapRow[];
  tree: CurriculumTreeNode[];
  instanceName: string;
}

// ============================================================
// ClassHeatmap
// ============================================================
export function ClassHeatmap({ rows, tree, instanceName }: ClassHeatmapProps) {
  const [selectedArea, setSelectedArea] = useState<string | null>(
    tree.length > 0 ? tree[0].id : null
  );
  const [hoveredCell, setHoveredCell] = useState<{
    studentName: string;
    outcomeName: string;
    status: MasteryStatus;
  } | null>(null);

  // Get outcomes for the selected area
  const selectedAreaNode = tree.find((a) => a.id === selectedArea);
  const outcomes: { id: string; title: string; strandTitle: string }[] = [];

  if (selectedAreaNode) {
    for (const strand of selectedAreaNode.children) {
      for (const outcome of strand.children) {
        if (outcome.level === 'outcome') {
          outcomes.push({
            id: outcome.id,
            title: outcome.title,
            strandTitle: strand.title,
          });
        }
      }
    }
  }

  return (
    <div className="space-y-4">
      {/* Area selector tabs */}
      <div className="flex flex-wrap gap-2">
        {tree.map((area) => (
          <button
            key={area.id}
            onClick={() => setSelectedArea(area.id)}
            className={`rounded-lg px-3 py-1.5 text-sm font-medium transition-colors ${
              selectedArea === area.id
                ? 'bg-purple-600 text-white'
                : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
            }`}
          >
            {area.title}
          </button>
        ))}
      </div>

      {/* Legend */}
      <div className="flex items-center gap-4">
        {MASTERY_STATUS_ORDER.map((status) => {
          const config = MASTERY_STATUS_CONFIG[status];
          return (
            <div key={status} className="flex items-center gap-1.5">
              <span
                className="inline-block h-3 w-3 rounded-sm"
                style={{ backgroundColor: config.heatmapColor }}
              />
              <span className="text-xs text-gray-600">{config.label}</span>
            </div>
          );
        })}
      </div>

      {/* Hover tooltip */}
      {hoveredCell && (
        <div className="rounded-md border border-gray-200 bg-white px-3 py-2 text-xs shadow-sm">
          <span className="font-semibold">{hoveredCell.studentName}</span>
          {' - '}
          <span className="text-gray-600">{hoveredCell.outcomeName}</span>
          {' - '}
          <span className={MASTERY_STATUS_CONFIG[hoveredCell.status].color}>
            {MASTERY_STATUS_CONFIG[hoveredCell.status].label}
          </span>
        </div>
      )}

      {/* Heatmap grid */}
      {outcomes.length === 0 ? (
        <div className="rounded-lg border border-gray-200 bg-white p-8 text-center text-sm text-gray-500">
          Select an area to view the heatmap.
        </div>
      ) : rows.length === 0 ? (
        <div className="rounded-lg border border-gray-200 bg-white p-8 text-center text-sm text-gray-500">
          No students to display. Add students to this class first.
        </div>
      ) : (
        <div className="overflow-x-auto rounded-lg border border-gray-200 bg-white">
          <table className="min-w-full">
            <thead>
              <tr>
                <th className="sticky left-0 z-10 border-b border-r border-gray-200 bg-gray-50 px-3 py-2 text-left text-xs font-semibold text-gray-700">
                  Student
                </th>
                {outcomes.map((outcome) => (
                  <th
                    key={outcome.id}
                    className="border-b border-gray-200 px-1 py-2 text-center"
                    title={`${outcome.strandTitle} â†’ ${outcome.title}`}
                  >
                    <div className="w-8">
                      <span className="block truncate text-[9px] font-normal text-gray-500">
                        {abbreviate(outcome.title)}
                      </span>
                    </div>
                  </th>
                ))}
              </tr>
            </thead>
            <tbody>
              {rows.map((row) => (
                <tr key={row.student_id} className="hover:bg-gray-50">
                  <td className="sticky left-0 z-10 border-r border-gray-100 bg-white px-3 py-1.5 text-xs font-medium text-gray-900">
                    {row.student_first_name} {row.student_last_name}
                  </td>
                  {outcomes.map((outcome) => {
                    const status: MasteryStatus =
                      row.statuses[outcome.id] ?? 'not_started';
                    const config = MASTERY_STATUS_CONFIG[status];
                    return (
                      <td
                        key={outcome.id}
                        className="border-gray-50 px-0.5 py-0.5 text-center"
                        onMouseEnter={() =>
                          setHoveredCell({
                            studentName: `${row.student_first_name} ${row.student_last_name}`,
                            outcomeName: outcome.title,
                            status,
                          })
                        }
                        onMouseLeave={() => setHoveredCell(null)}
                      >
                        <div
                          className="mx-auto h-6 w-6 rounded-sm transition-transform hover:scale-125"
                          style={{ backgroundColor: config.heatmapColor }}
                          title={`${row.student_first_name}: ${outcome.title} - ${config.label}`}
                        />
                      </td>
                    );
                  })}
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      )}
    </div>
  );
}

// ============================================================
// Helper: abbreviate long outcome titles for column headers
// ============================================================
function abbreviate(title: string): string {
  if (title.length <= 8) return title;
  // Take first word, or first 6 chars
  const words = title.split(' ');
  if (words[0].length <= 8) return words[0];
  return title.slice(0, 6) + 'â€¦';
}



===== D:\.code\wattleos\src\components\domain\mastery\mastery-grid.tsx =====

'use client';

import { useState, useTransition, useCallback } from 'react';
import { useRouter } from 'next/navigation';
import type { MasteryStatus, CurriculumLevel } from '@/types/domain';
import type { MasteryWithNode } from '@/lib/actions/mastery';
import { updateMasteryStatus } from '@/lib/actions/mastery';
import {
  MASTERY_STATUS_CONFIG,
  getNextMasteryStatus,
  MASTERY_STATUS_ORDER,
} from '@/lib/utils/mastery-status';
import type { CurriculumTreeNode } from '@/lib/utils/curriculum-tree';

// ============================================================
// Props
// ============================================================
interface MasteryGridProps {
  studentId: string;
  studentName: string;
  tree: CurriculumTreeNode[];
  masteryData: MasteryWithNode[];
  canManage: boolean;
  summary: {
    total: number;
    not_started: number;
    presented: number;
    practicing: number;
    mastered: number;
  };
}

// ============================================================
// MasteryGrid
// ============================================================
export function MasteryGrid({
  studentId,
  studentName,
  tree,
  masteryData,
  canManage,
  summary,
}: MasteryGridProps) {
  const [expandedAreas, setExpandedAreas] = useState<Set<string>>(() => {
    return new Set(tree.map((a) => a.id));
  });
  const [optimisticStatuses, setOptimisticStatuses] = useState<
    Record<string, MasteryStatus>
  >({});
  const [isPending, startTransition] = useTransition();
  const router = useRouter();

  // Build a lookup map: curriculum_node_id â†’ mastery status
  const statusMap = new Map<string, MasteryStatus>();
  for (const record of masteryData) {
    statusMap.set(record.curriculum_node_id, record.status);
  }

  // Apply optimistic updates on top
  for (const [nodeId, status] of Object.entries(optimisticStatuses)) {
    statusMap.set(nodeId, status);
  }

  function getStatus(nodeId: string): MasteryStatus {
    return statusMap.get(nodeId) ?? 'not_started';
  }

  const toggleArea = useCallback((areaId: string) => {
    setExpandedAreas((prev) => {
      const next = new Set(prev);
      if (next.has(areaId)) {
        next.delete(areaId);
      } else {
        next.add(areaId);
      }
      return next;
    });
  }, []);

  async function handleStatusClick(nodeId: string) {
    if (!canManage) return;

    const current = getStatus(nodeId);
    const next = getNextMasteryStatus(current);

    // Optimistic update
    setOptimisticStatuses((prev) => ({ ...prev, [nodeId]: next }));

    const result = await updateMasteryStatus({
      studentId,
      curriculumNodeId: nodeId,
      newStatus: next,
    });

    if (result.error) {
      // Revert optimistic update
      setOptimisticStatuses((prev) => {
        const copy = { ...prev };
        delete copy[nodeId];
        return copy;
      });
    } else {
      startTransition(() => {
        router.refresh();
      });
    }
  }

  async function handleStatusSelect(nodeId: string, newStatus: MasteryStatus) {
    if (!canManage) return;

    setOptimisticStatuses((prev) => ({ ...prev, [nodeId]: newStatus }));

    const result = await updateMasteryStatus({
      studentId,
      curriculumNodeId: nodeId,
      newStatus,
    });

    if (result.error) {
      setOptimisticStatuses((prev) => {
        const copy = { ...prev };
        delete copy[nodeId];
        return copy;
      });
    } else {
      startTransition(() => {
        router.refresh();
      });
    }
  }

  return (
    <div className="space-y-6">
      {/* Summary bar */}
      <div className="rounded-lg border border-gray-200 bg-white p-4">
        <div className="mb-3 flex items-center justify-between">
          <h3 className="text-sm font-semibold text-gray-900">
            Progress Overview
          </h3>
          <span className="text-xs text-gray-500">
            {summary.mastered} of {summary.total} outcomes mastered
          </span>
        </div>

        {/* Progress bar */}
        <div className="mb-3 flex h-3 overflow-hidden rounded-full bg-gray-100">
          {summary.total > 0 && (
            <>
              <div
                className="bg-green-400 transition-all"
                style={{
                  width: `${(summary.mastered / summary.total) * 100}%`,
                }}
              />
              <div
                className="bg-amber-400 transition-all"
                style={{
                  width: `${(summary.practicing / summary.total) * 100}%`,
                }}
              />
              <div
                className="bg-blue-400 transition-all"
                style={{
                  width: `${(summary.presented / summary.total) * 100}%`,
                }}
              />
            </>
          )}
        </div>

        {/* Legend */}
        <div className="flex flex-wrap gap-4">
          {MASTERY_STATUS_ORDER.map((status) => {
            const config = MASTERY_STATUS_CONFIG[status];
            const count = summary[status];
            return (
              <div key={status} className="flex items-center gap-1.5">
                <span className={`inline-block h-2.5 w-2.5 rounded-full ${config.dotColor}`} />
                <span className="text-xs text-gray-600">
                  {config.label}: <span className="font-semibold">{count}</span>
                </span>
              </div>
            );
          })}
        </div>
      </div>

      {/* Curriculum tree with mastery statuses */}
      <div className="space-y-3">
        {tree.map((area) => (
          <AreaSection
            key={area.id}
            area={area}
            isExpanded={expandedAreas.has(area.id)}
            onToggle={() => toggleArea(area.id)}
            getStatus={getStatus}
            canManage={canManage}
            onStatusClick={handleStatusClick}
            onStatusSelect={handleStatusSelect}
          />
        ))}
      </div>
    </div>
  );
}

// ============================================================
// AreaSection - collapsible area with strands/outcomes
// ============================================================
function AreaSection({
  area,
  isExpanded,
  onToggle,
  getStatus,
  canManage,
  onStatusClick,
  onStatusSelect,
}: {
  area: CurriculumTreeNode;
  isExpanded: boolean;
  onToggle: () => void;
  getStatus: (nodeId: string) => MasteryStatus;
  canManage: boolean;
  onStatusClick: (nodeId: string) => void;
  onStatusSelect: (nodeId: string, status: MasteryStatus) => void;
}) {
  // Count statuses within this area
  const outcomes = collectOutcomes(area);
  const counts = { mastered: 0, practicing: 0, presented: 0, not_started: 0 };
  for (const o of outcomes) {
    counts[getStatus(o.id)]++;
  }

  return (
    <div className="overflow-hidden rounded-lg border border-gray-200 bg-white">
      {/* Area header */}
      <button
        onClick={onToggle}
        className="flex w-full items-center justify-between px-4 py-3 text-left transition-colors hover:bg-gray-50"
      >
        <div className="flex items-center gap-3">
          <svg
            className={`h-4 w-4 text-gray-400 transition-transform ${isExpanded ? 'rotate-90' : ''}`}
            fill="none"
            viewBox="0 0 24 24"
            strokeWidth={2}
            stroke="currentColor"
          >
            <path strokeLinecap="round" strokeLinejoin="round" d="m8.25 4.5 7.5 7.5-7.5 7.5" />
          </svg>
          <span className="inline-flex rounded bg-purple-100 px-2 py-0.5 text-[10px] font-semibold uppercase text-purple-700">
            Area
          </span>
          <span className="text-sm font-semibold text-gray-900">
            {area.title}
          </span>
        </div>

        {/* Mini progress indicator */}
        <div className="flex items-center gap-2">
          <div className="flex h-2 w-24 overflow-hidden rounded-full bg-gray-100">
            {outcomes.length > 0 && (
              <>
                <div className="bg-green-400" style={{ width: `${(counts.mastered / outcomes.length) * 100}%` }} />
                <div className="bg-amber-400" style={{ width: `${(counts.practicing / outcomes.length) * 100}%` }} />
                <div className="bg-blue-400" style={{ width: `${(counts.presented / outcomes.length) * 100}%` }} />
              </>
            )}
          </div>
          <span className="text-xs text-gray-500">
            {counts.mastered}/{outcomes.length}
          </span>
        </div>
      </button>

      {/* Strands and outcomes */}
      {isExpanded && (
        <div className="border-t border-gray-100">
          {area.children.map((strand) => (
            <StrandSection
              key={strand.id}
              strand={strand}
              getStatus={getStatus}
              canManage={canManage}
              onStatusClick={onStatusClick}
              onStatusSelect={onStatusSelect}
            />
          ))}
        </div>
      )}
    </div>
  );
}

// ============================================================
// StrandSection - strand header + outcome rows
// ============================================================
function StrandSection({
  strand,
  getStatus,
  canManage,
  onStatusClick,
  onStatusSelect,
}: {
  strand: CurriculumTreeNode;
  getStatus: (nodeId: string) => MasteryStatus;
  canManage: boolean;
  onStatusClick: (nodeId: string) => void;
  onStatusSelect: (nodeId: string, status: MasteryStatus) => void;
}) {
  return (
    <div>
      <div className="bg-gray-50 px-4 py-2 pl-10">
        <div className="flex items-center gap-2">
          <span className="inline-flex rounded bg-blue-100 px-1.5 py-0.5 text-[9px] font-semibold uppercase text-blue-700">
            Strand
          </span>
          <span className="text-xs font-semibold text-gray-700">
            {strand.title}
          </span>
        </div>
      </div>
      <div className="divide-y divide-gray-50">
        {strand.children.map((outcome) => (
          <OutcomeRow
            key={outcome.id}
            outcome={outcome}
            status={getStatus(outcome.id)}
            canManage={canManage}
            onStatusClick={onStatusClick}
            onStatusSelect={onStatusSelect}
          />
        ))}
      </div>
    </div>
  );
}

// ============================================================
// OutcomeRow - single outcome with clickable status badge
// ============================================================
function OutcomeRow({
  outcome,
  status,
  canManage,
  onStatusClick,
  onStatusSelect,
}: {
  outcome: CurriculumTreeNode;
  status: MasteryStatus;
  canManage: boolean;
  onStatusClick: (nodeId: string) => void;
  onStatusSelect: (nodeId: string, status: MasteryStatus) => void;
}) {
  const [showPicker, setShowPicker] = useState(false);
  const config = MASTERY_STATUS_CONFIG[status];

  return (
    <div className="group flex items-center justify-between px-4 py-2 pl-14 transition-colors hover:bg-gray-50">
      <span className="mr-3 min-w-0 flex-1 text-sm text-gray-800">
        {outcome.title}
      </span>

      <div className="relative flex-shrink-0">
        {/* Status badge - click to cycle, right-click/long-press for picker */}
        <button
          onClick={() => {
            if (canManage) onStatusClick(outcome.id);
          }}
          onContextMenu={(e) => {
            if (canManage) {
              e.preventDefault();
              setShowPicker(!showPicker);
            }
          }}
          disabled={!canManage}
          className={`inline-flex items-center gap-1 rounded-full px-2.5 py-1 text-xs font-medium transition-all ${config.bgColor} ${config.color} ${config.borderColor} border ${
            canManage
              ? 'cursor-pointer hover:shadow-sm active:scale-95'
              : 'cursor-default'
          }`}
          title={
            canManage
              ? `Click to advance Â· Right-click for picker Â· ${config.description}`
              : config.description
          }
        >
          <span className={`inline-block h-2 w-2 rounded-full ${config.dotColor}`} />
          {config.label}
        </button>

        {/* Status picker dropdown */}
        {showPicker && (
          <>
            <div
              className="fixed inset-0 z-10"
              onClick={() => setShowPicker(false)}
            />
            <div className="absolute right-0 top-full z-20 mt-1 w-40 rounded-lg border border-gray-200 bg-white py-1 shadow-lg">
              {MASTERY_STATUS_ORDER.map((s) => {
                const c = MASTERY_STATUS_CONFIG[s];
                return (
                  <button
                    key={s}
                    onClick={() => {
                      onStatusSelect(outcome.id, s);
                      setShowPicker(false);
                    }}
                    className={`flex w-full items-center gap-2 px-3 py-1.5 text-left text-xs transition-colors hover:bg-gray-50 ${
                      s === status ? 'font-semibold' : ''
                    }`}
                  >
                    <span className={`inline-block h-2 w-2 rounded-full ${c.dotColor}`} />
                    <span className={c.color}>{c.label}</span>
                    {s === status && (
                      <svg className="ml-auto h-3 w-3 text-gray-500" fill="none" viewBox="0 0 24 24" strokeWidth={2} stroke="currentColor">
                        <path strokeLinecap="round" strokeLinejoin="round" d="m4.5 12.75 6 6 9-13.5" />
                      </svg>
                    )}
                  </button>
                );
              })}
            </div>
          </>
        )}
      </div>
    </div>
  );
}

// ============================================================
// Helper: Collect all outcome-level descendants of a node
// ============================================================
function collectOutcomes(node: CurriculumTreeNode): CurriculumTreeNode[] {
  const outcomes: CurriculumTreeNode[] = [];
  if (node.level === 'outcome') {
    outcomes.push(node);
  }
  for (const child of node.children) {
    outcomes.push(...collectOutcomes(child));
  }
  return outcomes;
}



===== D:\.code\wattleos\src\components\domain\mastery\mastery-history-panel.tsx =====

'use client';

import type { MasteryHistoryWithMeta } from '@/lib/actions/mastery';
import { MASTERY_STATUS_CONFIG } from '@/lib/utils/mastery-status';
import type { MasteryStatus } from '@/types/domain';

interface MasteryHistoryPanelProps {
  history: MasteryHistoryWithMeta[];
  showTitle?: boolean;
}

export function MasteryHistoryPanel({
  history,
  showTitle = true,
}: MasteryHistoryPanelProps) {
  if (history.length === 0) {
    return (
      <div className="rounded-lg border border-gray-200 bg-white p-4 text-center text-xs text-gray-500">
        No mastery changes recorded yet.
      </div>
    );
  }

  return (
    <div className="rounded-lg border border-gray-200 bg-white">
      {showTitle && (
        <div className="border-b border-gray-100 px-4 py-3">
          <h3 className="text-sm font-semibold text-gray-900">
            Recent Progress
          </h3>
        </div>
      )}

      <div className="divide-y divide-gray-50">
        {history.map((entry) => {
          const newConfig =
            MASTERY_STATUS_CONFIG[entry.new_status as MasteryStatus];
          const prevConfig = entry.previous_status
            ? MASTERY_STATUS_CONFIG[entry.previous_status as MasteryStatus]
            : null;

          const changedByName = entry.changed_by_user
            ? `${entry.changed_by_user.first_name ?? ''} ${entry.changed_by_user.last_name ?? ''}`.trim()
            : 'System';

          const date = new Date(entry.changed_at);
          const dateStr = date.toLocaleDateString('en-AU', {
            day: 'numeric',
            month: 'short',
          });
          const timeStr = date.toLocaleTimeString('en-AU', {
            hour: '2-digit',
            minute: '2-digit',
          });

          return (
            <div key={entry.id} className="px-4 py-3">
              <div className="flex items-start justify-between">
                <div className="min-w-0 flex-1">
                  <p className="truncate text-xs font-medium text-gray-900">
                    {entry.curriculum_node_title || 'Unknown outcome'}
                  </p>
                  <div className="mt-1 flex items-center gap-1.5">
                    {prevConfig && (
                      <>
                        <span
                          className={`inline-flex items-center rounded-full px-1.5 py-0.5 text-[10px] font-medium ${prevConfig.bgColor} ${prevConfig.color}`}
                        >
                          {prevConfig.shortLabel}
                        </span>
                        <svg
                          className="h-2.5 w-2.5 text-gray-400"
                          fill="none"
                          viewBox="0 0 24 24"
                          strokeWidth={2}
                          stroke="currentColor"
                        >
                          <path
                            strokeLinecap="round"
                            strokeLinejoin="round"
                            d="M13.5 4.5 21 12m0 0-7.5 7.5M21 12H3"
                          />
                        </svg>
                      </>
                    )}
                    <span
                      className={`inline-flex items-center rounded-full px-1.5 py-0.5 text-[10px] font-medium ${newConfig.bgColor} ${newConfig.color}`}
                    >
                      {newConfig.shortLabel}
                    </span>
                  </div>
                </div>
                <div className="ml-3 flex-shrink-0 text-right">
                  <p className="text-[10px] text-gray-500">{dateStr}</p>
                  <p className="text-[10px] text-gray-400">{timeStr}</p>
                </div>
              </div>
              <p className="mt-1 text-[10px] text-gray-400">
                by {changedByName}
              </p>
            </div>
          );
        })}
      </div>
    </div>
  );
}



===== D:\.code\wattleos\src\components\domain\mastery\portfolio-timeline.tsx =====

'use client';

import type { PortfolioTimelineItem } from '@/lib/actions/mastery';
import { MASTERY_STATUS_CONFIG } from '@/lib/utils/mastery-status';
import type { MasteryStatus } from '@/types/domain';

// ============================================================
// Props
// ============================================================
interface PortfolioTimelineProps {
  items: PortfolioTimelineItem[];
  studentName: string;
}

// ============================================================
// PortfolioTimeline
// ============================================================
export function PortfolioTimeline({
  items,
  studentName,
}: PortfolioTimelineProps) {
  if (items.length === 0) {
    return (
      <div className="rounded-lg border border-gray-200 bg-white p-8 text-center">
        <svg
          className="mx-auto h-12 w-12 text-gray-300"
          fill="none"
          viewBox="0 0 24 24"
          strokeWidth={1}
          stroke="currentColor"
        >
          <path
            strokeLinecap="round"
            strokeLinejoin="round"
            d="M12 6.042A8.967 8.967 0 0 0 6 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 0 1 6 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 0 1 6-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0 0 18 18a8.967 8.967 0 0 0-6 2.292m0-14.25v14.25"
          />
        </svg>
        <h3 className="mt-3 text-sm font-semibold text-gray-900">
          No portfolio entries yet
        </h3>
        <p className="mt-1 text-xs text-gray-500">
          {studentName}&apos;s learning journey will appear here as observations are
          published and mastery milestones are reached.
        </p>
      </div>
    );
  }

  // Group items by date
  const groupedByDate = new Map<string, PortfolioTimelineItem[]>();
  for (const item of items) {
    const dateKey = new Date(item.date).toLocaleDateString('en-AU', {
      weekday: 'long',
      year: 'numeric',
      month: 'long',
      day: 'numeric',
    });
    if (!groupedByDate.has(dateKey)) {
      groupedByDate.set(dateKey, []);
    }
    groupedByDate.get(dateKey)!.push(item);
  }

  return (
    <div className="space-y-6">
      {Array.from(groupedByDate.entries()).map(([dateLabel, dateItems]) => (
        <div key={dateLabel}>
          {/* Date header */}
          <div className="mb-3 flex items-center gap-3">
            <div className="h-px flex-1 bg-gray-200" />
            <span className="text-xs font-medium text-gray-500">
              {dateLabel}
            </span>
            <div className="h-px flex-1 bg-gray-200" />
          </div>

          {/* Items for this date */}
          <div className="space-y-3">
            {dateItems.map((item, idx) => (
              <TimelineCard key={`${item.type}-${idx}`} item={item} />
            ))}
          </div>
        </div>
      ))}
    </div>
  );
}

// ============================================================
// TimelineCard - renders a single timeline entry
// ============================================================
function TimelineCard({ item }: { item: PortfolioTimelineItem }) {
  if (item.type === 'observation') {
    return <ObservationCard item={item} />;
  }
  return <MasteryChangeCard item={item} />;
}

// ============================================================
// ObservationCard
// ============================================================
function ObservationCard({ item }: { item: PortfolioTimelineItem }) {
  const time = new Date(item.date).toLocaleTimeString('en-AU', {
    hour: '2-digit',
    minute: '2-digit',
  });

  return (
    <div className="rounded-lg border border-gray-200 bg-white p-4 transition-shadow hover:shadow-sm">
      <div className="mb-2 flex items-start justify-between">
        <div className="flex items-center gap-2">
          {/* Observation icon */}
          <div className="flex h-7 w-7 items-center justify-center rounded-full bg-amber-100">
            <svg
              className="h-3.5 w-3.5 text-amber-600"
              fill="none"
              viewBox="0 0 24 24"
              strokeWidth={1.5}
              stroke="currentColor"
            >
              <path
                strokeLinecap="round"
                strokeLinejoin="round"
                d="M2.036 12.322a1.012 1.012 0 0 1 0-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178Z"
              />
              <path
                strokeLinecap="round"
                strokeLinejoin="round"
                d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z"
              />
            </svg>
          </div>
          <div>
            <span className="text-xs font-semibold text-gray-900">
              Observation
            </span>
            <span className="ml-2 text-xs text-gray-500">
              by {item.observation_author}
            </span>
          </div>
        </div>
        <span className="text-xs text-gray-400">{time}</span>
      </div>

      {/* Content preview */}
      {item.observation_content && (
        <p className="mb-2 line-clamp-3 text-sm text-gray-700">
          {item.observation_content}
        </p>
      )}

      {/* Outcomes tags */}
      {item.observation_outcomes && item.observation_outcomes.length > 0 && (
        <div className="mb-2 flex flex-wrap gap-1">
          {item.observation_outcomes.map((outcome) => (
            <span
              key={outcome.id}
              className="inline-flex rounded-full bg-green-50 px-2 py-0.5 text-[10px] font-medium text-green-700"
            >
              {outcome.title}
            </span>
          ))}
        </div>
      )}

      {/* Media indicator */}
      {item.observation_media_count != null && item.observation_media_count > 0 && (
        <div className="flex items-center gap-1 text-xs text-gray-500">
          <svg
            className="h-3.5 w-3.5"
            fill="none"
            viewBox="0 0 24 24"
            strokeWidth={1.5}
            stroke="currentColor"
          >
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              d="m2.25 15.75 5.159-5.159a2.25 2.25 0 0 1 3.182 0l5.159 5.159m-1.5-1.5 1.409-1.409a2.25 2.25 0 0 1 3.182 0l2.909 2.909M3.75 21h16.5a1.5 1.5 0 0 0 1.5-1.5V6a1.5 1.5 0 0 0-1.5-1.5H3.75a1.5 1.5 0 0 0-1.5 1.5v13.5a1.5 1.5 0 0 0 1.5 1.5Z"
            />
          </svg>
          {item.observation_media_count} attachment
          {item.observation_media_count > 1 ? 's' : ''}
        </div>
      )}
    </div>
  );
}

// ============================================================
// MasteryChangeCard
// ============================================================
function MasteryChangeCard({ item }: { item: PortfolioTimelineItem }) {
  const time = new Date(item.date).toLocaleTimeString('en-AU', {
    hour: '2-digit',
    minute: '2-digit',
  });

  const newStatus = item.mastery_new_status as MasteryStatus;
  const prevStatus = item.mastery_previous_status as MasteryStatus | null;
  const newConfig = MASTERY_STATUS_CONFIG[newStatus];
  const prevConfig = prevStatus ? MASTERY_STATUS_CONFIG[prevStatus] : null;

  // Special styling for "mastered" milestone
  const isMilestone = newStatus === 'mastered';

  return (
    <div
      className={`rounded-lg border p-4 transition-shadow hover:shadow-sm ${
        isMilestone
          ? 'border-green-200 bg-green-50'
          : 'border-gray-200 bg-white'
      }`}
    >
      <div className="flex items-center justify-between">
        <div className="flex items-center gap-2">
          {/* Status icon */}
          <div
            className={`flex h-7 w-7 items-center justify-center rounded-full ${
              isMilestone ? 'bg-green-200' : newConfig.bgColor
            }`}
          >
            {isMilestone ? (
              <svg
                className="h-3.5 w-3.5 text-green-700"
                fill="none"
                viewBox="0 0 24 24"
                strokeWidth={2}
                stroke="currentColor"
              >
                <path
                  strokeLinecap="round"
                  strokeLinejoin="round"
                  d="M11.48 3.499a.562.562 0 0 1 1.04 0l2.125 5.111a.563.563 0 0 0 .475.345l5.518.442c.499.04.701.663.321.988l-4.204 3.602a.563.563 0 0 0-.182.557l1.285 5.385a.562.562 0 0 1-.84.61l-4.725-2.885a.562.562 0 0 0-.586 0L6.982 20.54a.562.562 0 0 1-.84-.61l1.285-5.386a.562.562 0 0 0-.182-.557l-4.204-3.602a.562.562 0 0 1 .321-.988l5.518-.442a.563.563 0 0 0 .475-.345L11.48 3.5Z"
                />
              </svg>
            ) : (
              <span className={`inline-block h-2.5 w-2.5 rounded-full ${newConfig.dotColor}`} />
            )}
          </div>

          <div>
            <span
              className={`text-xs font-semibold ${
                isMilestone ? 'text-green-800' : 'text-gray-900'
              }`}
            >
              {isMilestone ? 'Mastery Achieved!' : 'Progress Update'}
            </span>
            <span className="ml-2 text-xs text-gray-500">
              by {item.mastery_changed_by}
            </span>
          </div>
        </div>
        <span className="text-xs text-gray-400">{time}</span>
      </div>

      <div className="mt-2 flex items-center gap-2">
        <span className="text-sm text-gray-800">{item.mastery_node_title}</span>
        <span className="text-xs text-gray-400">â€”</span>
        {prevConfig && (
          <>
            <span
              className={`inline-flex items-center gap-1 rounded-full px-2 py-0.5 text-[10px] font-medium ${prevConfig.bgColor} ${prevConfig.color}`}
            >
              {prevConfig.label}
            </span>
            <svg
              className="h-3 w-3 text-gray-400"
              fill="none"
              viewBox="0 0 24 24"
              strokeWidth={2}
              stroke="currentColor"
            >
              <path
                strokeLinecap="round"
                strokeLinejoin="round"
                d="M13.5 4.5 21 12m0 0-7.5 7.5M21 12H3"
              />
            </svg>
          </>
        )}
        <span
          className={`inline-flex items-center gap-1 rounded-full px-2 py-0.5 text-[10px] font-medium ${newConfig.bgColor} ${newConfig.color}`}
        >
          {newConfig.label}
        </span>
      </div>
    </div>
  );
}



===== D:\.code\wattleos\src\components\domain\mastery\student-picker.tsx =====

'use client';

import { useState, useRef, useEffect } from 'react';
import type { Student } from '@/types/domain';

interface StudentPickerProps {
  students: Student[];
  selectedStudentId: string | null;
  onSelect: (studentId: string) => void;
}

export function StudentPicker({
  students,
  selectedStudentId,
  onSelect,
}: StudentPickerProps) {
  const [isOpen, setIsOpen] = useState(false);
  const [query, setQuery] = useState('');
  const dropdownRef = useRef<HTMLDivElement>(null);
  const inputRef = useRef<HTMLInputElement>(null);

  // Close on click outside
  useEffect(() => {
    function handleClickOutside(event: MouseEvent) {
      if (
        dropdownRef.current &&
        !dropdownRef.current.contains(event.target as Node)
      ) {
        setIsOpen(false);
      }
    }
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, []);

  const selected = students.find((s) => s.id === selectedStudentId);
  const filtered = students.filter((s) => {
    if (!query.trim()) return true;
    const q = query.toLowerCase();
    return (
      s.first_name.toLowerCase().includes(q) ||
      s.last_name.toLowerCase().includes(q) ||
      (s.preferred_name?.toLowerCase().includes(q) ?? false)
    );
  });

  return (
    <div className="relative" ref={dropdownRef}>
      {/* Trigger button */}
      <button
        onClick={() => {
          setIsOpen(!isOpen);
          if (!isOpen) {
            setTimeout(() => inputRef.current?.focus(), 50);
          }
        }}
        className="flex items-center gap-2 rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm transition-colors hover:bg-gray-50"
      >
        {selected ? (
          <>
            {selected.photo_url ? (
              <img
                src={selected.photo_url}
                alt=""
                className="h-6 w-6 rounded-full object-cover"
              />
            ) : (
              <div className="flex h-6 w-6 items-center justify-center rounded-full bg-amber-100 text-[10px] font-semibold text-amber-700">
                {selected.first_name.charAt(0)}
                {selected.last_name.charAt(0)}
              </div>
            )}
            <span className="font-medium text-gray-900">
              {selected.preferred_name ?? selected.first_name}{' '}
              {selected.last_name}
            </span>
          </>
        ) : (
          <span className="text-gray-500">Select a student...</span>
        )}
        <svg
          className="ml-1 h-4 w-4 text-gray-400"
          fill="none"
          viewBox="0 0 24 24"
          strokeWidth={1.5}
          stroke="currentColor"
        >
          <path
            strokeLinecap="round"
            strokeLinejoin="round"
            d="m19.5 8.25-7.5 7.5-7.5-7.5"
          />
        </svg>
      </button>

      {/* Dropdown */}
      {isOpen && (
        <div className="absolute left-0 top-full z-20 mt-1 w-72 rounded-lg border border-gray-200 bg-white shadow-lg">
          {/* Search input */}
          <div className="border-b border-gray-100 p-2">
            <input
              ref={inputRef}
              type="text"
              value={query}
              onChange={(e) => setQuery(e.target.value)}
              placeholder="Search students..."
              className="w-full rounded border border-gray-200 px-2 py-1.5 text-sm focus:border-amber-400 focus:outline-none focus:ring-1 focus:ring-amber-400"
            />
          </div>

          {/* Student list */}
          <div className="max-h-64 overflow-y-auto py-1">
            {filtered.length === 0 ? (
              <div className="px-3 py-2 text-xs text-gray-500">
                No students found.
              </div>
            ) : (
              filtered.map((student) => (
                <button
                  key={student.id}
                  onClick={() => {
                    onSelect(student.id);
                    setIsOpen(false);
                    setQuery('');
                  }}
                  className={`flex w-full items-center gap-2 px-3 py-2 text-left text-sm transition-colors hover:bg-gray-50 ${
                    student.id === selectedStudentId ? 'bg-amber-50' : ''
                  }`}
                >
                  {student.photo_url ? (
                    <img
                      src={student.photo_url}
                      alt=""
                      className="h-7 w-7 rounded-full object-cover"
                    />
                  ) : (
                    <div className="flex h-7 w-7 items-center justify-center rounded-full bg-gray-100 text-[10px] font-semibold text-gray-600">
                      {student.first_name.charAt(0)}
                      {student.last_name.charAt(0)}
                    </div>
                  )}
                  <div>
                    <span className="font-medium text-gray-900">
                      {student.preferred_name ?? student.first_name}{' '}
                      {student.last_name}
                    </span>
                  </div>
                  {student.id === selectedStudentId && (
                    <svg
                      className="ml-auto h-4 w-4 text-amber-600"
                      fill="none"
                      viewBox="0 0 24 24"
                      strokeWidth={2}
                      stroke="currentColor"
                    >
                      <path
                        strokeLinecap="round"
                        strokeLinejoin="round"
                        d="m4.5 12.75 6 6 9-13.5"
                      />
                    </svg>
                  )}
                </button>
              ))
            )}
          </div>
        </div>
      )}
    </div>
  );
}



===== D:\.code\wattleos\src\components\domain\observations\feed-filters.tsx =====

"use client";

import { useRouter, useSearchParams } from "next/navigation";

interface FeedFiltersProps {
  students: Array<{ id: string; name: string }>;
  currentStatus?: string;
  currentStudentId?: string;
}

const STATUS_TABS = [
  { value: undefined, label: "All" },
  { value: "draft", label: "Drafts" },
  { value: "published", label: "Published" },
  { value: "archived", label: "Archived" },
] as const;

export function FeedFilters({
  students,
  currentStatus,
  currentStudentId,
}: FeedFiltersProps) {
  const router = useRouter();
  const searchParams = useSearchParams();

  function updateParams(key: string, value: string | undefined) {
    const params = new URLSearchParams(searchParams.toString());
    if (value) {
      params.set(key, value);
    } else {
      params.delete(key);
    }
    params.delete("page"); // reset to page 1
    router.push(`/pedagogy/observations?${params.toString()}`);
  }

  return (
    <div className="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
      {/* Status tabs */}
      <div className="flex gap-1 rounded-lg bg-gray-100 p-1">
        {STATUS_TABS.map((tab) => (
          <button
            key={tab.label}
            onClick={() => updateParams("status", tab.value)}
            className={`rounded-md px-3 py-1.5 text-xs font-medium transition-colors ${
              currentStatus === tab.value
                ? "bg-white text-gray-900 shadow-sm"
                : "text-gray-600 hover:text-gray-900"
            }`}
          >
            {tab.label}
          </button>
        ))}
      </div>

      {/* Student filter */}
      <select
        value={currentStudentId ?? ""}
        onChange={(e) => updateParams("student", e.target.value || undefined)}
        className="rounded-lg border border-gray-300 px-3 py-1.5 text-sm text-gray-700 focus:border-ring focus:outline-none focus:ring-1 focus:ring-ring"
      >
        <option value="">All Students</option>
        {students.map((s) => (
          <option key={s.id} value={s.id}>
            {s.name}
          </option>
        ))}
      </select>
    </div>
  );
}



===== D:\.code\wattleos\src\components\domain\observations\media-gallery.tsx =====

// src/components/domain/observations/media-gallery.tsx
//
// ============================================================
// WattleOS V2 - Media Gallery
// ============================================================
// Reusable media thumbnail grid with lightbox integration.
//
// Two variants:
// - compact: horizontal scroll row, 64px thumbnails (feed cards)
// - full: wrapping grid, 128px thumbnails (detail page)
//
// WHY single component with variants: same data, different
// presentations. Avoids duplicating rendering + lightbox logic.
// ============================================================

"use client";

import type { ObservationMedia } from "@/types/domain";
import { useState } from "react";
import { MediaLightbox } from "./media-lightbox";

interface MediaGalleryProps {
  media: ObservationMedia[];
  /** 'compact' = small horizontal row (feed card), 'full' = larger grid (detail page) */
  variant: "compact" | "full";
}

export function MediaGallery({ media, variant }: MediaGalleryProps) {
  const [lightboxIndex, setLightboxIndex] = useState<number | null>(null);

  // Only show images (future: handle video/audio/document differently)
  const imageMedia = media.filter(
    (m) => m.media_type === "image" && m.thumbnail_url,
  );
  const otherMedia = media.filter(
    (m) => m.media_type !== "image" || !m.thumbnail_url,
  );

  if (media.length === 0) return null;

  function openLightbox(index: number) {
    setLightboxIndex(index);
  }

  function closeLightbox() {
    setLightboxIndex(null);
  }

  if (variant === "compact") {
    return (
      <>
        <div className="mt-3 flex gap-2 overflow-x-auto">
          {imageMedia.map((m, i) => (
            <button
              key={m.id}
              onClick={() => openLightbox(i)}
              className="flex-shrink-0 overflow-hidden rounded-lg focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-1"
            >
              <img
                src={m.thumbnail_url!}
                alt=""
                className="h-16 w-16 object-cover transition-transform hover:scale-105"
              />
            </button>
          ))}
          {/* Non-image media icons */}
          {otherMedia.map((m) => (
            <div
              key={m.id}
              className="flex h-16 w-16 flex-shrink-0 items-center justify-center rounded-lg bg-gray-100"
            >
              <MediaIcon type={m.media_type} />
            </div>
          ))}
          {/* Overflow indicator */}
          {imageMedia.length > 4 && (
            <div className="flex h-16 w-16 flex-shrink-0 items-center justify-center rounded-lg bg-gray-100 text-xs font-medium text-gray-500">
              +{imageMedia.length - 4}
            </div>
          )}
        </div>

        {lightboxIndex !== null && (
          <MediaLightbox
            media={imageMedia}
            currentIndex={lightboxIndex}
            onClose={closeLightbox}
            onNavigate={setLightboxIndex}
          />
        )}
      </>
    );
  }

  // variant === 'full'
  return (
    <>
      <div className="mt-4">
        <div className="flex flex-wrap gap-3">
          {imageMedia.map((m, i) => (
            <button
              key={m.id}
              onClick={() => openLightbox(i)}
              className="group overflow-hidden rounded-lg focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2"
            >
              <img
                src={m.thumbnail_url!}
                alt={m.file_name ?? "Observation photo"}
                className="h-32 w-32 object-cover transition-all group-hover:scale-105 group-hover:brightness-95 sm:h-40 sm:w-40"
              />
            </button>
          ))}
          {/* Non-image media */}
          {otherMedia.map((m) => (
            <div
              key={m.id}
              className="flex h-32 w-32 items-center justify-center rounded-lg bg-gray-100 sm:h-40 sm:w-40"
            >
              <div className="text-center">
                <MediaIcon type={m.media_type} />
                <p className="mt-1 text-xs text-gray-500">
                  {m.file_name ?? m.media_type}
                </p>
              </div>
            </div>
          ))}
        </div>
      </div>

      {lightboxIndex !== null && (
        <MediaLightbox
          media={imageMedia}
          currentIndex={lightboxIndex}
          onClose={closeLightbox}
          onNavigate={setLightboxIndex}
        />
      )}
    </>
  );
}

// ============================================================
// Sub-components
// ============================================================

function MediaIcon({ type }: { type: string }) {
  if (type === "image") {
    return (
      <svg
        className="h-6 w-6 text-gray-400"
        fill="none"
        viewBox="0 0 24 24"
        strokeWidth={1.5}
        stroke="currentColor"
      >
        <path
          strokeLinecap="round"
          strokeLinejoin="round"
          d="m2.25 15.75 5.159-5.159a2.25 2.25 0 0 1 3.182 0l5.159 5.159m-1.5-1.5 1.409-1.409a2.25 2.25 0 0 1 3.182 0l2.909 2.909M3.75 21h16.5a2.25 2.25 0 0 0 2.25-2.25V5.25a2.25 2.25 0 0 0-2.25-2.25H3.75A2.25 2.25 0 0 0 1.5 5.25v13.5A2.25 2.25 0 0 0 3.75 21Z"
        />
      </svg>
    );
  }
  if (type === "video") {
    return (
      <svg
        className="h-6 w-6 text-gray-400"
        fill="none"
        viewBox="0 0 24 24"
        strokeWidth={1.5}
        stroke="currentColor"
      >
        <path
          strokeLinecap="round"
          strokeLinejoin="round"
          d="m15.75 10.5 4.72-4.72a.75.75 0 0 1 1.28.53v11.38a.75.75 0 0 1-1.28.53l-4.72-4.72M4.5 18.75h9a2.25 2.25 0 0 0 2.25-2.25v-9a2.25 2.25 0 0 0-2.25-2.25h-9A2.25 2.25 0 0 0 2.25 7.5v9a2.25 2.25 0 0 0 2.25 2.25Z"
        />
      </svg>
    );
  }
  if (type === "audio") {
    return (
      <svg
        className="h-6 w-6 text-gray-400"
        fill="none"
        viewBox="0 0 24 24"
        strokeWidth={1.5}
        stroke="currentColor"
      >
        <path
          strokeLinecap="round"
          strokeLinejoin="round"
          d="M19.114 5.636a9 9 0 0 1 0 12.728M16.463 8.288a5.25 5.25 0 0 1 0 7.424M6.75 8.25l4.72-4.72a.75.75 0 0 1 1.28.53v15.88a.75.75 0 0 1-1.28.53l-4.72-4.72H4.51c-.88 0-1.704-.507-1.938-1.354A9.009 9.009 0 0 1 2.25 12c0-.83.112-1.633.322-2.396C2.806 8.756 3.63 8.25 4.51 8.25H6.75Z"
        />
      </svg>
    );
  }
  // document fallback
  return (
    <svg
      className="h-6 w-6 text-gray-400"
      fill="none"
      viewBox="0 0 24 24"
      strokeWidth={1.5}
      stroke="currentColor"
    >
      <path
        strokeLinecap="round"
        strokeLinejoin="round"
        d="M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m2.25 0H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 0 0-9-9Z"
      />
    </svg>
  );
}



===== D:\.code\wattleos\src\components\domain\observations\media-lightbox.tsx =====

// src/components/domain/observations/media-lightbox.tsx
//
// ============================================================
// WattleOS V2 - Media Lightbox
// ============================================================
// Full-screen image viewer overlay. Supports keyboard navigation
// (â† â†’ Escape), click-outside-to-close, and swipe on touch.
//
// WHY: Guides and parents need to view observation photos at
// full size. A lightbox keeps them on the same page rather than
// navigating away to a raw image URL.
// ============================================================

'use client';

import { useEffect, useCallback } from 'react';
import type { ObservationMedia } from '@/types/domain';

interface MediaLightboxProps {
  media: ObservationMedia[];
  currentIndex: number;
  onClose: () => void;
  onNavigate: (index: number) => void;
}

export function MediaLightbox({
  media,
  currentIndex,
  onClose,
  onNavigate,
}: MediaLightboxProps) {
  const current = media[currentIndex];
  const hasPrev = currentIndex > 0;
  const hasNext = currentIndex < media.length - 1;

  // Keyboard navigation
  const handleKeyDown = useCallback(
    (e: KeyboardEvent) => {
      if (e.key === 'Escape') {
        onClose();
      } else if (e.key === 'ArrowLeft' && hasPrev) {
        onNavigate(currentIndex - 1);
      } else if (e.key === 'ArrowRight' && hasNext) {
        onNavigate(currentIndex + 1);
      }
    },
    [currentIndex, hasPrev, hasNext, onClose, onNavigate]
  );

  useEffect(() => {
    document.addEventListener('keydown', handleKeyDown);
    // Prevent body scroll while lightbox is open
    document.body.style.overflow = 'hidden';

    return () => {
      document.removeEventListener('keydown', handleKeyDown);
      document.body.style.overflow = '';
    };
  }, [handleKeyDown]);

  if (!current) return null;

  // Use thumbnail_url as the image source (this IS the full image
  // for Supabase Storage - we store the public URL there).
  const imageUrl = current.thumbnail_url;

  return (
    <div
      className="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm"
      onClick={onClose}
      role="dialog"
      aria-modal="true"
      aria-label="Image viewer"
    >
      {/* Close button */}
      <button
        onClick={onClose}
        className="absolute right-4 top-4 z-10 flex h-10 w-10 items-center justify-center rounded-full bg-black/50 text-white transition-colors hover:bg-black/70"
        aria-label="Close"
      >
        <svg
          className="h-6 w-6"
          fill="none"
          viewBox="0 0 24 24"
          strokeWidth={2}
          stroke="currentColor"
        >
          <path
            strokeLinecap="round"
            strokeLinejoin="round"
            d="M6 18 18 6M6 6l12 12"
          />
        </svg>
      </button>

      {/* Counter */}
      {media.length > 1 && (
        <div className="absolute left-4 top-4 rounded-full bg-black/50 px-3 py-1 text-sm font-medium text-white">
          {currentIndex + 1} / {media.length}
        </div>
      )}

      {/* Previous button */}
      {hasPrev && (
        <button
          onClick={(e) => {
            e.stopPropagation();
            onNavigate(currentIndex - 1);
          }}
          className="absolute left-4 top-1/2 z-10 flex h-10 w-10 -translate-y-1/2 items-center justify-center rounded-full bg-black/50 text-white transition-colors hover:bg-black/70"
          aria-label="Previous image"
        >
          <svg
            className="h-6 w-6"
            fill="none"
            viewBox="0 0 24 24"
            strokeWidth={2}
            stroke="currentColor"
          >
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              d="M15.75 19.5 8.25 12l7.5-7.5"
            />
          </svg>
        </button>
      )}

      {/* Next button */}
      {hasNext && (
        <button
          onClick={(e) => {
            e.stopPropagation();
            onNavigate(currentIndex + 1);
          }}
          className="absolute right-4 top-1/2 z-10 flex h-10 w-10 -translate-y-1/2 items-center justify-center rounded-full bg-black/50 text-white transition-colors hover:bg-black/70"
          aria-label="Next image"
        >
          <svg
            className="h-6 w-6"
            fill="none"
            viewBox="0 0 24 24"
            strokeWidth={2}
            stroke="currentColor"
          >
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              d="m8.25 4.5 7.5 7.5-7.5 7.5"
            />
          </svg>
        </button>
      )}

      {/* Image */}
      <div
        className="flex max-h-[90vh] max-w-[90vw] items-center justify-center"
        onClick={(e) => e.stopPropagation()}
      >
        {imageUrl ? (
          <img
            src={imageUrl}
            alt={current.file_name ?? 'Observation photo'}
            className="max-h-[85vh] max-w-[85vw] rounded-lg object-contain shadow-2xl"
          />
        ) : (
          <div className="flex h-64 w-64 items-center justify-center rounded-lg bg-gray-800 text-gray-400">
            <div className="text-center">
              <MediaTypeIcon type={current.media_type} />
              <p className="mt-2 text-sm">{current.file_name ?? current.media_type}</p>
            </div>
          </div>
        )}
      </div>

      {/* File info bar */}
      <div className="absolute bottom-4 left-1/2 -translate-x-1/2 rounded-full bg-black/50 px-4 py-1.5 text-xs text-white/80">
        {current.file_name && (
          <span>{current.file_name}</span>
        )}
        {current.file_size_bytes && (
          <span className="ml-2">
            ({formatFileSize(current.file_size_bytes)})
          </span>
        )}
      </div>
    </div>
  );
}

// ============================================================
// Helpers
// ============================================================

function formatFileSize(bytes: number): string {
  if (bytes < 1024) return `${bytes} B`;
  if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(0)} KB`;
  return `${(bytes / (1024 * 1024)).toFixed(1)} MB`;
}

function MediaTypeIcon({ type }: { type: string }) {
  if (type === 'video') {
    return (
      <svg
        className="mx-auto h-12 w-12"
        fill="none"
        viewBox="0 0 24 24"
        strokeWidth={1.5}
        stroke="currentColor"
      >
        <path
          strokeLinecap="round"
          strokeLinejoin="round"
          d="m15.75 10.5 4.72-4.72a.75.75 0 0 1 1.28.53v11.38a.75.75 0 0 1-1.28.53l-4.72-4.72M4.5 18.75h9a2.25 2.25 0 0 0 2.25-2.25v-9a2.25 2.25 0 0 0-2.25-2.25h-9A2.25 2.25 0 0 0 2.25 7.5v9a2.25 2.25 0 0 0 2.25 2.25Z"
        />
      </svg>
    );
  }
  return (
    <svg
      className="mx-auto h-12 w-12"
      fill="none"
      viewBox="0 0 24 24"
      strokeWidth={1.5}
      stroke="currentColor"
    >
      <path
        strokeLinecap="round"
        strokeLinejoin="round"
        d="m2.25 15.75 5.159-5.159a2.25 2.25 0 0 1 3.182 0l5.159 5.159m-1.5-1.5 1.409-1.409a2.25 2.25 0 0 1 3.182 0l2.909 2.909M3.75 21h16.5a2.25 2.25 0 0 0 2.25-2.25V5.25a2.25 2.25 0 0 0-2.25-2.25H3.75A2.25 2.25 0 0 0 1.5 5.25v13.5A2.25 2.25 0 0 0 3.75 21Z"
      />
    </svg>
  );
}


===== D:\.code\wattleos\src\components\domain\observations\observation-capture-form.tsx =====

// src/components/domain/observations/observation-capture-form.tsx
//
// ============================================================
// WattleOS V2 - Observation Capture Form (with Media)
// ============================================================
// Client component: text + student tags + outcome tags + photos.
//
// CHANGES from previous version:
// - Added image compression via compressImage() before upload
// - Added per-photo upload progress indicators
// - Added upload status feedback (compressing â†’ uploading â†’ done / error)
// - Added consent warning when publishing with media + tagged students
// ============================================================

"use client";

import {
  addObservationMedia,
  createObservation,
  publishObservation,
} from "@/lib/actions/observations";
import { createSupabaseBrowserClient } from "@/lib/supabase/browser";
import { compressImage } from "@/lib/utils/image-compression";
import { useRouter } from "next/navigation";
import { useCallback, useRef, useState } from "react";

// ============================================================
// Types
// ============================================================

interface StudentOption {
  id: string;
  firstName: string;
  lastName: string;
  preferredName: string | null;
  photoUrl: string | null;
  mediaConsent: boolean;
}

interface OutcomeOption {
  id: string;
  title: string;
  level: string;
  instanceName: string;
}

interface ObservationCaptureFormProps {
  students: StudentOption[];
  outcomes: OutcomeOption[];
  canPublish: boolean;
}

type PhotoUploadStatus =
  | "pending"
  | "compressing"
  | "uploading"
  | "done"
  | "error";

interface PhotoEntry {
  file: File;
  previewUrl: string;
  status: PhotoUploadStatus;
  errorMessage: string | null;
}

// ============================================================
// Component
// ============================================================

export function ObservationCaptureForm({
  students,
  outcomes,
  canPublish,
}: ObservationCaptureFormProps) {
  // Form state
  const [content, setContent] = useState("");
  const [selectedStudents, setSelectedStudents] = useState<StudentOption[]>([]);
  const [selectedOutcomes, setSelectedOutcomes] = useState<OutcomeOption[]>([]);
  const [photoEntries, setPhotoEntries] = useState<PhotoEntry[]>([]);
  const [isSaving, setIsSaving] = useState(false);
  const [isPublishing, setIsPublishing] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [consentWarning, setConsentWarning] = useState<string | null>(null);
  const fileInputRef = useRef<HTMLInputElement>(null);
  const router = useRouter();

  // Student search
  const [studentQuery, setStudentQuery] = useState("");
  const [showStudentDropdown, setShowStudentDropdown] = useState(false);
  const filteredStudents = studentQuery.trim()
    ? students.filter(
        (s) =>
          !selectedStudents.find((sel) => sel.id === s.id) &&
          (s.firstName.toLowerCase().includes(studentQuery.toLowerCase()) ||
            s.lastName.toLowerCase().includes(studentQuery.toLowerCase()) ||
            s.preferredName
              ?.toLowerCase()
              .includes(studentQuery.toLowerCase())),
      )
    : students.filter((s) => !selectedStudents.find((sel) => sel.id === s.id));

  // Outcome search
  const [outcomeQuery, setOutcomeQuery] = useState("");
  const [showOutcomeDropdown, setShowOutcomeDropdown] = useState(false);
  const filteredOutcomes = outcomeQuery.trim()
    ? outcomes.filter(
        (o) =>
          !selectedOutcomes.find((sel) => sel.id === o.id) &&
          o.title.toLowerCase().includes(outcomeQuery.toLowerCase()),
      )
    : [];

  // ============================================================
  // Student / Outcome handlers
  // ============================================================

  function addStudent(student: StudentOption) {
    setSelectedStudents((prev) => [...prev, student]);
    setStudentQuery("");
    setShowStudentDropdown(false);
  }

  function removeStudent(id: string) {
    setSelectedStudents((prev) => prev.filter((s) => s.id !== id));
  }

  function addOutcome(outcome: OutcomeOption) {
    setSelectedOutcomes((prev) => [...prev, outcome]);
    setOutcomeQuery("");
    setShowOutcomeDropdown(false);
  }

  function removeOutcome(id: string) {
    setSelectedOutcomes((prev) => prev.filter((o) => o.id !== id));
  }

  // ============================================================
  // Photo handlers
  // ============================================================

  const handlePhotoSelect = useCallback(
    (e: React.ChangeEvent<HTMLInputElement>) => {
      const files = Array.from(e.target.files ?? []);
      if (files.length === 0) return;

      const newEntries: PhotoEntry[] = files.map((file) => ({
        file,
        previewUrl: URL.createObjectURL(file),
        status: "pending" as const,
        errorMessage: null,
      }));

      setPhotoEntries((prev) => [...prev, ...newEntries]);

      // Reset the input so the same file can be re-selected
      if (fileInputRef.current) {
        fileInputRef.current.value = "";
      }
    },
    [],
  );

  function removePhoto(index: number) {
    setPhotoEntries((prev) => {
      URL.revokeObjectURL(prev[index].previewUrl);
      return prev.filter((_, i) => i !== index);
    });
  }

  // ============================================================
  // Consent check
  // ============================================================

  function checkMediaConsent(): boolean {
    if (photoEntries.length === 0) return true; // No media, no issue

    const noConsentStudents = selectedStudents.filter((s) => !s.mediaConsent);
    if (noConsentStudents.length === 0) return true;

    const names = noConsentStudents
      .map((s) => s.preferredName ?? s.firstName)
      .join(", ");

    setConsentWarning(
      `Media consent has not been granted for: ${names}. Photos will still be saved, but may not be shared externally.`,
    );
    return false;
  }

  function dismissConsentWarning() {
    setConsentWarning(null);
  }

  // ============================================================
  // Save / Publish
  // ============================================================

  async function handleSave(publish: boolean) {
    if (!content.trim() && selectedStudents.length === 0) {
      setError("Please add some content or tag a student.");
      return;
    }

    // Consent check on publish only
    if (publish && photoEntries.length > 0) {
      const consentOk = checkMediaConsent();
      if (!consentOk && !consentWarning) {
        // First time - show warning, don't proceed yet.
        // The user will click Publish again after seeing the warning.
        return;
      }
    }

    setError(null);
    setConsentWarning(null);
    publish ? setIsPublishing(true) : setIsSaving(true);

    // 1. Create the observation
    const result = await createObservation({
      content: content.trim(),
      studentIds: selectedStudents.map((s) => s.id),
      outcomeIds: selectedOutcomes.map((o) => o.id),
    });

    if (result.error || !result.data) {
      setError(result.error?.message ?? "Failed to save observation");
      setIsSaving(false);
      setIsPublishing(false);
      return;
    }

    const observationId = result.data.id;

    // 2. Compress and upload photos
    if (photoEntries.length > 0) {
      const supabase = createSupabaseBrowserClient();

      for (let i = 0; i < photoEntries.length; i++) {
        const entry = photoEntries[i];

        // 2a. Compress
        updatePhotoStatus(i, "compressing");
        let fileToUpload: File;
        try {
          fileToUpload = await compressImage(entry.file);
        } catch (compressErr) {
          console.error("Compression failed, uploading original:", compressErr);
          fileToUpload = entry.file;
        }

        // 2b. Upload to Supabase Storage
        updatePhotoStatus(i, "uploading");
        const ext = fileToUpload.name.split(".").pop() ?? "jpg";
        const path = `${observationId}/${crypto.randomUUID()}.${ext}`;

        const { error: uploadError } = await supabase.storage
          .from("observation-media")
          .upload(path, fileToUpload, { contentType: fileToUpload.type });

        if (uploadError) {
          console.error("Photo upload failed:", uploadError.message);
          updatePhotoStatus(i, "error", uploadError.message);
          continue;
        }

        // 2c. Get public URL for thumbnail
        const { data: urlData } = supabase.storage
          .from("observation-media")
          .getPublicUrl(path);

        // 2d. Record the media attachment
        await addObservationMedia({
          observationId,
          mediaType: "image",
          storageProvider: "supabase",
          storagePath: path,
          thumbnailUrl: urlData?.publicUrl ?? null,
          fileName: entry.file.name,
          fileSizeBytes: fileToUpload.size,
        });

        updatePhotoStatus(i, "done");
      }
    }

    // 3. Publish if requested
    if (publish) {
      await publishObservation(observationId);
    }

    // 4. Redirect to feed
    router.push("/pedagogy/observations");
    router.refresh();
  }

  function updatePhotoStatus(
    index: number,
    status: PhotoUploadStatus,
    errorMessage?: string,
  ) {
    setPhotoEntries((prev) =>
      prev.map((entry, i) =>
        i === index
          ? { ...entry, status, errorMessage: errorMessage ?? null }
          : entry,
      ),
    );
  }

  // ============================================================
  // Render
  // ============================================================

  const isBusy = isSaving || isPublishing;
  const pendingPhotos = photoEntries.filter((p) => p.status === "pending");

  return (
    <div className="space-y-6 rounded-lg border border-gray-200 bg-white p-6">
      {error && (
        <div className="rounded-md bg-red-50 p-3 text-sm text-red-700">
          {error}
        </div>
      )}

      {consentWarning && (
        <div className="rounded-md border border-amber-200 bg-amber-50 p-3">
          <div className="flex items-start gap-2">
            <svg
              className="mt-0.5 h-4 w-4 flex-shrink-0 text-amber-600"
              fill="none"
              viewBox="0 0 24 24"
              strokeWidth={1.5}
              stroke="currentColor"
            >
              <path
                strokeLinecap="round"
                strokeLinejoin="round"
                d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z"
              />
            </svg>
            <div className="flex-1">
              <p className="text-sm font-medium text-amber-800">
                Media Consent Warning
              </p>
              <p className="mt-1 text-sm text-amber-700">{consentWarning}</p>
              <div className="mt-2 flex gap-2">
                <button
                  type="button"
                  onClick={() => handleSave(true)}
                  className="rounded-md bg-amber-600 px-3 py-1 text-xs font-medium text-white hover:bg-amber-700"
                >
                  Publish Anyway
                </button>
                <button
                  type="button"
                  onClick={dismissConsentWarning}
                  className="rounded-md border border-amber-300 px-3 py-1 text-xs font-medium text-amber-700 hover:bg-amber-100"
                >
                  Cancel
                </button>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Content */}
      <div>
        <label
          htmlFor="content"
          className="block text-sm font-medium text-gray-700"
        >
          What did you observe?
        </label>
        <textarea
          id="content"
          value={content}
          onChange={(e) => setContent(e.target.value)}
          placeholder="Describe the learning moment..."
          rows={4}
          className="mt-1 w-full rounded-lg border border-gray-300 px-4 py-3 text-sm placeholder:text-gray-400 focus:border-ring focus:outline-none focus:ring-1 focus:ring-ring"
        />
      </div>

      {/* Student tagger */}
      <div>
        <label className="block text-sm font-medium text-gray-700">
          Students
        </label>

        {/* Selected students */}
        {selectedStudents.length > 0 && (
          <div className="mt-2 flex flex-wrap gap-2">
            {selectedStudents.map((student) => (
              <span
                key={student.id}
                className="inline-flex items-center gap-1.5 rounded-full bg-blue-50 px-3 py-1.5 text-sm font-medium text-blue-700"
              >
                {student.photoUrl ? (
                  <img
                    src={student.photoUrl}
                    alt=""
                    className="h-5 w-5 rounded-full object-cover"
                  />
                ) : (
                  <span className="flex h-5 w-5 items-center justify-center rounded-full bg-blue-200 text-xs font-bold">
                    {student.firstName.charAt(0)}
                  </span>
                )}
                {student.preferredName ?? student.firstName} {student.lastName}
                {!student.mediaConsent && photoEntries.length > 0 && (
                  <svg
                    className="h-3.5 w-3.5 text-amber-500"
                    fill="none"
                    viewBox="0 0 24 24"
                    strokeWidth={2}
                    stroke="currentColor"
                  >
                    <path
                      strokeLinecap="round"
                      strokeLinejoin="round"
                      d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z"
                    />
                  </svg>
                )}
                <button
                  onClick={() => removeStudent(student.id)}
                  className="ml-1 text-blue-400 hover:text-blue-700"
                >
                  <svg
                    className="h-3.5 w-3.5"
                    fill="none"
                    viewBox="0 0 24 24"
                    strokeWidth={2}
                    stroke="currentColor"
                  >
                    <path
                      strokeLinecap="round"
                      strokeLinejoin="round"
                      d="M6 18 18 6M6 6l12 12"
                    />
                  </svg>
                </button>
              </span>
            ))}
          </div>
        )}

        {/* Search input */}
        <div className="relative mt-2">
          <input
            type="text"
            value={studentQuery}
            onChange={(e) => {
              setStudentQuery(e.target.value);
              setShowStudentDropdown(true);
            }}
            onFocus={() => setShowStudentDropdown(true)}
            onBlur={() => setTimeout(() => setShowStudentDropdown(false), 200)}
            placeholder="Search students..."
            className="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm placeholder:text-gray-400 focus:border-ring focus:outline-none focus:ring-1 focus:ring-ring"
          />

          {/* Dropdown */}
          {showStudentDropdown && filteredStudents.length > 0 && (
            <div className="absolute z-10 mt-1 max-h-48 w-full overflow-y-auto rounded-lg border border-gray-200 bg-white shadow-lg">
              {filteredStudents.slice(0, 10).map((student) => (
                <button
                  key={student.id}
                  onMouseDown={(e) => e.preventDefault()}
                  onClick={() => addStudent(student)}
                  className="flex w-full items-center gap-3 px-3 py-2 text-left text-sm hover:bg-amber-50"
                >
                  {student.photoUrl ? (
                    <img
                      src={student.photoUrl}
                      alt=""
                      className="h-7 w-7 rounded-full object-cover"
                    />
                  ) : (
                    <span className="flex h-7 w-7 items-center justify-center rounded-full bg-gray-200 text-xs font-bold text-gray-600">
                      {student.firstName.charAt(0)}
                    </span>
                  )}
                  <span>
                    {student.preferredName ?? student.firstName}{" "}
                    <span className="text-gray-500">{student.lastName}</span>
                  </span>
                </button>
              ))}
            </div>
          )}
        </div>
      </div>

      {/* Outcome tagger */}
      <div>
        <label className="block text-sm font-medium text-gray-700">
          Curriculum Outcomes
        </label>

        {/* Selected outcomes */}
        {selectedOutcomes.length > 0 && (
          <div className="mt-2 flex flex-wrap gap-2">
            {selectedOutcomes.map((outcome) => (
              <span
                key={outcome.id}
                className="inline-flex items-center gap-1.5 rounded-full bg-green-50 px-3 py-1.5 text-sm font-medium text-green-700"
              >
                {outcome.title}
                <button
                  onClick={() => removeOutcome(outcome.id)}
                  className="ml-1 text-green-400 hover:text-green-700"
                >
                  <svg
                    className="h-3.5 w-3.5"
                    fill="none"
                    viewBox="0 0 24 24"
                    strokeWidth={2}
                    stroke="currentColor"
                  >
                    <path
                      strokeLinecap="round"
                      strokeLinejoin="round"
                      d="M6 18 18 6M6 6l12 12"
                    />
                  </svg>
                </button>
              </span>
            ))}
          </div>
        )}

        {/* Outcome search */}
        <div className="relative mt-2">
          <input
            type="text"
            value={outcomeQuery}
            onChange={(e) => {
              setOutcomeQuery(e.target.value);
              setShowOutcomeDropdown(true);
            }}
            onFocus={() => {
              if (outcomeQuery.trim()) setShowOutcomeDropdown(true);
            }}
            onBlur={() => setTimeout(() => setShowOutcomeDropdown(false), 200)}
            placeholder="Search curriculum outcomes..."
            className="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm placeholder:text-gray-400 focus:border-ring focus:outline-none focus:ring-1 focus:ring-ring"
          />

          {showOutcomeDropdown && filteredOutcomes.length > 0 && (
            <div className="absolute z-10 mt-1 max-h-48 w-full overflow-y-auto rounded-lg border border-gray-200 bg-white shadow-lg">
              {filteredOutcomes.slice(0, 10).map((outcome) => (
                <button
                  key={outcome.id}
                  onMouseDown={(e) => e.preventDefault()}
                  onClick={() => addOutcome(outcome)}
                  className="flex w-full items-center gap-2 px-3 py-2 text-left text-sm hover:bg-amber-50"
                >
                  <span
                    className={`inline-flex rounded px-1 py-0.5 text-[10px] font-semibold uppercase ${
                      outcome.level === "outcome"
                        ? "bg-green-100 text-green-700"
                        : "bg-amber-100 text-amber-700"
                    }`}
                  >
                    {outcome.level}
                  </span>
                  <span className="flex-1 truncate">{outcome.title}</span>
                  <span className="flex-shrink-0 text-xs text-gray-400">
                    {outcome.instanceName}
                  </span>
                </button>
              ))}
            </div>
          )}

          {showOutcomeDropdown &&
            outcomeQuery.trim() &&
            filteredOutcomes.length === 0 && (
              <div className="absolute z-10 mt-1 w-full rounded-lg border border-gray-200 bg-white p-3 text-center text-sm text-gray-500 shadow-lg">
                No matching outcomes found
              </div>
            )}
        </div>
      </div>

      {/* Photo capture */}
      <div>
        <label className="block text-sm font-medium text-gray-700">
          Photos
        </label>
        <div className="mt-2">
          {/* Preview grid with upload status */}
          {photoEntries.length > 0 && (
            <div className="mb-3 flex flex-wrap gap-3">
              {photoEntries.map((entry, index) => (
                <div key={index} className="group relative">
                  <img
                    src={entry.previewUrl}
                    alt=""
                    className={`h-20 w-20 rounded-lg object-cover ${
                      entry.status === "error"
                        ? "ring-2 ring-red-400"
                        : entry.status === "done"
                          ? "ring-2 ring-green-400"
                          : ""
                    }`}
                  />

                  {/* Status overlay */}
                  {entry.status !== "pending" && entry.status !== "done" && (
                    <div className="absolute inset-0 flex items-center justify-center rounded-lg bg-black/40">
                      {entry.status === "compressing" && (
                        <div className="flex flex-col items-center gap-1">
                          <SpinnerIcon />
                          <span className="text-[10px] font-medium text-white">
                            Compressing
                          </span>
                        </div>
                      )}
                      {entry.status === "uploading" && (
                        <div className="flex flex-col items-center gap-1">
                          <SpinnerIcon />
                          <span className="text-[10px] font-medium text-white">
                            Uploading
                          </span>
                        </div>
                      )}
                      {entry.status === "error" && (
                        <div className="flex flex-col items-center gap-1">
                          <svg
                            className="h-5 w-5 text-red-300"
                            fill="none"
                            viewBox="0 0 24 24"
                            strokeWidth={2}
                            stroke="currentColor"
                          >
                            <path
                              strokeLinecap="round"
                              strokeLinejoin="round"
                              d="M12 9v3.75m9-.75a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9 3.75h.008v.008H12v-.008Z"
                            />
                          </svg>
                          <span className="text-[10px] font-medium text-red-300">
                            Failed
                          </span>
                        </div>
                      )}
                    </div>
                  )}

                  {/* Done checkmark */}
                  {entry.status === "done" && (
                    <div className="absolute bottom-1 right-1 flex h-5 w-5 items-center justify-center rounded-full bg-green-500">
                      <svg
                        className="h-3 w-3 text-white"
                        fill="none"
                        viewBox="0 0 24 24"
                        strokeWidth={3}
                        stroke="currentColor"
                      >
                        <path
                          strokeLinecap="round"
                          strokeLinejoin="round"
                          d="m4.5 12.75 6 6 9-13.5"
                        />
                      </svg>
                    </div>
                  )}

                  {/* Remove button (only before upload starts) */}
                  {entry.status === "pending" && (
                    <button
                      onClick={() => removePhoto(index)}
                      className="absolute -right-2 -top-2 flex h-5 w-5 items-center justify-center rounded-full bg-red-500 text-white opacity-0 transition-opacity group-hover:opacity-100"
                    >
                      <svg
                        className="h-3 w-3"
                        fill="none"
                        viewBox="0 0 24 24"
                        strokeWidth={2}
                        stroke="currentColor"
                      >
                        <path
                          strokeLinecap="round"
                          strokeLinejoin="round"
                          d="M6 18 18 6M6 6l12 12"
                        />
                      </svg>
                    </button>
                  )}
                </div>
              ))}
            </div>
          )}

          {/* Add Photo button + hidden file input */}
          <button
            type="button"
            onClick={() => fileInputRef.current?.click()}
            disabled={isBusy}
            className="inline-flex items-center gap-2 rounded-lg border border-dashed border-gray-300 px-4 py-2.5 text-sm font-medium text-gray-600 transition-colors hover:border-amber-400 hover:bg-amber-50 hover:text-amber-700 disabled:cursor-not-allowed disabled:opacity-50"
          >
            <svg
              className="h-5 w-5"
              fill="none"
              viewBox="0 0 24 24"
              strokeWidth={1.5}
              stroke="currentColor"
            >
              <path
                strokeLinecap="round"
                strokeLinejoin="round"
                d="M6.827 6.175A2.31 2.31 0 0 1 5.186 7.23c-.38.054-.757.112-1.134.175C2.999 7.58 2.25 8.507 2.25 9.574V18a2.25 2.25 0 0 0 2.25 2.25h15A2.25 2.25 0 0 0 21.75 18V9.574c0-1.067-.75-1.994-1.802-2.169a47.865 47.865 0 0 0-1.134-.175 2.31 2.31 0 0 1-1.64-1.055l-.822-1.316a2.192 2.192 0 0 0-1.736-1.039 48.774 48.774 0 0 0-5.232 0 2.192 2.192 0 0 0-1.736 1.039l-.821 1.316Z"
              />
              <path
                strokeLinecap="round"
                strokeLinejoin="round"
                d="M16.5 12.75a4.5 4.5 0 1 1-9 0 4.5 4.5 0 0 1 9 0Z"
              />
            </svg>
            Add Photo
          </button>
          <input
            ref={fileInputRef}
            type="file"
            accept="image/*"
            multiple
            capture="environment"
            onChange={handlePhotoSelect}
            className="hidden"
          />
        </div>
      </div>

      {/* Action buttons */}
      <div className="flex items-center gap-3 border-t border-gray-100 pt-4">
        <button
          onClick={() => handleSave(false)}
          disabled={isBusy}
          className="rounded-lg border border-gray-300 px-5 py-2.5 text-sm font-medium text-gray-700 transition-colors hover:bg-gray-50 disabled:cursor-not-allowed disabled:opacity-50"
        >
          {isSaving ? "Saving..." : "Save as Draft"}
        </button>

        {canPublish && (
          <button
            onClick={() => handleSave(true)}
            disabled={isBusy}
            className="rounded-lg bg-green-600 px-5 py-2.5 text-sm font-medium text-white shadow-sm transition-colors hover:bg-green-700 disabled:cursor-not-allowed disabled:opacity-50"
          >
            {isPublishing ? "Publishing..." : "Publish Now"}
          </button>
        )}

        <button
          onClick={() => router.back()}
          disabled={isBusy}
          className="ml-auto text-sm text-gray-500 hover:text-gray-700"
        >
          Cancel
        </button>
      </div>
    </div>
  );
}

// ============================================================
// Sub-components
// ============================================================

function SpinnerIcon() {
  return (
    <svg
      className="h-5 w-5 animate-spin text-white"
      fill="none"
      viewBox="0 0 24 24"
    >
      <circle
        className="opacity-25"
        cx="12"
        cy="12"
        r="10"
        stroke="currentColor"
        strokeWidth="4"
      />
      <path
        className="opacity-75"
        fill="currentColor"
        d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
      />
    </svg>
  );
}



===== D:\.code\wattleos\src\components\domain\observations\observation-card.tsx =====

// src/components/domain/observations/observation-card.tsx
//
// ============================================================
// WattleOS V2 - Observation Card (Feed Item)
// ============================================================
// Client component displayed in the observation feed. Shows
// author, content, media thumbnails, student tags, outcome tags,
// and action buttons (publish/archive/delete).
//
// CHANGES from previous version:
// - Replaced inline media thumbnail rendering with MediaGallery
// - Uses flat .students / .outcomes / .media (Batch 1 type fix)
// ============================================================

'use client';

import { useTransition } from 'react';
import { useRouter } from 'next/navigation';
import Link from 'next/link';
import type { ObservationFeedItem } from '@/types/domain';
import {
  publishObservation,
  archiveObservation,
  deleteObservation,
} from '@/lib/actions/observations';
import { MediaGallery } from './media-gallery';

interface ObservationCardProps {
  observation: ObservationFeedItem;
  currentUserId: string;
  canPublish: boolean;
}

export function ObservationCard({
  observation,
  currentUserId,
  canPublish,
}: ObservationCardProps) {
  const [isPending, startTransition] = useTransition();
  const router = useRouter();
  const isAuthor = observation.author.id === currentUserId;

  function refresh() {
    startTransition(() => router.refresh());
  }

  async function handlePublish() {
    await publishObservation(observation.id);
    refresh();
  }

  async function handleArchive() {
    await archiveObservation(observation.id);
    refresh();
  }

  async function handleDelete() {
    if (!confirm('Delete this draft observation?')) return;
    await deleteObservation(observation.id);
    refresh();
  }

  const authorName =
    [observation.author.first_name, observation.author.last_name]
      .filter(Boolean)
      .join(' ') || 'Unknown';

  const timeAgo = formatTimeAgo(observation.created_at);

  return (
    <div
      className={`rounded-lg border bg-white transition-shadow hover:shadow-sm ${
        observation.status === 'draft'
          ? 'border-amber-200'
          : 'border-gray-200'
      }`}
    >
      <div className="p-5">
        {/* Header row */}
        <div className="flex items-start justify-between gap-4">
          <div className="flex items-center gap-3">
            {/* Author avatar */}
            <div className="flex h-9 w-9 flex-shrink-0 items-center justify-center rounded-full bg-gray-200 text-sm font-medium text-gray-600">
              {observation.author.avatar_url ? (
                <img
                  src={observation.author.avatar_url}
                  alt={authorName}
                  className="h-9 w-9 rounded-full object-cover"
                />
              ) : (
                authorName.charAt(0).toUpperCase()
              )}
            </div>
            <div>
              <p className="text-sm font-medium text-gray-900">{authorName}</p>
              <p className="text-xs text-gray-500">{timeAgo}</p>
            </div>
          </div>

          {/* Status badge */}
          <StatusBadge status={observation.status} />
        </div>

        {/* Content */}
        {observation.content && (
          <div className="mt-3">
            <p className="whitespace-pre-wrap text-sm text-gray-700 line-clamp-4">
              {observation.content}
            </p>
          </div>
        )}

        {/* Media thumbnails - now uses MediaGallery with lightbox */}
        {observation.media.length > 0 && (
          <MediaGallery media={observation.media} variant="compact" />
        )}

        {/* Student tags */}
        {observation.students.length > 0 && (
          <div className="mt-3 flex flex-wrap gap-1.5">
            {observation.students.map((student) => (
              <span
                key={student.id}
                className="inline-flex items-center gap-1 rounded-full bg-blue-50 px-2.5 py-1 text-xs font-medium text-blue-700"
              >
                {student.photo_url ? (
                  <img
                    src={student.photo_url}
                    alt=""
                    className="h-4 w-4 rounded-full object-cover"
                  />
                ) : (
                  <svg
                    className="h-3 w-3"
                    fill="none"
                    viewBox="0 0 24 24"
                    strokeWidth={1.5}
                    stroke="currentColor"
                  >
                    <path
                      strokeLinecap="round"
                      strokeLinejoin="round"
                      d="M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.501 20.118a7.5 7.5 0 0 1 14.998 0A17.933 17.933 0 0 1 12 21.75c-2.676 0-5.216-.584-7.499-1.632Z"
                    />
                  </svg>
                )}
                {student.first_name} {student.last_name}
              </span>
            ))}
          </div>
        )}

        {/* Outcome tags */}
        {observation.outcomes.length > 0 && (
          <div className="mt-2 flex flex-wrap gap-1.5">
            {observation.outcomes.map((outcome) => (
              <span
                key={outcome.id}
                className="inline-flex items-center rounded-full bg-green-50 px-2.5 py-1 text-xs font-medium text-green-700"
              >
                {outcome.title}
              </span>
            ))}
          </div>
        )}

        {/* Actions */}
        <div className="mt-4 flex items-center gap-2 border-t border-gray-100 pt-3">
          <Link
            href={`/pedagogy/observations/${observation.id}`}
            className="text-xs font-medium text-gray-600 hover:text-gray-900"
          >
            View Details
          </Link>

          {observation.status === 'draft' && canPublish && (
            <button
              onClick={handlePublish}
              disabled={isPending}
              className="rounded-md bg-green-600 px-2.5 py-1 text-xs font-medium text-white hover:bg-green-700 disabled:opacity-50"
            >
              Publish
            </button>
          )}

          {observation.status === 'published' && canPublish && (
            <button
              onClick={handleArchive}
              disabled={isPending}
              className="rounded-md border border-gray-300 px-2.5 py-1 text-xs font-medium text-gray-600 hover:bg-gray-50 disabled:opacity-50"
            >
              Archive
            </button>
          )}

          {observation.status === 'draft' && isAuthor && (
            <button
              onClick={handleDelete}
              disabled={isPending}
              className="ml-auto text-xs font-medium text-red-500 hover:text-red-700 disabled:opacity-50"
            >
              Delete
            </button>
          )}
        </div>
      </div>
    </div>
  );
}

// ============================================================
// Sub-components
// ============================================================

function StatusBadge({ status }: { status: string }) {
  const styles: Record<string, string> = {
    draft: 'bg-amber-100 text-amber-700',
    published: 'bg-green-100 text-green-700',
    archived: 'bg-gray-100 text-gray-500',
  };

  return (
    <span
      className={`inline-flex rounded-full px-2.5 py-0.5 text-xs font-medium ${
        styles[status] ?? styles.draft
      }`}
    >
      {status.charAt(0).toUpperCase() + status.slice(1)}
    </span>
  );
}

function formatTimeAgo(dateStr: string): string {
  const date = new Date(dateStr);
  const now = new Date();
  const diff = now.getTime() - date.getTime();
  const minutes = Math.floor(diff / 60000);
  const hours = Math.floor(diff / 3600000);
  const days = Math.floor(diff / 86400000);

  if (minutes < 1) return 'Just now';
  if (minutes < 60) return `${minutes}m ago`;
  if (hours < 24) return `${hours}h ago`;
  if (days < 7) return `${days}d ago`;
  return date.toLocaleDateString('en-AU', { day: 'numeric', month: 'short' });
}


===== D:\.code\wattleos\src\components\domain\observations\observation-detail-actions.tsx =====

'use client';

import { useState, useTransition } from 'react';
import { useRouter } from 'next/navigation';
import {
  publishObservation,
  archiveObservation,
  deleteObservation,
} from '@/lib/actions/observations';

interface ObservationDetailActionsProps {
  observationId: string;
  status: string;
  isAuthor: boolean;
  canPublish: boolean;
}

export function ObservationDetailActions({
  observationId,
  status,
  isAuthor,
  canPublish,
}: ObservationDetailActionsProps) {
  const [isPending, startTransition] = useTransition();
  const router = useRouter();

  async function handlePublish() {
    await publishObservation(observationId);
    startTransition(() => router.refresh());
  }

  async function handleArchive() {
    await archiveObservation(observationId);
    startTransition(() => router.refresh());
  }

  async function handleDelete() {
    if (!confirm('Delete this draft observation? This cannot be undone.')) return;
    await deleteObservation(observationId);
    router.push('/pedagogy/observations');
    router.refresh();
  }

  return (
    <div className="mt-5 flex items-center gap-3 border-t border-gray-100 pt-4">
      {status === 'draft' && canPublish && (
        <button
          onClick={handlePublish}
          disabled={isPending}
          className="rounded-lg bg-green-600 px-4 py-2 text-sm font-medium text-white shadow-sm transition-colors hover:bg-green-700 disabled:opacity-50"
        >
          Publish
        </button>
      )}

      {status === 'published' && canPublish && (
        <button
          onClick={handleArchive}
          disabled={isPending}
          className="rounded-lg border border-gray-300 px-4 py-2 text-sm font-medium text-gray-700 transition-colors hover:bg-gray-50 disabled:opacity-50"
        >
          Archive
        </button>
      )}

      {status === 'draft' && isAuthor && (
        <button
          onClick={() => router.push(`/pedagogy/observations/${observationId}/edit`)}
          disabled={isPending}
          className="rounded-lg border border-gray-300 px-4 py-2 text-sm font-medium text-gray-700 transition-colors hover:bg-gray-50 disabled:opacity-50"
        >
          Edit
        </button>
      )}

      <button
        onClick={() => router.push('/pedagogy/observations')}
        className="text-sm text-gray-500 hover:text-gray-700"
      >
        Back to Feed
      </button>

      {status === 'draft' && isAuthor && (
        <button
          onClick={handleDelete}
          disabled={isPending}
          className="ml-auto text-sm font-medium text-red-500 hover:text-red-700 disabled:opacity-50"
        >
          Delete Draft
        </button>
      )}
    </div>
  );
}



===== D:\.code\wattleos\src\components\domain\parent\ConsentToggle.tsx =====

// src/components/domain/parent/ConsentToggle.tsx
//
// ============================================================
// WattleOS V2 - Consent Toggle (Client Component)
// ============================================================
// Toggle switch for consent preferences. Calls the server
// action on change with immediate visual feedback.
// ============================================================

'use client';

import { useState, useTransition } from 'react';
import { updateConsent } from '@/lib/actions/parent';

interface ConsentToggleProps {
  guardianId: string;
  consentType: 'media' | 'directory';
  label: string;
  description: string;
  initialValue: boolean;
}

export function ConsentToggle({
  guardianId,
  consentType,
  label,
  description,
  initialValue,
}: ConsentToggleProps) {
  const [isEnabled, setIsEnabled] = useState(initialValue);
  const [isPending, startTransition] = useTransition();
  const [error, setError] = useState<string | null>(null);

  function handleToggle() {
    const newValue = !isEnabled;
    setIsEnabled(newValue); // Optimistic
    setError(null);

    startTransition(async () => {
      const input =
        consentType === 'media'
          ? { guardianId, mediaConsent: newValue }
          : { guardianId, directoryConsent: newValue };

      const result = await updateConsent(input);

      if (result.error) {
        setIsEnabled(!newValue); // Revert
        setError(result.error.message);
      }
    });
  }

  return (
    <div className="flex items-start gap-3">
      {/* Toggle switch */}
      <button
        role="switch"
        aria-checked={isEnabled}
        onClick={handleToggle}
        disabled={isPending}
        className={`relative mt-0.5 flex h-6 w-11 flex-shrink-0 items-center rounded-full transition-colors ${
          isEnabled ? 'bg-amber-500' : 'bg-gray-200'
        } ${isPending ? 'opacity-60' : ''}`}
      >
        <span
          className={`inline-block h-4 w-4 transform rounded-full bg-white shadow transition-transform ${
            isEnabled ? 'translate-x-6' : 'translate-x-1'
          }`}
        />
      </button>
      <div className="min-w-0 flex-1">
        <p className="text-sm font-medium text-gray-900">{label}</p>
        <p className="text-xs text-gray-500">{description}</p>
        {error && <p className="mt-1 text-xs text-red-600">{error}</p>}
      </div>
    </div>
  );
}


===== D:\.code\wattleos\src\components\domain\parent\ContactInfoForm.tsx =====

// src/components/domain/parent/ContactInfoForm.tsx
//
// ============================================================
// WattleOS V2 - Contact Info Form (Client Component)
// ============================================================
// Phone number self-service. Parents can update their contact
// number without admin intervention. Shows inline edit pattern.
// ============================================================

"use client";

import { updateContactInfo } from "@/lib/actions/parent";
import { useState, useTransition } from "react";

interface ContactInfoFormProps {
  guardianId: string;
  initialPhone: string | null;
}

export function ContactInfoForm({
  guardianId,
  initialPhone,
}: ContactInfoFormProps) {
  const [isEditing, setIsEditing] = useState(false);
  const [phone, setPhone] = useState(initialPhone ?? "");
  const [savedPhone, setSavedPhone] = useState(initialPhone ?? "");
  const [isPending, startTransition] = useTransition();
  const [error, setError] = useState<string | null>(null);
  const [saved, setSaved] = useState(false);

  function handleSave() {
    setError(null);
    setSaved(false);

    startTransition(async () => {
      const result = await updateContactInfo({
        guardianId,
        phone: phone.trim() || null,
      });

      if (result.error) {
        setError(result.error.message);
      } else {
        setSavedPhone(phone.trim());
        setIsEditing(false);
        setSaved(true);
        setTimeout(() => setSaved(false), 2000);
      }
    });
  }

  function handleCancel() {
    setPhone(savedPhone);
    setIsEditing(false);
    setError(null);
  }

  if (!isEditing) {
    return (
      <div className="mt-2 flex items-center gap-3">
        <div className="text-sm text-gray-700">
          {savedPhone ? (
            <span>ðŸ“ž {savedPhone}</span>
          ) : (
            <span className="italic text-gray-400">No phone number set</span>
          )}
        </div>
        <button
          onClick={() => setIsEditing(true)}
          className="text-xs font-medium text-amber-600 hover:text-amber-700"
        >
          Edit
        </button>
        {saved && <span className="text-xs text-green-600">Saved</span>}
      </div>
    );
  }

  return (
    <div className="mt-2 space-y-2">
      <div className="flex items-center gap-2">
        <input
          type="tel"
          value={phone}
          onChange={(e) => setPhone(e.target.value)}
          placeholder="e.g., 0412 345 678"
          autoFocus
          className="block w-full max-w-xs rounded-md border border-gray-300 px-3 py-1.5 text-sm focus:border-ring focus:outline-none focus:ring-1 focus:ring-ring"
        />
        <button
          onClick={handleSave}
          disabled={isPending}
          className="rounded-md bg-amber-600 px-3 py-1.5 text-xs font-medium text-white hover:bg-amber-700 disabled:opacity-50"
        >
          {isPending ? "Saving..." : "Save"}
        </button>
        <button
          onClick={handleCancel}
          disabled={isPending}
          className="rounded-md border border-gray-300 px-3 py-1.5 text-xs font-medium text-gray-700 hover:bg-gray-50"
        >
          Cancel
        </button>
      </div>
      {error && <p className="text-xs text-red-600">{error}</p>}
    </div>
  );
}



===== D:\.code\wattleos\src\components\domain\reports\GenerateReportsForm.tsx =====

// src/components/domain/reports/GenerateReportsForm.tsx
//
// ============================================================
// WattleOS V2 - Generate Reports Form (Client Component)
// ============================================================
// Multi-step form for generating student reports:
//   1. Pick a template
//   2. Pick a class (loads students) or select individual students
//   3. Set term label and reporting period dates
//   4. Generate â†’ shows results â†’ link to reports list
//
// WHY client: Multi-step form with dynamic student loading
// requires client-side state management.
// ============================================================

"use client";

import { bulkGenerateReports } from "@/lib/actions/reports";
import { listStudents } from "@/lib/actions/sis";
import type { Student } from "@/types/domain";
import { useRouter } from "next/navigation";
import { useEffect, useState } from "react";

interface TemplateOption {
  id: string;
  name: string;
  cycleLevel: string | null;
  sectionCount: number;
}

interface ClassOption {
  id: string;
  name: string;
  cycleLevel: string | null;
  studentCount: number;
}

interface GenerateReportsFormProps {
  templates: TemplateOption[];
  classes: ClassOption[];
}

interface GenerationResult {
  generated: number;
  skipped: number;
  errors: string[];
}

export function GenerateReportsForm({
  templates,
  classes,
}: GenerateReportsFormProps) {
  // â”€â”€ Form state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const [selectedTemplateId, setSelectedTemplateId] = useState("");
  const [selectedClassId, setSelectedClassId] = useState("");
  const [students, setStudents] = useState<
    Pick<
      Student,
      "id" | "first_name" | "last_name" | "preferred_name" | "photo_url"
    >[]
  >([]);
  const [selectedStudentIds, setSelectedStudentIds] = useState<Set<string>>(
    new Set(),
  );
  const [term, setTerm] = useState("");
  const [periodStart, setPeriodStart] = useState("");
  const [periodEnd, setPeriodEnd] = useState("");

  // â”€â”€ UI state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const [isLoadingStudents, setIsLoadingStudents] = useState(false);
  const [isGenerating, setIsGenerating] = useState(false);
  const [result, setResult] = useState<GenerationResult | null>(null);
  const [error, setError] = useState<string | null>(null);

  const router = useRouter();

  // â”€â”€ Load students when class changes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  useEffect(() => {
    if (!selectedClassId) {
      setStudents([]);
      setSelectedStudentIds(new Set());
      return;
    }

    async function loadStudents() {
      setIsLoadingStudents(true);
      const result = await listStudents({
        class_id: selectedClassId,
        per_page: 100,
        enrollment_status: "active",
      });
      const studentList = (result.data ?? []).map((s) => ({
        id: s.id,
        first_name: s.first_name,
        last_name: s.last_name,
        preferred_name: s.preferred_name,
        photo_url: s.photo_url,
      }));
      setStudents(studentList);
      // Select all by default
      setSelectedStudentIds(new Set(studentList.map((s) => s.id)));
      setIsLoadingStudents(false);
    }

    loadStudents();
  }, [selectedClassId]);

  // â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function toggleStudent(studentId: string) {
    setSelectedStudentIds((prev) => {
      const next = new Set(prev);
      if (next.has(studentId)) {
        next.delete(studentId);
      } else {
        next.add(studentId);
      }
      return next;
    });
  }

  function toggleAllStudents() {
    if (selectedStudentIds.size === students.length) {
      setSelectedStudentIds(new Set());
    } else {
      setSelectedStudentIds(new Set(students.map((s) => s.id)));
    }
  }

  const isValid =
    selectedTemplateId &&
    selectedStudentIds.size > 0 &&
    term.trim() &&
    periodStart &&
    periodEnd;

  // â”€â”€ Generate â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function handleGenerate() {
    if (!isValid) return;

    setIsGenerating(true);
    setError(null);
    setResult(null);

    const res = await bulkGenerateReports({
      studentIds: Array.from(selectedStudentIds),
      templateId: selectedTemplateId,
      term: term.trim(),
      periodStart,
      periodEnd,
    });

    if (res.error) {
      setError(res.error.message);
    } else if (res.data) {
      setResult(res.data);
    }

    setIsGenerating(false);
  }

  // â”€â”€ Result screen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if (result) {
    return (
      <div className="rounded-lg border border-gray-200 bg-white p-8">
        <div className="mx-auto max-w-md text-center">
          {result.generated > 0 ? (
            <div className="mb-4 flex h-12 w-12 mx-auto items-center justify-center rounded-full bg-green-100">
              <svg
                className="h-6 w-6 text-green-600"
                fill="none"
                viewBox="0 0 24 24"
                strokeWidth={2}
                stroke="currentColor"
              >
                <path
                  strokeLinecap="round"
                  strokeLinejoin="round"
                  d="m4.5 12.75 6 6 9-13.5"
                />
              </svg>
            </div>
          ) : (
            <div className="mb-4 flex h-12 w-12 mx-auto items-center justify-center rounded-full bg-amber-100">
              <svg
                className="h-6 w-6 text-amber-600"
                fill="none"
                viewBox="0 0 24 24"
                strokeWidth={2}
                stroke="currentColor"
              >
                <path
                  strokeLinecap="round"
                  strokeLinejoin="round"
                  d="M12 9v3.75m9-.75a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9 3.75h.008v.008H12v-.008Z"
                />
              </svg>
            </div>
          )}

          <h2 className="text-lg font-semibold text-gray-900">
            Generation Complete
          </h2>

          <div className="mt-4 space-y-2 text-sm">
            {result.generated > 0 && (
              <p className="text-green-700">
                âœ“ {result.generated} report{result.generated !== 1 ? "s" : ""}{" "}
                generated
              </p>
            )}
            {result.skipped > 0 && (
              <p className="text-amber-700">
                âŠ˜ {result.skipped} skipped (already exist for this term)
              </p>
            )}
            {result.errors.length > 0 && (
              <div className="text-left">
                <p className="font-medium text-red-700">
                  âœ• {result.errors.length} error
                  {result.errors.length !== 1 ? "s" : ""}:
                </p>
                <ul className="mt-1 list-inside list-disc text-xs text-red-600">
                  {result.errors.slice(0, 5).map((err, i) => (
                    <li key={i}>{err}</li>
                  ))}
                  {result.errors.length > 5 && (
                    <li>...and {result.errors.length - 5} more</li>
                  )}
                </ul>
              </div>
            )}
          </div>

          <div className="mt-6 flex justify-center gap-3">
            <button
              onClick={() => {
                setResult(null);
                setSelectedStudentIds(new Set());
              }}
              className="rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50"
            >
              Generate More
            </button>
            <button
              onClick={() =>
                router.push(`/reports?term=${encodeURIComponent(term)}`)
              }
              className="rounded-md bg-amber-600 px-4 py-2 text-sm font-medium text-white hover:bg-amber-700"
            >
              View Reports
            </button>
          </div>
        </div>
      </div>
    );
  }

  // â”€â”€ Main form â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  return (
    <div className="space-y-6">
      {/* Step 1: Template */}
      <div className="rounded-lg border border-gray-200 bg-white p-5">
        <h2 className="text-sm font-semibold text-gray-900">
          1. Choose a Template
        </h2>
        <p className="mt-1 text-xs text-gray-500">
          The template determines what sections appear in each report.
        </p>
        <div className="mt-3 grid gap-2 sm:grid-cols-2 lg:grid-cols-3">
          {templates.map((t) => (
            <button
              key={t.id}
              onClick={() => setSelectedTemplateId(t.id)}
              className={`rounded-md border p-3 text-left transition-all ${
                selectedTemplateId === t.id
                  ? "border-amber-400 bg-amber-50 ring-1 ring-amber-400"
                  : "border-gray-200 hover:border-gray-300 hover:bg-gray-50"
              }`}
            >
              <p className="text-sm font-medium text-gray-900">{t.name}</p>
              <div className="mt-1 flex items-center gap-2 text-xs text-gray-500">
                {t.cycleLevel && <span>{t.cycleLevel}</span>}
                <span>{t.sectionCount} sections</span>
              </div>
            </button>
          ))}
        </div>
      </div>

      {/* Step 2: Students */}
      <div className="rounded-lg border border-gray-200 bg-white p-5">
        <h2 className="text-sm font-semibold text-gray-900">
          2. Select Students
        </h2>
        <p className="mt-1 text-xs text-gray-500">
          Pick a class to load its students, then select which ones to generate
          reports for.
        </p>

        {/* Class picker */}
        <div className="mt-3">
          <select
            value={selectedClassId}
            onChange={(e) => setSelectedClassId(e.target.value)}
            className="block w-full max-w-xs rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-ring focus:outline-none focus:ring-1 focus:ring-ring"
          >
            <option value="">Select a class...</option>
            {classes.map((c) => (
              <option key={c.id} value={c.id}>
                {c.name}
                {c.cycleLevel ? ` (${c.cycleLevel})` : ""} - {c.studentCount}{" "}
                student{c.studentCount !== 1 ? "s" : ""}
              </option>
            ))}
          </select>
        </div>

        {/* Student list */}
        {isLoadingStudents && (
          <div className="mt-4 text-sm text-gray-500">Loading students...</div>
        )}

        {!isLoadingStudents && students.length > 0 && (
          <div className="mt-4">
            <div className="mb-2 flex items-center justify-between">
              <button
                onClick={toggleAllStudents}
                className="text-xs font-medium text-amber-600 hover:text-amber-700"
              >
                {selectedStudentIds.size === students.length
                  ? "Deselect All"
                  : "Select All"}
              </button>
              <span className="text-xs text-gray-500">
                {selectedStudentIds.size} of {students.length} selected
              </span>
            </div>
            <div className="grid gap-1 sm:grid-cols-2 lg:grid-cols-3">
              {students.map((student) => {
                const isSelected = selectedStudentIds.has(student.id);
                return (
                  <button
                    key={student.id}
                    onClick={() => toggleStudent(student.id)}
                    className={`flex items-center gap-2 rounded-md border px-3 py-2 text-left text-sm transition-all ${
                      isSelected
                        ? "border-amber-300 bg-amber-50"
                        : "border-gray-200 text-gray-500 hover:border-gray-300"
                    }`}
                  >
                    <div
                      className={`flex h-4 w-4 flex-shrink-0 items-center justify-center rounded border ${
                        isSelected
                          ? "border-amber-500 bg-amber-500"
                          : "border-gray-300"
                      }`}
                    >
                      {isSelected && (
                        <svg
                          className="h-3 w-3 text-white"
                          fill="none"
                          viewBox="0 0 24 24"
                          strokeWidth={3}
                          stroke="currentColor"
                        >
                          <path
                            strokeLinecap="round"
                            strokeLinejoin="round"
                            d="m4.5 12.75 6 6 9-13.5"
                          />
                        </svg>
                      )}
                    </div>
                    {student.photo_url ? (
                      <img
                        src={student.photo_url}
                        alt=""
                        className="h-6 w-6 rounded-full object-cover"
                      />
                    ) : (
                      <div className="flex h-6 w-6 items-center justify-center rounded-full bg-gray-100 text-[10px] font-medium text-gray-500">
                        {student.first_name?.[0]}
                        {student.last_name?.[0]}
                      </div>
                    )}
                    <span
                      className={`truncate ${isSelected ? "text-gray-900" : ""}`}
                    >
                      {student.preferred_name ?? student.first_name}{" "}
                      {student.last_name}
                    </span>
                  </button>
                );
              })}
            </div>
          </div>
        )}

        {!isLoadingStudents && selectedClassId && students.length === 0 && (
          <p className="mt-4 text-sm text-gray-500">
            No active students in this class.
          </p>
        )}
      </div>

      {/* Step 3: Term & Period */}
      <div className="rounded-lg border border-gray-200 bg-white p-5">
        <h2 className="text-sm font-semibold text-gray-900">
          3. Reporting Period
        </h2>
        <p className="mt-1 text-xs text-gray-500">
          Set the term label and date range. Auto-populated data (attendance,
          observations) will be pulled from this period.
        </p>
        <div className="mt-3 grid gap-4 sm:grid-cols-3">
          <div>
            <label className="block text-xs font-medium text-gray-600">
              Term Label <span className="text-red-500">*</span>
            </label>
            <input
              type="text"
              value={term}
              onChange={(e) => setTerm(e.target.value)}
              placeholder="e.g., Term 1 2026"
              className="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-ring focus:outline-none focus:ring-1 focus:ring-ring"
            />
          </div>
          <div>
            <label className="block text-xs font-medium text-gray-600">
              Period Start <span className="text-red-500">*</span>
            </label>
            <input
              type="date"
              value={periodStart}
              onChange={(e) => setPeriodStart(e.target.value)}
              className="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-ring focus:outline-none focus:ring-1 focus:ring-ring"
            />
          </div>
          <div>
            <label className="block text-xs font-medium text-gray-600">
              Period End <span className="text-red-500">*</span>
            </label>
            <input
              type="date"
              value={periodEnd}
              onChange={(e) => setPeriodEnd(e.target.value)}
              className="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-ring focus:outline-none focus:ring-1 focus:ring-ring"
            />
          </div>
        </div>
      </div>

      {/* Error */}
      {error && (
        <div className="rounded-md bg-red-50 p-3 text-sm text-red-700">
          {error}
        </div>
      )}

      {/* Generate button */}
      <div className="flex items-center justify-between rounded-lg border border-gray-200 bg-white px-5 py-4">
        <div className="text-sm text-gray-500">
          {selectedStudentIds.size > 0 ? (
            <>
              Ready to generate{" "}
              <span className="font-medium text-gray-900">
                {selectedStudentIds.size}
              </span>{" "}
              report{selectedStudentIds.size !== 1 ? "s" : ""}
              {selectedTemplateId && (
                <>
                  {" "}
                  using{" "}
                  <span className="font-medium text-gray-900">
                    {templates.find((t) => t.id === selectedTemplateId)?.name}
                  </span>
                </>
              )}
            </>
          ) : (
            "Select a template and students to continue"
          )}
        </div>
        <button
          onClick={handleGenerate}
          disabled={!isValid || isGenerating}
          className="rounded-md bg-amber-600 px-6 py-2 text-sm font-medium text-white transition-colors hover:bg-amber-700 disabled:opacity-50"
        >
          {isGenerating
            ? `Generating ${selectedStudentIds.size} report${selectedStudentIds.size !== 1 ? "s" : ""}...`
            : `Generate ${selectedStudentIds.size} Report${selectedStudentIds.size !== 1 ? "s" : ""}`}
        </button>
      </div>
    </div>
  );
}



===== D:\.code\wattleos\src\components\domain\reports\NewTemplateForm.tsx =====

// src/components/domain/reports/NewTemplateForm.tsx
//
// ============================================================
// WattleOS V2 - New Template Form (Client Component)
// ============================================================
// Collects template name and cycle level, creates the template
// with default sections, and redirects to the builder.
// ============================================================

"use client";

import { createReportTemplate } from "@/lib/actions/reports";
import { useRouter } from "next/navigation";
import { useState } from "react";

export function NewTemplateForm() {
  const [name, setName] = useState("");
  const [cycleLevel, setCycleLevel] = useState("");
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const router = useRouter();

  async function handleSubmit(e: React.FormEvent) {
    e.preventDefault();
    if (!name.trim()) return;

    setIsLoading(true);
    setError(null);

    const result = await createReportTemplate({
      name: name.trim(),
      cycleLevel: cycleLevel.trim() || null,
    });

    if (result.error) {
      setError(result.error.message);
      setIsLoading(false);
    } else if (result.data) {
      // Redirect to the builder
      router.push(`/reports/templates/${result.data.id}`);
    }
  }

  return (
    <form
      onSubmit={handleSubmit}
      className="space-y-5 rounded-lg border border-gray-200 bg-white p-6"
    >
      {/* Template name */}
      <div>
        <label
          htmlFor="name"
          className="block text-sm font-medium text-gray-700"
        >
          Template Name <span className="text-red-500">*</span>
        </label>
        <input
          id="name"
          type="text"
          value={name}
          onChange={(e) => setName(e.target.value)}
          placeholder="e.g., End of Term 3-6 Report"
          autoFocus
          className="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 text-sm shadow-sm focus:border-ring focus:outline-none focus:ring-1 focus:ring-ring"
        />
      </div>

      {/* Cycle level */}
      <div>
        <label
          htmlFor="cycleLevel"
          className="block text-sm font-medium text-gray-700"
        >
          Cycle Level
        </label>
        <p className="text-xs text-gray-500">
          Optionally scope this template to a specific age group
        </p>
        <select
          id="cycleLevel"
          value={cycleLevel}
          onChange={(e) => setCycleLevel(e.target.value)}
          className="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 text-sm shadow-sm focus:border-ring focus:outline-none focus:ring-1 focus:ring-ring"
        >
          <option value="">All cycle levels</option>
          <option value="0-3">Infant / Toddler (0â€“3)</option>
          <option value="3-6">Primary (3â€“6)</option>
          <option value="6-9">Lower Elementary (6â€“9)</option>
          <option value="6-12">Elementary (6â€“12)</option>
          <option value="9-12">Upper Elementary (9â€“12)</option>
          <option value="12-15">Adolescent (12â€“15)</option>
        </select>
      </div>

      {/* Info about defaults */}
      <div className="rounded-md bg-amber-50 p-3">
        <p className="text-xs text-amber-800">
          Your template will be created with default sections (Student Info,
          Attendance Summary, Learning Progress, Teacher Comments, Goals). You
          can add, remove, and reorder sections in the builder.
        </p>
      </div>

      {/* Error */}
      {error && (
        <div className="rounded-md bg-red-50 p-3 text-sm text-red-700">
          {error}
        </div>
      )}

      {/* Actions */}
      <div className="flex items-center justify-end gap-3">
        <a
          href="/reports/templates"
          className="rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50"
        >
          Cancel
        </a>
        <button
          type="submit"
          disabled={isLoading || !name.trim()}
          className="rounded-md bg-amber-600 px-4 py-2 text-sm font-medium text-white transition-colors hover:bg-amber-700 disabled:opacity-50"
        >
          {isLoading ? "Creating..." : "Create & Customize"}
        </button>
      </div>
    </form>
  );
}



===== D:\.code\wattleos\src\components\domain\reports\report-pdf-actions.tsx =====

// src/components/domain/reports/report-pdf-actions.tsx
//
// ============================================================
// WattleOS V2 - Report PDF Action Buttons
// ============================================================
// Client component that provides Export PDF / Download PDF
// buttons for the report detail page.
//
// Two states:
//   1. No PDF exists yet â†’ "Export PDF" button â†’ calls exportReportToPdf
//   2. PDF exists â†’ "Download PDF" link + "Re-export" option
//
// WHY client component: Needs loading state, error handling, and
// triggering a browser download after the server action completes.
// ============================================================

'use client';

import { useState, useCallback } from 'react';
import { exportReportToPdf, getReportPdfUrl } from '@/lib/actions/report-export';

interface ReportPdfActionsProps {
  reportId: string;
  reportStatus: string;
  hasPdf: boolean;
  /** If true, uses parent-scoped download (no export, download only) */
  isParentView?: boolean;
}

export function ReportPdfActions({
  reportId,
  reportStatus,
  hasPdf,
  isParentView = false,
}: ReportPdfActionsProps) {
  const [isExporting, setIsExporting] = useState(false);
  const [isDownloading, setIsDownloading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [lastExportedAt, setLastExportedAt] = useState<string | null>(null);

  const canExport = reportStatus === 'approved' || reportStatus === 'published';

  // â”€â”€ Export (generate + upload) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  const handleExport = useCallback(async () => {
    setIsExporting(true);
    setError(null);

    const result = await exportReportToPdf(reportId);

    if (result.error) {
      setError(result.error.message);
      setIsExporting(false);
      return;
    }

    if (result.data) {
      // Trigger browser download
      triggerDownload(result.data.download_url, result.data.filename);
      setLastExportedAt(new Date().toLocaleTimeString());
    }

    setIsExporting(false);
  }, [reportId]);

  // â”€â”€ Download (existing PDF) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  const handleDownload = useCallback(async () => {
    setIsDownloading(true);
    setError(null);

    if (isParentView) {
      // Parents use the direct API route
      window.open(`/api/reports/${reportId}/pdf?parent=true`, '_blank');
      setIsDownloading(false);
      return;
    }

    const result = await getReportPdfUrl(reportId);

    if (result.error) {
      setError(result.error.message);
      setIsDownloading(false);
      return;
    }

    if (result.data) {
      triggerDownload(result.data.download_url, result.data.filename);
    }

    setIsDownloading(false);
  }, [reportId, isParentView]);

  // â”€â”€ Parent view: download only â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  if (isParentView) {
    if (!hasPdf) return null;

    return (
      <button
        onClick={handleDownload}
        disabled={isDownloading}
        className="inline-flex items-center gap-2 rounded-lg bg-amber-600 px-4 py-2 text-sm font-medium text-white shadow-sm transition-colors hover:bg-amber-700 disabled:cursor-not-allowed disabled:opacity-50"
      >
        <DownloadIcon />
        {isDownloading ? 'Preparing...' : 'Download PDF'}
      </button>
    );
  }

  // â”€â”€ Staff view: export + download â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  return (
    <div className="flex flex-col gap-2">
      <div className="flex items-center gap-2">
        {/* Primary action: Export or Download */}
        {hasPdf ? (
          <>
            <button
              onClick={handleDownload}
              disabled={isDownloading}
              className="inline-flex items-center gap-2 rounded-lg bg-amber-600 px-4 py-2 text-sm font-medium text-white shadow-sm transition-colors hover:bg-amber-700 disabled:cursor-not-allowed disabled:opacity-50"
            >
              <DownloadIcon />
              {isDownloading ? 'Preparing...' : 'Download PDF'}
            </button>
            {canExport && (
              <button
                onClick={handleExport}
                disabled={isExporting}
                className="inline-flex items-center gap-2 rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm font-medium text-gray-700 shadow-sm transition-colors hover:bg-gray-50 disabled:cursor-not-allowed disabled:opacity-50"
                title="Regenerate the PDF with the latest report content"
              >
                <RefreshIcon />
                {isExporting ? 'Generating...' : 'Re-export'}
              </button>
            )}
          </>
        ) : canExport ? (
          <button
            onClick={handleExport}
            disabled={isExporting}
            className="inline-flex items-center gap-2 rounded-lg bg-amber-600 px-4 py-2 text-sm font-medium text-white shadow-sm transition-colors hover:bg-amber-700 disabled:cursor-not-allowed disabled:opacity-50"
          >
            <ExportIcon />
            {isExporting ? 'Generating PDF...' : 'Export PDF'}
          </button>
        ) : (
          <p className="text-sm text-gray-500">
            Report must be approved or published before exporting to PDF.
          </p>
        )}
      </div>

      {/* Status messages */}
      {error && (
        <p className="text-sm text-red-600">{error}</p>
      )}
      {lastExportedAt && !error && (
        <p className="text-sm text-green-600">
          PDF exported successfully at {lastExportedAt}
        </p>
      )}
    </div>
  );
}

// ============================================================
// Helpers
// ============================================================

function triggerDownload(url: string, filename: string) {
  const link = document.createElement('a');
  link.href = url;
  link.download = filename;
  link.target = '_blank';
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

// ============================================================
// Icons (inline SVG - no external dependency)
// ============================================================

function DownloadIcon() {
  return (
    <svg
      className="h-4 w-4"
      fill="none"
      viewBox="0 0 24 24"
      strokeWidth={2}
      stroke="currentColor"
    >
      <path
        strokeLinecap="round"
        strokeLinejoin="round"
        d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3"
      />
    </svg>
  );
}

function ExportIcon() {
  return (
    <svg
      className="h-4 w-4"
      fill="none"
      viewBox="0 0 24 24"
      strokeWidth={2}
      stroke="currentColor"
    >
      <path
        strokeLinecap="round"
        strokeLinejoin="round"
        d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m2.25 0H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z"
      />
    </svg>
  );
}

function RefreshIcon() {
  return (
    <svg
      className="h-4 w-4"
      fill="none"
      viewBox="0 0 24 24"
      strokeWidth={2}
      stroke="currentColor"
    >
      <path
        strokeLinecap="round"
        strokeLinejoin="round"
        d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182"
      />
    </svg>
  );
}


===== D:\.code\wattleos\src\components\domain\reports\ReportEditor.tsx =====

// src/components/domain/reports/ReportEditor.tsx
//
// ============================================================
// WattleOS V2 - Report Editor (Client Component)
// ============================================================
// The teacher-facing report editor. Renders each section:
//   - Auto sections show populated data (mastery, attendance, etc.)
//   - Editable sections have a textarea for teacher narratives
//   - Each section can be marked complete
//   - Status workflow buttons at the top
//
// WHY client: Narrative editing, completion toggling, and status
// transitions all require interactive state. Saves are explicit
// (button click) to avoid mid-typing server calls.
// ============================================================

"use client";

import type { ReportCompletionStats } from "@/lib/actions/reports";
import { updateReportContent, updateReportStatus } from "@/lib/actions/reports";
import type {
  ReportAutoData,
  ReportContent,
  ReportSectionContent,
  TemplateSectionType,
} from "@/lib/reports/types";
import type { ReportStatus } from "@/types/domain";
import { useRouter } from "next/navigation";
import { useCallback, useState } from "react";

// ============================================================
// Props
// ============================================================

interface ReportEditorProps {
  reportId: string;
  reportStatus: ReportStatus;
  reportContent: ReportContent;
  completionStats: ReportCompletionStats;
  studentName: string;
  studentPhotoUrl: string | null;
  authorName: string;
  term: string | null;
}

// ============================================================
// Status workflow config
// ============================================================

const STATUS_CONFIG: Record<
  ReportStatus,
  {
    label: string;
    bgColor: string;
    textColor: string;
    actions: Array<{
      targetStatus: ReportStatus;
      label: string;
      variant: "primary" | "secondary" | "danger";
    }>;
  }
> = {
  draft: {
    label: "Draft",
    bgColor: "bg-gray-100",
    textColor: "text-gray-700",
    actions: [
      {
        targetStatus: "review",
        label: "Submit for Review",
        variant: "primary",
      },
    ],
  },
  review: {
    label: "In Review",
    bgColor: "bg-blue-100",
    textColor: "text-blue-700",
    actions: [
      {
        targetStatus: "draft",
        label: "Send Back to Draft",
        variant: "secondary",
      },
      { targetStatus: "approved", label: "Approve", variant: "primary" },
    ],
  },
  approved: {
    label: "Approved",
    bgColor: "bg-amber-100",
    textColor: "text-amber-700",
    actions: [
      {
        targetStatus: "review",
        label: "Send Back to Review",
        variant: "secondary",
      },
      { targetStatus: "published", label: "Publish", variant: "primary" },
    ],
  },
  published: {
    label: "Published",
    bgColor: "bg-green-100",
    textColor: "text-green-700",
    actions: [
      { targetStatus: "approved", label: "Unpublish", variant: "danger" },
    ],
  },
};

const VARIANT_STYLES = {
  primary: "bg-amber-600 text-white hover:bg-amber-700",
  secondary: "border border-gray-300 bg-white text-gray-700 hover:bg-gray-50",
  danger: "border border-red-300 bg-white text-red-700 hover:bg-red-50",
};

// ============================================================
// Component
// ============================================================

export function ReportEditor({
  reportId,
  reportStatus,
  reportContent,
  completionStats,
  studentName,
  studentPhotoUrl,
  authorName,
  term,
}: ReportEditorProps) {
  const [sections, setSections] = useState<ReportSectionContent[]>(
    reportContent?.sections ?? [],
  );
  const [currentStatus, setCurrentStatus] =
    useState<ReportStatus>(reportStatus);
  const [isSaving, setIsSaving] = useState(false);
  const [isTransitioning, setIsTransitioning] = useState(false);
  const [hasChanges, setHasChanges] = useState(false);
  const [saveMessage, setSaveMessage] = useState<{
    type: "success" | "error";
    text: string;
  } | null>(null);
  const router = useRouter();

  const isEditable = currentStatus === "draft" || currentStatus === "review";
  const statusConfig = STATUS_CONFIG[currentStatus];

  // â”€â”€ Section editing â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  const updateNarrative = useCallback(
    (templateSectionId: string, narrative: string) => {
      setSections((prev) =>
        prev.map((s) =>
          s.templateSectionId === templateSectionId ? { ...s, narrative } : s,
        ),
      );
      setHasChanges(true);
      setSaveMessage(null);
    },
    [],
  );

  const toggleComplete = useCallback((templateSectionId: string) => {
    setSections((prev) =>
      prev.map((s) =>
        s.templateSectionId === templateSectionId
          ? { ...s, completed: !s.completed }
          : s,
      ),
    );
    setHasChanges(true);
    setSaveMessage(null);
  }, []);

  // â”€â”€ Save content â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  async function handleSave() {
    setIsSaving(true);
    setSaveMessage(null);

    const sectionUpdates = sections
      .filter((s) => isEditableType(s.type))
      .map((s) => ({
        templateSectionId: s.templateSectionId,
        narrative: s.narrative,
        completed: s.completed,
      }));

    const result = await updateReportContent(reportId, {
      sections: sectionUpdates,
    });

    if (result.error) {
      setSaveMessage({ type: "error", text: result.error.message });
    } else {
      setSaveMessage({ type: "success", text: "Saved" });
      setHasChanges(false);
      router.refresh();
    }

    setIsSaving(false);
  }

  // â”€â”€ Status transition â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  async function handleStatusChange(newStatus: ReportStatus) {
    // Save any pending changes first
    if (hasChanges && isEditable) {
      await handleSave();
    }

    setIsTransitioning(true);
    setSaveMessage(null);

    const result = await updateReportStatus(reportId, newStatus);

    if (result.error) {
      setSaveMessage({ type: "error", text: result.error.message });
    } else {
      setCurrentStatus(newStatus);
      setSaveMessage({
        type: "success",
        text: `Status changed to ${STATUS_CONFIG[newStatus].label}`,
      });
      router.refresh();
    }

    setIsTransitioning(false);
  }

  // â”€â”€ Compute live completion â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  const editableCount = sections.filter((s) => isEditableType(s.type)).length;
  const completedEditable = sections.filter(
    (s) => isEditableType(s.type) && s.completed,
  ).length;
  const livePercent =
    editableCount > 0
      ? Math.round((completedEditable / editableCount) * 100)
      : 100;

  return (
    <div className="space-y-6">
      {/* Status bar */}
      <div className="flex flex-wrap items-center justify-between gap-4 rounded-lg border border-gray-200 bg-white px-5 py-4">
        <div className="flex items-center gap-4">
          {/* Status badge */}
          <span
            className={`inline-flex rounded-full px-3 py-1 text-sm font-medium ${statusConfig.bgColor} ${statusConfig.textColor}`}
          >
            {statusConfig.label}
          </span>

          {/* Progress */}
          <div className="flex items-center gap-2">
            <div className="h-2 w-24 overflow-hidden rounded-full bg-gray-100">
              <div
                className="h-full rounded-full bg-amber-500 transition-all duration-300"
                style={{ width: `${livePercent}%` }}
              />
            </div>
            <span className="text-xs text-gray-500">
              {completedEditable}/{editableCount} sections complete
            </span>
          </div>

          {/* Save indicator */}
          {hasChanges && (
            <span className="text-xs text-amber-600 font-medium">
              Unsaved changes
            </span>
          )}
          {saveMessage && (
            <span
              className={`text-xs font-medium ${
                saveMessage.type === "success"
                  ? "text-green-600"
                  : "text-red-600"
              }`}
            >
              {saveMessage.text}
            </span>
          )}
        </div>

        {/* Actions */}
        <div className="flex items-center gap-2">
          {isEditable && (
            <button
              onClick={handleSave}
              disabled={isSaving || !hasChanges}
              className="rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 transition-colors hover:bg-gray-50 disabled:opacity-50"
            >
              {isSaving ? "Saving..." : "Save"}
            </button>
          )}
          {statusConfig.actions.map((action) => (
            <button
              key={action.targetStatus}
              onClick={() => handleStatusChange(action.targetStatus)}
              disabled={isTransitioning}
              className={`rounded-md px-4 py-2 text-sm font-medium transition-colors disabled:opacity-50 ${VARIANT_STYLES[action.variant]}`}
            >
              {isTransitioning ? "..." : action.label}
            </button>
          ))}
        </div>
      </div>

      {/* Report period info */}
      {reportContent.reportingPeriod && (
        <div className="flex items-center gap-4 rounded-md bg-gray-50 px-4 py-2 text-xs text-gray-500">
          <span>
            Reporting period:{" "}
            {formatDate(reportContent.reportingPeriod.startDate)} â€“{" "}
            {formatDate(reportContent.reportingPeriod.endDate)}
          </span>
          <span>&middot;</span>
          <span>Author: {authorName}</span>
        </div>
      )}

      {/* Sections */}
      <div className="space-y-4">
        {sections.map((section) => (
          <ReportSection
            key={section.templateSectionId}
            section={section}
            isEditable={isEditable}
            onUpdateNarrative={updateNarrative}
            onToggleComplete={toggleComplete}
          />
        ))}
      </div>
    </div>
  );
}

// ============================================================
// ReportSection - renders a single section
// ============================================================

interface ReportSectionProps {
  section: ReportSectionContent;
  isEditable: boolean;
  onUpdateNarrative: (templateSectionId: string, narrative: string) => void;
  onToggleComplete: (templateSectionId: string) => void;
}

function ReportSection({
  section,
  isEditable,
  onUpdateNarrative,
  onToggleComplete,
}: ReportSectionProps) {
  const [isExpanded, setIsExpanded] = useState(true);

  return (
    <div
      className={`rounded-lg border bg-white transition-shadow ${
        section.completed ? "border-green-200" : "border-gray-200"
      }`}
    >
      {/* Section header */}
      <div
        className="flex cursor-pointer items-center justify-between px-5 py-4"
        onClick={() => setIsExpanded(!isExpanded)}
      >
        <div className="flex items-center gap-3">
          {/* Completion checkbox */}
          {isEditableType(section.type) && (
            <button
              onClick={(e) => {
                e.stopPropagation();
                if (isEditable) onToggleComplete(section.templateSectionId);
              }}
              disabled={!isEditable}
              className={`flex h-5 w-5 flex-shrink-0 items-center justify-center rounded border transition-colors ${
                section.completed
                  ? "border-green-500 bg-green-500"
                  : "border-gray-300 hover:border-gray-400"
              } ${!isEditable ? "opacity-60" : ""}`}
            >
              {section.completed && (
                <svg
                  className="h-3.5 w-3.5 text-white"
                  fill="none"
                  viewBox="0 0 24 24"
                  strokeWidth={3}
                  stroke="currentColor"
                >
                  <path
                    strokeLinecap="round"
                    strokeLinejoin="round"
                    d="m4.5 12.75 6 6 9-13.5"
                  />
                </svg>
              )}
            </button>
          )}
          {!isEditableType(section.type) && (
            <div className="flex h-5 w-5 flex-shrink-0 items-center justify-center rounded-full bg-blue-100">
              <svg
                className="h-3 w-3 text-blue-600"
                fill="none"
                viewBox="0 0 24 24"
                strokeWidth={2}
                stroke="currentColor"
              >
                <path
                  strokeLinecap="round"
                  strokeLinejoin="round"
                  d="m4.5 12.75 6 6 9-13.5"
                />
              </svg>
            </div>
          )}

          <h3 className="text-sm font-semibold text-gray-900">
            {section.title}
          </h3>
          <span className="rounded bg-gray-100 px-1.5 py-0.5 text-[10px] font-medium text-gray-500">
            {getSectionTypeLabel(section.type)}
          </span>
        </div>
        <svg
          className={`h-4 w-4 text-gray-400 transition-transform ${isExpanded ? "rotate-180" : ""}`}
          fill="none"
          viewBox="0 0 24 24"
          strokeWidth={2}
          stroke="currentColor"
        >
          <path
            strokeLinecap="round"
            strokeLinejoin="round"
            d="m19.5 8.25-7.5 7.5-7.5-7.5"
          />
        </svg>
      </div>

      {/* Section content */}
      {isExpanded && (
        <div className="border-t border-gray-100 px-5 py-4">
          {/* Auto data display */}
          {section.autoData && (
            <AutoDataRenderer autoData={section.autoData} type={section.type} />
          )}

          {/* Editable narrative */}
          {isEditableType(section.type) && (
            <div className={section.autoData ? "mt-4" : ""}>
              {isEditable ? (
                <div>
                  <textarea
                    value={section.narrative ?? ""}
                    onChange={(e) =>
                      onUpdateNarrative(
                        section.templateSectionId,
                        e.target.value,
                      )
                    }
                    rows={6}
                    placeholder={getPlaceholder(section)}
                    className="block w-full rounded-md border border-gray-300 px-3 py-2 text-sm leading-relaxed focus:border-ring focus:outline-none focus:ring-1 focus:ring-ring"
                  />
                  {section.narrative && (
                    <p className="mt-1 text-xs text-gray-400">
                      {countWords(section.narrative)} words
                    </p>
                  )}
                </div>
              ) : (
                <div className="prose prose-sm max-w-none text-gray-700">
                  {section.narrative ? (
                    <p className="whitespace-pre-wrap">{section.narrative}</p>
                  ) : (
                    <p className="italic text-gray-400">
                      No content written yet.
                    </p>
                  )}
                </div>
              )}
            </div>
          )}
        </div>
      )}
    </div>
  );
}

// ============================================================
// AutoDataRenderer - displays auto-populated data by type
// ============================================================

function AutoDataRenderer({
  autoData,
  type,
}: {
  autoData: ReportAutoData;
  type: TemplateSectionType;
}) {
  // â”€â”€ Student Info â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if (type === "student_info" && autoData.studentInfo) {
    const info = autoData.studentInfo;
    return (
      <div className="flex items-start gap-4">
        {info.photoUrl ? (
          <img
            src={info.photoUrl}
            alt=""
            className="h-16 w-16 rounded-lg object-cover"
          />
        ) : (
          <div className="flex h-16 w-16 items-center justify-center rounded-lg bg-gray-100 text-lg font-medium text-gray-400">
            {info.firstName[0]}
            {info.lastName[0]}
          </div>
        )}
        <div className="space-y-1 text-sm">
          <p className="font-medium text-gray-900">
            {info.preferredName
              ? `${info.preferredName} (${info.firstName} ${info.lastName})`
              : `${info.firstName} ${info.lastName}`}
          </p>
          {info.className && (
            <p className="text-gray-600">
              Class: {info.className}
              {info.cycleLevelName ? ` (${info.cycleLevelName})` : ""}
            </p>
          )}
          {info.dob && (
            <p className="text-gray-500">DOB: {formatDate(info.dob)}</p>
          )}
        </div>
      </div>
    );
  }

  // â”€â”€ Mastery Summary â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if (type === "mastery_summary" && autoData.masterySummary) {
    const ms = autoData.masterySummary;
    return (
      <div className="space-y-3">
        <div className="grid grid-cols-5 gap-3">
          <MasteryStatCard label="Total" value={ms.total} color="gray" />
          <MasteryStatCard
            label="Not Started"
            value={ms.notStarted}
            color="gray"
          />
          <MasteryStatCard
            label="Presented"
            value={ms.presented}
            color="blue"
          />
          <MasteryStatCard
            label="Practicing"
            value={ms.practicing}
            color="amber"
          />
          <MasteryStatCard label="Mastered" value={ms.mastered} color="green" />
        </div>
        <div className="flex items-center gap-2">
          <div className="h-2 flex-1 overflow-hidden rounded-full bg-gray-100">
            <div
              className="h-full rounded-full bg-green-500 transition-all"
              style={{ width: `${ms.percentMastered}%` }}
            />
          </div>
          <span className="text-sm font-medium text-gray-700">
            {ms.percentMastered}% mastered
          </span>
        </div>
      </div>
    );
  }

  // â”€â”€ Mastery Grid â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if (type === "mastery_grid" && autoData.masteryGrid) {
    const statusColors: Record<string, string> = {
      not_started: "bg-gray-100 text-gray-500",
      presented: "bg-blue-100 text-blue-700",
      practicing: "bg-amber-100 text-amber-700",
      mastered: "bg-green-100 text-green-700",
    };

    return (
      <div className="space-y-1">
        {autoData.masteryGrid.map((item) => (
          <div
            key={item.nodeId}
            className="flex items-center justify-between rounded px-3 py-1.5 text-sm hover:bg-gray-50"
          >
            <span className="text-gray-700">{item.nodeTitle}</span>
            <span
              className={`rounded-full px-2 py-0.5 text-xs font-medium ${
                statusColors[item.status] ?? statusColors.not_started
              }`}
            >
              {item.status.replace("_", " ")}
            </span>
          </div>
        ))}
        {autoData.masteryGrid.length === 0 && (
          <p className="text-sm text-gray-400 italic">
            No mastery data recorded.
          </p>
        )}
      </div>
    );
  }

  // â”€â”€ Attendance Summary â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if (type === "attendance_summary" && autoData.attendanceSummary) {
    const att = autoData.attendanceSummary;
    return (
      <div className="space-y-3">
        <div className="grid grid-cols-3 gap-3 sm:grid-cols-6">
          <AttendanceStatCard label="Total Days" value={att.totalDays} />
          <AttendanceStatCard
            label="Present"
            value={att.present}
            color="green"
          />
          <AttendanceStatCard label="Absent" value={att.absent} color="red" />
          <AttendanceStatCard label="Late" value={att.late} color="amber" />
          <AttendanceStatCard
            label="Excused"
            value={att.excused}
            color="blue"
          />
          <AttendanceStatCard
            label="Half Day"
            value={att.halfDay}
            color="gray"
          />
        </div>
        <p className="text-sm text-gray-600">
          Attendance rate:{" "}
          <span className="font-medium text-gray-900">
            {att.attendanceRate}%
          </span>
        </p>
      </div>
    );
  }

  // â”€â”€ Observation Highlights â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if (type === "observation_highlights" && autoData.observationHighlights) {
    return (
      <div className="space-y-3">
        {autoData.observationHighlights.length === 0 ? (
          <p className="text-sm text-gray-400 italic">
            No published observations found for this period.
          </p>
        ) : (
          autoData.observationHighlights.map((obs) => (
            <div
              key={obs.id}
              className="rounded-md border border-gray-100 bg-gray-50 p-3"
            >
              <div className="flex items-center justify-between text-xs text-gray-500">
                <span>{formatDate(obs.createdAt)}</span>
                <span>By {obs.authorName}</span>
              </div>
              {obs.content && (
                <p className="mt-1 text-sm text-gray-700 line-clamp-3">
                  {obs.content}
                </p>
              )}
              <div className="mt-2 flex flex-wrap gap-1">
                {obs.outcomes.map((outcome, i) => (
                  <span
                    key={i}
                    className="rounded bg-amber-50 px-1.5 py-0.5 text-[10px] font-medium text-amber-700"
                  >
                    {outcome}
                  </span>
                ))}
                {obs.mediaCount > 0 && (
                  <span className="rounded bg-gray-100 px-1.5 py-0.5 text-[10px] font-medium text-gray-600">
                    ðŸ“· {obs.mediaCount}
                  </span>
                )}
              </div>
            </div>
          ))
        )}
      </div>
    );
  }

  return null;
}

// ============================================================
// Small stat cards
// ============================================================

function MasteryStatCard({
  label,
  value,
  color,
}: {
  label: string;
  value: number;
  color: "gray" | "blue" | "amber" | "green";
}) {
  const colors = {
    gray: "bg-gray-50 text-gray-700",
    blue: "bg-blue-50 text-blue-700",
    amber: "bg-amber-50 text-amber-700",
    green: "bg-green-50 text-green-700",
  };

  return (
    <div className={`rounded-md p-2 text-center ${colors[color]}`}>
      <p className="text-lg font-bold">{value}</p>
      <p className="text-[10px] uppercase tracking-wide opacity-75">{label}</p>
    </div>
  );
}

function AttendanceStatCard({
  label,
  value,
  color,
}: {
  label: string;
  value: number;
  color?: "green" | "red" | "amber" | "blue" | "gray";
}) {
  const colors: Record<string, string> = {
    green: "text-green-700",
    red: "text-red-700",
    amber: "text-amber-700",
    blue: "text-blue-700",
    gray: "text-gray-700",
  };

  return (
    <div className="rounded-md border border-gray-100 bg-gray-50 p-2 text-center">
      <p
        className={`text-lg font-bold ${color ? colors[color] : "text-gray-900"}`}
      >
        {value}
      </p>
      <p className="text-[10px] uppercase tracking-wide text-gray-500">
        {label}
      </p>
    </div>
  );
}

// ============================================================
// Helpers
// ============================================================

function isEditableType(type: TemplateSectionType): boolean {
  return [
    "narrative",
    "custom_text",
    "goals",
    "observation_highlights",
  ].includes(type);
}

function getSectionTypeLabel(type: TemplateSectionType): string {
  const labels: Record<TemplateSectionType, string> = {
    student_info: "Auto",
    narrative: "Write",
    mastery_grid: "Auto",
    mastery_summary: "Auto",
    attendance_summary: "Auto",
    observation_highlights: "Review",
    custom_text: "Write",
    goals: "Write",
  };
  return labels[type] ?? type;
}

function getPlaceholder(section: ReportSectionContent): string {
  // Try to get placeholder from template snapshot
  const templateContent = undefined; // Placeholder extraction would go here
  switch (section.type) {
    case "narrative":
      return "Write about the student's progress, strengths, and areas for growth...";
    case "custom_text":
      return "Write content for this section...";
    case "goals":
      return "Outline learning goals and focus areas for the upcoming term...";
    case "observation_highlights":
      return "Add your commentary on the observation highlights above...";
    default:
      return "";
  }
}

function countWords(text: string): number {
  return text
    .trim()
    .split(/\s+/)
    .filter((w) => w.length > 0).length;
}

function formatDate(dateStr: string): string {
  try {
    const date = new Date(dateStr);
    return date.toLocaleDateString("en-AU", {
      day: "numeric",
      month: "short",
      year: "numeric",
    });
  } catch {
    return dateStr;
  }
}



===== D:\.code\wattleos\src\components\domain\reports\TemplateActions.tsx =====

// src/components/domain/reports/TemplateActions.tsx
//
// ============================================================
// WattleOS V2 - Template Card Actions (Client Component)
// ============================================================
// Dropdown menu for template management: duplicate, toggle
// active status, delete. Uses a simple popover pattern
// consistent with other WattleOS action menus.
//
// WHY client: User clicks trigger server actions with
// optimistic feedback and router refresh.
// ============================================================

'use client';

import { useState, useRef, useEffect, useTransition } from 'react';
import { useRouter } from 'next/navigation';
import {
  duplicateReportTemplate,
  updateReportTemplate,
  deleteReportTemplate,
} from '@/lib/actions/reports';

interface TemplateActionsProps {
  templateId: string;
  isActive: boolean;
}

export function TemplateActions({ templateId, isActive }: TemplateActionsProps) {
  const [isOpen, setIsOpen] = useState(false);
  const [isPending, startTransition] = useTransition();
  const [error, setError] = useState<string | null>(null);
  const menuRef = useRef<HTMLDivElement>(null);
  const router = useRouter();

  // Close on click outside
  useEffect(() => {
    function handleClick(e: MouseEvent) {
      if (menuRef.current && !menuRef.current.contains(e.target as Node)) {
        setIsOpen(false);
      }
    }
    if (isOpen) {
      document.addEventListener('mousedown', handleClick);
      return () => document.removeEventListener('mousedown', handleClick);
    }
  }, [isOpen]);

  async function handleDuplicate() {
    setError(null);
    setIsOpen(false);
    const result = await duplicateReportTemplate(templateId);
    if (result.error) {
      setError(result.error.message);
    } else {
      startTransition(() => router.refresh());
    }
  }

  async function handleToggleActive() {
    setError(null);
    setIsOpen(false);
    const result = await updateReportTemplate(templateId, { isActive: !isActive });
    if (result.error) {
      setError(result.error.message);
    } else {
      startTransition(() => router.refresh());
    }
  }

  async function handleDelete() {
    setError(null);
    const confirmed = window.confirm(
      'Are you sure you want to delete this template? This cannot be undone.'
    );
    if (!confirmed) return;

    setIsOpen(false);
    const result = await deleteReportTemplate(templateId);
    if (result.error) {
      setError(result.error.message);
    } else {
      startTransition(() => router.refresh());
    }
  }

  return (
    <div ref={menuRef} className="relative">
      <button
        onClick={() => setIsOpen(!isOpen)}
        disabled={isPending}
        className="rounded-md p-1 text-gray-400 transition-colors hover:bg-gray-100 hover:text-gray-600 disabled:opacity-50"
        aria-label="Template actions"
      >
        <svg className="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
          <path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z" />
        </svg>
      </button>

      {isOpen && (
        <div className="absolute right-0 z-10 mt-1 w-44 rounded-md border border-gray-200 bg-white py-1 shadow-lg">
          <button
            onClick={handleDuplicate}
            className="flex w-full items-center gap-2 px-3 py-2 text-left text-sm text-gray-700 transition-colors hover:bg-gray-50"
          >
            <svg className="h-4 w-4 text-gray-400" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.5a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75" />
            </svg>
            Duplicate
          </button>
          <button
            onClick={handleToggleActive}
            className="flex w-full items-center gap-2 px-3 py-2 text-left text-sm text-gray-700 transition-colors hover:bg-gray-50"
          >
            {isActive ? (
              <>
                <svg className="h-4 w-4 text-gray-400" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor">
                  <path strokeLinecap="round" strokeLinejoin="round" d="M3.98 8.223A10.477 10.477 0 0 0 1.934 12C3.226 16.338 7.244 19.5 12 19.5c.993 0 1.953-.138 2.863-.395M6.228 6.228A10.451 10.451 0 0 1 12 4.5c4.756 0 8.773 3.162 10.065 7.498a10.522 10.522 0 0 1-4.293 5.774M6.228 6.228 3 3m3.228 3.228 3.65 3.65m7.894 7.894L21 21m-3.228-3.228-3.65-3.65m0 0a3 3 0 1 0-4.243-4.243m4.242 4.242L9.88 9.88" />
                </svg>
                Deactivate
              </>
            ) : (
              <>
                <svg className="h-4 w-4 text-gray-400" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor">
                  <path strokeLinecap="round" strokeLinejoin="round" d="M2.036 12.322a1.012 1.012 0 0 1 0-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178Z" />
                  <path strokeLinecap="round" strokeLinejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
                </svg>
                Activate
              </>
            )}
          </button>
          <div className="my-1 border-t border-gray-100" />
          <button
            onClick={handleDelete}
            className="flex w-full items-center gap-2 px-3 py-2 text-left text-sm text-red-600 transition-colors hover:bg-red-50"
          >
            <svg className="h-4 w-4" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" />
            </svg>
            Delete
          </button>
        </div>
      )}

      {error && (
        <div className="absolute right-0 z-10 mt-1 w-64 rounded-md border border-red-200 bg-red-50 p-3 text-xs text-red-700 shadow-lg">
          {error}
          <button
            onClick={() => setError(null)}
            className="mt-1 block text-xs font-medium text-red-800 underline"
          >
            Dismiss
          </button>
        </div>
      )}
    </div>
  );
}


===== D:\.code\wattleos\src\components\domain\reports\TemplateBuilder.tsx =====

// src/components/domain/reports/TemplateBuilder.tsx
//
// ============================================================
// WattleOS V2 - Report Template Builder (Client Component)
// ============================================================
// Interactive section composer for report templates. Schools
// add, remove, reorder, and configure sections to design their
// report format.
//
// WHY client: All interactions (drag-to-reorder, expand/collapse
// config panels, add/remove sections) are client-side state.
// Only the Save action hits the server.
//
// Uses up/down buttons for reordering - reliable and accessible
// without requiring a drag-and-drop library dependency.
// ============================================================

"use client";

import { updateReportTemplate } from "@/lib/actions/reports";
import type {
  TemplateContent,
  TemplateSection,
  TemplateSectionConfig,
  TemplateSectionType,
} from "@/lib/reports/types";
import { SECTION_TYPE_CATALOG } from "@/lib/reports/types";
import { useRouter } from "next/navigation";
import { useCallback, useState } from "react";

interface TemplateBuilderProps {
  templateId: string;
  templateName: string;
  cycleLevel: string | null;
  initialContent: TemplateContent;
}

export function TemplateBuilder({
  templateId,
  templateName,
  cycleLevel,
  initialContent,
}: TemplateBuilderProps) {
  const [sections, setSections] = useState<TemplateSection[]>(
    initialContent?.sections ?? [],
  );
  const [expandedSection, setExpandedSection] = useState<string | null>(null);
  const [showCatalog, setShowCatalog] = useState(false);
  const [isSaving, setIsSaving] = useState(false);
  const [saveStatus, setSaveStatus] = useState<"idle" | "saved" | "error">(
    "idle",
  );
  const [saveError, setSaveError] = useState<string | null>(null);
  const [hasChanges, setHasChanges] = useState(false);
  const router = useRouter();

  // â”€â”€ Section Management â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  const markDirty = useCallback(() => {
    setHasChanges(true);
    setSaveStatus("idle");
  }, []);

  function addSection(type: TemplateSectionType) {
    const info = SECTION_TYPE_CATALOG.find((s) => s.type === type);
    if (!info) return;

    // Check if non-multiple section already exists
    if (!info.allowMultiple) {
      const exists = sections.some((s) => s.type === type);
      if (exists) return;
    }

    const newSection: TemplateSection = {
      id: crypto.randomUUID(),
      type,
      title: info.label,
      order: sections.length,
      config: getDefaultConfig(type),
    };

    setSections((prev) => [...prev, newSection]);
    setShowCatalog(false);
    setExpandedSection(newSection.id);
    markDirty();
  }

  function removeSection(sectionId: string) {
    setSections((prev) => {
      const filtered = prev.filter((s) => s.id !== sectionId);
      // Re-index orders
      return filtered.map((s, i) => ({ ...s, order: i }));
    });
    if (expandedSection === sectionId) {
      setExpandedSection(null);
    }
    markDirty();
  }

  function moveSection(sectionId: string, direction: "up" | "down") {
    setSections((prev) => {
      const index = prev.findIndex((s) => s.id === sectionId);
      if (index === -1) return prev;
      if (direction === "up" && index === 0) return prev;
      if (direction === "down" && index === prev.length - 1) return prev;

      const newSections = [...prev];
      const swapIndex = direction === "up" ? index - 1 : index + 1;
      [newSections[index], newSections[swapIndex]] = [
        newSections[swapIndex],
        newSections[index],
      ];

      // Re-index orders
      return newSections.map((s, i) => ({ ...s, order: i }));
    });
    markDirty();
  }

  function updateSectionTitle(sectionId: string, title: string) {
    setSections((prev) =>
      prev.map((s) => (s.id === sectionId ? { ...s, title } : s)),
    );
    markDirty();
  }

  function updateSectionConfig(
    sectionId: string,
    config: TemplateSectionConfig,
  ) {
    setSections((prev) =>
      prev.map((s) => (s.id === sectionId ? { ...s, config } : s)),
    );
    markDirty();
  }

  // â”€â”€ Save â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  async function handleSave() {
    setIsSaving(true);
    setSaveError(null);

    const content: TemplateContent = {
      version: 1,
      sections,
    };

    const result = await updateReportTemplate(templateId, { content });

    if (result.error) {
      setSaveError(result.error.message);
      setSaveStatus("error");
    } else {
      setSaveStatus("saved");
      setHasChanges(false);
      router.refresh();
    }

    setIsSaving(false);
  }

  // â”€â”€ Derived State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  const availableSections = SECTION_TYPE_CATALOG.filter((info) => {
    if (info.allowMultiple) return true;
    return !sections.some((s) => s.type === info.type);
  });

  return (
    <div className="space-y-6">
      {/* Toolbar */}
      <div className="flex items-center justify-between rounded-lg border border-gray-200 bg-white px-4 py-3">
        <div className="flex items-center gap-3">
          <span className="text-sm text-gray-500">
            {sections.length} section{sections.length !== 1 ? "s" : ""}
          </span>
          {hasChanges && (
            <span className="rounded-full bg-amber-100 px-2 py-0.5 text-xs font-medium text-amber-700">
              Unsaved changes
            </span>
          )}
          {saveStatus === "saved" && !hasChanges && (
            <span className="rounded-full bg-green-100 px-2 py-0.5 text-xs font-medium text-green-700">
              Saved
            </span>
          )}
        </div>
        <div className="flex items-center gap-3">
          <button
            onClick={() => setShowCatalog(!showCatalog)}
            className="rounded-md border border-gray-300 bg-white px-3 py-2 text-sm font-medium text-gray-700 transition-colors hover:bg-gray-50"
          >
            + Add Section
          </button>
          <button
            onClick={handleSave}
            disabled={isSaving || !hasChanges}
            className="rounded-md bg-amber-600 px-4 py-2 text-sm font-medium text-white transition-colors hover:bg-amber-700 disabled:opacity-50"
          >
            {isSaving ? "Saving..." : "Save Template"}
          </button>
        </div>
      </div>

      {/* Error */}
      {saveError && (
        <div className="rounded-md bg-red-50 p-3 text-sm text-red-700">
          {saveError}
        </div>
      )}

      {/* Section catalog (add panel) */}
      {showCatalog && (
        <div className="rounded-lg border border-amber-200 bg-amber-50 p-4">
          <div className="mb-3 flex items-center justify-between">
            <h3 className="text-sm font-semibold text-gray-900">
              Add a Section
            </h3>
            <button
              onClick={() => setShowCatalog(false)}
              className="text-sm text-gray-500 hover:text-gray-700"
            >
              Close
            </button>
          </div>
          {availableSections.length === 0 ? (
            <p className="text-sm text-gray-500">
              All single-use section types are already in the template.
            </p>
          ) : (
            <div className="grid gap-2 sm:grid-cols-2 lg:grid-cols-4">
              {availableSections.map((info) => (
                <button
                  key={info.type}
                  onClick={() => addSection(info.type)}
                  className="rounded-md border border-amber-200 bg-white p-3 text-left transition-all hover:border-amber-400 hover:shadow-sm"
                >
                  <div className="flex items-center gap-2">
                    <SectionIcon
                      type={info.type}
                      className="h-4 w-4 text-amber-600"
                    />
                    <span className="text-sm font-medium text-gray-900">
                      {info.label}
                    </span>
                  </div>
                  <p className="mt-1 text-xs text-gray-500">
                    {info.description}
                  </p>
                  <div className="mt-2 flex gap-1">
                    {info.isAutoPopulated && (
                      <span className="rounded bg-blue-50 px-1.5 py-0.5 text-[10px] font-medium text-blue-600">
                        Auto
                      </span>
                    )}
                    {info.isEditable && (
                      <span className="rounded bg-green-50 px-1.5 py-0.5 text-[10px] font-medium text-green-600">
                        Editable
                      </span>
                    )}
                  </div>
                </button>
              ))}
            </div>
          )}
        </div>
      )}

      {/* Section list */}
      {sections.length === 0 ? (
        <div className="rounded-lg border-2 border-dashed border-gray-300 p-12 text-center">
          <p className="text-sm text-gray-500">
            No sections yet. Click &ldquo;Add Section&rdquo; to start building
            your template.
          </p>
        </div>
      ) : (
        <div className="space-y-3">
          {sections.map((section, index) => (
            <SectionCard
              key={section.id}
              section={section}
              index={index}
              totalSections={sections.length}
              isExpanded={expandedSection === section.id}
              onToggleExpand={() =>
                setExpandedSection(
                  expandedSection === section.id ? null : section.id,
                )
              }
              onMoveUp={() => moveSection(section.id, "up")}
              onMoveDown={() => moveSection(section.id, "down")}
              onRemove={() => removeSection(section.id)}
              onUpdateTitle={(title) => updateSectionTitle(section.id, title)}
              onUpdateConfig={(config) =>
                updateSectionConfig(section.id, config)
              }
            />
          ))}
        </div>
      )}
    </div>
  );
}

// ============================================================
// SectionCard - individual section in the builder
// ============================================================

interface SectionCardProps {
  section: TemplateSection;
  index: number;
  totalSections: number;
  isExpanded: boolean;
  onToggleExpand: () => void;
  onMoveUp: () => void;
  onMoveDown: () => void;
  onRemove: () => void;
  onUpdateTitle: (title: string) => void;
  onUpdateConfig: (config: TemplateSectionConfig) => void;
}

function SectionCard({
  section,
  index,
  totalSections,
  isExpanded,
  onToggleExpand,
  onMoveUp,
  onMoveDown,
  onRemove,
  onUpdateTitle,
  onUpdateConfig,
}: SectionCardProps) {
  const info = SECTION_TYPE_CATALOG.find((s) => s.type === section.type);

  return (
    <div
      className={`rounded-lg border bg-white transition-shadow ${
        isExpanded ? "border-amber-300 shadow-sm" : "border-gray-200"
      }`}
    >
      {/* Header */}
      <div className="flex items-center gap-3 px-4 py-3">
        {/* Reorder buttons */}
        <div className="flex flex-col gap-0.5">
          <button
            onClick={onMoveUp}
            disabled={index === 0}
            className="rounded p-0.5 text-gray-400 transition-colors hover:bg-gray-100 hover:text-gray-600 disabled:opacity-30"
            aria-label="Move section up"
          >
            <svg
              className="h-3.5 w-3.5"
              fill="none"
              viewBox="0 0 24 24"
              strokeWidth={2}
              stroke="currentColor"
            >
              <path
                strokeLinecap="round"
                strokeLinejoin="round"
                d="m4.5 15.75 7.5-7.5 7.5 7.5"
              />
            </svg>
          </button>
          <button
            onClick={onMoveDown}
            disabled={index === totalSections - 1}
            className="rounded p-0.5 text-gray-400 transition-colors hover:bg-gray-100 hover:text-gray-600 disabled:opacity-30"
            aria-label="Move section down"
          >
            <svg
              className="h-3.5 w-3.5"
              fill="none"
              viewBox="0 0 24 24"
              strokeWidth={2}
              stroke="currentColor"
            >
              <path
                strokeLinecap="round"
                strokeLinejoin="round"
                d="m19.5 8.25-7.5 7.5-7.5-7.5"
              />
            </svg>
          </button>
        </div>

        {/* Section number */}
        <span className="flex h-6 w-6 flex-shrink-0 items-center justify-center rounded-full bg-gray-100 text-xs font-medium text-gray-500">
          {index + 1}
        </span>

        {/* Icon + title */}
        <SectionIcon
          type={section.type}
          className="h-4 w-4 flex-shrink-0 text-gray-400"
        />
        <button
          onClick={onToggleExpand}
          className="flex min-w-0 flex-1 items-center gap-2 text-left"
        >
          <span className="truncate text-sm font-medium text-gray-900">
            {section.title}
          </span>
          <span className="flex-shrink-0 text-xs text-gray-400">
            {info?.label !== section.title ? `(${info?.label})` : ""}
          </span>
        </button>

        {/* Badges */}
        <div className="flex flex-shrink-0 items-center gap-2">
          {info?.isAutoPopulated && (
            <span className="rounded bg-blue-50 px-1.5 py-0.5 text-[10px] font-medium text-blue-600">
              Auto
            </span>
          )}
          {info?.isEditable && (
            <span className="rounded bg-green-50 px-1.5 py-0.5 text-[10px] font-medium text-green-600">
              Editable
            </span>
          )}
        </div>

        {/* Expand toggle */}
        <button
          onClick={onToggleExpand}
          className="rounded p-1 text-gray-400 transition-colors hover:bg-gray-100 hover:text-gray-600"
        >
          <svg
            className={`h-4 w-4 transition-transform ${isExpanded ? "rotate-180" : ""}`}
            fill="none"
            viewBox="0 0 24 24"
            strokeWidth={2}
            stroke="currentColor"
          >
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              d="m19.5 8.25-7.5 7.5-7.5-7.5"
            />
          </svg>
        </button>

        {/* Remove */}
        <button
          onClick={onRemove}
          className="rounded p-1 text-gray-400 transition-colors hover:bg-red-50 hover:text-red-600"
          aria-label="Remove section"
        >
          <svg
            className="h-4 w-4"
            fill="none"
            viewBox="0 0 24 24"
            strokeWidth={1.5}
            stroke="currentColor"
          >
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              d="M6 18 18 6M6 6l12 12"
            />
          </svg>
        </button>
      </div>

      {/* Config panel (expanded) */}
      {isExpanded && (
        <div className="border-t border-gray-100 px-4 py-4">
          <SectionConfigPanel
            section={section}
            onUpdateTitle={onUpdateTitle}
            onUpdateConfig={onUpdateConfig}
          />
        </div>
      )}
    </div>
  );
}

// ============================================================
// SectionConfigPanel - type-specific config fields
// ============================================================

interface SectionConfigPanelProps {
  section: TemplateSection;
  onUpdateTitle: (title: string) => void;
  onUpdateConfig: (config: TemplateSectionConfig) => void;
}

function SectionConfigPanel({
  section,
  onUpdateTitle,
  onUpdateConfig,
}: SectionConfigPanelProps) {
  const config = section.config;

  return (
    <div className="space-y-4">
      {/* Section title (always editable) */}
      <div>
        <label className="block text-xs font-medium text-gray-600">
          Section Heading
        </label>
        <input
          type="text"
          value={section.title}
          onChange={(e) => onUpdateTitle(e.target.value)}
          className="mt-1 block w-full rounded-md border border-gray-300 px-3 py-1.5 text-sm focus:border-ring focus:outline-none focus:ring-1 focus:ring-ring"
        />
      </div>

      {/* Type-specific config */}
      {(section.type === "mastery_grid" ||
        section.type === "mastery_summary") && (
        <>
          <div>
            <label className="block text-xs font-medium text-gray-600">
              Curriculum Area Filter
            </label>
            <input
              type="text"
              value={config.curriculumAreaFilter ?? "all"}
              onChange={(e) =>
                onUpdateConfig({
                  ...config,
                  curriculumAreaFilter: e.target.value,
                })
              }
              placeholder="all (or enter an area name)"
              className="mt-1 block w-full rounded-md border border-gray-300 px-3 py-1.5 text-sm focus:border-ring focus:outline-none focus:ring-1 focus:ring-ring"
            />
            <p className="mt-1 text-xs text-gray-400">
              Enter &ldquo;all&rdquo; for all areas, or a specific area name
              like &ldquo;Practical Life&rdquo;
            </p>
          </div>
          {section.type === "mastery_summary" && (
            <div>
              <label className="block text-xs font-medium text-gray-600">
                Display Mode
              </label>
              <select
                value={config.displayMode ?? "both"}
                onChange={(e) =>
                  onUpdateConfig({
                    ...config,
                    displayMode: e.target.value as
                      | "percentage"
                      | "counts"
                      | "both",
                  })
                }
                className="mt-1 block w-full rounded-md border border-gray-300 px-3 py-1.5 text-sm focus:border-ring focus:outline-none focus:ring-1 focus:ring-ring"
              >
                <option value="both">Counts & Percentages</option>
                <option value="percentage">Percentages Only</option>
                <option value="counts">Counts Only</option>
              </select>
            </div>
          )}
        </>
      )}

      {section.type === "observation_highlights" && (
        <div>
          <label className="block text-xs font-medium text-gray-600">
            Max Observations
          </label>
          <input
            type="number"
            min={1}
            max={20}
            value={config.maxObservations ?? 5}
            onChange={(e) =>
              onUpdateConfig({
                ...config,
                maxObservations: parseInt(e.target.value, 10) || 5,
              })
            }
            className="mt-1 block w-24 rounded-md border border-gray-300 px-3 py-1.5 text-sm focus:border-ring focus:outline-none focus:ring-1 focus:ring-ring"
          />
          <p className="mt-1 text-xs text-gray-400">
            Number of recent published observations to include
          </p>
        </div>
      )}

      {section.type === "attendance_summary" && (
        <div className="flex items-center gap-2">
          <input
            type="checkbox"
            id={`showDetails-${section.id}`}
            checked={config.showDetails ?? false}
            onChange={(e) =>
              onUpdateConfig({ ...config, showDetails: e.target.checked })
            }
            className="h-4 w-4 rounded border-gray-300 text-amber-600 focus:ring-ring"
          />
          <label
            htmlFor={`showDetails-${section.id}`}
            className="text-xs text-gray-600"
          >
            Show daily breakdown (in addition to totals)
          </label>
        </div>
      )}

      {(section.type === "narrative" ||
        section.type === "custom_text" ||
        section.type === "goals") && (
        <>
          <div>
            <label className="block text-xs font-medium text-gray-600">
              Placeholder Text
            </label>
            <textarea
              value={config.placeholder ?? ""}
              onChange={(e) =>
                onUpdateConfig({ ...config, placeholder: e.target.value })
              }
              rows={2}
              placeholder="Hint text shown to the teacher when writing this section..."
              className="mt-1 block w-full rounded-md border border-gray-300 px-3 py-1.5 text-sm focus:border-ring focus:outline-none focus:ring-1 focus:ring-ring"
            />
          </div>
          <div>
            <label className="block text-xs font-medium text-gray-600">
              Suggested Minimum Words
            </label>
            <input
              type="number"
              min={0}
              value={config.suggestedMinWords ?? 0}
              onChange={(e) =>
                onUpdateConfig({
                  ...config,
                  suggestedMinWords: parseInt(e.target.value, 10) || 0,
                })
              }
              className="mt-1 block w-24 rounded-md border border-gray-300 px-3 py-1.5 text-sm focus:border-ring focus:outline-none focus:ring-1 focus:ring-ring"
            />
            <p className="mt-1 text-xs text-gray-400">
              Guidance only - not enforced. Set to 0 to disable.
            </p>
          </div>
        </>
      )}

      {section.type === "student_info" && (
        <p className="text-xs text-gray-500">
          This section automatically shows the student&apos;s name, class, date
          of birth, and photo. No configuration needed.
        </p>
      )}
    </div>
  );
}

// ============================================================
// SectionIcon - icon per section type
// ============================================================

function SectionIcon({
  type,
  className,
}: {
  type: TemplateSectionType;
  className?: string;
}) {
  const iconPaths: Record<TemplateSectionType, string> = {
    student_info:
      "M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.501 20.118a7.5 7.5 0 0 1 14.998 0A17.933 17.933 0 0 1 12 21.75c-2.676 0-5.216-.584-7.499-1.632Z",
    narrative:
      "M16.862 4.487l1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10",
    mastery_grid:
      "M3.375 19.5h17.25m-17.25 0a1.125 1.125 0 0 1-1.125-1.125M3.375 19.5h7.5c.621 0 1.125-.504 1.125-1.125m-9.75 0V5.625m0 12.75v-1.5c0-.621.504-1.125 1.125-1.125m18.375 2.625V5.625m0 12.75c0 .621-.504 1.125-1.125 1.125m1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125m0 3.75h-7.5A1.125 1.125 0 0 1 12 18.375m9.75-12.75c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125m19.5 0v1.5c0 .621-.504 1.125-1.125 1.125M2.25 5.625v1.5c0 .621.504 1.125 1.125 1.125m0 0h17.25m-17.25 0h7.5c.621 0 1.125.504 1.125 1.125M3.375 8.25c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125m17.25-3.75h-7.5c-.621 0-1.125.504-1.125 1.125m8.625-1.125c.621 0 1.125.504 1.125 1.125v1.5c0 .621-.504 1.125-1.125 1.125m-17.25 0h7.5m-7.5 0c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125M12 10.875v-1.5m0 1.5c0 .621-.504 1.125-1.125 1.125M12 10.875c0 .621.504 1.125 1.125 1.125m-2.25 0c.621 0 1.125.504 1.125 1.125M13.125 12h7.5m-7.5 0c-.621 0-1.125.504-1.125 1.125M20.625 12c.621 0 1.125.504 1.125 1.125v1.5c0 .621-.504 1.125-1.125 1.125m-17.25 0h7.5M12 14.625v-1.5m0 1.5c0 .621-.504 1.125-1.125 1.125M12 14.625c0 .621.504 1.125 1.125 1.125m-2.25 0c.621 0 1.125.504 1.125 1.125m0 0v1.5c0 .621-.504 1.125-1.125 1.125",
    mastery_summary:
      "M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 0 1 3 19.875v-6.75ZM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V8.625ZM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V4.125Z",
    attendance_summary:
      "M9 12h3.75M9 15h3.75M9 18h3.75m3 .75H18a2.25 2.25 0 0 0 2.25-2.25V6.108c0-1.135-.845-2.098-1.976-2.192a48.424 48.424 0 0 0-1.123-.08m-5.801 0c-.065.21-.1.433-.1.664 0 .414.336.75.75.75h4.5a.75.75 0 0 0 .75-.75 2.25 2.25 0 0 0-.1-.664m-5.8 0A2.251 2.251 0 0 1 13.5 2.25H15c1.012 0 1.867.668 2.15 1.586m-5.8 0c-.376.023-.75.05-1.124.08C9.095 4.01 8.25 4.973 8.25 6.108V8.25m0 0H4.875c-.621 0-1.125.504-1.125 1.125v11.25c0 .621.504 1.125 1.125 1.125h9.75c.621 0 1.125-.504 1.125-1.125V9.375c0-.621-.504-1.125-1.125-1.125H8.25ZM6.75 12h.008v.008H6.75V12Zm0 3h.008v.008H6.75V15Zm0 3h.008v.008H6.75V18Z",
    observation_highlights:
      "M2.036 12.322a1.012 1.012 0 0 1 0-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178Z M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z",
    custom_text:
      "M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 0 0-9-9Z",
    goals:
      "M9 12.75 11.25 15 15 9.75M21 12c0 1.268-.63 2.39-1.593 3.068a3.745 3.745 0 0 1-1.043 3.296 3.745 3.745 0 0 1-3.296 1.043A3.745 3.745 0 0 1 12 21c-1.268 0-2.39-.63-3.068-1.593a3.746 3.746 0 0 1-3.296-1.043 3.745 3.745 0 0 1-1.043-3.296A3.745 3.745 0 0 1 3 12c0-1.268.63-2.39 1.593-3.068a3.745 3.745 0 0 1 1.043-3.296 3.746 3.746 0 0 1 3.296-1.043A3.746 3.746 0 0 1 12 3c1.268 0 2.39.63 3.068 1.593a3.746 3.746 0 0 1 3.296 1.043 3.745 3.745 0 0 1 1.043 3.296A3.745 3.745 0 0 1 21 12Z",
  };

  return (
    <svg
      className={className}
      fill="none"
      viewBox="0 0 24 24"
      strokeWidth={1.5}
      stroke="currentColor"
    >
      <path strokeLinecap="round" strokeLinejoin="round" d={iconPaths[type]} />
    </svg>
  );
}

// ============================================================
// Default config per section type
// ============================================================

function getDefaultConfig(type: TemplateSectionType): TemplateSectionConfig {
  switch (type) {
    case "student_info":
      return {};
    case "narrative":
      return {
        placeholder:
          "Write about the student's progress, strengths, and areas for growth...",
        suggestedMinWords: 50,
      };
    case "mastery_grid":
      return { curriculumAreaFilter: "all" };
    case "mastery_summary":
      return { curriculumAreaFilter: "all", displayMode: "both" };
    case "attendance_summary":
      return { showDetails: false };
    case "observation_highlights":
      return { maxObservations: 5, publishedOnly: true };
    case "custom_text":
      return { placeholder: "" };
    case "goals":
      return {
        placeholder:
          "Outline learning goals and focus areas for the upcoming term...",
      };
    default:
      return {};
  }
}



===== D:\.code\wattleos\src\components\domain\sidebar.tsx =====

// src/components/domain/sidebar.tsx
//
// ============================================================
// WattleOS V2 â€” Sidebar Navigation (DESIGN SYSTEM MIGRATED)
// ============================================================
// MIGRATION CHANGES:
// â€¢ bg-white â†’ bg-sidebar-background (dark mode + brand aware)
// â€¢ border-gray-200 â†’ border-sidebar-border
// â€¢ text-gray-900/700/500/400 â†’ text-sidebar-foreground / text-muted-foreground
// â€¢ bg-amber-50/100, text-amber-600/700 â†’ bg-primary/10, text-primary
// â€¢ bg-amber-500 (badge) â†’ bg-primary
// â€¢ bg-black/50 â†’ bg-[var(--overlay)]
// â€¢ bg-gray-200 (avatar) â†’ bg-muted
// â€¢ hover:bg-gray-100 â†’ hover:bg-sidebar-accent
// â€¢ hover:bg-gray-50 â†’ hover:bg-sidebar-accent
// â€¢ w-64 â†’ w-[var(--sidebar-width)]
// â€¢ text-sm/xs â†’ text-[var(--text-sm/xs)]
// â€¢ Added palette icon for user settings nav
// ============================================================

'use client';

import { useState } from 'react';
import Link from 'next/link';
import { usePathname } from 'next/navigation';
import { signOutAction, switchTenantAction } from '@/lib/actions/auth';

interface NavItem {
  label: string;
  href: string;
  icon: string;
  badge?: number;
}

interface SidebarProps {
  tenantName: string;
  tenantLogo: string | null;
  userName: string;
  userEmail: string;
  userAvatar: string | null;
  roleName: string;
  navItems: NavItem[];
}

const ICON_MAP: Record<string, React.ReactNode> = {
  home: (
    <svg className="h-5 w-5" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor">
      <path strokeLinecap="round" strokeLinejoin="round" d="m2.25 12 8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h8.25" />
    </svg>
  ),
  eye: (
    <svg className="h-5 w-5" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor">
      <path strokeLinecap="round" strokeLinejoin="round" d="M2.036 12.322a1.012 1.012 0 0 1 0-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178Z" />
      <path strokeLinecap="round" strokeLinejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
    </svg>
  ),
  book: (
    <svg className="h-5 w-5" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor">
      <path strokeLinecap="round" strokeLinejoin="round" d="M12 6.042A8.967 8.967 0 0 0 6 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 0 1 6 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 0 1 6-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0 0 18 18a8.967 8.967 0 0 0-6 2.292m0-14.25v14.25" />
    </svg>
  ),
  chart: (
    <svg className="h-5 w-5" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor">
      <path strokeLinecap="round" strokeLinejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 0 1 3 19.875v-6.75ZM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V8.625ZM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V4.125Z" />
    </svg>
  ),
  users: (
    <svg className="h-5 w-5" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor">
      <path strokeLinecap="round" strokeLinejoin="round" d="M15 19.128a9.38 9.38 0 0 0 2.625.372 9.337 9.337 0 0 0 4.121-.952 4.125 4.125 0 0 0-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 0 1 8.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0 1 11.964-3.07M12 6.375a3.375 3.375 0 1 1-6.75 0 3.375 3.375 0 0 1 6.75 0Zm8.25 2.25a2.625 2.625 0 1 1-5.25 0 2.625 2.625 0 0 1 5.25 0Z" />
    </svg>
  ),
  clipboard: (
    <svg className="h-5 w-5" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor">
      <path strokeLinecap="round" strokeLinejoin="round" d="M9 12h3.75M9 15h3.75M9 18h3.75m3 .75H18a2.25 2.25 0 0 0 2.25-2.25V6.108c0-1.135-.845-2.098-1.976-2.192a48.424 48.424 0 0 0-1.123-.08m-5.801 0c-.065.21-.1.433-.1.664 0 .414.336.75.75.75h4.5a.75.75 0 0 0 .75-.75 2.25 2.25 0 0 0-.1-.664m-5.8 0A2.251 2.251 0 0 1 13.5 2.25H15c1.012 0 1.867.668 2.15 1.586m-5.8 0c-.376.023-.75.05-1.124.08C9.095 4.01 8.25 4.973 8.25 6.108V8.25m0 0H4.875c-.621 0-1.125.504-1.125 1.125v11.25c0 .621.504 1.125 1.125 1.125h9.75c.621 0 1.125-.504 1.125-1.125V9.375c0-.621-.504-1.125-1.125-1.125H8.25Z" />
    </svg>
  ),
  file: (
    <svg className="h-5 w-5" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor">
      <path strokeLinecap="round" strokeLinejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m2.25 0H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 0 0-9-9Z" />
    </svg>
  ),
  settings: (
    <svg className="h-5 w-5" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor">
      <path strokeLinecap="round" strokeLinejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.325.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 0 1 1.37.49l1.296 2.247a1.125 1.125 0 0 1-.26 1.431l-1.003.827c-.293.241-.438.613-.43.992a7.723 7.723 0 0 1 0 .255c-.008.378.137.75.43.991l1.004.827c.424.35.534.955.26 1.43l-1.298 2.247a1.125 1.125 0 0 1-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.47 6.47 0 0 1-.22.128c-.331.183-.581.495-.644.869l-.213 1.281c-.09.543-.56.94-1.11.94h-2.594c-.55 0-1.019-.398-1.11-.94l-.213-1.281c-.062-.374-.312-.686-.644-.87a6.52 6.52 0 0 1-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 0 1-1.369-.49l-1.297-2.247a1.125 1.125 0 0 1 .26-1.431l1.004-.827c.292-.24.437-.613.43-.991a6.932 6.932 0 0 1 0-.255c.007-.38-.138-.751-.43-.992l-1.004-.827a1.125 1.125 0 0 1-.26-1.43l1.297-2.247a1.125 1.125 0 0 1 1.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.086.22-.128.332-.183.582-.495.644-.869l.214-1.28Z" />
      <path strokeLinecap="round" strokeLinejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
    </svg>
  ),
  megaphone: (
    <svg className="h-5 w-5" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor">
      <path strokeLinecap="round" strokeLinejoin="round" d="M10.34 15.84c-.688-.06-1.386-.09-2.09-.09H7.5a4.5 4.5 0 1 1 0-9h.75c.704 0 1.402-.03 2.09-.09m0 9.18c.253.962.584 1.892.985 2.783.247.55.06 1.21-.463 1.511l-.657.38c-.551.318-1.26.117-1.527-.461a20.845 20.845 0 0 1-1.44-4.282m3.102.069a18.03 18.03 0 0 1-.59-4.59c0-1.586.205-3.124.59-4.59m0 9.18a23.848 23.848 0 0 1 8.835 2.535M10.34 6.66a23.847 23.847 0 0 0 8.835-2.535m0 0A23.74 23.74 0 0 0 18.795 3m.38 1.125a23.91 23.91 0 0 1 1.014 5.395m-1.014 8.855c-.118.38-.245.754-.38 1.125m.38-1.125a23.91 23.91 0 0 0 1.014-5.395m0-3.46c.495.413.811 1.035.811 1.73 0 .695-.316 1.317-.811 1.73m0-3.46a24.347 24.347 0 0 1 0 3.46" />
    </svg>
  ),
  chat: (
    <svg className="h-5 w-5" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor">
      <path strokeLinecap="round" strokeLinejoin="round" d="M20.25 8.511c.884.284 1.5 1.128 1.5 2.097v4.286c0 1.136-.847 2.1-1.98 2.193-.34.027-.68.052-1.02.072v3.091l-3-3c-1.354 0-2.694-.055-4.02-.163a2.115 2.115 0 0 1-.825-.242m9.345-8.334a2.126 2.126 0 0 0-.476-.095 48.64 48.64 0 0 0-8.048 0c-1.131.094-1.976 1.057-1.976 2.192v4.286c0 .837.46 1.58 1.155 1.951m9.345-8.334V6.637c0-1.621-1.152-3.026-2.76-3.235A48.455 48.455 0 0 0 11.25 3c-2.115 0-4.198.137-6.24.402-1.608.209-2.76 1.614-2.76 3.235v6.226c0 1.621 1.152 3.026 2.76 3.235.577.075 1.157.14 1.74.194V21l4.155-4.155" />
    </svg>
  ),
  heart: (
    <svg className="h-5 w-5" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor">
      <path strokeLinecap="round" strokeLinejoin="round" d="M21 8.25c0-2.485-2.099-4.5-4.688-4.5-1.935 0-3.597 1.126-4.312 2.733-.715-1.607-2.377-2.733-4.313-2.733C5.1 3.75 3 5.765 3 8.25c0 7.22 9 12 9 12s9-4.78 9-12Z" />
    </svg>
  ),
  clock: (
    <svg className="h-5 w-5" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor">
      <path strokeLinecap="round" strokeLinejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
    </svg>
  ),
  palette: (
    <svg className="h-5 w-5" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor">
      <path strokeLinecap="round" strokeLinejoin="round" d="M4.098 19.902a3.75 3.75 0 0 0 5.304 0l6.401-6.402M6.75 21A3.75 3.75 0 0 1 3 17.25V4.125C3 3.504 3.504 3 4.125 3h5.25c.621 0 1.125.504 1.125 1.125v4.072M6.75 21a3.75 3.75 0 0 0 3.75-3.75V8.197M6.75 21h13.125c.621 0 1.125-.504 1.125-1.125v-5.25c0-.621-.504-1.125-1.125-1.125h-4.072M10.5 8.197l2.88-2.88c.438-.439 1.15-.439 1.59 0l3.712 3.713c.44.44.44 1.152 0 1.59l-2.879 2.88M6.75 17.25h.008v.008H6.75v-.008Z" />
    </svg>
  ),
};

export function Sidebar({
  tenantName,
  tenantLogo,
  userName,
  userEmail,
  userAvatar,
  roleName,
  navItems,
}: SidebarProps) {
  const pathname = usePathname();
  const [isMobileOpen, setIsMobileOpen] = useState(false);

  return (
    <>
      {/* Mobile hamburger */}
      <button
        onClick={() => setIsMobileOpen(true)}
        className="fixed left-4 top-4 z-40 rounded-md bg-card p-2 shadow-md lg:hidden"
        aria-label="Open navigation"
      >
        <svg className="h-6 w-6 text-foreground" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor">
          <path strokeLinecap="round" strokeLinejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
        </svg>
      </button>

      {/* Mobile overlay */}
      {isMobileOpen && (
        <div
          className="fixed inset-0 z-40 bg-[var(--overlay)] lg:hidden"
          onClick={() => setIsMobileOpen(false)}
        />
      )}

      {/* Sidebar panel */}
      <aside
        className={`fixed inset-y-0 left-0 z-50 flex w-[var(--sidebar-width)] flex-col border-r border-sidebar-border bg-sidebar transition-transform duration-[var(--duration-base)] lg:static lg:translate-x-0 ${
          isMobileOpen ? 'translate-x-0' : '-translate-x-full'
        }`}
      >
        {/* Tenant header */}
        <div className="flex items-center gap-3 border-b border-sidebar-border px-4 py-5">
          <div className="flex h-10 w-10 flex-shrink-0 items-center justify-center rounded-lg bg-primary/15 text-[length:var(--text-sm)] font-bold text-primary">
            {tenantLogo ? (
              <img
                src={tenantLogo}
                alt={tenantName}
                className="h-10 w-10 rounded-lg object-cover"
              />
            ) : (
              tenantName.charAt(0).toUpperCase()
            )}
          </div>
          <div className="min-w-0 flex-1">
            <p className="truncate text-[length:var(--text-sm)] font-semibold text-sidebar-foreground">
              {tenantName}
            </p>
            <p className="text-[length:var(--text-xs)] text-muted-foreground">{roleName}</p>
          </div>
        </div>

        {/* Navigation */}
        <nav className="flex-1 space-y-1 overflow-y-auto px-3 py-4">
          {navItems.map((item) => {
            const isActive =
              pathname === item.href || pathname.startsWith(item.href + '/');

            return (
              <Link
                key={item.href}
                href={item.href}
                onClick={() => setIsMobileOpen(false)}
                className={`flex items-center gap-3 rounded-[var(--sidebar-item-radius)] px-3 py-2.5 text-[length:var(--text-sm)] font-medium transition-colors ${
                  isActive
                    ? 'bg-primary/10 text-primary'
                    : 'text-sidebar-foreground hover:bg-sidebar-accent hover:text-sidebar-accent-foreground'
                }`}
              >
                <span className={isActive ? 'text-primary' : 'text-muted-foreground'}>
                  {ICON_MAP[item.icon] ?? ICON_MAP.file}
                </span>
                <span className="flex-1">{item.label}</span>
                {item.badge && item.badge > 0 && (
                  <span className="inline-flex h-5 min-w-[20px] items-center justify-center rounded-full bg-primary px-1.5 text-[10px] font-bold text-primary-foreground">
                    {item.badge > 99 ? '99+' : item.badge}
                  </span>
                )}
              </Link>
            );
          })}
        </nav>

        {/* User footer */}
        <div className="border-t border-sidebar-border p-4">
          <div className="flex items-center gap-3">
            <div className="flex h-9 w-9 flex-shrink-0 items-center justify-center rounded-full bg-muted text-[length:var(--text-sm)] font-medium text-muted-foreground">
              {userAvatar ? (
                <img
                  src={userAvatar}
                  alt={userName}
                  className="h-9 w-9 rounded-full object-cover"
                />
              ) : (
                userName.charAt(0).toUpperCase()
              )}
            </div>
            <div className="min-w-0 flex-1">
              <p className="truncate text-[length:var(--text-sm)] font-medium text-sidebar-foreground">
                {userName}
              </p>
              <p className="truncate text-[length:var(--text-xs)] text-muted-foreground">{userEmail}</p>
            </div>
          </div>
          <div className="mt-3 flex gap-2">
            <form action={switchTenantAction} className="flex-1">
              <button
                type="submit"
                className="w-full rounded-md border border-border px-3 py-1.5 text-[length:var(--text-xs)] font-medium text-sidebar-foreground transition-colors hover:bg-sidebar-accent"
              >
                Switch School
              </button>
            </form>
            <form action={signOutAction} className="flex-1">
              <button
                type="submit"
                className="w-full rounded-md border border-border px-3 py-1.5 text-[length:var(--text-xs)] font-medium text-sidebar-foreground transition-colors hover:bg-sidebar-accent"
              >
                Sign Out
              </button>
            </form>
          </div>
        </div>
      </aside>
    </>
  );
}


===== D:\.code\wattleos\src\components\domain\sis\ClassForm.tsx =====

// src/components/domain/sis/ClassForm.tsx
//
// ============================================================
// WattleOS V2 - Class Create/Edit Form
// ============================================================
// 'use client' - interactive form for Montessori classrooms.
//
// Why shared: Same fields for create and edit. Accepts optional
// initialData for edit mode, calls createClass or updateClass.
// ============================================================

"use client";

import type { CreateClassInput, UpdateClassInput } from "@/lib/actions/classes";
import { createClass, updateClass } from "@/lib/actions/classes";
import type { Class } from "@/types/domain";
import Link from "next/link";
import { useRouter } from "next/navigation";
import { useState } from "react";

// â”€â”€ Props â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

interface ClassFormProps {
  /** When provided, form operates in edit mode */
  initialData?: Class;
}

// â”€â”€ Montessori cycle levels â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Why hardcoded: Montessori has standardized age groupings.
// Schools rarely deviate from these. Custom values are still
// allowed via the text input fallback.

const CYCLE_LEVEL_OPTIONS = [
  { value: "", label: "Select cycle level..." },
  { value: "0-3", label: "Infant/Toddler (0â€“3)" },
  { value: "3-6", label: "Primary / Casa (3â€“6)" },
  { value: "6-9", label: "Lower Elementary (6â€“9)" },
  { value: "6-12", label: "Elementary (6â€“12)" },
  { value: "9-12", label: "Upper Elementary (9â€“12)" },
  { value: "12-15", label: "Adolescent (12â€“15)" },
  { value: "15-18", label: "Upper Adolescent (15â€“18)" },
] as const;

// â”€â”€ Component â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

export function ClassForm({ initialData }: ClassFormProps) {
  const router = useRouter();
  const isEditing = !!initialData;

  // â”€â”€ Form state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const [name, setName] = useState(initialData?.name ?? "");
  const [room, setRoom] = useState(initialData?.room ?? "");
  const [cycleLevel, setCycleLevel] = useState(initialData?.cycle_level ?? "");
  const [isActive, setIsActive] = useState(initialData?.is_active ?? true);

  // â”€â”€ Submission state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const [isSaving, setIsSaving] = useState(false);
  const [error, setError] = useState<string | null>(null);

  // â”€â”€ Handlers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  async function handleSubmit(e: React.FormEvent) {
    e.preventDefault();
    setIsSaving(true);
    setError(null);

    if (isEditing && initialData) {
      // â”€â”€ Update existing class â”€â”€
      const input: UpdateClassInput = {
        name: name.trim(),
        room: room.trim() || null,
        cycle_level: cycleLevel || null,
        is_active: isActive,
      };

      const result = await updateClass(initialData.id, input);

      if (result.error) {
        setError(result.error.message);
        setIsSaving(false);
        return;
      }

      router.push(`/classes/${initialData.id}`);
      router.refresh();
    } else {
      // â”€â”€ Create new class â”€â”€
      const input: CreateClassInput = {
        name: name.trim(),
        room: room.trim() || null,
        cycle_level: cycleLevel || null,
      };

      const result = await createClass(input);

      if (result.error) {
        setError(result.error.message);
        setIsSaving(false);
        return;
      }

      router.push(`/classes/${result.data!.id}`);
      router.refresh();
    }
  }

  return (
    <form onSubmit={handleSubmit} className="space-y-8">
      {/* Error banner */}
      {error && (
        <div className="rounded-md bg-red-50 p-4">
          <p className="text-sm text-red-700">{error}</p>
        </div>
      )}

      {/* â”€â”€ Section: Class Details â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */}
      <div className="rounded-lg border border-gray-200 bg-white p-6">
        <h2 className="mb-4 text-lg font-semibold text-gray-900">
          Class Details
        </h2>

        <div className="grid grid-cols-1 gap-6 sm:grid-cols-2">
          {/* Class name */}
          <div className="sm:col-span-2">
            <label
              htmlFor="className"
              className="block text-sm font-medium text-gray-700"
            >
              Class Name <span className="text-red-500">*</span>
            </label>
            <input
              id="className"
              type="text"
              required
              value={name}
              onChange={(e) => setName(e.target.value)}
              placeholder="e.g. Wattle Room, Banksia Environment"
              className="mt-1 block w-full rounded-lg border border-gray-300 px-4 py-2.5 text-sm placeholder:text-gray-400 focus:border-ring focus:outline-none focus:ring-1 focus:ring-ring"
            />
            <p className="mt-1 text-xs text-gray-500">
              The name guides and parents will see (e.g. &quot;Wattle Room&quot;
              or &quot;3â€“6 Primary A&quot;).
            </p>
          </div>

          {/* Room / location */}
          <div>
            <label
              htmlFor="room"
              className="block text-sm font-medium text-gray-700"
            >
              Room / Location
            </label>
            <input
              id="room"
              type="text"
              value={room}
              onChange={(e) => setRoom(e.target.value)}
              placeholder="e.g. Building A, Room 3"
              className="mt-1 block w-full rounded-lg border border-gray-300 px-4 py-2.5 text-sm placeholder:text-gray-400 focus:border-ring focus:outline-none focus:ring-1 focus:ring-ring"
            />
          </div>

          {/* Cycle level */}
          <div>
            <label
              htmlFor="cycleLevel"
              className="block text-sm font-medium text-gray-700"
            >
              Cycle Level
            </label>
            <select
              id="cycleLevel"
              value={cycleLevel}
              onChange={(e) => setCycleLevel(e.target.value)}
              className="mt-1 block w-full rounded-lg border border-gray-300 px-4 py-2.5 text-sm focus:border-ring focus:outline-none focus:ring-1 focus:ring-ring"
            >
              {CYCLE_LEVEL_OPTIONS.map((opt) => (
                <option key={opt.value} value={opt.value}>
                  {opt.label}
                </option>
              ))}
            </select>
            <p className="mt-1 text-xs text-gray-500">
              The Montessori age grouping for this classroom.
            </p>
          </div>

          {/* Active toggle (only in edit mode) */}
          {isEditing && (
            <div className="sm:col-span-2">
              <div className="flex items-center gap-3">
                <button
                  type="button"
                  role="switch"
                  aria-checked={isActive}
                  onClick={() => setIsActive(!isActive)}
                  className={`relative inline-flex h-6 w-11 shrink-0 cursor-pointer rounded-full border-2 border-transparent transition-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 ${
                    isActive ? "bg-amber-600" : "bg-gray-200"
                  }`}
                >
                  <span
                    className={`pointer-events-none inline-block h-5 w-5 rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out ${
                      isActive ? "translate-x-5" : "translate-x-0"
                    }`}
                  />
                </button>
                <label className="text-sm font-medium text-gray-700">
                  {isActive ? "Active" : "Inactive"}
                </label>
              </div>
              <p className="mt-1 text-xs text-gray-500">
                Inactive classes are hidden from enrollment options but retain
                their historical records.
              </p>
            </div>
          )}
        </div>
      </div>

      {/* â”€â”€ Actions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */}
      <div className="flex items-center justify-end gap-3">
        <Link
          href={isEditing ? `/classes/${initialData!.id}` : "/classes"}
          className="rounded-lg border border-gray-300 bg-white px-4 py-2.5 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2"
        >
          Cancel
        </Link>
        <button
          type="submit"
          disabled={isSaving || !name.trim()}
          className="rounded-lg bg-amber-600 px-6 py-2.5 text-sm font-medium text-white shadow-sm hover:bg-amber-700 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50"
        >
          {isSaving
            ? isEditing
              ? "Saving..."
              : "Creating..."
            : isEditing
              ? "Save Changes"
              : "Create Class"}
        </button>
      </div>
    </form>
  );
}



===== D:\.code\wattleos\src\components\domain\sis\ClassRosterActions.tsx =====

// src/components/domain/sis/ClassRosterActions.tsx
//
// ============================================================
// WattleOS V2 - Class Roster Action Buttons
// ============================================================
// 'use client' - handles withdrawal confirmation with inline
// date picker. Transfer navigates to a dedicated page.
//
// Why inline: Withdraw is destructive and needs confirmation +
// a date. A modal would work too, but inline disclosure keeps
// the user in context without layering UI.
// ============================================================

"use client";

import { withdrawStudent } from "@/lib/actions/enrollments";
import { useRouter } from "next/navigation";
import { useState, useTransition } from "react";

interface ClassRosterActionsProps {
  studentId: string;
  studentName: string;
  classId: string;
  enrollmentId: string;
}

export function ClassRosterActions({
  studentId,
  studentName,
  classId,
}: ClassRosterActionsProps) {
  const router = useRouter();
  const [isPending, startTransition] = useTransition();
  const [showConfirm, setShowConfirm] = useState(false);
  const [withdrawDate, setWithdrawDate] = useState(
    new Date().toISOString().split("T")[0],
  );
  const [error, setError] = useState<string | null>(null);

  async function handleWithdraw() {
    setError(null);

    const result = await withdrawStudent(studentId, classId, withdrawDate);

    if (result.error) {
      setError(result.error.message);
      return;
    }

    setShowConfirm(false);
    startTransition(() => {
      router.refresh();
    });
  }

  if (showConfirm) {
    return (
      <div className="flex items-center gap-2">
        <input
          type="date"
          value={withdrawDate}
          onChange={(e) => setWithdrawDate(e.target.value)}
          className="rounded border border-gray-300 px-2 py-1 text-xs focus:border-ring focus:outline-none focus:ring-1 focus:ring-ring"
        />
        <button
          onClick={handleWithdraw}
          disabled={isPending}
          className="rounded bg-red-600 px-3 py-1 text-xs font-medium text-white hover:bg-red-700 disabled:opacity-50"
        >
          {isPending ? "..." : "Confirm"}
        </button>
        <button
          onClick={() => {
            setShowConfirm(false);
            setError(null);
          }}
          className="rounded border border-gray-300 px-3 py-1 text-xs font-medium text-gray-600 hover:bg-gray-50"
        >
          Cancel
        </button>
        {error && <span className="text-xs text-red-600">{error}</span>}
      </div>
    );
  }

  return (
    <div className="flex items-center gap-2">
      <button
        onClick={() => setShowConfirm(true)}
        className="rounded border border-red-200 px-3 py-1 text-xs font-medium text-red-600 hover:bg-red-50"
      >
        Withdraw
      </button>
    </div>
  );
}



===== D:\.code\wattleos\src\components\domain\sis\CustodyRestrictionSection.tsx =====

// src/components/domain/sis/CustodyRestrictionSection.tsx
//
// ============================================================
// WattleOS V2 - Custody Restriction Management Section
// ============================================================
// 'use client' - inline add/edit/remove for custody restrictions.
//
// Why safety-critical styling: Custody restrictions are legal
// documents. The red border + warning banner aren't decorative â€”
// they ensure staff don't miss these records when making
// pickup/release decisions. Every CRUD operation is audit-logged
// by the server action (not here - that's the action's job).
// ============================================================

'use client';

import { useState, useTransition } from 'react';
import { useRouter } from 'next/navigation';
import {
  createCustodyRestriction,
  updateCustodyRestriction,
  deleteCustodyRestriction,
} from '@/lib/actions/custody';
import { RESTRICTION_TYPES } from '@/lib/constants';
import type { CustodyRestriction, RestrictionType } from '@/types/domain';
import type {
  CreateCustodyRestrictionInput,
  UpdateCustodyRestrictionInput,
} from '@/lib/actions/custody';

// â”€â”€ Props â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

interface CustodyRestrictionSectionProps {
  studentId: string;
  restrictions: CustodyRestriction[];
  canManage: boolean;
}

// â”€â”€ Component â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

export function CustodyRestrictionSection({
  studentId,
  restrictions,
  canManage,
}: CustodyRestrictionSectionProps) {
  const router = useRouter();
  const [isPending, startTransition] = useTransition();
  const [showAddForm, setShowAddForm] = useState(false);
  const [editingId, setEditingId] = useState<string | null>(null);
  const [error, setError] = useState<string | null>(null);

  // â”€â”€ Form state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const [restrictedPersonName, setRestrictedPersonName] = useState('');
  const [restrictionType, setRestrictionType] = useState<RestrictionType>('no_contact');
  const [courtOrderReference, setCourtOrderReference] = useState('');
  const [effectiveDate, setEffectiveDate] = useState(
    new Date().toISOString().split('T')[0]
  );
  const [expiryDate, setExpiryDate] = useState('');
  const [notes, setNotes] = useState('');

  function resetForm() {
    setRestrictedPersonName('');
    setRestrictionType('no_contact');
    setCourtOrderReference('');
    setEffectiveDate(new Date().toISOString().split('T')[0]);
    setExpiryDate('');
    setNotes('');
    setError(null);
  }

  function openAdd() {
    setEditingId(null);
    resetForm();
    setShowAddForm(true);
  }

  function openEdit(restriction: CustodyRestriction) {
    setShowAddForm(false);
    setEditingId(restriction.id);
    setRestrictedPersonName(restriction.restricted_person_name);
    setRestrictionType(restriction.restriction_type);
    setCourtOrderReference(restriction.court_order_reference ?? '');
    setEffectiveDate(restriction.effective_date);
    setExpiryDate(restriction.expiry_date ?? '');
    setNotes(restriction.notes ?? '');
    setError(null);
  }

  function closeForm() {
    setShowAddForm(false);
    setEditingId(null);
    resetForm();
  }

  async function handleAdd() {
    if (!restrictedPersonName.trim() || !restrictionType || !effectiveDate) {
      setError('Restricted person, restriction type, and effective date are required.');
      return;
    }

    const input: CreateCustodyRestrictionInput = {
      student_id: studentId,
      restricted_person_name: restrictedPersonName.trim(),
      restriction_type: restrictionType,
      court_order_reference: courtOrderReference.trim() || null,
      effective_date: effectiveDate,
      expiry_date: expiryDate || null,
      notes: notes.trim() || null,
    };

    const result = await createCustodyRestriction(input);
    if (result.error) {
      setError(result.error.message);
      return;
    }

    closeForm();
    startTransition(() => router.refresh());
  }

  async function handleUpdate(restrictionId: string) {
    const input: UpdateCustodyRestrictionInput = {
      restricted_person_name: restrictedPersonName.trim(),
      restriction_type: restrictionType,
      court_order_reference: courtOrderReference.trim() || null,
      effective_date: effectiveDate,
      expiry_date: expiryDate || null,
      notes: notes.trim() || null,
    };

    const result = await updateCustodyRestriction(restrictionId, input);
    if (result.error) {
      setError(result.error.message);
      return;
    }

    closeForm();
    startTransition(() => router.refresh());
  }

  async function handleDelete(restrictionId: string, personName: string) {
    if (
      !confirm(
        `âš ï¸ SAFETY-CRITICAL: Remove custody restriction for "${personName}"?\n\n` +
        `This action is audit-logged. Only proceed if you have authority to modify custody records.`
      )
    ) {
      return;
    }

    const result = await deleteCustodyRestriction(restrictionId);
    if (result.error) {
      setError(result.error.message);
      return;
    }

    startTransition(() => router.refresh());
  }

  // â”€â”€ Inline form â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function renderForm(mode: 'add' | 'edit', restrictionId?: string) {
    return (
      <div className="space-y-4 rounded-md border border-red-200 bg-red-50/50 p-4">
        {/* Safety warning */}
        <div className="flex items-start gap-2 rounded bg-red-100 p-2 text-xs text-red-800">
          <svg className="mt-0.5 h-4 w-4 shrink-0" fill="currentColor" viewBox="0 0 20 20">
            <path fillRule="evenodd" d="M8.485 2.495c.673-1.167 2.357-1.167 3.03 0l6.28 10.875c.673 1.167-.168 2.625-1.516 2.625H3.72c-1.347 0-2.189-1.458-1.515-2.625L8.485 2.495zM10 5a.75.75 0 01.75.75v3.5a.75.75 0 01-1.5 0v-3.5A.75.75 0 0110 5zm0 9a1 1 0 100-2 1 1 0 000 2z" clipRule="evenodd" />
          </svg>
          <span>
            Custody restrictions are safety-critical records. All changes are
            audit-logged with your identity and timestamp.
          </span>
        </div>

        {error && (
          <div className="rounded bg-red-50 p-2 text-xs text-red-700">{error}</div>
        )}

        <div className="grid grid-cols-1 gap-4 sm:grid-cols-2">
          <div>
            <label className="block text-xs font-medium text-gray-700">
              Restricted Person <span className="text-red-500">*</span>
            </label>
            <input
              type="text"
              value={restrictedPersonName}
              onChange={(e) => setRestrictedPersonName(e.target.value)}
              placeholder="Full name of the restricted person"
              className="mt-1 block w-full rounded border border-gray-300 px-3 py-2 text-sm placeholder:text-gray-400 focus:border-red-500 focus:outline-none focus:ring-1 focus:ring-red-500"
            />
          </div>

          <div>
            <label className="block text-xs font-medium text-gray-700">
              Restriction Type <span className="text-red-500">*</span>
            </label>
            <select
              value={restrictionType}
              onChange={(e) => setRestrictionType(e.target.value as RestrictionType)}
              className="mt-1 block w-full rounded border border-gray-300 px-3 py-2 text-sm focus:border-red-500 focus:outline-none focus:ring-1 focus:ring-red-500"
            >
              {RESTRICTION_TYPES.map((t) => (
                <option key={t.value} value={t.value}>
                  {t.label}
                </option>
              ))}
            </select>
          </div>
        </div>

        <div className="grid grid-cols-1 gap-4 sm:grid-cols-3">
          <div>
            <label className="block text-xs font-medium text-gray-700">
              Effective Date <span className="text-red-500">*</span>
            </label>
            <input
              type="date"
              value={effectiveDate}
              onChange={(e) => setEffectiveDate(e.target.value)}
              className="mt-1 block w-full rounded border border-gray-300 px-3 py-2 text-sm focus:border-red-500 focus:outline-none focus:ring-1 focus:ring-red-500"
            />
          </div>

          <div>
            <label className="block text-xs font-medium text-gray-700">
              Expiry Date
            </label>
            <input
              type="date"
              value={expiryDate}
              onChange={(e) => setExpiryDate(e.target.value)}
              className="mt-1 block w-full rounded border border-gray-300 px-3 py-2 text-sm focus:border-red-500 focus:outline-none focus:ring-1 focus:ring-red-500"
            />
            <p className="mt-1 text-xs text-gray-500">Leave blank if indefinite.</p>
          </div>

          <div>
            <label className="block text-xs font-medium text-gray-700">
              Court Order Reference
            </label>
            <input
              type="text"
              value={courtOrderReference}
              onChange={(e) => setCourtOrderReference(e.target.value)}
              placeholder="e.g. FCA-2024-1234"
              className="mt-1 block w-full rounded border border-gray-300 px-3 py-2 text-sm placeholder:text-gray-400 focus:border-red-500 focus:outline-none focus:ring-1 focus:ring-red-500"
            />
          </div>
        </div>

        <div>
          <label className="block text-xs font-medium text-gray-700">
            Notes
          </label>
          <textarea
            value={notes}
            onChange={(e) => setNotes(e.target.value)}
            rows={2}
            placeholder="Any additional context for staff..."
            className="mt-1 block w-full rounded border border-gray-300 px-3 py-2 text-sm placeholder:text-gray-400 focus:border-red-500 focus:outline-none focus:ring-1 focus:ring-red-500"
          />
        </div>

        <div className="flex gap-2">
          <button
            onClick={() => mode === 'add' ? handleAdd() : handleUpdate(restrictionId!)}
            disabled={isPending}
            className="rounded bg-red-600 px-3 py-1.5 text-sm font-medium text-white hover:bg-red-700 disabled:opacity-50"
          >
            {isPending ? 'Saving...' : mode === 'add' ? 'Add Restriction' : 'Save Changes'}
          </button>
          <button
            onClick={closeForm}
            className="rounded border border-gray-300 px-3 py-1.5 text-sm font-medium text-gray-600 hover:bg-gray-50"
          >
            Cancel
          </button>
        </div>
      </div>
    );
  }

  // â”€â”€ No restrictions case â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if (restrictions.length === 0 && !showAddForm) {
    // Only show the section header if user can manage (to show the add button)
    if (!canManage) return null;

    return (
      <section className="rounded-lg border border-gray-200 bg-white shadow-sm">
        <div className="flex items-center justify-between border-b border-gray-200 px-6 py-4">
          <h2 className="text-lg font-medium text-gray-900">Custody Restrictions</h2>
          <button
            onClick={openAdd}
            className="text-sm font-medium text-red-600 hover:text-red-700"
          >
            + Add Restriction
          </button>
        </div>
        <div className="px-6 py-4">
          <p className="text-sm text-gray-500">No custody restrictions on file.</p>
        </div>
      </section>
    );
  }

  return (
    <section className="rounded-lg border-2 border-red-200 bg-white shadow-sm lg:col-span-2">
      <div className="flex items-center justify-between border-b border-red-200 bg-red-50 px-6 py-4">
        <h2 className="text-lg font-medium text-red-900">
          Custody Restrictions
        </h2>
        {canManage && !showAddForm && !editingId && (
          <button
            onClick={openAdd}
            className="text-sm font-medium text-red-600 hover:text-red-700"
          >
            + Add Restriction
          </button>
        )}
      </div>
      <div className="px-6 py-4">
        <div className="space-y-3">
          {restrictions.map((restriction) => {
            if (editingId === restriction.id) {
              return (
                <div key={restriction.id}>
                  {renderForm('edit', restriction.id)}
                </div>
              );
            }

            return (
              <div
                key={restriction.id}
                className="rounded-md border border-red-100 bg-red-50/50 p-3"
              >
                <div className="flex items-start justify-between">
                  <div>
                    <div className="flex items-center gap-2">
                      <p className="text-sm font-medium text-red-900">
                        {restriction.restricted_person_name}
                      </p>
                      <span className="inline-flex rounded-full border border-red-200 bg-red-100 px-2 py-0.5 text-xs font-medium text-red-800">
                        {restriction.restriction_type.replace(/_/g, ' ')}
                      </span>
                    </div>
                    {restriction.court_order_reference && (
                      <p className="mt-1 text-xs text-red-700">
                        Court order: {restriction.court_order_reference}
                      </p>
                    )}
                    <p className="mt-1 text-xs text-red-600">
                      Effective: {restriction.effective_date}
                      {restriction.expiry_date &&
                        ` - Expires: ${restriction.expiry_date}`}
                    </p>
                    {restriction.notes && (
                      <p className="mt-1 text-xs text-red-600">
                        {restriction.notes}
                      </p>
                    )}
                  </div>
                  {canManage && (
                    <div className="flex gap-1">
                      <button
                        onClick={() => openEdit(restriction)}
                        className="rounded p-1 text-red-400 hover:bg-red-100 hover:text-red-600"
                        title="Edit"
                      >
                        <svg className="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                        </svg>
                      </button>
                      <button
                        onClick={() =>
                          handleDelete(restriction.id, restriction.restricted_person_name)
                        }
                        className="rounded p-1 text-red-400 hover:bg-red-100 hover:text-red-600"
                        title="Delete"
                      >
                        <svg className="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                      </button>
                    </div>
                  )}
                </div>
              </div>
            );
          })}
        </div>

        {showAddForm && <div className="mt-3">{renderForm('add')}</div>}
      </div>
    </section>
  );
}


===== D:\.code\wattleos\src\components\domain\sis\EmergencyContactSection.tsx =====

// src/components/domain/sis/EmergencyContactSection.tsx
//
// ============================================================
// WattleOS V2 - Emergency Contact Management Section
// ============================================================
// 'use client' - inline add/edit/remove for emergency contacts.
//
// Why separate from guardians: Not all emergency contacts are
// system users (e.g., a neighbour or family friend). These are
// plain contact records, not linked to auth accounts.
// ============================================================

"use client";

import type {
  CreateEmergencyContactInput,
  UpdateEmergencyContactInput,
} from "@/lib/actions/emergency-contacts";
import {
  createEmergencyContact,
  deleteEmergencyContact,
  updateEmergencyContact,
} from "@/lib/actions/emergency-contacts";
import type { EmergencyContact } from "@/types/domain";
import { useRouter } from "next/navigation";
import { useState, useTransition } from "react";

// â”€â”€ Props â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

interface EmergencyContactSectionProps {
  studentId: string;
  contacts: EmergencyContact[];
  canManage: boolean;
}

// â”€â”€ Component â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

export function EmergencyContactSection({
  studentId,
  contacts,
  canManage,
}: EmergencyContactSectionProps) {
  const router = useRouter();
  const [isPending, startTransition] = useTransition();
  const [showAddForm, setShowAddForm] = useState(false);
  const [editingId, setEditingId] = useState<string | null>(null);
  const [error, setError] = useState<string | null>(null);

  // â”€â”€ Form state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const [name, setName] = useState("");
  const [relationship, setRelationship] = useState("");
  const [phonePrimary, setPhonePrimary] = useState("");
  const [phoneSecondary, setPhoneSecondary] = useState("");
  const [email, setEmail] = useState("");
  const [priorityOrder, setPriorityOrder] = useState(contacts.length + 1);
  const [notes, setNotes] = useState("");

  function resetForm() {
    setName("");
    setRelationship("");
    setPhonePrimary("");
    setPhoneSecondary("");
    setEmail("");
    setPriorityOrder(contacts.length + 1);
    setNotes("");
    setError(null);
  }

  function openAdd() {
    setEditingId(null);
    resetForm();
    setPriorityOrder(contacts.length + 1);
    setShowAddForm(true);
  }

  function openEdit(contact: EmergencyContact) {
    setShowAddForm(false);
    setEditingId(contact.id);
    setName(contact.name);
    setRelationship(contact.relationship);
    setPhonePrimary(contact.phone_primary);
    setPhoneSecondary(contact.phone_secondary ?? "");
    setEmail(contact.email ?? "");
    setPriorityOrder(contact.priority_order);
    setNotes(contact.notes ?? "");
    setError(null);
  }

  function closeForm() {
    setShowAddForm(false);
    setEditingId(null);
    resetForm();
  }

  async function handleAdd() {
    if (!name.trim() || !relationship.trim() || !phonePrimary.trim()) {
      setError("Name, relationship, and primary phone are required.");
      return;
    }

    const input: CreateEmergencyContactInput = {
      student_id: studentId,
      name: name.trim(),
      relationship: relationship.trim(),
      phone_primary: phonePrimary.trim(),
      phone_secondary: phoneSecondary.trim() || null,
      email: email.trim() || null,
      priority_order: priorityOrder,
      notes: notes.trim() || null,
    };

    const result = await createEmergencyContact(input);
    if (result.error) {
      setError(result.error.message);
      return;
    }

    closeForm();
    startTransition(() => router.refresh());
  }

  async function handleUpdate(contactId: string) {
    const input: UpdateEmergencyContactInput = {
      name: name.trim(),
      relationship: relationship.trim(),
      phone_primary: phonePrimary.trim(),
      phone_secondary: phoneSecondary.trim() || null,
      email: email.trim() || null,
      priority_order: priorityOrder,
      notes: notes.trim() || null,
    };

    const result = await updateEmergencyContact(contactId, input);
    if (result.error) {
      setError(result.error.message);
      return;
    }

    closeForm();
    startTransition(() => router.refresh());
  }

  async function handleDelete(contactId: string, contactName: string) {
    if (!confirm(`Delete emergency contact "${contactName}"?`)) return;

    const result = await deleteEmergencyContact(contactId);
    if (result.error) {
      setError(result.error.message);
      return;
    }

    startTransition(() => router.refresh());
  }

  // â”€â”€ Inline form â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function renderForm(mode: "add" | "edit", contactId?: string) {
    return (
      <div className="space-y-4 rounded-md border border-amber-200 bg-amber-50/50 p-4">
        {error && (
          <div className="rounded bg-red-50 p-2 text-xs text-red-700">
            {error}
          </div>
        )}

        <div className="grid grid-cols-1 gap-4 sm:grid-cols-3">
          <div>
            <label className="block text-xs font-medium text-gray-700">
              Full Name <span className="text-red-500">*</span>
            </label>
            <input
              type="text"
              value={name}
              onChange={(e) => setName(e.target.value)}
              placeholder="e.g. Jane Smith"
              className="mt-1 block w-full rounded border border-gray-300 px-3 py-2 text-sm placeholder:text-gray-400 focus:border-ring focus:outline-none focus:ring-1 focus:ring-ring"
            />
          </div>

          <div>
            <label className="block text-xs font-medium text-gray-700">
              Relationship <span className="text-red-500">*</span>
            </label>
            <input
              type="text"
              value={relationship}
              onChange={(e) => setRelationship(e.target.value)}
              placeholder="e.g. Grandmother, Neighbour"
              className="mt-1 block w-full rounded border border-gray-300 px-3 py-2 text-sm placeholder:text-gray-400 focus:border-ring focus:outline-none focus:ring-1 focus:ring-ring"
            />
          </div>

          <div>
            <label className="block text-xs font-medium text-gray-700">
              Priority
            </label>
            <input
              type="number"
              min={1}
              max={10}
              value={priorityOrder}
              onChange={(e) => setPriorityOrder(Number(e.target.value))}
              className="mt-1 block w-full rounded border border-gray-300 px-3 py-2 text-sm focus:border-ring focus:outline-none focus:ring-1 focus:ring-ring"
            />
            <p className="mt-1 text-xs text-gray-500">1 = first to call</p>
          </div>
        </div>

        <div className="grid grid-cols-1 gap-4 sm:grid-cols-3">
          <div>
            <label className="block text-xs font-medium text-gray-700">
              Primary Phone <span className="text-red-500">*</span>
            </label>
            <input
              type="tel"
              value={phonePrimary}
              onChange={(e) => setPhonePrimary(e.target.value)}
              placeholder="e.g. 0412 345 678"
              className="mt-1 block w-full rounded border border-gray-300 px-3 py-2 text-sm placeholder:text-gray-400 focus:border-ring focus:outline-none focus:ring-1 focus:ring-ring"
            />
          </div>

          <div>
            <label className="block text-xs font-medium text-gray-700">
              Secondary Phone
            </label>
            <input
              type="tel"
              value={phoneSecondary}
              onChange={(e) => setPhoneSecondary(e.target.value)}
              placeholder="Optional"
              className="mt-1 block w-full rounded border border-gray-300 px-3 py-2 text-sm placeholder:text-gray-400 focus:border-ring focus:outline-none focus:ring-1 focus:ring-ring"
            />
          </div>

          <div>
            <label className="block text-xs font-medium text-gray-700">
              Email
            </label>
            <input
              type="email"
              value={email}
              onChange={(e) => setEmail(e.target.value)}
              placeholder="Optional"
              className="mt-1 block w-full rounded border border-gray-300 px-3 py-2 text-sm placeholder:text-gray-400 focus:border-ring focus:outline-none focus:ring-1 focus:ring-ring"
            />
          </div>
        </div>

        <div>
          <label className="block text-xs font-medium text-gray-700">
            Notes
          </label>
          <input
            type="text"
            value={notes}
            onChange={(e) => setNotes(e.target.value)}
            placeholder="e.g. Only available after 3pm"
            className="mt-1 block w-full rounded border border-gray-300 px-3 py-2 text-sm placeholder:text-gray-400 focus:border-ring focus:outline-none focus:ring-1 focus:ring-ring"
          />
        </div>

        <div className="flex gap-2">
          <button
            onClick={() =>
              mode === "add" ? handleAdd() : handleUpdate(contactId!)
            }
            disabled={isPending}
            className="rounded bg-amber-600 px-3 py-1.5 text-sm font-medium text-white hover:bg-amber-700 disabled:opacity-50"
          >
            {isPending
              ? "Saving..."
              : mode === "add"
                ? "Add Contact"
                : "Save Changes"}
          </button>
          <button
            onClick={closeForm}
            className="rounded border border-gray-300 px-3 py-1.5 text-sm font-medium text-gray-600 hover:bg-gray-50"
          >
            Cancel
          </button>
        </div>
      </div>
    );
  }

  return (
    <section className="rounded-lg border border-gray-200 bg-white shadow-sm">
      <div className="flex items-center justify-between border-b border-gray-200 px-6 py-4">
        <h2 className="text-lg font-medium text-gray-900">
          Emergency Contacts
        </h2>
        {canManage && !showAddForm && !editingId && (
          <button
            onClick={openAdd}
            className="text-sm font-medium text-amber-600 hover:text-amber-700"
          >
            + Add Contact
          </button>
        )}
      </div>
      <div className="px-6 py-4">
        {contacts.length === 0 && !showAddForm ? (
          <p className="text-sm text-gray-500">
            No emergency contacts recorded.
          </p>
        ) : (
          <div className="space-y-3">
            {contacts.map((contact) => {
              if (editingId === contact.id) {
                return (
                  <div key={contact.id}>{renderForm("edit", contact.id)}</div>
                );
              }

              return (
                <div
                  key={contact.id}
                  className="flex items-center justify-between rounded-md border border-gray-100 p-3"
                >
                  <div className="flex items-center gap-3">
                    <span className="flex h-6 w-6 items-center justify-center rounded-full bg-gray-200 text-xs font-medium text-gray-600">
                      {contact.priority_order}
                    </span>
                    <div>
                      <p className="text-sm font-medium text-gray-900">
                        {contact.name}
                      </p>
                      <p className="text-xs text-gray-500">
                        {contact.relationship} Â· {contact.phone_primary}
                        {contact.phone_secondary &&
                          ` / ${contact.phone_secondary}`}
                        {contact.email && ` Â· ${contact.email}`}
                      </p>
                      {contact.notes && (
                        <p className="text-xs text-gray-400">{contact.notes}</p>
                      )}
                    </div>
                  </div>
                  {canManage && (
                    <div className="flex gap-1">
                      <button
                        onClick={() => openEdit(contact)}
                        className="rounded p-1 text-gray-400 hover:bg-gray-100 hover:text-gray-600"
                        title="Edit"
                      >
                        <svg
                          className="h-4 w-4"
                          fill="none"
                          stroke="currentColor"
                          viewBox="0 0 24 24"
                        >
                          <path
                            strokeLinecap="round"
                            strokeLinejoin="round"
                            strokeWidth={2}
                            d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"
                          />
                        </svg>
                      </button>
                      <button
                        onClick={() => handleDelete(contact.id, contact.name)}
                        className="rounded p-1 text-gray-400 hover:bg-red-50 hover:text-red-600"
                        title="Delete"
                      >
                        <svg
                          className="h-4 w-4"
                          fill="none"
                          stroke="currentColor"
                          viewBox="0 0 24 24"
                        >
                          <path
                            strokeLinecap="round"
                            strokeLinejoin="round"
                            strokeWidth={2}
                            d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
                          />
                        </svg>
                      </button>
                    </div>
                  )}
                </div>
              );
            })}
          </div>
        )}

        {showAddForm && renderForm("add")}
      </div>
    </section>
  );
}



===== D:\.code\wattleos\src\components\domain\sis\EnrollStudentForm.tsx =====

// src/components/domain/sis/EnrollStudentForm.tsx
//
// ============================================================
// WattleOS V2 - Enroll Student Form
// ============================================================
// 'use client' - search for a student, pick start date, enroll.
//
// Why client-side search: The student picker needs to be
// interactive with debounced search. We call the listStudents
// server action directly from the client - no API route needed.
// ============================================================

"use client";

import { enrollStudent } from "@/lib/actions/enrollments";
import { listStudents } from "@/lib/actions/students";
import { calculateAge, formatStudentName } from "@/lib/utils";
import type { Student } from "@/types/domain";
import Link from "next/link";
import { useRouter } from "next/navigation";
import { useCallback, useState } from "react";

// â”€â”€ Props â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

interface EnrollStudentFormProps {
  classId: string;
  className: string;
}

// â”€â”€ Component â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

export function EnrollStudentForm({
  classId,
  className,
}: EnrollStudentFormProps) {
  const router = useRouter();

  // â”€â”€ Search state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const [searchQuery, setSearchQuery] = useState("");
  const [searchResults, setSearchResults] = useState<Student[]>([]);
  const [isSearching, setIsSearching] = useState(false);
  const [hasSearched, setHasSearched] = useState(false);

  // â”€â”€ Selection state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const [selectedStudent, setSelectedStudent] = useState<Student | null>(null);
  const [startDate, setStartDate] = useState(
    new Date().toISOString().split("T")[0],
  );

  // â”€â”€ Submission state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const [isEnrolling, setIsEnrolling] = useState(false);
  const [error, setError] = useState<string | null>(null);

  // â”€â”€ Search handler â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const handleSearch = useCallback(async () => {
    if (!searchQuery.trim()) return;

    setIsSearching(true);
    setHasSearched(true);
    setError(null);

    const result = await listStudents({
      search: searchQuery.trim(),
      per_page: 10,
      enrollment_status: "active",
    });

    if (result.data) {
      setSearchResults(result.data);
    }

    setIsSearching(false);
  }, [searchQuery]);

  // â”€â”€ Enroll handler â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function handleEnroll() {
    if (!selectedStudent) return;

    setIsEnrolling(true);
    setError(null);

    const result = await enrollStudent({
      student_id: selectedStudent.id,
      class_id: classId,
      start_date: startDate,
    });

    if (result.error) {
      setError(result.error.message);
      setIsEnrolling(false);
      return;
    }

    // Success - redirect back to class detail
    router.push(`/classes/${classId}`);
    router.refresh();
  }

  return (
    <div className="space-y-6">
      {/* Error banner */}
      {error && (
        <div className="rounded-md bg-red-50 p-4">
          <p className="text-sm text-red-700">{error}</p>
        </div>
      )}

      {/* â”€â”€ Step 1: Search for a student â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */}
      <div className="rounded-lg border border-gray-200 bg-white p-6">
        <h2 className="mb-4 text-lg font-semibold text-gray-900">
          1. Find Student
        </h2>

        <div className="flex gap-3">
          <input
            type="text"
            value={searchQuery}
            onChange={(e) => setSearchQuery(e.target.value)}
            onKeyDown={(e) => {
              if (e.key === "Enter") {
                e.preventDefault();
                handleSearch();
              }
            }}
            placeholder="Search by name..."
            className="flex-1 rounded-lg border border-gray-300 px-4 py-2.5 text-sm placeholder:text-gray-400 focus:border-ring focus:outline-none focus:ring-1 focus:ring-ring"
          />
          <button
            onClick={handleSearch}
            disabled={isSearching || !searchQuery.trim()}
            className="rounded-lg bg-gray-900 px-4 py-2.5 text-sm font-medium text-white hover:bg-gray-800 disabled:cursor-not-allowed disabled:opacity-50"
          >
            {isSearching ? "Searching..." : "Search"}
          </button>
        </div>

        {/* Search results */}
        {hasSearched && (
          <div className="mt-4">
            {searchResults.length === 0 ? (
              <p className="text-sm text-gray-500">
                No active students found matching &quot;{searchQuery}&quot;.
              </p>
            ) : (
              <div className="divide-y divide-gray-100 rounded-lg border border-gray-200">
                {searchResults.map((student) => {
                  const displayName = formatStudentName(
                    student.first_name,
                    student.last_name,
                    student.preferred_name,
                  );
                  const age = calculateAge(student.dob);
                  const isSelected = selectedStudent?.id === student.id;

                  return (
                    <button
                      key={student.id}
                      type="button"
                      onClick={() => setSelectedStudent(student)}
                      className={`flex w-full items-center gap-3 px-4 py-3 text-left transition-colors ${
                        isSelected
                          ? "bg-amber-50 ring-1 ring-inset ring-amber-200"
                          : "hover:bg-gray-50"
                      }`}
                    >
                      <div className="flex h-8 w-8 items-center justify-center rounded-full bg-amber-100 text-xs font-medium text-amber-700">
                        {student.first_name[0]}
                        {student.last_name[0]}
                      </div>
                      <div className="flex-1">
                        <p className="text-sm font-medium text-gray-900">
                          {displayName}
                        </p>
                        {age !== null && (
                          <p className="text-xs text-gray-500">Age {age}</p>
                        )}
                      </div>
                      {isSelected && (
                        <svg
                          className="h-5 w-5 text-amber-600"
                          fill="currentColor"
                          viewBox="0 0 20 20"
                        >
                          <path
                            fillRule="evenodd"
                            d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.857-9.809a.75.75 0 00-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 10-1.06 1.061l2.5 2.5a.75.75 0 001.137-.089l4-5.5z"
                            clipRule="evenodd"
                          />
                        </svg>
                      )}
                    </button>
                  );
                })}
              </div>
            )}
          </div>
        )}
      </div>

      {/* â”€â”€ Step 2: Set enrollment date â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */}
      {selectedStudent && (
        <div className="rounded-lg border border-gray-200 bg-white p-6">
          <h2 className="mb-4 text-lg font-semibold text-gray-900">
            2. Set Start Date
          </h2>

          <div className="flex items-end gap-6">
            <div>
              <label
                htmlFor="startDate"
                className="block text-sm font-medium text-gray-700"
              >
                Enrollment Start Date
              </label>
              <input
                id="startDate"
                type="date"
                value={startDate}
                onChange={(e) => setStartDate(e.target.value)}
                className="mt-1 rounded-lg border border-gray-300 px-4 py-2.5 text-sm focus:border-ring focus:outline-none focus:ring-1 focus:ring-ring"
              />
            </div>

            <div className="rounded-lg bg-amber-50 px-4 py-3 text-sm text-amber-800">
              <span className="font-medium">
                {formatStudentName(
                  selectedStudent.first_name,
                  selectedStudent.last_name,
                  selectedStudent.preferred_name,
                )}
              </span>{" "}
              â†’ <span className="font-medium">{className}</span>
            </div>
          </div>
        </div>
      )}

      {/* â”€â”€ Actions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */}
      <div className="flex items-center justify-end gap-3">
        <Link
          href={`/classes/${classId}`}
          className="rounded-lg border border-gray-300 bg-white px-4 py-2.5 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2"
        >
          Cancel
        </Link>
        <button
          onClick={handleEnroll}
          disabled={!selectedStudent || isEnrolling}
          className="rounded-lg bg-amber-600 px-6 py-2.5 text-sm font-medium text-white shadow-sm hover:bg-amber-700 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50"
        >
          {isEnrolling ? "Enrolling..." : "Enroll Student"}
        </button>
      </div>
    </div>
  );
}



===== D:\.code\wattleos\src\components\domain\sis\GuardianSection.tsx =====

// src/components/domain/sis/GuardianSection.tsx
//
// ============================================================
// WattleOS V2 â€” Guardian Management Section (DESIGN SYSTEM MIGRATED)
// ============================================================
// MIGRATION CHANGES:
// â€¢ Card: border-gray-200 bg-white â†’ border-border bg-card
// â€¢ Section border: border-gray-200 â†’ border-border
// â€¢ Headings: text-gray-900 â†’ text-foreground
// â€¢ Labels: text-gray-700 â†’ text-foreground
// â€¢ Descriptions: text-gray-500 â†’ text-muted-foreground
// â€¢ Inputs: border-gray-300, focus:amber â†’ border-input, focus:ring
// â€¢ Checkboxes: text-amber-600 focus:ring-ring
//   â†’ text-primary focus:ring-ring
// â€¢ Primary btn: bg-amber-600 hover:bg-amber-700
//   â†’ bg-primary hover:bg-primary/90 text-primary-foreground
// â€¢ Cancel btn: border-gray-300 text-gray-600 hover:bg-gray-50
//   â†’ border-border text-muted-foreground hover:bg-muted
// â€¢ Form bg: border-amber-200 bg-amber-50/50
//   â†’ border-primary/30 bg-primary/5
// â€¢ Error: bg-red-50 text-red-700 â†’ bg-destructive/10 text-destructive
// â€¢ Required asterisk: text-red-500 â†’ text-destructive
// â€¢ Row: border-gray-100 â†’ border-border/50
// â€¢ "Primary" label: text-indigo-600 â†’ text-primary
// â€¢ Status badges: bg-green-50/blue-50/orange-50
//   â†’ semantic bg-[var(--success)]/10 etc. via inline style
// â€¢ Icon buttons: text-gray-400 hover:bg-gray-100
//   â†’ text-muted-foreground hover:bg-muted
// â€¢ Delete hover: hover:bg-red-50 hover:text-red-600
//   â†’ hover:bg-destructive/10 hover:text-destructive
// â€¢ Add link: text-amber-600 hover:text-amber-700
//   â†’ text-primary hover:text-primary/80
// â€¢ Spacing: px-6 py-4 â†’ p-[var(--density-card-padding)]
// â€¢ Typography: text-lg/sm/xs â†’ text-[length:var(--text-*)]
// ============================================================

"use client";

import type {
  CreateGuardianInput,
  UpdateGuardianInput,
} from "@/lib/actions/guardians";
import {
  createGuardian,
  removeGuardian,
  updateGuardian,
} from "@/lib/actions/guardians";
import { GUARDIAN_RELATIONSHIPS } from "@/lib/constants";
import type { GuardianWithUser } from "@/types/domain";
import { useRouter } from "next/navigation";
import { useState, useTransition } from "react";

// â”€â”€ Props â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

interface GuardianSectionProps {
  studentId: string;
  guardians: GuardianWithUser[];
  canManage: boolean;
}

// â”€â”€ Component â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

export function GuardianSection({
  studentId,
  guardians,
  canManage,
}: GuardianSectionProps) {
  const router = useRouter();
  const [isPending, startTransition] = useTransition();
  const [showAddForm, setShowAddForm] = useState(false);
  const [editingId, setEditingId] = useState<string | null>(null);
  const [error, setError] = useState<string | null>(null);

  // â”€â”€ Add form state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const [userId, setUserId] = useState("");
  const [relationship, setRelationship] = useState("");
  const [isPrimary, setIsPrimary] = useState(false);
  const [isEmergencyContact, setIsEmergencyContact] = useState(false);
  const [pickupAuthorized, setPickupAuthorized] = useState(true);
  const [phone, setPhone] = useState("");
  const [mediaConsent, setMediaConsent] = useState(false);
  const [directoryConsent, setDirectoryConsent] = useState(false);

  function resetForm() {
    setUserId("");
    setRelationship("");
    setIsPrimary(false);
    setIsEmergencyContact(false);
    setPickupAuthorized(true);
    setPhone("");
    setMediaConsent(false);
    setDirectoryConsent(false);
    setError(null);
  }

  function openAdd() {
    setEditingId(null);
    resetForm();
    setShowAddForm(true);
  }

  function openEdit(guardian: GuardianWithUser) {
    setShowAddForm(false);
    setEditingId(guardian.id);
    setRelationship(guardian.relationship);
    setIsPrimary(guardian.is_primary);
    setIsEmergencyContact(guardian.is_emergency_contact);
    setPickupAuthorized(guardian.pickup_authorized);
    setPhone(guardian.phone ?? "");
    setMediaConsent(guardian.media_consent);
    setDirectoryConsent(guardian.directory_consent);
    setError(null);
  }

  function closeForm() {
    setShowAddForm(false);
    setEditingId(null);
    resetForm();
  }

  async function handleAdd() {
    if (!userId.trim() || !relationship) {
      setError("User ID and relationship are required.");
      return;
    }

    const input: CreateGuardianInput = {
      user_id: userId.trim(),
      student_id: studentId,
      relationship,
      is_primary: isPrimary,
      is_emergency_contact: isEmergencyContact,
      pickup_authorized: pickupAuthorized,
      phone: phone.trim() || null,
      media_consent: mediaConsent,
      directory_consent: directoryConsent,
    };

    const result = await createGuardian(input);
    if (result.error) {
      setError(result.error.message);
      return;
    }

    closeForm();
    startTransition(() => router.refresh());
  }

  async function handleUpdate(guardianId: string) {
    const input: UpdateGuardianInput = {
      relationship,
      is_primary: isPrimary,
      is_emergency_contact: isEmergencyContact,
      pickup_authorized: pickupAuthorized,
      phone: phone.trim() || null,
      media_consent: mediaConsent,
      directory_consent: directoryConsent,
    };

    const result = await updateGuardian(guardianId, input);
    if (result.error) {
      setError(result.error.message);
      return;
    }

    closeForm();
    startTransition(() => router.refresh());
  }

  async function handleRemove(guardianId: string, guardianName: string) {
    if (
      !confirm(`Remove ${guardianName} as a guardian? This cannot be undone.`)
    ) {
      return;
    }

    const result = await removeGuardian(guardianId);
    if (result.error) {
      setError(result.error.message);
      return;
    }

    startTransition(() => router.refresh());
  }

  // â”€â”€ Inline form (shared between add and edit) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function renderForm(mode: "add" | "edit", guardianId?: string) {
    return (
      <div className="space-y-[var(--density-md)] rounded-md border border-primary/30 bg-primary/5 p-[var(--density-card-padding)]">
        {error && (
          <div className="rounded bg-destructive/10 p-2 text-[length:var(--text-xs)] text-destructive">
            {error}
          </div>
        )}

        {mode === "add" && (
          <div>
            <label className="block text-[length:var(--text-xs)] font-medium text-foreground">
              User ID <span className="text-destructive">*</span>
            </label>
            <input
              type="text"
              value={userId}
              onChange={(e) => setUserId(e.target.value)}
              placeholder="Paste the parent/guardian's user UUID"
              className="mt-1 block w-full rounded border border-input bg-card px-3 py-2 text-[length:var(--text-sm)] text-foreground placeholder:text-muted-foreground focus:border-ring focus:outline-none focus:ring-1 focus:ring-ring"
            />
            <p className="mt-1 text-[length:var(--text-xs)] text-muted-foreground">
              The parent must already have a WattleOS account. Use their UUID
              from the Users page.
            </p>
          </div>
        )}

        <div className="grid grid-cols-1 gap-[var(--density-md)] sm:grid-cols-2">
          <div>
            <label className="block text-[length:var(--text-xs)] font-medium text-foreground">
              Relationship <span className="text-destructive">*</span>
            </label>
            <select
              value={relationship}
              onChange={(e) => setRelationship(e.target.value)}
              className="mt-1 block w-full rounded border border-input bg-card px-3 py-2 text-[length:var(--text-sm)] text-foreground focus:border-ring focus:outline-none focus:ring-1 focus:ring-ring"
            >
              <option value="">Select...</option>
              {GUARDIAN_RELATIONSHIPS.map((r) => (
                <option key={r.value} value={r.value}>
                  {r.label}
                </option>
              ))}
            </select>
          </div>

          <div>
            <label className="block text-[length:var(--text-xs)] font-medium text-foreground">
              Phone
            </label>
            <input
              type="tel"
              value={phone}
              onChange={(e) => setPhone(e.target.value)}
              placeholder="e.g. 0412 345 678"
              className="mt-1 block w-full rounded border border-input bg-card px-3 py-2 text-[length:var(--text-sm)] text-foreground placeholder:text-muted-foreground focus:border-ring focus:outline-none focus:ring-1 focus:ring-ring"
            />
          </div>
        </div>

        {/* Toggles */}
        <div className="grid grid-cols-2 gap-[var(--density-sm)] sm:grid-cols-3">
          {[
            {
              label: "Primary guardian",
              checked: isPrimary,
              onChange: setIsPrimary,
            },
            {
              label: "Emergency contact",
              checked: isEmergencyContact,
              onChange: setIsEmergencyContact,
            },
            {
              label: "Pickup authorized",
              checked: pickupAuthorized,
              onChange: setPickupAuthorized,
            },
            {
              label: "Media consent",
              checked: mediaConsent,
              onChange: setMediaConsent,
            },
            {
              label: "Directory consent",
              checked: directoryConsent,
              onChange: setDirectoryConsent,
            },
          ].map((toggle) => (
            <label
              key={toggle.label}
              className="flex items-center gap-2 text-[length:var(--text-sm)] text-foreground"
            >
              <input
                type="checkbox"
                checked={toggle.checked}
                onChange={(e) => toggle.onChange(e.target.checked)}
                className="h-4 w-4 rounded border-input text-primary focus:ring-ring"
              />
              {toggle.label}
            </label>
          ))}
        </div>

        {/* Actions */}
        <div className="flex gap-2">
          <button
            onClick={() =>
              mode === "add" ? handleAdd() : handleUpdate(guardianId!)
            }
            disabled={isPending}
            className="rounded bg-primary px-3 py-1.5 text-[length:var(--text-sm)] font-medium text-primary-foreground hover:bg-primary/90 disabled:opacity-50"
          >
            {isPending
              ? "Saving..."
              : mode === "add"
                ? "Add Guardian"
                : "Save Changes"}
          </button>
          <button
            onClick={closeForm}
            className="rounded border border-border px-3 py-1.5 text-[length:var(--text-sm)] font-medium text-muted-foreground hover:bg-muted"
          >
            Cancel
          </button>
        </div>
      </div>
    );
  }

  return (
    <section className="rounded-lg border border-border bg-card shadow-[var(--shadow-xs)]">
      <div className="flex items-center justify-between border-b border-border px-[var(--density-card-padding)] py-[var(--density-card-padding)]">
        <h2 className="text-[length:var(--text-lg)] font-medium text-foreground">
          Guardians
        </h2>
        {canManage && !showAddForm && !editingId && (
          <button
            onClick={openAdd}
            className="text-[length:var(--text-sm)] font-medium text-primary hover:text-primary/80"
          >
            + Add Guardian
          </button>
        )}
      </div>
      <div className="p-[var(--density-card-padding)]">
        {guardians.length === 0 && !showAddForm ? (
          <p className="text-[length:var(--text-sm)] text-muted-foreground">
            No guardians linked.
          </p>
        ) : (
          <div className="space-y-[var(--density-sm)]">
            {guardians.map((guardian) => {
              if (editingId === guardian.id) {
                return (
                  <div key={guardian.id}>{renderForm("edit", guardian.id)}</div>
                );
              }

              return (
                <div
                  key={guardian.id}
                  className="flex items-center justify-between rounded-md border border-border/50 p-3"
                >
                  <div>
                    <p className="text-[length:var(--text-sm)] font-medium text-foreground">
                      {guardian.user?.first_name} {guardian.user?.last_name}
                      {guardian.is_primary && (
                        <span className="ml-2 text-[length:var(--text-xs)] font-normal text-primary">
                          Primary
                        </span>
                      )}
                    </p>
                    <p className="text-[length:var(--text-xs)] text-muted-foreground">
                      {guardian.relationship}
                      {guardian.phone && ` Â· ${guardian.phone}`}
                      {guardian.user?.email && ` Â· ${guardian.user.email}`}
                    </p>
                  </div>
                  <div className="flex items-center gap-2">
                    <div className="flex gap-1">
                      {guardian.pickup_authorized && (
                        <span
                          className="rounded px-1.5 py-0.5 text-[length:var(--text-xs)]"
                          style={{
                            backgroundColor:
                              "color-mix(in srgb, var(--success) 12%, transparent)",
                            color: "var(--success)",
                          }}
                        >
                          Pickup
                        </span>
                      )}
                      {guardian.media_consent && (
                        <span
                          className="rounded px-1.5 py-0.5 text-[length:var(--text-xs)]"
                          style={{
                            backgroundColor:
                              "color-mix(in srgb, var(--info) 12%, transparent)",
                            color: "var(--info)",
                          }}
                        >
                          Media
                        </span>
                      )}
                      {guardian.is_emergency_contact && (
                        <span
                          className="rounded px-1.5 py-0.5 text-[length:var(--text-xs)]"
                          style={{
                            backgroundColor:
                              "color-mix(in srgb, var(--warning) 12%, transparent)",
                            color: "var(--warning)",
                          }}
                        >
                          Emergency
                        </span>
                      )}
                    </div>
                    {canManage && (
                      <div className="flex gap-1">
                        <button
                          onClick={() => openEdit(guardian)}
                          className="rounded p-1 text-muted-foreground hover:bg-muted hover:text-foreground"
                          title="Edit"
                        >
                          <svg
                            className="h-4 w-4"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                          >
                            <path
                              strokeLinecap="round"
                              strokeLinejoin="round"
                              strokeWidth={2}
                              d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"
                            />
                          </svg>
                        </button>
                        <button
                          onClick={() =>
                            handleRemove(
                              guardian.id,
                              `${guardian.user?.first_name} ${guardian.user?.last_name}`,
                            )
                          }
                          className="rounded p-1 text-muted-foreground hover:bg-destructive/10 hover:text-destructive"
                          title="Remove"
                        >
                          <svg
                            className="h-4 w-4"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                          >
                            <path
                              strokeLinecap="round"
                              strokeLinejoin="round"
                              strokeWidth={2}
                              d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
                            />
                          </svg>
                        </button>
                      </div>
                    )}
                  </div>
                </div>
              );
            })}
          </div>
        )}

        {showAddForm && renderForm("add")}
      </div>
    </section>
  );
}



===== D:\.code\wattleos\src\components\domain\sis\MedicalConditionSection.tsx =====

// src/components/domain/sis/MedicalConditionSection.tsx
//
// ============================================================
// WattleOS V2 â€” Medical Condition Section (DESIGN SYSTEM MIGRATED)
// ============================================================
// MIGRATION CHANGES:
// â€¢ Severity badges: hardcoded red/orange/yellow/green
//   â†’ CSS variables (--medical-life-threatening, --medical-severe,
//     --medical-moderate, --medical-mild) via inline styles.
//   WHY inline: medical severity is domain-specific and uses
//   color-mix() to derive bg/border from a single token.
//   These colors intentionally do NOT change with brand hue â€”
//   a life-threatening condition is always red regardless of school.
// â€¢ Card: border-gray-200 bg-white â†’ border-border bg-card
// â€¢ Section header: text-gray-900 â†’ text-foreground
// â€¢ Labels: text-gray-700 â†’ text-foreground
// â€¢ Descriptions: text-gray-500/600 â†’ text-muted-foreground
// â€¢ Inputs: border-gray-300 focus:amber â†’ border-input focus:ring
// â€¢ Checkbox: text-amber-600 â†’ text-primary
// â€¢ Primary btn: bg-amber-600 â†’ bg-primary text-primary-foreground
// â€¢ Cancel btn: border-gray-300 text-gray-600 â†’ border-border text-muted-foreground
// â€¢ Form bg: border-amber-200 bg-amber-50/50 â†’ border-primary/30 bg-primary/5
// â€¢ Error: bg-red-50 text-red-700 â†’ bg-destructive/10 text-destructive
// â€¢ Required: text-red-500 â†’ text-destructive
// â€¢ Row: border-gray-100 â†’ border-border/50
// â€¢ Type badge: bg-gray-100 text-gray-600 â†’ bg-muted text-muted-foreground
// â€¢ Medication: text-blue-600 â†’ text-info
// â€¢ Delete hover: hover:bg-red-50 â†’ hover:bg-destructive/10
// â€¢ Spacing & typography â†’ density & font-scale variables
// ============================================================

'use client';

import { useState, useTransition } from 'react';
import { useRouter } from 'next/navigation';
import {
  createMedicalCondition,
  updateMedicalCondition,
  deleteMedicalCondition,
} from '@/lib/actions/medical';
import {
  MEDICAL_CONDITION_TYPES,
  MEDICAL_SEVERITIES,
} from '@/lib/constants';
import type { MedicalCondition, MedicalSeverity } from '@/types/domain';
import type {
  CreateMedicalConditionInput,
  UpdateMedicalConditionInput,
} from '@/lib/actions/medical';

// â”€â”€ Severity style helper â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Returns inline styles using CSS variables from globals.css.
// color-mix() derives bg (12% opacity) and border (25% opacity)
// from a single domain token, keeping dark mode support automatic.

function getSeverityStyle(severity: MedicalSeverity): React.CSSProperties {
  const varMap: Record<MedicalSeverity, string> = {
    life_threatening: 'var(--medical-life-threatening)',
    severe: 'var(--medical-severe)',
    moderate: 'var(--medical-moderate)',
    mild: 'var(--medical-mild)',
  };
  const color = varMap[severity];
  return {
    backgroundColor: `color-mix(in srgb, ${color} 12%, transparent)`,
    color: color,
    borderColor: `color-mix(in srgb, ${color} 25%, transparent)`,
  };
}

// â”€â”€ Props â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

interface MedicalConditionSectionProps {
  studentId: string;
  conditions: MedicalCondition[];
  canManage: boolean;
}

// â”€â”€ Component â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

export function MedicalConditionSection({
  studentId,
  conditions,
  canManage,
}: MedicalConditionSectionProps) {
  const router = useRouter();
  const [isPending, startTransition] = useTransition();
  const [showAddForm, setShowAddForm] = useState(false);
  const [editingId, setEditingId] = useState<string | null>(null);
  const [error, setError] = useState<string | null>(null);

  // â”€â”€ Form state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const [conditionType, setConditionType] = useState('');
  const [conditionName, setConditionName] = useState('');
  const [severity, setSeverity] = useState<MedicalSeverity>('mild');
  const [description, setDescription] = useState('');
  const [actionPlan, setActionPlan] = useState('');
  const [requiresMedication, setRequiresMedication] = useState(false);
  const [medicationName, setMedicationName] = useState('');
  const [medicationLocation, setMedicationLocation] = useState('');
  const [expiryDate, setExpiryDate] = useState('');

  function resetForm() {
    setConditionType('');
    setConditionName('');
    setSeverity('mild');
    setDescription('');
    setActionPlan('');
    setRequiresMedication(false);
    setMedicationName('');
    setMedicationLocation('');
    setExpiryDate('');
    setError(null);
  }

  function openAdd() {
    setEditingId(null);
    resetForm();
    setShowAddForm(true);
  }

  function openEdit(condition: MedicalCondition) {
    setShowAddForm(false);
    setEditingId(condition.id);
    setConditionType(condition.condition_type);
    setConditionName(condition.condition_name);
    setSeverity(condition.severity);
    setDescription(condition.description ?? '');
    setActionPlan(condition.action_plan ?? '');
    setRequiresMedication(condition.requires_medication);
    setMedicationName(condition.medication_name ?? '');
    setMedicationLocation(condition.medication_location ?? '');
    setExpiryDate(condition.expiry_date ?? '');
    setError(null);
  }

  function closeForm() {
    setShowAddForm(false);
    setEditingId(null);
    resetForm();
  }

  async function handleAdd() {
    if (!conditionType || !conditionName.trim()) {
      setError('Condition type and name are required.');
      return;
    }

    const input: CreateMedicalConditionInput = {
      student_id: studentId,
      condition_type: conditionType,
      condition_name: conditionName.trim(),
      severity,
      description: description.trim() || null,
      action_plan: actionPlan.trim() || null,
      requires_medication: requiresMedication,
      medication_name: requiresMedication ? medicationName.trim() || null : null,
      medication_location: requiresMedication ? medicationLocation.trim() || null : null,
      expiry_date: expiryDate || null,
    };

    const result = await createMedicalCondition(input);
    if (result.error) {
      setError(result.error.message);
      return;
    }

    closeForm();
    startTransition(() => router.refresh());
  }

  async function handleUpdate(conditionId: string) {
    const input: UpdateMedicalConditionInput = {
      condition_type: conditionType,
      condition_name: conditionName.trim(),
      severity,
      description: description.trim() || null,
      action_plan: actionPlan.trim() || null,
      requires_medication: requiresMedication,
      medication_name: requiresMedication ? medicationName.trim() || null : null,
      medication_location: requiresMedication ? medicationLocation.trim() || null : null,
      expiry_date: expiryDate || null,
    };

    const result = await updateMedicalCondition(conditionId, input);
    if (result.error) {
      setError(result.error.message);
      return;
    }

    closeForm();
    startTransition(() => router.refresh());
  }

  async function handleDelete(conditionId: string, conditionName: string) {
    if (!confirm(`Delete "${conditionName}"? This cannot be undone.`)) return;

    const result = await deleteMedicalCondition(conditionId);
    if (result.error) {
      setError(result.error.message);
      return;
    }

    startTransition(() => router.refresh());
  }

  // â”€â”€ Inline form â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function renderForm(mode: 'add' | 'edit', conditionId?: string) {
    return (
      <div className="space-y-[var(--density-md)] rounded-md border border-primary/30 bg-primary/5 p-[var(--density-card-padding)]">
        {error && (
          <div className="rounded bg-destructive/10 p-2 text-[length:var(--text-xs)] text-destructive">{error}</div>
        )}

        <div className="grid grid-cols-1 gap-[var(--density-md)] sm:grid-cols-3">
          <div>
            <label className="block text-[length:var(--text-xs)] font-medium text-foreground">
              Type <span className="text-destructive">*</span>
            </label>
            <select
              value={conditionType}
              onChange={(e) => setConditionType(e.target.value)}
              className="mt-1 block w-full rounded border border-input bg-card px-3 py-2 text-[length:var(--text-sm)] text-foreground focus:border-ring focus:outline-none focus:ring-1 focus:ring-ring"
            >
              <option value="">Select...</option>
              {MEDICAL_CONDITION_TYPES.map((t) => (
                <option key={t.value} value={t.value}>
                  {t.label}
                </option>
              ))}
            </select>
          </div>

          <div>
            <label className="block text-[length:var(--text-xs)] font-medium text-foreground">
              Condition Name <span className="text-destructive">*</span>
            </label>
            <input
              type="text"
              value={conditionName}
              onChange={(e) => setConditionName(e.target.value)}
              placeholder="e.g. Peanut allergy"
              className="mt-1 block w-full rounded border border-input bg-card px-3 py-2 text-[length:var(--text-sm)] text-foreground placeholder:text-muted-foreground focus:border-ring focus:outline-none focus:ring-1 focus:ring-ring"
            />
          </div>

          <div>
            <label className="block text-[length:var(--text-xs)] font-medium text-foreground">
              Severity <span className="text-destructive">*</span>
            </label>
            <select
              value={severity}
              onChange={(e) => setSeverity(e.target.value as MedicalSeverity)}
              className="mt-1 block w-full rounded border border-input bg-card px-3 py-2 text-[length:var(--text-sm)] text-foreground focus:border-ring focus:outline-none focus:ring-1 focus:ring-ring"
            >
              {MEDICAL_SEVERITIES.map((s) => (
                <option key={s.value} value={s.value}>
                  {s.label}
                </option>
              ))}
            </select>
          </div>
        </div>

        <div>
          <label className="block text-[length:var(--text-xs)] font-medium text-foreground">
            Description
          </label>
          <textarea
            value={description}
            onChange={(e) => setDescription(e.target.value)}
            rows={2}
            placeholder="Additional details about the condition..."
            className="mt-1 block w-full rounded border border-input bg-card px-3 py-2 text-[length:var(--text-sm)] text-foreground placeholder:text-muted-foreground focus:border-ring focus:outline-none focus:ring-1 focus:ring-ring"
          />
        </div>

        <div>
          <label className="block text-[length:var(--text-xs)] font-medium text-foreground">
            Action Plan
          </label>
          <textarea
            value={actionPlan}
            onChange={(e) => setActionPlan(e.target.value)}
            rows={2}
            placeholder="Steps to take if this condition presents..."
            className="mt-1 block w-full rounded border border-input bg-card px-3 py-2 text-[length:var(--text-sm)] text-foreground placeholder:text-muted-foreground focus:border-ring focus:outline-none focus:ring-1 focus:ring-ring"
          />
        </div>

        {/* Medication */}
        <div className="space-y-[var(--density-sm)]">
          <label className="flex items-center gap-2 text-[length:var(--text-sm)] text-foreground">
            <input
              type="checkbox"
              checked={requiresMedication}
              onChange={(e) => setRequiresMedication(e.target.checked)}
              className="h-4 w-4 rounded border-input text-primary focus:ring-ring"
            />
            Requires medication
          </label>

          {requiresMedication && (
            <div className="grid grid-cols-1 gap-[var(--density-md)] sm:grid-cols-2">
              <div>
                <label className="block text-[length:var(--text-xs)] font-medium text-foreground">
                  Medication Name
                </label>
                <input
                  type="text"
                  value={medicationName}
                  onChange={(e) => setMedicationName(e.target.value)}
                  placeholder="e.g. EpiPen, Ventolin"
                  className="mt-1 block w-full rounded border border-input bg-card px-3 py-2 text-[length:var(--text-sm)] text-foreground placeholder:text-muted-foreground focus:border-ring focus:outline-none focus:ring-1 focus:ring-ring"
                />
              </div>
              <div>
                <label className="block text-[length:var(--text-xs)] font-medium text-foreground">
                  Medication Location
                </label>
                <input
                  type="text"
                  value={medicationLocation}
                  onChange={(e) => setMedicationLocation(e.target.value)}
                  placeholder="e.g. Office first aid kit"
                  className="mt-1 block w-full rounded border border-input bg-card px-3 py-2 text-[length:var(--text-sm)] text-foreground placeholder:text-muted-foreground focus:border-ring focus:outline-none focus:ring-1 focus:ring-ring"
                />
              </div>
            </div>
          )}
        </div>

        <div className="w-48">
          <label className="block text-[length:var(--text-xs)] font-medium text-foreground">
            Review Date
          </label>
          <input
            type="date"
            value={expiryDate}
            onChange={(e) => setExpiryDate(e.target.value)}
            className="mt-1 block w-full rounded border border-input bg-card px-3 py-2 text-[length:var(--text-sm)] text-foreground focus:border-ring focus:outline-none focus:ring-1 focus:ring-ring"
          />
          <p className="mt-1 text-[length:var(--text-xs)] text-muted-foreground">When this plan should be reviewed.</p>
        </div>

        <div className="flex gap-2">
          <button
            onClick={() => mode === 'add' ? handleAdd() : handleUpdate(conditionId!)}
            disabled={isPending}
            className="rounded bg-primary px-3 py-1.5 text-[length:var(--text-sm)] font-medium text-primary-foreground hover:bg-primary/90 disabled:opacity-50"
          >
            {isPending ? 'Saving...' : mode === 'add' ? 'Add Condition' : 'Save Changes'}
          </button>
          <button
            onClick={closeForm}
            className="rounded border border-border px-3 py-1.5 text-[length:var(--text-sm)] font-medium text-muted-foreground hover:bg-muted"
          >
            Cancel
          </button>
        </div>
      </div>
    );
  }

  return (
    <section className="rounded-lg border border-border bg-card shadow-[var(--shadow-xs)]">
      <div className="flex items-center justify-between border-b border-border px-[var(--density-card-padding)] py-[var(--density-card-padding)]">
        <h2 className="text-[length:var(--text-lg)] font-medium text-foreground">Medical Conditions</h2>
        {canManage && !showAddForm && !editingId && (
          <button
            onClick={openAdd}
            className="text-[length:var(--text-sm)] font-medium text-primary hover:text-primary/80"
          >
            + Add Condition
          </button>
        )}
      </div>
      <div className="p-[var(--density-card-padding)]">
        {conditions.length === 0 && !showAddForm ? (
          <p className="text-[length:var(--text-sm)] text-muted-foreground">No medical conditions recorded.</p>
        ) : (
          <div className="space-y-[var(--density-sm)]">
            {conditions.map((condition) => {
              if (editingId === condition.id) {
                return (
                  <div key={condition.id}>{renderForm('edit', condition.id)}</div>
                );
              }

              return (
                <div
                  key={condition.id}
                  className="rounded-md border border-border/50 p-3"
                >
                  <div className="flex items-start justify-between">
                    <div className="flex-1">
                      <div className="flex items-center gap-2">
                        <p className="text-[length:var(--text-sm)] font-medium text-foreground">
                          {condition.condition_name}
                        </p>
                        <span
                          className="inline-flex rounded-full border px-2 py-0.5 text-[length:var(--text-xs)] font-medium"
                          style={getSeverityStyle(condition.severity)}
                        >
                          {condition.severity.replace('_', ' ')}
                        </span>
                        <span className="rounded bg-muted px-1.5 py-0.5 text-[length:var(--text-xs)] text-muted-foreground">
                          {condition.condition_type}
                        </span>
                      </div>
                      {condition.description && (
                        <p className="mt-1 text-[length:var(--text-xs)] text-muted-foreground">{condition.description}</p>
                      )}
                      {condition.action_plan && (
                        <p className="mt-1 text-[length:var(--text-xs)] text-muted-foreground">
                          <span className="font-medium text-foreground">Action plan:</span> {condition.action_plan}
                        </p>
                      )}
                      {condition.requires_medication && condition.medication_name && (
                        <p
                          className="mt-1 text-[length:var(--text-xs)]"
                          style={{ color: 'var(--info)' }}
                        >
                          ðŸ’Š {condition.medication_name}
                          {condition.medication_location && (
                            <span className="text-muted-foreground"> - {condition.medication_location}</span>
                          )}
                        </p>
                      )}
                    </div>
                    {canManage && (
                      <div className="flex gap-1">
                        <button
                          onClick={() => openEdit(condition)}
                          className="rounded p-1 text-muted-foreground hover:bg-muted hover:text-foreground"
                          title="Edit"
                        >
                          <svg className="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                          </svg>
                        </button>
                        <button
                          onClick={() => handleDelete(condition.id, condition.condition_name)}
                          className="rounded p-1 text-muted-foreground hover:bg-destructive/10 hover:text-destructive"
                          title="Delete"
                        >
                          <svg className="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                          </svg>
                        </button>
                      </div>
                    )}
                  </div>
                </div>
              );
            })}
          </div>
        )}

        {showAddForm && renderForm('add')}
      </div>
    </section>
  );
}


===== D:\.code\wattleos\src\components\domain\sis\StudentForm.tsx =====

// src/components/domain/sis/StudentForm.tsx
//
// ============================================================
// WattleOS V2 â€” Student Create/Edit Form (DESIGN SYSTEM MIGRATED)
// ============================================================
// MIGRATION CHANGES:
// â€¢ Error banner: bg-red-50 text-red-700
//   â†’ bg-destructive/10 text-destructive
// â€¢ Cards: border-gray-200 bg-white p-6
//   â†’ border-border bg-card p-[var(--density-card-padding)]
// â€¢ Section headings: text-lg text-gray-900
//   â†’ text-[length:var(--text-lg)] text-foreground
// â€¢ Labels: text-sm text-gray-700
//   â†’ text-[length:var(--text-sm)] text-foreground
// â€¢ Required asterisk: text-red-500 â†’ text-destructive
// â€¢ Hint text: text-xs text-gray-500
//   â†’ text-[length:var(--text-xs)] text-muted-foreground
// â€¢ All inputs: border-gray-300 px-4 py-2.5 text-sm
//     placeholder:text-gray-400 focus:border-ring focus:ring-ring
//   â†’ border-input bg-card px-4 py-2.5 text-[length:var(--text-sm)]
//     text-foreground placeholder:text-muted-foreground
//     focus:border-ring focus:ring-ring
// â€¢ Disabled input: disabled:bg-gray-50 disabled:text-gray-500
//   â†’ disabled:bg-[var(--input-disabled-bg)] disabled:text-[var(--input-disabled-fg)]
// â€¢ Primary btn: bg-amber-600 hover:bg-amber-700 text-white
//     focus:ring-ring
//   â†’ bg-primary hover:bg-primary/90 text-primary-foreground
//     focus:ring-ring
// â€¢ Cancel link: border-gray-300 bg-white text-gray-700
//     hover:bg-gray-50 focus:ring-ring
//   â†’ border-border bg-card text-foreground
//     hover:bg-muted focus:ring-ring
// â€¢ Section spacing: space-y-8 â†’ space-y-[var(--density-section-gap)]
// â€¢ Grid gaps: gap-6 â†’ gap-[var(--density-md)]
// â€¢ Section margin: mb-4 â†’ mb-[var(--density-md)]
// â€¢ Shadow: shadow-sm â†’ shadow-[var(--shadow-xs)]
// ============================================================

"use client";

import type {
  CreateStudentInput,
  UpdateStudentInput,
} from "@/lib/actions/students";
import { createStudent, updateStudent } from "@/lib/actions/students";
import { ENROLLMENT_STATUSES } from "@/lib/constants";
import type { EnrollmentStatus, Student } from "@/types/domain";
import Link from "next/link";
import { useRouter } from "next/navigation";
import { useState } from "react";

// â”€â”€ Props â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

interface StudentFormProps {
  /** When provided, form operates in edit mode */
  initialData?: Student;
  /** Whether the current user can manage enrollment status */
  canManageEnrollment?: boolean;
}

// â”€â”€ Gender options â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

const GENDER_OPTIONS = [
  { value: "", label: "Not specified" },
  { value: "male", label: "Male" },
  { value: "female", label: "Female" },
  { value: "non_binary", label: "Non-binary" },
  { value: "other", label: "Other" },
  { value: "prefer_not_to_say", label: "Prefer not to say" },
] as const;

// â”€â”€ Shared input class â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Extracted to a constant so every field is guaranteed identical.
// Changing one token here changes every input in the form.

const INPUT_CLASS =
  "mt-1 block w-full rounded-lg border border-input bg-card px-4 py-2.5 text-[length:var(--text-sm)] text-foreground placeholder:text-muted-foreground focus:border-ring focus:outline-none focus:ring-1 focus:ring-ring";

const SELECT_CLASS =
  "mt-1 block w-full rounded-lg border border-input bg-card px-4 py-2.5 text-[length:var(--text-sm)] text-foreground focus:border-ring focus:outline-none focus:ring-1 focus:ring-ring";

// â”€â”€ Component â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

export function StudentForm({
  initialData,
  canManageEnrollment = true,
}: StudentFormProps) {
  const router = useRouter();
  const isEditing = !!initialData;

  // â”€â”€ Form state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const [firstName, setFirstName] = useState(initialData?.first_name ?? "");
  const [lastName, setLastName] = useState(initialData?.last_name ?? "");
  const [preferredName, setPreferredName] = useState(
    initialData?.preferred_name ?? "",
  );
  const [dob, setDob] = useState(initialData?.dob ?? "");
  const [gender, setGender] = useState(initialData?.gender ?? "");
  const [enrollmentStatus, setEnrollmentStatus] = useState<EnrollmentStatus>(
    initialData?.enrollment_status ?? "active",
  );
  const [notes, setNotes] = useState(initialData?.notes ?? "");

  // â”€â”€ Submission state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const [isSaving, setIsSaving] = useState(false);
  const [error, setError] = useState<string | null>(null);

  // â”€â”€ Handlers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  async function handleSubmit(e: React.FormEvent) {
    e.preventDefault();
    setIsSaving(true);
    setError(null);

    if (isEditing && initialData) {
      // â”€â”€ Update existing student â”€â”€
      const input: UpdateStudentInput = {
        first_name: firstName.trim(),
        last_name: lastName.trim(),
        preferred_name: preferredName.trim() || null,
        dob: dob || null,
        gender: gender || null,
        enrollment_status: enrollmentStatus,
        notes: notes.trim() || null,
      };

      const result = await updateStudent(initialData.id, input);

      if (result.error) {
        setError(result.error.message);
        setIsSaving(false);
        return;
      }

      router.push(`/students/${initialData.id}`);
      router.refresh();
    } else {
      // â”€â”€ Create new student â”€â”€
      const input: CreateStudentInput = {
        first_name: firstName.trim(),
        last_name: lastName.trim(),
        preferred_name: preferredName.trim() || null,
        dob: dob || null,
        gender: gender || null,
        enrollment_status: enrollmentStatus,
        notes: notes.trim() || null,
      };

      const result = await createStudent(input);

      if (result.error) {
        setError(result.error.message);
        setIsSaving(false);
        return;
      }

      // Redirect to the newly created student's detail page
      router.push(`/students/${result.data!.id}`);
      router.refresh();
    }
  }

  return (
    <form
      onSubmit={handleSubmit}
      className="space-y-[var(--density-section-gap)]"
    >
      {/* Error banner */}
      {error && (
        <div className="rounded-md bg-destructive/10 p-4">
          <p className="text-[length:var(--text-sm)] text-destructive">
            {error}
          </p>
        </div>
      )}

      {/* â”€â”€ Section: Basic Information â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */}
      <div className="rounded-lg border border-border bg-card p-[var(--density-card-padding)]">
        <h2 className="mb-[var(--density-md)] text-[length:var(--text-lg)] font-semibold text-foreground">
          Basic Information
        </h2>

        <div className="grid grid-cols-1 gap-[var(--density-md)] sm:grid-cols-2">
          {/* First name */}
          <div>
            <label
              htmlFor="firstName"
              className="block text-[length:var(--text-sm)] font-medium text-foreground"
            >
              First Name <span className="text-destructive">*</span>
            </label>
            <input
              id="firstName"
              type="text"
              required
              value={firstName}
              onChange={(e) => setFirstName(e.target.value)}
              placeholder="e.g. Charlotte"
              className={INPUT_CLASS}
            />
          </div>

          {/* Last name */}
          <div>
            <label
              htmlFor="lastName"
              className="block text-[length:var(--text-sm)] font-medium text-foreground"
            >
              Last Name <span className="text-destructive">*</span>
            </label>
            <input
              id="lastName"
              type="text"
              required
              value={lastName}
              onChange={(e) => setLastName(e.target.value)}
              placeholder="e.g. Mason"
              className={INPUT_CLASS}
            />
          </div>

          {/* Preferred name */}
          <div>
            <label
              htmlFor="preferredName"
              className="block text-[length:var(--text-sm)] font-medium text-foreground"
            >
              Preferred Name
            </label>
            <input
              id="preferredName"
              type="text"
              value={preferredName}
              onChange={(e) => setPreferredName(e.target.value)}
              placeholder="e.g. Charlie"
              className={INPUT_CLASS}
            />
            <p className="mt-1 text-[length:var(--text-xs)] text-muted-foreground">
              The name the child goes by day-to-day, if different from their
              first name.
            </p>
          </div>

          {/* Date of birth */}
          <div>
            <label
              htmlFor="dob"
              className="block text-[length:var(--text-sm)] font-medium text-foreground"
            >
              Date of Birth
            </label>
            <input
              id="dob"
              type="date"
              value={dob}
              onChange={(e) => setDob(e.target.value)}
              max={new Date().toISOString().split("T")[0]}
              className={INPUT_CLASS}
            />
          </div>

          {/* Gender */}
          <div>
            <label
              htmlFor="gender"
              className="block text-[length:var(--text-sm)] font-medium text-foreground"
            >
              Gender
            </label>
            <select
              id="gender"
              value={gender}
              onChange={(e) => setGender(e.target.value)}
              className={SELECT_CLASS}
            >
              {GENDER_OPTIONS.map((opt) => (
                <option key={opt.value} value={opt.value}>
                  {opt.label}
                </option>
              ))}
            </select>
          </div>

          {/* Enrollment status */}
          <div>
            <label
              htmlFor="enrollmentStatus"
              className="block text-[length:var(--text-sm)] font-medium text-foreground"
            >
              Enrollment Status
            </label>
            <select
              id="enrollmentStatus"
              value={enrollmentStatus}
              onChange={(e) =>
                setEnrollmentStatus(e.target.value as EnrollmentStatus)
              }
              disabled={!canManageEnrollment}
              className={`${SELECT_CLASS} disabled:cursor-not-allowed disabled:bg-[var(--input-disabled-bg)] disabled:text-[var(--input-disabled-fg)]`}
            >
              {ENROLLMENT_STATUSES.map((opt) => (
                <option key={opt.value} value={opt.value}>
                  {opt.label}
                </option>
              ))}
            </select>
            {!canManageEnrollment && (
              <p className="mt-1 text-[length:var(--text-xs)] text-muted-foreground">
                You don&apos;t have permission to change enrollment status.
              </p>
            )}
          </div>
        </div>
      </div>

      {/* â”€â”€ Section: Notes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */}
      <div className="rounded-lg border border-border bg-card p-[var(--density-card-padding)]">
        <h2 className="mb-[var(--density-md)] text-[length:var(--text-lg)] font-semibold text-foreground">
          Notes
        </h2>
        <textarea
          id="notes"
          value={notes}
          onChange={(e) => setNotes(e.target.value)}
          rows={4}
          placeholder="Any additional notes about this student (dietary requirements, learning preferences, etc.)"
          className="block w-full rounded-lg border border-input bg-card px-4 py-3 text-[length:var(--text-sm)] text-foreground placeholder:text-muted-foreground focus:border-ring focus:outline-none focus:ring-1 focus:ring-ring"
        />
      </div>

      {/* â”€â”€ Actions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */}
      <div className="flex items-center justify-end gap-3">
        <Link
          href={isEditing ? `/students/${initialData!.id}` : "/students"}
          className="rounded-lg border border-border bg-card px-4 py-2.5 text-[length:var(--text-sm)] font-medium text-foreground shadow-[var(--shadow-xs)] hover:bg-muted focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2"
        >
          Cancel
        </Link>
        <button
          type="submit"
          disabled={isSaving || !firstName.trim() || !lastName.trim()}
          className="rounded-lg bg-primary px-6 py-2.5 text-[length:var(--text-sm)] font-medium text-primary-foreground shadow-[var(--shadow-xs)] hover:bg-primary/90 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50"
        >
          {isSaving
            ? isEditing
              ? "Saving..."
              : "Creating..."
            : isEditing
              ? "Save Changes"
              : "Create Student"}
        </button>
      </div>
    </form>
  );
}



===== D:\.code\wattleos\src\components\domain\students\StudentSearchBar.tsx =====

// src/components/domain/sis/StudentSearchBar.tsx
//
// ============================================================
// WattleOS V2 â€” Student Search Bar (DESIGN SYSTEM MIGRATED)
// ============================================================
// MIGRATION CHANGES:
// â€¢ text-gray-400 (icon) â†’ text-muted-foreground
// â€¢ border-gray-300 bg-white â†’ border-input bg-card
// â€¢ placeholder-gray-400 â†’ placeholder:text-muted-foreground
// â€¢ text-sm â†’ text-[length:var(--text-sm)]
// â€¢ focus:border-indigo-500 focus:ring-indigo-500
//   â†’ focus:border-ring focus:ring-ring
//   WHY: indigo was an inconsistency â€” rest of app used amber.
//   Now both resolve to --ring which follows the brand color.
// â€¢ shadow-sm â†’ shadow-[var(--shadow-xs)]
// ============================================================

'use client';

import { useRouter, useSearchParams } from 'next/navigation';
import { useCallback, useRef, useEffect, useState } from 'react';

interface StudentSearchBarProps {
  defaultValue: string;
}

export function StudentSearchBar({ defaultValue }: StudentSearchBarProps) {
  const router = useRouter();
  const searchParams = useSearchParams();
  const [value, setValue] = useState(defaultValue);
  const timeoutRef = useRef<ReturnType<typeof setTimeout> | null>(null);

  // Debounced search: updates URL after 300ms of no typing
  const handleSearch = useCallback(
    (term: string) => {
      if (timeoutRef.current) {
        clearTimeout(timeoutRef.current);
      }

      timeoutRef.current = setTimeout(() => {
        const params = new URLSearchParams(searchParams.toString());
        if (term.trim()) {
          params.set('search', term.trim());
        } else {
          params.delete('search');
        }
        // Reset to page 1 on new search
        params.delete('page');
        const qs = params.toString();
        router.push(`/students${qs ? `?${qs}` : ''}`);
      }, 300);
    },
    [router, searchParams]
  );

  // Cleanup timeout on unmount
  useEffect(() => {
    return () => {
      if (timeoutRef.current) {
        clearTimeout(timeoutRef.current);
      }
    };
  }, []);

  return (
    <div className="relative flex-1 sm:max-w-xs">
      <div className="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3">
        <svg
          className="h-4 w-4 text-muted-foreground"
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 20 20"
          fill="currentColor"
        >
          <path
            fillRule="evenodd"
            d="M9 3.5a5.5 5.5 0 100 11 5.5 5.5 0 000-11zM2 9a7 7 0 1112.452 4.391l3.328 3.329a.75.75 0 11-1.06 1.06l-3.329-3.328A7 7 0 012 9z"
            clipRule="evenodd"
          />
        </svg>
      </div>
      <input
        type="text"
        placeholder="Search students..."
        value={value}
        onChange={(e) => {
          setValue(e.target.value);
          handleSearch(e.target.value);
        }}
        className="block w-full rounded-md border border-input bg-card py-2 pl-10 pr-3 text-[length:var(--text-sm)] text-foreground placeholder:text-muted-foreground shadow-[var(--shadow-xs)] focus:border-ring focus:outline-none focus:ring-1 focus:ring-ring"
      />
    </div>
  );
}


===== D:\.code\wattleos\src\components\domain\timesheets\employee-mapping-client.tsx =====

// src/components/domain/timesheets/employee-mapping-client.tsx
//
// ============================================================
// WattleOS V2 - Employee Mapping Client Component
// ============================================================
// Interactive management of user â†” external employee ID
// mappings. Shows two states:
//   â€¢ Mapped staff (with external ID, edit/deactivate)
//   â€¢ Unmapped staff (with "Link" action)
//
// WHY 'use client': Add/edit/deactivate are mutations requiring
// form state and optimistic UI updates.
// ============================================================

"use client";

import {
  createEmployeeMapping,
  removeEmployeeMapping,
  updateEmployeeMapping,
} from "@/lib/actions/payroll-integration";
import type { EmployeeMapping, PayrollProvider } from "@/types/domain";
import { useRouter } from "next/navigation";
import { useState, useTransition } from "react";

// ============================================================
// Props
// ============================================================

interface EmployeeMappingClientProps {
  mappings: Array<EmployeeMapping & { user_name: string; user_email: string }>;
  staff: Array<{
    id: string;
    first_name: string;
    last_name: string;
    email: string;
  }>;
  provider: PayrollProvider | null;
}

// ============================================================
// Component
// ============================================================

export function EmployeeMappingClient({
  mappings,
  staff,
  provider,
}: EmployeeMappingClientProps) {
  const router = useRouter();
  const [isPending, startTransition] = useTransition();

  // Add form state
  const [addingUserId, setAddingUserId] = useState<string | null>(null);
  const [externalId, setExternalId] = useState("");
  const [externalName, setExternalName] = useState("");

  // Edit state
  const [editingId, setEditingId] = useState<string | null>(null);
  const [editExternalId, setEditExternalId] = useState("");
  const [editExternalName, setEditExternalName] = useState("");

  // Feedback
  const [message, setMessage] = useState<{
    type: "success" | "error";
    text: string;
  } | null>(null);

  // â”€â”€ Mapped user IDs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const mappedUserIds = new Set(
    mappings.filter((m) => m.is_active).map((m) => m.user_id),
  );
  const unmappedStaff = staff.filter((s) => !mappedUserIds.has(s.id));
  const activeMappings = mappings.filter((m) => m.is_active);
  const inactiveMappings = mappings.filter((m) => !m.is_active);

  // â”€â”€ Create mapping â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const handleCreate = async () => {
    if (!addingUserId || !externalId.trim() || !provider) return;
    setMessage(null);

    const result = await createEmployeeMapping({
      userId: addingUserId,
      provider,
      externalId: externalId.trim(),
      externalName: externalName.trim() || undefined,
    });

    if (result.error) {
      setMessage({ type: "error", text: result.error.message });
    } else {
      setMessage({ type: "success", text: "Employee linked." });
      setAddingUserId(null);
      setExternalId("");
      setExternalName("");
      startTransition(() => router.refresh());
    }
  };

  // â”€â”€ Update mapping â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const handleUpdate = async (mappingId: string) => {
    setMessage(null);

    const result = await updateEmployeeMapping(mappingId, {
      externalId: editExternalId.trim() || undefined,
      externalName: editExternalName.trim() || undefined,
    });

    if (result.error) {
      setMessage({ type: "error", text: result.error.message });
    } else {
      setMessage({ type: "success", text: "Mapping updated." });
      setEditingId(null);
      startTransition(() => router.refresh());
    }
  };

  // â”€â”€ Deactivate mapping â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const handleDeactivate = async (mappingId: string) => {
    if (
      !confirm(
        "Deactivate this mapping? The staff member will no longer sync to payroll.",
      )
    ) {
      return;
    }
    setMessage(null);

    const result = await removeEmployeeMapping(mappingId);
    if (result.error) {
      setMessage({ type: "error", text: result.error.message });
    } else {
      setMessage({ type: "success", text: "Mapping deactivated." });
      startTransition(() => router.refresh());
    }
  };

  // â”€â”€ Reactivate mapping â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const handleReactivate = async (mappingId: string) => {
    setMessage(null);
    const result = await updateEmployeeMapping(mappingId, { isActive: true });
    if (result.error) {
      setMessage({ type: "error", text: result.error.message });
    } else {
      setMessage({ type: "success", text: "Mapping reactivated." });
      startTransition(() => router.refresh());
    }
  };

  const providerLabel =
    provider === "xero" ? "Xero" : provider === "keypay" ? "KeyPay" : "Payroll";

  return (
    <div className="space-y-8">
      {/* Feedback */}
      {message && (
        <div
          className={`rounded-lg border px-4 py-3 text-sm ${
            message.type === "success"
              ? "border-green-200 bg-green-50 text-green-800"
              : "border-red-200 bg-red-50 text-red-800"
          }`}
        >
          {message.text}
        </div>
      )}

      {/* Active Mappings */}
      <section>
        <h2 className="text-sm font-semibold text-gray-900">
          Linked Staff ({activeMappings.length})
        </h2>
        <p className="mt-1 text-xs text-gray-500">
          These staff members are connected to {providerLabel} for payroll sync.
        </p>

        {activeMappings.length === 0 ? (
          <div className="mt-4 rounded-lg border border-gray-200 bg-gray-50 p-6 text-center text-sm text-gray-500">
            No staff linked yet. Use the section below to map staff to their{" "}
            {providerLabel} employee IDs.
          </div>
        ) : (
          <div className="mt-4 space-y-2">
            {activeMappings.map((mapping) => {
              const isEditing = editingId === mapping.id;

              return (
                <div
                  key={mapping.id}
                  className="flex items-center justify-between rounded-lg border border-gray-200 bg-white px-4 py-3"
                >
                  {isEditing ? (
                    <div className="flex flex-1 items-center gap-3">
                      <div className="flex h-8 w-8 items-center justify-center rounded-full bg-green-100 text-xs font-medium text-green-700">
                        {mapping.user_name
                          .split(" ")
                          .map((n) => n[0])
                          .join("")}
                      </div>
                      <div className="text-sm font-medium text-gray-900">
                        {mapping.user_name}
                      </div>
                      <input
                        type="text"
                        value={editExternalId}
                        onChange={(e) => setEditExternalId(e.target.value)}
                        placeholder="External ID"
                        className="w-40 rounded border border-gray-300 px-2 py-1 text-sm focus:border-ring focus:outline-none"
                      />
                      <input
                        type="text"
                        value={editExternalName}
                        onChange={(e) => setEditExternalName(e.target.value)}
                        placeholder="External name (optional)"
                        className="w-48 rounded border border-gray-300 px-2 py-1 text-sm focus:border-ring focus:outline-none"
                      />
                      <button
                        onClick={() => handleUpdate(mapping.id)}
                        disabled={isPending}
                        className="rounded bg-amber-600 px-3 py-1 text-xs font-medium text-white hover:bg-amber-700 disabled:opacity-50"
                      >
                        Save
                      </button>
                      <button
                        onClick={() => setEditingId(null)}
                        className="text-xs text-gray-500 hover:text-gray-700"
                      >
                        Cancel
                      </button>
                    </div>
                  ) : (
                    <>
                      <div className="flex items-center gap-3">
                        <div className="flex h-8 w-8 items-center justify-center rounded-full bg-green-100 text-xs font-medium text-green-700">
                          {mapping.user_name
                            .split(" ")
                            .map((n) => n[0])
                            .join("")}
                        </div>
                        <div>
                          <p className="text-sm font-medium text-gray-900">
                            {mapping.user_name}
                          </p>
                          <p className="text-xs text-gray-500">
                            {mapping.user_email}
                          </p>
                        </div>
                      </div>

                      <div className="flex items-center gap-4">
                        <div className="text-right">
                          <p className="text-sm font-mono text-gray-700">
                            {mapping.external_id}
                          </p>
                          {mapping.external_name && (
                            <p className="text-xs text-gray-400">
                              {mapping.external_name}
                            </p>
                          )}
                        </div>

                        <div className="flex items-center gap-2">
                          <button
                            onClick={() => {
                              setEditingId(mapping.id);
                              setEditExternalId(mapping.external_id);
                              setEditExternalName(mapping.external_name ?? "");
                            }}
                            className="text-xs text-gray-500 hover:text-gray-700"
                          >
                            Edit
                          </button>
                          <button
                            onClick={() => handleDeactivate(mapping.id)}
                            disabled={isPending}
                            className="text-xs text-red-500 hover:text-red-700"
                          >
                            Remove
                          </button>
                        </div>
                      </div>
                    </>
                  )}
                </div>
              );
            })}
          </div>
        )}
      </section>

      {/* Unmapped Staff */}
      {provider && unmappedStaff.length > 0 && (
        <section>
          <h2 className="text-sm font-semibold text-gray-900">
            Unmapped Staff ({unmappedStaff.length})
          </h2>
          <p className="mt-1 text-xs text-gray-500">
            These staff members have not been linked to a {providerLabel}{" "}
            employee record.
          </p>

          <div className="mt-4 space-y-2">
            {unmappedStaff.map((user) => {
              const isAdding = addingUserId === user.id;

              return (
                <div
                  key={user.id}
                  className="flex items-center justify-between rounded-lg border border-dashed border-gray-300 bg-gray-50/50 px-4 py-3"
                >
                  <div className="flex items-center gap-3">
                    <div className="flex h-8 w-8 items-center justify-center rounded-full bg-gray-200 text-xs font-medium text-gray-600">
                      {user.first_name?.[0] ?? ""}
                      {user.last_name?.[0] ?? ""}
                    </div>
                    <div>
                      <p className="text-sm font-medium text-gray-900">
                        {user.first_name} {user.last_name}
                      </p>
                      <p className="text-xs text-gray-500">{user.email}</p>
                    </div>
                  </div>

                  {isAdding ? (
                    <div className="flex items-center gap-2">
                      <input
                        type="text"
                        value={externalId}
                        onChange={(e) => setExternalId(e.target.value)}
                        placeholder={`${providerLabel} Employee ID`}
                        className="w-40 rounded border border-gray-300 px-2 py-1 text-sm focus:border-ring focus:outline-none"
                        autoFocus
                      />
                      <input
                        type="text"
                        value={externalName}
                        onChange={(e) => setExternalName(e.target.value)}
                        placeholder="Name in payroll (optional)"
                        className="w-48 rounded border border-gray-300 px-2 py-1 text-sm focus:border-ring focus:outline-none"
                      />
                      <button
                        onClick={handleCreate}
                        disabled={isPending || !externalId.trim()}
                        className="rounded bg-amber-600 px-3 py-1 text-xs font-medium text-white hover:bg-amber-700 disabled:opacity-50"
                      >
                        Link
                      </button>
                      <button
                        onClick={() => {
                          setAddingUserId(null);
                          setExternalId("");
                          setExternalName("");
                        }}
                        className="text-xs text-gray-500 hover:text-gray-700"
                      >
                        Cancel
                      </button>
                    </div>
                  ) : (
                    <button
                      onClick={() => setAddingUserId(user.id)}
                      className="rounded-lg border border-amber-300 px-3 py-1.5 text-xs font-medium text-amber-700 transition-colors hover:bg-amber-50"
                    >
                      Link to {providerLabel}
                    </button>
                  )}
                </div>
              );
            })}
          </div>
        </section>
      )}

      {/* Inactive Mappings */}
      {inactiveMappings.length > 0 && (
        <section>
          <h2 className="text-sm font-semibold text-gray-500">
            Inactive Mappings ({inactiveMappings.length})
          </h2>

          <div className="mt-3 space-y-2">
            {inactiveMappings.map((mapping) => (
              <div
                key={mapping.id}
                className="flex items-center justify-between rounded-lg border border-gray-200 bg-gray-50 px-4 py-3 opacity-60"
              >
                <div className="flex items-center gap-3">
                  <div className="flex h-8 w-8 items-center justify-center rounded-full bg-gray-200 text-xs font-medium text-gray-500">
                    {mapping.user_name
                      .split(" ")
                      .map((n) => n[0])
                      .join("")}
                  </div>
                  <div>
                    <p className="text-sm font-medium text-gray-600">
                      {mapping.user_name}
                    </p>
                    <p className="text-xs text-gray-400">
                      {mapping.external_id}
                    </p>
                  </div>
                </div>
                <button
                  onClick={() => handleReactivate(mapping.id)}
                  disabled={isPending}
                  className="text-xs text-amber-600 hover:text-amber-700"
                >
                  Reactivate
                </button>
              </div>
            ))}
          </div>
        </section>
      )}
    </div>
  );
}



===== D:\.code\wattleos\src\components\domain\timesheets\pay-period-management-client.tsx =====

// src/components/domain/timesheets/pay-period-management-client.tsx
//
// ============================================================
// WattleOS V2 - Pay Period Management Client
// ============================================================
// Interactive list of pay periods with create, lock, and
// status management. Uses inline create form for quick period
// creation based on tenant's configured pay frequency.
//
// WHY 'use client': Period creation and lock are mutations
// requiring form state and optimistic feedback.
// ============================================================

"use client";

import {
  createPayPeriod,
  lockPayPeriod,
  markPayPeriodProcessed,
} from "@/lib/actions/pay-periods";
import { bulkSyncTimesheets } from "@/lib/actions/payroll-integration";
import {
  PAY_FREQUENCY_OPTIONS,
  PAY_PERIOD_STATUS_CONFIG,
} from "@/lib/constants/timesheets";
import type { PayFrequency, PayPeriod } from "@/types/domain";
import { useRouter } from "next/navigation";
import { useState, useTransition } from "react";

// ============================================================
// Props
// ============================================================

interface PayPeriodManagementClientProps {
  periods: PayPeriod[];
  defaultFrequency: PayFrequency;
  canCreate: boolean;
}

// ============================================================
// Component
// ============================================================

export function PayPeriodManagementClient({
  periods,
  defaultFrequency,
  canCreate,
}: PayPeriodManagementClientProps) {
  const router = useRouter();
  const [isPending, startTransition] = useTransition();

  // Create form state
  const [showCreate, setShowCreate] = useState(false);
  const [createName, setCreateName] = useState("");
  const [createStart, setCreateStart] = useState("");
  const [createEnd, setCreateEnd] = useState("");
  const [createFrequency, setCreateFrequency] =
    useState<PayFrequency>(defaultFrequency);

  // Feedback
  const [message, setMessage] = useState<{
    type: "success" | "error";
    text: string;
  } | null>(null);

  // â”€â”€ Auto-generate period name â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const generateName = (start: string, end: string) => {
    if (!start || !end) return "";
    const s = new Date(start + "T00:00:00");
    const e = new Date(end + "T00:00:00");
    const fmt = (d: Date) =>
      d.toLocaleDateString("en-AU", { day: "numeric", month: "short" });
    return `${fmt(s)} â€“ ${fmt(e)} ${e.getFullYear()}`;
  };

  // â”€â”€ Auto-fill end date based on frequency â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const handleStartChange = (start: string) => {
    setCreateStart(start);
    if (start) {
      const d = new Date(start + "T00:00:00");
      const days =
        createFrequency === "weekly"
          ? 6
          : createFrequency === "fortnightly"
            ? 13
            : 29;
      d.setDate(d.getDate() + days);
      const end = d.toISOString().split("T")[0];
      setCreateEnd(end);
      setCreateName(generateName(start, end));
    }
  };

  // â”€â”€ Create period â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const handleCreate = async () => {
    if (!createName.trim() || !createStart || !createEnd) {
      setMessage({ type: "error", text: "All fields are required." });
      return;
    }

    setMessage(null);
    const result = await createPayPeriod({
      name: createName.trim(),
      startDate: createStart,
      endDate: createEnd,
      frequency: createFrequency,
    });

    if (result.error) {
      setMessage({ type: "error", text: result.error.message });
    } else {
      setMessage({ type: "success", text: "Pay period created." });
      setShowCreate(false);
      setCreateName("");
      setCreateStart("");
      setCreateEnd("");
      startTransition(() => router.refresh());
    }
  };

  // â”€â”€ Lock period â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const handleLock = async (periodId: string) => {
    if (
      !confirm(
        "Lock this period? Staff will no longer be able to add or edit time entries.",
      )
    ) {
      return;
    }
    setMessage(null);
    const result = await lockPayPeriod(periodId);
    if (result.error) {
      setMessage({ type: "error", text: result.error.message });
    } else {
      setMessage({ type: "success", text: "Period locked." });
      startTransition(() => router.refresh());
    }
  };

  // â”€â”€ Sync all approved timesheets â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const handleSyncAll = async (periodId: string) => {
    setMessage(null);
    const result = await bulkSyncTimesheets(periodId);
    if (result.error) {
      setMessage({ type: "error", text: result.error.message });
    } else if (result.data) {
      const { synced, failed } = result.data;
      if (failed > 0) {
        setMessage({
          type: "error",
          text: `Synced ${synced}, failed ${failed}. Check individual timesheets.`,
        });
      } else {
        setMessage({
          type: "success",
          text: `${synced} timesheet(s) synced to payroll.`,
        });
      }
      startTransition(() => router.refresh());
    }
  };

  // â”€â”€ Mark as processed â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const handleMarkProcessed = async (periodId: string) => {
    setMessage(null);
    const result = await markPayPeriodProcessed(periodId);
    if (result.error) {
      setMessage({ type: "error", text: result.error.message });
    } else {
      setMessage({ type: "success", text: "Period marked as processed." });
      startTransition(() => router.refresh());
    }
  };

  // â”€â”€ Date formatting â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const formatDateRange = (start: string, end: string) => {
    const s = new Date(start + "T00:00:00");
    const e = new Date(end + "T00:00:00");
    const fmt = (d: Date) =>
      d.toLocaleDateString("en-AU", {
        day: "numeric",
        month: "short",
        year: "numeric",
      });
    return `${fmt(s)} â€“ ${fmt(e)}`;
  };

  return (
    <div className="space-y-6">
      {/* Feedback */}
      {message && (
        <div
          className={`rounded-lg border px-4 py-3 text-sm ${
            message.type === "success"
              ? "border-green-200 bg-green-50 text-green-800"
              : "border-red-200 bg-red-50 text-red-800"
          }`}
        >
          {message.text}
        </div>
      )}

      {/* Create button / form */}
      {canCreate && !showCreate && (
        <button
          onClick={() => setShowCreate(true)}
          className="inline-flex items-center gap-2 rounded-lg bg-amber-600 px-4 py-2.5 text-sm font-medium text-white shadow-sm transition-colors hover:bg-amber-700"
        >
          <svg
            className="h-4 w-4"
            fill="none"
            viewBox="0 0 24 24"
            strokeWidth={1.5}
            stroke="currentColor"
          >
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              d="M12 4.5v15m7.5-7.5h-15"
            />
          </svg>
          New Pay Period
        </button>
      )}

      {showCreate && (
        <div className="rounded-lg border border-amber-200 bg-amber-50/50 p-5">
          <h3 className="text-sm font-semibold text-gray-900">
            Create Pay Period
          </h3>
          <div className="mt-4 grid grid-cols-1 gap-4 sm:grid-cols-2">
            <div>
              <label className="block text-xs font-medium text-gray-700">
                Frequency
              </label>
              <select
                value={createFrequency}
                onChange={(e) =>
                  setCreateFrequency(e.target.value as PayFrequency)
                }
                className="mt-1 w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-ring focus:outline-none focus:ring-1 focus:ring-ring"
              >
                {PAY_FREQUENCY_OPTIONS.map((opt) => (
                  <option key={opt.value} value={opt.value}>
                    {opt.label}
                  </option>
                ))}
              </select>
            </div>
            <div>
              <label className="block text-xs font-medium text-gray-700">
                Period Name
              </label>
              <input
                type="text"
                value={createName}
                onChange={(e) => setCreateName(e.target.value)}
                placeholder="e.g. Week 7 - 17 Feb to 23 Feb 2026"
                className="mt-1 w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-ring focus:outline-none focus:ring-1 focus:ring-ring"
              />
            </div>
            <div>
              <label className="block text-xs font-medium text-gray-700">
                Start Date
              </label>
              <input
                type="date"
                value={createStart}
                onChange={(e) => handleStartChange(e.target.value)}
                className="mt-1 w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-ring focus:outline-none focus:ring-1 focus:ring-ring"
              />
            </div>
            <div>
              <label className="block text-xs font-medium text-gray-700">
                End Date
              </label>
              <input
                type="date"
                value={createEnd}
                onChange={(e) => {
                  setCreateEnd(e.target.value);
                  setCreateName(generateName(createStart, e.target.value));
                }}
                className="mt-1 w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-ring focus:outline-none focus:ring-1 focus:ring-ring"
              />
            </div>
          </div>
          <div className="mt-4 flex justify-end gap-3">
            <button
              onClick={() => {
                setShowCreate(false);
                setCreateName("");
                setCreateStart("");
                setCreateEnd("");
              }}
              className="rounded-lg border border-gray-300 px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50"
            >
              Cancel
            </button>
            <button
              onClick={handleCreate}
              disabled={
                isPending || !createName.trim() || !createStart || !createEnd
              }
              className="rounded-lg bg-amber-600 px-4 py-2 text-sm font-medium text-white hover:bg-amber-700 disabled:opacity-50"
            >
              Create Period
            </button>
          </div>
        </div>
      )}

      {/* Periods list */}
      {periods.length === 0 ? (
        <div className="rounded-lg border border-gray-200 bg-white p-12 text-center">
          <svg
            className="mx-auto h-12 w-12 text-gray-300"
            fill="none"
            viewBox="0 0 24 24"
            strokeWidth={1}
            stroke="currentColor"
          >
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 0 1 2.25-2.25h13.5A2.25 2.25 0 0 1 21 7.5v11.25m-18 0A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75m-18 0v-7.5A2.25 2.25 0 0 1 5.25 9h13.5A2.25 2.25 0 0 1 21 11.25v7.5"
            />
          </svg>
          <p className="mt-4 text-sm font-medium text-gray-900">
            No pay periods yet
          </p>
          <p className="mt-1 text-sm text-gray-500">
            Create your first pay period to start accepting timesheets.
          </p>
        </div>
      ) : (
        <div className="space-y-3">
          {periods.map((period) => {
            const statusConfig = PAY_PERIOD_STATUS_CONFIG[period.status];

            return (
              <div
                key={period.id}
                className="flex items-center justify-between rounded-lg border border-gray-200 bg-white px-5 py-4 shadow-sm"
              >
                <div className="flex items-center gap-4">
                  {/* Status dot */}
                  <div
                    className={`h-2.5 w-2.5 rounded-full ${statusConfig.dotColor}`}
                  />

                  <div>
                    <p className="text-sm font-medium text-gray-900">
                      {period.name}
                    </p>
                    <p className="text-xs text-gray-500">
                      {formatDateRange(period.start_date, period.end_date)}
                      {" Â· "}
                      <span className="capitalize">{period.frequency}</span>
                    </p>
                  </div>
                </div>

                <div className="flex items-center gap-3">
                  {/* Status badge */}
                  <span
                    className={`rounded-full px-2.5 py-0.5 text-xs font-medium ${statusConfig.bgColor} ${statusConfig.color}`}
                  >
                    {statusConfig.label}
                  </span>

                  {/* Actions based on status */}
                  {period.status === "open" && (
                    <button
                      onClick={() => handleLock(period.id)}
                      disabled={isPending}
                      className="rounded-lg border border-amber-300 px-3 py-1.5 text-xs font-medium text-amber-700 transition-colors hover:bg-amber-50 disabled:opacity-50"
                    >
                      Lock Period
                    </button>
                  )}

                  {period.status === "locked" && canCreate && (
                    <div className="flex items-center gap-2">
                      <button
                        onClick={() => handleSyncAll(period.id)}
                        disabled={isPending}
                        className="rounded-lg bg-blue-600 px-3 py-1.5 text-xs font-medium text-white transition-colors hover:bg-blue-700 disabled:opacity-50"
                      >
                        Sync All
                      </button>
                      <button
                        onClick={() => handleMarkProcessed(period.id)}
                        disabled={isPending}
                        className="rounded-lg border border-gray-300 px-3 py-1.5 text-xs font-medium text-gray-700 transition-colors hover:bg-gray-50 disabled:opacity-50"
                      >
                        Mark Processed
                      </button>
                    </div>
                  )}
                </div>
              </div>
            );
          })}
        </div>
      )}
    </div>
  );
}



===== D:\.code\wattleos\src\components\domain\timesheets\payroll-settings-client.tsx =====

// src/components/domain/timesheets/payroll-settings-client.tsx
//
// ============================================================
// WattleOS V2 - Payroll Settings Form Client
// ============================================================
// Interactive form for configuring payroll:
//   â€¢ Pay frequency + cycle start day
//   â€¢ Default work hours (pre-filled in timesheet grid)
//   â€¢ Payroll provider selection (Xero/KeyPay/None)
//   â€¢ Auto-create periods toggle
//
// WHY 'use client': Form state management + server action
// mutation for saving settings.
// ============================================================

"use client";

import { updatePayrollSettings } from "@/lib/actions/payroll-integration";
import { PAY_FREQUENCY_OPTIONS } from "@/lib/constants/timesheets";
import type {
  PayFrequency,
  PayrollProvider,
  PayrollSettings,
} from "@/types/domain";
import { useRouter } from "next/navigation";
import { useState, useTransition } from "react";

// ============================================================
// Props
// ============================================================

interface PayrollSettingsClientProps {
  settings: PayrollSettings;
}

// ============================================================
// Day options
// ============================================================

const DAY_OPTIONS = [
  { value: 1, label: "Monday" },
  { value: 2, label: "Tuesday" },
  { value: 3, label: "Wednesday" },
  { value: 4, label: "Thursday" },
  { value: 5, label: "Friday" },
  { value: 6, label: "Saturday" },
  { value: 7, label: "Sunday" },
];

// ============================================================
// Component
// ============================================================

export function PayrollSettingsClient({
  settings,
}: PayrollSettingsClientProps) {
  const router = useRouter();
  const [isPending, startTransition] = useTransition();

  // Form state - initialised from current settings
  const [payFrequency, setPayFrequency] = useState<PayFrequency>(
    settings.pay_frequency,
  );
  const [payCycleStartDay, setPayCycleStartDay] = useState(
    settings.pay_cycle_start_day,
  );
  const [defaultStartTime, setDefaultStartTime] = useState(
    settings.default_start_time,
  );
  const [defaultEndTime, setDefaultEndTime] = useState(
    settings.default_end_time,
  );
  const [defaultBreakMinutes, setDefaultBreakMinutes] = useState(
    settings.default_break_minutes,
  );
  const [payrollProvider, setPayrollProvider] = useState<PayrollProvider | "">(
    settings.payroll_provider ?? "",
  );
  const [autoCreatePeriods, setAutoCreatePeriods] = useState(
    settings.auto_create_periods,
  );

  // Feedback
  const [message, setMessage] = useState<{
    type: "success" | "error";
    text: string;
  } | null>(null);
  const [isDirty, setIsDirty] = useState(false);

  const markDirty = () => setIsDirty(true);

  // â”€â”€ Save settings â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const handleSave = async () => {
    setMessage(null);

    const result = await updatePayrollSettings({
      payFrequency,
      payCycleStartDay,
      defaultStartTime,
      defaultEndTime,
      defaultBreakMinutes,
      payrollProvider:
        payrollProvider === "" ? null : (payrollProvider as PayrollProvider),
      autoCreatePeriods,
    });

    if (result.error) {
      setMessage({ type: "error", text: result.error.message });
    } else {
      setMessage({ type: "success", text: "Payroll settings saved." });
      setIsDirty(false);
      startTransition(() => router.refresh());
    }
  };

  return (
    <div className="space-y-8">
      {/* Feedback */}
      {message && (
        <div
          className={`rounded-lg border px-4 py-3 text-sm ${
            message.type === "success"
              ? "border-green-200 bg-green-50 text-green-800"
              : "border-red-200 bg-red-50 text-red-800"
          }`}
        >
          {message.text}
        </div>
      )}

      {/* Pay Cycle Section */}
      <section className="rounded-lg border border-gray-200 bg-white p-6">
        <h2 className="text-base font-semibold text-gray-900">Pay Cycle</h2>
        <p className="mt-1 text-sm text-gray-500">
          How often staff get paid and when the cycle starts.
        </p>

        <div className="mt-5 grid grid-cols-1 gap-5 sm:grid-cols-2">
          <div>
            <label className="block text-sm font-medium text-gray-700">
              Pay Frequency
            </label>
            <select
              value={payFrequency}
              onChange={(e) => {
                setPayFrequency(e.target.value as PayFrequency);
                markDirty();
              }}
              className="mt-1 w-full rounded-lg border border-gray-300 px-3 py-2.5 text-sm focus:border-ring focus:outline-none focus:ring-1 focus:ring-ring"
            >
              {PAY_FREQUENCY_OPTIONS.map((opt) => (
                <option key={opt.value} value={opt.value}>
                  {opt.label}
                </option>
              ))}
            </select>
          </div>

          <div>
            <label className="block text-sm font-medium text-gray-700">
              Cycle Start Day
            </label>
            <select
              value={payCycleStartDay}
              onChange={(e) => {
                setPayCycleStartDay(parseInt(e.target.value, 10));
                markDirty();
              }}
              className="mt-1 w-full rounded-lg border border-gray-300 px-3 py-2.5 text-sm focus:border-ring focus:outline-none focus:ring-1 focus:ring-ring"
            >
              {DAY_OPTIONS.map((opt) => (
                <option key={opt.value} value={opt.value}>
                  {opt.label}
                </option>
              ))}
            </select>
          </div>
        </div>

        <div className="mt-5 flex items-center gap-3">
          <input
            id="auto-create"
            type="checkbox"
            checked={autoCreatePeriods}
            onChange={(e) => {
              setAutoCreatePeriods(e.target.checked);
              markDirty();
            }}
            className="h-4 w-4 rounded border-gray-300 text-amber-600 focus:ring-ring"
          />
          <label htmlFor="auto-create" className="text-sm text-gray-700">
            Automatically create the next pay period when the current one is
            locked
          </label>
        </div>
      </section>

      {/* Default Work Hours Section */}
      <section className="rounded-lg border border-gray-200 bg-white p-6">
        <h2 className="text-base font-semibold text-gray-900">
          Default Work Hours
        </h2>
        <p className="mt-1 text-sm text-gray-500">
          Pre-filled in the timesheet grid. Staff can override per day.
        </p>

        <div className="mt-5 grid grid-cols-1 gap-5 sm:grid-cols-3">
          <div>
            <label className="block text-sm font-medium text-gray-700">
              Start Time
            </label>
            <input
              type="time"
              value={defaultStartTime}
              onChange={(e) => {
                setDefaultStartTime(e.target.value);
                markDirty();
              }}
              className="mt-1 w-full rounded-lg border border-gray-300 px-3 py-2.5 text-sm focus:border-ring focus:outline-none focus:ring-1 focus:ring-ring"
            />
          </div>

          <div>
            <label className="block text-sm font-medium text-gray-700">
              End Time
            </label>
            <input
              type="time"
              value={defaultEndTime}
              onChange={(e) => {
                setDefaultEndTime(e.target.value);
                markDirty();
              }}
              className="mt-1 w-full rounded-lg border border-gray-300 px-3 py-2.5 text-sm focus:border-ring focus:outline-none focus:ring-1 focus:ring-ring"
            />
          </div>

          <div>
            <label className="block text-sm font-medium text-gray-700">
              Break (minutes)
            </label>
            <input
              type="number"
              min={0}
              max={120}
              step={5}
              value={defaultBreakMinutes}
              onChange={(e) => {
                setDefaultBreakMinutes(parseInt(e.target.value, 10) || 0);
                markDirty();
              }}
              className="mt-1 w-full rounded-lg border border-gray-300 px-3 py-2.5 text-sm focus:border-ring focus:outline-none focus:ring-1 focus:ring-ring"
            />
          </div>
        </div>

        {/* Calculated daily hours preview */}
        {defaultStartTime && defaultEndTime && (
          <p className="mt-3 text-xs text-gray-500">
            {(() => {
              const [sh, sm] = defaultStartTime.split(":").map(Number);
              const [eh, em] = defaultEndTime.split(":").map(Number);
              const totalMinutes =
                eh * 60 + em - (sh * 60 + sm) - defaultBreakMinutes;
              const hours = (totalMinutes / 60).toFixed(1);
              return `= ${hours} hours per day (excluding ${defaultBreakMinutes}min break)`;
            })()}
          </p>
        )}
      </section>

      {/* Payroll Provider Section */}
      <section className="rounded-lg border border-gray-200 bg-white p-6">
        <h2 className="text-base font-semibold text-gray-900">
          Payroll Provider
        </h2>
        <p className="mt-1 text-sm text-gray-500">
          Connect to an external payroll system to automatically push approved
          timesheets. WattleOS handles time logging and approval - your payroll
          system handles tax, super, and leave calculations.
        </p>

        <div className="mt-5">
          <label className="block text-sm font-medium text-gray-700">
            Provider
          </label>
          <select
            value={payrollProvider}
            onChange={(e) => {
              setPayrollProvider(e.target.value as PayrollProvider | "");
              markDirty();
            }}
            className="mt-1 w-full max-w-xs rounded-lg border border-gray-300 px-3 py-2.5 text-sm focus:border-ring focus:outline-none focus:ring-1 focus:ring-ring"
          >
            <option value="">None (manual export)</option>
            <option value="xero">Xero</option>
            <option value="keypay">KeyPay</option>
          </select>
        </div>

        {payrollProvider && (
          <div className="mt-4 rounded-lg border border-blue-200 bg-blue-50 px-4 py-3 text-sm text-blue-800">
            <strong>
              {payrollProvider === "xero" ? "Xero" : "KeyPay"} integration
            </strong>{" "}
            will be available in a future update. For now, you can approve
            timesheets and export hours manually. The approved totals are ready
            for manual entry into{" "}
            {payrollProvider === "xero" ? "Xero" : "KeyPay"}.
          </div>
        )}
      </section>

      {/* Save button */}
      <div className="flex justify-end">
        <button
          onClick={handleSave}
          disabled={isPending || !isDirty}
          className="rounded-lg bg-amber-600 px-6 py-2.5 text-sm font-medium text-white shadow-sm transition-colors hover:bg-amber-700 disabled:opacity-50"
        >
          {isPending ? "Savingâ€¦" : "Save Settings"}
        </button>
      </div>
    </div>
  );
}



===== D:\.code\wattleos\src\components\domain\timesheets\pending-approvals-client.tsx =====

// src/components/domain/timesheets/pending-approvals-client.tsx
//
// ============================================================
// WattleOS V2 - Pending Approvals Client Component
// ============================================================
// Interactive component for the approver workflow. Shows
// submitted timesheets grouped by pay period, with:
//   â€¢ Expand to see daily entries
//   â€¢ Approve / Reject (with notes) individual timesheets
//   â€¢ Batch approve (select multiple â†’ approve all)
//
// WHY 'use client': Approve/reject are mutations that need
// optimistic state, plus batch selection needs checkbox state.
// ============================================================

"use client";

import {
  approveTimesheet,
  getTimesheetDetail,
  rejectTimesheet,
} from "@/lib/actions/timesheets";
import { TIME_ENTRY_TYPE_CONFIG } from "@/lib/constants/timesheets";
import type {
  PayPeriod,
  TimeEntry,
  TimesheetWithEntries,
} from "@/types/domain";
import { useRouter } from "next/navigation";
import { useState, useTransition } from "react";

// ============================================================
// Props
// ============================================================

interface PendingApprovalsClientProps {
  groupedByPeriod: Record<
    string,
    {
      period: PayPeriod | null;
      timesheets: TimesheetWithEntries[];
    }
  >;
}

// ============================================================
// Detail cache type
// ============================================================

interface TimesheetDetail {
  timesheetId: string;
  data: TimesheetWithEntries | null;
  loading: boolean;
}

// ============================================================
// Component
// ============================================================

export function PendingApprovalsClient({
  groupedByPeriod,
}: PendingApprovalsClientProps) {
  const router = useRouter();
  const [isPending, startTransition] = useTransition();

  // Expand/collapse state
  const [expandedId, setExpandedId] = useState<string | null>(null);
  const [details, setDetails] = useState<Map<string, TimesheetDetail>>(
    new Map(),
  );

  // Batch selection
  const [selectedIds, setSelectedIds] = useState<Set<string>>(new Set());

  // Reject modal
  const [rejectingId, setRejectingId] = useState<string | null>(null);
  const [rejectionNotes, setRejectionNotes] = useState("");

  // Action feedback
  const [actionMessage, setActionMessage] = useState<{
    type: "success" | "error";
    text: string;
  } | null>(null);

  // â”€â”€ Expand/collapse + lazy load detail â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const toggleExpand = async (timesheetId: string) => {
    if (expandedId === timesheetId) {
      setExpandedId(null);
      return;
    }
    setExpandedId(timesheetId);

    if (!details.has(timesheetId)) {
      setDetails((prev) => {
        const next = new Map(prev);
        next.set(timesheetId, { timesheetId, data: null, loading: true });
        return next;
      });

      const result = await getTimesheetDetail(timesheetId);
      setDetails((prev) => {
        const next = new Map(prev);
        next.set(timesheetId, {
          timesheetId,
          data: result.data ?? null,
          loading: false,
        });
        return next;
      });
    }
  };

  // â”€â”€ Approve single â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const handleApprove = async (timesheetId: string) => {
    setActionMessage(null);
    const result = await approveTimesheet(timesheetId);
    if (result.error) {
      setActionMessage({ type: "error", text: result.error.message });
    } else {
      setActionMessage({ type: "success", text: "Timesheet approved." });
      startTransition(() => router.refresh());
    }
  };

  // â”€â”€ Reject single â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const handleReject = async () => {
    if (!rejectingId) return;
    if (!rejectionNotes.trim()) {
      setActionMessage({
        type: "error",
        text: "Please provide a reason for rejection.",
      });
      return;
    }

    setActionMessage(null);
    const result = await rejectTimesheet(rejectingId, rejectionNotes.trim());
    if (result.error) {
      setActionMessage({ type: "error", text: result.error.message });
    } else {
      setActionMessage({
        type: "success",
        text: "Timesheet rejected and returned to staff.",
      });
      setRejectingId(null);
      setRejectionNotes("");
      startTransition(() => router.refresh());
    }
  };

  // â”€â”€ Batch approve â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const handleBatchApprove = async () => {
    if (selectedIds.size === 0) return;
    setActionMessage(null);

    let approved = 0;
    let failed = 0;

    for (const id of selectedIds) {
      const result = await approveTimesheet(id);
      if (result.error) {
        failed++;
      } else {
        approved++;
      }
    }

    setSelectedIds(new Set());

    if (failed > 0) {
      setActionMessage({
        type: "error",
        text: `Approved ${approved}, failed ${failed}. Check individual timesheets for issues.`,
      });
    } else {
      setActionMessage({
        type: "success",
        text: `${approved} timesheet(s) approved.`,
      });
    }

    startTransition(() => router.refresh());
  };

  // â”€â”€ Checkbox toggle â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const toggleSelect = (id: string) => {
    setSelectedIds((prev) => {
      const next = new Set(prev);
      if (next.has(id)) {
        next.delete(id);
      } else {
        next.add(id);
      }
      return next;
    });
  };

  const allTimesheetIds = Object.values(groupedByPeriod).flatMap((g) =>
    g.timesheets.map((ts) => ts.id),
  );

  const toggleSelectAll = () => {
    if (selectedIds.size === allTimesheetIds.length) {
      setSelectedIds(new Set());
    } else {
      setSelectedIds(new Set(allTimesheetIds));
    }
  };

  // â”€â”€ Format helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const formatDate = (dateStr: string) => {
    const d = new Date(dateStr + "T00:00:00");
    return d.toLocaleDateString("en-AU", {
      weekday: "short",
      day: "numeric",
      month: "short",
    });
  };

  const formatTime = (timeStr: string) => {
    const [h, m] = timeStr.split(":");
    const hour = parseInt(h, 10);
    const ampm = hour >= 12 ? "pm" : "am";
    const display = hour > 12 ? hour - 12 : hour === 0 ? 12 : hour;
    return `${display}:${m}${ampm}`;
  };

  return (
    <div className="space-y-6">
      {/* Action message */}
      {actionMessage && (
        <div
          className={`rounded-lg border px-4 py-3 text-sm ${
            actionMessage.type === "success"
              ? "border-green-200 bg-green-50 text-green-800"
              : "border-red-200 bg-red-50 text-red-800"
          }`}
        >
          {actionMessage.text}
        </div>
      )}

      {/* Batch actions bar */}
      <div className="flex items-center gap-4 rounded-lg border border-gray-200 bg-white px-4 py-3">
        <label className="flex items-center gap-2 text-sm text-gray-700">
          <input
            type="checkbox"
            checked={
              selectedIds.size === allTimesheetIds.length &&
              allTimesheetIds.length > 0
            }
            onChange={toggleSelectAll}
            className="h-4 w-4 rounded border-gray-300 text-amber-600 focus:ring-ring"
          />
          Select all ({allTimesheetIds.length})
        </label>
        {selectedIds.size > 0 && (
          <button
            onClick={handleBatchApprove}
            disabled={isPending}
            className="rounded-lg bg-green-600 px-4 py-1.5 text-sm font-medium text-white transition-colors hover:bg-green-700 disabled:opacity-50"
          >
            Approve Selected ({selectedIds.size})
          </button>
        )}
      </div>

      {/* Grouped timesheets */}
      {Object.entries(groupedByPeriod).map(([periodId, group]) => (
        <div key={periodId} className="space-y-3">
          {/* Period header */}
          <div className="flex items-center gap-3">
            <h3 className="text-sm font-semibold text-gray-700">
              {group.period?.name ?? "Unknown Period"}
            </h3>
            <span className="text-xs text-gray-400">
              {group.period
                ? `${new Date(group.period.start_date + "T00:00:00").toLocaleDateString("en-AU", { day: "numeric", month: "short" })} â€“ ${new Date(group.period.end_date + "T00:00:00").toLocaleDateString("en-AU", { day: "numeric", month: "short", year: "numeric" })}`
                : ""}
            </span>
            <span className="rounded-full bg-amber-100 px-2 py-0.5 text-xs font-medium text-amber-700">
              {group.timesheets.length} pending
            </span>
          </div>

          {/* Timesheet cards */}
          {group.timesheets.map((ts) => {
            const detail = details.get(ts.id);
            const isExpanded = expandedId === ts.id;

            return (
              <div
                key={ts.id}
                className="rounded-lg border border-gray-200 bg-white shadow-sm"
              >
                {/* Card header */}
                <div className="flex items-center gap-4 px-4 py-3">
                  <input
                    type="checkbox"
                    checked={selectedIds.has(ts.id)}
                    onChange={() => toggleSelect(ts.id)}
                    className="h-4 w-4 rounded border-gray-300 text-amber-600 focus:ring-ring"
                  />

                  <button
                    onClick={() => toggleExpand(ts.id)}
                    className="flex flex-1 items-center gap-4 text-left"
                  >
                    {/* Avatar placeholder */}
                    <div className="flex h-9 w-9 items-center justify-center rounded-full bg-amber-100 text-sm font-medium text-amber-700">
                      {ts.user.first_name?.[0] ?? ""}
                      {ts.user.last_name?.[0] ?? ""}
                    </div>

                    <div className="flex-1">
                      <p className="text-sm font-medium text-gray-900">
                        {ts.user.first_name} {ts.user.last_name}
                      </p>
                      <p className="text-xs text-gray-500">
                        {ts.total_hours.toFixed(1)}h total
                        {ts.overtime_hours > 0 &&
                          ` Â· ${ts.overtime_hours.toFixed(1)}h OT`}
                        {ts.leave_hours > 0 &&
                          ` Â· ${ts.leave_hours.toFixed(1)}h leave`}
                      </p>
                    </div>

                    {/* Expand chevron */}
                    <svg
                      className={`h-5 w-5 text-gray-400 transition-transform ${
                        isExpanded ? "rotate-180" : ""
                      }`}
                      fill="none"
                      viewBox="0 0 24 24"
                      strokeWidth={1.5}
                      stroke="currentColor"
                    >
                      <path
                        strokeLinecap="round"
                        strokeLinejoin="round"
                        d="m19.5 8.25-7.5 7.5-7.5-7.5"
                      />
                    </svg>
                  </button>

                  {/* Action buttons */}
                  <div className="flex items-center gap-2">
                    <button
                      onClick={() => handleApprove(ts.id)}
                      disabled={isPending}
                      className="rounded-lg bg-green-600 px-3 py-1.5 text-xs font-medium text-white transition-colors hover:bg-green-700 disabled:opacity-50"
                    >
                      Approve
                    </button>
                    <button
                      onClick={() => {
                        setRejectingId(ts.id);
                        setRejectionNotes("");
                      }}
                      disabled={isPending}
                      className="rounded-lg border border-red-300 px-3 py-1.5 text-xs font-medium text-red-700 transition-colors hover:bg-red-50 disabled:opacity-50"
                    >
                      Reject
                    </button>
                  </div>
                </div>

                {/* Expanded detail */}
                {isExpanded && (
                  <div className="border-t border-gray-100 px-4 py-3">
                    {detail?.loading && (
                      <p className="text-sm text-gray-400">Loading entriesâ€¦</p>
                    )}
                    {detail?.data && detail.data.time_entries.length > 0 && (
                      <div className="overflow-x-auto">
                        <table className="w-full text-sm">
                          <thead>
                            <tr className="border-b border-gray-100 text-left text-xs font-medium uppercase text-gray-500">
                              <th className="pb-2 pr-4">Date</th>
                              <th className="pb-2 pr-4">Start</th>
                              <th className="pb-2 pr-4">End</th>
                              <th className="pb-2 pr-4">Break</th>
                              <th className="pb-2 pr-4">Total</th>
                              <th className="pb-2 pr-4">Type</th>
                              <th className="pb-2">Notes</th>
                            </tr>
                          </thead>
                          <tbody>
                            {detail.data.time_entries
                              .sort(
                                (a: TimeEntry, b: TimeEntry) =>
                                  new Date(a.date).getTime() -
                                  new Date(b.date).getTime(),
                              )
                              .map((entry: TimeEntry) => {
                                const typeConfig =
                                  TIME_ENTRY_TYPE_CONFIG[entry.entry_type] ??
                                  TIME_ENTRY_TYPE_CONFIG.regular;
                                return (
                                  <tr
                                    key={entry.id}
                                    className="border-b border-gray-50"
                                  >
                                    <td className="py-2 pr-4 font-medium text-gray-900">
                                      {formatDate(entry.date)}
                                    </td>
                                    <td className="py-2 pr-4 text-gray-600">
                                      {formatTime(entry.start_time)}
                                    </td>
                                    <td className="py-2 pr-4 text-gray-600">
                                      {formatTime(entry.end_time)}
                                    </td>
                                    <td className="py-2 pr-4 text-gray-600">
                                      {entry.break_minutes}m
                                    </td>
                                    <td className="py-2 pr-4 font-medium text-gray-900">
                                      {entry.total_hours.toFixed(1)}h
                                    </td>
                                    <td className="py-2 pr-4">
                                      <span
                                        className={`inline-flex rounded-full px-2 py-0.5 text-xs font-medium ${typeConfig.bgColor} ${typeConfig.color}`}
                                      >
                                        {typeConfig.shortLabel}
                                      </span>
                                    </td>
                                    <td className="py-2 text-gray-500">
                                      {entry.notes || "â€”"}
                                    </td>
                                  </tr>
                                );
                              })}
                          </tbody>
                          <tfoot>
                            <tr className="font-medium">
                              <td
                                colSpan={4}
                                className="pt-2 text-right text-gray-500"
                              >
                                Period Total:
                              </td>
                              <td className="pt-2 text-gray-900">
                                {detail.data.total_hours.toFixed(1)}h
                              </td>
                              <td colSpan={2} />
                            </tr>
                          </tfoot>
                        </table>
                      </div>
                    )}
                    {detail?.data && detail.data.time_entries.length === 0 && (
                      <p className="text-sm text-gray-400">
                        No individual entries found for this timesheet.
                      </p>
                    )}
                  </div>
                )}
              </div>
            );
          })}
        </div>
      ))}

      {/* Reject modal */}
      {rejectingId && (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50">
          <div className="mx-4 w-full max-w-md rounded-xl bg-white p-6 shadow-xl">
            <h3 className="text-lg font-semibold text-gray-900">
              Reject Timesheet
            </h3>
            <p className="mt-1 text-sm text-gray-500">
              The staff member will be notified and can revise and resubmit.
            </p>
            <textarea
              value={rejectionNotes}
              onChange={(e) => setRejectionNotes(e.target.value)}
              placeholder="Reason for rejection (required)â€¦"
              rows={3}
              className="mt-4 w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-ring focus:outline-none focus:ring-1 focus:ring-ring"
              autoFocus
            />
            <div className="mt-4 flex justify-end gap-3">
              <button
                onClick={() => {
                  setRejectingId(null);
                  setRejectionNotes("");
                }}
                className="rounded-lg border border-gray-300 px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50"
              >
                Cancel
              </button>
              <button
                onClick={handleReject}
                disabled={!rejectionNotes.trim() || isPending}
                className="rounded-lg bg-red-600 px-4 py-2 text-sm font-medium text-white hover:bg-red-700 disabled:opacity-50"
              >
                Reject Timesheet
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}



===== D:\.code\wattleos\src\components\domain\timesheets\timesheet-grid-client.tsx =====

// ============================================================
// src/components/domain/timesheets/timesheet-grid-client.tsx
// ============================================================
// Interactive time entry grid for the current pay period.
// One row per day with inline editing of times, break, type.
//
// WHY client component: Every cell is an interactive input.
// We need useState for local edits and useTransition for
// non-blocking server action calls on blur/change.
//
// WHY upsert on blur: The server action `logTimeEntry` is an
// upsert (one entry per user per day). Saving on blur means
// the user never loses work - each cell auto-saves.
// ============================================================

"use client";

import { deleteTimeEntry, logTimeEntry } from "@/lib/actions/time-entries";
import { submitTimesheet } from "@/lib/actions/timesheets";
import {
  DAY_LABELS,
  LEAVE_TYPES,
  TIME_ENTRY_TYPE_CONFIG,
  TIME_ENTRY_TYPES,
  TIMESHEET_STATUS_CONFIG,
} from "@/lib/constants/timesheets";
import type {
  PayPeriod,
  TimeEntry,
  TimeEntryType,
  Timesheet,
  TimesheetStatus,
} from "@/types/domain";
import { useRouter } from "next/navigation";
import { useCallback, useState, useTransition } from "react";

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Types
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

interface TimesheetGridClientProps {
  payPeriod: PayPeriod;
  defaultStartTime: string;
  defaultEndTime: string;
  defaultBreakMinutes: number;
  existingEntries: TimeEntry[];
  currentTimesheet: (Timesheet & { pay_period_name?: string }) | null;
}

/** Local row state for each day in the period */
interface DayRow {
  date: string; // ISO date string 'YYYY-MM-DD'
  dayLabel: string; // 'Mon', 'Tue', etc.
  dateLabel: string; // 'Feb 17'
  startTime: string; // 'HH:MM'
  endTime: string; // 'HH:MM'
  breakMinutes: number;
  entryType: TimeEntryType;
  notes: string;
  totalHours: number; // computed locally for instant feedback
  entryId: string | null; // null if not yet saved
  isSaving: boolean;
  error: string | null;
  isWeekend: boolean;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Helpers
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function generateDaysInPeriod(
  startDate: string,
  endDate: string,
  defaultStart: string,
  defaultEnd: string,
  defaultBreak: number,
  existingEntries: TimeEntry[],
): DayRow[] {
  const days: DayRow[] = [];
  const entryMap = new Map<string, TimeEntry>();

  for (const entry of existingEntries) {
    entryMap.set(entry.date, entry);
  }

  const current = new Date(startDate + "T00:00:00");
  const end = new Date(endDate + "T00:00:00");

  while (current <= end) {
    const iso = current.toISOString().split("T")[0];
    const dayOfWeek = current.getDay(); // 0=Sun, 6=Sat
    const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
    const dayIndex = dayOfWeek === 0 ? 6 : dayOfWeek - 1; // Map to Mon=0..Sun=6
    const existing = entryMap.get(iso);

    const startTime = existing?.start_time?.slice(0, 5) ?? defaultStart;
    const endTime = existing?.end_time?.slice(0, 5) ?? defaultEnd;
    const breakMin = existing?.break_minutes ?? defaultBreak;

    days.push({
      date: iso,
      dayLabel: DAY_LABELS[dayIndex],
      dateLabel: current.toLocaleDateString("en-AU", {
        month: "short",
        day: "numeric",
      }),
      startTime,
      endTime,
      breakMinutes: breakMin,
      entryType: (existing?.entry_type as TimeEntryType) ?? "regular",
      notes: existing?.notes ?? "",
      totalHours:
        existing?.total_hours ?? computeHours(startTime, endTime, breakMin),
      entryId: existing?.id ?? null,
      isSaving: false,
      error: null,
      isWeekend,
    });

    current.setDate(current.getDate() + 1);
  }

  return days;
}

function computeHours(start: string, end: string, breakMin: number): number {
  const [sh, sm] = start.split(":").map(Number);
  const [eh, em] = end.split(":").map(Number);
  const startMins = sh * 60 + sm;
  const endMins = eh * 60 + em;
  const worked = (endMins - startMins) / 60 - breakMin / 60;
  return Math.max(0, Math.round(worked * 100) / 100);
}

function formatHours(h: number): string {
  return h.toFixed(1);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Component
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

export function TimesheetGridClient({
  payPeriod,
  defaultStartTime,
  defaultEndTime,
  defaultBreakMinutes,
  existingEntries,
  currentTimesheet,
}: TimesheetGridClientProps) {
  const router = useRouter();
  const [isSubmitting, startSubmitTransition] = useTransition();

  // â”€â”€ Local state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  const [rows, setRows] = useState<DayRow[]>(() =>
    generateDaysInPeriod(
      payPeriod.start_date,
      payPeriod.end_date,
      defaultStartTime,
      defaultEndTime,
      defaultBreakMinutes,
      existingEntries,
    ),
  );

  const [submitError, setSubmitError] = useState<string | null>(null);
  const [submitSuccess, setSubmitSuccess] = useState(false);

  // Derived
  const timesheetStatus: TimesheetStatus | null =
    currentTimesheet?.status ?? null;
  const isLocked =
    payPeriod.status === "locked" || payPeriod.status === "processed";
  const isEditable =
    !isLocked &&
    (timesheetStatus === null ||
      timesheetStatus === "draft" ||
      timesheetStatus === "rejected");

  const totalRegular = rows
    .filter(
      (r) =>
        r.entryType === "regular" ||
        r.entryType === "overtime" ||
        r.entryType === "public_holiday",
    )
    .reduce((sum, r) => sum + r.totalHours, 0);
  const totalOvertime = rows
    .filter((r) => r.entryType === "overtime")
    .reduce((sum, r) => sum + r.totalHours, 0);
  const totalLeave = rows
    .filter((r) => LEAVE_TYPES.includes(r.entryType))
    .reduce((sum, r) => sum + r.totalHours, 0);
  const grandTotal = rows.reduce((sum, r) => sum + r.totalHours, 0);

  // Check if all weekdays have an entry saved (entryId not null)
  const weekdayRows = rows.filter((r) => !r.isWeekend);
  const allWeekdaysFilled = weekdayRows.every((r) => r.entryId !== null);
  const canSubmit = isEditable && allWeekdaysFilled && !isSubmitting;

  // â”€â”€ Row update handler â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  const updateRow = useCallback((date: string, patch: Partial<DayRow>) => {
    setRows((prev) =>
      prev.map((row) => {
        if (row.date !== date) return row;
        const updated = { ...row, ...patch };

        // Recompute total if times or break changed
        if (
          "startTime" in patch ||
          "endTime" in patch ||
          "breakMinutes" in patch
        ) {
          updated.totalHours = computeHours(
            updated.startTime,
            updated.endTime,
            updated.breakMinutes,
          );
        }
        return updated;
      }),
    );
  }, []);

  // â”€â”€ Save a single row (called on blur) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  const saveRow = useCallback(
    async (date: string) => {
      const row = rows.find((r) => r.date === date);
      if (!row || !isEditable) return;

      // Don't save if start/end are empty
      if (!row.startTime || !row.endTime) return;

      updateRow(date, { isSaving: true, error: null });

      const result = await logTimeEntry({
        date: row.date,
        startTime: row.startTime,
        endTime: row.endTime,
        breakMinutes: row.breakMinutes,
        entryType: row.entryType,
        notes: row.notes || undefined,
      });

      if (result.error) {
        updateRow(date, { isSaving: false, error: result.error.message });
      } else if (result.data) {
        updateRow(date, {
          isSaving: false,
          error: null,
          entryId: result.data.id,
          totalHours: result.data.total_hours,
        });
      }
    },
    [rows, isEditable, updateRow],
  );

  // â”€â”€ Delete a row entry â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  const clearRow = useCallback(
    async (date: string) => {
      const row = rows.find((r) => r.date === date);
      if (!row?.entryId || !isEditable) return;

      updateRow(date, { isSaving: true, error: null });

      const result = await deleteTimeEntry(row.entryId);

      if (result.error) {
        updateRow(date, { isSaving: false, error: result.error.message });
      } else {
        updateRow(date, {
          isSaving: false,
          error: null,
          entryId: null,
          startTime: defaultStartTime,
          endTime: defaultEndTime,
          breakMinutes: defaultBreakMinutes,
          entryType: "regular",
          notes: "",
          totalHours: computeHours(
            defaultStartTime,
            defaultEndTime,
            defaultBreakMinutes,
          ),
        });
      }
    },
    [
      rows,
      isEditable,
      updateRow,
      defaultStartTime,
      defaultEndTime,
      defaultBreakMinutes,
    ],
  );

  // â”€â”€ Submit handler â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  const handleSubmit = () => {
    setSubmitError(null);
    setSubmitSuccess(false);

    startSubmitTransition(async () => {
      const result = await submitTimesheet(payPeriod.id);

      if (result.error) {
        setSubmitError(result.error.message);
      } else {
        setSubmitSuccess(true);
        // Refresh the page data from the server
        router.refresh();
      }
    });
  };

  // â”€â”€ Fill weekdays with defaults â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  const fillDefaults = useCallback(async () => {
    for (const row of rows) {
      if (!row.isWeekend && row.entryId === null) {
        await saveRow(row.date);
      }
    }
  }, [rows, saveRow]);

  // â”€â”€ Render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  return (
    <div className="space-y-4">
      {/* Status Banner */}
      {timesheetStatus && (
        <StatusBanner
          status={timesheetStatus}
          rejectionNotes={currentTimesheet?.rejection_notes ?? null}
        />
      )}

      {/* Period locked banner */}
      {isLocked && (
        <div className="rounded-lg border border-orange-200 bg-orange-50 px-4 py-3">
          <div className="flex items-center gap-2">
            <svg
              className="h-5 w-5 text-orange-500"
              fill="none"
              viewBox="0 0 24 24"
              strokeWidth={1.5}
              stroke="currentColor"
            >
              <path
                strokeLinecap="round"
                strokeLinejoin="round"
                d="M16.5 10.5V6.75a4.5 4.5 0 1 0-9 0v3.75m-.75 11.25h10.5a2.25 2.25 0 0 0 2.25-2.25v-6.75a2.25 2.25 0 0 0-2.25-2.25H6.75a2.25 2.25 0 0 0-2.25 2.25v6.75a2.25 2.25 0 0 0 2.25 2.25Z"
              />
            </svg>
            <p className="text-sm font-medium text-orange-800">
              This pay period is locked. No further changes can be made.
            </p>
          </div>
        </div>
      )}

      {/* Period header card */}
      <div className="rounded-lg border border-gray-200 bg-white px-6 py-4">
        <div className="flex items-center justify-between">
          <div>
            <h2 className="text-lg font-semibold text-gray-900">
              {payPeriod.name}
            </h2>
            <p className="text-sm text-gray-500">
              {new Date(payPeriod.start_date + "T00:00:00").toLocaleDateString(
                "en-AU",
                {
                  weekday: "short",
                  day: "numeric",
                  month: "short",
                },
              )}
              {" â€“ "}
              {new Date(payPeriod.end_date + "T00:00:00").toLocaleDateString(
                "en-AU",
                {
                  weekday: "short",
                  day: "numeric",
                  month: "short",
                  year: "numeric",
                },
              )}
            </p>
          </div>

          {/* Summary pills */}
          <div className="hidden items-center gap-3 sm:flex">
            <SummaryPill
              label="Total"
              value={formatHours(grandTotal)}
              variant="primary"
            />
            <SummaryPill
              label="Regular"
              value={formatHours(totalRegular - totalOvertime)}
              variant="default"
            />
            {totalOvertime > 0 && (
              <SummaryPill
                label="Overtime"
                value={formatHours(totalOvertime)}
                variant="warning"
              />
            )}
            {totalLeave > 0 && (
              <SummaryPill
                label="Leave"
                value={formatHours(totalLeave)}
                variant="info"
              />
            )}
          </div>
        </div>
      </div>

      {/* Time Entry Grid */}
      <div className="overflow-x-auto rounded-lg border border-gray-200 bg-white">
        <table className="min-w-full divide-y divide-gray-200">
          <thead className="bg-gray-50">
            <tr>
              <th className="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">
                Day
              </th>
              <th className="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">
                Date
              </th>
              <th className="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">
                Start
              </th>
              <th className="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">
                End
              </th>
              <th className="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">
                Break
              </th>
              <th className="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">
                Total
              </th>
              <th className="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">
                Type
              </th>
              <th className="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">
                Notes
              </th>
              <th className="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">
                <span className="sr-only">Status</span>
              </th>
            </tr>
          </thead>
          <tbody className="divide-y divide-gray-100">
            {rows.map((row) => (
              <DayRowComponent
                key={row.date}
                row={row}
                isEditable={isEditable}
                onUpdate={(patch) => updateRow(row.date, patch)}
                onBlurSave={() => saveRow(row.date)}
                onClear={() => clearRow(row.date)}
              />
            ))}
          </tbody>
        </table>
      </div>

      {/* Mobile summary (visible on small screens) */}
      <div className="flex flex-wrap items-center gap-2 sm:hidden">
        <SummaryPill
          label="Total"
          value={formatHours(grandTotal)}
          variant="primary"
        />
        <SummaryPill
          label="Regular"
          value={formatHours(totalRegular - totalOvertime)}
          variant="default"
        />
        {totalOvertime > 0 && (
          <SummaryPill
            label="Overtime"
            value={formatHours(totalOvertime)}
            variant="warning"
          />
        )}
        {totalLeave > 0 && (
          <SummaryPill
            label="Leave"
            value={formatHours(totalLeave)}
            variant="info"
          />
        )}
      </div>

      {/* Actions bar */}
      {isEditable && (
        <div className="flex items-center justify-between rounded-lg border border-gray-200 bg-white px-6 py-4">
          <div className="flex items-center gap-3">
            <button
              type="button"
              onClick={fillDefaults}
              className="inline-flex items-center gap-1.5 rounded-lg border border-gray-300 px-3 py-2 text-sm font-medium text-gray-700 transition-colors hover:bg-gray-50"
            >
              <svg
                className="h-4 w-4"
                fill="none"
                viewBox="0 0 24 24"
                strokeWidth={1.5}
                stroke="currentColor"
              >
                <path
                  strokeLinecap="round"
                  strokeLinejoin="round"
                  d="M3.75 9.776c.112-.017.227-.026.344-.026h15.812c.117 0 .232.009.344.026m-16.5 0a2.25 2.25 0 0 0-1.883 2.542l.857 6a2.25 2.25 0 0 0 2.227 1.932H19.05a2.25 2.25 0 0 0 2.227-1.932l.857-6a2.25 2.25 0 0 0-1.883-2.542m-16.5 0V6A2.25 2.25 0 0 1 6 3.75h3.879a1.5 1.5 0 0 1 1.06.44l2.122 2.12a1.5 1.5 0 0 0 1.06.44H18A2.25 2.25 0 0 1 20.25 9v.776"
                />
              </svg>
              Fill Defaults
            </button>
            {!allWeekdaysFilled && (
              <p className="text-xs text-gray-500">
                Save all weekday entries before submitting
              </p>
            )}
          </div>

          <button
            type="button"
            onClick={handleSubmit}
            disabled={!canSubmit}
            className="inline-flex items-center gap-2 rounded-lg bg-amber-600 px-5 py-2.5 text-sm font-medium text-white shadow-sm transition-colors hover:bg-amber-700 disabled:cursor-not-allowed disabled:opacity-50"
          >
            {isSubmitting ? (
              <>
                <svg
                  className="h-4 w-4 animate-spin"
                  fill="none"
                  viewBox="0 0 24 24"
                >
                  <circle
                    className="opacity-25"
                    cx="12"
                    cy="12"
                    r="10"
                    stroke="currentColor"
                    strokeWidth="4"
                  />
                  <path
                    className="opacity-75"
                    fill="currentColor"
                    d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"
                  />
                </svg>
                Submittingâ€¦
              </>
            ) : (
              <>
                <svg
                  className="h-4 w-4"
                  fill="none"
                  viewBox="0 0 24 24"
                  strokeWidth={1.5}
                  stroke="currentColor"
                >
                  <path
                    strokeLinecap="round"
                    strokeLinejoin="round"
                    d="M6 12 3.269 3.125A59.769 59.769 0 0 1 21.485 12 59.768 59.768 0 0 1 3.27 20.875L5.999 12Zm0 0h7.5"
                  />
                </svg>
                Submit Timesheet
              </>
            )}
          </button>
        </div>
      )}

      {/* Error/Success feedback */}
      {submitError && (
        <div className="rounded-lg border border-red-200 bg-red-50 px-4 py-3">
          <p className="text-sm text-red-700">{submitError}</p>
        </div>
      )}
      {submitSuccess && (
        <div className="rounded-lg border border-green-200 bg-green-50 px-4 py-3">
          <p className="text-sm text-green-700">
            Timesheet submitted successfully! Your approver will review it
            shortly.
          </p>
        </div>
      )}
    </div>
  );
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Sub-components
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function StatusBanner({
  status,
  rejectionNotes,
}: {
  status: TimesheetStatus;
  rejectionNotes: string | null;
}) {
  const config = TIMESHEET_STATUS_CONFIG[status];
  if (!config) return null;

  // Map status to border/background colors for the banner
  const bannerStyles: Record<TimesheetStatus, string> = {
    draft: "border-gray-200 bg-gray-50",
    submitted: "border-blue-200 bg-blue-50",
    approved: "border-green-200 bg-green-50",
    rejected: "border-red-200 bg-red-50",
    synced: "border-purple-200 bg-purple-50",
  };

  const textStyles: Record<TimesheetStatus, string> = {
    draft: "text-gray-700",
    submitted: "text-blue-700",
    approved: "text-green-700",
    rejected: "text-red-700",
    synced: "text-purple-700",
  };

  const messages: Record<TimesheetStatus, string> = {
    draft:
      "Your timesheet is in draft. Fill in your hours and submit when ready.",
    submitted: "Your timesheet has been submitted and is awaiting approval.",
    approved: "Your timesheet has been approved.",
    rejected:
      "Your timesheet was returned for revision. Please update and resubmit.",
    synced: "Your timesheet has been approved and synced to payroll.",
  };

  return (
    <div className={`rounded-lg border px-4 py-3 ${bannerStyles[status]}`}>
      <div className="flex items-start gap-3">
        <span
          className={`inline-flex items-center gap-1.5 rounded-full px-2.5 py-0.5 text-xs font-medium ${config.bgColor} ${config.color}`}
        >
          <span className={`h-1.5 w-1.5 rounded-full ${config.dotColor}`} />
          {config.label}
        </span>
        <p className={`text-sm ${textStyles[status]}`}>{messages[status]}</p>
      </div>
      {status === "rejected" && rejectionNotes && (
        <div className="mt-2 rounded-md bg-red-100 px-3 py-2">
          <p className="text-xs font-medium text-red-800">Reviewer notes:</p>
          <p className="mt-0.5 text-sm text-red-700">{rejectionNotes}</p>
        </div>
      )}
    </div>
  );
}

function DayRowComponent({
  row,
  isEditable,
  onUpdate,
  onBlurSave,
  onClear,
}: {
  row: DayRow;
  isEditable: boolean;
  onUpdate: (patch: Partial<DayRow>) => void;
  onBlurSave: () => void;
  onClear: () => void;
}) {
  const typeConfig = TIME_ENTRY_TYPE_CONFIG[row.entryType];
  const isLeave = LEAVE_TYPES.includes(row.entryType);

  return (
    <tr
      className={`${row.isWeekend ? "bg-gray-50/50" : ""} ${row.error ? "bg-red-50/30" : ""}`}
    >
      {/* Day label */}
      <td className="whitespace-nowrap px-4 py-2.5">
        <span
          className={`text-sm font-medium ${row.isWeekend ? "text-gray-400" : "text-gray-900"}`}
        >
          {row.dayLabel}
        </span>
      </td>

      {/* Date */}
      <td className="whitespace-nowrap px-4 py-2.5">
        <span className="text-sm text-gray-600">{row.dateLabel}</span>
      </td>

      {/* Start time */}
      <td className="whitespace-nowrap px-4 py-2.5">
        <input
          type="time"
          value={row.startTime}
          onChange={(e) => onUpdate({ startTime: e.target.value })}
          onBlur={onBlurSave}
          disabled={!isEditable}
          className="w-24 rounded-md border border-gray-300 px-2 py-1.5 text-sm text-gray-900 focus:border-ring focus:ring-1 focus:ring-ring disabled:bg-gray-100 disabled:text-gray-500"
        />
      </td>

      {/* End time */}
      <td className="whitespace-nowrap px-4 py-2.5">
        <input
          type="time"
          value={row.endTime}
          onChange={(e) => onUpdate({ endTime: e.target.value })}
          onBlur={onBlurSave}
          disabled={!isEditable}
          className="w-24 rounded-md border border-gray-300 px-2 py-1.5 text-sm text-gray-900 focus:border-ring focus:ring-1 focus:ring-ring disabled:bg-gray-100 disabled:text-gray-500"
        />
      </td>

      {/* Break */}
      <td className="whitespace-nowrap px-4 py-2.5">
        <select
          value={row.breakMinutes}
          onChange={(e) => onUpdate({ breakMinutes: Number(e.target.value) })}
          onBlur={onBlurSave}
          disabled={!isEditable}
          className="w-20 rounded-md border border-gray-300 px-2 py-1.5 text-sm text-gray-900 focus:border-ring focus:ring-1 focus:ring-ring disabled:bg-gray-100 disabled:text-gray-500"
        >
          <option value={0}>0 min</option>
          <option value={15}>15 min</option>
          <option value={30}>30 min</option>
          <option value={45}>45 min</option>
          <option value={60}>60 min</option>
        </select>
      </td>

      {/* Total hours */}
      <td className="whitespace-nowrap px-4 py-2.5">
        <span className="text-sm font-medium text-gray-900">
          {formatHours(row.totalHours)}h
        </span>
      </td>

      {/* Entry type */}
      <td className="whitespace-nowrap px-4 py-2.5">
        <select
          value={row.entryType}
          onChange={(e) => {
            onUpdate({ entryType: e.target.value as TimeEntryType });
            // Trigger save after type change
            setTimeout(onBlurSave, 0);
          }}
          disabled={!isEditable}
          className={`w-32 rounded-md border px-2 py-1.5 text-xs font-medium focus:border-ring focus:ring-1 focus:ring-ring disabled:opacity-60 ${typeConfig?.bgColor ?? "bg-gray-50"} ${typeConfig?.color ?? "text-gray-700"} border-gray-300`}
        >
          {TIME_ENTRY_TYPES.map((type) => (
            <option key={type} value={type}>
              {TIME_ENTRY_TYPE_CONFIG[type]?.label ?? type}
            </option>
          ))}
        </select>
      </td>

      {/* Notes */}
      <td className="px-4 py-2.5">
        <input
          type="text"
          value={row.notes}
          onChange={(e) => onUpdate({ notes: e.target.value })}
          onBlur={onBlurSave}
          disabled={!isEditable}
          placeholder={row.isWeekend ? "" : "Optional"}
          className="w-full min-w-[100px] rounded-md border border-gray-300 px-2 py-1.5 text-sm text-gray-900 placeholder:text-gray-400 focus:border-ring focus:ring-1 focus:ring-ring disabled:bg-gray-100 disabled:text-gray-500"
        />
      </td>

      {/* Status / Actions */}
      <td className="whitespace-nowrap px-4 py-2.5">
        <div className="flex items-center gap-1.5">
          {row.isSaving && (
            <svg
              className="h-4 w-4 animate-spin text-amber-500"
              fill="none"
              viewBox="0 0 24 24"
            >
              <circle
                className="opacity-25"
                cx="12"
                cy="12"
                r="10"
                stroke="currentColor"
                strokeWidth="4"
              />
              <path
                className="opacity-75"
                fill="currentColor"
                d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"
              />
            </svg>
          )}
          {!row.isSaving && row.entryId && !row.error && (
            <svg
              className="h-4 w-4 text-green-500"
              fill="none"
              viewBox="0 0 24 24"
              strokeWidth={2}
              stroke="currentColor"
            >
              <path
                strokeLinecap="round"
                strokeLinejoin="round"
                d="m4.5 12.75 6 6 9-13.5"
              />
            </svg>
          )}
          {row.error && (
            <span className="text-xs text-red-500" title={row.error}>
              <svg
                className="h-4 w-4"
                fill="none"
                viewBox="0 0 24 24"
                strokeWidth={2}
                stroke="currentColor"
              >
                <path
                  strokeLinecap="round"
                  strokeLinejoin="round"
                  d="M12 9v3.75m9-.75a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9 3.75h.008v.008H12v-.008Z"
                />
              </svg>
            </span>
          )}
          {isEditable && row.entryId && (
            <button
              type="button"
              onClick={onClear}
              className="rounded p-0.5 text-gray-400 transition-colors hover:text-red-500"
              title="Clear entry"
            >
              <svg
                className="h-3.5 w-3.5"
                fill="none"
                viewBox="0 0 24 24"
                strokeWidth={2}
                stroke="currentColor"
              >
                <path
                  strokeLinecap="round"
                  strokeLinejoin="round"
                  d="M6 18 18 6M6 6l12 12"
                />
              </svg>
            </button>
          )}
        </div>
      </td>
    </tr>
  );
}

function SummaryPill({
  label,
  value,
  variant,
}: {
  label: string;
  value: string;
  variant: "primary" | "default" | "warning" | "info";
}) {
  const styles: Record<typeof variant, string> = {
    primary: "bg-amber-50 text-amber-700 border-amber-200",
    default: "bg-gray-50 text-gray-700 border-gray-200",
    warning: "bg-orange-50 text-orange-700 border-orange-200",
    info: "bg-blue-50 text-blue-700 border-blue-200",
  };

  return (
    <div
      className={`inline-flex items-center gap-1.5 rounded-full border px-3 py-1 ${styles[variant]}`}
    >
      <span className="text-xs">{label}</span>
      <span className="text-sm font-semibold">{value}h</span>
    </div>
  );
}



===== D:\.code\wattleos\src\components\domain\timesheets\timesheet-history-list.tsx =====

// ============================================================
// src/components/domain/timesheets/timesheet-history-list.tsx
// ============================================================
// Renders a list of past timesheets as cards. Each card shows
// the pay period name, total hours, breakdown, and status badge.
// Expanding a card fetches the detailed time entries.
//
// WHY client component: Expand/collapse is interactive, and
// detail fetching on expand requires useState + useTransition.
// ============================================================

'use client';

import { useState, useTransition } from 'react';
import { getTimesheetDetail } from '@/lib/actions/timesheets';
import {
  TIMESHEET_STATUS_CONFIG,
  TIME_ENTRY_TYPE_CONFIG,
} from '@/lib/constants/timesheets';
import type {
  Timesheet,
  TimesheetWithEntries,
  TimesheetStatus,
  TimeEntryType,
} from '@/types/domain';

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Types
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

interface TimesheetHistoryListProps {
  timesheets: Array<Timesheet & { pay_period_name?: string }>;
}

interface ExpandedDetail {
  timesheetId: string;
  data: TimesheetWithEntries | null;
  error: string | null;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Helpers
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function formatHours(h: number): string {
  return h.toFixed(1);
}

function formatDate(dateStr: string): string {
  const d = new Date(dateStr + 'T00:00:00');
  return d.toLocaleDateString('en-AU', {
    weekday: 'short',
    day: 'numeric',
    month: 'short',
  });
}

function formatTime(timeStr: string | null): string {
  if (!timeStr) return 'â€“';
  return timeStr.slice(0, 5);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Component
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

export function TimesheetHistoryList({ timesheets }: TimesheetHistoryListProps) {
  const [expandedId, setExpandedId] = useState<string | null>(null);
  const [details, setDetails] = useState<Map<string, ExpandedDetail>>(new Map());
  const [isPending, startTransition] = useTransition();

  const toggleExpand = (timesheetId: string) => {
    if (expandedId === timesheetId) {
      setExpandedId(null);
      return;
    }

    setExpandedId(timesheetId);

    // Fetch detail if not already cached
    if (!details.has(timesheetId)) {
      startTransition(async () => {
        const result = await getTimesheetDetail(timesheetId);
        setDetails((prev) => {
          const next = new Map(prev);
          next.set(timesheetId, {
            timesheetId,
            data: result.data ?? null,
            error: result.error?.message ?? null,
          });
          return next;
        });
      });
    }
  };

  return (
    <div className="space-y-3">
      {timesheets.map((ts) => {
        const isExpanded = expandedId === ts.id;
        const detail = details.get(ts.id);
        const statusConfig = TIMESHEET_STATUS_CONFIG[ts.status as TimesheetStatus];

        return (
          <div
            key={ts.id}
            className="overflow-hidden rounded-lg border border-gray-200 bg-white transition-shadow hover:shadow-sm"
          >
            {/* Card header - clickable to expand */}
            <button
              type="button"
              onClick={() => toggleExpand(ts.id)}
              className="flex w-full items-center justify-between px-6 py-4 text-left"
            >
              <div className="min-w-0 flex-1">
                <div className="flex items-center gap-3">
                  <h3 className="truncate text-sm font-semibold text-gray-900">
                    {ts.pay_period_name ?? 'Pay Period'}
                  </h3>
                  {statusConfig && (
                    <span
                      className={`inline-flex items-center gap-1.5 rounded-full px-2.5 py-0.5 text-xs font-medium ${statusConfig.bgColor} ${statusConfig.color}`}
                    >
                      <span className={`h-1.5 w-1.5 rounded-full ${statusConfig.dotColor}`} />
                      {statusConfig.label}
                    </span>
                  )}
                </div>
                <div className="mt-1 flex items-center gap-4 text-xs text-gray-500">
                  <span>{formatHours(ts.total_hours)}h total</span>
                  <span className="text-gray-300">|</span>
                  <span>{formatHours(ts.regular_hours)}h regular</span>
                  {ts.overtime_hours > 0 && (
                    <>
                      <span className="text-gray-300">|</span>
                      <span className="text-orange-600">{formatHours(ts.overtime_hours)}h overtime</span>
                    </>
                  )}
                  {ts.leave_hours > 0 && (
                    <>
                      <span className="text-gray-300">|</span>
                      <span className="text-blue-600">{formatHours(ts.leave_hours)}h leave</span>
                    </>
                  )}
                </div>
              </div>

              {/* Expand chevron */}
              <svg
                className={`h-5 w-5 flex-shrink-0 text-gray-400 transition-transform duration-200 ${
                  isExpanded ? 'rotate-180' : ''
                }`}
                fill="none"
                viewBox="0 0 24 24"
                strokeWidth={1.5}
                stroke="currentColor"
              >
                <path strokeLinecap="round" strokeLinejoin="round" d="m19.5 8.25-7.5 7.5-7.5-7.5" />
              </svg>
            </button>

            {/* Rejection notes (always visible if rejected) */}
            {ts.status === 'rejected' && ts.rejection_notes && (
              <div className="border-t border-red-100 bg-red-50 px-6 py-3">
                <p className="text-xs font-medium text-red-800">Reviewer notes:</p>
                <p className="mt-0.5 text-sm text-red-700">{ts.rejection_notes}</p>
              </div>
            )}

            {/* Expanded detail */}
            {isExpanded && (
              <div className="border-t border-gray-100 px-6 py-4">
                {isPending && !detail && (
                  <div className="flex items-center justify-center py-6">
                    <svg className="h-5 w-5 animate-spin text-amber-500" fill="none" viewBox="0 0 24 24">
                      <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4" />
                      <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z" />
                    </svg>
                    <span className="ml-2 text-sm text-gray-500">Loading entriesâ€¦</span>
                  </div>
                )}

                {detail?.error && (
                  <p className="text-sm text-red-600">{detail.error}</p>
                )}

                {detail?.data && detail.data.time_entries.length > 0 && (
                  <div className="overflow-x-auto">
                    <table className="min-w-full divide-y divide-gray-100">
                      <thead>
                        <tr>
                          <th className="py-2 pr-4 text-left text-xs font-medium uppercase text-gray-500">Date</th>
                          <th className="px-4 py-2 text-left text-xs font-medium uppercase text-gray-500">Start</th>
                          <th className="px-4 py-2 text-left text-xs font-medium uppercase text-gray-500">End</th>
                          <th className="px-4 py-2 text-left text-xs font-medium uppercase text-gray-500">Break</th>
                          <th className="px-4 py-2 text-left text-xs font-medium uppercase text-gray-500">Total</th>
                          <th className="px-4 py-2 text-left text-xs font-medium uppercase text-gray-500">Type</th>
                          <th className="pl-4 py-2 text-left text-xs font-medium uppercase text-gray-500">Notes</th>
                        </tr>
                      </thead>
                      <tbody className="divide-y divide-gray-50">
                        {detail.data.time_entries
                          .sort((a, b) => a.date.localeCompare(b.date))
                          .map((entry) => {
                            const typeConfig = TIME_ENTRY_TYPE_CONFIG[entry.entry_type as TimeEntryType];
                            return (
                              <tr key={entry.id}>
                                <td className="whitespace-nowrap py-2 pr-4 text-sm text-gray-900">
                                  {formatDate(entry.date)}
                                </td>
                                <td className="whitespace-nowrap px-4 py-2 text-sm text-gray-600">
                                  {formatTime(entry.start_time)}
                                </td>
                                <td className="whitespace-nowrap px-4 py-2 text-sm text-gray-600">
                                  {formatTime(entry.end_time)}
                                </td>
                                <td className="whitespace-nowrap px-4 py-2 text-sm text-gray-600">
                                  {entry.break_minutes}m
                                </td>
                                <td className="whitespace-nowrap px-4 py-2 text-sm font-medium text-gray-900">
                                  {formatHours(entry.total_hours)}h
                                </td>
                                <td className="whitespace-nowrap px-4 py-2">
                                  {typeConfig && (
                                    <span className={`inline-flex rounded-full px-2 py-0.5 text-xs font-medium ${typeConfig.bgColor} ${typeConfig.color}`}>
                                      {typeConfig.shortLabel ?? typeConfig.label}
                                    </span>
                                  )}
                                </td>
                                <td className="pl-4 py-2 text-sm text-gray-500">
                                  {entry.notes || 'â€“'}
                                </td>
                              </tr>
                            );
                          })}
                      </tbody>
                    </table>
                  </div>
                )}

                {detail?.data && detail.data.time_entries.length === 0 && (
                  <p className="py-4 text-center text-sm text-gray-500">
                    No time entries for this period.
                  </p>
                )}

                {/* Submitted/approved timestamps */}
                {detail?.data && (
                  <div className="mt-4 flex flex-wrap gap-4 border-t border-gray-100 pt-3 text-xs text-gray-500">
                    {detail.data.submitted_at && (
                      <span>
                        Submitted: {new Date(detail.data.submitted_at).toLocaleDateString('en-AU', {
                          day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit',
                        })}
                      </span>
                    )}
                    {detail.data.approved_at && (
                      <span>
                        Approved: {new Date(detail.data.approved_at).toLocaleDateString('en-AU', {
                          day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit',
                        })}
                      </span>
                    )}
                    {detail.data.synced_at && (
                      <span>
                        Synced: {new Date(detail.data.synced_at).toLocaleDateString('en-AU', {
                          day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit',
                        })}
                      </span>
                    )}
                  </div>
                )}
              </div>
            )}
          </div>
        );
      })}
    </div>
  );
}


===== D:\.code\wattleos\src\components\domain\user\display-preferences-client.tsx =====

// src/components/domain/user/display-preferences-client.tsx
//
// ============================================================
// WattleOS V2 â€” User Display Preferences Form
// ============================================================
// Allows any authenticated user to override theme, density,
// and font scale for their personal experience.
//
// WHY separate from admin appearance:
//   Admin sets school-wide defaults. User overrides are personal.
//   A user picking "compact + dark" doesn't affect other staff.
//
// LIVE PREVIEW: Changes apply to DOM immediately. On save,
// the server action persists to DB and refreshes the cookie.
// ============================================================

"use client";

import { updateUserDisplayPreferences } from "@/lib/actions/display-settings";
import {
  type DensityMode,
  type ThemeMode,
  type UserDisplayPreferences,
  DENSITY_OPTIONS,
  FONT_SCALE_OPTIONS,
  THEME_OPTIONS,
} from "@/types/display";
import { useCallback, useState, useTransition } from "react";

interface DisplayPreferencesClientProps {
  initialPreferences: UserDisplayPreferences;
  tenantDefaultDensity: DensityMode;
  tenantDefaultTheme: ThemeMode;
}

export function DisplayPreferencesClient({
  initialPreferences,
  tenantDefaultDensity,
  tenantDefaultTheme,
}: DisplayPreferencesClientProps) {
  const [prefs, setPrefs] =
    useState<UserDisplayPreferences>(initialPreferences);
  const [isPending, startTransition] = useTransition();
  const [saveStatus, setSaveStatus] = useState<"idle" | "saved" | "error">(
    "idle",
  );

  // ---- Live preview ----

  const applyPreview = useCallback(
    (updated: UserDisplayPreferences) => {
      const html = document.documentElement;

      // Theme
      const effectiveTheme = updated.theme ?? tenantDefaultTheme;
      if (effectiveTheme === "dark") {
        html.classList.add("dark");
      } else if (effectiveTheme === "light") {
        html.classList.remove("dark");
      } else {
        // system: check OS preference
        if (window.matchMedia("(prefers-color-scheme: dark)").matches) {
          html.classList.add("dark");
        } else {
          html.classList.remove("dark");
        }
      }

      // Density
      html.dataset.density = updated.density ?? tenantDefaultDensity;

      // Font scale
      html.dataset.fontScale = updated.fontScale ?? "base";
    },
    [tenantDefaultDensity, tenantDefaultTheme],
  );

  const updateField = <K extends keyof UserDisplayPreferences>(
    key: K,
    value: UserDisplayPreferences[K],
  ) => {
    const updated = { ...prefs, [key]: value };
    setPrefs(updated);
    applyPreview(updated);
    setSaveStatus("idle");
  };

  // ---- Save ----

  const handleSave = () => {
    startTransition(async () => {
      const result = await updateUserDisplayPreferences(prefs);
      if (result.error) {
        setSaveStatus("error");
      } else {
        setSaveStatus("saved");
        // Reload to pick up fresh cookie in root layout
        setTimeout(() => window.location.reload(), 800);
      }
    });
  };

  // Effective values (for showing "using school default" state)
  const effectiveTheme = prefs.theme ?? tenantDefaultTheme;
  const effectiveDensity = prefs.density ?? tenantDefaultDensity;

  return (
    <div className="space-y-[var(--density-section-gap)] max-w-[var(--content-narrow-width)]">
      {/* ---- Theme ---- */}
      <section className="rounded-lg border border-border bg-card p-[var(--density-card-padding)]">
        <h2 className="text-[var(--text-lg)] font-semibold text-foreground">
          Theme
        </h2>
        <p className="mt-1 text-[var(--text-sm)] text-muted-foreground">
          Choose light, dark, or follow your device settings.
          {prefs.theme === null && (
            <span className="ml-1 text-[var(--text-xs)] italic">
              (Currently using school default: {tenantDefaultTheme})
            </span>
          )}
        </p>

        <div className="mt-4 flex flex-wrap gap-[var(--density-sm)]">
          {/* "Use school default" option */}
          <ThemeButton
            label={`School Default (${tenantDefaultTheme})`}
            isSelected={prefs.theme === null}
            onClick={() => updateField("theme", null)}
            icon={<SchoolIcon />}
          />

          {THEME_OPTIONS.map((option) => (
            <ThemeButton
              key={option.value}
              label={option.label}
              isSelected={prefs.theme === option.value}
              onClick={() => updateField("theme", option.value)}
              icon={<ThemeIcon mode={option.value} />}
            />
          ))}
        </div>
      </section>

      {/* ---- Density ---- */}
      <section className="rounded-lg border border-border bg-card p-[var(--density-card-padding)]">
        <h2 className="text-[var(--text-lg)] font-semibold text-foreground">
          Layout Density
        </h2>
        <p className="mt-1 text-[var(--text-sm)] text-muted-foreground">
          How much space between elements. Compact fits more on screen; spacious
          is easier on the eyes and better for touch.
          {prefs.density === null && (
            <span className="ml-1 text-[var(--text-xs)] italic">
              (Currently using school default: {tenantDefaultDensity})
            </span>
          )}
        </p>

        <div className="mt-4 space-y-[var(--density-sm)]">
          {/* School default option */}
          <DensityOption
            label={`School Default (${tenantDefaultDensity})`}
            description="Use the default set by your school administrator"
            isSelected={prefs.density === null}
            onSelect={() => updateField("density", null)}
          />

          {DENSITY_OPTIONS.map((option) => (
            <DensityOption
              key={option.value}
              label={option.label}
              description={option.description}
              isSelected={prefs.density === option.value}
              onSelect={() => updateField("density", option.value)}
            />
          ))}
        </div>
      </section>

      {/* ---- Font Scale ---- */}
      <section className="rounded-lg border border-border bg-card p-[var(--density-card-padding)]">
        <h2 className="text-[var(--text-lg)] font-semibold text-foreground">
          Text Size
        </h2>
        <p className="mt-1 text-[var(--text-sm)] text-muted-foreground">
          Scale all text up or down across the platform.
        </p>

        <div className="mt-4 flex flex-wrap gap-[var(--density-sm)]">
          {FONT_SCALE_OPTIONS.map((option) => (
            <button
              key={option.value}
              type="button"
              onClick={() =>
                updateField(
                  "fontScale",
                  option.value === "base" ? null : option.value,
                )
              }
              className={`
                rounded-lg border px-4 py-2 transition-all
                ${
                  (prefs.fontScale ?? "base") === option.value
                    ? "border-primary bg-primary/10 text-foreground font-semibold"
                    : "border-border bg-card text-muted-foreground hover:border-primary/50"
                }
              `}
              style={{
                fontSize: `calc(var(--text-sm) * ${
                  option.value === "sm"
                    ? 0.9
                    : option.value === "base"
                      ? 1
                      : option.value === "lg"
                        ? 1.1
                        : 1.2
                })`,
              }}
            >
              {option.label}
            </button>
          ))}
        </div>

        {/* Preview text */}
        <div className="mt-4 rounded-md border border-border/50 bg-muted/30 p-3">
          <p className="text-[var(--text-sm)] text-muted-foreground">
            Preview: This is how text will appear across WattleOS with your
            current settings.
          </p>
        </div>
      </section>

      {/* ---- Save ---- */}
      <div className="flex items-center gap-4">
        <button
          type="button"
          onClick={handleSave}
          disabled={isPending}
          className={`
            rounded-lg bg-primary px-6 py-2.5 text-[var(--text-sm)] font-semibold
            text-primary-foreground shadow-sm transition-all
            hover:opacity-90 disabled:opacity-50
          `}
        >
          {isPending ? "Savingâ€¦" : "Save Preferences"}
        </button>

        {saveStatus === "saved" && (
          <span className="text-[var(--text-sm)] text-success animate-fade-in">
            Saved! Reloadingâ€¦
          </span>
        )}
        {saveStatus === "error" && (
          <span className="text-[var(--text-sm)] text-destructive animate-fade-in">
            Failed to save. Please try again.
          </span>
        )}
      </div>
    </div>
  );
}

// ============================================================
// Sub-components
// ============================================================

function ThemeButton({
  label,
  isSelected,
  onClick,
  icon,
}: {
  label: string;
  isSelected: boolean;
  onClick: () => void;
  icon: React.ReactNode;
}) {
  return (
    <button
      type="button"
      onClick={onClick}
      className={`
        flex items-center gap-2 rounded-lg border px-4 py-2 text-[var(--text-sm)] font-medium transition-all
        ${
          isSelected
            ? "border-primary bg-primary/10 text-foreground"
            : "border-border bg-card text-muted-foreground hover:border-primary/50"
        }
      `}
    >
      {icon}
      {label}
    </button>
  );
}

function DensityOption({
  label,
  description,
  isSelected,
  onSelect,
}: {
  label: string;
  description: string;
  isSelected: boolean;
  onSelect: () => void;
}) {
  return (
    <button
      type="button"
      onClick={onSelect}
      className={`
        flex w-full items-start gap-3 rounded-lg border p-3 text-left transition-all
        ${
          isSelected
            ? "border-primary bg-primary/5"
            : "border-border bg-card hover:border-primary/50"
        }
      `}
    >
      <div
        className={`
          mt-0.5 h-4 w-4 shrink-0 rounded-full border-2 transition-colors
          ${isSelected ? "border-primary bg-primary" : "border-muted-foreground/40"}
        `}
      >
        {isSelected && (
          <div className="m-auto mt-0.5 h-1.5 w-1.5 rounded-full bg-primary-foreground" />
        )}
      </div>
      <div>
        <span className="block text-[var(--text-sm)] font-medium text-foreground">
          {label}
        </span>
        <span className="block text-[var(--text-xs)] text-muted-foreground">
          {description}
        </span>
      </div>
    </button>
  );
}

function ThemeIcon({ mode }: { mode: ThemeMode }) {
  if (mode === "light") {
    return (
      <svg
        className="h-4 w-4"
        fill="none"
        viewBox="0 0 24 24"
        strokeWidth={1.5}
        stroke="currentColor"
      >
        <path
          strokeLinecap="round"
          strokeLinejoin="round"
          d="M12 3v2.25m6.364.386-1.591 1.591M21 12h-2.25m-.386 6.364-1.591-1.591M12 18.75V21m-4.773-4.227-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0Z"
        />
      </svg>
    );
  }
  if (mode === "dark") {
    return (
      <svg
        className="h-4 w-4"
        fill="none"
        viewBox="0 0 24 24"
        strokeWidth={1.5}
        stroke="currentColor"
      >
        <path
          strokeLinecap="round"
          strokeLinejoin="round"
          d="M21.752 15.002A9.72 9.72 0 0 1 18 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 0 0 3 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 0 0 9.002-5.998Z"
        />
      </svg>
    );
  }
  return (
    <svg
      className="h-4 w-4"
      fill="none"
      viewBox="0 0 24 24"
      strokeWidth={1.5}
      stroke="currentColor"
    >
      <path
        strokeLinecap="round"
        strokeLinejoin="round"
        d="M9 17.25v1.007a3 3 0 0 1-.879 2.122L7.5 21h9l-.621-.621A3 3 0 0 1 15 18.257V17.25m6-12V15a2.25 2.25 0 0 1-2.25 2.25H5.25A2.25 2.25 0 0 1 3 15V5.25m18 0A2.25 2.25 0 0 0 18.75 3H5.25A2.25 2.25 0 0 0 3 5.25m18 0V12a2.25 2.25 0 0 1-2.25 2.25H5.25A2.25 2.25 0 0 1 3 12V5.25"
      />
    </svg>
  );
}

function SchoolIcon() {
  return (
    <svg
      className="h-4 w-4"
      fill="none"
      viewBox="0 0 24 24"
      strokeWidth={1.5}
      stroke="currentColor"
    >
      <path
        strokeLinecap="round"
        strokeLinejoin="round"
        d="M4.26 10.147a60.438 60.438 0 0 0-.491 6.347A48.62 48.62 0 0 1 12 20.904a48.62 48.62 0 0 1 8.232-4.41 60.46 60.46 0 0 0-.491-6.347m-15.482 0a50.636 50.636 0 0 0-2.658-.813A59.906 59.906 0 0 1 12 3.493a59.903 59.903 0 0 1 10.399 5.84c-.896.248-1.783.52-2.658.814m-15.482 0A50.717 50.717 0 0 1 12 13.489a50.702 50.702 0 0 1 7.74-3.342M6.75 15a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5Zm0 0v-3.675A55.378 55.378 0 0 1 12 8.443m-7.007 11.55A5.981 5.981 0 0 0 6.75 15.75v-1.5"
      />
    </svg>
  );
}



===== D:\.code\wattleos\src\lib\actions\announcements.ts =====

// src/lib/actions/announcements.ts
//
// ============================================================
// WattleOS V2 â€” Announcement Server Actions
// ============================================================
// Handles school-wide and class-targeted announcements.
// Staff create/manage, parents view. Read receipts tracked
// for engagement visibility.
//
// WHY server actions not API routes: Matches WattleOS pattern.
// Server Actions are co-located, type-safe, and don't need
// a separate API layer for internal mutations.
// ============================================================

'use server';

import { createSupabaseServerClient } from '@/lib/supabase/server';
import { getTenantContext, requirePermission } from '@/lib/auth/tenant-context';
import { Permissions } from '@/lib/constants/permissions';
import { ActionResponse, success, failure, ErrorCodes } from '@/types/api';
import type {
  Announcement,
  AnnouncementWithAuthor,
  AnnouncementRead,
  User,
  Class,
} from '@/types/domain';
import type { AnnouncementPriority, AnnouncementTargetType } from '@/lib/constants/communications';

// ============================================================
// Input Types
// ============================================================

export interface CreateAnnouncementInput {
  title: string;
  content: string;
  priority: AnnouncementPriority;
  target_type: AnnouncementTargetType;
  target_class_id?: string | null;
  is_pinned?: boolean;
}

export interface UpdateAnnouncementInput {
  title?: string;
  content?: string;
  priority?: AnnouncementPriority;
  is_pinned?: boolean;
}

export interface ListAnnouncementsParams {
  target_class_id?: string;
  priority?: AnnouncementPriority;
  pinned_only?: boolean;
  limit?: number;
  offset?: number;
}

// ============================================================
// CREATE ANNOUNCEMENT
// ============================================================
// Permission: SEND_ANNOUNCEMENTS
// Sets published_at to now() â€” announcements go live immediately.
// ============================================================

export async function createAnnouncement(
  input: CreateAnnouncementInput
): Promise<ActionResponse<Announcement>> {
  try {
    const context = await requirePermission(Permissions.SEND_ANNOUNCEMENTS);
    const supabase = await createSupabaseServerClient();

    if (!input.title.trim()) {
      return failure('Title is required', ErrorCodes.VALIDATION_ERROR);
    }
    if (!input.content.trim()) {
      return failure('Content is required', ErrorCodes.VALIDATION_ERROR);
    }
    if (input.target_type === 'class' && !input.target_class_id) {
      return failure(
        'A target class must be selected for class-targeted announcements',
        ErrorCodes.VALIDATION_ERROR
      );
    }

    const { data, error } = await supabase
      .from('announcements')
      .insert({
        tenant_id: context.tenant.id,
        author_id: context.user.id,
        title: input.title.trim(),
        content: input.content.trim(),
        priority: input.priority,
        target_type: input.target_type,
        target_class_id: input.target_type === 'class' ? input.target_class_id : null,
        is_pinned: input.is_pinned ?? false,
        published_at: new Date().toISOString(),
      })
      .select()
      .single();

    if (error) {
      return failure(error.message, ErrorCodes.CREATE_FAILED);
    }

    return success(data as Announcement);
  } catch (err) {
    const message = err instanceof Error ? err.message : 'Failed to create announcement';
    return failure(message, ErrorCodes.INTERNAL_ERROR);
  }
}

// ============================================================
// UPDATE ANNOUNCEMENT
// ============================================================

export async function updateAnnouncement(
  announcementId: string,
  input: UpdateAnnouncementInput
): Promise<ActionResponse<Announcement>> {
  try {
    await requirePermission(Permissions.SEND_ANNOUNCEMENTS);
    const supabase = await createSupabaseServerClient();

    const updateData: Record<string, unknown> = {};
    if (input.title !== undefined) updateData.title = input.title.trim();
    if (input.content !== undefined) updateData.content = input.content.trim();
    if (input.priority !== undefined) updateData.priority = input.priority;
    if (input.is_pinned !== undefined) updateData.is_pinned = input.is_pinned;

    if (Object.keys(updateData).length === 0) {
      return failure('No fields to update', ErrorCodes.VALIDATION_ERROR);
    }

    const { data, error } = await supabase
      .from('announcements')
      .update(updateData)
      .eq('id', announcementId)
      .is('deleted_at', null)
      .select()
      .single();

    if (error) {
      return failure(error.message, ErrorCodes.UPDATE_FAILED);
    }

    return success(data as Announcement);
  } catch (err) {
    const message = err instanceof Error ? err.message : 'Failed to update announcement';
    return failure(message, ErrorCodes.INTERNAL_ERROR);
  }
}

// ============================================================
// DELETE ANNOUNCEMENT (soft delete)
// ============================================================

export async function deleteAnnouncement(
  announcementId: string
): Promise<ActionResponse<{ deleted: boolean }>> {
  try {
    await requirePermission(Permissions.SEND_ANNOUNCEMENTS);
    const supabase = await createSupabaseServerClient();

    const { error } = await supabase
      .from('announcements')
      .update({ deleted_at: new Date().toISOString() })
      .eq('id', announcementId)
      .is('deleted_at', null);

    if (error) {
      return failure(error.message, ErrorCodes.DELETE_FAILED);
    }

    return success({ deleted: true });
  } catch (err) {
    const message = err instanceof Error ? err.message : 'Failed to delete announcement';
    return failure(message, ErrorCodes.INTERNAL_ERROR);
  }
}

// ============================================================
// LIST ANNOUNCEMENTS (Staff view)
// ============================================================
// Returns all announcements with author info, read counts,
// ordered by pinned first, then published_at descending.
// Permission: SEND_ANNOUNCEMENTS
// ============================================================

export async function listAnnouncements(
  params: ListAnnouncementsParams = {}
): Promise<ActionResponse<AnnouncementWithAuthor[]>> {
  try {
    await requirePermission(Permissions.SEND_ANNOUNCEMENTS);
    const supabase = await createSupabaseServerClient();

    const limit = params.limit ?? 50;
    const offset = params.offset ?? 0;

    let query = supabase
      .from('announcements')
      .select(
        `
        *,
        author:users!announcements_author_id_fkey(id, first_name, last_name, avatar_url),
        target_class:classes!announcements_target_class_id_fkey(id, name),
        announcement_reads(id)
      `
      )
      .is('deleted_at', null)
      .order('is_pinned', { ascending: false })
      .order('published_at', { ascending: false })
      .range(offset, offset + limit - 1);

    if (params.target_class_id) {
      query = query.eq('target_class_id', params.target_class_id);
    }
    if (params.priority) {
      query = query.eq('priority', params.priority);
    }
    if (params.pinned_only) {
      query = query.eq('is_pinned', true);
    }

    const { data, error } = await query;

    if (error) {
      return failure(error.message, ErrorCodes.DATABASE_ERROR);
    }

    const announcements: AnnouncementWithAuthor[] = ((data ?? []) as Array<Record<string, unknown>>).map(
      (row) => {
        const author = row.author as Pick<User, 'id' | 'first_name' | 'last_name' | 'avatar_url'>;
        const target_class = row.target_class as Pick<Class, 'id' | 'name'> | null;
        const reads = row.announcement_reads as Array<{ id: string }> | null;

        return {
          id: row.id as string,
          tenant_id: row.tenant_id as string,
          author_id: row.author_id as string,
          title: row.title as string,
          content: row.content as string,
          priority: row.priority as AnnouncementPriority,
          target_type: row.target_type as AnnouncementTargetType,
          target_class_id: row.target_class_id as string | null,
          is_pinned: row.is_pinned as boolean,
          published_at: row.published_at as string,
          created_at: row.created_at as string,
          updated_at: row.updated_at as string,
          author,
          target_class,
          read_count: reads?.length ?? 0,
        };
      }
    );

    return success(announcements);
  } catch (err) {
    const message = err instanceof Error ? err.message : 'Failed to list announcements';
    return failure(message, ErrorCodes.INTERNAL_ERROR);
  }
}

// ============================================================
// GET ANNOUNCEMENTS FOR PARENT
// ============================================================
// Returns announcements visible to the current parent:
// â€¢ All school-wide announcements
// â€¢ Class-targeted announcements for classes their children attend
// Includes is_read flag per announcement.
// No permission check â€” available to all authenticated users.
// ============================================================

export async function getAnnouncementsForParent(
  params: { limit?: number; offset?: number } = {}
): Promise<ActionResponse<AnnouncementWithAuthor[]>> {
  try {
    const context = await getTenantContext();
    const supabase = await createSupabaseServerClient();

    const limit = params.limit ?? 30;
    const offset = params.offset ?? 0;

    // Get classes the parent's children are enrolled in
    const { data: guardianships } = await supabase
      .from('guardians')
      .select('student_id')
      .eq('user_id', context.user.id)
      .is('deleted_at', null);

    const studentIds = (guardianships ?? []).map(
      (g) => (g as { student_id: string }).student_id
    );

    let classIds: string[] = [];
    if (studentIds.length > 0) {
      const { data: enrollments } = await supabase
        .from('enrollments')
        .select('class_id')
        .in('student_id', studentIds)
        .eq('status', 'active')
        .is('deleted_at', null);

      classIds = [
        ...new Set(
          (enrollments ?? []).map((e) => (e as { class_id: string }).class_id)
        ),
      ];
    }

    // Fetch announcements: school-wide OR targeting one of the parent's classes
    let query = supabase
      .from('announcements')
      .select(
        `
        *,
        author:users!announcements_author_id_fkey(id, first_name, last_name, avatar_url),
        target_class:classes!announcements_target_class_id_fkey(id, name)
      `
      )
      .is('deleted_at', null)
      .order('is_pinned', { ascending: false })
      .order('published_at', { ascending: false })
      .range(offset, offset + limit - 1);

    if (classIds.length > 0) {
      // school-wide OR class-targeted for parent's classes
      query = query.or(
        `target_type.eq.school_wide,target_class_id.in.(${classIds.join(',')})`
      );
    } else {
      // No children enrolled â€” only school-wide
      query = query.eq('target_type', 'school_wide');
    }

    const { data, error } = await query;

    if (error) {
      return failure(error.message, ErrorCodes.DATABASE_ERROR);
    }

    // Get read status for current user
    const announcementIds = ((data ?? []) as Array<{ id: string }>).map((a) => a.id);
    let readSet = new Set<string>();

    if (announcementIds.length > 0) {
      const { data: reads } = await supabase
        .from('announcement_reads')
        .select('announcement_id')
        .eq('user_id', context.user.id)
        .in('announcement_id', announcementIds);

      readSet = new Set(
        (reads ?? []).map(
          (r) => (r as { announcement_id: string }).announcement_id
        )
      );
    }

    const announcements: AnnouncementWithAuthor[] = ((data ?? []) as Array<Record<string, unknown>>).map(
      (row) => ({
        id: row.id as string,
        tenant_id: row.tenant_id as string,
        author_id: row.author_id as string,
        title: row.title as string,
        content: row.content as string,
        priority: row.priority as AnnouncementPriority,
        target_type: row.target_type as AnnouncementTargetType,
        target_class_id: row.target_class_id as string | null,
        is_pinned: row.is_pinned as boolean,
        published_at: row.published_at as string,
        created_at: row.created_at as string,
        updated_at: row.updated_at as string,
        author: row.author as Pick<User, 'id' | 'first_name' | 'last_name' | 'avatar_url'>,
        target_class: row.target_class as Pick<Class, 'id' | 'name'> | null,
        is_read: readSet.has(row.id as string),
      })
    );

    return success(announcements);
  } catch (err) {
    const message = err instanceof Error ? err.message : 'Failed to get announcements';
    return failure(message, ErrorCodes.INTERNAL_ERROR);
  }
}

// ============================================================
// MARK ANNOUNCEMENT AS READ
// ============================================================
// Creates a read receipt. Idempotent â€” upserts on the
// unique(announcement_id, user_id) constraint.
// ============================================================

export async function markAnnouncementRead(
  announcementId: string
): Promise<ActionResponse<AnnouncementRead>> {
  try {
    const context = await getTenantContext();
    const supabase = await createSupabaseServerClient();

    const { data, error } = await supabase
      .from('announcement_reads')
      .upsert(
        {
          tenant_id: context.tenant.id,
          announcement_id: announcementId,
          user_id: context.user.id,
          read_at: new Date().toISOString(),
        },
        { onConflict: 'announcement_id,user_id' }
      )
      .select()
      .single();

    if (error) {
      return failure(error.message, ErrorCodes.DATABASE_ERROR);
    }

    return success(data as AnnouncementRead);
  } catch (err) {
    const message = err instanceof Error ? err.message : 'Failed to mark as read';
    return failure(message, ErrorCodes.INTERNAL_ERROR);
  }
}

// ============================================================
// GET UNREAD ANNOUNCEMENT COUNT
// ============================================================
// Used for sidebar notification badge. Counts announcements
// visible to the current user that they haven't read yet.
// ============================================================

export async function getUnreadAnnouncementCount(): Promise<ActionResponse<number>> {
  try {
    const context = await getTenantContext();
    const supabase = await createSupabaseServerClient();

    // Get parent's class IDs (same logic as getAnnouncementsForParent)
    const { data: guardianships } = await supabase
      .from('guardians')
      .select('student_id')
      .eq('user_id', context.user.id)
      .is('deleted_at', null);

    const studentIds = (guardianships ?? []).map(
      (g) => (g as { student_id: string }).student_id
    );

    let classIds: string[] = [];
    if (studentIds.length > 0) {
      const { data: enrollments } = await supabase
        .from('enrollments')
        .select('class_id')
        .in('student_id', studentIds)
        .eq('status', 'active')
        .is('deleted_at', null);

      classIds = [
        ...new Set(
          (enrollments ?? []).map((e) => (e as { class_id: string }).class_id)
        ),
      ];
    }

    // Count visible announcements
    let announcementQuery = supabase
      .from('announcements')
      .select('id')
      .is('deleted_at', null);

    if (classIds.length > 0) {
      announcementQuery = announcementQuery.or(
        `target_type.eq.school_wide,target_class_id.in.(${classIds.join(',')})`
      );
    } else {
      announcementQuery = announcementQuery.eq('target_type', 'school_wide');
    }

    const { data: allAnnouncements } = await announcementQuery;
    const allIds = ((allAnnouncements ?? []) as Array<{ id: string }>).map((a) => a.id);

    if (allIds.length === 0) {
      return success(0);
    }

    // Count which ones are read
    const { data: reads } = await supabase
      .from('announcement_reads')
      .select('announcement_id')
      .eq('user_id', context.user.id)
      .in('announcement_id', allIds);

    const readSet = new Set(
      (reads ?? []).map(
        (r) => (r as { announcement_id: string }).announcement_id
      )
    );

    const unreadCount = allIds.filter((id) => !readSet.has(id)).length;

    return success(unreadCount);
  } catch (err) {
    const message = err instanceof Error ? err.message : 'Failed to get unread count';
    return failure(message, ErrorCodes.INTERNAL_ERROR);
  }
}

// ============================================================
// GET ANNOUNCEMENT READ STATS
// ============================================================
// For staff view: how many users have read a specific
// announcement. Returns count and list of readers.
// Permission: SEND_ANNOUNCEMENTS
// ============================================================

export async function getAnnouncementReadStats(
  announcementId: string
): Promise<ActionResponse<{ total_reads: number; readers: Array<Pick<User, 'id' | 'first_name' | 'last_name'> & { read_at: string }> }>> {
  try {
    await requirePermission(Permissions.SEND_ANNOUNCEMENTS);
    const supabase = await createSupabaseServerClient();

    const { data, error } = await supabase
      .from('announcement_reads')
      .select(
        `
        read_at,
        user:users!announcement_reads_user_id_fkey(id, first_name, last_name)
      `
      )
      .eq('announcement_id', announcementId)
      .order('read_at', { ascending: false });

    if (error) {
      return failure(error.message, ErrorCodes.DATABASE_ERROR);
    }

    const readers = ((data ?? []) as Array<Record<string, unknown>>).map((row) => ({
      ...(row.user as Pick<User, 'id' | 'first_name' | 'last_name'>),
      read_at: row.read_at as string,
    }));

    return success({
      total_reads: readers.length,
      readers,
    });
  } catch (err) {
    const message = err instanceof Error ? err.message : 'Failed to get read stats';
    return failure(message, ErrorCodes.INTERNAL_ERROR);
  }
}


===== D:\.code\wattleos\src\lib\actions\attendance.ts =====

// src/lib/actions/attendance.ts
//
// ============================================================
// WattleOS V2 â€” Attendance Server Actions
// ============================================================
// All attendance mutations and queries. Uses upsert pattern
// for markAttendance since there's a UNIQUE(tenant_id, student_id, date)
// constraint â€” marking the same student twice on the same day
// updates the existing record rather than failing.
//
// WHY upsert: Roll call is a "tap to toggle" UI. The guide taps
// Present, then realizes the student is Late, and taps again.
// Upsert makes this idempotent without requiring the UI to know
// if a record already exists.
// ============================================================

'use server';

import { createSupabaseServerClient } from '@/lib/supabase/server';
import { getTenantContext, requirePermission } from '@/lib/auth/tenant-context';
import { Permissions } from '@/lib/constants/permissions';
import { ActionResponse, PaginatedResponse, success, failure } from '@/types/api';
import type { AttendanceRecord, AttendanceStatus, Student } from '@/types/domain';

// ============================================================
// Input Types
// ============================================================

export interface MarkAttendanceInput {
  studentId: string;
  classId?: string;
  date: string; // ISO date string YYYY-MM-DD
  status: AttendanceStatus;
  checkInAt?: string | null;
  checkOutAt?: string | null;
  notes?: string | null;
}

export interface BulkMarkAttendanceInput {
  classId: string;
  date: string; // ISO date string YYYY-MM-DD
  records: Array<{
    studentId: string;
    status: AttendanceStatus;
    notes?: string | null;
  }>;
}

// ============================================================
// Compound types for UI
// ============================================================

/** Student row enriched with their attendance status for a given date */
export interface StudentAttendanceRow {
  student: Pick<Student, 'id' | 'first_name' | 'last_name' | 'preferred_name' | 'photo_url'>;
  record: AttendanceRecord | null;
  /** Critical medical conditions surfaced in roll call */
  medicalAlerts: Array<{
    condition_name: string;
    severity: string;
  }>;
}

/** Daily summary stats */
export interface AttendanceDaySummary {
  date: string;
  total: number;
  present: number;
  absent: number;
  late: number;
  excused: number;
  half_day: number;
}

/** Absence report row */
export interface AbsenceReportRow {
  student: Pick<Student, 'id' | 'first_name' | 'last_name' | 'preferred_name' | 'photo_url'>;
  date: string;
  status: AttendanceStatus;
  notes: string | null;
  hasExplanation: boolean;
}

// ============================================================
// MARK: Single student attendance (upsert)
// ============================================================

export async function markAttendance(
  input: MarkAttendanceInput
): Promise<ActionResponse<AttendanceRecord>> {
  try {
    const context = await requirePermission(Permissions.MANAGE_ATTENDANCE);
    const supabase = await createSupabaseServerClient();

    if (!input.studentId) return failure('Student is required', 'VALIDATION_ERROR');
    if (!input.date) return failure('Date is required', 'VALIDATION_ERROR');
    if (!input.status) return failure('Status is required', 'VALIDATION_ERROR');

    // Upsert: insert or update if record exists for this student+date
    const { data, error } = await supabase
      .from('attendance_records')
      .upsert(
        {
          tenant_id: context.tenant.id,
          student_id: input.studentId,
          class_id: input.classId ?? null,
          date: input.date,
          status: input.status,
          check_in_at: input.checkInAt ?? null,
          check_out_at: input.checkOutAt ?? null,
          notes: input.notes ?? null,
          recorded_by: context.user.id,
          deleted_at: null, // un-soft-delete if re-marking
        },
        {
          onConflict: 'tenant_id,student_id,date',
        }
      )
      .select()
      .single();

    if (error) {
      return failure(error.message, 'DB_ERROR');
    }

    return success(data as AttendanceRecord);
  } catch (err) {
    const message = err instanceof Error ? err.message : 'Failed to mark attendance';
    return failure(message, 'UNEXPECTED_ERROR');
  }
}

// ============================================================
// BULK MARK: Entire class for a date (roll call submit)
// ============================================================

export async function bulkMarkAttendance(
  input: BulkMarkAttendanceInput
): Promise<ActionResponse<{ marked: number; errors: number }>> {
  try {
    const context = await requirePermission(Permissions.MANAGE_ATTENDANCE);
    const supabase = await createSupabaseServerClient();

    if (!input.classId) return failure('Class is required', 'VALIDATION_ERROR');
    if (!input.date) return failure('Date is required', 'VALIDATION_ERROR');
    if (input.records.length === 0) return failure('No records to mark', 'VALIDATION_ERROR');

    const rows = input.records.map((r) => ({
      tenant_id: context.tenant.id,
      student_id: r.studentId,
      class_id: input.classId,
      date: input.date,
      status: r.status,
      notes: r.notes ?? null,
      recorded_by: context.user.id,
      deleted_at: null,
    }));

    const { data, error } = await supabase
      .from('attendance_records')
      .upsert(rows, {
        onConflict: 'tenant_id,student_id,date',
      })
      .select();

    if (error) {
      return failure(error.message, 'DB_ERROR');
    }

    return success({
      marked: data?.length ?? 0,
      errors: input.records.length - (data?.length ?? 0),
    });
  } catch (err) {
    const message = err instanceof Error ? err.message : 'Failed to bulk mark attendance';
    return failure(message, 'UNEXPECTED_ERROR');
  }
}

// ============================================================
// GET: Class attendance for a single date (roll call view)
// ============================================================
// Returns all actively enrolled students in the class, each
// paired with their attendance record (if any) for that date,
// plus any critical medical alerts.

export async function getClassAttendance(
  classId: string,
  date: string
): Promise<ActionResponse<StudentAttendanceRow[]>> {
  try {
    await requirePermission(Permissions.MANAGE_ATTENDANCE);
    const supabase = await createSupabaseServerClient();

    // 1. Get active enrollments for this class
    const { data: enrollments, error: enrollError } = await supabase
      .from('enrollments')
      .select('student_id, student:students(id, first_name, last_name, preferred_name, photo_url)')
      .eq('class_id', classId)
      .eq('status', 'active')
      .is('deleted_at', null);

    if (enrollError) {
      return failure(enrollError.message, 'DB_ERROR');
    }

    const studentRows = (enrollments ?? [])
      .filter((e) => (e as Record<string, unknown>).student)
      .map((e) => {
        const student = (e as Record<string, unknown>).student as Pick<
          Student,
          'id' | 'first_name' | 'last_name' | 'preferred_name' | 'photo_url'
        >;
        return { studentId: e.student_id as string, student };
      });

    if (studentRows.length === 0) {
      return success([]);
    }

    const studentIds = studentRows.map((s) => s.studentId);

    // 2. Get existing attendance records for these students on this date
    const { data: records, error: recError } = await supabase
      .from('attendance_records')
      .select('*')
      .eq('date', date)
      .in('student_id', studentIds)
      .is('deleted_at', null);

    if (recError) {
      return failure(recError.message, 'DB_ERROR');
    }

    const recordMap = new Map<string, AttendanceRecord>();
    for (const r of (records ?? []) as AttendanceRecord[]) {
      recordMap.set(r.student_id, r);
    }

    // 3. Get critical medical conditions (severe + life_threatening)
    const { data: medicals } = await supabase
      .from('medical_conditions')
      .select('student_id, condition_name, severity')
      .in('student_id', studentIds)
      .in('severity', ['severe', 'life_threatening'])
      .is('deleted_at', null);

    const medicalMap = new Map<string, Array<{ condition_name: string; severity: string }>>();
    for (const m of (medicals ?? []) as Array<{ student_id: string; condition_name: string; severity: string }>) {
      if (!medicalMap.has(m.student_id)) medicalMap.set(m.student_id, []);
      medicalMap.get(m.student_id)!.push({
        condition_name: m.condition_name,
        severity: m.severity,
      });
    }

    // 4. Assemble rows, sorted by last name
    const rows: StudentAttendanceRow[] = studentRows
      .map((s) => ({
        student: s.student,
        record: recordMap.get(s.studentId) ?? null,
        medicalAlerts: medicalMap.get(s.studentId) ?? [],
      }))
      .sort((a, b) =>
        a.student.last_name.localeCompare(b.student.last_name)
      );

    return success(rows);
  } catch (err) {
    const message = err instanceof Error ? err.message : 'Failed to get class attendance';
    return failure(message, 'UNEXPECTED_ERROR');
  }
}

// ============================================================
// GET: Student attendance history (paginated, date range)
// ============================================================

export async function getStudentAttendanceHistory(params: {
  studentId: string;
  startDate?: string;
  endDate?: string;
  page?: number;
  perPage?: number;
}): Promise<PaginatedResponse<AttendanceRecord>> {
  try {
    await getTenantContext(); // RLS handles parent vs staff access
    const supabase = await createSupabaseServerClient();

    const page = params.page ?? 1;
    const perPage = params.perPage ?? 30;
    const from = (page - 1) * perPage;
    const to = from + perPage - 1;

    let countQuery = supabase
      .from('attendance_records')
      .select('*', { count: 'exact', head: true })
      .eq('student_id', params.studentId)
      .is('deleted_at', null);

    let dataQuery = supabase
      .from('attendance_records')
      .select('*')
      .eq('student_id', params.studentId)
      .is('deleted_at', null)
      .order('date', { ascending: false })
      .range(from, to);

    if (params.startDate) {
      countQuery = countQuery.gte('date', params.startDate);
      dataQuery = dataQuery.gte('date', params.startDate);
    }
    if (params.endDate) {
      countQuery = countQuery.lte('date', params.endDate);
      dataQuery = dataQuery.lte('date', params.endDate);
    }

    const { count, error: countError } = await countQuery;
    if (countError) {
      return {
        data: [],
        pagination: { total: 0, page, per_page: perPage, total_pages: 0 },
        error: { message: countError.message, code: 'DB_ERROR' },
      };
    }

    const { data, error: dataError } = await dataQuery;
    if (dataError) {
      return {
        data: [],
        pagination: { total: 0, page, per_page: perPage, total_pages: 0 },
        error: { message: dataError.message, code: 'DB_ERROR' },
      };
    }

    return {
      data: (data ?? []) as AttendanceRecord[],
      pagination: {
        total: count ?? 0,
        page,
        per_page: perPage,
        total_pages: Math.ceil((count ?? 0) / perPage),
      },
      error: null,
    };
  } catch (err) {
    const message = err instanceof Error ? err.message : 'Failed to get attendance history';
    return {
      data: [],
      pagination: { total: 0, page: 1, per_page: 30, total_pages: 0 },
      error: { message, code: 'UNEXPECTED_ERROR' },
    };
  }
}

// ============================================================
// GET: Attendance summary for a class over a date range
// ============================================================

export async function getAttendanceSummary(params: {
  classId: string;
  startDate: string;
  endDate: string;
}): Promise<ActionResponse<AttendanceDaySummary[]>> {
  try {
    await requirePermission(Permissions.MANAGE_ATTENDANCE);
    const supabase = await createSupabaseServerClient();

    const { data, error } = await supabase
      .from('attendance_records')
      .select('date, status')
      .eq('class_id', params.classId)
      .gte('date', params.startDate)
      .lte('date', params.endDate)
      .is('deleted_at', null);

    if (error) {
      return failure(error.message, 'DB_ERROR');
    }

    // Aggregate by date
    const dayMap = new Map<string, AttendanceDaySummary>();

    type AttendanceCountKey = Exclude<keyof AttendanceDaySummary, "date" | "total">;

const isAttendanceCountKey = (v: string): v is AttendanceCountKey =>
  v === "present" ||
  v === "absent" ||
  v === "late" ||
  v === "excused" ||
  v === "half_day";

    for (const row of (data ?? []) as Array<{ date: string; status: string }>) {
  if (!dayMap.has(row.date)) {
    dayMap.set(row.date, {
      date: row.date,
      total: 0,
      present: 0,
      absent: 0,
      late: 0,
      excused: 0,
      half_day: 0,
    });
  }

  const summary = dayMap.get(row.date)!;
  summary.total += 1;

  if (isAttendanceCountKey(row.status)) {
    summary[row.status] += 1;
  }
}

    // Sort by date descending
    const summaries = Array.from(dayMap.values()).sort(
      (a, b) => b.date.localeCompare(a.date)
    );

    return success(summaries);
  } catch (err) {
    const message = err instanceof Error ? err.message : 'Failed to get attendance summary';
    return failure(message, 'UNEXPECTED_ERROR');
  }
}

// ============================================================
// GET: Absence report (unexplained absences)
// ============================================================

export async function getAbsenceReport(params: {
  classId?: string;
  startDate: string;
  endDate: string;
  unexplainedOnly?: boolean;
}): Promise<ActionResponse<AbsenceReportRow[]>> {
  try {
    await requirePermission(Permissions.VIEW_ATTENDANCE_REPORTS);
    const supabase = await createSupabaseServerClient();

    let query = supabase
      .from('attendance_records')
      .select('*, student:students(id, first_name, last_name, preferred_name, photo_url)')
      .in('status', ['absent', 'late'])
      .gte('date', params.startDate)
      .lte('date', params.endDate)
      .is('deleted_at', null)
      .order('date', { ascending: false });

    if (params.classId) {
      query = query.eq('class_id', params.classId);
    }

    const { data, error } = await query;

    if (error) {
      return failure(error.message, 'DB_ERROR');
    }

    let rows: AbsenceReportRow[] = ((data ?? []) as Array<Record<string, unknown>>)
      .filter((r) => r.student)
      .map((r) => ({
        student: r.student as Pick<Student, 'id' | 'first_name' | 'last_name' | 'preferred_name' | 'photo_url'>,
        date: r.date as string,
        status: r.status as AttendanceStatus,
        notes: (r.notes as string) ?? null,
        hasExplanation: !!(r.notes as string | null)?.trim(),
      }));

    if (params.unexplainedOnly) {
      rows = rows.filter((r) => !r.hasExplanation);
    }

    return success(rows);
  } catch (err) {
    const message = err instanceof Error ? err.message : 'Failed to get absence report';
    return failure(message, 'UNEXPECTED_ERROR');
  }
}

// ============================================================
// CHECK IN / CHECK OUT helpers
// ============================================================

export async function checkInStudent(
  studentId: string,
  date: string
): Promise<ActionResponse<AttendanceRecord>> {
  return markAttendance({
    studentId,
    date,
    status: 'present',
    checkInAt: new Date().toISOString(),
  });
}

export async function checkOutStudent(
  studentId: string,
  date: string
): Promise<ActionResponse<AttendanceRecord>> {
  try {
    const context = await requirePermission(Permissions.MANAGE_ATTENDANCE);
    const supabase = await createSupabaseServerClient();

    // Find existing record for today
    const { data: existing, error: findError } = await supabase
      .from('attendance_records')
      .select('*')
      .eq('student_id', studentId)
      .eq('date', date)
      .is('deleted_at', null)
      .single();

    if (findError || !existing) {
      return failure('No attendance record found for this student today', 'NOT_FOUND');
    }

    const { data, error } = await supabase
      .from('attendance_records')
      .update({
        check_out_at: new Date().toISOString(),
        recorded_by: context.user.id,
      })
      .eq('id', (existing as AttendanceRecord).id)
      .select()
      .single();

    if (error) {
      return failure(error.message, 'DB_ERROR');
    }

    return success(data as AttendanceRecord);
  } catch (err) {
    const message = err instanceof Error ? err.message : 'Failed to check out student';
    return failure(message, 'UNEXPECTED_ERROR');
  }
} 


===== D:\.code\wattleos\src\lib\actions\auth.ts =====

'use server';

import { createSupabaseServerClient } from '@/lib/supabase/server';
import { setUserTenant, getUserTenants } from '@/lib/auth/tenant-context';
import { redirect } from 'next/navigation';
import type { ActionResponse } from '@/types/api';
import { success, failure, ErrorCodes } from '@/types/api';

// ============================================================
// selectTenantAction
// ============================================================
// Called when a user picks a tenant from the tenant picker.
// Validates membership, then updates JWT app_metadata.
// ============================================================
export async function selectTenantAction(
  tenantId: string
): Promise<ActionResponse<{ tenantId: string }>> {
  const supabase = await createSupabaseServerClient();

  const {
    data: { user },
  } = await supabase.auth.getUser();

  if (!user) {
    return failure('Not authenticated', ErrorCodes.UNAUTHORIZED);
  }

  // Verify the user actually belongs to this tenant
  const tenants = await getUserTenants(user.id);
  const membership = tenants.find((t) => t.tenant.id === tenantId);

  if (!membership) {
    return failure('You do not have access to this school', ErrorCodes.FORBIDDEN);
  }

  if (!membership.tenant.is_active) {
    return failure(
      'This school account is currently inactive',
      ErrorCodes.TENANT_NOT_FOUND
    );
  }

  // Update the JWT app_metadata with the selected tenant
  await setUserTenant(user.id, tenantId);

  // Important: ensure the new app_metadata is reflected in the current session cookie.
  // (If your middleware already forces refresh, this is still harmless.)
  try {
    await supabase.auth.refreshSession();
  } catch {
    // If refresh fails (rare), the next request/middleware refresh will still pick up changes.
  }

  return success({ tenantId });
}

// ============================================================
// signOutAction
// ============================================================
// Signs the user out and redirects to login.
// ============================================================
export async function signOutAction(): Promise<void> {
  const supabase = await createSupabaseServerClient();
  await supabase.auth.signOut();
  redirect('/login');
}

// ============================================================
// switchTenantAction
// ============================================================
// Called when a user wants to switch to a different tenant.
// Clears the current tenant from JWT and redirects to picker.
// ============================================================
export async function switchTenantAction(): Promise<void> {
  const supabase = await createSupabaseServerClient();

  const {
    data: { user },
  } = await supabase.auth.getUser();

  if (!user) {
    redirect('/login');
  }

  // Clear tenant_id from app_metadata to force tenant picker
  // (If your setUserTenant expects null instead of '', adjust it there.)
  await setUserTenant(user.id, '');

  try {
    await supabase.auth.refreshSession();
  } catch {
    // ok
  }

  redirect('/tenant-picker');
}



===== D:\.code\wattleos\src\lib\actions\billing.ts =====

// src/lib/actions/billing.ts
//
// ============================================================
// WattleOS V2 â€” Billing Server Actions
// ============================================================
// Manages fee schedules, invoices, and Stripe synchronization.
//
// FLOW:
// 1. Admin creates fee schedule (pricing rules)
// 2. Admin creates invoice for a student+guardian
// 3. "Sync to Stripe" pushes the invoice to Stripe
// 4. "Send Invoice" emails the parent via Stripe
// 5. Parent pays via Stripe hosted page
// 6. Webhook updates invoice status + creates payment record
// ============================================================

'use server';

import { createSupabaseServerClient } from '@/lib/supabase/server';
import { getTenantContext, requirePermission } from '@/lib/auth/tenant-context';
import { Permissions } from '@/lib/constants/permissions';
import { ActionResponse, success, failure, ErrorCodes } from '@/types/api';
import type {
  FeeSchedule,
  Invoice,
  InvoiceWithDetails,
  InvoiceLineItem,
  Payment,
  StripeCustomer,
} from '@/types/domain';

// ============================================================
// FEE SCHEDULE ACTIONS
// ============================================================

export interface CreateFeeScheduleInput {
  name: string;
  class_id?: string | null;
  amount_cents: number;
  currency?: string;
  frequency: string;
  description?: string;
  effective_from?: string;
  effective_until?: string | null;
}

export async function createFeeSchedule(
  input: CreateFeeScheduleInput
): Promise<ActionResponse<FeeSchedule>> {
  try {
    const context = await requirePermission(Permissions.MANAGE_INTEGRATIONS);
    const supabase = await createSupabaseServerClient();

    if (!input.name?.trim()) return failure('Name is required', ErrorCodes.VALIDATION_ERROR);
    if (input.amount_cents < 0) return failure('Amount must be positive', ErrorCodes.VALIDATION_ERROR);

    const { data, error } = await supabase
      .from('fee_schedules')
      .insert({
        tenant_id: context.tenant.id,
        name: input.name.trim(),
        class_id: input.class_id || null,
        amount_cents: input.amount_cents,
        currency: input.currency ?? context.tenant.currency.toLowerCase(),
        frequency: input.frequency,
        description: input.description?.trim() || null,
        effective_from: input.effective_from ?? new Date().toISOString().split('T')[0],
        effective_until: input.effective_until || null,
      })
      .select()
      .single();

    if (error) return failure(error.message, ErrorCodes.CREATE_FAILED);
    return success(data as FeeSchedule);
  } catch (err) {
    return failure(err instanceof Error ? err.message : 'Failed', ErrorCodes.INTERNAL_ERROR);
  }
}

export async function listFeeSchedules(): Promise<ActionResponse<FeeSchedule[]>> {
  try {
    await requirePermission(Permissions.MANAGE_INTEGRATIONS);
    const supabase = await createSupabaseServerClient();

    const { data, error } = await supabase
      .from('fee_schedules')
      .select('*')
      .is('deleted_at', null)
      .order('created_at', { ascending: false });

    if (error) return failure(error.message, ErrorCodes.DATABASE_ERROR);
    return success((data ?? []) as FeeSchedule[]);
  } catch (err) {
    return failure(err instanceof Error ? err.message : 'Failed', ErrorCodes.INTERNAL_ERROR);
  }
}

export async function updateFeeSchedule(
  id: string,
  input: Partial<CreateFeeScheduleInput> & { is_active?: boolean }
): Promise<ActionResponse<FeeSchedule>> {
  try {
    await requirePermission(Permissions.MANAGE_INTEGRATIONS);
    const supabase = await createSupabaseServerClient();

    const updateData: Record<string, unknown> = {};
    if (input.name !== undefined) updateData.name = input.name.trim();
    if (input.amount_cents !== undefined) updateData.amount_cents = input.amount_cents;
    if (input.frequency !== undefined) updateData.frequency = input.frequency;
    if (input.description !== undefined) updateData.description = input.description?.trim() || null;
    if (input.is_active !== undefined) updateData.is_active = input.is_active;
    if (input.effective_until !== undefined) updateData.effective_until = input.effective_until;

    const { data, error } = await supabase
      .from('fee_schedules')
      .update(updateData)
      .eq('id', id)
      .is('deleted_at', null)
      .select()
      .single();

    if (error) return failure(error.message, ErrorCodes.UPDATE_FAILED);
    return success(data as FeeSchedule);
  } catch (err) {
    return failure(err instanceof Error ? err.message : 'Failed', ErrorCodes.INTERNAL_ERROR);
  }
}

// ============================================================
// INVOICE ACTIONS
// ============================================================

export interface CreateInvoiceInput {
  student_id: string;
  guardian_id: string;
  due_date: string;
  period_start?: string;
  period_end?: string;
  notes?: string;
  line_items: Array<{
    fee_schedule_id?: string;
    description: string;
    quantity: number;
    unit_amount_cents: number;
  }>;
}

export async function createInvoice(
  input: CreateInvoiceInput
): Promise<ActionResponse<Invoice>> {
  try {
    const context = await requirePermission(Permissions.MANAGE_INTEGRATIONS);
    const supabase = await createSupabaseServerClient();

    if (!input.student_id) return failure('Student is required', ErrorCodes.VALIDATION_ERROR);
    if (!input.guardian_id) return failure('Guardian is required', ErrorCodes.VALIDATION_ERROR);
    if (!input.due_date) return failure('Due date is required', ErrorCodes.VALIDATION_ERROR);
    if (!input.line_items.length) return failure('At least one line item is required', ErrorCodes.VALIDATION_ERROR);

    // Generate invoice number
    const { data: numResult } = await supabase
      .rpc('next_invoice_number', { p_tenant_id: context.tenant.id });

    const invoiceNumber = numResult ?? `INV-${new Date().getFullYear()}-0001`;

    // Calculate totals
    const subtotal = input.line_items.reduce(
      (sum, li) => sum + li.quantity * li.unit_amount_cents,
      0
    );

    // Create invoice
    const { data: invoice, error: invoiceError } = await supabase
      .from('invoices')
      .insert({
        tenant_id: context.tenant.id,
        student_id: input.student_id,
        guardian_id: input.guardian_id,
        invoice_number: invoiceNumber,
        status: 'draft',
        subtotal_cents: subtotal,
        total_cents: subtotal, // No tax/discount for now
        currency: context.tenant.currency.toLowerCase(),
        due_date: input.due_date,
        period_start: input.period_start || null,
        period_end: input.period_end || null,
        notes: input.notes?.trim() || null,
        created_by: context.user.id,
      })
      .select()
      .single();

    if (invoiceError || !invoice) {
      return failure(invoiceError?.message ?? 'Failed to create invoice', ErrorCodes.CREATE_FAILED);
    }

    // Create line items
    const lineItems = input.line_items.map((li) => ({
      tenant_id: context.tenant.id,
      invoice_id: invoice.id,
      fee_schedule_id: li.fee_schedule_id || null,
      description: li.description,
      quantity: li.quantity,
      unit_amount_cents: li.unit_amount_cents,
      total_cents: li.quantity * li.unit_amount_cents,
    }));

    const { error: lineError } = await supabase
      .from('invoice_line_items')
      .insert(lineItems);

    if (lineError) {
      // Cleanup: delete the invoice if line items fail
      await supabase.from('invoices').delete().eq('id', invoice.id);
      return failure(lineError.message, ErrorCodes.CREATE_FAILED);
    }

    return success(invoice as Invoice);
  } catch (err) {
    return failure(err instanceof Error ? err.message : 'Failed', ErrorCodes.INTERNAL_ERROR);
  }
}

export async function listInvoices(params?: {
  status?: string;
  student_id?: string;
  limit?: number;
}): Promise<ActionResponse<InvoiceWithDetails[]>> {
  try {
    await requirePermission(Permissions.MANAGE_INTEGRATIONS);
    const supabase = await createSupabaseServerClient();

    let query = supabase
      .from('invoices')
      .select(`
        *,
        student:students(id, first_name, last_name, photo_url),
        guardian:guardians(id, user_id, relationship, user:users(id, first_name, last_name, email)),
        line_items:invoice_line_items(*)
      `)
      .is('deleted_at', null)
      .order('created_at', { ascending: false })
      .limit(params?.limit ?? 50);

    if (params?.status) query = query.eq('status', params.status);
    if (params?.student_id) query = query.eq('student_id', params.student_id);

    const { data, error } = await query;

    if (error) return failure(error.message, ErrorCodes.DATABASE_ERROR);
    return success((data ?? []) as InvoiceWithDetails[]);
  } catch (err) {
    return failure(err instanceof Error ? err.message : 'Failed', ErrorCodes.INTERNAL_ERROR);
  }
}

export async function getParentInvoices(): Promise<ActionResponse<InvoiceWithDetails[]>> {
  try {
    const context = await getTenantContext();
    const supabase = await createSupabaseServerClient();

    // Get guardian records for this user
    const { data: guardians } = await supabase
      .from('guardians')
      .select('id')
      .eq('user_id', context.user.id)
      .is('deleted_at', null);

    const guardianIds = (guardians ?? []).map((g) => g.id);
    if (guardianIds.length === 0) return success([]);

    const { data, error } = await supabase
      .from('invoices')
      .select(`
        *,
        student:students(id, first_name, last_name, photo_url),
        guardian:guardians(id, user_id, relationship),
        line_items:invoice_line_items(*)
      `)
      .in('guardian_id', guardianIds)
      .is('deleted_at', null)
      .not('status', 'eq', 'draft') // Parents don't see drafts
      .order('created_at', { ascending: false })
      .limit(50);

    if (error) return failure(error.message, ErrorCodes.DATABASE_ERROR);
    return success((data ?? []) as InvoiceWithDetails[]);
  } catch (err) {
    return failure(err instanceof Error ? err.message : 'Failed', ErrorCodes.INTERNAL_ERROR);
  }
}

// ============================================================
// STRIPE SYNC ACTIONS
// ============================================================

export async function syncInvoiceToStripe(
  invoiceId: string
): Promise<ActionResponse<Invoice>> {
  try {
    const context = await requirePermission(Permissions.MANAGE_INTEGRATIONS);
    const supabase = await createSupabaseServerClient();

    // 1. Get invoice with guardian details
    const { data: invoice } = await supabase
      .from('invoices')
      .select(`
        *,
        guardian:guardians(id, user_id, user:users(id, email, first_name, last_name)),
        line_items:invoice_line_items(*)
      `)
      .eq('id', invoiceId)
      .single();

    if (!invoice) return failure('Invoice not found', ErrorCodes.NOT_FOUND);

    // 2. Get Stripe config
    const { data: config } = await supabase
      .from('integration_configs')
      .select('credentials')
      .eq('provider', 'stripe')
      .eq('is_enabled', true)
      .is('deleted_at', null)
      .maybeSingle();

    if (!config) {
      return failure('Stripe is not configured', ErrorCodes.INTEGRATION_ERROR);
    }

    const creds = config.credentials as { secret_key: string };
    if (!creds.secret_key) {
      return failure('Stripe secret key missing', ErrorCodes.INTEGRATION_ERROR);
    }

    // 3. Dynamic import
    const {
      createStripeClient,
      createCustomer,
      createInvoice: createStripeInvoice,
      finalizeInvoice: finalizeStripeInvoice,
    } = await import('@/lib/integrations/stripe/client');

    const stripe = createStripeClient(creds.secret_key);

    // 4. Ensure Stripe Customer exists for guardian
    let stripeCustomer: { stripe_customer_id: string } | null = null;

    const { data: existingCustomer } = await supabase
      .from('stripe_customers')
      .select('stripe_customer_id')
      .eq('guardian_id', invoice.guardian_id)
      .maybeSingle();

    if (existingCustomer) {
      stripeCustomer = existingCustomer;
    } else {
      // Create new Stripe customer
      const guardianUser = (invoice as unknown as {
        guardian: { user: { email: string; first_name: string; last_name: string } };
      }).guardian.user;

      const customer = await createCustomer(stripe, {
        email: guardianUser.email,
        name: `${guardianUser.first_name} ${guardianUser.last_name}`.trim(),
        metadata: {
          wattleos_guardian_id: invoice.guardian_id,
          wattleos_tenant_id: context.tenant.id,
        },
      });

      await supabase.from('stripe_customers').insert({
        tenant_id: context.tenant.id,
        guardian_id: invoice.guardian_id,
        stripe_customer_id: customer.id,
        email: guardianUser.email,
      });

      stripeCustomer = { stripe_customer_id: customer.id };
    }

    // 5. Create Stripe Invoice
    const lineItems = (invoice.line_items as InvoiceLineItem[]) ?? [];
    const dueDate = Math.floor(new Date(invoice.due_date).getTime() / 1000);

    const stripeInvoice = await createStripeInvoice(stripe, {
      customer_id: stripeCustomer.stripe_customer_id,
      currency: invoice.currency,
      due_date: dueDate,
      auto_advance: false,
      line_items: lineItems.map((li) => ({
        description: li.description,
        amount_cents: li.total_cents,
        quantity: 1, // Already calculated
      })),
      metadata: {
        wattleos_invoice_id: invoice.id,
        wattleos_tenant_id: context.tenant.id,
        wattleos_invoice_number: invoice.invoice_number,
      },
    });

    // 6. Finalize the invoice
    const finalized = await finalizeStripeInvoice(stripe, stripeInvoice.id);

    // 7. Update WattleOS invoice with Stripe IDs
    const { data: updated, error: updateError } = await supabase
      .from('invoices')
      .update({
        stripe_invoice_id: finalized.id,
        stripe_hosted_url: finalized.hosted_invoice_url,
        status: 'pending',
      })
      .eq('id', invoiceId)
      .select()
      .single();

    if (updateError) return failure(updateError.message, ErrorCodes.UPDATE_FAILED);
    return success(updated as Invoice);
  } catch (err) {
    return failure(err instanceof Error ? err.message : 'Stripe sync failed', ErrorCodes.INTEGRATION_ERROR);
  }
}

export async function sendStripeInvoice(
  invoiceId: string
): Promise<ActionResponse<Invoice>> {
  try {
    await requirePermission(Permissions.MANAGE_INTEGRATIONS);
    const supabase = await createSupabaseServerClient();

    const { data: invoice } = await supabase
      .from('invoices')
      .select('stripe_invoice_id')
      .eq('id', invoiceId)
      .single();

    if (!invoice?.stripe_invoice_id) {
      return failure('Invoice not synced to Stripe yet', ErrorCodes.INTEGRATION_ERROR);
    }

    const { data: config } = await supabase
      .from('integration_configs')
      .select('credentials')
      .eq('provider', 'stripe')
      .eq('is_enabled', true)
      .is('deleted_at', null)
      .maybeSingle();

    if (!config) return failure('Stripe not configured', ErrorCodes.INTEGRATION_ERROR);

    const creds = config.credentials as { secret_key: string };
    const { createStripeClient, sendInvoice: stripeSend } = await import(
      '@/lib/integrations/stripe/client'
    );

    const stripe = createStripeClient(creds.secret_key);
    await stripeSend(stripe, invoice.stripe_invoice_id);

    const { data: updated } = await supabase
      .from('invoices')
      .update({ status: 'sent', sent_at: new Date().toISOString() })
      .eq('id', invoiceId)
      .select()
      .single();

    return success(updated as Invoice);
  } catch (err) {
    return failure(err instanceof Error ? err.message : 'Send failed', ErrorCodes.INTEGRATION_ERROR);
  }
}

export async function voidInvoice(
  invoiceId: string
): Promise<ActionResponse<Invoice>> {
  try {
    await requirePermission(Permissions.MANAGE_INTEGRATIONS);
    const supabase = await createSupabaseServerClient();

    const { data: invoice } = await supabase
      .from('invoices')
      .select('stripe_invoice_id, status')
      .eq('id', invoiceId)
      .single();

    if (!invoice) return failure('Invoice not found', ErrorCodes.NOT_FOUND);
    if (invoice.status === 'paid') return failure('Cannot void a paid invoice', ErrorCodes.VALIDATION_ERROR);

    // Void in Stripe if synced
    if (invoice.stripe_invoice_id) {
      const { data: config } = await supabase
        .from('integration_configs')
        .select('credentials')
        .eq('provider', 'stripe')
        .eq('is_enabled', true)
        .is('deleted_at', null)
        .maybeSingle();

      if (config) {
        const creds = config.credentials as { secret_key: string };
        const { createStripeClient, voidInvoice: stripeVoid } = await import(
          '@/lib/integrations/stripe/client'
        );
        const stripe = createStripeClient(creds.secret_key);
        await stripeVoid(stripe, invoice.stripe_invoice_id);
      }
    }

    const { data: updated } = await supabase
      .from('invoices')
      .update({ status: 'void', voided_at: new Date().toISOString() })
      .eq('id', invoiceId)
      .select()
      .single();

    return success(updated as Invoice);
  } catch (err) {
    return failure(err instanceof Error ? err.message : 'Void failed', ErrorCodes.INTERNAL_ERROR);
  }
}

// ============================================================
// PAYMENT QUERIES
// ============================================================

export async function listPaymentsForInvoice(
  invoiceId: string
): Promise<ActionResponse<Payment[]>> {
  try {
    await getTenantContext();
    const supabase = await createSupabaseServerClient();

    const { data, error } = await supabase
      .from('payments')
      .select('*')
      .eq('invoice_id', invoiceId)
      .order('created_at', { ascending: false });

    if (error) return failure(error.message, ErrorCodes.DATABASE_ERROR);
    return success((data ?? []) as Payment[]);
  } catch (err) {
    return failure(err instanceof Error ? err.message : 'Failed', ErrorCodes.INTERNAL_ERROR);
  }
}


===== D:\.code\wattleos\src\lib\actions\classes.ts =====

'use server';

// ============================================================
// WattleOS V2 â€” Class Server Actions
// ============================================================
// CRUD for Montessori classrooms/environments.
// Classes are the organizational unit students are enrolled into.
//
// Fix: createClass now calls getTenantContext() for tenant_id.
// ============================================================

import { createSupabaseServerClient } from '@/lib/supabase/server';
import { getTenantContext } from '@/lib/auth/tenant-context';
import { ActionResponse, success, failure } from '@/types/api';
import { Class, ClassWithCounts, EnrollmentWithStudent } from '@/types/domain';

// ============================================================
// Input Types
// ============================================================

export interface CreateClassInput {
  name: string;
  room?: string | null;
  cycle_level?: string | null;
}

export interface UpdateClassInput {
  name?: string;
  room?: string | null;
  cycle_level?: string | null;
  is_active?: boolean;
}

// ============================================================
// LIST CLASSES (with active enrollment counts)
// ============================================================

export async function listClasses(): Promise<ActionResponse<ClassWithCounts[]>> {
  try {
    const supabase = await createSupabaseServerClient();

    const { data: classes, error } = await supabase
      .from('classes')
      .select('*')
      .is('deleted_at', null)
      .order('name', { ascending: true });

    if (error) {
      return failure(error.message, 'DB_ERROR');
    }

    // Get active enrollment counts per class
    const classIds = (classes ?? []).map((c) => c.id);
    const counts: Record<string, number> = {};

    if (classIds.length > 0) {
      const { data: enrollments } = await supabase
        .from('enrollments')
        .select('class_id')
        .in('class_id', classIds)
        .eq('status', 'active')
        .is('deleted_at', null);

      for (const enrollment of enrollments ?? []) {
        counts[enrollment.class_id] = (counts[enrollment.class_id] ?? 0) + 1;
      }
    }

    const classesWithCounts: ClassWithCounts[] = (classes ?? []).map((c) => ({
      ...(c as Class),
      active_enrollment_count: counts[c.id] ?? 0,
    }));

    return success(classesWithCounts);
  } catch (err) {
    const message = err instanceof Error ? err.message : 'Failed to list classes';
    return failure(message, 'UNEXPECTED_ERROR');
  }
}

// ============================================================
// GET CLASS BY ID
// ============================================================

export async function getClass(classId: string): Promise<ActionResponse<Class>> {
  try {
    const supabase = await createSupabaseServerClient();

    const { data, error } = await supabase
      .from('classes')
      .select('*')
      .eq('id', classId)
      .is('deleted_at', null)
      .single();

    if (error || !data) {
      return failure('Class not found', 'NOT_FOUND');
    }

    return success(data as Class);
  } catch (err) {
    const message = err instanceof Error ? err.message : 'Failed to get class';
    return failure(message, 'UNEXPECTED_ERROR');
  }
}

// ============================================================
// GET CLASS ROSTER (students actively enrolled)
// ============================================================

export async function getClassRoster(
  classId: string
): Promise<ActionResponse<EnrollmentWithStudent[]>> {
  try {
    const supabase = await createSupabaseServerClient();

    const { data, error } = await supabase
      .from('enrollments')
      .select('*, student:students(*)')
      .eq('class_id', classId)
      .eq('status', 'active')
      .is('deleted_at', null)
      .order('created_at', { ascending: true });

    if (error) {
      return failure(error.message, 'DB_ERROR');
    }

    return success((data ?? []) as EnrollmentWithStudent[]);
  } catch (err) {
    const message = err instanceof Error ? err.message : 'Failed to get class roster';
    return failure(message, 'UNEXPECTED_ERROR');
  }
}

// ============================================================
// CREATE CLASS
// ============================================================

export async function createClass(input: CreateClassInput): Promise<ActionResponse<Class>> {
  try {
    const context = await getTenantContext();
    const supabase = await createSupabaseServerClient();

    if (!input.name?.trim()) {
      return failure('Class name is required', 'VALIDATION_ERROR');
    }

    const { data, error } = await supabase
      .from('classes')
      .insert({
        tenant_id: context.tenant.id,
        name: input.name.trim(),
        room: input.room?.trim() || null,
        cycle_level: input.cycle_level?.trim() || null,
      })
      .select()
      .single();

    if (error) {
      return failure(error.message, 'DB_ERROR');
    }

    return success(data as Class);
  } catch (err) {
    const message = err instanceof Error ? err.message : 'Failed to create class';
    return failure(message, 'UNEXPECTED_ERROR');
  }
}

// ============================================================
// UPDATE CLASS
// ============================================================

export async function updateClass(
  classId: string,
  input: UpdateClassInput
): Promise<ActionResponse<Class>> {
  try {
    const supabase = await createSupabaseServerClient();

    const updateData: Record<string, unknown> = {};
    if (input.name !== undefined) updateData.name = input.name.trim();
    if (input.room !== undefined) updateData.room = input.room?.trim() || null;
    if (input.cycle_level !== undefined) updateData.cycle_level = input.cycle_level?.trim() || null;
    if (input.is_active !== undefined) updateData.is_active = input.is_active;

    if (Object.keys(updateData).length === 0) {
      return failure('No fields to update', 'VALIDATION_ERROR');
    }

    const { data, error } = await supabase
      .from('classes')
      .update(updateData)
      .eq('id', classId)
      .is('deleted_at', null)
      .select()
      .single();

    if (error) {
      return failure(error.message, 'DB_ERROR');
    }

    if (!data) {
      return failure('Class not found', 'NOT_FOUND');
    }

    return success(data as Class);
  } catch (err) {
    const message = err instanceof Error ? err.message : 'Failed to update class';
    return failure(message, 'UNEXPECTED_ERROR');
  }
}

// ============================================================
// SOFT DELETE CLASS
// ============================================================
// Withdraws all active enrollments before deactivating.

export async function deleteClass(classId: string): Promise<ActionResponse<{ id: string }>> {
  try {
    const supabase = await createSupabaseServerClient();

    // Check for active enrollments
    const { data: activeEnrollments } = await supabase
      .from('enrollments')
      .select('id')
      .eq('class_id', classId)
      .eq('status', 'active')
      .is('deleted_at', null);

    if (activeEnrollments && activeEnrollments.length > 0) {
      return failure(
        `Cannot delete class with ${activeEnrollments.length} active enrollment(s). Withdraw or transfer students first.`,
        'HAS_ACTIVE_ENROLLMENTS'
      );
    }

    const { error } = await supabase
      .from('classes')
      .update({ deleted_at: new Date().toISOString(), is_active: false })
      .eq('id', classId)
      .is('deleted_at', null);

    if (error) {
      return failure(error.message, 'DB_ERROR');
    }

    return success({ id: classId });
  } catch (err) {
    const message = err instanceof Error ? err.message : 'Failed to delete class';
    return failure(message, 'UNEXPECTED_ERROR');
  }
}


===== D:\.code\wattleos\src\lib\actions\consent.ts =====

// src/lib/actions/consent.ts
//
// ============================================================
// WattleOS V2 â€” Consent Check Server Actions
// ============================================================
// Queries guardian consent flags for students. Used by the
// observation capture form to warn when publishing photos of
// students without media consent.
//
// WHY separate file: Consent logic cuts across SIS (guardians)
// and Pedagogy (observations). Keeping it isolated prevents
// circular dependencies between action modules.
// ============================================================

'use server';

import { createSupabaseServerClient } from '@/lib/supabase/server';
import { getTenantContext } from '@/lib/auth/tenant-context';
import { ActionResponse, success, failure } from '@/types/api';

/**
 * For a list of student IDs, returns a record mapping each
 * student ID to whether ANY of their guardians has granted
 * media_consent. If a student has no guardians, they are
 * considered as NOT having consent (safe default).
 */
export async function getStudentMediaConsentMap(
  studentIds: string[]
): Promise<ActionResponse<Record<string, boolean>>> {
  try {
    await getTenantContext();
    const supabase = await createSupabaseServerClient();

    if (studentIds.length === 0) {
      return success({});
    }

    const { data, error } = await supabase
      .from('guardians')
      .select('student_id, media_consent')
      .in('student_id', studentIds)
      .is('deleted_at', null);

    if (error) {
      return failure(error.message, 'DB_ERROR');
    }

    // Build map: studentId â†’ true if ANY guardian has media_consent = true
    const consentMap: Record<string, boolean> = {};

    // Default all to false
    for (const id of studentIds) {
      consentMap[id] = false;
    }

    // Set to true if any guardian consented
    for (const row of data ?? []) {
      const guardianRow = row as { student_id: string; media_consent: boolean };
      if (guardianRow.media_consent) {
        consentMap[guardianRow.student_id] = true;
      }
    }

    return success(consentMap);
  } catch (err) {
    const message =
      err instanceof Error ? err.message : 'Failed to check media consent';
    return failure(message, 'UNEXPECTED_ERROR');
  }
}


===== D:\.code\wattleos\src\lib\actions\curriculum.ts =====

// src/lib/actions/curriculum.ts
'use server';

import { createSupabaseAdminClient, createSupabaseServerClient } from '@/lib/supabase/server';
import { getTenantContext, requirePermission } from '@/lib/auth/tenant-context';
import { Permissions } from '@/lib/constants/permissions';
import type { ActionResponse } from '@/types/api';
import { success, failure, ErrorCodes } from '@/types/api';
import type {
  CurriculumTemplate,
  CurriculumInstance,
  CurriculumNode,
  CurriculumLevel,
} from '@/types/domain';

// ============================================================
// READ: List available curriculum templates (global)
// ============================================================
export async function listCurriculumTemplates(): Promise<ActionResponse<CurriculumTemplate[]>> {
  const supabase = createSupabaseAdminClient();

  const { data, error } = await supabase
    .from('curriculum_templates')
    .select('*')
    .eq('is_active', true)
    .order('name');

  if (error) return failure(error.message, ErrorCodes.INTERNAL_ERROR);

  return success(data as CurriculumTemplate[]);
}

// ============================================================
// READ: List tenant's curriculum instances
// ============================================================
export async function listCurriculumInstances(): Promise<ActionResponse<CurriculumInstance[]>> {
  await getTenantContext();
  const supabase = await createSupabaseServerClient();

  const { data, error } = await supabase
    .from('curriculum_instances')
    .select('*')
    .is('deleted_at', null)
    .order('name');

  if (error) return failure(error.message, ErrorCodes.INTERNAL_ERROR);

  return success(data as CurriculumInstance[]);
}

// ============================================================
// READ: Get full node tree for a curriculum instance
// ============================================================
export async function getCurriculumTree(
  instanceId: string
): Promise<ActionResponse<CurriculumNode[]>> {
  await getTenantContext();
  const supabase = await createSupabaseServerClient();

  const { data, error } = await supabase
    .from('curriculum_nodes')
    .select('*')
    .eq('instance_id', instanceId)
    .is('deleted_at', null)
    .order('sequence_order', { ascending: true });

  if (error) return failure(error.message, ErrorCodes.INTERNAL_ERROR);

  return success(data as CurriculumNode[]);
}

// ============================================================
// FORK: Create a tenant instance from a global template
// ============================================================
export async function forkCurriculumTemplate(
  templateId: string,
  name: string,
  description?: string
): Promise<ActionResponse<CurriculumInstance>> {
  const context = await requirePermission(Permissions.MANAGE_CURRICULUM);
  const adminClient = createSupabaseAdminClient();

  // 1) Verify template exists
  const { data: template, error: templateError } = await adminClient
    .from('curriculum_templates')
    .select('*')
    .eq('id', templateId)
    .single();

  if (templateError || !template) {
    return failure('Template not found', ErrorCodes.NOT_FOUND);
  }

  // 2) Create the instance
  const { data: instance, error: instanceError } = await adminClient
    .from('curriculum_instances')
    .insert({
      tenant_id: context.tenant.id,
      source_template_id: templateId,
      name,
      description: description ?? (template as { description?: string | null }).description ?? null,
    })
    .select()
    .single();

  if (instanceError || !instance) {
    return failure(instanceError?.message ?? 'Failed to create instance', ErrorCodes.INTERNAL_ERROR);
  }

  // 3) Fetch all template nodes
  const { data: templateNodes, error: nodesError } = await adminClient
    .from('curriculum_template_nodes')
    .select('*')
    .eq('template_id', templateId)
    .order('sequence_order', { ascending: true });

  if (nodesError || !templateNodes) {
    return failure(nodesError?.message ?? 'Failed to read template nodes', ErrorCodes.INTERNAL_ERROR);
  }

  // 4) Copy nodes (parents before children) and build an ID map
  const idMap = new Map<string, string>(); // template_node_id â†’ new_node_id

  const levelOrder: Record<string, number> = { area: 0, strand: 1, outcome: 2, activity: 3 };
  const sortedNodes = [...templateNodes].sort(
    (a: any, b: any) => levelOrder[a.level] - levelOrder[b.level]
  );

  for (const level of ['area', 'strand', 'outcome', 'activity'] as const) {
    const nodesAtLevel = sortedNodes.filter((n: any) => n.level === level);
    if (nodesAtLevel.length === 0) continue;

    const inserts = nodesAtLevel.map((node: any) => ({
      tenant_id: context.tenant.id,
      instance_id: (instance as any).id,
      parent_id: node.parent_id ? idMap.get(node.parent_id) ?? null : null,
      source_template_node_id: node.id,
      level: node.level,
      title: node.title,
      description: node.description,
      sequence_order: node.sequence_order,
      is_hidden: false,
    }));

    const { data: insertedNodes, error: insertError } = await adminClient
      .from('curriculum_nodes')
      .insert(inserts)
      .select();

    if (insertError || !insertedNodes) {
      return failure(insertError?.message ?? `Failed to insert ${level} nodes`, ErrorCodes.INTERNAL_ERROR);
    }

    for (const inserted of insertedNodes as any[]) {
      if (inserted.source_template_node_id) {
        idMap.set(inserted.source_template_node_id, inserted.id);
      }
    }
  }

  return success(instance as CurriculumInstance);
}

// ============================================================
// CREATE: Add a custom node to a curriculum instance
// ============================================================
export async function createCurriculumNode(input: {
  instanceId: string;
  parentId: string | null;
  level: CurriculumLevel;
  title: string;
  description?: string;
}): Promise<ActionResponse<CurriculumNode>> {
  const context = await requirePermission(Permissions.MANAGE_CURRICULUM);
  const supabase = await createSupabaseServerClient();

  // Get the next sequence order for this parent
  let nextOrder = 0;

  if (input.parentId === null) {
    const { data: rootSiblings, error } = await supabase
      .from('curriculum_nodes')
      .select('sequence_order')
      .eq('instance_id', input.instanceId)
      .is('deleted_at', null)
      .is('parent_id', null)
      .order('sequence_order', { ascending: false })
      .limit(1);

    if (error) return failure(error.message, ErrorCodes.INTERNAL_ERROR);

    nextOrder = rootSiblings && rootSiblings.length > 0 ? (rootSiblings[0].sequence_order as number) + 1 : 0;
  } else {
    const { data: siblings, error } = await supabase
      .from('curriculum_nodes')
      .select('sequence_order')
      .eq('instance_id', input.instanceId)
      .is('deleted_at', null)
      .eq('parent_id', input.parentId)
      .order('sequence_order', { ascending: false })
      .limit(1);

    if (error) return failure(error.message, ErrorCodes.INTERNAL_ERROR);

    nextOrder = siblings && siblings.length > 0 ? (siblings[0].sequence_order as number) + 1 : 0;
  }

  const { data, error } = await supabase
    .from('curriculum_nodes')
    .insert({
      tenant_id: context.tenant.id,
      instance_id: input.instanceId,
      parent_id: input.parentId,
      level: input.level,
      title: input.title,
      description: input.description ?? null,
      sequence_order: nextOrder,
      source_template_node_id: null,
      is_hidden: false,
    })
    .select()
    .single();

  if (error || !data) return failure(error?.message ?? 'Failed to create node', ErrorCodes.INTERNAL_ERROR);

  return success(data as CurriculumNode);
}

// ============================================================
// UPDATE: Rename a curriculum node
// ============================================================
export async function updateCurriculumNode(
  nodeId: string,
  updates: { title?: string; description?: string }
): Promise<ActionResponse<CurriculumNode>> {
  await requirePermission(Permissions.MANAGE_CURRICULUM);
  const supabase = await createSupabaseServerClient();

  const { data, error } = await supabase
    .from('curriculum_nodes')
    .update(updates)
    .eq('id', nodeId)
    .is('deleted_at', null)
    .select()
    .single();

  if (error || !data) return failure(error?.message ?? 'Node not found', ErrorCodes.NOT_FOUND);

  return success(data as CurriculumNode);
}

// ============================================================
// UPDATE: Toggle node visibility (hide/show)
// ============================================================
export async function toggleNodeVisibility(
  nodeId: string
): Promise<ActionResponse<CurriculumNode>> {
  await requirePermission(Permissions.MANAGE_CURRICULUM);
  const supabase = await createSupabaseServerClient();

  const { data: current, error: currentError } = await supabase
    .from('curriculum_nodes')
    .select('is_hidden')
    .eq('id', nodeId)
    .is('deleted_at', null)
    .single();

  if (currentError) return failure(currentError.message, ErrorCodes.INTERNAL_ERROR);
  if (!current) return failure('Node not found', ErrorCodes.NOT_FOUND);

  const { data, error } = await supabase
    .from('curriculum_nodes')
    .update({ is_hidden: !(current as any).is_hidden })
    .eq('id', nodeId)
    .select()
    .single();

  if (error || !data) return failure(error?.message ?? 'Failed to update', ErrorCodes.INTERNAL_ERROR);

  return success(data as CurriculumNode);
}

// ============================================================
// UPDATE: Reorder nodes (move up/down within siblings)
// ============================================================
export async function reorderCurriculumNode(
  nodeId: string,
  direction: 'up' | 'down'
): Promise<ActionResponse<{ success: boolean }>> {
  await requirePermission(Permissions.MANAGE_CURRICULUM);
  const supabase = await createSupabaseServerClient();

  const { data: node, error: nodeError } = await supabase
    .from('curriculum_nodes')
    .select('*')
    .eq('id', nodeId)
    .is('deleted_at', null)
    .single();

  if (nodeError) return failure(nodeError.message, ErrorCodes.INTERNAL_ERROR);
  if (!node) return failure('Node not found', ErrorCodes.NOT_FOUND);

  // Get siblings
  let siblingsQuery = supabase
    .from('curriculum_nodes')
    .select('id, sequence_order')
    .eq('instance_id', (node as any).instance_id)
    .is('deleted_at', null)
    .order('sequence_order', { ascending: true });

  siblingsQuery = (node as any).parent_id
    ? siblingsQuery.eq('parent_id', (node as any).parent_id)
    : siblingsQuery.is('parent_id', null);

  const { data: siblings, error: sibError } = await siblingsQuery;
  if (sibError) return failure(sibError.message, ErrorCodes.INTERNAL_ERROR);
  if (!siblings || siblings.length < 2) return success({ success: true });

  const currentIndex = siblings.findIndex((s) => s.id === nodeId);
  const swapIndex = direction === 'up' ? currentIndex - 1 : currentIndex + 1;

  if (swapIndex < 0 || swapIndex >= siblings.length) return success({ success: true });

  const current = siblings[currentIndex];
  const swap = siblings[swapIndex];

  const { error: e1 } = await supabase
    .from('curriculum_nodes')
    .update({ sequence_order: swap.sequence_order })
    .eq('id', current.id);

  if (e1) return failure(e1.message, ErrorCodes.INTERNAL_ERROR);

  const { error: e2 } = await supabase
    .from('curriculum_nodes')
    .update({ sequence_order: current.sequence_order })
    .eq('id', swap.id);

  if (e2) return failure(e2.message, ErrorCodes.INTERNAL_ERROR);

  return success({ success: true });
}

// ============================================================
// DELETE: Soft-delete a curriculum node and its children
// ============================================================
export async function deleteCurriculumNode(
  nodeId: string
): Promise<ActionResponse<{ success: boolean }>> {
  await requirePermission(Permissions.MANAGE_CURRICULUM);
  const supabase = await createSupabaseServerClient();

  const now = new Date().toISOString();

  const { error } = await supabase.from('curriculum_nodes').update({ deleted_at: now }).eq('id', nodeId);
  if (error) return failure(error.message, ErrorCodes.INTERNAL_ERROR);

  // Soft-delete descendants iteratively
  let parentIds = [nodeId];
  while (parentIds.length > 0) {
    const { data: children, error: childError } = await supabase
      .from('curriculum_nodes')
      .select('id')
      .in('parent_id', parentIds)
      .is('deleted_at', null);

    if (childError) return failure(childError.message, ErrorCodes.INTERNAL_ERROR);
    if (!children || children.length === 0) break;

    const childIds = children.map((c) => c.id);

    const { error: delError } = await supabase
      .from('curriculum_nodes')
      .update({ deleted_at: now })
      .in('id', childIds);

    if (delError) return failure(delError.message, ErrorCodes.INTERNAL_ERROR);

    parentIds = childIds;
  }

  return success({ success: true });
}

// ============================================================
// SEARCH: Search nodes within an instance
// ============================================================
export async function searchCurriculumNodes(
  instanceId: string,
  query: string
): Promise<ActionResponse<CurriculumNode[]>> {
  await getTenantContext();
  const supabase = await createSupabaseServerClient();

  const { data, error } = await supabase
    .from('curriculum_nodes')
    .select('*')
    .eq('instance_id', instanceId)
    .is('deleted_at', null)
    .ilike('title', `%${query}%`)
    .order('sequence_order', { ascending: true })
    .limit(50);

  if (error) return failure(error.message, ErrorCodes.INTERNAL_ERROR);

  return success(data as CurriculumNode[]);
}

// ============================================================
// CREATE: Create a blank curriculum instance (from scratch)
// ============================================================
export async function createBlankCurriculumInstance(
  name: string,
  description?: string
): Promise<ActionResponse<CurriculumInstance>> {
  const context = await requirePermission(Permissions.MANAGE_CURRICULUM);
  const supabase = await createSupabaseServerClient();

  const { data, error } = await supabase
    .from('curriculum_instances')
    .insert({
      tenant_id: context.tenant.id,
      name,
      description: description ?? null,
      source_template_id: null,
    })
    .select()
    .single();

  if (error || !data) {
    return failure(error?.message ?? 'Failed to create instance', ErrorCodes.INTERNAL_ERROR);
  }

  return success(data as CurriculumInstance);
}

// ============================================================
// DELETE: Soft-delete a curriculum instance
// ============================================================
export async function deleteCurriculumInstance(
  instanceId: string
): Promise<ActionResponse<{ success: boolean }>> {
  await requirePermission(Permissions.MANAGE_CURRICULUM);
  const supabase = await createSupabaseServerClient();

  const now = new Date().toISOString();

  const { error } = await supabase
    .from('curriculum_instances')
    .update({ deleted_at: now })
    .eq('id', instanceId);

  if (error) return failure(error.message, ErrorCodes.INTERNAL_ERROR);

  return success({ success: true });
}



===== D:\.code\wattleos\src\lib\actions\custody.ts =====

'use server';

// ============================================================
// WattleOS V2 â€” Custody Restriction Server Actions
// ============================================================
// HIGH-SENSITIVITY TABLE. Tracks court orders and access
// restrictions. Only accessible by users with
// 'manage_safety_records' permission (enforced by RLS).
//
// Fix: createCustodyRestriction now calls getTenantContext()
// for tenant_id on INSERT. Audit log writes use context
// instead of a separate auth.getUser() call.
// ============================================================

import { createSupabaseServerClient, createSupabaseAdminClient } from '@/lib/supabase/server';
import { getTenantContext } from '@/lib/auth/tenant-context';
import { ActionResponse, success, failure } from '@/types/api';
import { CustodyRestriction, RestrictionType } from '@/types/domain';

// ============================================================
// Input Types
// ============================================================

export interface CreateCustodyRestrictionInput {
  student_id: string;
  restricted_person_name: string;
  restriction_type: RestrictionType;
  court_order_reference?: string | null;
  court_order_doc_url?: string | null;
  effective_date: string;
  expiry_date?: string | null;
  notes?: string | null;
}

export interface UpdateCustodyRestrictionInput {
  restricted_person_name?: string;
  restriction_type?: RestrictionType;
  court_order_reference?: string | null;
  court_order_doc_url?: string | null;
  effective_date?: string;
  expiry_date?: string | null;
  notes?: string | null;
}

// ============================================================
// LIST CUSTODY RESTRICTIONS FOR A STUDENT
// ============================================================

export async function listCustodyRestrictions(
  studentId: string
): Promise<ActionResponse<CustodyRestriction[]>> {
  try {
    const supabase = await createSupabaseServerClient();

    const { data, error } = await supabase
      .from('custody_restrictions')
      .select('*')
      .eq('student_id', studentId)
      .is('deleted_at', null)
      .order('effective_date', { ascending: false });

    if (error) {
      // RLS will deny access if user lacks 'manage_safety_records' permission
      if (error.code === '42501' || error.message.includes('policy')) {
        return failure('You do not have permission to view custody restrictions', 'FORBIDDEN');
      }
      return failure(error.message, 'DB_ERROR');
    }

    return success((data ?? []) as CustodyRestriction[]);
  } catch (err) {
    const message = err instanceof Error ? err.message : 'Failed to list custody restrictions';
    return failure(message, 'UNEXPECTED_ERROR');
  }
}

// ============================================================
// CREATE CUSTODY RESTRICTION
// ============================================================

export async function createCustodyRestriction(
  input: CreateCustodyRestrictionInput
): Promise<ActionResponse<CustodyRestriction>> {
  try {
    const context = await getTenantContext();
    const supabase = await createSupabaseServerClient();

    // Validation
    if (!input.student_id) return failure('Student is required', 'VALIDATION_ERROR');
    if (!input.restricted_person_name?.trim()) {
      return failure('Restricted person name is required', 'VALIDATION_ERROR');
    }
    if (!input.restriction_type) return failure('Restriction type is required', 'VALIDATION_ERROR');
    if (!input.effective_date) return failure('Effective date is required', 'VALIDATION_ERROR');

    const { data, error } = await supabase
      .from('custody_restrictions')
      .insert({
        tenant_id: context.tenant.id,
        student_id: input.student_id,
        restricted_person_name: input.restricted_person_name.trim(),
        restriction_type: input.restriction_type,
        court_order_reference: input.court_order_reference?.trim() || null,
        court_order_doc_url: input.court_order_doc_url || null,
        effective_date: input.effective_date,
        expiry_date: input.expiry_date || null,
        notes: input.notes?.trim() || null,
      })
      .select()
      .single();

    if (error) {
      return failure(error.message, 'DB_ERROR');
    }

    // Audit log â€” custody changes are security-critical
    const adminClient = createSupabaseAdminClient();

    await adminClient.from('audit_logs').insert({
      tenant_id: context.tenant.id,
      user_id: context.user.id,
      action: 'custody_restriction.created',
      entity_type: 'custody_restriction',
      entity_id: (data as CustodyRestriction).id,
      metadata: {
        student_id: input.student_id,
        restriction_type: input.restriction_type,
        restricted_person: input.restricted_person_name,
      },
    });

    return success(data as CustodyRestriction);
  } catch (err) {
    const message = err instanceof Error ? err.message : 'Failed to create custody restriction';
    return failure(message, 'UNEXPECTED_ERROR');
  }
}

// ============================================================
// UPDATE CUSTODY RESTRICTION
// ============================================================

export async function updateCustodyRestriction(
  restrictionId: string,
  input: UpdateCustodyRestrictionInput
): Promise<ActionResponse<CustodyRestriction>> {
  try {
    const context = await getTenantContext();
    const supabase = await createSupabaseServerClient();

    const updateData: Record<string, unknown> = {};
    if (input.restricted_person_name !== undefined) updateData.restricted_person_name = input.restricted_person_name.trim();
    if (input.restriction_type !== undefined) updateData.restriction_type = input.restriction_type;
    if (input.court_order_reference !== undefined) updateData.court_order_reference = input.court_order_reference?.trim() || null;
    if (input.court_order_doc_url !== undefined) updateData.court_order_doc_url = input.court_order_doc_url || null;
    if (input.effective_date !== undefined) updateData.effective_date = input.effective_date;
    if (input.expiry_date !== undefined) updateData.expiry_date = input.expiry_date || null;
    if (input.notes !== undefined) updateData.notes = input.notes?.trim() || null;

    if (Object.keys(updateData).length === 0) {
      return failure('No fields to update', 'VALIDATION_ERROR');
    }

    const { data, error } = await supabase
      .from('custody_restrictions')
      .update(updateData)
      .eq('id', restrictionId)
      .is('deleted_at', null)
      .select()
      .single();

    if (error) {
      return failure(error.message, 'DB_ERROR');
    }

    if (!data) {
      return failure('Custody restriction not found', 'NOT_FOUND');
    }

    // Audit log
    const adminClient = createSupabaseAdminClient();

    await adminClient.from('audit_logs').insert({
      tenant_id: context.tenant.id,
      user_id: context.user.id,
      action: 'custody_restriction.updated',
      entity_type: 'custody_restriction',
      entity_id: restrictionId,
      metadata: { updated_fields: Object.keys(updateData) },
    });

    return success(data as CustodyRestriction);
  } catch (err) {
    const message = err instanceof Error ? err.message : 'Failed to update custody restriction';
    return failure(message, 'UNEXPECTED_ERROR');
  }
}

// ============================================================
// DELETE CUSTODY RESTRICTION (soft delete)
// ============================================================

export async function deleteCustodyRestriction(
  restrictionId: string
): Promise<ActionResponse<{ id: string }>> {
  try {
    const context = await getTenantContext();
    const supabase = await createSupabaseServerClient();

    // Fetch before delete for audit
    const { data: existing } = await supabase
      .from('custody_restrictions')
      .select('student_id, restricted_person_name')
      .eq('id', restrictionId)
      .is('deleted_at', null)
      .single();

    const { error } = await supabase
      .from('custody_restrictions')
      .update({ deleted_at: new Date().toISOString() })
      .eq('id', restrictionId)
      .is('deleted_at', null);

    if (error) {
      return failure(error.message, 'DB_ERROR');
    }

    // Audit log
    if (existing) {
      const adminClient = createSupabaseAdminClient();

      await adminClient.from('audit_logs').insert({
        tenant_id: context.tenant.id,
        user_id: context.user.id,
        action: 'custody_restriction.deleted',
        entity_type: 'custody_restriction',
        entity_id: restrictionId,
        metadata: {
          student_id: existing.student_id,
          restricted_person: existing.restricted_person_name,
        },
      });
    }

    return success({ id: restrictionId });
  } catch (err) {
    const message = err instanceof Error ? err.message : 'Failed to delete custody restriction';
    return failure(message, 'UNEXPECTED_ERROR');
  }
}


===== D:\.code\wattleos\src\lib\actions\display-settings.ts =====

// src/lib/actions/display-settings.ts
//
// ============================================================
// WattleOS V2 â€” Display Settings Server Actions
// ============================================================
// Manages both admin-level (tenant) and user-level display
// preferences, plus the cookie that the root layout reads.
//
// WHY cookie sync: The root layout.tsx renders for both
// authenticated and unauthenticated pages. It can't call
// getTenantContext(). A cookie lets it apply the correct
// data attributes without a DB call on every page load.
//
// WHY two levels: Admin sets the school defaults (brand color,
// default density). Users override for personal preference
// (dark mode, compact layout). The resolve function merges
// them with user > tenant > platform default precedence.
// ============================================================

"use server";

import { getTenantContext, requirePermission } from "@/lib/auth/tenant-context";
import { Permissions } from "@/lib/constants/permissions";
import { createSupabaseServerClient } from "@/lib/supabase/server";
import { ActionResponse, failure, success } from "@/types/api";
import {
  DISPLAY_COOKIE_MAX_AGE,
  DISPLAY_COOKIE_NAME,
  type ResolvedDisplayConfig,
  type TenantDisplaySettings,
  type UserDisplayPreferences,
  parseTenantDisplaySettings,
  parseUserDisplayPreferences,
  resolveDisplayConfig,
  serializeDisplayCookie,
} from "@/types/display";
import { cookies } from "next/headers";

// ============================================================
// READ: Get resolved display config (tenant + user merged)
// ============================================================
// Called by the (app) layout to get the full resolved config.
// Also syncs the cookie so root layout stays current.
// ============================================================

export async function getResolvedDisplayConfig(): Promise<
  ActionResponse<ResolvedDisplayConfig>
> {
  try {
    const context = await getTenantContext();
    const supabase = await createSupabaseServerClient();

    // 1. Parse tenant display settings from tenants.settings.display
    const tenantDisplay = parseTenantDisplaySettings(
      (context.tenant.settings as Record<string, unknown>)?.display,
    );

    // 2. Fetch user display preferences from tenant_users.display_preferences
    const { data: membership } = await supabase
      .from("tenant_users")
      .select("display_preferences")
      .eq("tenant_id", context.tenant.id)
      .eq("user_id", context.user.id)
      .is("deleted_at", null)
      .single();

    const userDisplay = parseUserDisplayPreferences(
      membership?.display_preferences,
    );

    // 3. Resolve
    const resolved = resolveDisplayConfig(tenantDisplay, userDisplay);

    // 4. Sync cookie so root layout stays current
    await syncDisplayCookie(resolved);

    return success(resolved);
  } catch (err) {
    const message =
      err instanceof Error ? err.message : "Failed to load display settings";
    return failure(message, "DISPLAY_LOAD_ERROR");
  }
}

// ============================================================
// READ: Get tenant display settings (admin view)
// ============================================================

export async function getTenantDisplaySettings(): Promise<
  ActionResponse<TenantDisplaySettings>
> {
  try {
    const context = await getTenantContext();

    const tenantDisplay = parseTenantDisplaySettings(
      (context.tenant.settings as Record<string, unknown>)?.display,
    );

    return success(tenantDisplay);
  } catch (err) {
    const message =
      err instanceof Error
        ? err.message
        : "Failed to load tenant display settings";
    return failure(message, "DISPLAY_LOAD_ERROR");
  }
}

// ============================================================
// WRITE: Update tenant display settings (admin only)
// ============================================================
// Permission: manage_tenant_settings
// Merges into tenants.settings.display without clobbering
// other settings (feature flags, etc.).
// ============================================================

export async function updateTenantDisplaySettings(
  input: Partial<TenantDisplaySettings>,
): Promise<ActionResponse<TenantDisplaySettings>> {
  try {
    const context = await requirePermission(Permissions.MANAGE_TENANT_SETTINGS);
    const supabase = await createSupabaseServerClient();

    // Read current settings to merge (preserve non-display keys)
    const currentSettings = (context.tenant.settings ?? {}) as Record<
      string,
      unknown
    >;
    const currentDisplay = parseTenantDisplaySettings(currentSettings.display);

    // Merge input with current display settings
    const updatedDisplay: TenantDisplaySettings = {
      brandHue:
        input.brandHue !== undefined ? input.brandHue : currentDisplay.brandHue,
      brandSaturation:
        input.brandSaturation !== undefined
          ? input.brandSaturation
          : currentDisplay.brandSaturation,
      defaultDensity: input.defaultDensity ?? currentDisplay.defaultDensity,
      defaultTheme: input.defaultTheme ?? currentDisplay.defaultTheme,
      faviconUrl:
        input.faviconUrl !== undefined
          ? input.faviconUrl
          : currentDisplay.faviconUrl,
    };

    // Write back to tenants.settings, preserving other keys
    const updatedSettings = {
      ...currentSettings,
      display: updatedDisplay,
    };

    const { error } = await supabase
      .from("tenants")
      .update({ settings: updatedSettings })
      .eq("id", context.tenant.id);

    if (error) {
      return failure(error.message, "DB_ERROR");
    }

    // Re-resolve and sync cookie (admin may also be a user)
    await refreshDisplayCookie(context.tenant.id, context.user.id);

    return success(updatedDisplay);
  } catch (err) {
    const message =
      err instanceof Error ? err.message : "Failed to update display settings";
    return failure(message, "DISPLAY_UPDATE_ERROR");
  }
}

// ============================================================
// READ: Get user display preferences
// ============================================================

export async function getUserDisplayPreferences(): Promise<
  ActionResponse<UserDisplayPreferences>
> {
  try {
    const context = await getTenantContext();
    const supabase = await createSupabaseServerClient();

    const { data: membership } = await supabase
      .from("tenant_users")
      .select("display_preferences")
      .eq("tenant_id", context.tenant.id)
      .eq("user_id", context.user.id)
      .is("deleted_at", null)
      .single();

    const prefs = parseUserDisplayPreferences(membership?.display_preferences);

    return success(prefs);
  } catch (err) {
    const message =
      err instanceof Error ? err.message : "Failed to load user preferences";
    return failure(message, "DISPLAY_LOAD_ERROR");
  }
}

// ============================================================
// WRITE: Update user display preferences
// ============================================================
// Any authenticated user can update their own preferences.
// No special permission needed.
// ============================================================

export async function updateUserDisplayPreferences(
  input: Partial<UserDisplayPreferences>,
): Promise<ActionResponse<UserDisplayPreferences>> {
  try {
    const context = await getTenantContext();
    const supabase = await createSupabaseServerClient();

    // Read current preferences to merge
    const { data: membership } = await supabase
      .from("tenant_users")
      .select("display_preferences")
      .eq("tenant_id", context.tenant.id)
      .eq("user_id", context.user.id)
      .is("deleted_at", null)
      .single();

    const current = parseUserDisplayPreferences(
      membership?.display_preferences,
    );

    const updated: UserDisplayPreferences = {
      theme: input.theme !== undefined ? input.theme : current.theme,
      density: input.density !== undefined ? input.density : current.density,
      fontScale:
        input.fontScale !== undefined ? input.fontScale : current.fontScale,
      sidebarCollapsed:
        input.sidebarCollapsed !== undefined
          ? input.sidebarCollapsed
          : current.sidebarCollapsed,
    };

    const { error } = await supabase
      .from("tenant_users")
      .update({ display_preferences: updated })
      .eq("tenant_id", context.tenant.id)
      .eq("user_id", context.user.id)
      .is("deleted_at", null);

    if (error) {
      return failure(error.message, "DB_ERROR");
    }

    // Refresh the cookie with the new resolved config
    await refreshDisplayCookie(context.tenant.id, context.user.id);

    return success(updated);
  } catch (err) {
    const message =
      err instanceof Error
        ? err.message
        : "Failed to update display preferences";
    return failure(message, "DISPLAY_UPDATE_ERROR");
  }
}

// ============================================================
// Internal: Cookie sync helpers
// ============================================================

async function syncDisplayCookie(
  resolved: ResolvedDisplayConfig,
): Promise<void> {
  try {
    const cookieStore = await cookies();
    cookieStore.set(DISPLAY_COOKIE_NAME, serializeDisplayCookie(resolved), {
      httpOnly: false, // Readable by client JS for system theme detection
      secure: process.env.NODE_ENV === "production",
      sameSite: "lax",
      maxAge: DISPLAY_COOKIE_MAX_AGE,
      path: "/",
    });
  } catch {
    // Cookie setting can fail in some contexts (e.g., during static generation).
    // Non-critical â€” the layout will just use defaults.
  }
}

async function refreshDisplayCookie(
  tenantId: string,
  userId: string,
): Promise<void> {
  try {
    const supabase = await createSupabaseServerClient();

    // Fetch fresh tenant settings
    const { data: tenant } = await supabase
      .from("tenants")
      .select("settings")
      .eq("id", tenantId)
      .single();

    const tenantDisplay = parseTenantDisplaySettings(
      (tenant?.settings as Record<string, unknown>)?.display,
    );

    // Fetch fresh user preferences
    const { data: membership } = await supabase
      .from("tenant_users")
      .select("display_preferences")
      .eq("tenant_id", tenantId)
      .eq("user_id", userId)
      .is("deleted_at", null)
      .single();

    const userDisplay = parseUserDisplayPreferences(
      membership?.display_preferences,
    );

    const resolved = resolveDisplayConfig(tenantDisplay, userDisplay);
    await syncDisplayCookie(resolved);
  } catch {
    // Non-critical
  }
}



===== D:\.code\wattleos\src\lib\actions\emergency-contacts.ts =====

'use server';

// ============================================================
// WattleOS V2 â€” Emergency Contact Server Actions
// ============================================================
// Separate from guardians: not all emergency contacts are
// system users, and not all guardians are emergency contacts.
//
// Fix: createEmergencyContact now calls getTenantContext()
// for tenant_id on INSERT.
// ============================================================

import { createSupabaseServerClient } from '@/lib/supabase/server';
import { getTenantContext } from '@/lib/auth/tenant-context';
import { ActionResponse, success, failure } from '@/types/api';
import { EmergencyContact } from '@/types/domain';

// ============================================================
// Input Types
// ============================================================

export interface CreateEmergencyContactInput {
  student_id: string;
  name: string;
  relationship: string;
  phone_primary: string;
  phone_secondary?: string | null;
  email?: string | null;
  priority_order?: number;
  notes?: string | null;
}

export interface UpdateEmergencyContactInput {
  name?: string;
  relationship?: string;
  phone_primary?: string;
  phone_secondary?: string | null;
  email?: string | null;
  priority_order?: number;
  notes?: string | null;
}

// ============================================================
// LIST EMERGENCY CONTACTS FOR A STUDENT
// ============================================================

export async function listEmergencyContacts(
  studentId: string
): Promise<ActionResponse<EmergencyContact[]>> {
  try {
    const supabase = await createSupabaseServerClient();

    const { data, error } = await supabase
      .from('emergency_contacts')
      .select('*')
      .eq('student_id', studentId)
      .is('deleted_at', null)
      .order('priority_order', { ascending: true });

    if (error) {
      return failure(error.message, 'DB_ERROR');
    }

    return success((data ?? []) as EmergencyContact[]);
  } catch (err) {
    const message = err instanceof Error ? err.message : 'Failed to list emergency contacts';
    return failure(message, 'UNEXPECTED_ERROR');
  }
}

// ============================================================
// CREATE EMERGENCY CONTACT
// ============================================================

export async function createEmergencyContact(
  input: CreateEmergencyContactInput
): Promise<ActionResponse<EmergencyContact>> {
  try {
    const context = await getTenantContext();
    const supabase = await createSupabaseServerClient();

    if (!input.student_id) return failure('Student is required', 'VALIDATION_ERROR');
    if (!input.name?.trim()) return failure('Name is required', 'VALIDATION_ERROR');
    if (!input.relationship?.trim()) return failure('Relationship is required', 'VALIDATION_ERROR');
    if (!input.phone_primary?.trim()) return failure('Primary phone is required', 'VALIDATION_ERROR');

    const { data, error } = await supabase
      .from('emergency_contacts')
      .insert({
        tenant_id: context.tenant.id,
        student_id: input.student_id,
        name: input.name.trim(),
        relationship: input.relationship.trim(),
        phone_primary: input.phone_primary.trim(),
        phone_secondary: input.phone_secondary?.trim() || null,
        email: input.email?.trim() || null,
        priority_order: input.priority_order ?? 1,
        notes: input.notes?.trim() || null,
      })
      .select()
      .single();

    if (error) {
      return failure(error.message, 'DB_ERROR');
    }

    return success(data as EmergencyContact);
  } catch (err) {
    const message = err instanceof Error ? err.message : 'Failed to create emergency contact';
    return failure(message, 'UNEXPECTED_ERROR');
  }
}

// ============================================================
// UPDATE EMERGENCY CONTACT
// ============================================================

export async function updateEmergencyContact(
  contactId: string,
  input: UpdateEmergencyContactInput
): Promise<ActionResponse<EmergencyContact>> {
  try {
    const supabase = await createSupabaseServerClient();

    const updateData: Record<string, unknown> = {};
    if (input.name !== undefined) updateData.name = input.name.trim();
    if (input.relationship !== undefined) updateData.relationship = input.relationship.trim();
    if (input.phone_primary !== undefined) updateData.phone_primary = input.phone_primary.trim();
    if (input.phone_secondary !== undefined) updateData.phone_secondary = input.phone_secondary?.trim() || null;
    if (input.email !== undefined) updateData.email = input.email?.trim() || null;
    if (input.priority_order !== undefined) updateData.priority_order = input.priority_order;
    if (input.notes !== undefined) updateData.notes = input.notes?.trim() || null;

    if (Object.keys(updateData).length === 0) {
      return failure('No fields to update', 'VALIDATION_ERROR');
    }

    const { data, error } = await supabase
      .from('emergency_contacts')
      .update(updateData)
      .eq('id', contactId)
      .is('deleted_at', null)
      .select()
      .single();

    if (error) {
      return failure(error.message, 'DB_ERROR');
    }

    if (!data) {
      return failure('Emergency contact not found', 'NOT_FOUND');
    }

    return success(data as EmergencyContact);
  } catch (err) {
    const message = err instanceof Error ? err.message : 'Failed to update emergency contact';
    return failure(message, 'UNEXPECTED_ERROR');
  }
}

// ============================================================
// DELETE EMERGENCY CONTACT (soft delete)
// ============================================================

export async function deleteEmergencyContact(
  contactId: string
): Promise<ActionResponse<{ id: string }>> {
  try {
    const supabase = await createSupabaseServerClient();

    const { error } = await supabase
      .from('emergency_contacts')
      .update({ deleted_at: new Date().toISOString() })
      .eq('id', contactId)
      .is('deleted_at', null);

    if (error) {
      return failure(error.message, 'DB_ERROR');
    }

    return success({ id: contactId });
  } catch (err) {
    const message = err instanceof Error ? err.message : 'Failed to delete emergency contact';
    return failure(message, 'UNEXPECTED_ERROR');
  }
}


===== D:\.code\wattleos\src\lib\actions\enrollments.ts =====

'use server';

// ============================================================
// WattleOS V2 â€” Enrollment Server Actions
// ============================================================
// Handles the lifecycle of student-class relationships:
// admit â†’ (optional transfer) â†’ withdraw/complete.
//
// Fix: enrollStudent and transferStudent now call
// getTenantContext() for tenant_id on INSERT operations.
// ============================================================

import { createSupabaseServerClient } from '@/lib/supabase/server';
import { getTenantContext } from '@/lib/auth/tenant-context';
import { ActionResponse, success, failure } from '@/types/api';
import { Enrollment } from '@/types/domain';

// ============================================================
// Input Types
// ============================================================

export interface EnrollStudentInput {
  student_id: string;
  class_id: string;
  start_date: string;
}

export interface TransferStudentInput {
  student_id: string;
  from_class_id: string;
  to_class_id: string;
  transfer_date: string;
}

// ============================================================
// ENROLL STUDENT IN CLASS
// ============================================================
// Creates a new active enrollment. Checks for existing active
// enrollment in the same class to prevent duplicates.

export async function enrollStudent(
  input: EnrollStudentInput
): Promise<ActionResponse<Enrollment>> {
  try {
    const context = await getTenantContext();
    const supabase = await createSupabaseServerClient();

    // Validation
    if (!input.student_id) return failure('Student is required', 'VALIDATION_ERROR');
    if (!input.class_id) return failure('Class is required', 'VALIDATION_ERROR');
    if (!input.start_date) return failure('Start date is required', 'VALIDATION_ERROR');

    // Check for existing active enrollment in same class
    const { data: existing } = await supabase
      .from('enrollments')
      .select('id')
      .eq('student_id', input.student_id)
      .eq('class_id', input.class_id)
      .eq('status', 'active')
      .is('deleted_at', null)
      .maybeSingle();

    if (existing) {
      return failure('Student is already enrolled in this class', 'DUPLICATE_ENROLLMENT');
    }

    const { data, error } = await supabase
      .from('enrollments')
      .insert({
        tenant_id: context.tenant.id,
        student_id: input.student_id,
        class_id: input.class_id,
        start_date: input.start_date,
        status: 'active',
      })
      .select()
      .single();

    if (error) {
      return failure(error.message, 'DB_ERROR');
    }

    return success(data as Enrollment);
  } catch (err) {
    const message = err instanceof Error ? err.message : 'Failed to enroll student';
    return failure(message, 'UNEXPECTED_ERROR');
  }
}

// ============================================================
// TRANSFER STUDENT BETWEEN CLASSES
// ============================================================
// Completes the enrollment in the source class (sets end_date)
// and creates a new active enrollment in the target class.

export async function transferStudent(
  input: TransferStudentInput
): Promise<ActionResponse<{ withdrawn: Enrollment; enrolled: Enrollment }>> {
  try {
    const context = await getTenantContext();
    const supabase = await createSupabaseServerClient();

    // Validation
    if (!input.student_id) return failure('Student is required', 'VALIDATION_ERROR');
    if (!input.from_class_id) return failure('Source class is required', 'VALIDATION_ERROR');
    if (!input.to_class_id) return failure('Target class is required', 'VALIDATION_ERROR');
    if (!input.transfer_date) return failure('Transfer date is required', 'VALIDATION_ERROR');
    if (input.from_class_id === input.to_class_id) {
      return failure('Source and target class must be different', 'VALIDATION_ERROR');
    }

    // Find the active enrollment in the source class
    const { data: currentEnrollment, error: findError } = await supabase
      .from('enrollments')
      .select('*')
      .eq('student_id', input.student_id)
      .eq('class_id', input.from_class_id)
      .eq('status', 'active')
      .is('deleted_at', null)
      .single();

    if (findError || !currentEnrollment) {
      return failure('No active enrollment found in source class', 'NOT_FOUND');
    }

    // Check target class doesn't already have an active enrollment
    const { data: existingTarget } = await supabase
      .from('enrollments')
      .select('id')
      .eq('student_id', input.student_id)
      .eq('class_id', input.to_class_id)
      .eq('status', 'active')
      .is('deleted_at', null)
      .maybeSingle();

    if (existingTarget) {
      return failure('Student is already enrolled in the target class', 'DUPLICATE_ENROLLMENT');
    }

    // Complete the current enrollment
    const { data: withdrawn, error: withdrawError } = await supabase
      .from('enrollments')
      .update({
        status: 'completed',
        end_date: input.transfer_date,
      })
      .eq('id', currentEnrollment.id)
      .select()
      .single();

    if (withdrawError) {
      return failure(withdrawError.message, 'DB_ERROR');
    }

    // Create new enrollment in target class
    const { data: enrolled, error: enrollError } = await supabase
      .from('enrollments')
      .insert({
        tenant_id: context.tenant.id,
        student_id: input.student_id,
        class_id: input.to_class_id,
        start_date: input.transfer_date,
        status: 'active',
      })
      .select()
      .single();

    if (enrollError) {
      // Attempt to roll back the withdrawal
      await supabase
        .from('enrollments')
        .update({ status: 'active', end_date: null })
        .eq('id', currentEnrollment.id);

      return failure(enrollError.message, 'DB_ERROR');
    }

    return success({
      withdrawn: withdrawn as Enrollment,
      enrolled: enrolled as Enrollment,
    });
  } catch (err) {
    const message = err instanceof Error ? err.message : 'Failed to transfer student';
    return failure(message, 'UNEXPECTED_ERROR');
  }
}

// ============================================================
// WITHDRAW STUDENT FROM CLASS
// ============================================================

export async function withdrawStudent(
  studentId: string,
  classId: string,
  withdrawDate: string
): Promise<ActionResponse<Enrollment>> {
  try {
    const supabase = await createSupabaseServerClient();

    const { data, error } = await supabase
      .from('enrollments')
      .update({
        status: 'withdrawn',
        end_date: withdrawDate,
      })
      .eq('student_id', studentId)
      .eq('class_id', classId)
      .eq('status', 'active')
      .is('deleted_at', null)
      .select()
      .single();

    if (error) {
      return failure(error.message, 'DB_ERROR');
    }

    if (!data) {
      return failure('No active enrollment found', 'NOT_FOUND');
    }

    return success(data as Enrollment);
  } catch (err) {
    const message = err instanceof Error ? err.message : 'Failed to withdraw student';
    return failure(message, 'UNEXPECTED_ERROR');
  }
}

// ============================================================
// GET ENROLLMENT HISTORY FOR A STUDENT
// ============================================================

export async function getStudentEnrollmentHistory(
  studentId: string
): Promise<ActionResponse<Enrollment[]>> {
  try {
    const supabase = await createSupabaseServerClient();

    const { data, error } = await supabase
      .from('enrollments')
      .select('*, class:classes(id, name, room, cycle_level)')
      .eq('student_id', studentId)
      .is('deleted_at', null)
      .order('start_date', { ascending: false });

    if (error) {
      return failure(error.message, 'DB_ERROR');
    }

    return success((data ?? []) as Enrollment[]);
  } catch (err) {
    const message = err instanceof Error ? err.message : 'Failed to get enrollment history';
    return failure(message, 'UNEXPECTED_ERROR');
  }
}


===== D:\.code\wattleos\src\lib\actions\guardians.ts =====

'use server';

// ============================================================
// WattleOS V2 â€” Guardian Server Actions
// ============================================================
// Links users (parents/carers) to students.
// Manages consent flags and pickup authorization.
//
// Fix: createGuardian now calls getTenantContext() for tenant_id.
// ============================================================

import { createSupabaseServerClient } from '@/lib/supabase/server';
import { getTenantContext } from '@/lib/auth/tenant-context';
import { ActionResponse, success, failure } from '@/types/api';
import { Guardian, GuardianWithUser } from '@/types/domain';

// ============================================================
// Input Types
// ============================================================

export interface CreateGuardianInput {
  user_id: string;
  student_id: string;
  relationship: string;
  is_primary?: boolean;
  is_emergency_contact?: boolean;
  pickup_authorized?: boolean;
  phone?: string | null;
  media_consent?: boolean;
  directory_consent?: boolean;
}

export interface UpdateGuardianInput {
  relationship?: string;
  is_primary?: boolean;
  is_emergency_contact?: boolean;
  pickup_authorized?: boolean;
  phone?: string | null;
  media_consent?: boolean;
  directory_consent?: boolean;
}

// ============================================================
// LIST GUARDIANS FOR A STUDENT
// ============================================================

export async function listGuardians(
  studentId: string
): Promise<ActionResponse<GuardianWithUser[]>> {
  try {
    const supabase = await createSupabaseServerClient();

    const { data, error } = await supabase
      .from('guardians')
      .select('*, user:users(id, email, first_name, last_name, avatar_url)')
      .eq('student_id', studentId)
      .is('deleted_at', null)
      .order('is_primary', { ascending: false });

    if (error) {
      return failure(error.message, 'DB_ERROR');
    }

    return success((data ?? []) as GuardianWithUser[]);
  } catch (err) {
    const message = err instanceof Error ? err.message : 'Failed to list guardians';
    return failure(message, 'UNEXPECTED_ERROR');
  }
}

// ============================================================
// LINK GUARDIAN TO STUDENT
// ============================================================

export async function createGuardian(
  input: CreateGuardianInput
): Promise<ActionResponse<Guardian>> {
  try {
    const context = await getTenantContext();
    const supabase = await createSupabaseServerClient();

    if (!input.user_id) return failure('User is required', 'VALIDATION_ERROR');
    if (!input.student_id) return failure('Student is required', 'VALIDATION_ERROR');
    if (!input.relationship?.trim()) return failure('Relationship is required', 'VALIDATION_ERROR');

    const { data, error } = await supabase
      .from('guardians')
      .insert({
        tenant_id: context.tenant.id,
        user_id: input.user_id,
        student_id: input.student_id,
        relationship: input.relationship.trim(),
        is_primary: input.is_primary ?? false,
        is_emergency_contact: input.is_emergency_contact ?? false,
        pickup_authorized: input.pickup_authorized ?? true,
        phone: input.phone?.trim() || null,
        media_consent: input.media_consent ?? false,
        directory_consent: input.directory_consent ?? false,
      })
      .select()
      .single();

    if (error) {
      if (error.code === '23505') {
        return failure('This user is already linked as a guardian for this student', 'DUPLICATE');
      }
      return failure(error.message, 'DB_ERROR');
    }

    return success(data as Guardian);
  } catch (err) {
    const message = err instanceof Error ? err.message : 'Failed to create guardian';
    return failure(message, 'UNEXPECTED_ERROR');
  }
}

// ============================================================
// UPDATE GUARDIAN
// ============================================================

export async function updateGuardian(
  guardianId: string,
  input: UpdateGuardianInput
): Promise<ActionResponse<Guardian>> {
  try {
    const supabase = await createSupabaseServerClient();

    const updateData: Record<string, unknown> = {};
    if (input.relationship !== undefined) updateData.relationship = input.relationship.trim();
    if (input.is_primary !== undefined) updateData.is_primary = input.is_primary;
    if (input.is_emergency_contact !== undefined) updateData.is_emergency_contact = input.is_emergency_contact;
    if (input.pickup_authorized !== undefined) updateData.pickup_authorized = input.pickup_authorized;
    if (input.phone !== undefined) updateData.phone = input.phone?.trim() || null;
    if (input.media_consent !== undefined) updateData.media_consent = input.media_consent;
    if (input.directory_consent !== undefined) updateData.directory_consent = input.directory_consent;

    if (Object.keys(updateData).length === 0) {
      return failure('No fields to update', 'VALIDATION_ERROR');
    }

    const { data, error } = await supabase
      .from('guardians')
      .update(updateData)
      .eq('id', guardianId)
      .is('deleted_at', null)
      .select()
      .single();

    if (error) {
      return failure(error.message, 'DB_ERROR');
    }

    if (!data) {
      return failure('Guardian not found', 'NOT_FOUND');
    }

    return success(data as Guardian);
  } catch (err) {
    const message = err instanceof Error ? err.message : 'Failed to update guardian';
    return failure(message, 'UNEXPECTED_ERROR');
  }
}

// ============================================================
// REMOVE GUARDIAN LINK (soft delete)
// ============================================================

export async function removeGuardian(guardianId: string): Promise<ActionResponse<{ id: string }>> {
  try {
    const supabase = await createSupabaseServerClient();

    const { error } = await supabase
      .from('guardians')
      .update({ deleted_at: new Date().toISOString() })
      .eq('id', guardianId)
      .is('deleted_at', null);

    if (error) {
      return failure(error.message, 'DB_ERROR');
    }

    return success({ id: guardianId });
  } catch (err) {
    const message = err instanceof Error ? err.message : 'Failed to remove guardian';
    return failure(message, 'UNEXPECTED_ERROR');
  }
}


===== D:\.code\wattleos\src\lib\actions\integrations.ts =====

// src/lib/actions/integrations.ts
//
// ============================================================
// WattleOS V2 â€” Integration Server Actions
// ============================================================
// Manages integration configuration (CRUD) and orchestrates
// integration operations (provision folders, upload files).
//
// WHY separate from the client libraries: Server actions handle
// auth (requirePermission), config lookup, sync logging, and
// error normalization. The client libraries are pure API wrappers
// that know nothing about WattleOS.
// ============================================================

'use server';

import { createSupabaseServerClient } from '@/lib/supabase/server';
import { getTenantContext, requirePermission } from '@/lib/auth/tenant-context';
import { Permissions } from '@/lib/constants/permissions';
import { ActionResponse, success, failure, ErrorCodes } from '@/types/api';
import type {
  IntegrationConfig,
  IntegrationSyncLog,
  StudentPortfolioFolder,
} from '@/types/domain';
import type { IntegrationProvider } from '@/lib/constants/integrations';

// ============================================================
// Input Types
// ============================================================

export interface SaveIntegrationConfigInput {
  provider: IntegrationProvider;
  is_enabled: boolean;
  credentials: Record<string, unknown>;
  settings: Record<string, unknown>;
}

export interface ProvisionPortfolioInput {
  student_id: string;
  student_name: string;
  year?: number;
  parent_emails?: string[];
}

// ============================================================
// GET ALL INTEGRATION CONFIGS
// ============================================================

export async function listIntegrationConfigs(): Promise<
  ActionResponse<IntegrationConfig[]>
> {
  try {
    await requirePermission(Permissions.MANAGE_INTEGRATIONS);
    const supabase = await createSupabaseServerClient();

    const { data, error } = await supabase
      .from('integration_configs')
      .select('*')
      .is('deleted_at', null)
      .order('provider');

    if (error) {
      return failure(error.message, ErrorCodes.DATABASE_ERROR);
    }

    return success((data ?? []) as IntegrationConfig[]);
  } catch (err) {
    const message =
      err instanceof Error ? err.message : 'Failed to list configs';
    return failure(message, ErrorCodes.INTERNAL_ERROR);
  }
}

// ============================================================
// GET SINGLE INTEGRATION CONFIG
// ============================================================

export async function getIntegrationConfig(
  provider: IntegrationProvider
): Promise<ActionResponse<IntegrationConfig | null>> {
  try {
    await requirePermission(Permissions.MANAGE_INTEGRATIONS);
    const supabase = await createSupabaseServerClient();

    const { data, error } = await supabase
      .from('integration_configs')
      .select('*')
      .eq('provider', provider)
      .is('deleted_at', null)
      .maybeSingle();

    if (error) {
      return failure(error.message, ErrorCodes.DATABASE_ERROR);
    }

    return success(data as IntegrationConfig | null);
  } catch (err) {
    const message =
      err instanceof Error ? err.message : 'Failed to get config';
    return failure(message, ErrorCodes.INTERNAL_ERROR);
  }
}

// ============================================================
// SAVE (UPSERT) INTEGRATION CONFIG
// ============================================================

export async function saveIntegrationConfig(
  input: SaveIntegrationConfigInput
): Promise<ActionResponse<IntegrationConfig>> {
  try {
    const context = await requirePermission(Permissions.MANAGE_INTEGRATIONS);
    const supabase = await createSupabaseServerClient();

    const { data, error } = await supabase
      .from('integration_configs')
      .upsert(
        {
          tenant_id: context.tenant.id,
          provider: input.provider,
          is_enabled: input.is_enabled,
          credentials: input.credentials,
          settings: input.settings,
        },
        { onConflict: 'tenant_id,provider' }
      )
      .select()
      .single();

    if (error) {
      return failure(error.message, ErrorCodes.CREATE_FAILED);
    }

    // Log the config change
    await logSyncOperation(supabase, context.tenant.id, {
      provider: input.provider,
      operation: 'config_updated',
      status: 'success',
      request_data: { is_enabled: input.is_enabled },
    });

    return success(data as IntegrationConfig);
  } catch (err) {
    const message =
      err instanceof Error ? err.message : 'Failed to save config';
    return failure(message, ErrorCodes.INTERNAL_ERROR);
  }
}

// ============================================================
// DELETE INTEGRATION CONFIG
// ============================================================

export async function deleteIntegrationConfig(
  provider: IntegrationProvider
): Promise<ActionResponse<{ deleted: boolean }>> {
  try {
    await requirePermission(Permissions.MANAGE_INTEGRATIONS);
    const supabase = await createSupabaseServerClient();

    const { error } = await supabase
      .from('integration_configs')
      .update({ deleted_at: new Date().toISOString(), is_enabled: false })
      .eq('provider', provider)
      .is('deleted_at', null);

    if (error) {
      return failure(error.message, ErrorCodes.DELETE_FAILED);
    }

    return success({ deleted: true });
  } catch (err) {
    const message =
      err instanceof Error ? err.message : 'Failed to delete config';
    return failure(message, ErrorCodes.INTERNAL_ERROR);
  }
}

// ============================================================
// PROVISION STUDENT PORTFOLIO FOLDER (Google Drive)
// ============================================================
// Orchestrates: lookup config â†’ create Drive client â†’ provision
// folder â†’ store mapping â†’ optionally share with parents â†’ log.
// ============================================================

export async function provisionStudentPortfolio(
  input: ProvisionPortfolioInput
): Promise<ActionResponse<StudentPortfolioFolder>> {
  try {
    const context = await getTenantContext();
    const supabase = await createSupabaseServerClient();
    const year = input.year ?? new Date().getFullYear();

    // 1. Check if folder already exists for this student + year
    const { data: existing } = await supabase
      .from('student_portfolio_folders')
      .select('*')
      .eq('student_id', input.student_id)
      .eq('year', year)
      .is('deleted_at', null)
      .maybeSingle();

    if (existing) {
      return success(existing as StudentPortfolioFolder);
    }

    // 2. Get Google Drive config
    const { data: config } = await supabase
      .from('integration_configs')
      .select('*')
      .eq('provider', 'google_drive')
      .eq('is_enabled', true)
      .is('deleted_at', null)
      .maybeSingle();

    if (!config) {
      return failure(
        'Google Drive integration is not configured or enabled',
        ErrorCodes.INTEGRATION_ERROR
      );
    }

    const configData = config as IntegrationConfig;
    const credentials = configData.credentials as {
      service_account_email: string;
      private_key: string;
      root_folder_id: string;
    };

    if (
      !credentials.service_account_email ||
      !credentials.private_key ||
      !credentials.root_folder_id
    ) {
      return failure(
        'Google Drive credentials are incomplete',
        ErrorCodes.INTEGRATION_ERROR
      );
    }

    // 3. Dynamically import and call the Drive client
    // WHY dynamic import: googleapis is a large package. Only load it
    // when actually needed, not on every server action import.
    const { createDriveClient, provisionPortfolioFolder, shareFolderWithUser } =
      await import('@/lib/integrations/google-drive/client');

    const drive = createDriveClient(credentials);

    const result = await provisionPortfolioFolder(
      drive,
      credentials.root_folder_id,
      input.student_name,
      year
    );

    // 4. Store the folder mapping
    const { data: folderRecord, error: insertError } = await supabase
      .from('student_portfolio_folders')
      .insert({
        tenant_id: context.tenant.id,
        student_id: input.student_id,
        drive_folder_id: result.folder_id,
        drive_folder_url: result.folder_url,
        year,
      })
      .select()
      .single();

    if (insertError) {
      return failure(insertError.message, ErrorCodes.CREATE_FAILED);
    }

    // 5. Share with parent emails if configured
    const settings = configData.settings as { auto_share_with_parents?: boolean };
    if (settings.auto_share_with_parents && input.parent_emails) {
      for (const email of input.parent_emails) {
        try {
          await shareFolderWithUser(drive, result.folder_id, email, 'reader');
        } catch {
          // Non-critical â€” log but don't fail the provisioning
          await logSyncOperation(supabase, context.tenant.id, {
            provider: 'google_drive',
            operation: 'share_folder',
            entity_type: 'student',
            entity_id: input.student_id,
            status: 'failure',
            error_message: `Failed to share with ${email}`,
          });
        }
      }
    }

    // 6. Log success
    await logSyncOperation(supabase, context.tenant.id, {
      provider: 'google_drive',
      operation: 'provision_folder',
      entity_type: 'student',
      entity_id: input.student_id,
      status: 'success',
      response_data: { folder_id: result.folder_id, year },
    });

    return success(folderRecord as StudentPortfolioFolder);
  } catch (err) {
    const message =
      err instanceof Error ? err.message : 'Failed to provision portfolio';
    return failure(message, ErrorCodes.INTEGRATION_ERROR);
  }
}

// ============================================================
// GET STUDENT PORTFOLIO FOLDER
// ============================================================

export async function getStudentPortfolioFolder(
  studentId: string,
  year?: number
): Promise<ActionResponse<StudentPortfolioFolder | null>> {
  try {
    await getTenantContext();
    const supabase = await createSupabaseServerClient();

    let query = supabase
      .from('student_portfolio_folders')
      .select('*')
      .eq('student_id', studentId)
      .is('deleted_at', null)
      .order('year', { ascending: false });

    if (year) {
      query = query.eq('year', year);
    }

    const { data, error } = await query.limit(1).maybeSingle();

    if (error) {
      return failure(error.message, ErrorCodes.DATABASE_ERROR);
    }

    return success(data as StudentPortfolioFolder | null);
  } catch (err) {
    const message =
      err instanceof Error ? err.message : 'Failed to get portfolio folder';
    return failure(message, ErrorCodes.INTERNAL_ERROR);
  }
}

// ============================================================
// LIST SYNC LOGS
// ============================================================

export async function listSyncLogs(params: {
  provider?: IntegrationProvider;
  status?: 'success' | 'failure' | 'pending';
  limit?: number;
}): Promise<ActionResponse<IntegrationSyncLog[]>> {
  try {
    await requirePermission(Permissions.MANAGE_INTEGRATIONS);
    const supabase = await createSupabaseServerClient();

    const limit = params.limit ?? 50;

    let query = supabase
      .from('integration_sync_logs')
      .select('*')
      .order('created_at', { ascending: false })
      .limit(limit);

    if (params.provider) {
      query = query.eq('provider', params.provider);
    }
    if (params.status) {
      query = query.eq('status', params.status);
    }

    const { data, error } = await query;

    if (error) {
      return failure(error.message, ErrorCodes.DATABASE_ERROR);
    }

    return success((data ?? []) as IntegrationSyncLog[]);
  } catch (err) {
    const message =
      err instanceof Error ? err.message : 'Failed to list sync logs';
    return failure(message, ErrorCodes.INTERNAL_ERROR);
  }
}

// ============================================================
// TEST INTEGRATION CONNECTION
// ============================================================
// Verifies that the credentials work by performing a lightweight
// API call (e.g., list root folder for Drive, retrieve account
// for Stripe).
// ============================================================

export async function testIntegrationConnection(
  provider: IntegrationProvider
): Promise<ActionResponse<{ connected: boolean; message: string }>> {
  try {
    const context = await requirePermission(Permissions.MANAGE_INTEGRATIONS);
    const supabase = await createSupabaseServerClient();

    const { data: config } = await supabase
      .from('integration_configs')
      .select('*')
      .eq('provider', provider)
      .is('deleted_at', null)
      .maybeSingle();

    if (!config) {
      return failure('Integration not configured', ErrorCodes.NOT_FOUND);
    }

    const configData = config as IntegrationConfig;

    if (provider === 'google_drive') {
      const credentials = configData.credentials as {
        service_account_email: string;
        private_key: string;
        root_folder_id: string;
      };

      const { createDriveClient } = await import(
        '@/lib/integrations/google-drive/client'
      );
      const drive = createDriveClient(credentials);

      // Try to get the root folder
      const response = await drive.files.get({
        fileId: credentials.root_folder_id,
        fields: 'id, name',
      });

      await logSyncOperation(supabase, context.tenant.id, {
        provider: 'google_drive',
        operation: 'test_connection',
        status: 'success',
      });

      return success({
        connected: true,
        message: `Connected to folder "${response.data.name}"`,
      });
    }

    // Add other providers here as they're implemented
    return failure(
      `Test not implemented for ${provider}`,
      ErrorCodes.INTEGRATION_ERROR
    );
  } catch (err) {
    const message =
      err instanceof Error ? err.message : 'Connection test failed';
    return success({
      connected: false,
      message,
    });
  }
}

// ============================================================
// HELPER: Log sync operation
// ============================================================

async function logSyncOperation(
  supabase: Awaited<ReturnType<typeof createSupabaseServerClient>>,
  tenantId: string,
  log: {
    provider: string;
    operation: string;
    entity_type?: string;
    entity_id?: string;
    status: 'success' | 'failure' | 'pending';
    request_data?: Record<string, unknown>;
    response_data?: Record<string, unknown>;
    error_message?: string;
  }
): Promise<void> {
  try {
    await supabase.from('integration_sync_logs').insert({
      tenant_id: tenantId,
      provider: log.provider,
      operation: log.operation,
      entity_type: log.entity_type ?? null,
      entity_id: log.entity_id ?? null,
      status: log.status,
      request_data: log.request_data ?? {},
      response_data: log.response_data ?? {},
      error_message: log.error_message ?? null,
    });
  } catch {
    // Sync logging is non-critical â€” don't fail the main operation
    console.error('Failed to write sync log');
  }
}


===== D:\.code\wattleos\src\lib\actions\mastery.ts =====

// src/lib/actions/mastery.ts
'use server';

import { createSupabaseAdminClient, createSupabaseServerClient } from '@/lib/supabase/server';
import { getTenantContext, requirePermission } from '@/lib/auth/tenant-context';

import { Permissions } from '@/lib/constants/permissions';
import type { ActionResponse } from '@/types/api';
import { success, failure, ErrorCodes } from '@/types/api';
import type {
  StudentMastery,
  MasteryHistoryEntry,
  MasteryStatus,
} from '@/types/domain';

// ============================================================
// Composite types for UI rendering
// ============================================================

export interface MasteryWithNode extends StudentMastery {
  curriculum_node: {
    id: string;
    title: string;
    level: string;
    parent_id: string | null;
    instance_id: string;
    sequence_order: number;
    is_hidden: boolean;
  };
}

export interface MasteryHistoryWithMeta extends MasteryHistoryEntry {
  changed_by_user:
    | {
        first_name: string | null;
        last_name: string | null;
      }
    | null;
  curriculum_node_title: string;
}

export interface StudentMasteryOverview {
  student_id: string;
  student_name: string;
  total_outcomes: number;
  not_started: number;
  presented: number;
  practicing: number;
  mastered: number;
}

export interface ClassHeatmapRow {
  student_id: string;
  student_first_name: string;
  student_last_name: string;
  statuses: Record<string, MasteryStatus>; // curriculum_node_id â†’ status
}

export interface PortfolioTimelineItem {
  type: 'observation' | 'mastery_change';
  date: string;
  // Observation fields
  observation_id?: string;
  observation_content?: string | null;
  observation_author?: string;
  observation_outcomes?: Array<{ id: string; title: string }>;
  observation_media_count?: number;
  // Mastery change fields
  mastery_node_title?: string;
  mastery_previous_status?: string | null;
  mastery_new_status?: string;
  mastery_changed_by?: string;
}

// ============================================================
// READ: Get all mastery records for a student within an instance
// ============================================================
export async function getStudentMastery(
  studentId: string,
  instanceId: string
): Promise<ActionResponse<MasteryWithNode[]>> {
  await getTenantContext();
  const supabase = await createSupabaseServerClient();

  // Get all curriculum nodes for this instance
  const { data: nodes, error: nodesError } = await supabase
    .from('curriculum_nodes')
    .select('id, title, level, parent_id, instance_id, sequence_order, is_hidden')
    .eq('instance_id', instanceId)
    .is('deleted_at', null)
    .eq('is_hidden', false)
    .order('sequence_order');

  if (nodesError) return failure(nodesError.message, ErrorCodes.INTERNAL_ERROR);
  if (!nodes || nodes.length === 0) return success([]);

  // Get existing mastery records for this student
  const nodeIds = nodes.map((n) => n.id);
  const { data: masteryRecords, error: masteryError } = await supabase
    .from('student_mastery')
    .select('*')
    .eq('student_id', studentId)
    .in('curriculum_node_id', nodeIds)
    .is('deleted_at', null);

  if (masteryError) return failure(masteryError.message, ErrorCodes.INTERNAL_ERROR);

  // Build a map of existing mastery records
  const masteryMap = new Map<string, StudentMastery>();
  for (const record of masteryRecords ?? []) {
    masteryMap.set(record.curriculum_node_id as string, record as unknown as StudentMastery);
  }

  // Merge: for each node, return mastery record (or synthesize a not_started one)
  const result: MasteryWithNode[] = nodes.map((node) => {
    const existing = masteryMap.get(node.id);
    if (existing) {
      return {
        ...existing,
        curriculum_node: node,
      };
    }

    // Synthesize a "not_started" placeholder (not persisted until first status change)
    return {
      id: `virtual-${node.id}`,
      tenant_id: '',
      student_id: studentId,
      curriculum_node_id: node.id,
      status: 'not_started' as MasteryStatus,
      date_achieved: null,
      assessed_by: null,
      notes: null,
      created_at: '',
      updated_at: '',
      deleted_at: undefined,
      curriculum_node: node,
    };
  });

  return success(result);
}

// ============================================================
// UPDATE: Set mastery status for a student Ã— outcome
// ============================================================
// 1) Upsert student_mastery via cookie-auth client (RLS applies)
// 2) Insert mastery_history via service-role admin client
// ============================================================
export async function updateMasteryStatus(input: {
  studentId: string;
  curriculumNodeId: string;
  newStatus: MasteryStatus;
  notes?: string;
}): Promise<ActionResponse<StudentMastery>> {
  const context = await requirePermission(Permissions.MANAGE_MASTERY);

  const supabase = await createSupabaseServerClient();
  const adminClient = createSupabaseAdminClient();

  const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD

  // Check if a mastery record already exists
  const { data: existing, error: existingError } = await supabase
    .from('student_mastery')
    .select('*')
    .eq('student_id', input.studentId)
    .eq('curriculum_node_id', input.curriculumNodeId)
    .is('deleted_at', null)
    .maybeSingle();

  if (existingError) {
    return failure(existingError.message, ErrorCodes.INTERNAL_ERROR);
  }

  let masteryRecord: StudentMastery;
  const previousStatus = (existing as { status?: string } | null)?.status ?? null;

  if (existing) {
    // Update existing record
    const { data, error } = await supabase
      .from('student_mastery')
      .update({
        status: input.newStatus,
        date_achieved: today,
        assessed_by: context.user.id,
        notes: input.notes ?? (existing as { notes?: string | null }).notes ?? null,
      })
      .eq('id', (existing as { id: string }).id)
      .select()
      .single();

    if (error || !data) {
      return failure(error?.message ?? 'Failed to update mastery', ErrorCodes.INTERNAL_ERROR);
    }
    masteryRecord = data as unknown as StudentMastery;
  } else {
    // Create new record
    const { data, error } = await supabase
      .from('student_mastery')
      .insert({
        tenant_id: context.tenant.id,
        student_id: input.studentId,
        curriculum_node_id: input.curriculumNodeId,
        status: input.newStatus,
        date_achieved: today,
        assessed_by: context.user.id,
        notes: input.notes ?? null,
      })
      .select()
      .single();

    if (error || !data) {
      return failure(error?.message ?? 'Failed to create mastery record', ErrorCodes.INTERNAL_ERROR);
    }
    masteryRecord = data as unknown as StudentMastery;
  }

  // Append to mastery_history (service role â€” bypasses RLS)
  const { error: histError } = await adminClient.from('mastery_history').insert({
    tenant_id: context.tenant.id,
    student_mastery_id: masteryRecord.id,
    student_id: input.studentId,
    curriculum_node_id: input.curriculumNodeId,
    previous_status: previousStatus,
    new_status: input.newStatus,
    changed_by: context.user.id,
  });

  if (histError) {
    return failure(histError.message, ErrorCodes.INTERNAL_ERROR);
  }

  return success(masteryRecord);
}

// ============================================================
// BULK UPDATE: Set mastery status for multiple outcomes at once
// ============================================================
export async function bulkUpdateMasteryStatus(input: {
  studentId: string;
  updates: Array<{
    curriculumNodeId: string;
    newStatus: MasteryStatus;
  }>;
}): Promise<ActionResponse<{ updated: number }>> {
  await requirePermission(Permissions.MANAGE_MASTERY);

  let updated = 0;
  for (const update of input.updates) {
    const result = await updateMasteryStatus({
      studentId: input.studentId,
      curriculumNodeId: update.curriculumNodeId,
      newStatus: update.newStatus,
    });
    if (result.data) updated++;
  }

  return success({ updated });
}

// ============================================================
// READ: Get mastery history for a student (timeline)
// ============================================================
export async function getStudentMasteryHistory(
  studentId: string,
  limit: number = 50
): Promise<ActionResponse<MasteryHistoryWithMeta[]>> {
  await getTenantContext();
  const supabase = await createSupabaseServerClient();

  const { data, error } = await supabase
    .from('mastery_history')
    .select(
      `
      *,
      changed_by_user:users!mastery_history_changed_by_fkey(first_name, last_name),
      curriculum_node:curriculum_nodes!mastery_history_curriculum_node_id_fkey(title)
    `
    )
    .eq('student_id', studentId)
    .order('changed_at', { ascending: false })
    .limit(limit);

  if (error) {
    // Fallback: if the join fails (possible with RLS), do a simpler query
    const { data: simpleData, error: simpleError } = await supabase
      .from('mastery_history')
      .select('*')
      .eq('student_id', studentId)
      .order('changed_at', { ascending: false })
      .limit(limit);

    if (simpleError) return failure(simpleError.message, ErrorCodes.INTERNAL_ERROR);

    const result: MasteryHistoryWithMeta[] = (simpleData ?? []).map((row) => ({
      ...(row as unknown as MasteryHistoryEntry),
      changed_by_user: null,
      curriculum_node_title: '',
    }));

    return success(result);
  }

  const result: MasteryHistoryWithMeta[] = (data ?? []).map((row: Record<string, unknown>) => {
    const changedByUser = row.changed_by_user as
      | { first_name: string | null; last_name: string | null }
      | null;
    const curriculumNode = row.curriculum_node as { title: string } | null;

    return {
      id: row.id as string,
      tenant_id: row.tenant_id as string,
      student_mastery_id: row.student_mastery_id as string,
      student_id: row.student_id as string,
      curriculum_node_id: row.curriculum_node_id as string,
      previous_status: (row.previous_status as MasteryStatus | null),
      new_status: (row.new_status as MasteryStatus),
      
      changed_by: row.changed_by as string | null,
      changed_at: row.changed_at as string,
      changed_by_user: changedByUser,
      curriculum_node_title: curriculumNode?.title ?? '',
    };
  });

  return success(result);
}

// ============================================================
// READ: Get mastery overview for all students in a class
// (used for the class heatmap)
// ============================================================
export async function getClassMasteryHeatmap(
  instanceId: string,
  studentIds: string[]
): Promise<ActionResponse<ClassHeatmapRow[]>> {
  await getTenantContext();
  const supabase = await createSupabaseServerClient();

  if (studentIds.length === 0) return success([]);

  // Get all outcome-level nodes for this instance
  const { data: outcomes, error: outcomesError } = await supabase
    .from('curriculum_nodes')
    .select('id')
    .eq('instance_id', instanceId)
    .eq('level', 'outcome')
    .eq('is_hidden', false)
    .is('deleted_at', null);

  if (outcomesError) return failure(outcomesError.message, ErrorCodes.INTERNAL_ERROR);

  const outcomeIds = (outcomes ?? []).map((o) => o.id);

  // Get all mastery records for these students Ã— outcomes
  const { data: masteryRecords, error: masteryError } = await supabase
    .from('student_mastery')
    .select('student_id, curriculum_node_id, status')
    .in('student_id', studentIds)
    .in('curriculum_node_id', outcomeIds)
    .is('deleted_at', null);

  if (masteryError) return failure(masteryError.message, ErrorCodes.INTERNAL_ERROR);

  // Get student names
  const { data: students, error: studentsError } = await supabase
    .from('students')
    .select('id, first_name, last_name')
    .in('id', studentIds)
    .is('deleted_at', null)
    .order('last_name')
    .order('first_name');

  if (studentsError) return failure(studentsError.message, ErrorCodes.INTERNAL_ERROR);

  // Build the heatmap rows
  const masteryByStudent = new Map<string, Record<string, MasteryStatus>>();
  for (const record of masteryRecords ?? []) {
    const sid = record.student_id as string;
    const nid = record.curriculum_node_id as string;
    if (!masteryByStudent.has(sid)) masteryByStudent.set(sid, {});
    masteryByStudent.get(sid)![nid] = record.status as MasteryStatus;
  }

  const rows: ClassHeatmapRow[] = (students ?? []).map((student) => ({
    student_id: student.id,
    student_first_name: student.first_name,
    student_last_name: student.last_name,
    statuses: masteryByStudent.get(student.id) ?? {},
  }));

  return success(rows);
}

// ============================================================
// READ: Get mastery summary stats for a single student
// (used for portfolio header and dashboard widgets)
// ============================================================
export async function getStudentMasterySummary(
  studentId: string,
  instanceId: string
): Promise<
  ActionResponse<{
    total: number;
    not_started: number;
    presented: number;
    practicing: number;
    mastered: number;
  }>
> {
  await getTenantContext();
  const supabase = await createSupabaseServerClient();

  // Count total outcome nodes in the instance
  const { count: totalCount, error: countError } = await supabase
    .from('curriculum_nodes')
    .select('id', { count: 'exact', head: true })
    .eq('instance_id', instanceId)
    .eq('level', 'outcome')
    .eq('is_hidden', false)
    .is('deleted_at', null);

  if (countError) return failure(countError.message, ErrorCodes.INTERNAL_ERROR);

  const total = totalCount ?? 0;

  // Fetch outcome IDs once
  const { data: outcomeNodes, error: outcomeIdsError } = await supabase
    .from('curriculum_nodes')
    .select('id')
    .eq('instance_id', instanceId)
    .eq('level', 'outcome')
    .eq('is_hidden', false)
    .is('deleted_at', null);

  if (outcomeIdsError) return failure(outcomeIdsError.message, ErrorCodes.INTERNAL_ERROR);

  const outcomeIds = (outcomeNodes ?? []).map((n) => n.id);

  // Count mastery records by status
  const { data: statusRows, error: statusError } = await supabase
    .from('student_mastery')
    .select('status')
    .eq('student_id', studentId)
    .is('deleted_at', null)
    .in('curriculum_node_id', outcomeIds);

  if (statusError) return failure(statusError.message, ErrorCodes.INTERNAL_ERROR);

  const counts = {
    total,
    not_started: 0,
    presented: 0,
    practicing: 0,
    mastered: 0,
  };

  for (const row of statusRows ?? []) {
    const s = row.status as MasteryStatus;
    if (s in counts) (counts as Record<string, number>)[s]++;
  }

  // not_started = total outcomes minus those with any explicit status
  counts.not_started = total - (counts.presented + counts.practicing + counts.mastered);

  return success(counts);
}

// ============================================================
// READ: Portfolio timeline for a student
// ============================================================
export async function getStudentPortfolioTimeline(
  studentId: string,
  limit: number = 50
): Promise<ActionResponse<PortfolioTimelineItem[]>> {
  await getTenantContext();
  const supabase = await createSupabaseServerClient();

  const timeline: PortfolioTimelineItem[] = [];

  // 1) Get published observations for this student
  const { data: obsStudents, error: obsStudentsError } = await supabase
    .from('observation_students')
    .select('observation_id')
    .eq('student_id', studentId);

  if (obsStudentsError) return failure(obsStudentsError.message, ErrorCodes.INTERNAL_ERROR);

  if (obsStudents && obsStudents.length > 0) {
    const obsIds = obsStudents.map((os) => os.observation_id);

    const { data: observations, error: obsError } = await supabase
      .from('observations')
      .select(
        `
        id, content, status, published_at, created_at,
        author:users!observations_author_id_fkey(first_name, last_name)
      `
      )
      .in('id', obsIds)
      .eq('status', 'published')
      .is('deleted_at', null)
      .order('published_at', { ascending: false })
      .limit(limit);

    if (obsError) return failure(obsError.message, ErrorCodes.INTERNAL_ERROR);

    for (const obs of observations ?? []) {
      const author = obs.author as unknown as { first_name: string | null; last_name: string | null } | null;

      // outcomes for this observation
      const { data: outcomes, error: outcomesError } = await supabase
        .from('observation_outcomes')
        .select('curriculum_node_id, curriculum_nodes!inner(id, title)')
        .eq('observation_id', obs.id);

      if (outcomesError) return failure(outcomesError.message, ErrorCodes.INTERNAL_ERROR);

      // media count
      const { count: mediaCount, error: mediaError } = await supabase
        .from('observation_media')
        .select('id', { count: 'exact', head: true })
        .eq('observation_id', obs.id)
        .is('deleted_at', null);

      if (mediaError) return failure(mediaError.message, ErrorCodes.INTERNAL_ERROR);

      timeline.push({
        type: 'observation',
        date: (obs.published_at as string) ?? (obs.created_at as string),
        observation_id: obs.id as string,
        observation_content: obs.content as string | null,
        observation_author: author
          ? `${author.first_name ?? ''} ${author.last_name ?? ''}`.trim()
          : 'Unknown',
        observation_outcomes: (outcomes ?? []).map((o) => {
          const node = (o as Record<string, unknown>).curriculum_nodes as { id: string; title: string };
          return { id: node.id, title: node.title };
        }),
        observation_media_count: mediaCount ?? 0,
      });
    }
  }

  // 2) Get mastery history for this student
  const { data: masteryChanges, error: masteryError } = await supabase
    .from('mastery_history')
    .select(
      `
      *,
      changed_by_user:users!mastery_history_changed_by_fkey(first_name, last_name),
      curriculum_node:curriculum_nodes!mastery_history_curriculum_node_id_fkey(title)
    `
    )
    .eq('student_id', studentId)
    .order('changed_at', { ascending: false })
    .limit(limit);

  if (masteryError) return failure(masteryError.message, ErrorCodes.INTERNAL_ERROR);

  for (const change of masteryChanges ?? []) {
    const changedByUser = (change as Record<string, unknown>).changed_by_user as
      | { first_name: string | null; last_name: string | null }
      | null;
    const node = (change as Record<string, unknown>).curriculum_node as { title: string } | null;

    timeline.push({
      type: 'mastery_change',
      date: change.changed_at as string,
      mastery_node_title: node?.title ?? 'Unknown outcome',
      mastery_previous_status: change.previous_status as string | null,
      mastery_new_status: change.new_status as string,
      mastery_changed_by: changedByUser
        ? `${changedByUser.first_name ?? ''} ${changedByUser.last_name ?? ''}`.trim()
        : 'System',
    });
  }

  // 3) Sort by date descending
  timeline.sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime());

  return success(timeline.slice(0, limit));
}



===== D:\.code\wattleos\src\lib\actions\medical.ts =====

'use server';

// ============================================================
// WattleOS V2 â€” Medical Conditions Server Actions
// ============================================================
// Normalized medical records. Requires 'view_medical_records'
// permission (enforced by RLS). Parents can view their own
// children's records via is_guardian_of() check.
//
// Fix: createMedicalCondition now calls getTenantContext()
// for tenant_id on INSERT.
// ============================================================

import { createSupabaseServerClient } from '@/lib/supabase/server';
import { getTenantContext } from '@/lib/auth/tenant-context';
import { ActionResponse, success, failure } from '@/types/api';
import { MedicalCondition, MedicalSeverity } from '@/types/domain';

// ============================================================
// Input Types
// ============================================================

export interface CreateMedicalConditionInput {
  student_id: string;
  condition_type: string;
  condition_name: string;
  severity: MedicalSeverity;
  description?: string | null;
  action_plan?: string | null;
  action_plan_doc_url?: string | null;
  requires_medication?: boolean;
  medication_name?: string | null;
  medication_location?: string | null;
  expiry_date?: string | null;
}

export interface UpdateMedicalConditionInput {
  condition_type?: string;
  condition_name?: string;
  severity?: MedicalSeverity;
  description?: string | null;
  action_plan?: string | null;
  action_plan_doc_url?: string | null;
  requires_medication?: boolean;
  medication_name?: string | null;
  medication_location?: string | null;
  expiry_date?: string | null;
}

// ============================================================
// LIST MEDICAL CONDITIONS FOR A STUDENT
// ============================================================

export async function listMedicalConditions(
  studentId: string
): Promise<ActionResponse<MedicalCondition[]>> {
  try {
    const supabase = await createSupabaseServerClient();

    const { data, error } = await supabase
      .from('medical_conditions')
      .select('*')
      .eq('student_id', studentId)
      .is('deleted_at', null)
      .order('severity', { ascending: true });

    if (error) {
      return failure(error.message, 'DB_ERROR');
    }

    return success((data ?? []) as MedicalCondition[]);
  } catch (err) {
    const message = err instanceof Error ? err.message : 'Failed to list medical conditions';
    return failure(message, 'UNEXPECTED_ERROR');
  }
}

// ============================================================
// LIST ALL STUDENTS WITH SEVERE/LIFE-THREATENING CONDITIONS
// ============================================================
// Used for the school-wide medical alerts dashboard.

export async function listCriticalMedicalConditions(): Promise<ActionResponse<MedicalCondition[]>> {
  try {
    const supabase = await createSupabaseServerClient();

    const { data, error } = await supabase
      .from('medical_conditions')
      .select('*, student:students(id, first_name, last_name, preferred_name, photo_url)')
      .in('severity', ['severe', 'life_threatening'])
      .is('deleted_at', null)
      .order('severity', { ascending: true });

    if (error) {
      return failure(error.message, 'DB_ERROR');
    }

    return success((data ?? []) as MedicalCondition[]);
  } catch (err) {
    const message = err instanceof Error ? err.message : 'Failed to list critical conditions';
    return failure(message, 'UNEXPECTED_ERROR');
  }
}

// ============================================================
// CREATE MEDICAL CONDITION
// ============================================================

export async function createMedicalCondition(
  input: CreateMedicalConditionInput
): Promise<ActionResponse<MedicalCondition>> {
  try {
    const context = await getTenantContext();
    const supabase = await createSupabaseServerClient();

    // Validation
    if (!input.student_id) return failure('Student is required', 'VALIDATION_ERROR');
    if (!input.condition_type?.trim()) return failure('Condition type is required', 'VALIDATION_ERROR');
    if (!input.condition_name?.trim()) return failure('Condition name is required', 'VALIDATION_ERROR');
    if (!input.severity) return failure('Severity is required', 'VALIDATION_ERROR');

    const { data, error } = await supabase
      .from('medical_conditions')
      .insert({
        tenant_id: context.tenant.id,
        student_id: input.student_id,
        condition_type: input.condition_type.trim(),
        condition_name: input.condition_name.trim(),
        severity: input.severity,
        description: input.description?.trim() || null,
        action_plan: input.action_plan?.trim() || null,
        action_plan_doc_url: input.action_plan_doc_url || null,
        requires_medication: input.requires_medication ?? false,
        medication_name: input.medication_name?.trim() || null,
        medication_location: input.medication_location?.trim() || null,
        expiry_date: input.expiry_date || null,
      })
      .select()
      .single();

    if (error) {
      return failure(error.message, 'DB_ERROR');
    }

    return success(data as MedicalCondition);
  } catch (err) {
    const message = err instanceof Error ? err.message : 'Failed to create medical condition';
    return failure(message, 'UNEXPECTED_ERROR');
  }
}

// ============================================================
// UPDATE MEDICAL CONDITION
// ============================================================

export async function updateMedicalCondition(
  conditionId: string,
  input: UpdateMedicalConditionInput
): Promise<ActionResponse<MedicalCondition>> {
  try {
    const supabase = await createSupabaseServerClient();

    const updateData: Record<string, unknown> = {};
    if (input.condition_type !== undefined) updateData.condition_type = input.condition_type.trim();
    if (input.condition_name !== undefined) updateData.condition_name = input.condition_name.trim();
    if (input.severity !== undefined) updateData.severity = input.severity;
    if (input.description !== undefined) updateData.description = input.description?.trim() || null;
    if (input.action_plan !== undefined) updateData.action_plan = input.action_plan?.trim() || null;
    if (input.action_plan_doc_url !== undefined) updateData.action_plan_doc_url = input.action_plan_doc_url || null;
    if (input.requires_medication !== undefined) updateData.requires_medication = input.requires_medication;
    if (input.medication_name !== undefined) updateData.medication_name = input.medication_name?.trim() || null;
    if (input.medication_location !== undefined) updateData.medication_location = input.medication_location?.trim() || null;
    if (input.expiry_date !== undefined) updateData.expiry_date = input.expiry_date || null;

    if (Object.keys(updateData).length === 0) {
      return failure('No fields to update', 'VALIDATION_ERROR');
    }

    const { data, error } = await supabase
      .from('medical_conditions')
      .update(updateData)
      .eq('id', conditionId)
      .is('deleted_at', null)
      .select()
      .single();

    if (error) {
      return failure(error.message, 'DB_ERROR');
    }

    if (!data) {
      return failure('Medical condition not found', 'NOT_FOUND');
    }

    return success(data as MedicalCondition);
  } catch (err) {
    const message = err instanceof Error ? err.message : 'Failed to update medical condition';
    return failure(message, 'UNEXPECTED_ERROR');
  }
}

// ============================================================
// DELETE MEDICAL CONDITION (soft delete)
// ============================================================

export async function deleteMedicalCondition(
  conditionId: string
): Promise<ActionResponse<{ id: string }>> {
  try {
    const supabase = await createSupabaseServerClient();

    const { error } = await supabase
      .from('medical_conditions')
      .update({ deleted_at: new Date().toISOString() })
      .eq('id', conditionId)
      .is('deleted_at', null);

    if (error) {
      return failure(error.message, 'DB_ERROR');
    }

    return success({ id: conditionId });
  } catch (err) {
    const message = err instanceof Error ? err.message : 'Failed to delete medical condition';
    return failure(message, 'UNEXPECTED_ERROR');
  }
}


===== D:\.code\wattleos\src\lib\actions\messaging.ts =====

// src/lib/actions/messaging.ts
//
// ============================================================
// WattleOS V2 â€” Messaging Server Actions
// ============================================================
// Thread-based messaging between staff and parents.
// Two thread types:
// â€¢ class_broadcast â€” guide sends to all parents of a class
// â€¢ direct â€” 1:1 between staff and parent
//
// WHY thread model: Groups replies into conversations. A class
// broadcast creates one thread; parents reply within it.
// Direct messages keep 1:1 history clean.
// ============================================================

'use server';

import { createSupabaseServerClient } from '@/lib/supabase/server';
import { getTenantContext, requirePermission } from '@/lib/auth/tenant-context';
import { Permissions } from '@/lib/constants/permissions';
import { ActionResponse, success, failure, ErrorCodes } from '@/types/api';
import type {
  MessageThread,
  MessageThreadWithPreview,
  Message,
  MessageWithSender,
  MessageRecipient,
  User,
  Class,
} from '@/types/domain';
import type { MessageThreadType } from '@/lib/constants/communications';

// ============================================================
// Input Types
// ============================================================

export interface CreateClassBroadcastInput {
  class_id: string;
  subject: string;
  initial_message: string;
}

export interface CreateDirectMessageInput {
  recipient_user_id: string;
  subject?: string;
  initial_message: string;
}

export interface SendMessageInput {
  thread_id: string;
  content: string;
}

// ============================================================
// CREATE CLASS BROADCAST THREAD
// ============================================================
// Permission: SEND_CLASS_MESSAGES
// Creates a thread, sends the first message, and populates
// recipients from all guardians of students enrolled in the
// class, plus the sender.
// ============================================================

export async function createClassBroadcast(
  input: CreateClassBroadcastInput
): Promise<ActionResponse<MessageThread>> {
  try {
    const context = await requirePermission(Permissions.SEND_CLASS_MESSAGES);
    const supabase = await createSupabaseServerClient();

    if (!input.subject?.trim()) {
      return failure('Subject is required', ErrorCodes.VALIDATION_ERROR);
    }
    if (!input.initial_message.trim()) {
      return failure('Message content is required', ErrorCodes.VALIDATION_ERROR);
    }

    // 1. Create the thread
    const { data: thread, error: threadError } = await supabase
      .from('message_threads')
      .insert({
        tenant_id: context.tenant.id,
        subject: input.subject.trim(),
        thread_type: 'class_broadcast' as MessageThreadType,
        class_id: input.class_id,
        created_by: context.user.id,
      })
      .select()
      .single();

    if (threadError || !thread) {
      return failure(
        threadError?.message ?? 'Failed to create thread',
        ErrorCodes.CREATE_FAILED
      );
    }

    const threadData = thread as MessageThread;

    // 2. Send the initial message
    const { error: msgError } = await supabase
      .from('messages')
      .insert({
        tenant_id: context.tenant.id,
        thread_id: threadData.id,
        sender_id: context.user.id,
        content: input.initial_message.trim(),
        sent_at: new Date().toISOString(),
      });

    if (msgError) {
      // Rollback thread creation
      await supabase.from('message_threads').delete().eq('id', threadData.id);
      return failure(msgError.message, ErrorCodes.CREATE_FAILED);
    }

    // 3. Populate recipients: all guardians of enrolled students + sender
    const { data: enrollments } = await supabase
      .from('enrollments')
      .select('student_id')
      .eq('class_id', input.class_id)
      .eq('status', 'active')
      .is('deleted_at', null);

    const studentIds = (enrollments ?? []).map(
      (e) => (e as { student_id: string }).student_id
    );

    let guardianUserIds: string[] = [];
    if (studentIds.length > 0) {
      const { data: guardians } = await supabase
        .from('guardians')
        .select('user_id')
        .in('student_id', studentIds)
        .is('deleted_at', null);

      guardianUserIds = [
        ...new Set(
          (guardians ?? []).map((g) => (g as { user_id: string }).user_id)
        ),
      ];
    }

    // Add the sender (guide) as a recipient too so they see it in their inbox
    const allRecipientIds = [...new Set([context.user.id, ...guardianUserIds])];

    if (allRecipientIds.length > 0) {
      const recipientRows = allRecipientIds.map((userId) => ({
        tenant_id: context.tenant.id,
        thread_id: threadData.id,
        user_id: userId,
        // Sender's own receipt is pre-read
        read_at: userId === context.user.id ? new Date().toISOString() : null,
      }));

      await supabase.from('message_recipients').insert(recipientRows);
    }

    return success(threadData);
  } catch (err) {
    const message = err instanceof Error ? err.message : 'Failed to create broadcast';
    return failure(message, ErrorCodes.INTERNAL_ERROR);
  }
}

// ============================================================
// CREATE DIRECT MESSAGE THREAD
// ============================================================
// Permission: SEND_CLASS_MESSAGES (staff) or any authenticated
// user replying to an existing thread. For new threads, only
// staff can initiate.
// ============================================================

export async function createDirectMessage(
  input: CreateDirectMessageInput
): Promise<ActionResponse<MessageThread>> {
  try {
    const context = await requirePermission(Permissions.SEND_CLASS_MESSAGES);
    const supabase = await createSupabaseServerClient();

    if (!input.initial_message.trim()) {
      return failure('Message content is required', ErrorCodes.VALIDATION_ERROR);
    }

    // Check if a direct thread already exists between these two users
    const { data: existingThreads } = await supabase
      .from('message_threads')
      .select(
        `
        id,
        message_recipients!inner(user_id)
      `
      )
      .eq('thread_type', 'direct')
      .eq('created_by', context.user.id)
      .is('deleted_at', null);

    const existingThread = ((existingThreads ?? []) as Array<Record<string, unknown>>).find(
      (t) => {
        const recipients = t.message_recipients as Array<{ user_id: string }>;
        return recipients.some((r) => r.user_id === input.recipient_user_id);
      }
    );

    if (existingThread) {
      // Thread already exists â€” just send a message to it
      const sendResult = await sendMessage({
        thread_id: existingThread.id as string,
        content: input.initial_message,
      });

      if (sendResult.error) {
        return failure(sendResult.error.message, sendResult.error.code);
      }

      // Return the existing thread
      const { data: threadData } = await supabase
        .from('message_threads')
        .select()
        .eq('id', existingThread.id as string)
        .single();

      return success(threadData as MessageThread);
    }

    // 1. Create new thread
    const { data: thread, error: threadError } = await supabase
      .from('message_threads')
      .insert({
        tenant_id: context.tenant.id,
        subject: input.subject?.trim() || null,
        thread_type: 'direct' as MessageThreadType,
        class_id: null,
        created_by: context.user.id,
      })
      .select()
      .single();

    if (threadError || !thread) {
      return failure(
        threadError?.message ?? 'Failed to create thread',
        ErrorCodes.CREATE_FAILED
      );
    }

    const threadData = thread as MessageThread;

    // 2. Send the initial message
    const { error: msgError } = await supabase
      .from('messages')
      .insert({
        tenant_id: context.tenant.id,
        thread_id: threadData.id,
        sender_id: context.user.id,
        content: input.initial_message.trim(),
        sent_at: new Date().toISOString(),
      });

    if (msgError) {
      await supabase.from('message_threads').delete().eq('id', threadData.id);
      return failure(msgError.message, ErrorCodes.CREATE_FAILED);
    }

    // 3. Add both participants as recipients
    const recipientRows = [
      {
        tenant_id: context.tenant.id,
        thread_id: threadData.id,
        user_id: context.user.id,
        read_at: new Date().toISOString(), // Sender has read their own message
      },
      {
        tenant_id: context.tenant.id,
        thread_id: threadData.id,
        user_id: input.recipient_user_id,
        read_at: null,
      },
    ];

    await supabase.from('message_recipients').insert(recipientRows);

    return success(threadData);
  } catch (err) {
    const message = err instanceof Error ? err.message : 'Failed to create direct message';
    return failure(message, ErrorCodes.INTERNAL_ERROR);
  }
}

// ============================================================
// SEND MESSAGE (reply to existing thread)
// ============================================================
// Any thread participant can reply. Bumps the thread's
// updated_at. Resets read_at for all OTHER recipients
// so they see the thread as unread again.
// ============================================================

export async function sendMessage(
  input: SendMessageInput
): Promise<ActionResponse<Message>> {
  try {
    const context = await getTenantContext();
    const supabase = await createSupabaseServerClient();

    if (!input.content.trim()) {
      return failure('Message content is required', ErrorCodes.VALIDATION_ERROR);
    }

    // Verify the sender is a recipient of this thread
    const { data: recipientCheck } = await supabase
      .from('message_recipients')
      .select('id')
      .eq('thread_id', input.thread_id)
      .eq('user_id', context.user.id)
      .single();

    if (!recipientCheck) {
      // Check if they have messaging permission (staff can message any thread)
      if (!context.permissions.includes(Permissions.SEND_CLASS_MESSAGES)) {
        return failure('You are not a participant in this thread', ErrorCodes.FORBIDDEN);
      }
    }

    // 1. Insert the message
    const { data: message, error: msgError } = await supabase
      .from('messages')
      .insert({
        tenant_id: context.tenant.id,
        thread_id: input.thread_id,
        sender_id: context.user.id,
        content: input.content.trim(),
        sent_at: new Date().toISOString(),
      })
      .select()
      .single();

    if (msgError) {
      return failure(msgError.message, ErrorCodes.CREATE_FAILED);
    }

    // 2. Bump thread's updated_at (for inbox sorting)
    await supabase
      .from('message_threads')
      .update({ updated_at: new Date().toISOString() })
      .eq('id', input.thread_id);

    // 3. Reset read_at for all OTHER recipients (so they see unread)
    await supabase
      .from('message_recipients')
      .update({ read_at: null })
      .eq('thread_id', input.thread_id)
      .neq('user_id', context.user.id);

    // 4. Mark sender's own receipt as read
    await supabase
      .from('message_recipients')
      .update({ read_at: new Date().toISOString() })
      .eq('thread_id', input.thread_id)
      .eq('user_id', context.user.id);

    return success(message as Message);
  } catch (err) {
    const message = err instanceof Error ? err.message : 'Failed to send message';
    return failure(message, ErrorCodes.INTERNAL_ERROR);
  }
}

// ============================================================
// GET INBOX (thread list)
// ============================================================
// Returns all threads the current user participates in,
// ordered by most recently updated. Includes preview of
// the latest message and unread count.
// ============================================================

export async function getInbox(
  params: { limit?: number; offset?: number } = {}
): Promise<ActionResponse<MessageThreadWithPreview[]>> {
  try {
    const context = await getTenantContext();
    const supabase = await createSupabaseServerClient();

    const limit = params.limit ?? 30;
    const offset = params.offset ?? 0;

    // Get thread IDs the user is a recipient of
    const { data: recipientData, error: recipientError } = await supabase
      .from('message_recipients')
      .select('thread_id, read_at')
      .eq('user_id', context.user.id);

    if (recipientError) {
      return failure(recipientError.message, ErrorCodes.DATABASE_ERROR);
    }

    const threadReadMap = new Map<string, string | null>();
    for (const r of (recipientData ?? []) as Array<{ thread_id: string; read_at: string | null }>) {
      threadReadMap.set(r.thread_id, r.read_at);
    }

    const threadIds = [...threadReadMap.keys()];

    if (threadIds.length === 0) {
      return success([]);
    }

    // Fetch threads with creator info
    const { data: threads, error: threadError } = await supabase
      .from('message_threads')
      .select(
        `
        *,
        creator:users!message_threads_created_by_fkey(id, first_name, last_name, avatar_url),
        target_class:classes!message_threads_class_id_fkey(id, name)
      `
      )
      .in('id', threadIds)
      .is('deleted_at', null)
      .order('updated_at', { ascending: false })
      .range(offset, offset + limit - 1);

    if (threadError) {
      return failure(threadError.message, ErrorCodes.DATABASE_ERROR);
    }

    // For each thread, get the latest message and unread count
    const enrichedThreads: MessageThreadWithPreview[] = [];

    for (const thread of (threads ?? []) as Array<Record<string, unknown>>) {
      const threadId = thread.id as string;

      // Latest message
      const { data: lastMessages } = await supabase
        .from('messages')
        .select(
          `
          id, content, sent_at, sender_id,
          sender:users!messages_sender_id_fkey(id, first_name, last_name)
        `
        )
        .eq('thread_id', threadId)
        .is('deleted_at', null)
        .order('sent_at', { ascending: false })
        .limit(1);

      const lastMsg = (lastMessages ?? [])[0] as Record<string, unknown> | undefined;

      // Recipient count
      const { count: recipientCount } = await supabase
        .from('message_recipients')
        .select('id', { count: 'exact', head: true })
        .eq('thread_id', threadId);

      // Unread count for current user: count messages sent AFTER their read_at
      const userReadAt = threadReadMap.get(threadId);
      let unreadCount = 0;

      if (!userReadAt) {
        // Never read â€” all messages are unread (minus own messages)
        const { count } = await supabase
          .from('messages')
          .select('id', { count: 'exact', head: true })
          .eq('thread_id', threadId)
          .neq('sender_id', context.user.id)
          .is('deleted_at', null);
        unreadCount = count ?? 0;
      } else {
        // Count messages after last read
        const { count } = await supabase
          .from('messages')
          .select('id', { count: 'exact', head: true })
          .eq('thread_id', threadId)
          .neq('sender_id', context.user.id)
          .gt('sent_at', userReadAt)
          .is('deleted_at', null);
        unreadCount = count ?? 0;
      }

      enrichedThreads.push({
        id: threadId,
        tenant_id: thread.tenant_id as string,
        subject: thread.subject as string | null,
        thread_type: thread.thread_type as MessageThreadType,
        class_id: thread.class_id as string | null,
        created_by: thread.created_by as string,
        created_at: thread.created_at as string,
        updated_at: thread.updated_at as string,
        creator: thread.creator as Pick<User, 'id' | 'first_name' | 'last_name' | 'avatar_url'>,
        target_class: thread.target_class as Pick<Class, 'id' | 'name'> | null,
        last_message: lastMsg
          ? {
              id: lastMsg.id as string,
              content: lastMsg.content as string,
              sent_at: lastMsg.sent_at as string,
              sender_id: lastMsg.sender_id as string,
            }
          : null,
        last_message_sender: lastMsg?.sender
          ? (lastMsg.sender as Pick<User, 'id' | 'first_name' | 'last_name'>)
          : null,
        unread_count: unreadCount,
        recipient_count: recipientCount ?? 0,
      });
    }

    return success(enrichedThreads);
  } catch (err) {
    const message = err instanceof Error ? err.message : 'Failed to get inbox';
    return failure(message, ErrorCodes.INTERNAL_ERROR);
  }
}

// ============================================================
// GET THREAD MESSAGES
// ============================================================
// Returns all messages in a thread, ordered chronologically.
// Marks the thread as read for the current user.
// ============================================================

export async function getThreadMessages(
  threadId: string
): Promise<ActionResponse<{ thread: MessageThread; messages: MessageWithSender[]; recipients: Array<Pick<User, 'id' | 'first_name' | 'last_name' | 'avatar_url'>> }>> {
  try {
    const context = await getTenantContext();
    const supabase = await createSupabaseServerClient();

    // Verify user is a participant (or has staff permission)
    const { data: recipientCheck } = await supabase
      .from('message_recipients')
      .select('id')
      .eq('thread_id', threadId)
      .eq('user_id', context.user.id)
      .single();

    if (!recipientCheck && !context.permissions.includes(Permissions.SEND_CLASS_MESSAGES)) {
      return failure('You are not a participant in this thread', ErrorCodes.FORBIDDEN);
    }

    // Fetch thread
    const { data: thread, error: threadError } = await supabase
      .from('message_threads')
      .select()
      .eq('id', threadId)
      .is('deleted_at', null)
      .single();

    if (threadError || !thread) {
      return failure('Thread not found', ErrorCodes.NOT_FOUND);
    }

    // Fetch messages
    const { data: messages, error: msgError } = await supabase
      .from('messages')
      .select(
        `
        *,
        sender:users!messages_sender_id_fkey(id, first_name, last_name, avatar_url)
      `
      )
      .eq('thread_id', threadId)
      .is('deleted_at', null)
      .order('sent_at', { ascending: true });

    if (msgError) {
      return failure(msgError.message, ErrorCodes.DATABASE_ERROR);
    }

    // Fetch recipients with user info
    const { data: recipientRows } = await supabase
      .from('message_recipients')
      .select(
        `
        user:users!message_recipients_user_id_fkey(id, first_name, last_name, avatar_url)
      `
      )
      .eq('thread_id', threadId);

    const recipients = ((recipientRows ?? []) as Array<Record<string, unknown>>).map(
      (r) => r.user as Pick<User, 'id' | 'first_name' | 'last_name' | 'avatar_url'>
    );

    // Mark as read for the current user
    await supabase
      .from('message_recipients')
      .update({ read_at: new Date().toISOString() })
      .eq('thread_id', threadId)
      .eq('user_id', context.user.id);

    const typedMessages: MessageWithSender[] = ((messages ?? []) as Array<Record<string, unknown>>).map(
      (msg) => ({
        id: msg.id as string,
        tenant_id: msg.tenant_id as string,
        thread_id: msg.thread_id as string,
        sender_id: msg.sender_id as string,
        content: msg.content as string,
        sent_at: msg.sent_at as string,
        created_at: msg.created_at as string,
        sender: msg.sender as Pick<User, 'id' | 'first_name' | 'last_name' | 'avatar_url'>,
      })
    );

    return success({
      thread: thread as MessageThread,
      messages: typedMessages,
      recipients,
    });
  } catch (err) {
    const message = err instanceof Error ? err.message : 'Failed to get thread';
    return failure(message, ErrorCodes.INTERNAL_ERROR);
  }
}

// ============================================================
// MARK THREAD AS READ
// ============================================================
// Updates the current user's read_at on the message_recipients
// row for this thread.
// ============================================================

export async function markThreadRead(
  threadId: string
): Promise<ActionResponse<MessageRecipient>> {
  try {
    const context = await getTenantContext();
    const supabase = await createSupabaseServerClient();

    const { data, error } = await supabase
      .from('message_recipients')
      .update({ read_at: new Date().toISOString() })
      .eq('thread_id', threadId)
      .eq('user_id', context.user.id)
      .select()
      .single();

    if (error) {
      return failure(error.message, ErrorCodes.DATABASE_ERROR);
    }

    return success(data as MessageRecipient);
  } catch (err) {
    const message = err instanceof Error ? err.message : 'Failed to mark as read';
    return failure(message, ErrorCodes.INTERNAL_ERROR);
  }
}

// ============================================================
// GET UNREAD MESSAGE COUNT
// ============================================================
// Counts threads with unread messages for the current user.
// Used for sidebar notification badge.
// ============================================================

export async function getUnreadMessageCount(): Promise<ActionResponse<number>> {
  try {
    const context = await getTenantContext();
    const supabase = await createSupabaseServerClient();

    // Get all threads user participates in where read_at is null
    // (meaning they have never read the thread or new messages arrived)
    const { data: unreadRecipients, error } = await supabase
      .from('message_recipients')
      .select('thread_id')
      .eq('user_id', context.user.id)
      .is('read_at', null);

    if (error) {
      return failure(error.message, ErrorCodes.DATABASE_ERROR);
    }

    // For each "unread" thread, verify there are actually messages not from this user
    let unreadCount = 0;
    const threadIds = (unreadRecipients ?? []).map(
      (r) => (r as { thread_id: string }).thread_id
    );

    if (threadIds.length > 0) {
      // Count threads that have at least one message not from the current user
      for (const threadId of threadIds) {
        const { count } = await supabase
          .from('messages')
          .select('id', { count: 'exact', head: true })
          .eq('thread_id', threadId)
          .neq('sender_id', context.user.id)
          .is('deleted_at', null);

        if ((count ?? 0) > 0) {
          unreadCount++;
        }
      }
    }

    return success(unreadCount);
  } catch (err) {
    const message = err instanceof Error ? err.message : 'Failed to get unread count';
    return failure(message, ErrorCodes.INTERNAL_ERROR);
  }
}

// ============================================================
// DELETE THREAD (soft delete, staff only)
// ============================================================

export async function deleteThread(
  threadId: string
): Promise<ActionResponse<{ deleted: boolean }>> {
  try {
    await requirePermission(Permissions.SEND_CLASS_MESSAGES);
    const supabase = await createSupabaseServerClient();

    const { error } = await supabase
      .from('message_threads')
      .update({ deleted_at: new Date().toISOString() })
      .eq('id', threadId)
      .is('deleted_at', null);

    if (error) {
      return failure(error.message, ErrorCodes.DELETE_FAILED);
    }

    return success({ deleted: true });
  } catch (err) {
    const message = err instanceof Error ? err.message : 'Failed to delete thread';
    return failure(message, ErrorCodes.INTERNAL_ERROR);
  }
}


===== D:\.code\wattleos\src\lib\actions\observations.ts =====

// src/lib/actions/observations.ts
'use server';

import { createSupabaseServerClient } from '@/lib/supabase/server';
import { getTenantContext, requirePermission } from '@/lib/auth/tenant-context';
import { Permissions } from '@/lib/constants/permissions';
import type { ActionResponse, PaginatedResponse } from '@/types/api';
import { success, failure, ErrorCodes } from '@/types/api';
import type {
  Observation,
  ObservationFeedItem,
  ObservationMedia,
  Student,
  CurriculumNode,
  User,
} from '@/types/domain';

// Local helper types for relation rows returned by Supabase selects.
// (We keep them minimal and then map into canonical domain shapes.)
type AuthorRow = Pick<User, 'id' | 'first_name' | 'last_name' | 'avatar_url'>;

type StudentPick = Pick<Student, 'id' | 'first_name' | 'last_name' | 'preferred_name' | 'photo_url'>;
type OutcomePick = Pick<CurriculumNode, 'id' | 'title' | 'level'>;

type ObsRow = {
  id: string;
  content: string | null;
  status: Observation['status'];
  created_at: string;
  published_at: string | null;
  author_id: string;
};

// Local â€œjoin rowâ€ shapes for mapping
type ObservationStudentJoin = { student: StudentPick };
type ObservationOutcomeJoin = { curriculum_node: OutcomePick };

// ============================================================
// CREATE: New observation (starts as draft)
// ============================================================
export async function createObservation(input: {
  content: string;
  studentIds: string[];
  outcomeIds: string[];
}): Promise<ActionResponse<Observation>> {
  const context = await requirePermission(Permissions.CREATE_OBSERVATION);
  const supabase = await createSupabaseServerClient();

  // 1. Create the observation
  const { data: observation, error: obsError } = await supabase
    .from('observations')
    .insert({
      tenant_id: context.tenant.id,
      author_id: context.user.id,
      content: input.content,
      status: 'draft',
    })
    .select()
    .single();

  if (obsError || !observation) {
    return failure(obsError?.message ?? 'Failed to create observation', ErrorCodes.INTERNAL_ERROR);
  }

  // 2. Tag students
  if (input.studentIds.length > 0) {
    const studentInserts = input.studentIds.map((studentId) => ({
      tenant_id: context.tenant.id,
      observation_id: (observation as any).id,
      student_id: studentId,
    }));

    const { error: studentsError } = await supabase.from('observation_students').insert(studentInserts);

    if (studentsError) {
      // Non-fatal: observation was created, students just failed to tag
      console.error('Failed to tag students:', studentsError.message);
    }
  }

  // 3. Tag curriculum outcomes
  if (input.outcomeIds.length > 0) {
    const outcomeInserts = input.outcomeIds.map((nodeId) => ({
      tenant_id: context.tenant.id,
      observation_id: (observation as any).id,
      curriculum_node_id: nodeId,
    }));

    const { error: outcomesError } = await supabase.from('observation_outcomes').insert(outcomeInserts);

    if (outcomesError) {
      console.error('Failed to tag outcomes:', outcomesError.message);
    }
  }

  return success(observation as Observation);
}

// ============================================================
// UPDATE: Edit an observation draft
// ============================================================
export async function updateObservation(
  observationId: string,
  input: {
    content?: string;
    studentIds?: string[];
    outcomeIds?: string[];
  }
): Promise<ActionResponse<Observation>> {
  const context = await requirePermission(Permissions.CREATE_OBSERVATION);
  const supabase = await createSupabaseServerClient();

  // Verify ownership and draft status
  const { data: existing, error: existingError } = await supabase
    .from('observations')
    .select('id, author_id, status')
    .eq('id', observationId)
    .is('deleted_at', null)
    .single();

  if (existingError) return failure(existingError.message, ErrorCodes.INTERNAL_ERROR);
  if (!existing) return failure('Observation not found', ErrorCodes.NOT_FOUND);

  if ((existing as any).status === 'published') {
    return failure('Published observations cannot be edited', ErrorCodes.VALIDATION_ERROR);
  }

  if ((existing as any).author_id !== context.user.id) {
    return failure('Only the author can edit a draft', ErrorCodes.FORBIDDEN);
  }

  // Update content if provided
  if (input.content !== undefined) {
    const { error } = await supabase.from('observations').update({ content: input.content }).eq('id', observationId);
    if (error) return failure(error.message, ErrorCodes.INTERNAL_ERROR);
  }

  // Replace student tags if provided
  if (input.studentIds !== undefined) {
    await supabase.from('observation_students').delete().eq('observation_id', observationId);

    if (input.studentIds.length > 0) {
      const { error } = await supabase.from('observation_students').insert(
        input.studentIds.map((sid) => ({
          tenant_id: context.tenant.id,
          observation_id: observationId,
          student_id: sid,
        }))
      );
      if (error) return failure(error.message, ErrorCodes.INTERNAL_ERROR);
    }
  }

  // Replace outcome tags if provided
  if (input.outcomeIds !== undefined) {
    await supabase.from('observation_outcomes').delete().eq('observation_id', observationId);

    if (input.outcomeIds.length > 0) {
      const { error } = await supabase.from('observation_outcomes').insert(
        input.outcomeIds.map((nid) => ({
          tenant_id: context.tenant.id,
          observation_id: observationId,
          curriculum_node_id: nid,
        }))
      );
      if (error) return failure(error.message, ErrorCodes.INTERNAL_ERROR);
    }
  }

  // Fetch updated observation
  const { data, error } = await supabase.from('observations').select('*').eq('id', observationId).single();
  if (error || !data) return failure('Failed to fetch updated observation', ErrorCodes.INTERNAL_ERROR);

  return success(data as Observation);
}

// ============================================================
// PUBLISH: Transition observation from draft to published
// ============================================================
export async function publishObservation(observationId: string): Promise<ActionResponse<Observation>> {
  await requirePermission(Permissions.PUBLISH_OBSERVATION);
  const supabase = await createSupabaseServerClient();

  const { data, error } = await supabase
    .from('observations')
    .update({
      status: 'published',
      published_at: new Date().toISOString(),
    })
    .eq('id', observationId)
    .eq('status', 'draft')
    .is('deleted_at', null)
    .select()
    .single();

  if (error || !data) {
    return failure(error?.message ?? 'Observation not found or already published', ErrorCodes.NOT_FOUND);
  }

  return success(data as Observation);
}

// ============================================================
// ARCHIVE: Soft-archive a published observation
// ============================================================
export async function archiveObservation(observationId: string): Promise<ActionResponse<Observation>> {
  await requirePermission(Permissions.PUBLISH_OBSERVATION);
  const supabase = await createSupabaseServerClient();

  const { data, error } = await supabase
    .from('observations')
    .update({ status: 'archived' })
    .eq('id', observationId)
    .is('deleted_at', null)
    .select()
    .single();

  if (error || !data) return failure(error?.message ?? 'Observation not found', ErrorCodes.NOT_FOUND);

  return success(data as Observation);
}

// ============================================================
// DELETE: Soft-delete a draft observation
// ============================================================
export async function deleteObservation(
  observationId: string
): Promise<ActionResponse<{ success: boolean }>> {
  const context = await requirePermission(Permissions.CREATE_OBSERVATION);
  const supabase = await createSupabaseServerClient();

  const { data: existing, error: existingError } = await supabase
    .from('observations')
    .select('author_id, status')
    .eq('id', observationId)
    .is('deleted_at', null)
    .single();

  if (existingError) return failure(existingError.message, ErrorCodes.INTERNAL_ERROR);
  if (!existing) return failure('Observation not found', ErrorCodes.NOT_FOUND);

  if ((existing as any).status !== 'draft') {
    return failure('Only drafts can be deleted', ErrorCodes.VALIDATION_ERROR);
  }

  if ((existing as any).author_id !== context.user.id) {
    return failure('Only the author can delete a draft', ErrorCodes.FORBIDDEN);
  }

  const { error } = await supabase
    .from('observations')
    .update({ deleted_at: new Date().toISOString() })
    .eq('id', observationId);

  if (error) return failure(error.message, ErrorCodes.INTERNAL_ERROR);

  return success({ success: true });
}

// ============================================================
// FEED: Get observation feed with relations (paginated)
// ============================================================
export async function getObservationFeed(options?: {
  page?: number;
  perPage?: number;
  status?: 'draft' | 'published' | 'archived';
  studentId?: string;
  outcomeId?: string;
  authorId?: string;
}): Promise<PaginatedResponse<ObservationFeedItem>> {
  await getTenantContext();
  const supabase = await createSupabaseServerClient();

  const page = options?.page ?? 1;
  const perPage = options?.perPage ?? 20;
  const offset = (page - 1) * perPage;

  let countQuery = supabase
    .from('observations')
    .select('id', { count: 'exact', head: true })
    .is('deleted_at', null);

  let dataQuery = supabase
    .from('observations')
    .select('id, content, status, created_at, published_at, author_id')
    .is('deleted_at', null)
    .order('created_at', { ascending: false })
    .range(offset, offset + perPage - 1);

  if (options?.status) {
    countQuery = countQuery.eq('status', options.status);
    dataQuery = dataQuery.eq('status', options.status);
  }

  if (options?.authorId) {
    countQuery = countQuery.eq('author_id', options.authorId);
    dataQuery = dataQuery.eq('author_id', options.authorId);
  }

  if (options?.studentId) {
    const { data: obsIds, error } = await supabase
      .from('observation_students')
      .select('observation_id')
      .eq('student_id', options.studentId);

    if (error) {
      return {
        data: [],
        pagination: { total: 0, page, per_page: perPage, total_pages: 0 },
        error: { message: error.message, code: ErrorCodes.INTERNAL_ERROR },
      };
    }

    const ids = (obsIds ?? []).map((r: any) => r.observation_id as string);
    if (ids.length === 0) {
      return { data: [], pagination: { total: 0, page, per_page: perPage, total_pages: 0 }, error: null };
    }
    countQuery = countQuery.in('id', ids);
    dataQuery = dataQuery.in('id', ids);
  }

  if (options?.outcomeId) {
    const { data: obsIds, error } = await supabase
      .from('observation_outcomes')
      .select('observation_id')
      .eq('curriculum_node_id', options.outcomeId);

    if (error) {
      return {
        data: [],
        pagination: { total: 0, page, per_page: perPage, total_pages: 0 },
        error: { message: error.message, code: ErrorCodes.INTERNAL_ERROR },
      };
    }

    const ids = (obsIds ?? []).map((r: any) => r.observation_id as string);
    if (ids.length === 0) {
      return { data: [], pagination: { total: 0, page, per_page: perPage, total_pages: 0 }, error: null };
    }
    countQuery = countQuery.in('id', ids);
    dataQuery = dataQuery.in('id', ids);
  }

  const { count, error: countError } = await countQuery;
  if (countError) {
    return {
      data: [],
      pagination: { total: 0, page, per_page: perPage, total_pages: 0 },
      error: { message: countError.message, code: ErrorCodes.INTERNAL_ERROR },
    };
  }

  const { data: observations, error: dataError } = await dataQuery;
  if (dataError || !observations) {
    return {
      data: [],
      pagination: { total: 0, page, per_page: perPage, total_pages: 0 },
      error: { message: dataError?.message ?? 'Failed', code: ErrorCodes.INTERNAL_ERROR },
    };
  }

  const obsRows = observations as unknown as ObsRow[];

  if (obsRows.length === 0) {
    return {
      data: [],
      pagination: {
        total: count ?? 0,
        page,
        per_page: perPage,
        total_pages: Math.ceil((count ?? 0) / perPage),
      },
      error: null,
    };
  }

  const obsIds = obsRows.map((o) => o.id);
  const authorIds = [...new Set(obsRows.map((o) => o.author_id))];

  const [authorsRes, studentsRes, outcomesRes, mediaRes] = await Promise.all([
    supabase.from('users').select('id, first_name, last_name, avatar_url').in('id', authorIds),
    supabase
      .from('observation_students')
      .select('observation_id, student:students(id, first_name, last_name, preferred_name, photo_url)')
      .in('observation_id', obsIds),
    supabase
      .from('observation_outcomes')
      .select('observation_id, curriculum_node:curriculum_nodes(id, title, level)')
      .in('observation_id', obsIds),
    supabase
      .from('observation_media')
      .select('*')
      .in('observation_id', obsIds)
      .is('deleted_at', null),
  ]);

  const authorMap = new Map<string, AuthorRow>(
    (authorsRes.data ?? []).map((a: any) => [
      a.id as string,
      {
        id: a.id as string,
        first_name: a.first_name ?? null,
        last_name: a.last_name ?? null,
        avatar_url: a.avatar_url ?? null,
      } satisfies AuthorRow,
    ])
  );

  // observation_students map: obsId -> [{ student }]
  const studentsByObs = new Map<string, ObservationStudentJoin[]>();
  for (const row of (studentsRes.data ?? []) as any[]) {
    const obsId = row.observation_id as string;
    const student = row.student as StudentPick | null;
    if (!student) continue;

    if (!studentsByObs.has(obsId)) studentsByObs.set(obsId, []);
    studentsByObs.get(obsId)!.push({ student });
  }

  // observation_outcomes map: obsId -> [{ curriculum_node }]
  const outcomesByObs = new Map<string, ObservationOutcomeJoin[]>();
  for (const row of (outcomesRes.data ?? []) as any[]) {
    const obsId = row.observation_id as string;
    const node = row.curriculum_node as OutcomePick | null;
    if (!node) continue;

    if (!outcomesByObs.has(obsId)) outcomesByObs.set(obsId, []);
    outcomesByObs.get(obsId)!.push({ curriculum_node: node });
  }

  // observation_media map: obsId -> ObservationMedia[]
  const mediaByObs = new Map<string, ObservationMedia[]>();
  for (const row of (mediaRes.data ?? []) as any[]) {
    const obsId = row.observation_id as string;
    if (!mediaByObs.has(obsId)) mediaByObs.set(obsId, []);
    mediaByObs.get(obsId)!.push(row as ObservationMedia);
  }

  const feedItems: ObservationFeedItem[] = obsRows.map((obs) => ({
    id: obs.id,
    content: obs.content,
    status: obs.status,
    published_at: obs.published_at,
    created_at: obs.created_at,
    author:
      authorMap.get(obs.author_id) ??
      ({
        id: obs.author_id,
        first_name: null,
        last_name: null,
        avatar_url: null,
      } as AuthorRow),
    students: (studentsByObs.get(obs.id) ?? []).map((os: ObservationStudentJoin) => os.student),
    outcomes: (outcomesByObs.get(obs.id) ?? []).map((oo: ObservationOutcomeJoin) => oo.curriculum_node),
    media: mediaByObs.get(obs.id) ?? [],
  }));

  return {
    data: feedItems,
    pagination: {
      total: count ?? 0,
      page,
      per_page: perPage,
      total_pages: Math.ceil((count ?? 0) / perPage),
    },
    error: null,
  };
}

// ============================================================
// GET: Single observation with full relations
// ============================================================
export async function getObservation(
  observationId: string
): Promise<ActionResponse<ObservationFeedItem>> {
  await getTenantContext();
  const supabase = await createSupabaseServerClient();

  const { data: obs, error: obsError } = await supabase
    .from('observations')
    .select('id, content, status, created_at, published_at, author_id')
    .eq('id', observationId)
    .is('deleted_at', null)
    .single();

  if (obsError) return failure(obsError.message, ErrorCodes.INTERNAL_ERROR);
  if (!obs) return failure('Observation not found', ErrorCodes.NOT_FOUND);

  const obsRow = obs as unknown as ObsRow;

  const [authorRes, studentsRes, outcomesRes, mediaRes] = await Promise.all([
    supabase.from('users').select('id, first_name, last_name, avatar_url').eq('id', obsRow.author_id).single(),
    supabase
      .from('observation_students')
      .select('student:students(id, first_name, last_name, preferred_name, photo_url)')
      .eq('observation_id', observationId),
    supabase
      .from('observation_outcomes')
      .select('curriculum_node:curriculum_nodes(id, title, level)')
      .eq('observation_id', observationId),
    supabase.from('observation_media').select('*').eq('observation_id', observationId).is('deleted_at', null),
  ]);

  const author: AuthorRow =
    (authorRes.data as any) ??
    ({
      id: obsRow.author_id,
      first_name: null,
      last_name: null,
      avatar_url: null,
    } as AuthorRow);

  const observation_students: ObservationStudentJoin[] = ((studentsRes.data ?? []) as any[])
    .filter((r) => r.student)
    .map((r) => ({ student: r.student as StudentPick }));

  const observation_outcomes: ObservationOutcomeJoin[] = ((outcomesRes.data ?? []) as any[])
    .filter((r) => r.curriculum_node)
    .map((r) => ({ curriculum_node: r.curriculum_node as OutcomePick }));

  const observation_media: ObservationMedia[] = ((mediaRes.data ?? []) as any[]).map((m) => m as ObservationMedia);

  const feedItem: ObservationFeedItem = {
    id: obsRow.id,
    content: obsRow.content,
    status: obsRow.status,
    created_at: obsRow.created_at,
    published_at: obsRow.published_at,
    author,
    students: observation_students.map((os: ObservationStudentJoin) => os.student),
    outcomes: observation_outcomes.map((oo: ObservationOutcomeJoin) => oo.curriculum_node),
    media: observation_media,
  };

  return success(feedItem);
}

// ============================================================
// MEDIA: Record a media attachment (after upload to storage)
// ============================================================
export async function addObservationMedia(input: {
  observationId: string;
  mediaType: 'image' | 'video' | 'audio' | 'document';
  storageProvider: 'supabase' | 'google_drive';
  storagePath?: string;
  googleDriveFileId?: string;
  thumbnailUrl?: string;
  fileName?: string;
  fileSizeBytes?: number;
}): Promise<ActionResponse<ObservationMedia>> {
  const context = await requirePermission(Permissions.CREATE_OBSERVATION);
  const supabase = await createSupabaseServerClient();

  const { data, error } = await supabase
    .from('observation_media')
    .insert({
      tenant_id: context.tenant.id,
      observation_id: input.observationId,
      media_type: input.mediaType,
      storage_provider: input.storageProvider,
      storage_path: input.storagePath ?? null,
      google_drive_file_id: input.googleDriveFileId ?? null,
      thumbnail_url: input.thumbnailUrl ?? null,
      file_name: input.fileName ?? null,
      file_size_bytes: input.fileSizeBytes ?? null,
    })
    .select()
    .single();

  if (error || !data) {
    return failure(error?.message ?? 'Failed to add media', ErrorCodes.INTERNAL_ERROR);
  }

  return success(data as ObservationMedia);
}

// ============================================================
// MEDIA: Delete a media attachment
// ============================================================
export async function deleteObservationMedia(
  mediaId: string
): Promise<ActionResponse<{ success: boolean }>> {
  await requirePermission(Permissions.CREATE_OBSERVATION);
  const supabase = await createSupabaseServerClient();

  const { error } = await supabase
    .from('observation_media')
    .update({ deleted_at: new Date().toISOString() })
    .eq('id', mediaId);

  if (error) return failure(error.message, ErrorCodes.INTERNAL_ERROR);

  return success({ success: true });
}



===== D:\.code\wattleos\src\lib\actions\parent\attendance.ts =====

// src/lib/actions/parent/attendance.ts
//
// ============================================================
// WattleOS V2 â€” Parent Portal: Attendance Actions
// ============================================================
// Fetches attendance records for a parent's child. Read-only
// view â€” parents can see but not modify attendance.
//
// WHY separate from staff attendance: Parents see a simplified
// view without class-level aggregation or recording controls.
// ============================================================

'use server';

import { createSupabaseServerClient } from '@/lib/supabase/server';
import { getTenantContext } from '@/lib/auth/tenant-context';
import { isGuardianOf } from './children';
import type { ActionResponse } from '@/types/api';
import type { AttendanceStatus } from '@/types/domain';

// ============================================================
// Types
// ============================================================

export interface ChildAttendanceRecord {
  id: string;
  date: string;
  status: AttendanceStatus;
  checkInAt: string | null;
  checkOutAt: string | null;
  notes: string | null;
}

export interface ChildAttendanceSummary {
  totalDays: number;
  present: number;
  absent: number;
  late: number;
  excused: number;
  halfDay: number;
  attendanceRate: number;
}

export interface ChildAttendanceResponse {
  records: ChildAttendanceRecord[];
  summary: ChildAttendanceSummary;
}

// ============================================================
// getChildAttendance â€” records + summary for a date range
// ============================================================

export async function getChildAttendance(
  studentId: string,
  params?: {
    startDate?: string;
    endDate?: string;
    page?: number;
    perPage?: number;
  }
): Promise<ActionResponse<ChildAttendanceResponse>> {
  try {
    const context = await getTenantContext();

    const isGuardian = await isGuardianOf(studentId);
    if (!isGuardian) {
      return { data: null, error: { message: 'Not authorized', code: 'FORBIDDEN' } };
    }

    const supabase = await createSupabaseServerClient();
    const page = params?.page ?? 1;
    const perPage = params?.perPage ?? 50;
    const offset = (page - 1) * perPage;

    // Default to current term (last 90 days if no dates provided)
    const endDate = params?.endDate ?? new Date().toISOString().split('T')[0];
    const defaultStart = new Date();
    defaultStart.setDate(defaultStart.getDate() - 90);
    const startDate = params?.startDate ?? defaultStart.toISOString().split('T')[0];

    // Fetch records
    let query = supabase
      .from('attendance_records')
      .select('id, date, status, check_in_at, check_out_at, notes')
      .eq('tenant_id', context.tenant.id)
      .eq('student_id', studentId)
      .gte('date', startDate)
      .lte('date', endDate)
      .is('deleted_at', null)
      .order('date', { ascending: false });

    // Paginate
    query = query.range(offset, offset + perPage - 1);

    const { data, error } = await query;

    if (error) {
      return { data: null, error: { message: error.message, code: 'QUERY_ERROR' } };
    }

    const records: ChildAttendanceRecord[] = (data ?? []).map((r) => ({
      id: r.id,
      date: r.date,
      status: r.status as AttendanceStatus,
      checkInAt: r.check_in_at,
      checkOutAt: r.check_out_at,
      notes: r.notes,
    }));

    // Summary for the full date range (not paginated)
    const { data: allRecords } = await supabase
      .from('attendance_records')
      .select('status')
      .eq('tenant_id', context.tenant.id)
      .eq('student_id', studentId)
      .gte('date', startDate)
      .lte('date', endDate)
      .is('deleted_at', null);

    const all = allRecords ?? [];
    const totalDays = all.length;
    const present = all.filter((r) => r.status === 'present').length;
    const absent = all.filter((r) => r.status === 'absent').length;
    const late = all.filter((r) => r.status === 'late').length;
    const excused = all.filter((r) => r.status === 'excused').length;
    const halfDay = all.filter((r) => r.status === 'half_day').length;
    const attendanceRate = totalDays > 0
      ? Math.round(((present + late + halfDay) / totalDays) * 100)
      : 0;

    return {
      data: {
        records,
        summary: { totalDays, present, absent, late, excused, halfDay, attendanceRate },
      },
      error: null,
    };
  } catch (err) {
    return {
      data: null,
      error: { message: err instanceof Error ? err.message : 'Unknown error', code: 'INTERNAL_ERROR' },
    };
  }
}

// ============================================================
// getChildAttendanceWeek â€” current week at a glance
// ============================================================

export async function getChildAttendanceWeek(
  studentId: string
): Promise<ActionResponse<ChildAttendanceRecord[]>> {
  try {
    const context = await getTenantContext();

    const isGuardian = await isGuardianOf(studentId);
    if (!isGuardian) {
      return { data: null, error: { message: 'Not authorized', code: 'FORBIDDEN' } };
    }

    const supabase = await createSupabaseServerClient();

    // Get Monday of current week
    const now = new Date();
    const day = now.getDay();
    const monday = new Date(now);
    monday.setDate(now.getDate() - (day === 0 ? 6 : day - 1));
    const mondayStr = monday.toISOString().split('T')[0];

    const friday = new Date(monday);
    friday.setDate(monday.getDate() + 4);
    const fridayStr = friday.toISOString().split('T')[0];

    const { data, error } = await supabase
      .from('attendance_records')
      .select('id, date, status, check_in_at, check_out_at, notes')
      .eq('tenant_id', context.tenant.id)
      .eq('student_id', studentId)
      .gte('date', mondayStr)
      .lte('date', fridayStr)
      .is('deleted_at', null)
      .order('date', { ascending: true });

    if (error) {
      return { data: null, error: { message: error.message, code: 'QUERY_ERROR' } };
    }

    return {
      data: (data ?? []).map((r) => ({
        id: r.id,
        date: r.date,
        status: r.status as AttendanceStatus,
        checkInAt: r.check_in_at,
        checkOutAt: r.check_out_at,
        notes: r.notes,
      })),
      error: null,
    };
  } catch (err) {
    return {
      data: null,
      error: { message: err instanceof Error ? err.message : 'Unknown error', code: 'INTERNAL_ERROR' },
    };
  }
}


===== D:\.code\wattleos\src\lib\actions\parent\children.ts =====

// src/lib/actions/parent/children.ts
//
// ============================================================
// WattleOS V2 â€” Parent Portal: Children Actions
// ============================================================
// Fetches children and overview data for the logged-in parent.
// Authorization is via guardian relationship, not permissions.
//
// WHY guardian-based auth: Parents don't have staff permissions.
// The is_guardian_of() RLS function handles DB-level security,
// and we double-check at the application layer for defense in
// depth.
// ============================================================

'use server';

import { createSupabaseServerClient } from '@/lib/supabase/server';
import { getTenantContext } from '@/lib/auth/tenant-context';
import type { ActionResponse } from '@/types/api';

// ============================================================
// Types
// ============================================================

export interface ParentChild {
  id: string;
  firstName: string;
  lastName: string;
  preferredName: string | null;
  photoUrl: string | null;
  dob: string | null;
  className: string | null;
  classId: string | null;
  guardianId: string;
  relationship: string;
  isPrimary: boolean;
}

export interface ChildOverview {
  child: ParentChild;
  attendance: {
    totalDays: number;
    present: number;
    absent: number;
    late: number;
    attendanceRate: number;
    lastRecordDate: string | null;
  };
  recentObservations: Array<{
    id: string;
    content: string | null;
    authorName: string;
    createdAt: string;
    mediaCount: number;
  }>;
  mastery: {
    total: number;
    mastered: number;
    practicing: number;
    presented: number;
    percentMastered: number;
  };
  publishedReportCount: number;
}

// ============================================================
// requireGuardian â€” verifies user is a guardian in this tenant
// ============================================================

export async function getMyGuardianRecords(): Promise<
  ActionResponse<
    Array<{
      guardianId: string;
      studentId: string;
      relationship: string;
      isPrimary: boolean;
      mediaConsent: boolean;
      directoryConsent: boolean;
      phone: string | null;
    }>
  >
> {
  try {
    const context = await getTenantContext();
    const supabase = await createSupabaseServerClient();

    const { data, error } = await supabase
      .from('guardians')
      .select('id, student_id, relationship, is_primary, media_consent, directory_consent, phone')
      .eq('tenant_id', context.tenant.id)
      .eq('user_id', context.user.id)
      .is('deleted_at', null);

    if (error) {
      return { data: null, error: { message: error.message, code: 'QUERY_ERROR' } };
    }

    return {
      data: (data ?? []).map((g) => ({
        guardianId: g.id,
        studentId: g.student_id,
        relationship: g.relationship,
        isPrimary: g.is_primary,
        mediaConsent: g.media_consent,
        directoryConsent: g.directory_consent,
        phone: g.phone,
      })),
      error: null,
    };
  } catch (err) {
    return {
      data: null,
      error: { message: err instanceof Error ? err.message : 'Unknown error', code: 'INTERNAL_ERROR' },
    };
  }
}

// ============================================================
// getMyChildren â€” lists all children for the logged-in parent
// ============================================================

export async function getMyChildren(): Promise<ActionResponse<ParentChild[]>> {
  try {
    const context = await getTenantContext();
    const supabase = await createSupabaseServerClient();

    // Fetch guardian records with student + current enrollment/class
    const { data, error } = await supabase
      .from('guardians')
      .select(
        `
        id,
        relationship,
        is_primary,
        student:students!inner(
          id,
          first_name,
          last_name,
          preferred_name,
          photo_url,
          dob
        )
      `
      )
      .eq('tenant_id', context.tenant.id)
      .eq('user_id', context.user.id)
      .is('deleted_at', null);

    if (error) {
      return { data: null, error: { message: error.message, code: 'QUERY_ERROR' } };
    }

    if (!data || data.length === 0) {
      return { data: [], error: null };
    }

    // Get current class for each student via active enrollments
    const studentIds = data.map(
      (g) => (g.student as unknown as { id: string }).id
    );

    const { data: enrollments } = await supabase
      .from('enrollments')
      .select(
        `
        student_id,
        class:classes(id, name)
      `
      )
      .eq('tenant_id', context.tenant.id)
      .in('student_id', studentIds)
      .eq('status', 'active')
      .is('deleted_at', null);

    // Build class lookup
    const classLookup = new Map<string, { id: string; name: string }>();
    for (const enrollment of enrollments ?? []) {
      const cls = enrollment.class as unknown as { id: string; name: string } | null;
      if (cls) {
        classLookup.set(enrollment.student_id, cls);
      }
    }

    const children: ParentChild[] = data.map((g) => {
      const student = g.student as unknown as {
        id: string;
        first_name: string;
        last_name: string;
        preferred_name: string | null;
        photo_url: string | null;
        dob: string | null;
      };
      const cls = classLookup.get(student.id);

      return {
        id: student.id,
        firstName: student.first_name,
        lastName: student.last_name,
        preferredName: student.preferred_name,
        photoUrl: student.photo_url,
        dob: student.dob,
        className: cls?.name ?? null,
        classId: cls?.id ?? null,
        guardianId: g.id,
        relationship: g.relationship,
        isPrimary: g.is_primary,
      };
    });

    return { data: children, error: null };
  } catch (err) {
    return {
      data: null,
      error: { message: err instanceof Error ? err.message : 'Unknown error', code: 'INTERNAL_ERROR' },
    };
  }
}

// ============================================================
// getChildOverview â€” dashboard card data for a single child
// ============================================================

export async function getChildOverview(
  studentId: string
): Promise<ActionResponse<ChildOverview>> {
  try {
    const context = await getTenantContext();
    const supabase = await createSupabaseServerClient();

    // 1. Verify guardian relationship
    const { data: guardianRecord } = await supabase
      .from('guardians')
      .select('id, relationship, is_primary')
      .eq('tenant_id', context.tenant.id)
      .eq('user_id', context.user.id)
      .eq('student_id', studentId)
      .is('deleted_at', null)
      .single();

    if (!guardianRecord) {
      return { data: null, error: { message: 'Not authorized to view this student', code: 'FORBIDDEN' } };
    }

    // 2. Fetch child info (reuse getMyChildren shape)
    const { data: studentData } = await supabase
      .from('students')
      .select('id, first_name, last_name, preferred_name, photo_url, dob')
      .eq('id', studentId)
      .is('deleted_at', null)
      .single();

    if (!studentData) {
      return { data: null, error: { message: 'Student not found', code: 'NOT_FOUND' } };
    }

    // Get current class
    const { data: enrollment } = await supabase
      .from('enrollments')
      .select('class:classes(id, name)')
      .eq('tenant_id', context.tenant.id)
      .eq('student_id', studentId)
      .eq('status', 'active')
      .is('deleted_at', null)
      .limit(1)
      .single();

    const cls = enrollment?.class as unknown as { id: string; name: string } | null;

    const child: ParentChild = {
      id: studentData.id,
      firstName: studentData.first_name,
      lastName: studentData.last_name,
      preferredName: studentData.preferred_name,
      photoUrl: studentData.photo_url,
      dob: studentData.dob,
      className: cls?.name ?? null,
      classId: cls?.id ?? null,
      guardianId: guardianRecord.id,
      relationship: guardianRecord.relationship,
      isPrimary: guardianRecord.is_primary,
    };

    // 3. Attendance summary (last 30 days)
    const thirtyDaysAgo = new Date();
    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

    const { data: attendanceRecords } = await supabase
      .from('attendance_records')
      .select('status, date')
      .eq('tenant_id', context.tenant.id)
      .eq('student_id', studentId)
      .gte('date', thirtyDaysAgo.toISOString().split('T')[0])
      .is('deleted_at', null)
      .order('date', { ascending: false });

    const records = attendanceRecords ?? [];
    const totalDays = records.length;
    const present = records.filter((r) => r.status === 'present').length;
    const absent = records.filter((r) => r.status === 'absent').length;
    const late = records.filter((r) => r.status === 'late').length;
    const attendanceRate = totalDays > 0 ? Math.round((present / totalDays) * 100) : 0;

    const attendance = {
      totalDays,
      present,
      absent,
      late,
      attendanceRate,
      lastRecordDate: records[0]?.date ?? null,
    };

    // 4. Recent published observations (last 5)
    const { data: obsStudentLinks } = await supabase
      .from('observation_students')
      .select('observation_id')
      .eq('tenant_id', context.tenant.id)
      .eq('student_id', studentId);

    const obsIds = (obsStudentLinks ?? []).map((l) => l.observation_id);

    let recentObservations: ChildOverview['recentObservations'] = [];
    if (obsIds.length > 0) {
      const { data: observations } = await supabase
        .from('observations')
        .select(
          `
          id,
          content,
          created_at,
          author:users!observations_author_id_fkey(first_name, last_name)
        `
        )
        .eq('tenant_id', context.tenant.id)
        .eq('status', 'published')
        .in('id', obsIds)
        .is('deleted_at', null)
        .order('created_at', { ascending: false })
        .limit(5);

      // Get media counts
      const foundObsIds = (observations ?? []).map((o) => o.id);
      const { data: mediaCounts } = foundObsIds.length > 0
        ? await supabase
            .from('observation_media')
            .select('observation_id')
            .in('observation_id', foundObsIds)
            .is('deleted_at', null)
        : { data: [] };

      const mediaCountMap = new Map<string, number>();
      for (const m of mediaCounts ?? []) {
        mediaCountMap.set(m.observation_id, (mediaCountMap.get(m.observation_id) ?? 0) + 1);
      }

      recentObservations = (observations ?? []).map((o) => {
        const author = o.author as unknown as { first_name: string | null; last_name: string | null } | null;
        return {
          id: o.id,
          content: o.content,
          authorName: [author?.first_name, author?.last_name].filter(Boolean).join(' ') || 'Guide',
          createdAt: o.created_at,
          mediaCount: mediaCountMap.get(o.id) ?? 0,
        };
      });
    }

    // 5. Mastery snapshot (all instances combined)
    const { data: masteryRecords } = await supabase
      .from('student_mastery')
      .select('status')
      .eq('tenant_id', context.tenant.id)
      .eq('student_id', studentId)
      .is('deleted_at', null);

    const masteryData = masteryRecords ?? [];
    const total = masteryData.length;
    const mastered = masteryData.filter((m) => m.status === 'mastered').length;
    const practicing = masteryData.filter((m) => m.status === 'practicing').length;
    const presented = masteryData.filter((m) => m.status === 'presented').length;
    const percentMastered = total > 0 ? Math.round((mastered / total) * 100) : 0;

    const mastery = { total, mastered, practicing, presented, percentMastered };

    // 6. Published report count
    const { count: publishedReportCount } = await supabase
      .from('student_reports')
      .select('id', { count: 'exact', head: true })
      .eq('tenant_id', context.tenant.id)
      .eq('student_id', studentId)
      .eq('status', 'published')
      .is('deleted_at', null);

    return {
      data: {
        child,
        attendance,
        recentObservations,
        mastery,
        publishedReportCount: publishedReportCount ?? 0,
      },
      error: null,
    };
  } catch (err) {
    return {
      data: null,
      error: { message: err instanceof Error ? err.message : 'Unknown error', code: 'INTERNAL_ERROR' },
    };
  }
}

// ============================================================
// isGuardianOf â€” lightweight check for route guards
// ============================================================

export async function isGuardianOf(studentId: string): Promise<boolean> {
  try {
    const context = await getTenantContext();
    const supabase = await createSupabaseServerClient();

    const { data } = await supabase
      .from('guardians')
      .select('id')
      .eq('tenant_id', context.tenant.id)
      .eq('user_id', context.user.id)
      .eq('student_id', studentId)
      .is('deleted_at', null)
      .limit(1)
      .single();

    return !!data;
  } catch {
    return false;
  }
}

// ============================================================
// isParentUser â€” checks if user has guardian records (is a parent)
// ============================================================

export async function isParentUser(): Promise<boolean> {
  try {
    const context = await getTenantContext();
    const supabase = await createSupabaseServerClient();

    const { count } = await supabase
      .from('guardians')
      .select('id', { count: 'exact', head: true })
      .eq('tenant_id', context.tenant.id)
      .eq('user_id', context.user.id)
      .is('deleted_at', null);

    return (count ?? 0) > 0;
  } catch {
    return false;
  }
}


===== D:\.code\wattleos\src\lib\actions\parent\index.ts =====

// src/lib/actions/parent/index.ts
//
// ============================================================
// WattleOS V2 â€” Parent Portal: Barrel Export
// ============================================================

// Children & identity
export {
  getMyChildren,
  getChildOverview,
  getMyGuardianRecords,
  isGuardianOf,
  isParentUser,
} from './children';
export type { ParentChild, ChildOverview } from './children';

// Portfolio (observations + mastery)
export {
  getChildObservations,
  getChildMastery,
  getChildMasteryDetails,
} from './portfolio';
export type {
  ChildObservation,
  ChildMasteryRecord,
  ChildMasterySummary,
} from './portfolio';

// Attendance
export {
  getChildAttendance,
  getChildAttendanceWeek,
} from './attendance';
export type {
  ChildAttendanceRecord,
  ChildAttendanceSummary,
  ChildAttendanceResponse,
} from './attendance';

// Reports
export {
  getChildReports,
  getChildReport,
} from './reports';
export type {
  ParentReportSummary,
  ParentReportDetail,
} from './reports';

// Settings (consent + contact)
export {
  getMySettings,
  updateConsent,
  updateContactInfo,
} from './settings';
export type {
  ParentGuardianSettings,
  UpdateConsentInput,
  UpdateContactInfoInput,
} from './settings';


===== D:\.code\wattleos\src\lib\actions\parent\portfolio.ts =====

// src/lib/actions/parent/portfolio.ts
//
// ============================================================
// WattleOS V2 â€” Parent Portal: Portfolio Actions
// ============================================================
// Fetches published observations and mastery progression for
// a parent's child. Only published observations are visible
// to parents (enforced by both application logic and RLS).
//
// WHY separate from staff observations: Parents see a curated
// view â€” no drafts, no archived items, no editing capabilities.
// The portfolio is a read-only celebration of learning.
// ============================================================

'use server';

import { createSupabaseServerClient } from '@/lib/supabase/server';
import { getTenantContext } from '@/lib/auth/tenant-context';
import { isGuardianOf } from './children';
import type { ActionResponse } from '@/types/api';

// ============================================================
// Types
// ============================================================

export interface ChildObservation {
  id: string;
  content: string | null;
  authorName: string;
  publishedAt: string | null;
  createdAt: string;
  outcomes: Array<{
    nodeId: string;
    title: string;
    level: string;
  }>;
  media: Array<{
    id: string;
    mediaType: string;
    storageUrl: string;
    thumbnailUrl: string | null;
    caption: string | null;
  }>;
}

export interface ChildMasteryRecord {
  nodeId: string;
  nodeTitle: string;
  nodeLevel: string;
  areaName: string | null;
  status: string;
  updatedAt: string;
}

export interface ChildMasterySummary {
  instanceId: string;
  instanceName: string;
  total: number;
  notStarted: number;
  presented: number;
  practicing: number;
  mastered: number;
  percentMastered: number;
}

// ============================================================
// getChildObservations â€” published observations for a child
// ============================================================

export async function getChildObservations(
  studentId: string,
  params?: { page?: number; perPage?: number }
): Promise<ActionResponse<ChildObservation[]> & { pagination?: { page: number; total: number; totalPages: number } }> {
  try {
    const context = await getTenantContext();

    // Verify guardian relationship
    const isGuardian = await isGuardianOf(studentId);
    if (!isGuardian) {
      return { data: null, error: { message: 'Not authorized', code: 'FORBIDDEN' } };
    }

    const supabase = await createSupabaseServerClient();
    const page = params?.page ?? 1;
    const perPage = params?.perPage ?? 20;
    const offset = (page - 1) * perPage;

    // Get observation IDs for this student
    const { data: links } = await supabase
      .from('observation_students')
      .select('observation_id')
      .eq('tenant_id', context.tenant.id)
      .eq('student_id', studentId);

    const obsIds = (links ?? []).map((l) => l.observation_id);
    if (obsIds.length === 0) {
      return {
        data: [],
        error: null,
        pagination: { page, total: 0, totalPages: 0 },
      };
    }

    // Count total published
    const { count: total } = await supabase
      .from('observations')
      .select('id', { count: 'exact', head: true })
      .eq('tenant_id', context.tenant.id)
      .eq('status', 'published')
      .in('id', obsIds)
      .is('deleted_at', null);

    // Fetch paginated observations
    const { data: observations, error } = await supabase
      .from('observations')
      .select(
        `
        id,
        content,
        published_at,
        created_at,
        author:users!observations_author_id_fkey(first_name, last_name)
      `
      )
      .eq('tenant_id', context.tenant.id)
      .eq('status', 'published')
      .in('id', obsIds)
      .is('deleted_at', null)
      .order('published_at', { ascending: false, nullsFirst: false })
      .range(offset, offset + perPage - 1);

    if (error) {
      return { data: null, error: { message: error.message, code: 'QUERY_ERROR' } };
    }

    const foundIds = (observations ?? []).map((o) => o.id);

    // Fetch outcomes for these observations
    const { data: outcomeLinks } = foundIds.length > 0
      ? await supabase
          .from('observation_outcomes')
          .select(
            `
            observation_id,
            node:curriculum_nodes(id, title, level)
          `
          )
          .eq('tenant_id', context.tenant.id)
          .in('observation_id', foundIds)
      : { data: [] };

    const outcomesMap = new Map<string, ChildObservation['outcomes']>();
    for (const link of outcomeLinks ?? []) {
      const node = link.node as unknown as { id: string; title: string; level: string } | null;
      if (!node) continue;
      const existing = outcomesMap.get(link.observation_id) ?? [];
      existing.push({ nodeId: node.id, title: node.title, level: node.level });
      outcomesMap.set(link.observation_id, existing);
    }

    // Fetch media for these observations
    const { data: mediaRecords } = foundIds.length > 0
      ? await supabase
          .from('observation_media')
          .select('id, observation_id, media_type, storage_url, thumbnail_url, caption')
          .in('observation_id', foundIds)
          .is('deleted_at', null)
      : { data: [] };

    const mediaMap = new Map<string, ChildObservation['media']>();
    for (const m of mediaRecords ?? []) {
      const existing = mediaMap.get(m.observation_id) ?? [];
      existing.push({
        id: m.id,
        mediaType: m.media_type,
        storageUrl: m.storage_url,
        thumbnailUrl: m.thumbnail_url,
        caption: m.caption,
      });
      mediaMap.set(m.observation_id, existing);
    }

    // Assemble
    const result: ChildObservation[] = (observations ?? []).map((o) => {
      const author = o.author as unknown as { first_name: string | null; last_name: string | null } | null;
      return {
        id: o.id,
        content: o.content,
        authorName: [author?.first_name, author?.last_name].filter(Boolean).join(' ') || 'Guide',
        publishedAt: o.published_at,
        createdAt: o.created_at,
        outcomes: outcomesMap.get(o.id) ?? [],
        media: mediaMap.get(o.id) ?? [],
      };
    });

    const totalCount = total ?? 0;

    return {
      data: result,
      error: null,
      pagination: {
        page,
        total: totalCount,
        totalPages: Math.ceil(totalCount / perPage),
      },
    };
  } catch (err) {
    return {
      data: null,
      error: { message: err instanceof Error ? err.message : 'Unknown error', code: 'INTERNAL_ERROR' },
    };
  }
}

// ============================================================
// getChildMastery â€” mastery records grouped by curriculum instance
// ============================================================

export async function getChildMastery(
  studentId: string
): Promise<ActionResponse<ChildMasterySummary[]>> {
  try {
    const context = await getTenantContext();

    const isGuardian = await isGuardianOf(studentId);
    if (!isGuardian) {
      return { data: null, error: { message: 'Not authorized', code: 'FORBIDDEN' } };
    }

    const supabase = await createSupabaseServerClient();

    // Get all mastery records with node info
    const { data: masteryRecords, error } = await supabase
      .from('student_mastery')
      .select(
        `
        status,
        node:curriculum_nodes!inner(
          id,
          title,
          level,
          instance_id
        )
      `
      )
      .eq('tenant_id', context.tenant.id)
      .eq('student_id', studentId)
      .is('deleted_at', null);

    if (error) {
      return { data: null, error: { message: error.message, code: 'QUERY_ERROR' } };
    }

    // Get curriculum instance names
    const { data: instances } = await supabase
      .from('curriculum_instances')
      .select('id, name')
      .eq('tenant_id', context.tenant.id)
      .is('deleted_at', null);

    const instanceNameMap = new Map<string, string>();
    for (const inst of instances ?? []) {
      instanceNameMap.set(inst.id, inst.name);
    }

    // Group by instance
    const instanceMap = new Map<
      string,
      { total: number; notStarted: number; presented: number; practicing: number; mastered: number }
    >();

    for (const record of masteryRecords ?? []) {
      const node = record.node as unknown as { id: string; instance_id: string };
      const instanceId = node.instance_id;

      if (!instanceMap.has(instanceId)) {
        instanceMap.set(instanceId, {
          total: 0,
          notStarted: 0,
          presented: 0,
          practicing: 0,
          mastered: 0,
        });
      }

      const stats = instanceMap.get(instanceId)!;
      stats.total++;
      switch (record.status) {
        case 'not_started':
          stats.notStarted++;
          break;
        case 'presented':
          stats.presented++;
          break;
        case 'practicing':
          stats.practicing++;
          break;
        case 'mastered':
          stats.mastered++;
          break;
      }
    }

    const summaries: ChildMasterySummary[] = Array.from(instanceMap.entries()).map(
      ([instanceId, stats]) => ({
        instanceId,
        instanceName: instanceNameMap.get(instanceId) ?? 'Unknown Curriculum',
        ...stats,
        percentMastered: stats.total > 0 ? Math.round((stats.mastered / stats.total) * 100) : 0,
      })
    );

    return { data: summaries, error: null };
  } catch (err) {
    return {
      data: null,
      error: { message: err instanceof Error ? err.message : 'Unknown error', code: 'INTERNAL_ERROR' },
    };
  }
}

// ============================================================
// getChildMasteryDetails â€” full mastery list for a curriculum
// ============================================================

export async function getChildMasteryDetails(
  studentId: string,
  instanceId: string
): Promise<ActionResponse<ChildMasteryRecord[]>> {
  try {
    const context = await getTenantContext();

    const isGuardian = await isGuardianOf(studentId);
    if (!isGuardian) {
      return { data: null, error: { message: 'Not authorized', code: 'FORBIDDEN' } };
    }

    const supabase = await createSupabaseServerClient();

    const { data, error } = await supabase
      .from('student_mastery')
      .select(
        `
        status,
        updated_at,
        node:curriculum_nodes!inner(
          id,
          title,
          level,
          instance_id,
          parent:curriculum_nodes(title)
        )
      `
      )
      .eq('tenant_id', context.tenant.id)
      .eq('student_id', studentId)
      .is('deleted_at', null);

    if (error) {
      return { data: null, error: { message: error.message, code: 'QUERY_ERROR' } };
    }

    // Filter to the requested instance and map
    const records: ChildMasteryRecord[] = (data ?? [])
      .filter((r) => {
        const node = r.node as unknown as { instance_id: string };
        return node.instance_id === instanceId;
      })
      .map((r) => {
        const node = r.node as unknown as {
          id: string;
          title: string;
          level: string;
          parent: { title: string } | null;
        };
        return {
          nodeId: node.id,
          nodeTitle: node.title,
          nodeLevel: node.level,
          areaName: node.parent?.title ?? null,
          status: r.status,
          updatedAt: r.updated_at,
        };
      });

    return { data: records, error: null };
  } catch (err) {
    return {
      data: null,
      error: { message: err instanceof Error ? err.message : 'Unknown error', code: 'INTERNAL_ERROR' },
    };
  }
}


===== D:\.code\wattleos\src\lib\actions\parent\reports.ts =====

// src/lib/actions/parent/reports.ts
//
// ============================================================
// WattleOS V2 â€” Parent Portal: Reports Actions
// ============================================================
// Fetches published student reports for a parent's child.
// Read-only â€” parents view the same data teachers produced,
// but cannot edit content or change status.
//
// WHY use RLS + app guard: The student_reports table already
// has "Parents can view published reports" RLS policy. We add
// application-layer guardian check for defense in depth.
// ============================================================

'use server';

import { createSupabaseServerClient } from '@/lib/supabase/server';
import { getTenantContext } from '@/lib/auth/tenant-context';
import { isGuardianOf } from './children';
import type { ActionResponse } from '@/types/api';
import type { ReportContent } from '@/lib/reports/types';

// ============================================================
// Types
// ============================================================

export interface ParentReportSummary {
  id: string;
  term: string | null;
  templateName: string | null;
  publishedAt: string | null;
  authorName: string;
}

export interface ParentReportDetail {
  id: string;
  term: string | null;
  templateName: string | null;
  publishedAt: string | null;
  authorName: string;
  content: ReportContent;
}

// ============================================================
// getChildReports â€” list of published reports for a child
// ============================================================

export async function getChildReports(
  studentId: string
): Promise<ActionResponse<ParentReportSummary[]>> {
  try {
    const context = await getTenantContext();

    const isGuardian = await isGuardianOf(studentId);
    if (!isGuardian) {
      return { data: null, error: { message: 'Not authorized', code: 'FORBIDDEN' } };
    }

    const supabase = await createSupabaseServerClient();

    const { data, error } = await supabase
      .from('student_reports')
      .select(
        `
        id,
        term,
        published_at,
        template:report_templates(name),
        author:users!student_reports_author_id_fkey(first_name, last_name)
      `
      )
      .eq('tenant_id', context.tenant.id)
      .eq('student_id', studentId)
      .eq('status', 'published')
      .is('deleted_at', null)
      .order('published_at', { ascending: false, nullsFirst: false });

    if (error) {
      return { data: null, error: { message: error.message, code: 'QUERY_ERROR' } };
    }

    const reports: ParentReportSummary[] = (data ?? []).map((r) => {
      const template = r.template as unknown as { name: string } | null;
      const author = r.author as unknown as { first_name: string | null; last_name: string | null } | null;
      return {
        id: r.id,
        term: r.term,
        templateName: template?.name ?? null,
        publishedAt: r.published_at,
        authorName: [author?.first_name, author?.last_name].filter(Boolean).join(' ') || 'Teacher',
      };
    });

    return { data: reports, error: null };
  } catch (err) {
    return {
      data: null,
      error: { message: err instanceof Error ? err.message : 'Unknown error', code: 'INTERNAL_ERROR' },
    };
  }
}

// ============================================================
// getChildReport â€” single published report with full content
// ============================================================

export async function getChildReport(
  reportId: string,
  studentId: string
): Promise<ActionResponse<ParentReportDetail>> {
  try {
    const context = await getTenantContext();

    const isGuardian = await isGuardianOf(studentId);
    if (!isGuardian) {
      return { data: null, error: { message: 'Not authorized', code: 'FORBIDDEN' } };
    }

    const supabase = await createSupabaseServerClient();

    const { data, error } = await supabase
      .from('student_reports')
      .select(
        `
        id,
        term,
        content,
        published_at,
        template:report_templates(name),
        author:users!student_reports_author_id_fkey(first_name, last_name)
      `
      )
      .eq('id', reportId)
      .eq('tenant_id', context.tenant.id)
      .eq('student_id', studentId)
      .eq('status', 'published')
      .is('deleted_at', null)
      .single();

    if (error || !data) {
      return { data: null, error: { message: 'Report not found', code: 'NOT_FOUND' } };
    }

    const template = data.template as unknown as { name: string } | null;
    const author = data.author as unknown as { first_name: string | null; last_name: string | null } | null;

    return {
      data: {
        id: data.id,
        term: data.term,
        templateName: template?.name ?? null,
        publishedAt: data.published_at,
        authorName: [author?.first_name, author?.last_name].filter(Boolean).join(' ') || 'Teacher',
        content: data.content as unknown as ReportContent,
      },
      error: null,
    };
  } catch (err) {
    return {
      data: null,
      error: { message: err instanceof Error ? err.message : 'Unknown error', code: 'INTERNAL_ERROR' },
    };
  }
}


===== D:\.code\wattleos\src\lib\actions\parent\settings.ts =====

// src/lib/actions/parent/settings.ts
//
// ============================================================
// WattleOS V2 â€” Parent Portal: Settings Actions
// ============================================================
// Parents can update their consent preferences and contact
// information without staff intervention.
//
// WHY self-service: Consent toggles (media, directory) change
// frequently â€” parents should be able to update at any time.
// Contact info updates reduce admin workload.
// ============================================================

'use server';

import { createSupabaseServerClient, createSupabaseAdminClient } from '@/lib/supabase/server';
import { getTenantContext } from '@/lib/auth/tenant-context';
import type { ActionResponse } from '@/types/api';

// ============================================================
// Types
// ============================================================

export interface ParentGuardianSettings {
  guardianId: string;
  studentId: string;
  studentName: string;
  studentPhotoUrl: string | null;
  relationship: string;
  isPrimary: boolean;
  phone: string | null;
  mediaConsent: boolean;
  directoryConsent: boolean;
  pickupAuthorized: boolean;
}

export interface UpdateConsentInput {
  guardianId: string;
  mediaConsent?: boolean;
  directoryConsent?: boolean;
}

export interface UpdateContactInfoInput {
  guardianId: string;
  phone?: string | null;
}

// ============================================================
// getMySettings â€” all guardian records with consent/contact info
// ============================================================

export async function getMySettings(): Promise<ActionResponse<ParentGuardianSettings[]>> {
  try {
    const context = await getTenantContext();
    const supabase = await createSupabaseServerClient();

    const { data, error } = await supabase
      .from('guardians')
      .select(
        `
        id,
        student_id,
        relationship,
        is_primary,
        phone,
        media_consent,
        directory_consent,
        pickup_authorized,
        student:students!inner(
          first_name,
          last_name,
          preferred_name,
          photo_url
        )
      `
      )
      .eq('tenant_id', context.tenant.id)
      .eq('user_id', context.user.id)
      .is('deleted_at', null);

    if (error) {
      return { data: null, error: { message: error.message, code: 'QUERY_ERROR' } };
    }

    const settings: ParentGuardianSettings[] = (data ?? []).map((g) => {
      const student = g.student as unknown as {
        first_name: string;
        last_name: string;
        preferred_name: string | null;
        photo_url: string | null;
      };
      return {
        guardianId: g.id,
        studentId: g.student_id,
        studentName: `${student.preferred_name ?? student.first_name} ${student.last_name}`,
        studentPhotoUrl: student.photo_url,
        relationship: g.relationship,
        isPrimary: g.is_primary,
        phone: g.phone,
        mediaConsent: g.media_consent,
        directoryConsent: g.directory_consent,
        pickupAuthorized: g.pickup_authorized,
      };
    });

    return { data: settings, error: null };
  } catch (err) {
    return {
      data: null,
      error: { message: err instanceof Error ? err.message : 'Unknown error', code: 'INTERNAL_ERROR' },
    };
  }
}

// ============================================================
// updateConsent â€” toggle media/directory consent per child
// ============================================================

export async function updateConsent(
  input: UpdateConsentInput
): Promise<ActionResponse<{ success: boolean }>> {
  try {
    const context = await getTenantContext();
    const admin = createSupabaseAdminClient();

    // Verify this guardian record belongs to the current user
    const { data: guardian } = await admin
      .from('guardians')
      .select('id, user_id')
      .eq('id', input.guardianId)
      .eq('tenant_id', context.tenant.id)
      .eq('user_id', context.user.id)
      .is('deleted_at', null)
      .single();

    if (!guardian) {
      return { data: null, error: { message: 'Guardian record not found', code: 'NOT_FOUND' } };
    }

    // Build update object
    const updates: Record<string, boolean> = {};
    if (input.mediaConsent !== undefined) {
      updates.media_consent = input.mediaConsent;
    }
    if (input.directoryConsent !== undefined) {
      updates.directory_consent = input.directoryConsent;
    }

    if (Object.keys(updates).length === 0) {
      return { data: { success: true }, error: null };
    }

    const { error } = await admin
      .from('guardians')
      .update(updates)
      .eq('id', input.guardianId)
      .eq('tenant_id', context.tenant.id);

    if (error) {
      return { data: null, error: { message: error.message, code: 'UPDATE_ERROR' } };
    }

    // Audit log
    await admin.from('audit_logs').insert({
      tenant_id: context.tenant.id,
      user_id: context.user.id,
      action: 'guardian.consent_updated',
      entity_type: 'guardian',
      entity_id: input.guardianId,
      metadata: { changes: updates },
    });

    return { data: { success: true }, error: null };
  } catch (err) {
    return {
      data: null,
      error: { message: err instanceof Error ? err.message : 'Unknown error', code: 'INTERNAL_ERROR' },
    };
  }
}

// ============================================================
// updateContactInfo â€” parent updates their own phone number
// ============================================================

export async function updateContactInfo(
  input: UpdateContactInfoInput
): Promise<ActionResponse<{ success: boolean }>> {
  try {
    const context = await getTenantContext();
    const admin = createSupabaseAdminClient();

    // Verify ownership
    const { data: guardian } = await admin
      .from('guardians')
      .select('id, user_id')
      .eq('id', input.guardianId)
      .eq('tenant_id', context.tenant.id)
      .eq('user_id', context.user.id)
      .is('deleted_at', null)
      .single();

    if (!guardian) {
      return { data: null, error: { message: 'Guardian record not found', code: 'NOT_FOUND' } };
    }

    const updates: Record<string, string | null> = {};
    if (input.phone !== undefined) {
      updates.phone = input.phone;
    }

    if (Object.keys(updates).length === 0) {
      return { data: { success: true }, error: null };
    }

    const { error } = await admin
      .from('guardians')
      .update(updates)
      .eq('id', input.guardianId)
      .eq('tenant_id', context.tenant.id);

    if (error) {
      return { data: null, error: { message: error.message, code: 'UPDATE_ERROR' } };
    }

    // Audit log
    await admin.from('audit_logs').insert({
      tenant_id: context.tenant.id,
      user_id: context.user.id,
      action: 'guardian.contact_updated',
      entity_type: 'guardian',
      entity_id: input.guardianId,
      metadata: { fields: Object.keys(updates) },
    });

    return { data: { success: true }, error: null };
  } catch (err) {
    return {
      data: null,
      error: { message: err instanceof Error ? err.message : 'Unknown error', code: 'INTERNAL_ERROR' },
    };
  }
}


===== D:\.code\wattleos\src\lib\actions\pay-periods.ts =====

// src/lib/actions/pay-periods.ts
//
// ============================================================
// WattleOS V2 â€” Pay Period Server Actions
// ============================================================
// Manages pay cycle records (weekly/fortnightly/monthly).
// Pay periods are explicit DB records rather than computed dates
// because they handle edge cases (holidays, mid-cycle starts).
// ============================================================

'use server';

import { createSupabaseServerClient } from '@/lib/supabase/server';
import { getTenantContext, requirePermission } from '@/lib/auth/tenant-context';
import { Permissions } from '@/lib/constants/permissions';
import type { ActionResponse } from '@/types/api';
import { success, failure } from '@/types/api';
import type { PayPeriod, PayFrequency } from '@/types/domain';

// ============================================================
// GET: Current open pay period (for today's date)
// ============================================================

/**
 * Returns the currently open pay period that contains today's date.
 * Any authenticated user can call this (staff need it for time logging).
 */
export async function getCurrentPayPeriod(): Promise<ActionResponse<PayPeriod | null>> {
  try {
    await getTenantContext();
    const supabase = await createSupabaseServerClient();
    const today = new Date().toISOString().split('T')[0];

    const { data, error } = await supabase
      .from('pay_periods')
      .select('*')
      .eq('status', 'open')
      .lte('start_date', today)
      .gte('end_date', today)
      .is('deleted_at', null)
      .order('start_date', { ascending: false })
      .limit(1)
      .maybeSingle();

    if (error) {
      return failure(error.message, 'DB_ERROR');
    }

    return success((data as PayPeriod) ?? null);
  } catch (err) {
    const message = err instanceof Error ? err.message : 'Failed to get current pay period';
    return failure(message, 'UNEXPECTED_ERROR');
  }
}

// ============================================================
// LIST: All pay periods (paginated)
// ============================================================

export async function listPayPeriods(params?: {
  status?: string;
  page?: number;
  perPage?: number;
}): Promise<ActionResponse<{ periods: PayPeriod[]; total: number }>> {
  try {
    await requirePermission(Permissions.APPROVE_TIMESHEETS);
    const supabase = await createSupabaseServerClient();

    const page = params?.page ?? 1;
    const perPage = params?.perPage ?? 20;
    const from = (page - 1) * perPage;
    const to = from + perPage - 1;

    let query = supabase
      .from('pay_periods')
      .select('*', { count: 'exact' })
      .is('deleted_at', null)
      .order('start_date', { ascending: false })
      .range(from, to);

    if (params?.status) {
      query = query.eq('status', params.status);
    }

    const { data, error, count } = await query;

    if (error) {
      return failure(error.message, 'DB_ERROR');
    }

    return success({
      periods: (data ?? []) as PayPeriod[],
      total: count ?? 0,
    });
  } catch (err) {
    const message = err instanceof Error ? err.message : 'Failed to list pay periods';
    return failure(message, 'UNEXPECTED_ERROR');
  }
}

// ============================================================
// CREATE: New pay period
// ============================================================

export async function createPayPeriod(input: {
  name: string;
  startDate: string;
  endDate: string;
  frequency: PayFrequency;
}): Promise<ActionResponse<PayPeriod>> {
  try {
    const context = await requirePermission(Permissions.MANAGE_INTEGRATIONS);
    const supabase = await createSupabaseServerClient();

    // Validate dates
    if (new Date(input.startDate) >= new Date(input.endDate)) {
      return failure('Start date must be before end date', 'VALIDATION_ERROR');
    }

    // Check for overlapping periods
    const { data: overlap } = await supabase
      .from('pay_periods')
      .select('id')
      .is('deleted_at', null)
      .or(`and(start_date.lte.${input.endDate},end_date.gte.${input.startDate})`)
      .limit(1);

    if (overlap && overlap.length > 0) {
      return failure('This period overlaps with an existing pay period', 'VALIDATION_ERROR');
    }

    const { data, error } = await supabase
      .from('pay_periods')
      .insert({
        tenant_id: context.tenant.id,
        name: input.name,
        start_date: input.startDate,
        end_date: input.endDate,
        frequency: input.frequency,
        status: 'open',
      })
      .select()
      .single();

    if (error) {
      return failure(error.message, 'DB_ERROR');
    }

    return success(data as PayPeriod);
  } catch (err) {
    const message = err instanceof Error ? err.message : 'Failed to create pay period';
    return failure(message, 'UNEXPECTED_ERROR');
  }
}

// ============================================================
// LOCK: Prevent further time entry edits for this period
// ============================================================

export async function lockPayPeriod(
  payPeriodId: string
): Promise<ActionResponse<PayPeriod>> {
  try {
    const context = await requirePermission(Permissions.APPROVE_TIMESHEETS);
    const supabase = await createSupabaseServerClient();

    const { data: existing, error: fetchError } = await supabase
      .from('pay_periods')
      .select('*')
      .eq('id', payPeriodId)
      .is('deleted_at', null)
      .single();

    if (fetchError || !existing) {
      return failure('Pay period not found', 'NOT_FOUND');
    }

    const period = existing as PayPeriod;

    if (period.status !== 'open') {
      return failure(`Cannot lock a period that is already '${period.status}'`, 'VALIDATION_ERROR');
    }

    const { data, error } = await supabase
      .from('pay_periods')
      .update({
        status: 'locked',
        locked_at: new Date().toISOString(),
        locked_by: context.user.id,
      })
      .eq('id', payPeriodId)
      .select()
      .single();

    if (error) {
      return failure(error.message, 'DB_ERROR');
    }

    return success(data as PayPeriod);
  } catch (err) {
    const message = err instanceof Error ? err.message : 'Failed to lock pay period';
    return failure(message, 'UNEXPECTED_ERROR');
  }
}

// ============================================================
// MARK PROCESSED: After all timesheets synced to payroll
// ============================================================

export async function markPayPeriodProcessed(
  payPeriodId: string
): Promise<ActionResponse<PayPeriod>> {
  try {
    await requirePermission(Permissions.MANAGE_INTEGRATIONS);
    const supabase = await createSupabaseServerClient();

    const { data, error } = await supabase
      .from('pay_periods')
      .update({ status: 'processed' })
      .eq('id', payPeriodId)
      .eq('status', 'locked')
      .is('deleted_at', null)
      .select()
      .single();

    if (error) {
      return failure(error.message, 'DB_ERROR');
    }

    if (!data) {
      return failure('Pay period not found or not in locked status', 'VALIDATION_ERROR');
    }

    return success(data as PayPeriod);
  } catch (err) {
    const message = err instanceof Error ? err.message : 'Failed to mark period as processed';
    return failure(message, 'UNEXPECTED_ERROR');
  }
}


===== D:\.code\wattleos\src\lib\actions\payroll-integration.ts =====

// src/lib/actions/payroll-integration.ts
//
// ============================================================
// WattleOS V2 â€” Payroll Integration Server Actions
// ============================================================
// Manages the connection between WattleOS and external payroll
// systems (Xero / KeyPay). Three concerns:
//   1. Payroll settings (config)
//   2. Employee mappings (user â†’ external ID)
//   3. Timesheet sync (push approved hours out)
//
// Sync methods are complete action shells with proper validation.
// The actual API calls will be wired in Phase 9d when the
// integration clients are built.
// ============================================================

'use server';

import { createSupabaseServerClient } from '@/lib/supabase/server';
import { requirePermission, getTenantContext } from '@/lib/auth/tenant-context';
import { Permissions } from '@/lib/constants/permissions';
import type { ActionResponse } from '@/types/api';
import { success, failure } from '@/types/api';
import type {
  PayrollSettings,
  EmployeeMapping,
  PayrollProvider,
  PayFrequency,
  Timesheet,
} from '@/types/domain';

// ============================================================
// PAYROLL SETTINGS
// ============================================================

/**
 * Get the tenant's payroll settings. Creates a default row if none exists.
 */
export async function getPayrollSettings(): Promise<ActionResponse<PayrollSettings>> {
  try {
    const context = await getTenantContext();
    const supabase = await createSupabaseServerClient();

    const { data, error } = await supabase
      .from('payroll_settings')
      .select('*')
      .eq('tenant_id', context.tenant.id)
      .maybeSingle();

    if (error) {
      return failure(error.message, 'DB_ERROR');
    }

    // Auto-create default settings if none exist
    if (!data) {
      const { data: created, error: createError } = await supabase
        .from('payroll_settings')
        .insert({ tenant_id: context.tenant.id })
        .select()
        .single();

      if (createError) {
        return failure(createError.message, 'DB_ERROR');
      }

      return success(created as PayrollSettings);
    }

    return success(data as PayrollSettings);
  } catch (err) {
    const message = err instanceof Error ? err.message : 'Failed to get payroll settings';
    return failure(message, 'UNEXPECTED_ERROR');
  }
}

/**
 * Update payroll settings (admin only).
 */
export async function updatePayrollSettings(input: {
  payFrequency?: PayFrequency;
  payCycleStartDay?: number;
  defaultStartTime?: string;
  defaultEndTime?: string;
  defaultBreakMinutes?: number;
  payrollProvider?: PayrollProvider | null;
  providerConfig?: Record<string, unknown>;
  autoCreatePeriods?: boolean;
}): Promise<ActionResponse<PayrollSettings>> {
  try {
    const context = await requirePermission(Permissions.MANAGE_INTEGRATIONS);
    const supabase = await createSupabaseServerClient();

    // Validate start day
    if (input.payCycleStartDay !== undefined) {
      if (input.payCycleStartDay < 1 || input.payCycleStartDay > 7) {
        return failure('Pay cycle start day must be between 1 (Monday) and 7 (Sunday)', 'VALIDATION_ERROR');
      }
    }

    // Validate break minutes
    if (input.defaultBreakMinutes !== undefined && input.defaultBreakMinutes < 0) {
      return failure('Break minutes cannot be negative', 'VALIDATION_ERROR');
    }

    // Build update payload (only include provided fields)
    const updates: Record<string, unknown> = {};
    if (input.payFrequency !== undefined) updates.pay_frequency = input.payFrequency;
    if (input.payCycleStartDay !== undefined) updates.pay_cycle_start_day = input.payCycleStartDay;
    if (input.defaultStartTime !== undefined) updates.default_start_time = input.defaultStartTime;
    if (input.defaultEndTime !== undefined) updates.default_end_time = input.defaultEndTime;
    if (input.defaultBreakMinutes !== undefined) updates.default_break_minutes = input.defaultBreakMinutes;
    if (input.payrollProvider !== undefined) updates.payroll_provider = input.payrollProvider;
    if (input.providerConfig !== undefined) updates.provider_config = input.providerConfig;
    if (input.autoCreatePeriods !== undefined) updates.auto_create_periods = input.autoCreatePeriods;

    if (Object.keys(updates).length === 0) {
      return failure('No fields to update', 'VALIDATION_ERROR');
    }

    const { data, error } = await supabase
      .from('payroll_settings')
      .update(updates)
      .eq('tenant_id', context.tenant.id)
      .select()
      .single();

    if (error) {
      return failure(error.message, 'DB_ERROR');
    }

    return success(data as PayrollSettings);
  } catch (err) {
    const message = err instanceof Error ? err.message : 'Failed to update payroll settings';
    return failure(message, 'UNEXPECTED_ERROR');
  }
}

// ============================================================
// EMPLOYEE MAPPINGS
// ============================================================

/**
 * List all employee mappings for the tenant (with user details).
 */
export async function listEmployeeMappings(): Promise<
  ActionResponse<Array<EmployeeMapping & { user_name: string; user_email: string }>>
> {
  try {
    await requirePermission(Permissions.MANAGE_INTEGRATIONS);
    const supabase = await createSupabaseServerClient();

    const { data, error } = await supabase
      .from('employee_mappings')
      .select(`
        *,
        user:users(id, first_name, last_name, email)
      `)
      .order('created_at', { ascending: true });

    if (error) {
      return failure(error.message, 'DB_ERROR');
    }

    const mappings = ((data ?? []) as Array<Record<string, unknown>>).map((row) => {
      const user = row.user as { id: string; first_name: string; last_name: string; email: string } | null;
      return {
        ...(row as unknown as EmployeeMapping),
        user_name: user ? `${user.first_name} ${user.last_name}` : 'Unknown',
        user_email: user?.email ?? '',
      };
    });

    return success(mappings);
  } catch (err) {
    const message = err instanceof Error ? err.message : 'Failed to list employee mappings';
    return failure(message, 'UNEXPECTED_ERROR');
  }
}

/**
 * Create a new employee mapping (link WattleOS user to external payroll ID).
 */
export async function createEmployeeMapping(input: {
  userId: string;
  provider: PayrollProvider;
  externalId: string;
  externalName?: string;
}): Promise<ActionResponse<EmployeeMapping>> {
  try {
    const context = await requirePermission(Permissions.MANAGE_INTEGRATIONS);
    const supabase = await createSupabaseServerClient();

    if (!input.externalId.trim()) {
      return failure('External employee ID is required', 'VALIDATION_ERROR');
    }

    const { data, error } = await supabase
      .from('employee_mappings')
      .insert({
        tenant_id: context.tenant.id,
        user_id: input.userId,
        provider: input.provider,
        external_id: input.externalId.trim(),
        external_name: input.externalName?.trim() ?? null,
        is_active: true,
      })
      .select()
      .single();

    if (error) {
      if (error.message.includes('duplicate') || error.message.includes('unique')) {
        return failure('This user already has a mapping for this provider', 'VALIDATION_ERROR');
      }
      return failure(error.message, 'DB_ERROR');
    }

    return success(data as EmployeeMapping);
  } catch (err) {
    const message = err instanceof Error ? err.message : 'Failed to create employee mapping';
    return failure(message, 'UNEXPECTED_ERROR');
  }
}

/**
 * Update an existing employee mapping.
 */
export async function updateEmployeeMapping(
  mappingId: string,
  input: {
    externalId?: string;
    externalName?: string;
    isActive?: boolean;
  }
): Promise<ActionResponse<EmployeeMapping>> {
  try {
    await requirePermission(Permissions.MANAGE_INTEGRATIONS);
    const supabase = await createSupabaseServerClient();

    const updates: Record<string, unknown> = {};
    if (input.externalId !== undefined) updates.external_id = input.externalId.trim();
    if (input.externalName !== undefined) updates.external_name = input.externalName.trim();
    if (input.isActive !== undefined) updates.is_active = input.isActive;

    if (Object.keys(updates).length === 0) {
      return failure('No fields to update', 'VALIDATION_ERROR');
    }

    const { data, error } = await supabase
      .from('employee_mappings')
      .update(updates)
      .eq('id', mappingId)
      .select()
      .single();

    if (error) {
      return failure(error.message, 'DB_ERROR');
    }

    if (!data) {
      return failure('Employee mapping not found', 'NOT_FOUND');
    }

    return success(data as EmployeeMapping);
  } catch (err) {
    const message = err instanceof Error ? err.message : 'Failed to update employee mapping';
    return failure(message, 'UNEXPECTED_ERROR');
  }
}

/**
 * Deactivate an employee mapping (soft-disable, not delete).
 */
export async function removeEmployeeMapping(
  mappingId: string
): Promise<ActionResponse<{ deactivated: boolean }>> {
  try {
    await requirePermission(Permissions.MANAGE_INTEGRATIONS);
    const supabase = await createSupabaseServerClient();

    const { error } = await supabase
      .from('employee_mappings')
      .update({ is_active: false })
      .eq('id', mappingId);

    if (error) {
      return failure(error.message, 'DB_ERROR');
    }

    return success({ deactivated: true });
  } catch (err) {
    const message = err instanceof Error ? err.message : 'Failed to deactivate employee mapping';
    return failure(message, 'UNEXPECTED_ERROR');
  }
}

// ============================================================
// TIMESHEET SYNC
// ============================================================

/**
 * Sync a single approved timesheet to the configured payroll provider.
 *
 * Pipeline:
 * 1. Verify timesheet is approved
 * 2. Verify employee mapping exists for the staff member
 * 3. Verify payroll provider is configured
 * 4. Push hours to Xero/KeyPay via integration client
 * 5. Update timesheet status to 'synced' with external reference
 *
 * NOTE: The actual API calls (step 4) will be wired in Phase 9d
 * when the Xero/KeyPay integration clients are built. Currently
 * performs all validation and marks as synced for testing.
 */
export async function syncTimesheetToPayroll(
  timesheetId: string
): Promise<ActionResponse<Timesheet>> {
  try {
    await requirePermission(Permissions.MANAGE_INTEGRATIONS);
    const supabase = await createSupabaseServerClient();

    // 1. Fetch the timesheet
    const { data: timesheet, error: fetchError } = await supabase
      .from('timesheets')
      .select('*')
      .eq('id', timesheetId)
      .is('deleted_at', null)
      .single();

    if (fetchError || !timesheet) {
      return failure('Timesheet not found', 'NOT_FOUND');
    }

    const typed = timesheet as Timesheet;

    if (typed.status !== 'approved') {
      return failure(
        `Cannot sync a timesheet in '${typed.status}' status. Must be 'approved'.`,
        'VALIDATION_ERROR'
      );
    }

    // 2. Check employee mapping exists
    const { data: mapping, error: mappingError } = await supabase
      .from('employee_mappings')
      .select('*')
      .eq('user_id', typed.user_id)
      .eq('is_active', true)
      .limit(1)
      .maybeSingle();

    if (mappingError) {
      return failure(mappingError.message, 'DB_ERROR');
    }

    if (!mapping) {
      return failure(
        'No employee mapping found for this staff member. Configure the mapping in Payroll Settings first.',
        'VALIDATION_ERROR'
      );
    }

    // 3. Check payroll provider is configured
    const { data: settings } = await supabase
      .from('payroll_settings')
      .select('payroll_provider, provider_config')
      .limit(1)
      .maybeSingle();

    if (!settings || !(settings as PayrollSettings).payroll_provider) {
      return failure(
        'No payroll provider configured. Set up Xero or KeyPay in Payroll Settings first.',
        'VALIDATION_ERROR'
      );
    }

    // 4. TODO: Push to Xero/KeyPay via integration client (Phase 9d)
    // const provider = (settings as PayrollSettings).payroll_provider;
    // const config = (settings as PayrollSettings).provider_config;
    // const typedMapping = mapping as EmployeeMapping;
    //
    // if (provider === 'xero') {
    //   const xeroClient = createXeroClient(config);
    //   const result = await xeroClient.pushTimesheet({ ... });
    //   syncReference = result.timesheetId;
    // } else if (provider === 'keypay') {
    //   const keypayClient = createKeyPayClient(config);
    //   const result = await keypayClient.pushTimesheet({ ... });
    //   syncReference = result.timesheetId;
    // }

    // 5. Mark as synced (for now, generates a placeholder reference)
    const syncReference = `STUB-${Date.now()}-${timesheetId.slice(0, 8)}`;

    const { data: updated, error: updateError } = await supabase
      .from('timesheets')
      .update({
        status: 'synced',
        synced_at: new Date().toISOString(),
        sync_reference: syncReference,
      })
      .eq('id', timesheetId)
      .select()
      .single();

    if (updateError) {
      return failure(updateError.message, 'DB_ERROR');
    }

    return success(updated as Timesheet);
  } catch (err) {
    const message = err instanceof Error ? err.message : 'Failed to sync timesheet to payroll';
    return failure(message, 'UNEXPECTED_ERROR');
  }
}

/**
 * Bulk sync all approved timesheets for a pay period.
 */
export async function bulkSyncTimesheets(
  payPeriodId: string
): Promise<ActionResponse<{ synced: number; failed: number; errors: string[] }>> {
  try {
    await requirePermission(Permissions.MANAGE_INTEGRATIONS);
    const supabase = await createSupabaseServerClient();

    // Get all approved timesheets for this period
    const { data: timesheets, error } = await supabase
      .from('timesheets')
      .select('id')
      .eq('pay_period_id', payPeriodId)
      .eq('status', 'approved')
      .is('deleted_at', null);

    if (error) {
      return failure(error.message, 'DB_ERROR');
    }

    const ids = ((timesheets ?? []) as Array<{ id: string }>).map((t) => t.id);

    if (ids.length === 0) {
      return failure('No approved timesheets found for this pay period', 'VALIDATION_ERROR');
    }

    let synced = 0;
    let failed = 0;
    const errors: string[] = [];

    for (const id of ids) {
      const result = await syncTimesheetToPayroll(id);
      if (result.error) {
        errors.push(`Timesheet ${id}: ${result.error.message}`);
        failed++;
      } else {
        synced++;
      }
    }

    return success({ synced, failed, errors });
  } catch (err) {
    const message = err instanceof Error ? err.message : 'Failed to bulk sync timesheets';
    return failure(message, 'UNEXPECTED_ERROR');
  }
}


===== D:\.code\wattleos\src\lib\actions\pickup-authorizations.ts =====

// src/lib/actions/pickup-authorizations.ts
//
// ============================================================
// WattleOS V2 â€” Pickup Authorization Server Actions
// ============================================================
// Manages who is authorized to pick up each student.
// Separate from guardians â€” covers grandparents, nannies,
// family friends, etc.
//
// WHY separate file: Pickup is managed on the student detail
// page (SIS context), not the daily attendance workflow.
// ============================================================

'use server';

import { createSupabaseServerClient } from '@/lib/supabase/server';
import { getTenantContext } from '@/lib/auth/tenant-context';
import { ActionResponse, success, failure } from '@/types/api';
import type { PickupAuthorization } from '@/types/domain';

// ============================================================
// Input Types
// ============================================================

export interface CreatePickupAuthorizationInput {
  studentId: string;
  authorizedName: string;
  relationship?: string;
  phone?: string;
  photoUrl?: string;
  isPermanent?: boolean;
  validFrom?: string;
  validUntil?: string;
}

export interface UpdatePickupAuthorizationInput {
  authorizedName?: string;
  relationship?: string;
  phone?: string;
  photoUrl?: string;
  isPermanent?: boolean;
  validFrom?: string | null;
  validUntil?: string | null;
}

// ============================================================
// LIST: All pickup authorizations for a student
// ============================================================

export async function listPickupAuthorizations(
  studentId: string
): Promise<ActionResponse<PickupAuthorization[]>> {
  try {
    await getTenantContext();
    const supabase = await createSupabaseServerClient();

    const { data, error } = await supabase
      .from('pickup_authorizations')
      .select('*')
      .eq('student_id', studentId)
      .is('deleted_at', null)
      .order('is_permanent', { ascending: false })
      .order('authorized_name', { ascending: true });

    if (error) {
      return failure(error.message, 'DB_ERROR');
    }

    return success((data ?? []) as PickupAuthorization[]);
  } catch (err) {
    const message = err instanceof Error ? err.message : 'Failed to list pickup authorizations';
    return failure(message, 'UNEXPECTED_ERROR');
  }
}

// ============================================================
// CREATE
// ============================================================

export async function createPickupAuthorization(
  input: CreatePickupAuthorizationInput
): Promise<ActionResponse<PickupAuthorization>> {
  try {
    const context = await getTenantContext();
    const supabase = await createSupabaseServerClient();

    if (!input.studentId) return failure('Student is required', 'VALIDATION_ERROR');
    if (!input.authorizedName?.trim()) return failure('Name is required', 'VALIDATION_ERROR');

    const { data, error } = await supabase
      .from('pickup_authorizations')
      .insert({
        tenant_id: context.tenant.id,
        student_id: input.studentId,
        authorized_name: input.authorizedName.trim(),
        relationship: input.relationship?.trim() || null,
        phone: input.phone?.trim() || null,
        photo_url: input.photoUrl || null,
        is_permanent: input.isPermanent ?? true,
        valid_from: input.validFrom || null,
        valid_until: input.validUntil || null,
        authorized_by: context.user.id,
      })
      .select()
      .single();

    if (error) {
      return failure(error.message, 'DB_ERROR');
    }

    return success(data as PickupAuthorization);
  } catch (err) {
    const message = err instanceof Error ? err.message : 'Failed to create pickup authorization';
    return failure(message, 'UNEXPECTED_ERROR');
  }
}

// ============================================================
// UPDATE
// ============================================================

export async function updatePickupAuthorization(
  id: string,
  input: UpdatePickupAuthorizationInput
): Promise<ActionResponse<PickupAuthorization>> {
  try {
    await getTenantContext();
    const supabase = await createSupabaseServerClient();

    const updates: Record<string, unknown> = {};
    if (input.authorizedName !== undefined) updates.authorized_name = input.authorizedName.trim();
    if (input.relationship !== undefined) updates.relationship = input.relationship?.trim() || null;
    if (input.phone !== undefined) updates.phone = input.phone?.trim() || null;
    if (input.photoUrl !== undefined) updates.photo_url = input.photoUrl || null;
    if (input.isPermanent !== undefined) updates.is_permanent = input.isPermanent;
    if (input.validFrom !== undefined) updates.valid_from = input.validFrom;
    if (input.validUntil !== undefined) updates.valid_until = input.validUntil;

    if (Object.keys(updates).length === 0) {
      return failure('No fields to update', 'VALIDATION_ERROR');
    }

    const { data, error } = await supabase
      .from('pickup_authorizations')
      .update(updates)
      .eq('id', id)
      .is('deleted_at', null)
      .select()
      .single();

    if (error) {
      return failure(error.message, 'DB_ERROR');
    }

    return success(data as PickupAuthorization);
  } catch (err) {
    const message = err instanceof Error ? err.message : 'Failed to update pickup authorization';
    return failure(message, 'UNEXPECTED_ERROR');
  }
}

// ============================================================
// DELETE (soft delete)
// ============================================================

export async function deletePickupAuthorization(
  id: string
): Promise<ActionResponse<{ success: boolean }>> {
  try {
    await getTenantContext();
    const supabase = await createSupabaseServerClient();

    const { error } = await supabase
      .from('pickup_authorizations')
      .update({ deleted_at: new Date().toISOString() })
      .eq('id', id)
      .is('deleted_at', null);

    if (error) {
      return failure(error.message, 'DB_ERROR');
    }

    return success({ success: true });
  } catch (err) {
    const message = err instanceof Error ? err.message : 'Failed to delete pickup authorization';
    return failure(message, 'UNEXPECTED_ERROR');
  }
}


===== D:\.code\wattleos\src\lib\actions\report-export.ts =====

// src/lib/actions/report-export.ts
//
// ============================================================
// WattleOS V2 â€” Report Export Server Actions
// ============================================================
// Handles PDF export for student reports. The pipeline:
//   1. Fetch the student report (must be approved or published)
//   2. Render to PDF via @react-pdf/renderer
//   3. Upload PDF to Supabase Storage
//   4. Update student_reports.pdf_storage_path
//   5. Return a signed download URL
//
// WHY separate from reports.ts: Export is an integration concern
// (PDF generation + storage upload), not a CRUD concern. Keeps
// the core reporting actions clean.
// ============================================================

"use server";

import {
  createSupabaseServerClient,
  createSupabaseAdminClient,
} from "@/lib/supabase/server";
import { requirePermission } from "@/lib/auth/tenant-context";
import { Permissions } from "@/lib/constants/permissions";
import { success, failure } from "@/types/api";
import type { ActionResponse } from "@/types/api";
import type { StudentReport } from "@/types/domain";
import {
  renderReportPdf,
  generateReportStoragePath,
  generateReportFilename,
} from "@/lib/integrations/pdf/client";
import type { ReportContent } from "@/lib/integrations/pdf/client";

// ============================================================
// Types
// ============================================================

interface PdfExportResult {
  /** Supabase Storage path of the uploaded PDF */
  storage_path: string;
  /** Signed download URL (valid for 1 hour) */
  download_url: string;
  /** Human-readable filename */
  filename: string;
  /** PDF file size in bytes */
  size_bytes: number;
}

type StudentJoin = {
  id?: string;
  first_name: string;
  last_name: string;
  preferred_name: string | null;
  dob?: string | null;
};

type TemplateJoin = { id: string; name: string };
type AuthorJoin = { id: string; first_name: string; last_name: string };

/**
 * Supabase/PostgREST sometimes returns joined relations as arrays
 * even when logically 1:1. This normalizes "object | object[] | null"
 * into "object | null".
 */
function firstOrNull<T>(v: T | T[] | null | undefined): T | null {
  if (!v) return null;
  return Array.isArray(v) ? (v[0] ?? null) : v;
}

// ============================================================
// EXPORT: Generate PDF and upload to storage
// ============================================================

export async function exportReportToPdf(
  reportId: string
): Promise<ActionResponse<PdfExportResult>> {
  try {
    const context = await requirePermission(Permissions.MANAGE_REPORTS);
    const supabase = await createSupabaseServerClient();
    const adminClient = createSupabaseAdminClient();

    // 1. Fetch the report with joined details
    const { data: report, error: fetchError } = await supabase
      .from("student_reports")
      .select(
        `
        *,
        student:students(id, first_name, last_name, preferred_name, dob),
        template:report_templates(id, name),
        author:users!student_reports_author_id_fkey(id, first_name, last_name)
      `
      )
      .eq("id", reportId)
      .is("deleted_at", null)
      .single();

    if (fetchError || !report) {
      return failure("Report not found", "NOT_FOUND");
    }

    // Normalize joins (student/template/author can come back as object or array)
    const student = firstOrNull(report.student as unknown as StudentJoin | StudentJoin[] | null);
    const template = firstOrNull(report.template as unknown as TemplateJoin | TemplateJoin[] | null);
    const author = firstOrNull(report.author as unknown as AuthorJoin | AuthorJoin[] | null);

    // Keep base report strongly typed
    const typedReport = report as StudentReport;

    // 2. Validate status â€” only approved or published reports get PDFs
    if (typedReport.status !== "approved" && typedReport.status !== "published") {
      return failure(
        `Cannot export a report in '${typedReport.status}' status. Report must be approved or published.`,
        "VALIDATION_ERROR"
      );
    }

    // 3. Build the ReportContent from the JSONB content + joined data
    const studentName = student
      ? `${student.preferred_name ?? student.first_name} ${student.last_name}`
      : "Unknown Student";

    const authorName = author
      ? `${author.first_name} ${author.last_name}`
      : "Unknown Author";

    const rawContent = typedReport.content as Record<string, unknown>;

    const reportContent: ReportContent = {
      student_name: (rawContent.student_name as string) ?? studentName,
      student_dob:
        (rawContent.student_dob as string) ??
        (student?.dob ?? undefined) ??
        undefined,
      class_name: (rawContent.class_name as string) ?? undefined,
      term: (rawContent.term as string) ?? typedReport.term ?? "Unknown Term",
      school_name: (rawContent.school_name as string) ?? "School",
      author_name: (rawContent.author_name as string) ?? authorName,
      report_date:
        (rawContent.report_date as string) ??
        new Date().toLocaleDateString("en-AU"),
      narrative: (rawContent.narrative as string) ?? undefined,
      sections: (rawContent.sections as ReportContent["sections"]) ?? undefined,
      observations:
        (rawContent.observations as ReportContent["observations"]) ?? undefined,
      mastery_summary:
        (rawContent.mastery_summary as ReportContent["mastery_summary"]) ??
        undefined,
      attendance:
        (rawContent.attendance as ReportContent["attendance"]) ?? undefined,
      teacher_comments: (rawContent.teacher_comments as string) ?? undefined,
      goals: (rawContent.goals as string) ?? undefined,
    };

    // 4. Render the PDF
    const pdfBuffer = await renderReportPdf(reportContent);

    // 5. Upload to Supabase Storage
    const storagePath = generateReportStoragePath({
      tenantId: context.tenant.id,
      studentId: typedReport.student_id,
      reportId: typedReport.id,
    });

    const { error: uploadError } = await adminClient.storage
      .from("reports")
      .upload(storagePath, pdfBuffer, {
        contentType: "application/pdf",
        upsert: true,
      });

    if (uploadError) {
      return failure(`Failed to upload PDF: ${uploadError.message}`, "STORAGE_ERROR");
    }

    // 6. Update the report record with the storage path
    const { error: updateError } = await supabase
      .from("student_reports")
      .update({ pdf_storage_path: storagePath })
      .eq("id", reportId);

    if (updateError) {
      console.error(
        `[report-export] PDF uploaded but failed to update record: ${updateError.message}`
      );
    }

    // 7. Generate a signed download URL (valid for 1 hour)
    const { data: signedUrlData, error: signedUrlError } = await adminClient.storage
      .from("reports")
      .createSignedUrl(storagePath, 3600);

    if (signedUrlError || !signedUrlData?.signedUrl) {
      return failure("PDF generated but failed to create download URL", "STORAGE_ERROR");
    }

    const filename = generateReportFilename(reportContent);

    return success({
      storage_path: storagePath,
      download_url: signedUrlData.signedUrl,
      filename,
      size_bytes: pdfBuffer.byteLength,
    });
  } catch (err) {
    const message = err instanceof Error ? err.message : "Failed to export report to PDF";
    return failure(message, "UNEXPECTED_ERROR");
  }
}

// ============================================================
// GET: Download URL for an existing PDF (staff)
// ============================================================

export async function getReportPdfUrl(
  reportId: string
): Promise<ActionResponse<{ download_url: string; filename: string }>> {
  try {
    await requirePermission(Permissions.MANAGE_REPORTS);
    const supabase = await createSupabaseServerClient();
    const adminClient = createSupabaseAdminClient();

    const { data: report, error: fetchError } = await supabase
      .from("student_reports")
      .select(
        `
        id, pdf_storage_path, term,
        student:students(first_name, last_name, preferred_name)
      `
      )
      .eq("id", reportId)
      .is("deleted_at", null)
      .single();

    if (fetchError || !report) {
      return failure("Report not found", "NOT_FOUND");
    }

    const student = firstOrNull(
      report.student as unknown as
        | { first_name: string; last_name: string; preferred_name: string | null }
        | { first_name: string; last_name: string; preferred_name: string | null }[]
        | null
    );

    const pdf_storage_path =
      (report as any).pdf_storage_path as string | null | undefined;

    if (!pdf_storage_path) {
      return failure(
        'This report has not been exported to PDF yet. Use "Export PDF" first.',
        "NOT_FOUND"
      );
    }

    const { data: signedUrlData, error: signedUrlError } = await adminClient.storage
      .from("reports")
      .createSignedUrl(pdf_storage_path, 3600);

    if (signedUrlError || !signedUrlData?.signedUrl) {
      return failure("Failed to generate download URL", "STORAGE_ERROR");
    }

    const studentName = student
      ? `${student.preferred_name ?? student.first_name} ${student.last_name}`
      : "Student";
    const term = (report as any).term ?? "Report";
    const filename = `${studentName.replace(/\s+/g, "_")}_${String(term).replace(
      /\s+/g,
      "_"
    )}_Report.pdf`;

    return success({
      download_url: signedUrlData.signedUrl,
      filename,
    });
  } catch (err) {
    const message = err instanceof Error ? err.message : "Failed to get PDF download URL";
    return failure(message, "UNEXPECTED_ERROR");
  }
}

// ============================================================
// PARENT: Download URL for a published report
// ============================================================

export async function getParentReportPdfUrl(
  reportId: string
): Promise<ActionResponse<{ download_url: string; filename: string }>> {
  try {
    const supabase = await createSupabaseServerClient();
    const adminClient = createSupabaseAdminClient();

    const { data: report, error: fetchError } = await supabase
      .from("student_reports")
      .select(
        `
        id, pdf_storage_path, term, status,
        student:students(first_name, last_name, preferred_name)
      `
      )
      .eq("id", reportId)
      .eq("status", "published")
      .is("deleted_at", null)
      .single();

    if (fetchError || !report) {
      return failure("Report not found or not available", "NOT_FOUND");
    }

    const student = firstOrNull(
      report.student as unknown as
        | { first_name: string; last_name: string; preferred_name: string | null }
        | { first_name: string; last_name: string; preferred_name: string | null }[]
        | null
    );

    const pdf_storage_path =
      (report as any).pdf_storage_path as string | null | undefined;

    if (!pdf_storage_path) {
      return failure("PDF is not yet available for this report", "NOT_FOUND");
    }

    const { data: signedUrlData, error: signedUrlError } = await adminClient.storage
      .from("reports")
      .createSignedUrl(pdf_storage_path, 3600);

    if (signedUrlError || !signedUrlData?.signedUrl) {
      return failure("Failed to generate download URL", "STORAGE_ERROR");
    }

    const studentName = student
      ? `${student.preferred_name ?? student.first_name} ${student.last_name}`
      : "Student";
    const term = (report as any).term ?? "Report";
    const filename = `${studentName.replace(/\s+/g, "_")}_${String(term).replace(
      /\s+/g,
      "_"
    )}_Report.pdf`;

    return success({
      download_url: signedUrlData.signedUrl,
      filename,
    });
  } catch (err) {
    const message = err instanceof Error ? err.message : "Failed to get PDF download URL";
    return failure(message, "UNEXPECTED_ERROR");
  }
}



===== D:\.code\wattleos\src\lib\actions\reports\index.ts =====

// src/lib/actions/reports/index.ts
//
// ============================================================
// WattleOS V2 â€” Reports Actions Barrel Export
// ============================================================
// Re-exports all Reporting actions for convenient importing.
// Usage:
//   import { listReportTemplates, generateStudentReport } from '@/lib/actions/reports';
// ============================================================

// â”€â”€ Template CRUD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
export {
  listReportTemplates,
  getReportTemplate,
  createReportTemplate,
  updateReportTemplate,
  duplicateReportTemplate,
  deleteReportTemplate,
} from './templates';

export type {
  CreateTemplateInput,
  UpdateTemplateInput,
  TemplateWithStats,
} from './templates';

// â”€â”€ Student Report CRUD + Generation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
export {
  listStudentReports,
  getStudentReport,
  generateStudentReport,
  bulkGenerateReports,
  updateReportContent,
  updateReportStatus,
  deleteStudentReport,
  getReportCompletionStats,
  getReportTerms,
} from './student-reports';

export type {
  GenerateReportInput,
  BulkGenerateReportsInput,
  UpdateReportContentInput,
  ListReportsParams,
  ReportWithDetails,
  ReportCompletionStats,
} from './student-reports';


===== D:\.code\wattleos\src\lib\actions\reports\student-reports.ts =====

// src/lib/actions/reports/student-reports.ts
//
// ============================================================
// WattleOS V2 - Student Report Server Actions
// ============================================================
// CRUD for individual student reports, plus:
//   - Data aggregation (mastery, attendance, observations)
//   - Report generation from a template
//   - Workflow transitions (draft â†’ review â†’ approved â†’ published)
//
// WHY separate from templates: Templates define structure;
// reports are the filled-in instances for specific students.
// This separation mirrors the curriculum template â†’ instance
// pattern used throughout WattleOS.
//
// All actions return ActionResponse<T> - never throw.
// RLS enforces tenant isolation at the database level.
// ============================================================

"use server";

import {
  createSupabaseServerClient,
  createSupabaseAdminClient,
} from "@/lib/supabase/server";
import { getTenantContext, requirePermission } from "@/lib/auth/tenant-context";
import { Permissions } from "@/lib/constants/permissions";
import {
  type ActionResponse,
  type PaginatedResponse,
  success,
  failure,
  paginated,
  paginatedFailure,
  ErrorCodes,
} from "@/types/api";
import type {
  StudentReport,
  ReportStatus as DomainReportStatus,
  Student,
  User,
  ReportTemplate,
  MasteryStatus,
} from "@/types/domain";
import { validatePagination } from "@/lib/utils";
import type {
  TemplateContent,
  TemplateSection,
  ReportContent,
  ReportSectionContent,
  ReportAutoData,
} from "@/lib/reports/types";
import { validateTemplateContent } from "@/lib/reports/types";

// NOTE:
// DomainReportStatus in @/types/domain may currently be missing "published".
// This actions file uses the canonical DB workflow union to avoid TS2367.

// keep this import referenced so it doesn't get flagged as unused in some configs
void (null as unknown as DomainReportStatus);

// ============================================================
// Input Types
// ============================================================

export interface GenerateReportInput {
  studentId: string;
  templateId: string;
  term: string;
  /** Start of the reporting period (ISO date) */
  periodStart: string;
  /** End of the reporting period (ISO date) */
  periodEnd: string;
}

export interface BulkGenerateReportsInput {
  studentIds: string[];
  templateId: string;
  term: string;
  periodStart: string;
  periodEnd: string;
}

export interface UpdateReportContentInput {
  /** Updated section contents (partial - only changed sections) */
  sections: Array<{
    templateSectionId: string;
    narrative?: string;
    completed?: boolean;
  }>;
}

export interface ListReportsParams {
  page?: number;
  per_page?: number;
  term?: string;
  status?: ReportStatus;
  studentId?: string;
  authorId?: string;
}

// ============================================================
// Compound types for UI
// ============================================================

/** Report with student and author details for list views */
export interface ReportWithDetails extends StudentReport {
  student: Pick<
    Student,
    "id" | "first_name" | "last_name" | "preferred_name" | "photo_url"
  >;
  author: Pick<User, "id" | "first_name" | "last_name">;
  templateName: string | null;
}

/** Completion stats for a report */
export interface ReportCompletionStats {
  totalSections: number;
  completedSections: number;
  editableSections: number;
  completedEditable: number;
  percentComplete: number;
}

// ============================================================
// LIST STUDENT REPORTS
// ============================================================

export async function listStudentReports(
  params: ListReportsParams = {}
): Promise<PaginatedResponse<ReportWithDetails>> {
  try {
    await requirePermission(Permissions.MANAGE_REPORTS);
    const supabase = await createSupabaseServerClient();
    const { page, perPage, offset } = validatePagination(
      params.page,
      params.per_page
    );

    // Build count query
    let countQuery = supabase
      .from("student_reports")
      .select("id", { count: "exact", head: true })
      .is("deleted_at", null);

    // Build data query with joins
    let dataQuery = supabase
      .from("student_reports")
      .select(
        "*, student:students(id, first_name, last_name, preferred_name, photo_url), author:users!student_reports_author_id_fkey(id, first_name, last_name), template:report_templates(name)"
      )
      .is("deleted_at", null)
      .order("updated_at", { ascending: false })
      .range(offset, offset + perPage - 1);

    // Apply filters to both queries
    if (params.term) {
      countQuery = countQuery.eq("term", params.term);
      dataQuery = dataQuery.eq("term", params.term);
    }
    if (params.status) {
      countQuery = countQuery.eq("status", params.status);
      dataQuery = dataQuery.eq("status", params.status);
    }
    if (params.studentId) {
      countQuery = countQuery.eq("student_id", params.studentId);
      dataQuery = dataQuery.eq("student_id", params.studentId);
    }
    if (params.authorId) {
      countQuery = countQuery.eq("author_id", params.authorId);
      dataQuery = dataQuery.eq("author_id", params.authorId);
    }

    const { count, error: countError } = await countQuery;
    if (countError) {
      return paginatedFailure(countError.message, ErrorCodes.DATABASE_ERROR);
    }

    const { data, error: dataError } = await dataQuery;
    if (dataError) {
      return paginatedFailure(dataError.message, ErrorCodes.DATABASE_ERROR);
    }

    // Map to ReportWithDetails
    const reports: ReportWithDetails[] = (
      (data ?? []) as Array<Record<string, unknown>>
    ).map((row) => {
      const student = row.student as Pick<
        Student,
        "id" | "first_name" | "last_name" | "preferred_name" | "photo_url"
      >;
      const author = row.author as Pick<User, "id" | "first_name" | "last_name">;
      const template = row.template as { name: string } | null;

      return {
        id: row.id as string,
        tenant_id: row.tenant_id as string,
        student_id: row.student_id as string,
        template_id: (row.template_id as string) ?? null,
        author_id: row.author_id as string,
        term: (row.term as string) ?? null,
        content: (row.content as Record<string, unknown>) ?? {},
        status: row.status as unknown as StudentReport["status"],
        published_at: (row.published_at as string) ?? null,
        google_doc_id: (row.google_doc_id as string) ?? null,
        pdf_storage_path: (row.pdf_storage_path as string) ?? null,
        student,
        author,
        templateName: template?.name ?? null,
      };
    });

    return paginated(reports, count ?? 0, page, perPage);
  } catch (err) {
    const message =
      err instanceof Error ? err.message : "Failed to list student reports";
    return paginatedFailure(message, ErrorCodes.UNKNOWN_ERROR);
  }
}

// ============================================================
// GET SINGLE STUDENT REPORT (with details)
// ============================================================

export async function getStudentReport(
  reportId: string
): Promise<ActionResponse<ReportWithDetails>> {
  try {
    await getTenantContext();
    const supabase = await createSupabaseServerClient();

    const { data, error } = await supabase
      .from("student_reports")
      .select(
        "*, student:students(id, first_name, last_name, preferred_name, photo_url), author:users!student_reports_author_id_fkey(id, first_name, last_name), template:report_templates(name)"
      )
      .eq("id", reportId)
      .is("deleted_at", null)
      .single();

    if (error || !data) {
      return failure("Report not found", ErrorCodes.NOT_FOUND);
    }

    const row = data as Record<string, unknown>;
    const student = row.student as Pick<
      Student,
      "id" | "first_name" | "last_name" | "preferred_name" | "photo_url"
    >;
    const author = row.author as Pick<User, "id" | "first_name" | "last_name">;
    const template = row.template as { name: string } | null;

    const report: ReportWithDetails = {
      id: row.id as string,
      tenant_id: row.tenant_id as string,
      student_id: row.student_id as string,
      template_id: (row.template_id as string) ?? null,
      author_id: row.author_id as string,
      term: (row.term as string) ?? null,
      content: (row.content as Record<string, unknown>) ?? {},
      status: row.status as unknown as StudentReport["status"],
      published_at: (row.published_at as string) ?? null,
      google_doc_id: (row.google_doc_id as string) ?? null,
      pdf_storage_path: (row.pdf_storage_path as string) ?? null,
      student,
      author,
      templateName: template?.name ?? null,
    };

    return success(report);
  } catch (err) {
    const message =
      err instanceof Error ? err.message : "Failed to get student report";
    return failure(message, ErrorCodes.UNKNOWN_ERROR);
  }
}

// ============================================================
// GENERATE REPORT FROM TEMPLATE
// ============================================================

export async function generateStudentReport(
  input: GenerateReportInput
): Promise<ActionResponse<StudentReport>> {
  try {
    const context = await requirePermission(Permissions.MANAGE_REPORTS);
    const supabase = await createSupabaseServerClient();

    // 1. Fetch the template
    const { data: templateRow, error: templateError } = await supabase
      .from("report_templates")
      .select("*")
      .eq("id", input.templateId)
      .is("deleted_at", null)
      .single();

    if (templateError || !templateRow) {
      return failure("Report template not found", ErrorCodes.NOT_FOUND);
    }

    const template = templateRow as ReportTemplate;
    const templateContent = template.content as unknown as TemplateContent;

    if (!validateTemplateContent(templateContent)) {
      return failure(
        "Template has invalid content structure",
        ErrorCodes.VALIDATION_ERROR
      );
    }

    // 2. Check for duplicate (same student + term + template)
    const { count: existingCount } = await supabase
      .from("student_reports")
      .select("id", { count: "exact", head: true })
      .eq("student_id", input.studentId)
      .eq("template_id", input.templateId)
      .eq("term", input.term)
      .is("deleted_at", null);

    if (existingCount && existingCount > 0) {
      return failure(
        "A report already exists for this student, template, and term",
        ErrorCodes.ALREADY_EXISTS
      );
    }

    // 3. Aggregate data for auto-populated sections
    const autoData = await aggregateStudentData(
      supabase,
      input.studentId,
      input.periodStart,
      input.periodEnd,
      templateContent
    );

    // 4. Build report content
    const reportContent: ReportContent = {
      version: 1,
      templateSnapshot: templateContent,
      sections: templateContent.sections.map((section) =>
        buildReportSection(section, autoData)
      ),
      reportingPeriod: {
        startDate: input.periodStart,
        endDate: input.periodEnd,
        termLabel: input.term,
      },
    };

    // 5. Insert the report
    const { data, error } = await supabase
      .from("student_reports")
      .insert({
        tenant_id: context.tenant.id,
        student_id: input.studentId,
        template_id: input.templateId,
        author_id: context.user.id,
        term: input.term,
        content: reportContent as unknown as Record<string, unknown>,
        status: "draft",
      })
      .select()
      .single();

    if (error) {
      return failure(error.message, ErrorCodes.DATABASE_ERROR);
    }

    // Audit log
    const adminClient = createSupabaseAdminClient();
    await adminClient.from("audit_logs").insert({
      tenant_id: context.tenant.id,
      user_id: context.user.id,
      action: "student_report.generated",
      entity_type: "student_report",
      entity_id: (data as StudentReport).id,
      metadata: {
        student_id: input.studentId,
        template_id: input.templateId,
        term: input.term,
      },
    });

    return success(data as StudentReport);
  } catch (err) {
    const message =
      err instanceof Error ? err.message : "Failed to generate student report";
    return failure(message, ErrorCodes.UNKNOWN_ERROR);
  }
}

// ============================================================
// BULK GENERATE REPORTS
// ============================================================

export async function bulkGenerateReports(
  input: BulkGenerateReportsInput
): Promise<
  ActionResponse<{ generated: number; skipped: number; errors: string[] }>
> {
  try {
    await requirePermission(Permissions.MANAGE_REPORTS);

    const results = { generated: 0, skipped: 0, errors: [] as string[] };

    for (const studentId of input.studentIds) {
      const result = await generateStudentReport({
        studentId,
        templateId: input.templateId,
        term: input.term,
        periodStart: input.periodStart,
        periodEnd: input.periodEnd,
      });

      if (result.error) {
        if (result.error.code === ErrorCodes.ALREADY_EXISTS) {
          results.skipped += 1;
        } else {
          results.errors.push(`Student ${studentId}: ${result.error.message}`);
        }
      } else {
        results.generated += 1;
      }
    }

    return success(results);
  } catch (err) {
    const message =
      err instanceof Error ? err.message : "Failed to bulk generate reports";
    return failure(message, ErrorCodes.UNKNOWN_ERROR);
  }
}

// ============================================================
// UPDATE REPORT CONTENT (teacher edits)
// ============================================================

export async function updateReportContent(
  reportId: string,
  input: UpdateReportContentInput
): Promise<ActionResponse<StudentReport>> {
  try {
    await requirePermission(Permissions.MANAGE_REPORTS);
    const supabase = await createSupabaseServerClient();

    // Fetch existing report
    const { data: existing, error: fetchError } = await supabase
      .from("student_reports")
      .select("*")
      .eq("id", reportId)
      .is("deleted_at", null)
      .single();

    if (fetchError || !existing) {
      return failure("Report not found", ErrorCodes.NOT_FOUND);
    }

    const report = existing as StudentReport;

    // âœ… widen locally (prevents TS narrowing that excludes "published")
    const status: ReportStatus = report.status as unknown as ReportStatus;

    if (status === "approved" || status === "published") {
      return failure(
        'Cannot edit an approved or published report. Change status to "review" first.',
        ErrorCodes.VALIDATION_ERROR
      );
    }

    // Parse existing content
    const content = report.content as unknown as ReportContent;
    if (!content?.sections) {
      return failure(
        "Report has invalid content structure",
        ErrorCodes.VALIDATION_ERROR
      );
    }

    // Apply section updates
    const updatedSections = content.sections.map((section) => {
      const update = input.sections.find(
        (s) => s.templateSectionId === section.templateSectionId
      );
      if (!update) return section;

      return {
        ...section,
        narrative:
          update.narrative !== undefined ? update.narrative : section.narrative,
        completed:
          update.completed !== undefined ? update.completed : section.completed,
      };
    });

    const updatedContent: ReportContent = {
      ...content,
      sections: updatedSections,
    };

    const { data, error } = await supabase
      .from("student_reports")
      .update({
        content: updatedContent as unknown as Record<string, unknown>,
      })
      .eq("id", reportId)
      .select()
      .single();

    if (error) {
      return failure(error.message, ErrorCodes.DATABASE_ERROR);
    }

    return success(data as StudentReport);
  } catch (err) {
    const message =
      err instanceof Error ? err.message : "Failed to update report content";
    return failure(message, ErrorCodes.UNKNOWN_ERROR);
  }
}

// ============================================================
// UPDATE REPORT STATUS (workflow transitions)
// ============================================================
type ReportStatus = "draft" | "review" | "approved" | "published";
type WorkflowReportStatus = "draft" | "review" | "approved" | "published";

const VALID_TRANSITIONS: Record<
  WorkflowReportStatus,
  readonly WorkflowReportStatus[]
> = {
  draft: ["review"],
  review: ["draft", "approved"],
  approved: ["review", "published"],
  published: ["approved"],
} as const;
export async function updateReportStatus(
  reportId: string,
  newStatus: WorkflowReportStatus
): Promise<ActionResponse<StudentReport>> {
  try {
    const context = await requirePermission(Permissions.MANAGE_REPORTS);
    const supabase = await createSupabaseServerClient();

    const { data: existing, error: fetchError } = await supabase
      .from("student_reports")
      .select("*")
      .eq("id", reportId)
      .is("deleted_at", null)
      .single();

    if (fetchError || !existing) {
      return failure("Report not found", ErrorCodes.NOT_FOUND);
    }

    const report = existing as StudentReport;

    // âœ… hard cast to the workflow union (cannot narrow away "published")
    const currentStatus = (report as any).status as WorkflowReportStatus;

    const validNext = VALID_TRANSITIONS[currentStatus] ?? [];

    if (!validNext.includes(newStatus)) {
      return failure(
        `Cannot transition from "${currentStatus}" to "${newStatus}". Valid transitions: ${
          validNext.join(", ") || "none"
        }`,
        ErrorCodes.INVALID_STATUS_TRANSITION
      );
    }

    const updateData: Record<string, unknown> = { status: newStatus };

    if (newStatus === "published") {
      updateData.published_at = new Date().toISOString();
    } else if (currentStatus === "published" && newStatus !== "published") {
      updateData.published_at = null;
    }

    const { data, error } = await supabase
      .from("student_reports")
      .update(updateData)
      .eq("id", reportId)
      .select()
      .single();

    if (error) {
      return failure(error.message, ErrorCodes.DATABASE_ERROR);
    }

    const adminClient = createSupabaseAdminClient();
    await adminClient.from("audit_logs").insert({
      tenant_id: context.tenant.id,
      user_id: context.user.id,
      action: "student_report.status_changed",
      entity_type: "student_report",
      entity_id: reportId,
      metadata: {
        from: currentStatus,
        to: newStatus,
        student_id: report.student_id,
      },
    });

    return success(data as StudentReport);
  } catch (err) {
    const message =
      err instanceof Error ? err.message : "Failed to update report status";
    return failure(message, ErrorCodes.UNKNOWN_ERROR);
  }
}

// ============================================================
// SOFT DELETE STUDENT REPORT
// ============================================================

export async function deleteStudentReport(
  reportId: string
): Promise<ActionResponse<{ id: string }>> {
  try {
    await requirePermission(Permissions.MANAGE_REPORTS);
    const supabase = await createSupabaseServerClient();

    // Don't allow deleting published reports
    const { data: existing } = await supabase
      .from("student_reports")
      .select("status")
      .eq("id", reportId)
      .is("deleted_at", null)
      .single();

    const existingStatus = (existing as { status?: unknown } | null)?.status as
      | ReportStatus
      | undefined;

    if (existingStatus === "published") {
      return failure(
        "Cannot delete a published report. Unpublish it first.",
        ErrorCodes.VALIDATION_ERROR
      );
    }

    const { error } = await supabase
      .from("student_reports")
      .update({ deleted_at: new Date().toISOString() })
      .eq("id", reportId)
      .is("deleted_at", null);

    if (error) {
      return failure(error.message, ErrorCodes.DATABASE_ERROR);
    }

    return success({ id: reportId });
  } catch (err) {
    const message =
      err instanceof Error ? err.message : "Failed to delete student report";
    return failure(message, ErrorCodes.UNKNOWN_ERROR);
  }
}

// ============================================================
// GET COMPLETION STATS FOR A REPORT
// ============================================================
// ============================================================
// GET COMPLETION STATS FOR A REPORT
// ============================================================

export async function getReportCompletionStats(
  reportContent: Record<string, unknown>
): Promise<ReportCompletionStats> {
  const content = reportContent as unknown as ReportContent;

  if (!content?.sections) {
    return {
      totalSections: 0,
      completedSections: 0,
      editableSections: 0,
      completedEditable: 0,
      percentComplete: 0,
    };
  }

  const editableTypes = new Set([
    "narrative",
    "custom_text",
    "goals",
    "observation_highlights",
  ]);

  const totalSections = content.sections.length;
  const completedSections = content.sections.filter((s) => s.completed).length;

  const editableSections = content.sections.filter((s) =>
    editableTypes.has(s.type)
  ).length;

  const completedEditable = content.sections.filter(
    (s) => editableTypes.has(s.type) && s.completed
  ).length;

  return {
    totalSections,
    completedSections,
    editableSections,
    completedEditable,
    percentComplete:
      editableSections > 0
        ? Math.round((completedEditable / editableSections) * 100)
        : 100,
  };
}


// ============================================================
// GET DISTINCT TERMS
// ============================================================

export async function getReportTerms(): Promise<ActionResponse<string[]>> {
  try {
    await requirePermission(Permissions.MANAGE_REPORTS);
    const supabase = await createSupabaseServerClient();

    const { data, error } = await supabase
      .from("student_reports")
      .select("term")
      .is("deleted_at", null)
      .not("term", "is", null)
      .order("term", { ascending: false });

    if (error) {
      return failure(error.message, ErrorCodes.DATABASE_ERROR);
    }

    // Deduplicate
    const terms = [
      ...new Set(
        ((data ?? []) as Array<{ term: string | null }>)
          .map((r) => r.term)
          .filter((t): t is string => t !== null)
      ),
    ];

    return success(terms);
  } catch (err) {
    const message =
      err instanceof Error ? err.message : "Failed to get report terms";
    return failure(message, ErrorCodes.UNKNOWN_ERROR);
  }
}

// ============================================================
// PRIVATE: Aggregate student data for report generation
// ============================================================

interface AggregatedStudentData {
  studentInfo: ReportAutoData["studentInfo"];
  masterySummary: ReportAutoData["masterySummary"];
  masteryGrid: ReportAutoData["masteryGrid"];
  attendanceSummary: ReportAutoData["attendanceSummary"];
  observationHighlights: ReportAutoData["observationHighlights"];
}

type CurriculumNodeRow = {
  id: string;
  title: string;
  level: string;
  parent_id: string | null;
};

function toSingleCurriculumNode(v: unknown): CurriculumNodeRow | null {
  if (!v) return null;
  if (Array.isArray(v)) return (v[0] ?? null) as CurriculumNodeRow | null;
  return v as CurriculumNodeRow;
}

function getCurriculumNodeTitle(v: unknown): string | null {
  if (!v) return null;
  if (Array.isArray(v)) return (v[0]?.title as string) ?? null;
  return ((v as any).title as string) ?? null;
}

async function aggregateStudentData(
  supabase: Awaited<ReturnType<typeof createSupabaseServerClient>>,
  studentId: string,
  periodStart: string,
  periodEnd: string,
  templateContent: TemplateContent
): Promise<AggregatedStudentData> {
  // Determine which data types we actually need
  const sectionTypes = new Set(templateContent.sections.map((s) => s.type));

  const result: AggregatedStudentData = {
    studentInfo: undefined,
    masterySummary: undefined,
    masteryGrid: undefined,
    attendanceSummary: undefined,
    observationHighlights: undefined,
  };

  // â”€â”€ Student Info â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if (sectionTypes.has("student_info")) {
    const { data: student } = await supabase
      .from("students")
      .select(
        "id, first_name, last_name, preferred_name, dob, photo_url, enrollment_status"
      )
      .eq("id", studentId)
      .single();

    if (student) {
      const s = student as Record<string, unknown>;

      // Get current class
      const { data: enrollment } = await supabase
        .from("enrollments")
        .select("class:classes(name, cycle_level)")
        .eq("student_id", studentId)
        .eq("status", "active")
        .is("deleted_at", null)
        .limit(1)
        .single();

      const classData = (enrollment as Record<string, unknown>)?.class as {
        name: string;
        cycle_level: string | null;
      } | null;

      result.studentInfo = {
        firstName: s.first_name as string,
        lastName: s.last_name as string,
        preferredName: (s.preferred_name as string) ?? null,
        dob: (s.dob as string) ?? null,
        photoUrl: (s.photo_url as string) ?? null,
        className: classData?.name ?? null,
        cycleLevelName: classData?.cycle_level ?? null,
        enrollmentStatus: s.enrollment_status as string,
      };
    }
  }

  // â”€â”€ Mastery Data â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if (sectionTypes.has("mastery_grid") || sectionTypes.has("mastery_summary")) {
    const { data: masteryRows } = await supabase
      .from("student_mastery")
      .select(
        "curriculum_node_id, status, curriculum_node:curriculum_nodes(id, title, level, parent_id)"
      )
      .eq("student_id", studentId)
      .is("deleted_at", null);

    if (masteryRows && masteryRows.length > 0) {
      // Normalise curriculum_node which Supabase may return as [] instead of object|null
      const rows = (masteryRows as Array<Record<string, unknown>>).map((r) => ({
        curriculum_node_id: r.curriculum_node_id as string,
        status: r.status as MasteryStatus,
        curriculum_node: toSingleCurriculumNode((r as any).curriculum_node),
      }));

      // Grid data
      result.masteryGrid = rows
        .filter((r) => r.curriculum_node)
        .map((r) => ({
          nodeId: r.curriculum_node_id,
          nodeTitle: r.curriculum_node!.title,
          nodeLevel: r.curriculum_node!.level,
          parentTitle: null, // Could resolve parent titles if needed
          status: r.status,
        }));

      // Summary data
      const total = rows.length;
      const notStarted = rows.filter((r) => r.status === "not_started").length;
      const presented = rows.filter((r) => r.status === "presented").length;
      const practicing = rows.filter((r) => r.status === "practicing").length;
      const mastered = rows.filter((r) => r.status === "mastered").length;

      result.masterySummary = {
        total,
        notStarted,
        presented,
        practicing,
        mastered,
        percentMastered: total > 0 ? Math.round((mastered / total) * 100) : 0,
      };
    }
  }

  // â”€â”€ Attendance Data â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if (sectionTypes.has("attendance_summary")) {
    const { data: attendanceRows } = await supabase
      .from("attendance_records")
      .select("status")
      .eq("student_id", studentId)
      .gte("date", periodStart)
      .lte("date", periodEnd)
      .is("deleted_at", null);

    if (attendanceRows) {
      const rows = attendanceRows as Array<{ status: string }>;
      const totalDays = rows.length;
      const present = rows.filter((r) => r.status === "present").length;
      const absent = rows.filter((r) => r.status === "absent").length;
      const late = rows.filter((r) => r.status === "late").length;
      const excused = rows.filter((r) => r.status === "excused").length;
      const halfDay = rows.filter((r) => r.status === "half_day").length;

      result.attendanceSummary = {
        totalDays,
        present,
        absent,
        late,
        excused,
        halfDay,
        attendanceRate:
          totalDays > 0 ? Math.round((present / totalDays) * 100) : 0,
      };
    }
  }

  // â”€â”€ Observation Highlights â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if (sectionTypes.has("observation_highlights")) {
    // Get max count from template config
    const obsSection = templateContent.sections.find(
      (s) => s.type === "observation_highlights"
    );
    const maxObs = obsSection?.config?.maxObservations ?? 5;

    // Find observations tagged to this student in the period
    const { data: obsLinks } = await supabase
      .from("observation_students")
      .select("observation_id")
      .eq("student_id", studentId);

    const obsIds = ((obsLinks ?? []) as Array<{ observation_id: string }>).map(
      (r) => r.observation_id
    );

    if (obsIds.length > 0) {
      const { data: observations } = await supabase
        .from("observations")
        .select(
          "id, content, created_at, author_id, author:users!observations_author_id_fkey(first_name, last_name)"
        )
        .in("id", obsIds)
        .eq("status", "published")
        .gte("created_at", periodStart)
        .lte("created_at", periodEnd)
        .is("deleted_at", null)
        .order("created_at", { ascending: false })
        .limit(maxObs);

      if (observations) {
        // Get outcome titles for each observation
        const observationIds = (observations as Array<{ id: string }>).map(
          (o) => o.id
        );

        const { data: outcomeLinks } = await supabase
          .from("observation_outcomes")
          .select("observation_id, curriculum_node:curriculum_nodes(title)")
          .in("observation_id", observationIds);

        const outcomeMap = new Map<string, string[]>();
        for (const link of (outcomeLinks ?? []) as Array<
          Record<string, unknown>
        >) {
          const obsId = link.observation_id as string;
          const title = getCurriculumNodeTitle((link as any).curriculum_node);

          if (!outcomeMap.has(obsId)) outcomeMap.set(obsId, []);
          if (title) outcomeMap.get(obsId)!.push(title);
        }

        // Get media counts
        const { data: mediaCounts } = await supabase
          .from("observation_media")
          .select("observation_id")
          .in("observation_id", observationIds);

        const mediaCountMap = new Map<string, number>();
        for (const m of (mediaCounts ?? []) as Array<{ observation_id: string }>) {
          mediaCountMap.set(
            m.observation_id,
            (mediaCountMap.get(m.observation_id) ?? 0) + 1
          );
        }

        result.observationHighlights = (
          observations as Array<Record<string, unknown>>
        ).map((obs) => {
          const author = obs.author as
            | { first_name: string | null; last_name: string | null }
            | null;
          const authorName = author
            ? [author.first_name, author.last_name].filter(Boolean).join(" ")
            : "Unknown";

          return {
            id: obs.id as string,
            content: (obs.content as string) ?? null,
            createdAt: obs.created_at as string,
            authorName,
            outcomes: outcomeMap.get(obs.id as string) ?? [],
            mediaCount: mediaCountMap.get(obs.id as string) ?? 0,
          };
        });
      }
    }
  }

  return result;
}

// ============================================================
// PRIVATE: Build a single report section from a template section
// ============================================================

function buildReportSection(
  templateSection: TemplateSection,
  data: AggregatedStudentData
): ReportSectionContent {
  const section: ReportSectionContent = {
    templateSectionId: templateSection.id,
    type: templateSection.type,
    title: templateSection.title,
    order: templateSection.order,
    completed: false,
  };

  // Auto-populated sections get their data and are marked complete
  switch (templateSection.type) {
    case "student_info":
      if (data.studentInfo) {
        section.autoData = { studentInfo: data.studentInfo };
        section.completed = true;
      }
      break;

    case "mastery_grid":
      if (data.masteryGrid) {
        // Filter by curriculum area if configured
        let grid = data.masteryGrid;
        const areaFilter = (templateSection as any).config?.curriculumAreaFilter;
        if (areaFilter && areaFilter !== "all") {
          grid = grid.filter((item) => item.parentTitle === areaFilter);
        }
        section.autoData = { masteryGrid: grid };
        section.completed = true;
      }
      break;

    case "mastery_summary":
      if (data.masterySummary) {
        section.autoData = { masterySummary: data.masterySummary };
        section.completed = true;
      }
      break;

    case "attendance_summary":
      if (data.attendanceSummary) {
        section.autoData = { attendanceSummary: data.attendanceSummary };
        section.completed = true;
      }
      break;

    case "observation_highlights":
      if (data.observationHighlights) {
        section.autoData = { observationHighlights: data.observationHighlights };
        // Semi-auto: teacher should review/curate, so not marked complete
        section.completed = false;
      }
      break;

    // Manual sections start empty
    case "narrative":
    case "custom_text":
    case "goals":
      section.narrative = "";
      section.completed = false;
      break;
  }

  return section;
}



===== D:\.code\wattleos\src\lib\actions\reports\templates.ts =====

// src/lib/actions/reports/templates.ts
//
// ============================================================
// WattleOS V2 â€” Report Template Server Actions
// ============================================================
// CRUD operations for report templates. Templates define the
// structure of end-of-term reports â€” schools compose them from
// section types (narrative, mastery grid, attendance, etc.).
//
// WHY template builder: Every Montessori school has different
// reporting requirements. Some focus on narrative, others on
// data. Rather than shipping fixed formats, we let each school
// design their own report structure.
//
// All actions return ActionResponse<T> â€” never throw.
// RLS enforces tenant isolation at the database level.
// ============================================================

'use server';

import { createSupabaseServerClient, createSupabaseAdminClient } from '@/lib/supabase/server';
import { getTenantContext, requirePermission } from '@/lib/auth/tenant-context';
import { Permissions } from '@/lib/constants/permissions';
import { ActionResponse, success, failure, ErrorCodes } from '@/types/api';
import type { ReportTemplate } from '@/types/domain';
import {
  TemplateContent,
  createDefaultTemplateContent,
  validateTemplateContent,
} from '@/lib/reports/types';

// ============================================================
// Input Types
// ============================================================

export interface CreateTemplateInput {
  name: string;
  cycleLevel?: string | null;
  content?: TemplateContent;
}

export interface UpdateTemplateInput {
  name?: string;
  cycleLevel?: string | null;
  content?: TemplateContent;
  isActive?: boolean;
}

// ============================================================
// Compound types for UI
// ============================================================

/** Template with count of reports generated from it */
export interface TemplateWithStats extends ReportTemplate {
  reportCount: number;
}

// ============================================================
// LIST REPORT TEMPLATES
// ============================================================

export async function listReportTemplates(params?: {
  cycleLevel?: string;
  activeOnly?: boolean;
}): Promise<ActionResponse<TemplateWithStats[]>> {
  try {
    await requirePermission(Permissions.MANAGE_REPORTS);
    const supabase = await createSupabaseServerClient();

    let query = supabase
      .from('report_templates')
      .select('*')
      .is('deleted_at', null)
      .order('name', { ascending: true });

    if (params?.cycleLevel) {
      query = query.eq('cycle_level', params.cycleLevel);
    }

    if (params?.activeOnly !== false) {
      // Default: only show active templates
      query = query.eq('is_active', true);
    }

    const { data, error } = await query;

    if (error) {
      return failure(error.message, ErrorCodes.DATABASE_ERROR);
    }

    const templates = (data ?? []) as ReportTemplate[];

    // Get report counts for each template
    const templateIds = templates.map((t) => t.id);

    let reportCounts: Record<string, number> = {};
    if (templateIds.length > 0) {
      const { data: counts } = await supabase
        .from('student_reports')
        .select('template_id')
        .in('template_id', templateIds)
        .is('deleted_at', null);

      for (const row of (counts ?? []) as Array<{ template_id: string }>) {
        reportCounts[row.template_id] = (reportCounts[row.template_id] ?? 0) + 1;
      }
    }

    const templatesWithStats: TemplateWithStats[] = templates.map((t) => ({
      ...t,
      reportCount: reportCounts[t.id] ?? 0,
    }));

    return success(templatesWithStats);
  } catch (err) {
    const message = err instanceof Error ? err.message : 'Failed to list report templates';
    return failure(message, ErrorCodes.UNKNOWN_ERROR);
  }
}

// ============================================================
// GET SINGLE REPORT TEMPLATE
// ============================================================

export async function getReportTemplate(
  templateId: string
): Promise<ActionResponse<ReportTemplate>> {
  try {
    await requirePermission(Permissions.MANAGE_REPORTS);
    const supabase = await createSupabaseServerClient();

    const { data, error } = await supabase
      .from('report_templates')
      .select('*')
      .eq('id', templateId)
      .is('deleted_at', null)
      .single();

    if (error || !data) {
      return failure('Report template not found', ErrorCodes.NOT_FOUND);
    }

    return success(data as ReportTemplate);
  } catch (err) {
    const message = err instanceof Error ? err.message : 'Failed to get report template';
    return failure(message, ErrorCodes.UNKNOWN_ERROR);
  }
}

// ============================================================
// CREATE REPORT TEMPLATE
// ============================================================

export async function createReportTemplate(
  input: CreateTemplateInput
): Promise<ActionResponse<ReportTemplate>> {
  try {
    const context = await requirePermission(Permissions.MANAGE_REPORTS);
    const supabase = await createSupabaseServerClient();

    // Validation
    if (!input.name?.trim()) {
      return failure('Template name is required', ErrorCodes.VALIDATION_ERROR);
    }

    // Use provided content or generate default
    const content = input.content ?? createDefaultTemplateContent();

    if (!validateTemplateContent(content)) {
      return failure('Invalid template content structure', ErrorCodes.VALIDATION_ERROR);
    }

    const { data, error } = await supabase
      .from('report_templates')
      .insert({
        tenant_id: context.tenant.id,
        name: input.name.trim(),
        cycle_level: input.cycleLevel?.trim() || null,
        content: content as unknown as Record<string, unknown>,
        is_active: true,
      })
      .select()
      .single();

    if (error) {
      return failure(error.message, ErrorCodes.DATABASE_ERROR);
    }

    // Audit log
    const adminClient = createSupabaseAdminClient();
    await adminClient.from('audit_logs').insert({
      tenant_id: context.tenant.id,
      user_id: context.user.id,
      action: 'report_template.created',
      entity_type: 'report_template',
      entity_id: (data as ReportTemplate).id,
      metadata: { name: input.name },
    });

    return success(data as ReportTemplate);
  } catch (err) {
    const message = err instanceof Error ? err.message : 'Failed to create report template';
    return failure(message, ErrorCodes.UNKNOWN_ERROR);
  }
}

// ============================================================
// UPDATE REPORT TEMPLATE
// ============================================================

export async function updateReportTemplate(
  templateId: string,
  input: UpdateTemplateInput
): Promise<ActionResponse<ReportTemplate>> {
  try {
    await requirePermission(Permissions.MANAGE_REPORTS);
    const supabase = await createSupabaseServerClient();

    // Build update payload â€” only include provided fields
    const updateData: Record<string, unknown> = {};

    if (input.name !== undefined) {
      if (!input.name.trim()) {
        return failure('Template name cannot be empty', ErrorCodes.VALIDATION_ERROR);
      }
      updateData.name = input.name.trim();
    }

    if (input.cycleLevel !== undefined) {
      updateData.cycle_level = input.cycleLevel?.trim() || null;
    }

    if (input.content !== undefined) {
      if (!validateTemplateContent(input.content)) {
        return failure('Invalid template content structure', ErrorCodes.VALIDATION_ERROR);
      }
      updateData.content = input.content as unknown as Record<string, unknown>;
    }

    if (input.isActive !== undefined) {
      updateData.is_active = input.isActive;
    }

    if (Object.keys(updateData).length === 0) {
      return failure('No fields to update', ErrorCodes.VALIDATION_ERROR);
    }

    const { data, error } = await supabase
      .from('report_templates')
      .update(updateData)
      .eq('id', templateId)
      .is('deleted_at', null)
      .select()
      .single();

    if (error) {
      return failure(error.message, ErrorCodes.DATABASE_ERROR);
    }

    if (!data) {
      return failure('Report template not found', ErrorCodes.NOT_FOUND);
    }

    return success(data as ReportTemplate);
  } catch (err) {
    const message = err instanceof Error ? err.message : 'Failed to update report template';
    return failure(message, ErrorCodes.UNKNOWN_ERROR);
  }
}

// ============================================================
// DUPLICATE REPORT TEMPLATE
// ============================================================
// Creates a copy of an existing template with "(Copy)" appended
// to the name. Useful for schools that want to iterate on a
// template without modifying the original.

export async function duplicateReportTemplate(
  templateId: string
): Promise<ActionResponse<ReportTemplate>> {
  try {
    const context = await requirePermission(Permissions.MANAGE_REPORTS);
    const supabase = await createSupabaseServerClient();

    // Fetch the source template
    const { data: source, error: fetchError } = await supabase
      .from('report_templates')
      .select('*')
      .eq('id', templateId)
      .is('deleted_at', null)
      .single();

    if (fetchError || !source) {
      return failure('Source template not found', ErrorCodes.NOT_FOUND);
    }

    const sourceTemplate = source as ReportTemplate;

    // Create the duplicate
    const { data, error } = await supabase
      .from('report_templates')
      .insert({
        tenant_id: context.tenant.id,
        name: `${sourceTemplate.name} (Copy)`,
        cycle_level: sourceTemplate.cycle_level,
        content: sourceTemplate.content,
        is_active: true,
      })
      .select()
      .single();

    if (error) {
      return failure(error.message, ErrorCodes.DATABASE_ERROR);
    }

    return success(data as ReportTemplate);
  } catch (err) {
    const message = err instanceof Error ? err.message : 'Failed to duplicate report template';
    return failure(message, ErrorCodes.UNKNOWN_ERROR);
  }
}

// ============================================================
// SOFT DELETE REPORT TEMPLATE
// ============================================================

export async function deleteReportTemplate(
  templateId: string
): Promise<ActionResponse<{ id: string }>> {
  try {
    await requirePermission(Permissions.MANAGE_REPORTS);
    const supabase = await createSupabaseServerClient();

    // Check if any non-deleted reports use this template
    const { count } = await supabase
      .from('student_reports')
      .select('id', { count: 'exact', head: true })
      .eq('template_id', templateId)
      .is('deleted_at', null);

    if (count && count > 0) {
      return failure(
        `This template is used by ${count} report(s). Deactivate it instead, or delete the reports first.`,
        ErrorCodes.VALIDATION_ERROR
      );
    }

    const { error } = await supabase
      .from('report_templates')
      .update({ deleted_at: new Date().toISOString(), is_active: false })
      .eq('id', templateId)
      .is('deleted_at', null);

    if (error) {
      return failure(error.message, ErrorCodes.DATABASE_ERROR);
    }

    return success({ id: templateId });
  } catch (err) {
    const message = err instanceof Error ? err.message : 'Failed to delete report template';
    return failure(message, ErrorCodes.UNKNOWN_ERROR);
  }
}


===== D:\.code\wattleos\src\lib\actions\sis.ts =====

// ============================================================
// WattleOS V2 â€” SIS Actions Barrel Export
// ============================================================
// Re-exports all Student Information System actions for
// convenient importing. Usage:
//   import { listStudents, createStudent } from '@/lib/actions/sis';
// ============================================================

export {
  listStudents,
  getStudent,
  createStudent,
  updateStudent,
  deleteStudent,
} from './students';

export type {
  CreateStudentInput,
  UpdateStudentInput,
  ListStudentsParams,
} from './students';

export {
  listClasses,
  getClass,
  getClassRoster,
  createClass,
  updateClass,
  deleteClass,
} from './classes';

export type {
  CreateClassInput,
  UpdateClassInput,
} from './classes';

export {
  enrollStudent,
  transferStudent,
  withdrawStudent,
  getStudentEnrollmentHistory,
} from './enrollments';

export type {
  EnrollStudentInput,
  TransferStudentInput,
} from './enrollments';

export {
  listGuardians,
  createGuardian,
  updateGuardian,
  removeGuardian,
} from './guardians';

export type {
  CreateGuardianInput,
  UpdateGuardianInput,
} from './guardians';

export {
  listMedicalConditions,
  listCriticalMedicalConditions,
  createMedicalCondition,
  updateMedicalCondition,
  deleteMedicalCondition,
} from './medical';

export type {
  CreateMedicalConditionInput,
  UpdateMedicalConditionInput,
} from './medical';

export {
  listEmergencyContacts,
  createEmergencyContact,
  updateEmergencyContact,
  deleteEmergencyContact,
} from './emergency-contacts';

export type {
  CreateEmergencyContactInput,
  UpdateEmergencyContactInput,
} from './emergency-contacts';

export {
  listCustodyRestrictions,
  createCustodyRestriction,
  updateCustodyRestriction,
  deleteCustodyRestriction,
} from './custody';

export type {
  CreateCustodyRestrictionInput,
  UpdateCustodyRestrictionInput,
} from './custody';


===== D:\.code\wattleos\src\lib\actions\students.ts =====

'use server';

// ============================================================
// WattleOS V2 â€” Student Server Actions
// ============================================================
// CRUD operations for student records.
// All actions return ActionResponse<T> â€” never throw.
// RLS enforces tenant isolation at the database level.
//
// Fix: createStudent now calls getTenantContext() to get
// tenant_id for the INSERT. Without this, the NOT NULL
// constraint on tenant_id would reject every insert.
// ============================================================

import { createSupabaseServerClient, createSupabaseAdminClient } from '@/lib/supabase/server';
import { getTenantContext } from '@/lib/auth/tenant-context';
import { ActionResponse, PaginatedResponse, success, failure, paginated, paginatedFailure } from '@/types/api';
import { Student, StudentWithDetails, EnrollmentStatus } from '@/types/domain';
import { validatePagination } from '@/lib/utils';

// ============================================================
// Input Types
// ============================================================

export interface CreateStudentInput {
  first_name: string;
  last_name: string;
  preferred_name?: string | null;
  dob?: string | null;
  gender?: string | null;
  photo_url?: string | null;
  enrollment_status?: EnrollmentStatus;
  notes?: string | null;
}

export interface UpdateStudentInput {
  first_name?: string;
  last_name?: string;
  preferred_name?: string | null;
  dob?: string | null;
  gender?: string | null;
  photo_url?: string | null;
  enrollment_status?: EnrollmentStatus;
  notes?: string | null;
}

export interface ListStudentsParams {
  page?: number;
  per_page?: number;
  search?: string;
  enrollment_status?: EnrollmentStatus;
  class_id?: string;
}

// ============================================================
// LIST STUDENTS
// ============================================================

export async function listStudents(
  params: ListStudentsParams = {}
): Promise<PaginatedResponse<Student>> {
  try {
    const supabase = await createSupabaseServerClient();
    const { page, perPage, offset } = validatePagination(params.page, params.per_page);

    // Base query â€” RLS handles tenant isolation
    let query = supabase
      .from('students')
      .select('*', { count: 'exact' })
      .is('deleted_at', null)
      .order('last_name', { ascending: true })
      .order('first_name', { ascending: true });

    // Filter: enrollment status
    if (params.enrollment_status) {
      query = query.eq('enrollment_status', params.enrollment_status);
    }

    // Filter: search by name
    if (params.search) {
      const searchTerm = `%${params.search}%`;
      query = query.or(
        `first_name.ilike.${searchTerm},last_name.ilike.${searchTerm},preferred_name.ilike.${searchTerm}`
      );
    }

    // Filter: students in a specific class (via enrollments)
    if (params.class_id) {
      const { data: enrollmentData } = await supabase
        .from('enrollments')
        .select('student_id')
        .eq('class_id', params.class_id)
        .eq('status', 'active')
        .is('deleted_at', null);

      const studentIds = enrollmentData?.map((e) => e.student_id) ?? [];
      if (studentIds.length === 0) {
        return paginated([], 0, page, perPage);
      }
      query = query.in('id', studentIds);
    }

    // Paginate
    query = query.range(offset, offset + perPage - 1);

    const { data, count, error } = await query;

    if (error) {
      return paginatedFailure(error.message, 'DB_ERROR');
    }

    return paginated(data as Student[], count ?? 0, page, perPage);
  } catch (err) {
    const message = err instanceof Error ? err.message : 'Failed to list students';
    return paginatedFailure(message, 'UNEXPECTED_ERROR');
  }
}

// ============================================================
// GET STUDENT BY ID (with all related data)
// ============================================================

export async function getStudent(studentId: string): Promise<ActionResponse<StudentWithDetails>> {
  try {
    const supabase = await createSupabaseServerClient();

    // Fetch student
    const { data: student, error: studentError } = await supabase
      .from('students')
      .select('*')
      .eq('id', studentId)
      .is('deleted_at', null)
      .single();

    if (studentError || !student) {
      return failure('Student not found', 'NOT_FOUND');
    }

    // Fetch enrollments with class data
    const { data: enrollments } = await supabase
      .from('enrollments')
      .select('*, class:classes(*)')
      .eq('student_id', studentId)
      .is('deleted_at', null)
      .order('start_date', { ascending: false });

    // Fetch guardians with user data
    const { data: guardians } = await supabase
      .from('guardians')
      .select('*, user:users(id, email, first_name, last_name, avatar_url)')
      .eq('student_id', studentId)
      .is('deleted_at', null)
      .order('is_primary', { ascending: false });

    // Fetch medical conditions
    const { data: medicalConditions } = await supabase
      .from('medical_conditions')
      .select('*')
      .eq('student_id', studentId)
      .is('deleted_at', null)
      .order('severity', { ascending: true });

    // Fetch emergency contacts
    const { data: emergencyContacts } = await supabase
      .from('emergency_contacts')
      .select('*')
      .eq('student_id', studentId)
      .is('deleted_at', null)
      .order('priority_order', { ascending: true });

    // Fetch custody restrictions
    const { data: custodyRestrictions } = await supabase
      .from('custody_restrictions')
      .select('*')
      .eq('student_id', studentId)
      .is('deleted_at', null);

    const studentWithDetails: StudentWithDetails = {
      ...(student as Student),
      enrollments: (enrollments ?? []) as StudentWithDetails['enrollments'],
      guardians: (guardians ?? []) as StudentWithDetails['guardians'],
      medical_conditions: medicalConditions ?? [],
      emergency_contacts: emergencyContacts ?? [],
      custody_restrictions: custodyRestrictions ?? [],
    };

    return success(studentWithDetails);
  } catch (err) {
    const message = err instanceof Error ? err.message : 'Failed to get student';
    return failure(message, 'UNEXPECTED_ERROR');
  }
}

// ============================================================
// CREATE STUDENT
// ============================================================

export async function createStudent(
  input: CreateStudentInput
): Promise<ActionResponse<Student>> {
  try {
    const context = await getTenantContext();
    const supabase = await createSupabaseServerClient();

    // Validation
    if (!input.first_name?.trim()) {
      return failure('First name is required', 'VALIDATION_ERROR');
    }
    if (!input.last_name?.trim()) {
      return failure('Last name is required', 'VALIDATION_ERROR');
    }

    const { data, error } = await supabase
      .from('students')
      .insert({
        tenant_id: context.tenant.id,
        first_name: input.first_name.trim(),
        last_name: input.last_name.trim(),
        preferred_name: input.preferred_name?.trim() || null,
        dob: input.dob || null,
        gender: input.gender || null,
        photo_url: input.photo_url || null,
        enrollment_status: input.enrollment_status ?? 'active',
        notes: input.notes?.trim() || null,
      })
      .select()
      .single();

    if (error) {
      return failure(error.message, 'DB_ERROR');
    }

    // Audit log (via admin client to bypass RLS on audit_logs)
    const adminClient = createSupabaseAdminClient();

    await adminClient.from('audit_logs').insert({
      tenant_id: context.tenant.id,
      user_id: context.user.id,
      action: 'student.created',
      entity_type: 'student',
      entity_id: (data as Student).id,
      metadata: { first_name: input.first_name, last_name: input.last_name },
    });

    return success(data as Student);
  } catch (err) {
    const message = err instanceof Error ? err.message : 'Failed to create student';
    return failure(message, 'UNEXPECTED_ERROR');
  }
}

// ============================================================
// UPDATE STUDENT
// ============================================================

export async function updateStudent(
  studentId: string,
  input: UpdateStudentInput
): Promise<ActionResponse<Student>> {
  try {
    const supabase = await createSupabaseServerClient();

    // Build the update payload â€” only include fields that were provided
    const updateData: Record<string, unknown> = {};
    if (input.first_name !== undefined) updateData.first_name = input.first_name.trim();
    if (input.last_name !== undefined) updateData.last_name = input.last_name.trim();
    if (input.preferred_name !== undefined) updateData.preferred_name = input.preferred_name?.trim() || null;
    if (input.dob !== undefined) updateData.dob = input.dob || null;
    if (input.gender !== undefined) updateData.gender = input.gender || null;
    if (input.photo_url !== undefined) updateData.photo_url = input.photo_url || null;
    if (input.enrollment_status !== undefined) updateData.enrollment_status = input.enrollment_status;
    if (input.notes !== undefined) updateData.notes = input.notes?.trim() || null;

    if (Object.keys(updateData).length === 0) {
      return failure('No fields to update', 'VALIDATION_ERROR');
    }

    const { data, error } = await supabase
      .from('students')
      .update(updateData)
      .eq('id', studentId)
      .is('deleted_at', null)
      .select()
      .single();

    if (error) {
      return failure(error.message, 'DB_ERROR');
    }

    if (!data) {
      return failure('Student not found', 'NOT_FOUND');
    }

    return success(data as Student);
  } catch (err) {
    const message = err instanceof Error ? err.message : 'Failed to update student';
    return failure(message, 'UNEXPECTED_ERROR');
  }
}

// ============================================================
// SOFT DELETE STUDENT
// ============================================================
// Sets deleted_at instead of removing the row.
// Also soft-deletes related enrollments.

export async function deleteStudent(studentId: string): Promise<ActionResponse<{ id: string }>> {
  try {
    const supabase = await createSupabaseServerClient();

    // Soft delete the student
    const { error: studentError } = await supabase
      .from('students')
      .update({ deleted_at: new Date().toISOString() })
      .eq('id', studentId)
      .is('deleted_at', null);

    if (studentError) {
      return failure(studentError.message, 'DB_ERROR');
    }

    // Soft delete active enrollments
    await supabase
      .from('enrollments')
      .update({ deleted_at: new Date().toISOString(), status: 'withdrawn' })
      .eq('student_id', studentId)
      .eq('status', 'active')
      .is('deleted_at', null);

    return success({ id: studentId });
  } catch (err) {
    const message = err instanceof Error ? err.message : 'Failed to delete student';
    return failure(message, 'UNEXPECTED_ERROR');
  }
}


===== D:\.code\wattleos\src\lib\actions\time-entries.ts =====

// src/lib/actions/time-entries.ts
//
// ============================================================
// WattleOS V2 â€” Time Entry Server Actions
// ============================================================
// Manages daily time records for staff. One entry per person
// per day (Australian award structure).
//
// WHY separate from timesheets.ts: Time entries are the daily
// input workflow (guide logs hours). Timesheets are the
// aggregated output (submitted for approval).
// ============================================================

'use server';

import { createSupabaseServerClient } from '@/lib/supabase/server';
import { getTenantContext, requirePermission } from '@/lib/auth/tenant-context';
import { Permissions } from '@/lib/constants/permissions';
import type { ActionResponse } from '@/types/api';
import { success, failure } from '@/types/api';
import type { TimeEntry, TimeEntryType } from '@/types/domain';

// ============================================================
// Types
// ============================================================

interface LogTimeEntryInput {
  date: string;
  startTime: string;
  endTime: string;
  breakMinutes?: number;
  entryType?: TimeEntryType;
  classId?: string;
  notes?: string;
}

export interface TimeEntryWithMeta extends TimeEntry {
  class_name?: string | null;
}

// ============================================================
// LOG: Create or update a daily time entry (upsert)
// ============================================================

/**
 * Creates or updates a time entry for the current user on a given date.
 * Uses upsert on the (tenant_id, user_id, date) unique constraint.
 *
 * Validation:
 * - end_time must be after start_time
 * - break_minutes must be non-negative
 * - Cannot edit entries in a locked or processed pay period
 */
export async function logTimeEntry(
  input: LogTimeEntryInput
): Promise<ActionResponse<TimeEntry>> {
  try {
    const context = await requirePermission(Permissions.LOG_TIME);
    const supabase = await createSupabaseServerClient();

    // Validate times
    if (input.startTime >= input.endTime) {
      return failure('End time must be after start time', 'VALIDATION_ERROR');
    }

    const breakMinutes = input.breakMinutes ?? 30;
    if (breakMinutes < 0) {
      return failure('Break minutes cannot be negative', 'VALIDATION_ERROR');
    }

    // Check if the date falls in a locked/processed period
    const { data: lockedPeriod } = await supabase
      .from('pay_periods')
      .select('id, status')
      .lte('start_date', input.date)
      .gte('end_date', input.date)
      .in('status', ['locked', 'processed'])
      .is('deleted_at', null)
      .limit(1)
      .maybeSingle();

    if (lockedPeriod) {
      return failure(
        'Cannot edit time entries for a locked or processed pay period',
        'VALIDATION_ERROR'
      );
    }

    // Find the open pay period for this date (to link the entry)
    const { data: openPeriod } = await supabase
      .from('pay_periods')
      .select('id')
      .lte('start_date', input.date)
      .gte('end_date', input.date)
      .eq('status', 'open')
      .is('deleted_at', null)
      .limit(1)
      .maybeSingle();

    // Check if entry already exists (for upsert)
    const { data: existing } = await supabase
      .from('time_entries')
      .select('id')
      .eq('user_id', context.user.id)
      .eq('date', input.date)
      .is('deleted_at', null)
      .maybeSingle();

    const entryData = {
      tenant_id: context.tenant.id,
      user_id: context.user.id,
      pay_period_id: (openPeriod as { id: string } | null)?.id ?? null,
      date: input.date,
      start_time: input.startTime,
      end_time: input.endTime,
      break_minutes: breakMinutes,
      entry_type: input.entryType ?? 'regular',
      class_id: input.classId ?? null,
      notes: input.notes ?? null,
    };

    let data: unknown;
    let error: { message: string } | null;

    if (existing) {
      // Update existing entry
      const result = await supabase
        .from('time_entries')
        .update({
          start_time: entryData.start_time,
          end_time: entryData.end_time,
          break_minutes: entryData.break_minutes,
          entry_type: entryData.entry_type,
          class_id: entryData.class_id,
          notes: entryData.notes,
          pay_period_id: entryData.pay_period_id,
        })
        .eq('id', (existing as { id: string }).id)
        .select()
        .single();
      data = result.data;
      error = result.error;
    } else {
      // Insert new entry
      const result = await supabase
        .from('time_entries')
        .insert(entryData)
        .select()
        .single();
      data = result.data;
      error = result.error;
    }

    if (error) {
      return failure(error.message, 'DB_ERROR');
    }

    return success(data as TimeEntry);
  } catch (err) {
    const message = err instanceof Error ? err.message : 'Failed to log time entry';
    return failure(message, 'UNEXPECTED_ERROR');
  }
}

// ============================================================
// GET: My time entries for a pay period or date range
// ============================================================

export async function getMyTimeEntries(params?: {
  payPeriodId?: string;
  startDate?: string;
  endDate?: string;
}): Promise<ActionResponse<TimeEntryWithMeta[]>> {
  try {
    const context = await requirePermission(Permissions.LOG_TIME);
    const supabase = await createSupabaseServerClient();

    let query = supabase
      .from('time_entries')
      .select(`
        *,
        class:classes(name)
      `)
      .eq('user_id', context.user.id)
      .is('deleted_at', null)
      .order('date', { ascending: true });

    if (params?.payPeriodId) {
      query = query.eq('pay_period_id', params.payPeriodId);
    }

    if (params?.startDate) {
      query = query.gte('date', params.startDate);
    }

    if (params?.endDate) {
      query = query.lte('date', params.endDate);
    }

    const { data, error } = await query;

    if (error) {
      return failure(error.message, 'DB_ERROR');
    }

    // Flatten the class join
    const entries: TimeEntryWithMeta[] = ((data ?? []) as Array<Record<string, unknown>>).map(
      (row) => {
        const classData = row.class as { name: string } | null;
        return {
          id: row.id as string,
          tenant_id: row.tenant_id as string,
          user_id: row.user_id as string,
          pay_period_id: row.pay_period_id as string | null,
          date: row.date as string,
          start_time: row.start_time as string,
          end_time: row.end_time as string,
          break_minutes: row.break_minutes as number,
          total_hours: row.total_hours as number,
          entry_type: row.entry_type as TimeEntryType,
          class_id: row.class_id as string | null,
          notes: row.notes as string | null,
          class_name: classData?.name ?? null,
        };
      }
    );

    return success(entries);
  } catch (err) {
    const message = err instanceof Error ? err.message : 'Failed to get time entries';
    return failure(message, 'UNEXPECTED_ERROR');
  }
}

// ============================================================
// GET: All time entries for a user in a pay period (approver)
// ============================================================

export async function getTimeEntriesForUser(params: {
  userId: string;
  payPeriodId: string;
}): Promise<ActionResponse<TimeEntryWithMeta[]>> {
  try {
    await requirePermission(Permissions.APPROVE_TIMESHEETS);
    const supabase = await createSupabaseServerClient();

    const { data, error } = await supabase
      .from('time_entries')
      .select(`
        *,
        class:classes(name)
      `)
      .eq('user_id', params.userId)
      .eq('pay_period_id', params.payPeriodId)
      .is('deleted_at', null)
      .order('date', { ascending: true });

    if (error) {
      return failure(error.message, 'DB_ERROR');
    }

    const entries: TimeEntryWithMeta[] = ((data ?? []) as Array<Record<string, unknown>>).map(
      (row) => {
        const classData = row.class as { name: string } | null;
        return {
          id: row.id as string,
          tenant_id: row.tenant_id as string,
          user_id: row.user_id as string,
          pay_period_id: row.pay_period_id as string | null,
          date: row.date as string,
          start_time: row.start_time as string,
          end_time: row.end_time as string,
          break_minutes: row.break_minutes as number,
          total_hours: row.total_hours as number,
          entry_type: row.entry_type as TimeEntryType,
          class_id: row.class_id as string | null,
          notes: row.notes as string | null,
          class_name: classData?.name ?? null,
        };
      }
    );

    return success(entries);
  } catch (err) {
    const message = err instanceof Error ? err.message : 'Failed to get time entries';
    return failure(message, 'UNEXPECTED_ERROR');
  }
}

// ============================================================
// DELETE: Soft-delete a time entry (own entries only)
// ============================================================

export async function deleteTimeEntry(
  entryId: string
): Promise<ActionResponse<{ deleted: boolean }>> {
  try {
    const context = await requirePermission(Permissions.LOG_TIME);
    const supabase = await createSupabaseServerClient();

    // Verify ownership and that it's not in a locked period
    const { data: entry, error: fetchError } = await supabase
      .from('time_entries')
      .select('id, user_id, pay_period_id')
      .eq('id', entryId)
      .is('deleted_at', null)
      .single();

    if (fetchError || !entry) {
      return failure('Time entry not found', 'NOT_FOUND');
    }

    const typedEntry = entry as { id: string; user_id: string; pay_period_id: string | null };

    if (typedEntry.user_id !== context.user.id) {
      return failure('You can only delete your own time entries', 'FORBIDDEN');
    }

    // Check if linked to a locked period
    if (typedEntry.pay_period_id) {
      const { data: period } = await supabase
        .from('pay_periods')
        .select('status')
        .eq('id', typedEntry.pay_period_id)
        .single();

      if (period && (period as { status: string }).status !== 'open') {
        return failure('Cannot delete entries in a locked or processed pay period', 'VALIDATION_ERROR');
      }
    }

    const { error } = await supabase
      .from('time_entries')
      .update({ deleted_at: new Date().toISOString() })
      .eq('id', entryId);

    if (error) {
      return failure(error.message, 'DB_ERROR');
    }

    return success({ deleted: true });
  } catch (err) {
    const message = err instanceof Error ? err.message : 'Failed to delete time entry';
    return failure(message, 'UNEXPECTED_ERROR');
  }
}


===== D:\.code\wattleos\src\lib\actions\timesheets.ts =====

// src/lib/actions/timesheets.ts
//
// ============================================================
// WattleOS V2 â€” Timesheet Server Actions
// ============================================================
// Manages the timesheet lifecycle:
//   draft â†’ submitted â†’ approved â†’ synced
//                    â†˜ rejected â†’ (resubmit)
//
// A timesheet aggregates a staff member's time_entries for a
// pay period into one reviewable unit.
// ============================================================

'use server';

import { createSupabaseServerClient } from '@/lib/supabase/server';
import { getTenantContext, requirePermission } from '@/lib/auth/tenant-context';
import { Permissions } from '@/lib/constants/permissions';
import type { ActionResponse } from '@/types/api';
import { success, failure } from '@/types/api';
import type {
  Timesheet,
  TimesheetStatus,
  TimesheetWithEntries,
  TimeEntry,
  TimeEntryType,
} from '@/types/domain';
import { LEAVE_TYPES } from '@/lib/constants/timesheets';

// ============================================================
// Helper: User type from Supabase join
// ============================================================

interface JoinedUser {
  id: string;
  first_name: string;
  last_name: string;
  avatar_url: string | null;
}

// ============================================================
// SUBMIT: Aggregate entries â†’ create/update timesheet
// ============================================================

/**
 * Submits a timesheet for a pay period. Aggregates all time_entries
 * for the current user in that period, calculates hour totals,
 * and sets status to 'submitted'.
 *
 * If a draft timesheet already exists, it's updated.
 * If the timesheet was previously rejected, re-submitting resets
 * it to 'submitted'.
 */
export async function submitTimesheet(
  payPeriodId: string
): Promise<ActionResponse<Timesheet>> {
  try {
    const context = await requirePermission(Permissions.LOG_TIME);
    const supabase = await createSupabaseServerClient();

    // 1. Verify the pay period exists and is open
    const { data: period, error: periodError } = await supabase
      .from('pay_periods')
      .select('id, status')
      .eq('id', payPeriodId)
      .is('deleted_at', null)
      .single();

    if (periodError || !period) {
      return failure('Pay period not found', 'NOT_FOUND');
    }

    const typedPeriod = period as { id: string; status: string };

    // Allow submission if period is open (or locked â€” locked just prevents new entries)
    if (typedPeriod.status === 'processed') {
      return failure('This pay period has already been processed', 'VALIDATION_ERROR');
    }

    // 2. Fetch all time entries for this user + period
    const { data: entries, error: entriesError } = await supabase
      .from('time_entries')
      .select('*')
      .eq('user_id', context.user.id)
      .eq('pay_period_id', payPeriodId)
      .is('deleted_at', null);

    if (entriesError) {
      return failure(entriesError.message, 'DB_ERROR');
    }

    const typedEntries = (entries ?? []) as TimeEntry[];

    if (typedEntries.length === 0) {
      return failure('No time entries found for this pay period. Log your hours first.', 'VALIDATION_ERROR');
    }

    // 3. Calculate hour breakdowns
    let regularHours = 0;
    let overtimeHours = 0;
    let leaveHours = 0;

    for (const entry of typedEntries) {
      const hours = Number(entry.total_hours) || 0;
      if (entry.entry_type === 'overtime') {
        overtimeHours += hours;
      } else if (LEAVE_TYPES.includes(entry.entry_type as TimeEntryType)) {
        leaveHours += hours;
      } else {
        regularHours += hours;
      }
    }

    const totalHours = regularHours + overtimeHours + leaveHours;

    // 4. Upsert the timesheet
    const { data: existing } = await supabase
      .from('timesheets')
      .select('id, status')
      .eq('user_id', context.user.id)
      .eq('pay_period_id', payPeriodId)
      .is('deleted_at', null)
      .maybeSingle();

    const typedExisting = existing as { id: string; status: TimesheetStatus } | null;

    // Can only submit if draft or rejected
    if (typedExisting && typedExisting.status !== 'draft' && typedExisting.status !== 'rejected') {
      return failure(
        `Timesheet is already '${typedExisting.status}' and cannot be resubmitted`,
        'VALIDATION_ERROR'
      );
    }

    const timesheetData = {
      total_hours: Math.round(totalHours * 100) / 100,
      regular_hours: Math.round(regularHours * 100) / 100,
      overtime_hours: Math.round(overtimeHours * 100) / 100,
      leave_hours: Math.round(leaveHours * 100) / 100,
      status: 'submitted' as const,
      submitted_at: new Date().toISOString(),
      rejected_at: null,
      rejected_by: null,
      rejection_notes: null,
    };

    let data: unknown;
    let error: { message: string } | null;

    if (typedExisting) {
      const result = await supabase
        .from('timesheets')
        .update(timesheetData)
        .eq('id', typedExisting.id)
        .select()
        .single();
      data = result.data;
      error = result.error;
    } else {
      const result = await supabase
        .from('timesheets')
        .insert({
          tenant_id: context.tenant.id,
          user_id: context.user.id,
          pay_period_id: payPeriodId,
          ...timesheetData,
        })
        .select()
        .single();
      data = result.data;
      error = result.error;
    }

    if (error) {
      return failure(error.message, 'DB_ERROR');
    }

    return success(data as Timesheet);
  } catch (err) {
    const message = err instanceof Error ? err.message : 'Failed to submit timesheet';
    return failure(message, 'UNEXPECTED_ERROR');
  }
}

// ============================================================
// GET: My timesheets (staff view â€” own timesheets)
// ============================================================

export async function getMyTimesheets(): Promise<ActionResponse<Array<Timesheet & { pay_period_name: string }>>> {
  try {
    const context = await requirePermission(Permissions.LOG_TIME);
    const supabase = await createSupabaseServerClient();

    const { data, error } = await supabase
      .from('timesheets')
      .select(`
        *,
        pay_period:pay_periods(name)
      `)
      .eq('user_id', context.user.id)
      .is('deleted_at', null)
      .order('created_at', { ascending: false });

    if (error) {
      return failure(error.message, 'DB_ERROR');
    }

    const timesheets = ((data ?? []) as Array<Record<string, unknown>>).map((row) => {
      const pp = row.pay_period as { name: string } | null;
      return {
        ...(row as unknown as Timesheet),
        pay_period_name: pp?.name ?? 'Unknown Period',
      };
    });

    return success(timesheets);
  } catch (err) {
    const message = err instanceof Error ? err.message : 'Failed to get my timesheets';
    return failure(message, 'UNEXPECTED_ERROR');
  }
}

// ============================================================
// LIST: Pending timesheets (approver view)
// ============================================================

export async function listPendingTimesheets(params?: {
  payPeriodId?: string;
}): Promise<ActionResponse<Array<Timesheet & { user_name: string; pay_period_name: string }>>> {
  try {
    await requirePermission(Permissions.APPROVE_TIMESHEETS);
    const supabase = await createSupabaseServerClient();

    let query = supabase
      .from('timesheets')
      .select(`
        *,
        user:users!timesheets_user_id_fkey(id, first_name, last_name, avatar_url),
        pay_period:pay_periods(name)
      `)
      .eq('status', 'submitted')
      .is('deleted_at', null)
      .order('submitted_at', { ascending: true });

    if (params?.payPeriodId) {
      query = query.eq('pay_period_id', params.payPeriodId);
    }

    const { data, error } = await query;

    if (error) {
      return failure(error.message, 'DB_ERROR');
    }

    const timesheets = ((data ?? []) as Array<Record<string, unknown>>).map((row) => {
      const user = row.user as JoinedUser | null;
      const pp = row.pay_period as { name: string } | null;
      return {
        ...(row as unknown as Timesheet),
        user_name: user ? `${user.first_name} ${user.last_name}` : 'Unknown',
        pay_period_name: pp?.name ?? 'Unknown Period',
      };
    });

    return success(timesheets);
  } catch (err) {
    const message = err instanceof Error ? err.message : 'Failed to list pending timesheets';
    return failure(message, 'UNEXPECTED_ERROR');
  }
}

// ============================================================
// LIST: All timesheets for a pay period (admin/approver view)
// ============================================================

export async function listTimesheetsForPeriod(
  payPeriodId: string
): Promise<ActionResponse<Array<Timesheet & { user_name: string; avatar_url: string | null }>>> {
  try {
    await requirePermission(Permissions.APPROVE_TIMESHEETS);
    const supabase = await createSupabaseServerClient();

    const { data, error } = await supabase
      .from('timesheets')
      .select(`
        *,
        user:users!timesheets_user_id_fkey(id, first_name, last_name, avatar_url)
      `)
      .eq('pay_period_id', payPeriodId)
      .is('deleted_at', null)
      .order('submitted_at', { ascending: true });

    if (error) {
      return failure(error.message, 'DB_ERROR');
    }

    const timesheets = ((data ?? []) as Array<Record<string, unknown>>).map((row) => {
      const user = row.user as JoinedUser | null;
      return {
        ...(row as unknown as Timesheet),
        user_name: user ? `${user.first_name} ${user.last_name}` : 'Unknown',
        avatar_url: user?.avatar_url ?? null,
      };
    });

    return success(timesheets);
  } catch (err) {
    const message = err instanceof Error ? err.message : 'Failed to list timesheets for period';
    return failure(message, 'UNEXPECTED_ERROR');
  }
}

// ============================================================
// GET: Timesheet detail with all time entries
// ============================================================

export async function getTimesheetDetail(
  timesheetId: string
): Promise<ActionResponse<TimesheetWithEntries>> {
  try {
    // Allow both own timesheets and approver access
    const context = await getTenantContext();
    const supabase = await createSupabaseServerClient();

    const { data, error } = await supabase
      .from('timesheets')
      .select(`
        *,
        user:users!timesheets_user_id_fkey(id, first_name, last_name, avatar_url),
        pay_period:pay_periods(name, start_date, end_date)
      `)
      .eq('id', timesheetId)
      .is('deleted_at', null)
      .single();

    if (error || !data) {
      return failure('Timesheet not found', 'NOT_FOUND');
    }

    const row = data as Record<string, unknown>;
    const timesheetUserId = row.user_id as string;

    // Permission check: own timesheet OR approver
    const isOwn = timesheetUserId === context.user.id;
    const isApprover = context.permissions.includes(Permissions.APPROVE_TIMESHEETS);

    if (!isOwn && !isApprover) {
      return failure('You do not have permission to view this timesheet', 'FORBIDDEN');
    }

    // Fetch related time entries
    const { data: entries, error: entriesError } = await supabase
      .from('time_entries')
      .select(`
        *,
        class:classes(name)
      `)
      .eq('user_id', timesheetUserId)
      .eq('pay_period_id', row.pay_period_id as string)
      .is('deleted_at', null)
      .order('date', { ascending: true });

    if (entriesError) {
      return failure(entriesError.message, 'DB_ERROR');
    }

    const user = row.user as JoinedUser;

    const result: TimesheetWithEntries = {
      ...(row as unknown as Timesheet),
      user: {
        id: user.id,
        first_name: user.first_name,
        last_name: user.last_name,
        avatar_url: user.avatar_url,
      },
      time_entries: ((entries ?? []) as Array<Record<string, unknown>>).map((e) => ({
        id: e.id as string,
        tenant_id: e.tenant_id as string,
        user_id: e.user_id as string,
        pay_period_id: e.pay_period_id as string | null,
        date: e.date as string,
        start_time: e.start_time as string,
        end_time: e.end_time as string,
        break_minutes: e.break_minutes as number,
        total_hours: e.total_hours as number,
        entry_type: e.entry_type as TimeEntryType,
        class_id: e.class_id as string | null,
        notes: e.notes as string | null,
      })),
    };

    return success(result);
  } catch (err) {
    const message = err instanceof Error ? err.message : 'Failed to get timesheet detail';
    return failure(message, 'UNEXPECTED_ERROR');
  }
}

// ============================================================
// APPROVE: Mark timesheet as approved
// ============================================================

export async function approveTimesheet(
  timesheetId: string
): Promise<ActionResponse<Timesheet>> {
  try {
    const context = await requirePermission(Permissions.APPROVE_TIMESHEETS);
    const supabase = await createSupabaseServerClient();

    // Verify timesheet exists and is in submitted status
    const { data: existing, error: fetchError } = await supabase
      .from('timesheets')
      .select('id, status, user_id')
      .eq('id', timesheetId)
      .is('deleted_at', null)
      .single();

    if (fetchError || !existing) {
      return failure('Timesheet not found', 'NOT_FOUND');
    }

    const typedExisting = existing as { id: string; status: string; user_id: string };

    if (typedExisting.status !== 'submitted') {
      return failure(
        `Cannot approve a timesheet in '${typedExisting.status}' status. Must be 'submitted'.`,
        'VALIDATION_ERROR'
      );
    }

    // Cannot approve your own timesheet
    if (typedExisting.user_id === context.user.id) {
      return failure('You cannot approve your own timesheet', 'VALIDATION_ERROR');
    }

    const { data, error } = await supabase
      .from('timesheets')
      .update({
        status: 'approved',
        approved_at: new Date().toISOString(),
        approved_by: context.user.id,
      })
      .eq('id', timesheetId)
      .select()
      .single();

    if (error) {
      return failure(error.message, 'DB_ERROR');
    }

    return success(data as Timesheet);
  } catch (err) {
    const message = err instanceof Error ? err.message : 'Failed to approve timesheet';
    return failure(message, 'UNEXPECTED_ERROR');
  }
}

// ============================================================
// REJECT: Mark timesheet as rejected with notes
// ============================================================

export async function rejectTimesheet(
  timesheetId: string,
  notes: string
): Promise<ActionResponse<Timesheet>> {
  try {
    const context = await requirePermission(Permissions.APPROVE_TIMESHEETS);
    const supabase = await createSupabaseServerClient();

    if (!notes.trim()) {
      return failure('Rejection notes are required', 'VALIDATION_ERROR');
    }

    const { data: existing, error: fetchError } = await supabase
      .from('timesheets')
      .select('id, status, user_id')
      .eq('id', timesheetId)
      .is('deleted_at', null)
      .single();

    if (fetchError || !existing) {
      return failure('Timesheet not found', 'NOT_FOUND');
    }

    const typedExisting = existing as { id: string; status: string; user_id: string };

    if (typedExisting.status !== 'submitted') {
      return failure(
        `Cannot reject a timesheet in '${typedExisting.status}' status. Must be 'submitted'.`,
        'VALIDATION_ERROR'
      );
    }

    const { data, error } = await supabase
      .from('timesheets')
      .update({
        status: 'rejected',
        rejected_at: new Date().toISOString(),
        rejected_by: context.user.id,
        rejection_notes: notes.trim(),
      })
      .eq('id', timesheetId)
      .select()
      .single();

    if (error) {
      return failure(error.message, 'DB_ERROR');
    }

    return success(data as Timesheet);
  } catch (err) {
    const message = err instanceof Error ? err.message : 'Failed to reject timesheet';
    return failure(message, 'UNEXPECTED_ERROR');
  }
}

// ============================================================
// BATCH APPROVE: Approve multiple submitted timesheets
// ============================================================

export async function batchApproveTimesheets(
  timesheetIds: string[]
): Promise<ActionResponse<{ approved: number; failed: number; errors: string[] }>> {
  try {
    const context = await requirePermission(Permissions.APPROVE_TIMESHEETS);
    const supabase = await createSupabaseServerClient();

    let approved = 0;
    let failed = 0;
    const errors: string[] = [];

    for (const id of timesheetIds) {
      const { data: existing } = await supabase
        .from('timesheets')
        .select('id, status, user_id')
        .eq('id', id)
        .is('deleted_at', null)
        .single();

      const typed = existing as { id: string; status: string; user_id: string } | null;

      if (!typed) {
        errors.push(`Timesheet ${id}: not found`);
        failed++;
        continue;
      }

      if (typed.status !== 'submitted') {
        errors.push(`Timesheet ${id}: not in submitted status`);
        failed++;
        continue;
      }

      if (typed.user_id === context.user.id) {
        errors.push(`Timesheet ${id}: cannot approve own timesheet`);
        failed++;
        continue;
      }

      const { error } = await supabase
        .from('timesheets')
        .update({
          status: 'approved',
          approved_at: new Date().toISOString(),
          approved_by: context.user.id,
        })
        .eq('id', id);

      if (error) {
        errors.push(`Timesheet ${id}: ${error.message}`);
        failed++;
      } else {
        approved++;
      }
    }

    return success({ approved, failed, errors });
  } catch (err) {
    const message = err instanceof Error ? err.message : 'Failed to batch approve timesheets';
    return failure(message, 'UNEXPECTED_ERROR');
  }
}


===== D:\.code\wattleos\src\lib\auth\tenant-context.ts =====

// src/lib/auth/tenant-context.ts

import { cache } from 'react';
import { redirect } from 'next/navigation';
import { createSupabaseServerClient, createSupabaseAdminClient } from '@/lib/supabase/server';
import type { TenantContext, Tenant, User, Role } from '@/types/domain';
import type { PermissionKey } from '@/lib/constants/permissions';

// Helper type for the role_permissions select shape
type RolePermissionRow = {
  permission: { key: string } | { key: string }[] | null;
};

// ============================================================
// getTenantContext
// ============================================================
// Cached per-request. Returns the full tenant context including
// the resolved tenant, user, role, and permission keys.
// Redirects to /login if unauthenticated.
// Redirects to /tenant-picker if no tenant in JWT.
// ============================================================
export const getTenantContext = cache(async (): Promise<TenantContext> => {
  const supabase = await createSupabaseServerClient();

  // 1. Get authenticated user
  const {
    data: { user: authUser },
    error: authError,
  } = await supabase.auth.getUser();

  if (authError || !authUser) {
    redirect('/login');
  }

  // 2. Extract tenant_id from JWT app_metadata
  const tenantId = authUser.app_metadata?.tenant_id as string | undefined;
  if (!tenantId) {
    redirect('/tenant-picker');
  }

  // 3. Fetch tenant
  const { data: tenant, error: tenantError } = await supabase
    .from('tenants')
    .select('*')
    .eq('id', tenantId)
    .single();

  if (tenantError || !tenant) {
    redirect('/tenant-picker');
  }

  // 4. Fetch user profile
  const { data: user, error: userError } = await supabase
    .from('users')
    .select('*')
    .eq('id', authUser.id)
    .single();

  if (userError || !user) {
    redirect('/login');
  }

  // 5. Fetch tenant membership with role
  const { data: membership, error: membershipError } = await supabase
    .from('tenant_users')
    .select(
      `
      *,
      role:roles(*)
    `
    )
    .eq('tenant_id', tenantId)
    .eq('user_id', authUser.id)
    .is('deleted_at', null)
    .single();

  if (membershipError || !membership || !membership.role) {
    redirect('/tenant-picker');
  }

  // 6. Fetch permission keys for this role
  const { data: rolePermissions, error: permsError } = await supabase
    .from('role_permissions')
    .select(
      `
      permission:permissions(key)
    `
    )
    .eq('tenant_id', tenantId)
    .eq('role_id', membership.role_id);

  if (permsError) {
    // Safer to treat as no permissions than crash context resolution.
    // You can swap this to redirect('/login') if you prefer hard-fail.
    console.error('Failed to load role permissions:', permsError.message);
  }

  const permissions = ((rolePermissions ?? []) as unknown as RolePermissionRow[])
    .map((rp) => {
      const perm = rp.permission;
      if (!perm) return null;

      // Supabase sometimes returns a 1-item array for nested selects
      if (Array.isArray(perm)) return perm[0]?.key ?? null;

      return perm.key ?? null;
    })
    .filter((key): key is string => !!key);

  return {
    tenant: tenant as Tenant,
    user: user as User,
    role: membership.role as Role,
    permissions,
  };
});

// ============================================================
// requirePermission
// ============================================================
// Guard for Server Actions. Throws if the user lacks the
// required permission. Returns the context if authorized.
// ============================================================
export async function requirePermission(permission: PermissionKey): Promise<TenantContext> {
  const context = await getTenantContext();

  if (!context.permissions.includes(permission)) {
    throw new Error(`Forbidden: missing permission '${permission}'`);
  }

  return context;
}

// ============================================================
// hasPermission (server component-safe check)
// ============================================================
export function hasPermission(context: TenantContext, permission: PermissionKey): boolean {
  return context.permissions.includes(permission);
}

// ============================================================
// resolveTenantBySlug
// ============================================================
// Used by middleware to look up a tenant from the URL slug.
// Uses admin client (service role) because this runs before
// the user has a JWT with tenant_id.
// ============================================================
export async function resolveTenantBySlug(slug: string): Promise<Tenant | null> {
  const adminClient = createSupabaseAdminClient();

  const { data, error } = await adminClient
    .from('tenants')
    .select('*')
    .eq('slug', slug)
    .eq('is_active', true)
    .single();

  if (error || !data) return null;

  return data as Tenant;
}

// ============================================================
// getUserTenants
// ============================================================
export async function getUserTenants(
  userId: string
): Promise<
  Array<{
    tenant: Tenant;
    role: Role;
    status: string;
  }>
> {
  const adminClient = createSupabaseAdminClient();

  const { data, error } = await adminClient
    .from('tenant_users')
    .select(
      `
      status,
      tenant:tenants(*),
      role:roles(*)
    `
    )
    .eq('user_id', userId)
    .is('deleted_at', null)
    .eq('status', 'active');

  if (error || !data) return [];

  return data
    .filter((row) => row.tenant && row.role)
    .map((row) => ({
      tenant: row.tenant as unknown as Tenant,
      role: row.role as unknown as Role,
      status: row.status as string,
    }));
}

// ============================================================
// setUserTenant
// ============================================================
export async function setUserTenant(userId: string, tenantId: string): Promise<void> {
  const adminClient = createSupabaseAdminClient();

  await adminClient.auth.admin.updateUserById(userId, {
    app_metadata: { tenant_id: tenantId },
  });
}



===== D:\.code\wattleos\src\lib\constants\attendance.ts =====

// src/lib/constants/attendance.ts
//
// ============================================================
// WattleOS V2 â€” Attendance Constants
// ============================================================
// Status options, labels, and color coding for attendance UI.
// Must stay in sync with the CHECK constraint on
// attendance_records.status column.
// ============================================================

export const ATTENDANCE_STATUSES = [
  { value: 'present', label: 'Present' },
  { value: 'absent', label: 'Absent' },
  { value: 'late', label: 'Late' },
  { value: 'excused', label: 'Excused' },
  { value: 'half_day', label: 'Half Day' },
] as const;

export type AttendanceStatusValue = (typeof ATTENDANCE_STATUSES)[number]['value'];

/**
 * Color config for attendance status badges and roll call buttons.
 * Uses Tailwind classes compatible with the WattleOS design system.
 */
export const ATTENDANCE_STATUS_CONFIG: Record<
  AttendanceStatusValue,
  {
    label: string;
    badgeBg: string;
    badgeText: string;
    buttonBg: string;
    buttonHover: string;
    icon: string;
  }
> = {
  present: {
    label: 'Present',
    badgeBg: 'bg-green-100',
    badgeText: 'text-green-700',
    buttonBg: 'bg-green-600',
    buttonHover: 'hover:bg-green-700',
    icon: 'âœ“',
  },
  absent: {
    label: 'Absent',
    badgeBg: 'bg-red-100',
    badgeText: 'text-red-700',
    buttonBg: 'bg-red-600',
    buttonHover: 'hover:bg-red-700',
    icon: 'âœ—',
  },
  late: {
    label: 'Late',
    badgeBg: 'bg-amber-100',
    badgeText: 'text-amber-700',
    buttonBg: 'bg-amber-600',
    buttonHover: 'hover:bg-amber-700',
    icon: 'â°',
  },
  excused: {
    label: 'Excused',
    badgeBg: 'bg-blue-100',
    badgeText: 'text-blue-700',
    buttonBg: 'bg-blue-600',
    buttonHover: 'hover:bg-blue-700',
    icon: 'ðŸ“',
  },
  half_day: {
    label: 'Half Day',
    badgeBg: 'bg-purple-100',
    badgeText: 'text-purple-700',
    buttonBg: 'bg-purple-600',
    buttonHover: 'hover:bg-purple-700',
    icon: 'Â½',
  },
};


===== D:\.code\wattleos\src\lib\constants\billing.ts =====

// src/lib/constants/billing.ts
//
// ============================================================
// WattleOS V2 â€” Billing Constants
// ============================================================

export type InvoiceStatus =
  | 'draft'
  | 'pending'
  | 'sent'
  | 'paid'
  | 'partially_paid'
  | 'overdue'
  | 'void'
  | 'refunded';

export type PaymentStatus =
  | 'succeeded'
  | 'failed'
  | 'pending'
  | 'refunded'
  | 'partially_refunded';

export type FeeFrequency =
  | 'weekly'
  | 'fortnightly'
  | 'monthly'
  | 'termly'
  | 'annually'
  | 'one_off';

export const INVOICE_STATUS_CONFIG: Record<
  InvoiceStatus,
  { label: string; bgColor: string; color: string }
> = {
  draft: { label: 'Draft', bgColor: 'bg-gray-100', color: 'text-gray-700' },
  pending: { label: 'Pending', bgColor: 'bg-yellow-100', color: 'text-yellow-700' },
  sent: { label: 'Sent', bgColor: 'bg-blue-100', color: 'text-blue-700' },
  paid: { label: 'Paid', bgColor: 'bg-green-100', color: 'text-green-700' },
  partially_paid: { label: 'Partial', bgColor: 'bg-amber-100', color: 'text-amber-700' },
  overdue: { label: 'Overdue', bgColor: 'bg-red-100', color: 'text-red-700' },
  void: { label: 'Void', bgColor: 'bg-gray-100', color: 'text-gray-500' },
  refunded: { label: 'Refunded', bgColor: 'bg-purple-100', color: 'text-purple-700' },
};

export const PAYMENT_STATUS_CONFIG: Record<
  PaymentStatus,
  { label: string; bgColor: string; color: string }
> = {
  succeeded: { label: 'Paid', bgColor: 'bg-green-100', color: 'text-green-700' },
  failed: { label: 'Failed', bgColor: 'bg-red-100', color: 'text-red-700' },
  pending: { label: 'Pending', bgColor: 'bg-yellow-100', color: 'text-yellow-700' },
  refunded: { label: 'Refunded', bgColor: 'bg-purple-100', color: 'text-purple-700' },
  partially_refunded: { label: 'Partial Refund', bgColor: 'bg-purple-50', color: 'text-purple-600' },
};

export const FEE_FREQUENCY_CONFIG: Record<
  FeeFrequency,
  { label: string; shortLabel: string }
> = {
  weekly: { label: 'Weekly', shortLabel: '/wk' },
  fortnightly: { label: 'Fortnightly', shortLabel: '/2wk' },
  monthly: { label: 'Monthly', shortLabel: '/mo' },
  termly: { label: 'Per Term', shortLabel: '/term' },
  annually: { label: 'Annually', shortLabel: '/yr' },
  one_off: { label: 'One-off', shortLabel: '' },
};

/** Format cents to dollars string (e.g., 15000 â†’ "$150.00") */
export function formatCurrency(cents: number, currency: string = 'aud'): string {
  const dollars = cents / 100;
  return new Intl.NumberFormat('en-AU', {
    style: 'currency',
    currency: currency.toUpperCase(),
    minimumFractionDigits: 2,
  }).format(dollars);
}


===== D:\.code\wattleos\src\lib\constants\communications.ts =====

// src/lib/constants/communications.ts
//
// ============================================================
// WattleOS V2 â€” Communications Constants
// ============================================================
// Labels, options, and color config for announcements and
// messaging. Used by forms (select options) and display
// components (badges, indicators).
// ============================================================

// ============================================================
// Announcement Priority
// ============================================================

export const ANNOUNCEMENT_PRIORITIES = [
  { value: 'normal', label: 'Normal' },
  { value: 'urgent', label: 'Urgent' },
] as const;

export type AnnouncementPriority = 'normal' | 'urgent';

export const ANNOUNCEMENT_PRIORITY_CONFIG: Record<
  AnnouncementPriority,
  { label: string; color: string; bgColor: string; icon: string }
> = {
  normal: {
    label: 'Normal',
    color: 'text-gray-700',
    bgColor: 'bg-gray-100',
    icon: 'ðŸ“¢',
  },
  urgent: {
    label: 'Urgent',
    color: 'text-red-700',
    bgColor: 'bg-red-100',
    icon: 'ðŸš¨',
  },
};

// ============================================================
// Announcement Target Type
// ============================================================

export const ANNOUNCEMENT_TARGETS = [
  { value: 'school_wide', label: 'Entire School' },
  { value: 'class', label: 'Specific Class' },
] as const;

export type AnnouncementTargetType = 'school_wide' | 'class';

// ============================================================
// Message Thread Type
// ============================================================

export const MESSAGE_THREAD_TYPES = [
  { value: 'class_broadcast', label: 'Class Message' },
  { value: 'direct', label: 'Direct Message' },
] as const;

export type MessageThreadType = 'class_broadcast' | 'direct';

export const THREAD_TYPE_CONFIG: Record<
  MessageThreadType,
  { label: string; color: string; bgColor: string; icon: string }
> = {
  class_broadcast: {
    label: 'Class Message',
    color: 'text-blue-700',
    bgColor: 'bg-blue-100',
    icon: 'ðŸ‘¥',
  },
  direct: {
    label: 'Direct Message',
    color: 'text-emerald-700',
    bgColor: 'bg-emerald-100',
    icon: 'ðŸ’¬',
  },
};


===== D:\.code\wattleos\src\lib\constants\index.ts =====

// ============================================================
// WattleOS V2 â€” Constants
// ============================================================
// Single source of truth for permission keys and status values.
// These must stay in sync with the database seed and CHECK constraints.
// ============================================================

// ============================================================
// Permission Keys
// ============================================================

export const PERMISSIONS = {
  // Admin
  MANAGE_TENANT_SETTINGS: 'manage_tenant_settings',
  MANAGE_USERS: 'manage_users',
  VIEW_AUDIT_LOGS: 'view_audit_logs',
  MANAGE_INTEGRATIONS: 'manage_integrations',

  // Pedagogy
  CREATE_OBSERVATION: 'create_observation',
  PUBLISH_OBSERVATION: 'publish_observation',
  VIEW_ALL_OBSERVATIONS: 'view_all_observations',
  MANAGE_CURRICULUM: 'manage_curriculum',
  MANAGE_MASTERY: 'manage_mastery',
  MANAGE_REPORTS: 'manage_reports',

  // SIS
  VIEW_STUDENTS: 'view_students',
  MANAGE_STUDENTS: 'manage_students',
  VIEW_MEDICAL_RECORDS: 'view_medical_records',
  MANAGE_MEDICAL_RECORDS: 'manage_medical_records',
  MANAGE_SAFETY_RECORDS: 'manage_safety_records',
  MANAGE_ENROLLMENT: 'manage_enrollment',

  // Attendance
  MANAGE_ATTENDANCE: 'manage_attendance',
  VIEW_ATTENDANCE_REPORTS: 'view_attendance_reports',

  // Communications
  SEND_ANNOUNCEMENTS: 'send_announcements',
  SEND_CLASS_MESSAGES: 'send_class_messages',

  // Timesheets (Phase 9)
  LOG_TIME: 'log_time',
  APPROVE_TIMESHEETS: 'approve_timesheets',
  VIEW_ALL_TIMESHEETS: 'view_all_timesheets',
} as const;

export type PermissionKey = (typeof PERMISSIONS)[keyof typeof PERMISSIONS];

// ============================================================
// Enrollment Status Options (for UI selects/filters)
// ============================================================

export const ENROLLMENT_STATUSES = [
  { value: 'inquiry', label: 'Inquiry' },
  { value: 'applicant', label: 'Applicant' },
  { value: 'active', label: 'Active' },
  { value: 'withdrawn', label: 'Withdrawn' },
  { value: 'graduated', label: 'Graduated' },
] as const;

export const ENROLLMENT_RECORD_STATUSES = [
  { value: 'active', label: 'Active' },
  { value: 'completed', label: 'Completed' },
  { value: 'withdrawn', label: 'Withdrawn' },
] as const;

// ============================================================
// Medical Severity Options
// ============================================================

export const MEDICAL_SEVERITIES = [
  { value: 'mild', label: 'Mild' },
  { value: 'moderate', label: 'Moderate' },
  { value: 'severe', label: 'Severe' },
  { value: 'life_threatening', label: 'Life Threatening' },
] as const;

export const MEDICAL_CONDITION_TYPES = [
  { value: 'allergy', label: 'Allergy' },
  { value: 'asthma', label: 'Asthma' },
  { value: 'epilepsy', label: 'Epilepsy' },
  { value: 'diabetes', label: 'Diabetes' },
  { value: 'other', label: 'Other' },
] as const;

// ============================================================
// Custody Restriction Types
// ============================================================

export const RESTRICTION_TYPES = [
  { value: 'no_contact', label: 'No Contact' },
  { value: 'no_pickup', label: 'No Pickup' },
  { value: 'supervised_only', label: 'Supervised Only' },
  { value: 'no_information', label: 'No Information Access' },
] as const;

// ============================================================
// Guardian Relationships
// ============================================================

export const GUARDIAN_RELATIONSHIPS = [
  { value: 'mother', label: 'Mother' },
  { value: 'father', label: 'Father' },
  { value: 'stepmother', label: 'Stepmother' },
  { value: 'stepfather', label: 'Stepfather' },
  { value: 'grandmother', label: 'Grandmother' },
  { value: 'grandfather', label: 'Grandfather' },
  { value: 'aunt', label: 'Aunt' },
  { value: 'uncle', label: 'Uncle' },
  { value: 'foster_parent', label: 'Foster Parent' },
  { value: 'legal_guardian', label: 'Legal Guardian' },
  { value: 'other', label: 'Other' },
] as const;

// ============================================================
// Pagination Defaults
// ============================================================

export const DEFAULT_PAGE_SIZE = 20;
export const MAX_PAGE_SIZE = 100;

export { ATTENDANCE_STATUSES, ATTENDANCE_STATUS_CONFIG } from './attendance';
export type { AttendanceStatusValue } from './attendance';

export {
  TIME_ENTRY_TYPE_CONFIG,
  TIME_ENTRY_TYPES,
  LEAVE_TYPES,
  TIMESHEET_STATUS_CONFIG,
  PAY_PERIOD_STATUS_CONFIG,
  PAY_FREQUENCY_OPTIONS,
  DAY_LABELS,
  DEFAULT_WORK_HOURS,
} from './timesheets';
export type { EntryTypeConfig, TimesheetStatusConfig } from './timesheets';


===== D:\.code\wattleos\src\lib\constants\integrations.ts =====

// src/lib/constants/integrations.ts
//
// ============================================================
// WattleOS V2 â€” Integration Constants
// ============================================================
// Provider definitions for the integrations admin UI.
// Each provider declares its required credential fields
// and settings so the config form can be generated dynamically.
// ============================================================

export type IntegrationProvider =
  | 'google_drive'
  | 'google_docs'
  | 'stripe'
  | 'xero'
  | 'keypay';

export interface CredentialField {
  key: string;
  label: string;
  type: 'text' | 'textarea' | 'password';
  placeholder: string;
  required: boolean;
  helpText?: string;
}

export interface SettingField {
  key: string;
  label: string;
  type: 'text' | 'boolean';
  defaultValue: string | boolean;
  helpText?: string;
}

export interface ProviderDefinition {
  key: IntegrationProvider;
  label: string;
  description: string;
  icon: string;
  bgColor: string;
  color: string;
  credentialFields: CredentialField[];
  settingFields: SettingField[];
  /** Whether this integration is fully implemented */
  implemented: boolean;
}

export const INTEGRATION_PROVIDERS: Record<IntegrationProvider, ProviderDefinition> = {
  google_drive: {
    key: 'google_drive',
    label: 'Google Drive',
    description: 'Portfolio folder provisioning and media storage for student observations.',
    icon: 'ðŸ“',
    bgColor: 'bg-blue-50',
    color: 'text-blue-700',
    implemented: true,
    credentialFields: [
      {
        key: 'service_account_email',
        label: 'Service Account Email',
        type: 'text',
        placeholder: 'wattleos@project.iam.gserviceaccount.com',
        required: true,
        helpText: 'The email address of your Google Cloud service account.',
      },
      {
        key: 'private_key',
        label: 'Private Key',
        type: 'textarea',
        placeholder: '-----BEGIN PRIVATE KEY-----\n...\n-----END PRIVATE KEY-----',
        required: true,
        helpText: 'The private key from your service account JSON file. Keep this secret.',
      },
      {
        key: 'root_folder_id',
        label: 'Root Portfolio Folder ID',
        type: 'text',
        placeholder: '1BxiMVs0XRA5nFMdKvBdBZjgmUUqptlbs74OgVE2wtIs',
        required: true,
        helpText: 'The Google Drive folder ID where all student portfolios will be created. Share this folder with the service account email.',
      },
    ],
    settingFields: [
      {
        key: 'auto_share_with_parents',
        label: 'Auto-share folders with parents',
        type: 'boolean',
        defaultValue: true,
        helpText: 'Automatically grant parents read access to their child\'s portfolio folder.',
      },
      {
        key: 'folder_name_template',
        label: 'Folder name template',
        type: 'text',
        defaultValue: '{student_name}',
        helpText: 'How to name student portfolio folders. Supports: {student_name}, {year}.',
      },
    ],
  },

  google_docs: {
    key: 'google_docs',
    label: 'Google Docs',
    description: 'Export student reports as Google Docs for editing and sharing.',
    icon: 'ðŸ“„',
    bgColor: 'bg-blue-50',
    color: 'text-blue-700',
    implemented: false,
    credentialFields: [
      {
        key: 'service_account_email',
        label: 'Service Account Email',
        type: 'text',
        placeholder: 'wattleos@project.iam.gserviceaccount.com',
        required: true,
      },
      {
        key: 'private_key',
        label: 'Private Key',
        type: 'textarea',
        placeholder: '-----BEGIN PRIVATE KEY-----\n...',
        required: true,
      },
      {
        key: 'template_folder_id',
        label: 'Report Template Folder ID',
        type: 'text',
        placeholder: 'Google Drive folder ID',
        required: true,
        helpText: 'Folder containing Google Docs report templates.',
      },
    ],
    settingFields: [],
  },

  stripe: {
    key: 'stripe',
    label: 'Stripe',
    description: 'Tuition invoicing, parent auto-pay, and payment reconciliation.',
    icon: 'ðŸ’³',
    bgColor: 'bg-purple-50',
    color: 'text-purple-700',
    // WHY implemented: true â€” Full Stripe client exists at
    // lib/integrations/stripe/client.ts (create invoice, finalize,
    // send, refund, webhook verification). Billing server actions
    // handle sync-to-Stripe flow. Webhook route handles invoice.paid,
    // invoice.payment_failed, and charge.refunded events.
    implemented: true,
    credentialFields: [
      {
        key: 'secret_key',
        label: 'Secret Key',
        type: 'password',
        placeholder: 'sk_live_...',
        required: true,
        helpText: 'Your Stripe secret API key. Use test keys for development.',
      },
      {
        key: 'publishable_key',
        label: 'Publishable Key',
        type: 'text',
        placeholder: 'pk_live_...',
        required: true,
        helpText: 'Your Stripe publishable key for client-side checkout.',
      },
      {
        key: 'webhook_secret',
        label: 'Webhook Signing Secret',
        type: 'password',
        placeholder: 'whsec_...',
        required: true,
        helpText: 'Used to verify webhook payloads. Found in Stripe Dashboard â†’ Webhooks.',
      },
    ],
    settingFields: [
      {
        key: 'auto_charge',
        label: 'Auto-charge on invoice due date',
        type: 'boolean',
        defaultValue: true,
        helpText: 'Automatically charge the parent\'s saved payment method when an invoice is due.',
      },
      {
        key: 'currency',
        label: 'Currency',
        type: 'text',
        defaultValue: 'aud',
        helpText: 'Three-letter ISO currency code (e.g., aud, usd, gbp).',
      },
    ],
  },

  xero: {
    key: 'xero',
    label: 'Xero',
    description: 'Push approved timesheets to Xero for payroll processing.',
    icon: 'ðŸ“Š',
    bgColor: 'bg-cyan-50',
    color: 'text-cyan-700',
    implemented: false,
    credentialFields: [
      {
        key: 'client_id',
        label: 'Client ID',
        type: 'text',
        placeholder: 'Your Xero app client ID',
        required: true,
      },
      {
        key: 'client_secret',
        label: 'Client Secret',
        type: 'password',
        placeholder: 'Your Xero app client secret',
        required: true,
      },
      {
        key: 'tenant_id',
        label: 'Xero Tenant ID',
        type: 'text',
        placeholder: 'Your Xero organization ID',
        required: true,
        helpText: 'Found in your Xero connected apps settings.',
      },
    ],
    settingFields: [],
  },

  keypay: {
    key: 'keypay',
    label: 'KeyPay',
    description: 'Australian payroll integration for timesheet and leave management.',
    icon: 'ðŸ”‘',
    bgColor: 'bg-green-50',
    color: 'text-green-700',
    implemented: false,
    credentialFields: [
      {
        key: 'api_key',
        label: 'API Key',
        type: 'password',
        placeholder: 'Your KeyPay API key',
        required: true,
      },
      {
        key: 'business_id',
        label: 'Business ID',
        type: 'text',
        placeholder: 'Your KeyPay business ID',
        required: true,
      },
    ],
    settingFields: [],
  },
};

export const INTEGRATION_PROVIDER_LIST = Object.values(INTEGRATION_PROVIDERS);

export const SYNC_STATUS_CONFIG = {
  success: { label: 'Success', bgColor: 'bg-green-100', color: 'text-green-700' },
  failure: { label: 'Failed', bgColor: 'bg-red-100', color: 'text-red-700' },
  pending: { label: 'Pending', bgColor: 'bg-yellow-100', color: 'text-yellow-700' },
} as const;


===== D:\.code\wattleos\src\lib\constants\permissions.ts =====

// ============================================================
// WattleOS V2 â€” Permission Constants
// ============================================================
// Mirrors permissions seeded in the database.
// Used for client-side permission checks and type-safe
// references throughout the application.
// MODIFIED IN PHASE 9b: Added timesheet permissions.
// ============================================================

export const Permissions = {
  // Admin
  MANAGE_TENANT_SETTINGS: 'manage_tenant_settings',
  MANAGE_USERS: 'manage_users',
  VIEW_AUDIT_LOGS: 'view_audit_logs',
  MANAGE_INTEGRATIONS: 'manage_integrations',

  // Pedagogy
  CREATE_OBSERVATION: 'create_observation',
  PUBLISH_OBSERVATION: 'publish_observation',
  VIEW_ALL_OBSERVATIONS: 'view_all_observations',
  MANAGE_CURRICULUM: 'manage_curriculum',
  MANAGE_MASTERY: 'manage_mastery',
  MANAGE_REPORTS: 'manage_reports',

  // SIS
  VIEW_STUDENTS: 'view_students',
  MANAGE_STUDENTS: 'manage_students',
  VIEW_MEDICAL_RECORDS: 'view_medical_records',
  MANAGE_MEDICAL_RECORDS: 'manage_medical_records',
  MANAGE_SAFETY_RECORDS: 'manage_safety_records',
  MANAGE_ENROLLMENT: 'manage_enrollment',

  // Attendance
  MANAGE_ATTENDANCE: 'manage_attendance',
  VIEW_ATTENDANCE_REPORTS: 'view_attendance_reports',

  // Communications
  SEND_ANNOUNCEMENTS: 'send_announcements',
  SEND_CLASS_MESSAGES: 'send_class_messages',

  // Timesheets (Phase 9)
  // WHY: Three-tier access â€” all staff log, heads approve, admins see everything.
  LOG_TIME: 'log_time',
  APPROVE_TIMESHEETS: 'approve_timesheets',
  VIEW_ALL_TIMESHEETS: 'view_all_timesheets',
} as const;

export type PermissionKey = (typeof Permissions)[keyof typeof Permissions];

// Module groupings for the admin permissions UI
export const PermissionModules = {
  admin: {
    label: 'Administration',
    permissions: [
      Permissions.MANAGE_TENANT_SETTINGS,
      Permissions.MANAGE_USERS,
      Permissions.VIEW_AUDIT_LOGS,
      Permissions.MANAGE_INTEGRATIONS,
    ],
  },
  pedagogy: {
    label: 'Pedagogy',
    permissions: [
      Permissions.CREATE_OBSERVATION,
      Permissions.PUBLISH_OBSERVATION,
      Permissions.VIEW_ALL_OBSERVATIONS,
      Permissions.MANAGE_CURRICULUM,
      Permissions.MANAGE_MASTERY,
      Permissions.MANAGE_REPORTS,
    ],
  },
  sis: {
    label: 'Student Information',
    permissions: [
      Permissions.VIEW_STUDENTS,
      Permissions.MANAGE_STUDENTS,
      Permissions.VIEW_MEDICAL_RECORDS,
      Permissions.MANAGE_MEDICAL_RECORDS,
      Permissions.MANAGE_SAFETY_RECORDS,
      Permissions.MANAGE_ENROLLMENT,
    ],
  },
  attendance: {
    label: 'Attendance',
    permissions: [
      Permissions.MANAGE_ATTENDANCE,
      Permissions.VIEW_ATTENDANCE_REPORTS,
    ],
  },
  comms: {
    label: 'Communications',
    permissions: [
      Permissions.SEND_ANNOUNCEMENTS,
      Permissions.SEND_CLASS_MESSAGES,
    ],
  },
  timesheets: {
    label: 'Timesheets & Payroll',
    permissions: [
      Permissions.LOG_TIME,
      Permissions.APPROVE_TIMESHEETS,
      Permissions.VIEW_ALL_TIMESHEETS,
    ],
  },
} as const;


===== D:\.code\wattleos\src\lib\constants\timesheets.ts =====

// src/lib/constants/timesheets.ts
//
// ============================================================
// WattleOS V2 â€” Timesheet Constants
// ============================================================
// Status labels, entry type options, and color config for the
// timesheet module. Used by both staff and admin UI.
// ============================================================

import type {
  TimeEntryType,
  TimesheetStatus,
  PayPeriodStatus,
  PayFrequency,
} from '@/types/domain';

// ============================================================
// Time Entry Types
// ============================================================

export interface EntryTypeConfig {
  label: string;
  shortLabel: string;
  color: string;
  bgColor: string;
  icon: string;
}

export const TIME_ENTRY_TYPE_CONFIG: Record<TimeEntryType, EntryTypeConfig> = {
  regular: {
    label: 'Regular',
    shortLabel: 'Reg',
    color: 'text-gray-700',
    bgColor: 'bg-gray-100',
    icon: 'â°',
  },
  overtime: {
    label: 'Overtime',
    shortLabel: 'OT',
    color: 'text-amber-700',
    bgColor: 'bg-amber-100',
    icon: 'âš¡',
  },
  public_holiday: {
    label: 'Public Holiday',
    shortLabel: 'PH',
    color: 'text-purple-700',
    bgColor: 'bg-purple-100',
    icon: 'ðŸŽ‰',
  },
  sick_leave: {
    label: 'Sick Leave',
    shortLabel: 'Sick',
    color: 'text-red-700',
    bgColor: 'bg-red-100',
    icon: 'ðŸ¤’',
  },
  annual_leave: {
    label: 'Annual Leave',
    shortLabel: 'AL',
    color: 'text-blue-700',
    bgColor: 'bg-blue-100',
    icon: 'ðŸŒ´',
  },
  unpaid_leave: {
    label: 'Unpaid Leave',
    shortLabel: 'UL',
    color: 'text-gray-500',
    bgColor: 'bg-gray-50',
    icon: 'ðŸ“‹',
  },
};

export const TIME_ENTRY_TYPES: TimeEntryType[] = [
  'regular',
  'overtime',
  'public_holiday',
  'sick_leave',
  'annual_leave',
  'unpaid_leave',
];

export const LEAVE_TYPES: TimeEntryType[] = [
  'sick_leave',
  'annual_leave',
  'unpaid_leave',
  'public_holiday',
];

// ============================================================
// Timesheet Statuses
// ============================================================

export interface TimesheetStatusConfig {
  label: string;
  color: string;
  bgColor: string;
  dotColor: string;
}

export const TIMESHEET_STATUS_CONFIG: Record<TimesheetStatus, TimesheetStatusConfig> = {
  draft: {
    label: 'Draft',
    color: 'text-gray-700',
    bgColor: 'bg-gray-100',
    dotColor: 'bg-gray-400',
  },
  submitted: {
    label: 'Submitted',
    color: 'text-blue-700',
    bgColor: 'bg-blue-100',
    dotColor: 'bg-blue-500',
  },
  approved: {
    label: 'Approved',
    color: 'text-green-700',
    bgColor: 'bg-green-100',
    dotColor: 'bg-green-500',
  },
  rejected: {
    label: 'Rejected',
    color: 'text-red-700',
    bgColor: 'bg-red-100',
    dotColor: 'bg-red-500',
  },
  synced: {
    label: 'Synced',
    color: 'text-emerald-700',
    bgColor: 'bg-emerald-100',
    dotColor: 'bg-emerald-500',
  },
};

// ============================================================
// Pay Period Statuses
// ============================================================

export const PAY_PERIOD_STATUS_CONFIG: Record<PayPeriodStatus, TimesheetStatusConfig> = {
  open: {
    label: 'Open',
    color: 'text-green-700',
    bgColor: 'bg-green-100',
    dotColor: 'bg-green-500',
  },
  locked: {
    label: 'Locked',
    color: 'text-amber-700',
    bgColor: 'bg-amber-100',
    dotColor: 'bg-amber-500',
  },
  processed: {
    label: 'Processed',
    color: 'text-gray-700',
    bgColor: 'bg-gray-100',
    dotColor: 'bg-gray-500',
  },
};

// ============================================================
// Pay Frequency Options
// ============================================================

export const PAY_FREQUENCY_OPTIONS: Array<{ value: PayFrequency; label: string }> = [
  { value: 'weekly', label: 'Weekly' },
  { value: 'fortnightly', label: 'Fortnightly' },
  { value: 'monthly', label: 'Monthly' },
];

// ============================================================
// Day labels (for timesheet grid)
// ============================================================

export const DAY_LABELS = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'] as const;

export const DAY_NUMBERS: Record<string, number> = {
  Mon: 1,
  Tue: 2,
  Wed: 3,
  Thu: 4,
  Fri: 5,
  Sat: 6,
  Sun: 7,
};

// ============================================================
// Default work hours (fallbacks if no payroll_settings)
// ============================================================

export const DEFAULT_WORK_HOURS = {
  startTime: '08:00',
  endTime: '16:00',
  breakMinutes: 30,
  standardDayHours: 7.6,  // Australian full-time standard
} as const;


===== D:\.code\wattleos\src\lib\integrations\google-drive\client.ts =====

// src/lib/integrations/google-drive/client.ts
//
// ============================================================
// WattleOS V2 â€” Google Drive Integration Client
// ============================================================
// Isolated integration module. Handles:
// â€¢ Service account authentication
// â€¢ Portfolio folder provisioning (per student, per year)
// â€¢ File upload (photos, videos, documents)
// â€¢ Folder sharing with parent Google accounts
//
// WHY isolated: Integration code lives in /lib/integrations/
// per the architecture plan. Domain actions call this client;
// the client knows nothing about WattleOS domain types.
//
// DEPENDENCIES: googleapis npm package
// Install: npm install googleapis
// ============================================================

import { google } from 'googleapis';
import type { drive_v3 } from 'googleapis';

// ============================================================
// Types
// ============================================================

export interface GoogleDriveCredentials {
  service_account_email: string;
  private_key: string;
  /** The shared Drive or top-level folder where all school portfolios live */
  root_folder_id: string;
}

export interface GoogleDriveSettings {
  /** Folder naming pattern. Supports: {student_name}, {year} */
  folder_name_template: string;
  /** Whether to auto-share folders with parent Google accounts */
  auto_share_with_parents: boolean;
}

export interface ProvisionFolderResult {
  folder_id: string;
  folder_url: string;
}

export interface UploadFileResult {
  file_id: string;
  file_url: string;
  thumbnail_url: string | null;
}

// ============================================================
// Client Factory
// ============================================================
// Creates an authenticated Google Drive client from a service
// account credential set. Each call creates a fresh client
// (no long-lived connections in serverless).
// ============================================================

export function createDriveClient(
  credentials: GoogleDriveCredentials
): drive_v3.Drive {
  const auth = new google.auth.GoogleAuth({
    credentials: {
      client_email: credentials.service_account_email,
      private_key: credentials.private_key,
    },
    scopes: ['https://www.googleapis.com/auth/drive'],
  });

  return google.drive({ version: 'v3', auth });
}

// ============================================================
// PROVISION PORTFOLIO FOLDER
// ============================================================
// Creates a folder structure:
//   Root Folder / {Student Name} / {Year}
//
// Idempotent: if the student folder already exists, returns it.
// The year subfolder is always created fresh (one per academic year).
// ============================================================

export async function provisionPortfolioFolder(
  drive: drive_v3.Drive,
  rootFolderId: string,
  studentName: string,
  year: number
): Promise<ProvisionFolderResult> {
  // 1. Find or create student folder under root
  const studentFolderId = await findOrCreateFolder(
    drive,
    rootFolderId,
    studentName
  );

  // 2. Find or create year subfolder
  const yearFolderName = `${year}`;
  const yearFolderId = await findOrCreateFolder(
    drive,
    studentFolderId,
    yearFolderName
  );

  return {
    folder_id: yearFolderId,
    folder_url: `https://drive.google.com/drive/folders/${yearFolderId}`,
  };
}

// ============================================================
// UPLOAD FILE TO FOLDER
// ============================================================
// Uploads a file (image, video, document) to a specific folder.
// Returns the file ID and web view link.
// ============================================================

export async function uploadFileToDrive(
  drive: drive_v3.Drive,
  folderId: string,
  fileName: string,
  mimeType: string,
  fileBuffer: Buffer
): Promise<UploadFileResult> {
  const { Readable } = await import('stream');

  const response = await drive.files.create({
    requestBody: {
      name: fileName,
      parents: [folderId],
      mimeType,
    },
    media: {
      mimeType,
      body: Readable.from(fileBuffer),
    },
    fields: 'id, webViewLink, thumbnailLink',
  });

  const fileId = response.data.id!;
  const fileUrl = response.data.webViewLink ?? `https://drive.google.com/file/d/${fileId}/view`;
  const thumbnailUrl = response.data.thumbnailLink ?? null;

  return {
    file_id: fileId,
    file_url: fileUrl,
    thumbnail_url: thumbnailUrl,
  };
}

// ============================================================
// SHARE FOLDER WITH USER
// ============================================================
// Grants reader access to a Google account (parent's email).
// Silently succeeds if already shared.
// ============================================================

export async function shareFolderWithUser(
  drive: drive_v3.Drive,
  folderId: string,
  email: string,
  role: 'reader' | 'writer' = 'reader'
): Promise<void> {
  try {
    await drive.permissions.create({
      fileId: folderId,
      requestBody: {
        type: 'user',
        role,
        emailAddress: email,
      },
      sendNotificationEmail: false,
    });
  } catch (err: unknown) {
    // If already shared, Google returns 400 â€” we can ignore this
    const error = err as { code?: number };
    if (error.code !== 400) {
      throw err;
    }
  }
}

// ============================================================
// DELETE FILE FROM DRIVE
// ============================================================
// Moves a file to trash (recoverable). Used when an observation
// media attachment is deleted.
// ============================================================

export async function trashDriveFile(
  drive: drive_v3.Drive,
  fileId: string
): Promise<void> {
  await drive.files.update({
    fileId,
    requestBody: { trashed: true },
  });
}

// ============================================================
// LIST FILES IN FOLDER
// ============================================================
// Returns files in a portfolio folder. Used for the portfolio
// view to show all media for a student's year.
// ============================================================

export async function listFolderFiles(
  drive: drive_v3.Drive,
  folderId: string
): Promise<Array<{ id: string; name: string; mimeType: string; size: string; webViewLink: string; thumbnailLink: string | null }>> {
  const response = await drive.files.list({
    q: `'${folderId}' in parents and trashed = false`,
    fields: 'files(id, name, mimeType, size, webViewLink, thumbnailLink)',
    orderBy: 'createdTime desc',
    pageSize: 100,
  });

  return (response.data.files ?? []).map((f) => ({
    id: f.id!,
    name: f.name!,
    mimeType: f.mimeType!,
    size: f.size ?? '0',
    webViewLink: f.webViewLink ?? `https://drive.google.com/file/d/${f.id}/view`,
    thumbnailLink: f.thumbnailLink ?? null,
  }));
}

// ============================================================
// HELPER: Find or create a folder by name under a parent
// ============================================================

async function findOrCreateFolder(
  drive: drive_v3.Drive,
  parentId: string,
  folderName: string
): Promise<string> {
  // Search for existing folder
  const searchResponse = await drive.files.list({
    q: `'${parentId}' in parents and name = '${folderName.replace(/'/g, "\\'")}' and mimeType = 'application/vnd.google-apps.folder' and trashed = false`,
    fields: 'files(id)',
    pageSize: 1,
  });

  if (searchResponse.data.files && searchResponse.data.files.length > 0) {
    return searchResponse.data.files[0].id!;
  }

  // Create new folder
  const createResponse = await drive.files.create({
    requestBody: {
      name: folderName,
      parents: [parentId],
      mimeType: 'application/vnd.google-apps.folder',
    },
    fields: 'id',
  });

  return createResponse.data.id!;
}


===== D:\.code\wattleos\src\lib\integrations\pdf\client.ts =====

// src/lib/integrations/pdf/client.ts
//
// ============================================================
// WattleOS V2 â€” PDF Generation Client
// ============================================================
// Thin wrapper around @react-pdf/renderer that converts a
// ReportContent object into a PDF Buffer.
//
// WHY isolated: Keeps the heavy @react-pdf dependency in one
// place. If we ever switch to puppeteer/wkhtmltopdf/etc., only
// this file changes.
// ============================================================

import React from "react";
import { renderToBuffer } from "@react-pdf/renderer";
import type { DocumentProps } from "@react-pdf/renderer";

import { ReportDocument } from "./report-renderer";
import type { ReportContent } from "./report-renderer";

export type { ReportContent };

/**
 * Renders a student report to a PDF buffer.
 *
 * @param content - The assembled report content (from student_reports.content JSONB)
 * @returns Buffer containing the PDF bytes
 * @throws Error if rendering fails
 */
export async function renderReportPdf(content: ReportContent): Promise<Buffer> {
  try {
    // NOTE:
    // @react-pdf/renderer types `renderToBuffer` as requiring a ReactElement<DocumentProps>
    // (i.e. the <Document /> element itself).
    //
    // Our `ReportDocument` is a component that *returns* <Document />, but TypeScript
    // cannot prove that, so we cast to the expected element type.
    const doc = React.createElement(ReportDocument, { content }) as unknown as React.ReactElement<DocumentProps>;

    const bufferLike = await renderToBuffer(doc);

    // Some versions return ArrayBufferLike; normalize to Buffer
    return Buffer.isBuffer(bufferLike) ? bufferLike : Buffer.from(bufferLike as any);
  } catch (err) {
    const message = err instanceof Error ? err.message : "Unknown PDF rendering error";
    throw new Error(`PDF generation failed: ${message}`);
  }
}

/**
 * Generates a safe filename for a student report PDF.
 *
 * Format: StudentName_Term_Report.pdf
 * Example: Emily_Chen_Term_1_2026_Report.pdf
 */
export function generateReportFilename(content: ReportContent): string {
  const safeName = content.student_name
    .replace(/[^a-zA-Z0-9\s]/g, "")
    .replace(/\s+/g, "_");
  const safeTerm = content.term
    .replace(/[^a-zA-Z0-9\s]/g, "")
    .replace(/\s+/g, "_");
  return `${safeName}_${safeTerm}_Report.pdf`;
}

/**
 * Generates the Supabase Storage path for a report PDF.
 *
 * Path: reports/{tenant_id}/{student_id}/{report_id}.pdf
 * WHY: Mirrors the Google Drive folder hierarchy. Tenant-scoped
 * at the top level for easy bucket RLS.
 */
export function generateReportStoragePath(params: {
  tenantId: string;
  studentId: string;
  reportId: string;
}): string {
  return `reports/${params.tenantId}/${params.studentId}/${params.reportId}.pdf`;
}



===== D:\.code\wattleos\src\lib\integrations\pdf\report-renderer.tsx =====

// src/lib/integrations/pdf/report-renderer.tsx
//
// ============================================================
// WattleOS V2 - PDF Report Renderer
// ============================================================
// Renders a StudentReport's JSONB content into a professional
// PDF using @react-pdf/renderer. This runs server-side only.
//
// WHY @react-pdf/renderer: Pure Node.js, no browser/puppeteer
// dependency, React component model matches our stack, produces
// high-quality vector PDFs with embedded fonts.
// ============================================================

import React from 'react';
import {
  Document,
  Page,
  Text,
  View,
  StyleSheet,
  Font,
} from '@react-pdf/renderer';

// ============================================================
// Types for the report content JSONB structure
// ============================================================

/** A single observation excerpt included in the report */
interface ReportObservation {
  date: string;
  content: string;
  outcomes: string[];
  author_name: string;
}

/** Mastery summary for a curriculum area */
interface ReportMasteryArea {
  area_name: string;
  items: Array<{
    outcome_title: string;
    status: 'not_started' | 'presented' | 'practicing' | 'mastered';
  }>;
}

/** Attendance summary stats */
interface ReportAttendance {
  total_days: number;
  present: number;
  absent: number;
  late: number;
  excused: number;
  attendance_rate: number;
}

/** The full rendered report content structure stored in student_reports.content */
export interface ReportContent {
  student_name: string;
  student_dob?: string;
  class_name?: string;
  term: string;
  school_name: string;
  school_logo_url?: string;
  author_name: string;
  report_date: string;
  narrative?: string;
  sections?: Array<{
    title: string;
    body: string;
  }>;
  observations?: ReportObservation[];
  mastery_summary?: ReportMasteryArea[];
  attendance?: ReportAttendance;
  teacher_comments?: string;
  goals?: string;
}

// ============================================================
// Styles - Warm Montessori aesthetic
// ============================================================

const WATTLE_AMBER = '#D97706';
const WATTLE_AMBER_LIGHT = '#FEF3C7';
const WATTLE_GREEN = '#059669';
const TEXT_PRIMARY = '#1F2937';
const TEXT_SECONDARY = '#6B7280';
const BORDER_COLOR = '#E5E7EB';

const MASTERY_COLORS: Record<string, string> = {
  not_started: '#9CA3AF',
  presented: '#3B82F6',
  practicing: '#D97706',
  mastered: '#059669',
};

const MASTERY_LABELS: Record<string, string> = {
  not_started: 'Not Started',
  presented: 'Presented',
  practicing: 'Practicing',
  mastered: 'Mastered',
};

const styles = StyleSheet.create({
  page: {
    padding: 50,
    fontSize: 10,
    fontFamily: 'Helvetica',
    color: TEXT_PRIMARY,
    lineHeight: 1.6,
  },
  // Header
  header: {
    marginBottom: 30,
    borderBottom: `2 solid ${WATTLE_AMBER}`,
    paddingBottom: 15,
  },
  schoolName: {
    fontSize: 18,
    fontFamily: 'Helvetica-Bold',
    color: WATTLE_AMBER,
    marginBottom: 4,
  },
  reportTitle: {
    fontSize: 14,
    fontFamily: 'Helvetica-Bold',
    color: TEXT_PRIMARY,
    marginBottom: 2,
  },
  reportSubtitle: {
    fontSize: 10,
    color: TEXT_SECONDARY,
  },
  // Student info bar
  studentInfoBar: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    backgroundColor: WATTLE_AMBER_LIGHT,
    padding: 12,
    borderRadius: 4,
    marginBottom: 20,
  },
  studentInfoItem: {
    flexDirection: 'column',
  },
  studentInfoLabel: {
    fontSize: 8,
    color: TEXT_SECONDARY,
    textTransform: 'uppercase' as const,
    letterSpacing: 0.5,
    marginBottom: 2,
  },
  studentInfoValue: {
    fontSize: 11,
    fontFamily: 'Helvetica-Bold',
    color: TEXT_PRIMARY,
  },
  // Sections
  sectionTitle: {
    fontSize: 13,
    fontFamily: 'Helvetica-Bold',
    color: WATTLE_AMBER,
    marginTop: 20,
    marginBottom: 8,
    borderBottom: `1 solid ${BORDER_COLOR}`,
    paddingBottom: 4,
  },
  bodyText: {
    fontSize: 10,
    lineHeight: 1.7,
    color: TEXT_PRIMARY,
    marginBottom: 8,
  },
  // Observations
  observationCard: {
    backgroundColor: '#F9FAFB',
    borderLeft: `3 solid ${WATTLE_GREEN}`,
    padding: 10,
    marginBottom: 8,
    borderRadius: 2,
  },
  observationDate: {
    fontSize: 8,
    color: TEXT_SECONDARY,
    marginBottom: 3,
  },
  observationContent: {
    fontSize: 9.5,
    lineHeight: 1.6,
    color: TEXT_PRIMARY,
    marginBottom: 4,
  },
  observationOutcomes: {
    fontSize: 8,
    color: WATTLE_GREEN,
    fontFamily: 'Helvetica-Oblique',
  },
  // Mastery table
  masteryArea: {
    marginBottom: 12,
  },
  masteryAreaTitle: {
    fontSize: 11,
    fontFamily: 'Helvetica-Bold',
    color: TEXT_PRIMARY,
    marginBottom: 4,
  },
  masteryRow: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    paddingVertical: 3,
    paddingHorizontal: 6,
    borderBottom: `0.5 solid ${BORDER_COLOR}`,
  },
  masteryRowAlt: {
    backgroundColor: '#F9FAFB',
  },
  masteryOutcome: {
    fontSize: 9,
    color: TEXT_PRIMARY,
    flex: 1,
  },
  masteryStatus: {
    fontSize: 8,
    fontFamily: 'Helvetica-Bold',
    paddingVertical: 2,
    paddingHorizontal: 6,
    borderRadius: 8,
  },
  // Attendance
  attendanceGrid: {
    flexDirection: 'row',
    flexWrap: 'wrap',
    gap: 8,
    marginBottom: 12,
  },
  attendanceStat: {
    width: '30%',
    backgroundColor: '#F9FAFB',
    padding: 10,
    borderRadius: 4,
    alignItems: 'center',
  },
  attendanceNumber: {
    fontSize: 18,
    fontFamily: 'Helvetica-Bold',
    color: TEXT_PRIMARY,
  },
  attendanceLabel: {
    fontSize: 8,
    color: TEXT_SECONDARY,
    marginTop: 2,
  },
  attendanceRate: {
    width: '100%',
    backgroundColor: WATTLE_AMBER_LIGHT,
    padding: 12,
    borderRadius: 4,
    alignItems: 'center',
    marginTop: 4,
  },
  attendanceRateNumber: {
    fontSize: 24,
    fontFamily: 'Helvetica-Bold',
    color: WATTLE_AMBER,
  },
  // Footer
  footer: {
    position: 'absolute',
    bottom: 30,
    left: 50,
    right: 50,
    borderTop: `1 solid ${BORDER_COLOR}`,
    paddingTop: 8,
    flexDirection: 'row',
    justifyContent: 'space-between',
  },
  footerText: {
    fontSize: 7,
    color: TEXT_SECONDARY,
  },
  // Teacher comments / goals
  commentBox: {
    backgroundColor: '#F9FAFB',
    border: `1 solid ${BORDER_COLOR}`,
    padding: 12,
    borderRadius: 4,
    marginBottom: 12,
  },
  commentLabel: {
    fontSize: 9,
    fontFamily: 'Helvetica-Bold',
    color: TEXT_SECONDARY,
    marginBottom: 4,
    textTransform: 'uppercase' as const,
    letterSpacing: 0.5,
  },
  commentText: {
    fontSize: 10,
    lineHeight: 1.7,
    color: TEXT_PRIMARY,
  },
  // Signature area
  signatureArea: {
    marginTop: 30,
    flexDirection: 'row',
    justifyContent: 'space-between',
  },
  signatureLine: {
    width: '40%',
    borderTop: `1 solid ${TEXT_PRIMARY}`,
    paddingTop: 4,
  },
  signatureLabel: {
    fontSize: 8,
    color: TEXT_SECONDARY,
  },
});

// ============================================================
// Component: Student Info Bar
// ============================================================

function StudentInfoBar({ content }: { content: ReportContent }) {
  return (
    <View style={styles.studentInfoBar}>
      <View style={styles.studentInfoItem}>
        <Text style={styles.studentInfoLabel}>Student</Text>
        <Text style={styles.studentInfoValue}>{content.student_name}</Text>
      </View>
      {content.class_name && (
        <View style={styles.studentInfoItem}>
          <Text style={styles.studentInfoLabel}>Class</Text>
          <Text style={styles.studentInfoValue}>{content.class_name}</Text>
        </View>
      )}
      <View style={styles.studentInfoItem}>
        <Text style={styles.studentInfoLabel}>Term</Text>
        <Text style={styles.studentInfoValue}>{content.term}</Text>
      </View>
      {content.student_dob && (
        <View style={styles.studentInfoItem}>
          <Text style={styles.studentInfoLabel}>Date of Birth</Text>
          <Text style={styles.studentInfoValue}>{content.student_dob}</Text>
        </View>
      )}
    </View>
  );
}

// ============================================================
// Component: Narrative Sections
// ============================================================

function NarrativeSections({ content }: { content: ReportContent }) {
  return (
    <>
      {content.narrative && (
        <>
          <Text style={styles.sectionTitle}>Overview</Text>
          <Text style={styles.bodyText}>{content.narrative}</Text>
        </>
      )}
      {content.sections?.map((section, i) => (
        <View key={i} wrap={false}>
          <Text style={styles.sectionTitle}>{section.title}</Text>
          <Text style={styles.bodyText}>{section.body}</Text>
        </View>
      ))}
    </>
  );
}

// ============================================================
// Component: Observations Section
// ============================================================

function ObservationsSection({ observations }: { observations: ReportObservation[] }) {
  if (observations.length === 0) return null;

  return (
    <>
      <Text style={styles.sectionTitle}>Selected Observations</Text>
      {observations.map((obs, i) => (
        <View key={i} style={styles.observationCard} wrap={false}>
          <Text style={styles.observationDate}>
            {obs.date} - {obs.author_name}
          </Text>
          <Text style={styles.observationContent}>{obs.content}</Text>
          {obs.outcomes.length > 0 && (
            <Text style={styles.observationOutcomes}>
              Outcomes: {obs.outcomes.join(', ')}
            </Text>
          )}
        </View>
      ))}
    </>
  );
}

// ============================================================
// Component: Mastery Summary
// ============================================================

function MasterySection({ areas }: { areas: ReportMasteryArea[] }) {
  if (areas.length === 0) return null;

  return (
    <>
      <Text style={styles.sectionTitle}>Curriculum Progress</Text>
      {areas.map((area, areaIdx) => (
        <View key={areaIdx} style={styles.masteryArea} wrap={false}>
          <Text style={styles.masteryAreaTitle}>{area.area_name}</Text>
          {area.items.map((item, itemIdx) => (
            <View
              key={itemIdx}
              style={[
                styles.masteryRow,
                itemIdx % 2 === 1 ? styles.masteryRowAlt : {},
              ]}
            >
              <Text style={styles.masteryOutcome}>{item.outcome_title}</Text>
              <Text
                style={[
                  styles.masteryStatus,
                  { color: MASTERY_COLORS[item.status] ?? '#6B7280' },
                ]}
              >
                {MASTERY_LABELS[item.status] ?? item.status}
              </Text>
            </View>
          ))}
        </View>
      ))}
    </>
  );
}

// ============================================================
// Component: Attendance Summary
// ============================================================

function AttendanceSection({ attendance }: { attendance: ReportAttendance }) {
  return (
    <>
      <Text style={styles.sectionTitle}>Attendance Summary</Text>
      <View style={styles.attendanceGrid}>
        <View style={styles.attendanceStat}>
          <Text style={styles.attendanceNumber}>{attendance.total_days}</Text>
          <Text style={styles.attendanceLabel}>Total Days</Text>
        </View>
        <View style={styles.attendanceStat}>
          <Text style={styles.attendanceNumber}>{attendance.present}</Text>
          <Text style={styles.attendanceLabel}>Present</Text>
        </View>
        <View style={styles.attendanceStat}>
          <Text style={styles.attendanceNumber}>{attendance.absent}</Text>
          <Text style={styles.attendanceLabel}>Absent</Text>
        </View>
        <View style={styles.attendanceStat}>
          <Text style={styles.attendanceNumber}>{attendance.late}</Text>
          <Text style={styles.attendanceLabel}>Late</Text>
        </View>
        <View style={styles.attendanceStat}>
          <Text style={styles.attendanceNumber}>{attendance.excused}</Text>
          <Text style={styles.attendanceLabel}>Excused</Text>
        </View>
      </View>
      <View style={styles.attendanceRate}>
        <Text style={styles.attendanceRateNumber}>
          {attendance.attendance_rate}%
        </Text>
        <Text style={styles.attendanceLabel}>Attendance Rate</Text>
      </View>
    </>
  );
}

// ============================================================
// Component: Teacher Comments & Goals
// ============================================================

function CommentsAndGoals({ content }: { content: ReportContent }) {
  return (
    <>
      {content.teacher_comments && (
        <View style={styles.commentBox} wrap={false}>
          <Text style={styles.commentLabel}>Teacher Comments</Text>
          <Text style={styles.commentText}>{content.teacher_comments}</Text>
        </View>
      )}
      {content.goals && (
        <View style={styles.commentBox} wrap={false}>
          <Text style={styles.commentLabel}>Goals for Next Term</Text>
          <Text style={styles.commentText}>{content.goals}</Text>
        </View>
      )}
    </>
  );
}

// ============================================================
// Main Document Component
// ============================================================

export function ReportDocument({ content }: { content: ReportContent }) {
  return (
    <Document
      title={`${content.student_name} - ${content.term} Report`}
      author={content.author_name}
      subject={`Student Report for ${content.student_name}`}
      creator="WattleOS"
    >
      <Page size="A4" style={styles.page}>
        {/* Header */}
        <View style={styles.header}>
          <Text style={styles.schoolName}>{content.school_name}</Text>
          <Text style={styles.reportTitle}>
            Student Report - {content.term}
          </Text>
          <Text style={styles.reportSubtitle}>
            Prepared by {content.author_name} Â· {content.report_date}
          </Text>
        </View>

        {/* Student Info */}
        <StudentInfoBar content={content} />

        {/* Narrative / Custom Sections */}
        <NarrativeSections content={content} />

        {/* Observations */}
        {content.observations && content.observations.length > 0 && (
          <ObservationsSection observations={content.observations} />
        )}

        {/* Mastery */}
        {content.mastery_summary && content.mastery_summary.length > 0 && (
          <MasterySection areas={content.mastery_summary} />
        )}

        {/* Attendance */}
        {content.attendance && (
          <AttendanceSection attendance={content.attendance} />
        )}

        {/* Comments & Goals */}
        <CommentsAndGoals content={content} />

        {/* Signature Area */}
        <View style={styles.signatureArea}>
          <View style={styles.signatureLine}>
            <Text style={styles.signatureLabel}>Guide / Teacher</Text>
          </View>
          <View style={styles.signatureLine}>
            <Text style={styles.signatureLabel}>Head of School</Text>
          </View>
        </View>

        {/* Footer */}
        <View style={styles.footer} fixed>
          <Text style={styles.footerText}>
            {content.school_name} Â· {content.term}
          </Text>
          <Text style={styles.footerText}>
            Generated by WattleOS Â· Confidential
          </Text>
          <Text
            style={styles.footerText}
            render={({ pageNumber, totalPages }) =>
              `Page ${pageNumber} of ${totalPages}`
            }
          />
        </View>
      </Page>
    </Document>
  );
}


===== D:\.code\wattleos\src\lib\integrations\stripe\client.ts =====

// src/lib/integrations/stripe/client.ts
//
// ============================================================
// WattleOS V2 â€” Stripe Integration Client
// ============================================================
// Isolated integration module. Handles:
// â€¢ Customer creation (parent â†’ Stripe Customer)
// â€¢ Invoice creation and finalization
// â€¢ Checkout session for payment method setup
// â€¢ Refunds
//
// DEPENDENCY: npm install stripe
// ============================================================

import Stripe from 'stripe';

// ============================================================
// Types
// ============================================================

export interface StripeCredentials {
  secret_key: string;
  publishable_key: string;
  webhook_secret: string;
}

export interface CreateCustomerInput {
  email: string;
  name: string;
  metadata?: Record<string, string>;
}

export interface CreateInvoiceInput {
  customer_id: string;
  line_items: Array<{
    description: string;
    amount_cents: number;
    quantity: number;
  }>;
  currency: string;
  due_date: number; // Unix timestamp
  metadata?: Record<string, string>;
  auto_advance?: boolean;
}

export interface CreateCheckoutInput {
  customer_id: string;
  success_url: string;
  cancel_url: string;
  mode: 'setup'; // For saving payment methods
}

// ============================================================
// Client Factory
// ============================================================

export function createStripeClient(secretKey: string): Stripe {
  return new Stripe(secretKey, {
    // Either omit apiVersion entirely, OR set it to your accountâ€™s version.
    // apiVersion: "2026-01-28.clover",
    typescript: true,
  });
}




// ============================================================
// CUSTOMER OPERATIONS
// ============================================================

export async function createCustomer(
  stripe: Stripe,
  input: CreateCustomerInput
): Promise<Stripe.Customer> {
  return stripe.customers.create({
    email: input.email,
    name: input.name,
    metadata: input.metadata ?? {},
  });
}

export async function getCustomer(
  stripe: Stripe,
  customerId: string
): Promise<Stripe.Customer | null> {
  try {
    const customer = await stripe.customers.retrieve(customerId);
    if (customer.deleted) return null;
    return customer as Stripe.Customer;
  } catch {
    return null;
  }
}

// ============================================================
// INVOICE OPERATIONS
// ============================================================

export async function createInvoice(
  stripe: Stripe,
  input: CreateInvoiceInput
): Promise<Stripe.Invoice> {
  // 1. Create invoice
  const invoice = await stripe.invoices.create({
    customer: input.customer_id,
    currency: input.currency,
    due_date: input.due_date,
    auto_advance: input.auto_advance ?? false,
    collection_method: 'send_invoice',
    metadata: input.metadata ?? {},
  });

  // 2. Add line items
  for (const item of input.line_items) {
    await stripe.invoiceItems.create({
      customer: input.customer_id,
      invoice: invoice.id,
      description: item.description,
      amount: item.amount_cents,
      currency: input.currency,
      quantity: item.quantity,
    });
  }

  return invoice;
}

export async function finalizeInvoice(
  stripe: Stripe,
  invoiceId: string
): Promise<Stripe.Invoice> {
  return stripe.invoices.finalizeInvoice(invoiceId);
}

export async function sendInvoice(
  stripe: Stripe,
  invoiceId: string
): Promise<Stripe.Invoice> {
  return stripe.invoices.sendInvoice(invoiceId);
}

export async function voidInvoice(
  stripe: Stripe,
  invoiceId: string
): Promise<Stripe.Invoice> {
  return stripe.invoices.voidInvoice(invoiceId);
}

// ============================================================
// PAYMENT METHOD SETUP
// ============================================================
// Creates a Stripe Checkout Session in 'setup' mode.
// The parent is redirected to Stripe's hosted page to save
// their card. No payment is taken â€” just card details stored.
// ============================================================

export async function createSetupCheckout(
  stripe: Stripe,
  input: CreateCheckoutInput
): Promise<Stripe.Checkout.Session> {
  return stripe.checkout.sessions.create({
    customer: input.customer_id,
    mode: 'setup',
    payment_method_types: ['card'],
    success_url: input.success_url,
    cancel_url: input.cancel_url,
  });
}

// ============================================================
// REFUNDS
// ============================================================

export async function createRefund(
  stripe: Stripe,
  paymentIntentId: string,
  amountCents?: number,
  reason?: string
): Promise<Stripe.Refund> {
  return stripe.refunds.create({
    payment_intent: paymentIntentId,
    amount: amountCents, // undefined = full refund
    reason: (reason as Stripe.RefundCreateParams.Reason) ?? 'requested_by_customer',
  });
}

// ============================================================
// WEBHOOK VERIFICATION
// ============================================================
export function verifyWebhookSignature(
  payload: string | Buffer,
  signature: string,
  secret: string
): Stripe.Event {
  // Keep this consistent with createStripeClient (or omit apiVersion).
  const stripe = new Stripe("", {
    // apiVersion: "2026-01-28.clover",
  });
  return stripe.webhooks.constructEvent(payload, signature, secret);
}


===== D:\.code\wattleos\src\lib\reports\types.ts =====

// src/lib/reports/types.ts
//
// ============================================================
// WattleOS V2 â€” Report Template & Content Types
// ============================================================
// Defines the JSONB structure stored in report_templates.content
// and student_reports.content. These types are the contract
// between the template builder UI, the report generator, and
// the report editor.
//
// WHY JSONB: Report templates are inherently flexible â€” every
// school wants different sections, orderings, and data pulls.
// A rigid relational schema would require migrations for every
// new section type. JSONB with TypeScript types gives us
// flexibility + type safety at the application layer.
// ============================================================

// ============================================================
// Template Section Types
// ============================================================
// Each section type determines:
//   1. What data gets auto-populated when generating a report
//   2. What's editable by the teacher
//   3. How it renders in the report viewer / PDF

export type TemplateSectionType =
  | 'student_info'           // Auto: student name, class, DOB, photo
  | 'narrative'              // Manual: teacher writes free-text prose
  | 'mastery_grid'           // Auto: mastery statuses for a curriculum area
  | 'mastery_summary'        // Auto: counts/percentages of mastery progress
  | 'attendance_summary'     // Auto: attendance stats for the reporting period
  | 'observation_highlights' // Semi-auto: recent observations, teacher can curate
  | 'custom_text'            // Manual: freeform section (e.g., goals, social development)
  | 'goals';                 // Manual: teacher sets goals for next term

// ============================================================
// Template Section
// ============================================================
// A single section within a report template. Schools build
// templates by composing these sections in order.

export interface TemplateSection {
  /** Stable UUID for this section â€” survives reordering */
  id: string;
  /** What kind of section this is */
  type: TemplateSectionType;
  /** Section heading displayed in the report */
  title: string;
  /** Display order (0-indexed) */
  order: number;
  /** Type-specific configuration */
  config: TemplateSectionConfig;
}

// ============================================================
// Section Config (type-specific settings)
// ============================================================

export interface TemplateSectionConfig {
  // â”€â”€ mastery_grid / mastery_summary â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  /** Filter to a specific curriculum area title, or 'all' */
  curriculumAreaFilter?: string;
  /** Which curriculum instance to pull from */
  curriculumInstanceId?: string;
  /** For mastery_summary: show as percentage or counts */
  displayMode?: 'percentage' | 'counts' | 'both';

  // â”€â”€ observation_highlights â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  /** Max observations to auto-include */
  maxObservations?: number;
  /** Only include published observations */
  publishedOnly?: boolean;

  // â”€â”€ attendance_summary â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  /** Show daily breakdown vs totals only */
  showDetails?: boolean;

  // â”€â”€ narrative / custom_text / goals â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  /** Hint text shown to the teacher when writing */
  placeholder?: string;
  /** Suggested minimum word count (guidance, not enforced) */
  suggestedMinWords?: number;
}

// ============================================================
// Template Content (stored in report_templates.content)
// ============================================================

export interface TemplateContent {
  /** Schema version for future migrations */
  version: 1;
  /** Ordered list of sections that compose this template */
  sections: TemplateSection[];
}

// ============================================================
// Default template for new templates
// ============================================================

export function createDefaultTemplateContent(): TemplateContent {
  return {
    version: 1,
    sections: [
      {
        id: crypto.randomUUID(),
        type: 'student_info',
        title: 'Student Information',
        order: 0,
        config: {},
      },
      {
        id: crypto.randomUUID(),
        type: 'attendance_summary',
        title: 'Attendance Summary',
        order: 1,
        config: { showDetails: false },
      },
      {
        id: crypto.randomUUID(),
        type: 'mastery_summary',
        title: 'Learning Progress',
        order: 2,
        config: { curriculumAreaFilter: 'all', displayMode: 'both' },
      },
      {
        id: crypto.randomUUID(),
        type: 'narrative',
        title: 'Teacher Comments',
        order: 3,
        config: {
          placeholder: 'Write about the student\'s progress, strengths, and areas for growth...',
          suggestedMinWords: 50,
        },
      },
      {
        id: crypto.randomUUID(),
        type: 'goals',
        title: 'Goals for Next Term',
        order: 4,
        config: {
          placeholder: 'Outline learning goals and focus areas for the upcoming term...',
        },
      },
    ],
  };
}

// ============================================================
// Report Section Content (stored in student_reports.content)
// ============================================================
// When a report is generated from a template, each template
// section becomes a report section. Auto sections get populated
// with data; manual sections start empty for the teacher to fill.

export interface ReportSectionContent {
  /** Links back to the template section this was generated from */
  templateSectionId: string;
  /** Section type (copied from template for rendering) */
  type: TemplateSectionType;
  /** Section title (copied from template, editable) */
  title: string;
  /** Display order */
  order: number;

  // â”€â”€ Auto-populated data â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  /** Data pulled from the system at generation time */
  autoData?: ReportAutoData;

  // â”€â”€ Teacher-editable content â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  /** Free-text narrative written by the teacher */
  narrative?: string;

  // â”€â”€ Workflow tracking â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  /** Whether the teacher has reviewed/completed this section */
  completed: boolean;
}

// ============================================================
// Auto-populated data shapes
// ============================================================

export interface ReportAutoData {
  // â”€â”€ student_info â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  studentInfo?: {
    firstName: string;
    lastName: string;
    preferredName: string | null;
    dob: string | null;
    photoUrl: string | null;
    className: string | null;
    cycleLevelName: string | null;
    enrollmentStatus: string;
  };

  // â”€â”€ mastery_grid â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  masteryGrid?: Array<{
    nodeId: string;
    nodeTitle: string;
    nodeLevel: string;
    parentTitle: string | null;
    status: string;
  }>;

  // â”€â”€ mastery_summary â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  masterySummary?: {
    total: number;
    notStarted: number;
    presented: number;
    practicing: number;
    mastered: number;
    percentMastered: number;
  };

  // â”€â”€ attendance_summary â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  attendanceSummary?: {
    totalDays: number;
    present: number;
    absent: number;
    late: number;
    excused: number;
    halfDay: number;
    attendanceRate: number; // percentage
  };

  // â”€â”€ observation_highlights â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  observationHighlights?: Array<{
    id: string;
    content: string | null;
    createdAt: string;
    authorName: string;
    outcomes: string[];
    mediaCount: number;
  }>;
}

// ============================================================
// Report Content (stored in student_reports.content)
// ============================================================

export interface ReportContent {
  /** Schema version */
  version: 1;
  /** Frozen snapshot of the template at generation time */
  templateSnapshot: TemplateContent;
  /** Generated/edited sections */
  sections: ReportSectionContent[];
  /** Metadata about the reporting period */
  reportingPeriod?: {
    startDate: string;
    endDate: string;
    termLabel: string;
  };
}

// ============================================================
// Section type metadata (used by the template builder UI)
// ============================================================

export interface SectionTypeInfo {
  type: TemplateSectionType;
  label: string;
  description: string;
  icon: string;
  /** Whether this section auto-populates data */
  isAutoPopulated: boolean;
  /** Whether the teacher writes content in this section */
  isEditable: boolean;
  /** Can this section appear multiple times in a template? */
  allowMultiple: boolean;
}

export const SECTION_TYPE_CATALOG: SectionTypeInfo[] = [
  {
    type: 'student_info',
    label: 'Student Information',
    description: 'Auto-populated student details: name, class, date of birth, photo',
    icon: 'user',
    isAutoPopulated: true,
    isEditable: false,
    allowMultiple: false,
  },
  {
    type: 'narrative',
    label: 'Narrative / Teacher Comments',
    description: 'Free-text area for the teacher to write about the student',
    icon: 'edit',
    isAutoPopulated: false,
    isEditable: true,
    allowMultiple: true,
  },
  {
    type: 'mastery_grid',
    label: 'Mastery Grid',
    description: 'Detailed mastery statuses for curriculum outcomes in an area',
    icon: 'grid',
    isAutoPopulated: true,
    isEditable: false,
    allowMultiple: true,
  },
  {
    type: 'mastery_summary',
    label: 'Mastery Summary',
    description: 'Progress counts and percentages across curriculum areas',
    icon: 'chart',
    isAutoPopulated: true,
    isEditable: false,
    allowMultiple: true,
  },
  {
    type: 'attendance_summary',
    label: 'Attendance Summary',
    description: 'Attendance statistics for the reporting period',
    icon: 'clipboard',
    isAutoPopulated: true,
    isEditable: false,
    allowMultiple: false,
  },
  {
    type: 'observation_highlights',
    label: 'Observation Highlights',
    description: 'Key observations from the term, auto-selected or teacher-curated',
    icon: 'eye',
    isAutoPopulated: true,
    isEditable: true,
    allowMultiple: false,
  },
  {
    type: 'custom_text',
    label: 'Custom Section',
    description: 'A freeform text section with a custom title',
    icon: 'file-text',
    isAutoPopulated: false,
    isEditable: true,
    allowMultiple: true,
  },
  {
    type: 'goals',
    label: 'Goals for Next Term',
    description: 'Teacher-set learning goals for the upcoming period',
    icon: 'target',
    isAutoPopulated: false,
    isEditable: true,
    allowMultiple: false,
  },
];

// ============================================================
// Helpers
// ============================================================

/** Get the catalog entry for a section type */
export function getSectionTypeInfo(type: TemplateSectionType): SectionTypeInfo | undefined {
  return SECTION_TYPE_CATALOG.find((s) => s.type === type);
}

/** Check if a template content object is valid */
export function validateTemplateContent(content: unknown): content is TemplateContent {
  if (!content || typeof content !== 'object') return false;
  const c = content as Record<string, unknown>;
  if (c.version !== 1) return false;
  if (!Array.isArray(c.sections)) return false;
  for (const section of c.sections as unknown[]) {
    if (!section || typeof section !== 'object') return false;
    const s = section as Record<string, unknown>;
    if (typeof s.id !== 'string') return false;
    if (typeof s.type !== 'string') return false;
    if (typeof s.title !== 'string') return false;
    if (typeof s.order !== 'number') return false;
  }
  return true;
}


===== D:\.code\wattleos\src\lib\supabase\browser.ts =====

// ============================================================
// WattleOS V2 â€” Supabase Browser Client
// ============================================================
// Used in 'use client' components for real-time subscriptions
// and client-side queries. Singleton pattern to avoid creating
// multiple GoTrue clients.
// ============================================================

import { createBrowserClient } from '@supabase/ssr';

let client: ReturnType<typeof createBrowserClient> | null = null;

export function createSupabaseBrowserClient() {
  if (client) return client;

  client = createBrowserClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
  );

  return client;
}


===== D:\.code\wattleos\src\lib\supabase\middleware.ts =====

// src/lib/supabase/middleware.ts

import { createServerClient } from '@supabase/ssr';
import type { CookieOptions } from '@supabase/ssr';
import { NextRequest, NextResponse } from 'next/server';

/**
 * Supabase SSR middleware passes cookies as:
 *   setAll([{ name, value, options }, ...])
 *
 * We type it locally to satisfy noImplicitAny.
 */
type CookieToSet = {
  name: string;
  value: string;
  options?: CookieOptions;
};

export async function updateSession(request: NextRequest) {
  let supabaseResponse = NextResponse.next({
    request,
  });

  const supabase = createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        getAll() {
          return request.cookies.getAll();
        },
        setAll(cookiesToSet: CookieToSet[]) {
          // Write cookies onto the *request* (so downstream handlers see them)
          cookiesToSet.forEach(({ name, value }: CookieToSet) => {
            request.cookies.set(name, value);
          });

          // Recreate the response so the updated request is carried forward
          supabaseResponse = NextResponse.next({
            request,
          });

          // Also write cookies onto the *response* (so the browser persists them)
          cookiesToSet.forEach(({ name, value, options }: CookieToSet) => {
            supabaseResponse.cookies.set(name, value, options);
          });
        },
      },
    }
  );

  // Refresh the session - critical for keeping the JWT valid
  const {
    data: { user },
  } = await supabase.auth.getUser();

  return { supabaseResponse, user, supabase };
}



===== D:\.code\wattleos\src\lib\supabase\server.ts =====

// src/lib/supabase/server.ts

// ============================================================
// WattleOS V2 - Supabase Server Client
// ============================================================
// Used in Server Components and Server Actions.
// Creates a new client per request using cookie-based auth.
// ============================================================

import { createServerClient } from "@supabase/ssr";
import { cookies } from "next/headers";
import type { CookieSerializeOptions } from "cookie";

/**
 * Supabase SSR will call setAll([{ name, value, options }, ...])
 * We type it locally to satisfy noImplicitAny.
 */
type CookieToSet = {
  name: string;
  value: string;
  options?: CookieSerializeOptions;
};

export async function createSupabaseServerClient() {
  const cookieStore = await cookies();

  return createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        getAll() {
          return cookieStore.getAll();
        },
        setAll(cookiesToSet: CookieToSet[]) {
          try {
            cookiesToSet.forEach(
              ({ name, value, options }: CookieToSet) => {
                // Next's cookieStore.set accepts (name, value, options)
                cookieStore.set(name, value, options);
              }
            );
          } catch {
            // setAll is called from Server Components where cookies
            // can't be set. Safe to ignore; middleware handles refresh.
          }
        },
      },
    }
  );
}

// ============================================================
// Admin Client (service role - bypasses RLS)
// ============================================================

import { createClient } from "@supabase/supabase-js";

export function createSupabaseAdminClient() {
  return createClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.SUPABASE_SERVICE_ROLE_KEY!,
    {
      auth: {
        autoRefreshToken: false,
        persistSession: false,
      },
    }
  );
}



===== D:\.code\wattleos\src\lib\utils\curriculum-tree.ts =====

import type { CurriculumNode } from '@/types/domain';

// ============================================================
// CurriculumTreeNode
// ============================================================
// A curriculum node with its children nested.
// Used for rendering the tree UI.
// ============================================================
export interface CurriculumTreeNode extends CurriculumNode {
  children: CurriculumTreeNode[];
}

// ============================================================
// buildTree
// ============================================================
// Takes a flat array of curriculum_nodes from the database
// and builds a nested tree structure.
// ============================================================
export function buildTree(nodes: CurriculumNode[]): CurriculumTreeNode[] {
  const nodeMap = new Map<string, CurriculumTreeNode>();
  const roots: CurriculumTreeNode[] = [];

  // First pass: wrap each node with an empty children array
  for (const node of nodes) {
    nodeMap.set(node.id, { ...node, children: [] });
  }

  // Second pass: link children to parents
  for (const node of nodes) {
    const treeNode = nodeMap.get(node.id)!;

    if (node.parent_id && nodeMap.has(node.parent_id)) {
      nodeMap.get(node.parent_id)!.children.push(treeNode);
    } else {
      roots.push(treeNode);
    }
  }

  // Sort children by sequence_order at every level
  function sortChildren(node: CurriculumTreeNode): void {
    node.children.sort((a, b) => a.sequence_order - b.sequence_order);
    node.children.forEach(sortChildren);
  }

  roots.sort((a, b) => a.sequence_order - b.sequence_order);
  roots.forEach(sortChildren);

  return roots;
}

// ============================================================
// countNodes
// ============================================================
// Counts total nodes in a tree (recursive)
// ============================================================
export function countNodes(nodes: CurriculumTreeNode[]): number {
  let count = 0;
  for (const node of nodes) {
    count += 1 + countNodes(node.children);
  }
  return count;
}

// ============================================================
// flattenTree
// ============================================================
// Flattens a tree back into a list (for search highlighting)
// ============================================================
export function flattenTree(nodes: CurriculumTreeNode[]): CurriculumNode[] {
  const result: CurriculumNode[] = [];
  for (const node of nodes) {
    result.push(node);
    result.push(...flattenTree(node.children));
  }
  return result;
}

// ============================================================
// LEVEL_CONFIG
// ============================================================
// Display configuration for each curriculum level.
// ============================================================
export const LEVEL_CONFIG: Record<
  string,
  { label: string; color: string; bgColor: string; indent: number; addChildLabel: string; addChildLevel: string | null }
> = {
  area: {
    label: 'Area',
    color: 'text-purple-700',
    bgColor: 'bg-purple-50 border-purple-200',
    indent: 0,
    addChildLabel: 'Add Strand',
    addChildLevel: 'strand',
  },
  strand: {
    label: 'Strand',
    color: 'text-blue-700',
    bgColor: 'bg-blue-50 border-blue-200',
    indent: 1,
    addChildLabel: 'Add Outcome',
    addChildLevel: 'outcome',
  },
  outcome: {
    label: 'Outcome',
    color: 'text-green-700',
    bgColor: 'bg-green-50 border-green-200',
    indent: 2,
    addChildLabel: 'Add Activity',
    addChildLevel: 'activity',
  },
  activity: {
    label: 'Activity',
    color: 'text-amber-700',
    bgColor: 'bg-amber-50 border-amber-200',
    indent: 3,
    addChildLabel: '',
    addChildLevel: null,
  },
};



===== D:\.code\wattleos\src\lib\utils\image-compression.ts =====

// src/lib/utils/image-compression.ts
//
// ============================================================
// WattleOS V2 â€” Client-Side Image Compression
// ============================================================
// Uses canvas to resize and compress images before upload.
// No external dependencies â€” runs in the browser only.
//
// WHY: Phone cameras produce 5â€“15MB photos. Supabase free-tier
// storage is limited, and uploading large files on school Wi-Fi
// is painful. We compress to â‰¤2MB (configurable) before upload.
// ============================================================

interface CompressOptions {
  /** Maximum width or height in pixels. Default: 1920. */
  maxDimension?: number;
  /** Target file size in bytes. Default: 2MB (2_097_152). */
  maxSizeBytes?: number;
  /** Initial JPEG quality (0â€“1). Default: 0.85. */
  initialQuality?: number;
  /** Minimum JPEG quality before giving up. Default: 0.4. */
  minQuality?: number;
  /** Output MIME type. Default: 'image/jpeg'. */
  outputType?: 'image/jpeg' | 'image/webp';
}

const DEFAULT_OPTIONS: Required<CompressOptions> = {
  maxDimension: 1920,
  maxSizeBytes: 2_097_152, // 2MB
  initialQuality: 0.85,
  minQuality: 0.4,
  outputType: 'image/jpeg',
};

/**
 * Compress an image File using canvas.
 *
 * Strategy:
 * 1. If the file is already under maxSizeBytes AND under maxDimension, return as-is.
 * 2. Draw to canvas at maxDimension, export at initialQuality.
 * 3. If still over maxSizeBytes, iteratively lower quality until minQuality.
 * 4. Return the compressed File (preserving original filename).
 */
export async function compressImage(
  file: File,
  options?: CompressOptions
): Promise<File> {
  const opts = { ...DEFAULT_OPTIONS, ...options };

  // Skip non-image files
  if (!file.type.startsWith('image/')) {
    return file;
  }

  // Skip if already small enough (quick check before decoding)
  if (file.size <= opts.maxSizeBytes) {
    // Still might need to resize, so check dimensions
    const needsResize = await imageDimensionsExceed(file, opts.maxDimension);
    if (!needsResize) {
      return file;
    }
  }

  // Load image into an HTMLImageElement
  const img = await loadImage(file);

  // Calculate target dimensions (maintain aspect ratio)
  const { width, height } = calculateDimensions(
    img.naturalWidth,
    img.naturalHeight,
    opts.maxDimension
  );

  // Draw to canvas
  const canvas = document.createElement('canvas');
  canvas.width = width;
  canvas.height = height;
  const ctx = canvas.getContext('2d');
  if (!ctx) {
    // Canvas not available (SSR safety) â€” return original
    return file;
  }
  ctx.drawImage(img, 0, 0, width, height);

  // Export at decreasing quality until under target size
  let quality = opts.initialQuality;
  let blob = await canvasToBlob(canvas, opts.outputType, quality);

  while (blob.size > opts.maxSizeBytes && quality > opts.minQuality) {
    quality -= 0.05;
    blob = await canvasToBlob(canvas, opts.outputType, quality);
  }

  // Build a new File with the original name (but correct extension)
  const ext = opts.outputType === 'image/webp' ? '.webp' : '.jpg';
  const nameBase = file.name.replace(/\.[^.]+$/, '');
  const compressedFile = new File([blob], `${nameBase}${ext}`, {
    type: opts.outputType,
    lastModified: Date.now(),
  });

  return compressedFile;
}

// ============================================================
// Internal helpers
// ============================================================

function loadImage(file: File): Promise<HTMLImageElement> {
  return new Promise((resolve, reject) => {
    const img = new Image();
    img.onload = () => {
      URL.revokeObjectURL(img.src);
      resolve(img);
    };
    img.onerror = () => {
      URL.revokeObjectURL(img.src);
      reject(new Error(`Failed to load image: ${file.name}`));
    };
    img.src = URL.createObjectURL(file);
  });
}

function calculateDimensions(
  origWidth: number,
  origHeight: number,
  maxDimension: number
): { width: number; height: number } {
  if (origWidth <= maxDimension && origHeight <= maxDimension) {
    return { width: origWidth, height: origHeight };
  }

  const ratio = Math.min(maxDimension / origWidth, maxDimension / origHeight);
  return {
    width: Math.round(origWidth * ratio),
    height: Math.round(origHeight * ratio),
  };
}

function canvasToBlob(
  canvas: HTMLCanvasElement,
  type: string,
  quality: number
): Promise<Blob> {
  return new Promise((resolve, reject) => {
    canvas.toBlob(
      (blob) => {
        if (blob) {
          resolve(blob);
        } else {
          reject(new Error('Canvas toBlob returned null'));
        }
      },
      type,
      quality
    );
  });
}

async function imageDimensionsExceed(
  file: File,
  maxDimension: number
): Promise<boolean> {
  try {
    const img = await loadImage(file);
    return img.naturalWidth > maxDimension || img.naturalHeight > maxDimension;
  } catch {
    return false;
  }
}


===== D:\.code\wattleos\src\lib\utils\index.ts =====

// ============================================================
// WattleOS V2 â€” Utility Functions
// ============================================================
// Pure functions with no side effects. Used across modules.
// ============================================================

/**
 * Format a student's display name.
 * Prefers preferred_name over first_name.
 */
export function formatStudentName(
  firstName: string,
  lastName: string,
  preferredName?: string | null
): string {
  const displayFirst = preferredName || firstName;
  return `${displayFirst} ${lastName}`;
}

/**
 * Format a full name from first + last.
 */
export function formatFullName(
  firstName: string | null | undefined,
  lastName: string | null | undefined
): string {
  return [firstName, lastName].filter(Boolean).join(' ') || 'Unknown';
}

/**
 * Calculate age from date of birth.
 */
export function calculateAge(dob: string | null): number | null {
  if (!dob) return null;
  const birth = new Date(dob);
  const today = new Date();
  let age = today.getFullYear() - birth.getFullYear();
  const monthDiff = today.getMonth() - birth.getMonth();
  if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
    age--;
  }
  return age;
}

/**
 * Format a date string for display (AU format: DD/MM/YYYY).
 */
export function formatDate(dateStr: string | null | undefined): string {
  if (!dateStr) return 'â€”';
  const date = new Date(dateStr);
  return date.toLocaleDateString('en-AU', {
    day: '2-digit',
    month: '2-digit',
    year: 'numeric',
  });
}

/**
 * Format a datetime string for display.
 */
export function formatDateTime(dateStr: string | null | undefined): string {
  if (!dateStr) return 'â€”';
  const date = new Date(dateStr);
  return date.toLocaleDateString('en-AU', {
    day: '2-digit',
    month: '2-digit',
    year: 'numeric',
    hour: '2-digit',
    minute: '2-digit',
  });
}

/**
 * Validate pagination parameters and clamp to safe ranges.
 */
export function validatePagination(
  page: unknown,
  perPage: unknown,
  maxPerPage: number = 100
): { page: number; perPage: number; offset: number } {
  const safePage = Math.max(1, Number(page) || 1);
  const safePerPage = Math.min(maxPerPage, Math.max(1, Number(perPage) || 20));
  return {
    page: safePage,
    perPage: safePerPage,
    offset: (safePage - 1) * safePerPage,
  };
}

/**
 * Clamp a string to a maximum length, appending ellipsis if truncated.
 */
export function truncate(str: string | null | undefined, maxLength: number = 100): string {
  if (!str) return '';
  if (str.length <= maxLength) return str;
  return str.slice(0, maxLength - 1) + 'â€¦';
}

/**
 * Get severity badge color for medical conditions.
 */
export function severityColor(severity: string): string {
  switch (severity) {
    case 'life_threatening':
      return 'bg-red-100 text-red-800 border-red-200';
    case 'severe':
      return 'bg-orange-100 text-orange-800 border-orange-200';
    case 'moderate':
      return 'bg-yellow-100 text-yellow-800 border-yellow-200';
    case 'mild':
      return 'bg-green-100 text-green-800 border-green-200';
    default:
      return 'bg-gray-100 text-gray-800 border-gray-200';
  }
}

/**
 * Get enrollment status badge color.
 */
export function enrollmentStatusColor(status: string): string {
  switch (status) {
    case 'active':
      return 'bg-green-100 text-green-800 border-green-200';
    case 'inquiry':
      return 'bg-blue-100 text-blue-800 border-blue-200';
    case 'applicant':
      return 'bg-purple-100 text-purple-800 border-purple-200';
    case 'withdrawn':
      return 'bg-gray-100 text-gray-800 border-gray-200';
    case 'graduated':
      return 'bg-amber-100 text-amber-800 border-amber-200';
    default:
      return 'bg-gray-100 text-gray-800 border-gray-200';
  }
}


===== D:\.code\wattleos\src\lib\utils\mastery-status.ts =====

import type { MasteryStatus } from '@/types/domain';

// ============================================================
// MASTERY_STATUS_CONFIG
// ============================================================
// Display configuration for each mastery status.
// Used consistently across the mastery grid, heatmap, timeline,
// and any other UI that renders mastery status.
// ============================================================
export const MASTERY_STATUS_CONFIG: Record<
  MasteryStatus,
  {
    label: string;
    shortLabel: string;
    color: string;
    bgColor: string;
    borderColor: string;
    dotColor: string;
    heatmapColor: string;
    description: string;
  }
> = {
  not_started: {
    label: 'Not Started',
    shortLabel: 'NS',
    color: 'text-gray-500',
    bgColor: 'bg-gray-100',
    borderColor: 'border-gray-200',
    dotColor: 'bg-gray-300',
    heatmapColor: '#e5e7eb', // gray-200
    description: 'Student has not been introduced to this material',
  },
  presented: {
    label: 'Presented',
    shortLabel: 'P',
    color: 'text-blue-700',
    bgColor: 'bg-blue-100',
    borderColor: 'border-blue-200',
    dotColor: 'bg-blue-500',
    heatmapColor: '#93c5fd', // blue-300
    description: 'Guide has given the initial lesson/presentation',
  },
  practicing: {
    label: 'Practicing',
    shortLabel: 'Pr',
    color: 'text-amber-700',
    bgColor: 'bg-amber-100',
    borderColor: 'border-amber-200',
    dotColor: 'bg-amber-500',
    heatmapColor: '#fcd34d', // amber-300
    description: 'Student is working with the material independently',
  },
  mastered: {
    label: 'Mastered',
    shortLabel: 'M',
    color: 'text-green-700',
    bgColor: 'bg-green-100',
    borderColor: 'border-green-200',
    dotColor: 'bg-green-500',
    heatmapColor: '#86efac', // green-300
    description: 'Student demonstrates consistent, independent competence',
  },
};

// ============================================================
// Status progression order (used for cycling through statuses)
// ============================================================
export const MASTERY_STATUS_ORDER: MasteryStatus[] = [
  'not_started',
  'presented',
  'practicing',
  'mastered',
];

// ============================================================
// Get next status in the progression cycle
// ============================================================
export function getNextMasteryStatus(current: MasteryStatus): MasteryStatus {
  const index = MASTERY_STATUS_ORDER.indexOf(current);
  return MASTERY_STATUS_ORDER[(index + 1) % MASTERY_STATUS_ORDER.length];
}

// ============================================================
// Calculate mastery percentage (for progress bars)
// ============================================================
export function masteryPercentage(counts: {
  total: number;
  mastered: number;
  practicing: number;
  presented: number;
}): number {
  if (counts.total === 0) return 0;
  // Weighted: mastered = 100%, practicing = 66%, presented = 33%
  const weighted =
    counts.mastered * 1 + counts.practicing * 0.66 + counts.presented * 0.33;
  return Math.round((weighted / counts.total) * 100);
}



===== D:\.code\wattleos\src\proxy.ts =====

import { NextRequest, NextResponse } from 'next/server';
import { updateSession } from '@/lib/supabase/middleware';

// Routes that don't require authentication
const PUBLIC_ROUTES = ['/login', '/auth/callback', '/'];

// Routes that are part of the marketing site
const MARKETING_ROUTES = ['/', '/pricing', '/features', '/about', '/contact'];

export async function proxy(request: NextRequest) {
  const { pathname } = request.nextUrl;

  // Skip middleware for static files and API routes that handle their own auth
  if (
    pathname.startsWith('/_next') ||
    pathname.startsWith('/api/webhooks') ||
    pathname.includes('.')
  ) {
    return NextResponse.next();
  }

  // Refresh the Supabase session (critical for JWT validity)
  const { supabaseResponse, user } = await updateSession(request);

  // Determine if this is a tenant subdomain
  const hostname = request.headers.get('host') ?? '';
  const rootDomain = process.env.NEXT_PUBLIC_ROOT_DOMAIN ?? 'wattleos.com';
  const isSubdomain =
    hostname !== rootDomain &&
    hostname !== `www.${rootDomain}` &&
    !hostname.startsWith('localhost') &&
    !hostname.startsWith('127.0.0.1');

  // Extract tenant slug from subdomain (e.g., "green-valley" from "green-valley.wattleos.com")
  let tenantSlug: string | null = null;
  if (isSubdomain) {
    tenantSlug = hostname.split('.')[0];
  }

  // Marketing routes on root domain - no auth required
  if (!isSubdomain && MARKETING_ROUTES.includes(pathname)) {
    return supabaseResponse;
  }

  // Public routes - no auth required
  if (PUBLIC_ROUTES.includes(pathname)) {
    return supabaseResponse;
  }

  // Everything below requires authentication
  if (!user) {
    const loginUrl = request.nextUrl.clone();
    loginUrl.pathname = '/login';
    loginUrl.searchParams.set('redirect', pathname);
    return NextResponse.redirect(loginUrl);
  }

  // If on a subdomain, set the tenant slug as a header for downstream use
  if (tenantSlug) {
    supabaseResponse.headers.set('x-tenant-slug', tenantSlug);
  }

  // If user has no tenant_id in their JWT, redirect to tenant picker
  // (unless they're already on the tenant picker page)
  const tenantId = user.app_metadata?.tenant_id;
  if (!tenantId && pathname !== '/tenant-picker') {
    const pickerUrl = request.nextUrl.clone();
    pickerUrl.pathname = '/tenant-picker';
    return NextResponse.redirect(pickerUrl);
  }

  return supabaseResponse;
}

export const config = {
  matcher: [
    // Match all routes except static files
    '/((?!_next/static|_next/image|favicon.ico|.*\\.(?:svg|png|jpg|jpeg|gif|webp)$).*)',
  ],
};



===== D:\.code\wattleos\src\types\api.ts =====

// ============================================================
// WattleOS V2 - API Response Types
// ============================================================
// Every Server Action returns one of these shapes.
// No Action throws. No error fails silently.
// The calling component always checks both fields.
// ============================================================

// ============================================================
// Error Codes
// ============================================================
// Standardized error codes used across all Server Actions.
// Actions use these as the `code` field in error responses.
// UI can match on these to show contextual error messages.
// ============================================================

export const ErrorCodes = {
  // Auth & Access
  UNAUTHORIZED: 'UNAUTHORIZED',
  FORBIDDEN: 'FORBIDDEN',
  TENANT_NOT_FOUND: 'TENANT_NOT_FOUND',
  PERMISSION_DENIED: 'PERMISSION_DENIED',

  // Validation
  VALIDATION_ERROR: 'VALIDATION_ERROR',
  INVALID_INPUT: 'INVALID_INPUT',
  MISSING_REQUIRED_FIELD: 'MISSING_REQUIRED_FIELD',

  // CRUD
  NOT_FOUND: 'NOT_FOUND',
  ALREADY_EXISTS: 'ALREADY_EXISTS',
  CREATE_FAILED: 'CREATE_FAILED',
  UPDATE_FAILED: 'UPDATE_FAILED',
  DELETE_FAILED: 'DELETE_FAILED',

  // Curriculum
  FORK_FAILED: 'FORK_FAILED',
  TEMPLATE_NOT_FOUND: 'TEMPLATE_NOT_FOUND',
  INSTANCE_NOT_FOUND: 'INSTANCE_NOT_FOUND',
  NODE_NOT_FOUND: 'NODE_NOT_FOUND',
  REORDER_FAILED: 'REORDER_FAILED',

  // Observations
  OBSERVATION_NOT_FOUND: 'OBSERVATION_NOT_FOUND',
  PUBLISH_FAILED: 'PUBLISH_FAILED',
  ARCHIVE_FAILED: 'ARCHIVE_FAILED',
  ALREADY_PUBLISHED: 'ALREADY_PUBLISHED',
  CONSENT_WARNING: 'CONSENT_WARNING',

  // Mastery
  MASTERY_UPDATE_FAILED: 'MASTERY_UPDATE_FAILED',
  INVALID_STATUS_TRANSITION: 'INVALID_STATUS_TRANSITION',

  // Students & SIS
  STUDENT_NOT_FOUND: 'STUDENT_NOT_FOUND',
  CLASS_NOT_FOUND: 'CLASS_NOT_FOUND',
  ENROLLMENT_FAILED: 'ENROLLMENT_FAILED',
  GUARDIAN_NOT_FOUND: 'GUARDIAN_NOT_FOUND',

  // Attendance
  ATTENDANCE_ALREADY_RECORDED: 'ATTENDANCE_ALREADY_RECORDED',
  ATTENDANCE_UPDATE_FAILED: 'ATTENDANCE_UPDATE_FAILED',

  // Reporting
  REPORT_NOT_FOUND: 'REPORT_NOT_FOUND',
  TEMPLATE_RENDER_FAILED: 'TEMPLATE_RENDER_FAILED',

  // Integrations
  INTEGRATION_ERROR: 'INTEGRATION_ERROR',
  SYNC_FAILED: 'SYNC_FAILED',

  // Generic
  UNKNOWN_ERROR: 'UNKNOWN_ERROR',
  DATABASE_ERROR: 'DATABASE_ERROR',
  INTERNAL_ERROR: 'INTERNAL_ERROR',
} as const;

export type ErrorCode = typeof ErrorCodes[keyof typeof ErrorCodes];

// ============================================================
// Response Types
// ============================================================

export interface ActionResponse<T> {
  data: T | null;
  error: {
    message: string;
    code: string;
  } | null;
}

export interface PaginatedResponse<T> {
  data: T[];
  pagination: {
    total: number;
    page: number;
    per_page: number;
    total_pages: number;
  };
  error: {
    message: string;
    code: string;
  } | null;
}

// ============================================================
// Helper: Create success/error responses
// ============================================================

export function success<T>(data: T): ActionResponse<T> {
  return { data, error: null };
}

export function failure<T = never>(message: string, code: string = ErrorCodes.UNKNOWN_ERROR): ActionResponse<T> {
  return { data: null, error: { message, code } };
}

export function paginated<T>(
  data: T[],
  total: number,
  page: number,
  perPage: number
): PaginatedResponse<T> {
  return {
    data,
    pagination: {
      total,
      page,
      per_page: perPage,
      total_pages: Math.ceil(total / perPage),
    },
    error: null,
  };
}

export function paginatedFailure<T = never>(message: string, code: string = ErrorCodes.UNKNOWN_ERROR): PaginatedResponse<T> {
  return {
    data: [],
    pagination: { total: 0, page: 1, per_page: 20, total_pages: 0 },
    error: { message, code },
  };
}


===== D:\.code\wattleos\src\types\display.ts =====

// src/types/display.ts
//
// ============================================================
// WattleOS V2 â€” Display & Theme Configuration Types
// ============================================================
// Shared types for the configurable design system.
//
// THREE LAYERS OF CONFIGURATION:
//   1. Platform defaults (hardcoded in globals.css + here)
//   2. Tenant settings (admin configures via tenants.settings.display)
//   3. User preferences (individual override via tenant_users.display_preferences)
//
// Resolution order: user pref > tenant setting > platform default
// ============================================================

// ============================================================
// Enums / Unions
// ============================================================

export type DensityMode = "compact" | "comfortable" | "spacious";
export type FontScale = "sm" | "base" | "lg" | "xl";
export type ThemeMode = "light" | "dark" | "system";

export const DENSITY_OPTIONS: {
  value: DensityMode;
  label: string;
  description: string;
}[] = [
  {
    value: "compact",
    label: "Compact",
    description: "Denser layout â€” fits more on screen",
  },
  {
    value: "comfortable",
    label: "Comfortable",
    description: "Balanced spacing â€” the default",
  },
  {
    value: "spacious",
    label: "Spacious",
    description: "More breathing room â€” larger touch targets",
  },
];

export const FONT_SCALE_OPTIONS: { value: FontScale; label: string }[] = [
  { value: "sm", label: "Small" },
  { value: "base", label: "Default" },
  { value: "lg", label: "Large" },
  { value: "xl", label: "Extra Large" },
];

export const THEME_OPTIONS: { value: ThemeMode; label: string }[] = [
  { value: "light", label: "Light" },
  { value: "dark", label: "Dark" },
  { value: "system", label: "System" },
];

// ============================================================
// Tenant Display Settings (Admin-configured, per-school)
// ============================================================
// Stored in: tenants.settings.display (JSONB)
// Set by: Admin in School Settings > Appearance
// Permission: manage_tenant_settings
// ============================================================

export interface TenantDisplaySettings {
  /** Brand hue override (0-360). null = use default wattle amber (38) */
  brandHue: number | null;
  /** Brand saturation override (0-100). null = use default (92) */
  brandSaturation: number | null;
  /** Default density for all users in this tenant */
  defaultDensity: DensityMode;
  /** Default theme for all users in this tenant */
  defaultTheme: ThemeMode;
  /** School favicon URL */
  faviconUrl: string | null;
}

export const DEFAULT_TENANT_DISPLAY: TenantDisplaySettings = {
  brandHue: null,
  brandSaturation: null,
  defaultDensity: "comfortable",
  defaultTheme: "light",
  faviconUrl: null,
};

// ============================================================
// User Display Preferences (Per-user override)
// ============================================================
// Stored in: tenant_users.display_preferences (JSONB)
// Set by: User in their profile settings
// ============================================================

export interface UserDisplayPreferences {
  /** Theme override. null = use tenant default */
  theme: ThemeMode | null;
  /** Density override. null = use tenant default */
  density: DensityMode | null;
  /** Font scale override. null = 'base' */
  fontScale: FontScale | null;
  /** Sidebar collapsed by default */
  sidebarCollapsed: boolean;
}

export const DEFAULT_USER_DISPLAY: UserDisplayPreferences = {
  theme: null,
  density: null,
  fontScale: null,
  sidebarCollapsed: false,
};

// ============================================================
// Resolved Display Config
// ============================================================
// Computed from: merge(platform defaults, tenant settings, user prefs)
// This is what layout.tsx actually uses and what gets written
// into the wattle-display cookie.
// ============================================================

export interface ResolvedDisplayConfig {
  theme: ThemeMode;
  density: DensityMode;
  fontScale: FontScale;
  brandHue: number | null;
  brandSaturation: number | null;
  sidebarCollapsed: boolean;
}

export const DEFAULT_RESOLVED_DISPLAY: ResolvedDisplayConfig = {
  theme: "light",
  density: "comfortable",
  fontScale: "base",
  brandHue: null,
  brandSaturation: null,
  sidebarCollapsed: false,
};

/**
 * Resolves the display configuration by merging tenant + user layers.
 * Called in the (app) layout server component after fetching both.
 */
export function resolveDisplayConfig(
  tenant: TenantDisplaySettings | null,
  user: UserDisplayPreferences | null,
): ResolvedDisplayConfig {
  const t = tenant ?? DEFAULT_TENANT_DISPLAY;
  const u = user ?? DEFAULT_USER_DISPLAY;

  return {
    theme: u.theme ?? t.defaultTheme,
    density: u.density ?? t.defaultDensity,
    fontScale: u.fontScale ?? "base",
    brandHue: t.brandHue,
    brandSaturation: t.brandSaturation,
    sidebarCollapsed: u.sidebarCollapsed,
  };
}

/**
 * Parses the raw JSONB from tenants.settings.display into typed form.
 * Returns defaults for any missing or invalid fields.
 */
export function parseTenantDisplaySettings(
  raw: unknown,
): TenantDisplaySettings {
  if (!raw || typeof raw !== "object") return DEFAULT_TENANT_DISPLAY;

  const obj = raw as Record<string, unknown>;

  return {
    brandHue:
      typeof obj.brandHue === "number" &&
      obj.brandHue >= 0 &&
      obj.brandHue <= 360
        ? obj.brandHue
        : null,
    brandSaturation:
      typeof obj.brandSaturation === "number" &&
      obj.brandSaturation >= 0 &&
      obj.brandSaturation <= 100
        ? obj.brandSaturation
        : null,
    defaultDensity: isDensity(obj.defaultDensity)
      ? obj.defaultDensity
      : "comfortable",
    defaultTheme: isTheme(obj.defaultTheme) ? obj.defaultTheme : "light",
    faviconUrl: typeof obj.faviconUrl === "string" ? obj.faviconUrl : null,
  };
}

/**
 * Parses the raw JSONB from tenant_users.display_preferences into typed form.
 */
export function parseUserDisplayPreferences(
  raw: unknown,
): UserDisplayPreferences {
  if (!raw || typeof raw !== "object") return DEFAULT_USER_DISPLAY;

  const obj = raw as Record<string, unknown>;

  return {
    theme: isTheme(obj.theme) ? obj.theme : null,
    density: isDensity(obj.density) ? obj.density : null,
    fontScale: isFontScale(obj.fontScale) ? obj.fontScale : null,
    sidebarCollapsed:
      typeof obj.sidebarCollapsed === "boolean" ? obj.sidebarCollapsed : false,
  };
}

// ============================================================
// Type Guards
// ============================================================

function isDensity(v: unknown): v is DensityMode {
  return v === "compact" || v === "comfortable" || v === "spacious";
}

function isTheme(v: unknown): v is ThemeMode {
  return v === "light" || v === "dark" || v === "system";
}

function isFontScale(v: unknown): v is FontScale {
  return v === "sm" || v === "base" || v === "lg" || v === "xl";
}

// ============================================================
// Cookie Shape
// ============================================================
// The resolved config is serialized to a cookie so the root
// layout (which can't call getTenantContext) can apply it.
// ============================================================

export const DISPLAY_COOKIE_NAME = "wattle-display";
export const DISPLAY_COOKIE_MAX_AGE = 60 * 60 * 24 * 365; // 1 year

/**
 * Serialize resolved config to a cookie-safe JSON string.
 */
export function serializeDisplayCookie(config: ResolvedDisplayConfig): string {
  return JSON.stringify(config);
}

/**
 * Parse a display cookie back to ResolvedDisplayConfig.
 * Returns defaults if parsing fails.
 */
export function parseDisplayCookie(
  cookieValue: string | undefined,
): ResolvedDisplayConfig {
  if (!cookieValue) return DEFAULT_RESOLVED_DISPLAY;

  try {
    const parsed = JSON.parse(cookieValue);
    return {
      theme: isTheme(parsed.theme) ? parsed.theme : "light",
      density: isDensity(parsed.density) ? parsed.density : "comfortable",
      fontScale: isFontScale(parsed.fontScale) ? parsed.fontScale : "base",
      brandHue: typeof parsed.brandHue === "number" ? parsed.brandHue : null,
      brandSaturation:
        typeof parsed.brandSaturation === "number"
          ? parsed.brandSaturation
          : null,
      sidebarCollapsed:
        typeof parsed.sidebarCollapsed === "boolean"
          ? parsed.sidebarCollapsed
          : false,
    };
  } catch {
    return DEFAULT_RESOLVED_DISPLAY;
  }
}

// ============================================================
// Avatar Helpers
// ============================================================

/**
 * Returns a CSS variable name for a deterministic avatar color.
 * Uses the 8-color palette from globals.css (--avatar-0 through --avatar-7).
 */
export function getAvatarColor(name: string): string {
  let hash = 0;
  for (let i = 0; i < name.length; i++) {
    hash = ((hash << 5) - hash + name.charCodeAt(i)) | 0;
  }
  const index = Math.abs(hash) % 8;
  return `var(--avatar-${index})`;
}

/**
 * Returns initials from a name (1-2 characters).
 */
export function getInitials(name: string): string {
  const parts = name.trim().split(/\s+/);
  if (parts.length === 0 || parts[0] === "") return "?";
  if (parts.length === 1) return parts[0].charAt(0).toUpperCase();
  return (parts[0].charAt(0) + parts[parts.length - 1].charAt(0)).toUpperCase();
}



===== D:\.code\wattleos\src\types\domain.ts =====

// ============================================================
// WattleOS V2 â€” Domain Types
// ============================================================
// These types are the contract between the database and the
// application layer. Generated types from Supabase supplement
// these, but these domain types are canonical.
//
// UPDATED: TenantContext now uses nested Tenant/User objects
// matching the actual getTenantContext() implementation.
// ============================================================

// ============================================================
// Enums
// ============================================================

export type PlanTier = 'basic' | 'pro' | 'enterprise';

export type UserStatus = 'active' | 'invited' | 'suspended';

export type CurriculumLevel = 'area' | 'strand' | 'outcome' | 'activity';

export type ObservationStatus = 'draft' | 'published' | 'archived';

export type MasteryStatus = 'not_started' | 'presented' | 'practicing' | 'mastered';

export type EnrollmentStatus = 'inquiry' | 'applicant' | 'active' | 'withdrawn' | 'graduated';

export type AttendanceStatus = 'present' | 'absent' | 'late' | 'excused' | 'half_day';

export type MedicalSeverity = 'mild' | 'moderate' | 'severe' | 'life_threatening';

export type RestrictionType = 'no_contact' | 'no_pickup' | 'supervised_only' | 'no_information';

export type ReportStatus = 'draft' | 'review' | 'approved' | 'published';

export type AnnouncementPriority = 'normal' | 'urgent';

export type AnnouncementTargetType = 'school_wide' | 'class';

export type MessageThreadType = 'class_broadcast' | 'direct';

export type MediaType = 'image' | 'video' | 'audio' | 'document';

export type StorageProvider = 'supabase' | 'google_drive';

// ============================================================
// Core Platform
// ============================================================

export interface Tenant {
  id: string;
  slug: string;
  name: string;
  domain: string | null;
  logo_url: string | null;
  timezone: string;
  country: string;
  currency: string;
  settings: Record<string, unknown>;
  plan_tier: PlanTier;
  is_active: boolean;
  created_at: string;
  updated_at: string;
}

export interface User {
  id: string;
  email: string;
  first_name: string | null;
  last_name: string | null;
  avatar_url: string | null;
  created_at: string;
  updated_at: string;
}

export interface Permission {
  id: string;
  key: string;
  label: string;
  module: string;
  description: string | null;
}

export interface Role {
  id: string;
  tenant_id: string;
  name: string;
  description: string | null;
  is_system: boolean;
  created_at: string;
  updated_at: string;
}

export interface TenantUser {
  id: string;
  tenant_id: string;
  user_id: string;
  role_id: string;
  status: UserStatus;
  created_at: string;
  updated_at: string;
}

// ============================================================
// Tenant Context (returned by getTenantContext)
// ============================================================
// This is the shape returned by getTenantContext() in
// src/lib/auth/tenant-context.ts. It carries the full
// resolved tenant, user, role, and permission keys.
//
// ACCESS PATTERN IN ACTION FILES:
//   const context = await getTenantContext();
//   context.tenant.id    â€” the tenant UUID
//   context.user.id      â€” the authenticated user UUID
//   context.role.name    â€” the role display name
//   context.permissions  â€” string[] of permission keys
// ============================================================
export interface TenantContext {
  tenant: Tenant;
  user: User;
  role: Role;
  permissions: string[];  // Array of permission keys for fast checks
}

// ============================================================
// Curriculum
// ============================================================

export interface CurriculumTemplate {
  id: string;
  name: string;
  framework: string;
  age_range: string | null;
  description: string | null;
  version: number;
  is_active: boolean;
}

export interface CurriculumInstance {
  id: string;
  tenant_id: string;
  source_template_id: string | null;
  name: string;
  description: string | null;
  is_active: boolean;
}

export interface CurriculumNode {
  id: string;
  tenant_id: string;
  instance_id: string;
  parent_id: string | null;
  source_template_node_id: string | null;
  level: CurriculumLevel;
  title: string;
  description: string | null;
  sequence_order: number;
  is_hidden: boolean;
}

export interface CurriculumTemplateNode {
  id: string;
  template_id: string;
  parent_id: string | null;
  level: CurriculumLevel;
  title: string;
  description: string | null;
  sequence_order: number;
}

// ============================================================
// Observations
// ============================================================

export interface Observation {
  id: string;
  tenant_id: string;
  author_id: string;
  content: string | null;
  status: ObservationStatus;
  published_at: string | null;
  created_at: string;
  updated_at: string;
}

export interface ObservationWithRelations extends Observation {
  author: User;
  students: Student[];
  outcomes: CurriculumNode[];
  media: ObservationMedia[];
}

export interface ObservationMedia {
  id: string;
  tenant_id: string;
  observation_id: string;
  media_type: MediaType;
  storage_provider: StorageProvider;
  storage_path: string | null;
  google_drive_file_id: string | null;
  thumbnail_url: string | null;
  file_name: string | null;
  file_size_bytes: number | null;
}
// Flat student shape for observation display
export interface ObservationStudent {
  id: string;
  first_name: string;
  last_name: string;
  preferred_name: string | null;
  photo_url: string | null;
}

// Flat outcome shape for observation display
export interface ObservationOutcome {
  id: string;
  title: string;
  level: string;
}

// Feed item shape â€” returned by getObservationFeed / getObservation.
// Uses flat arrays (unwrapped from Supabase join shape) so UI
// components can access .students, .outcomes, .media directly.
export interface ObservationFeedItem {
  id: string;
  content: string | null;
  status: ObservationStatus;
  published_at: string | null;
  created_at: string;
  author: Pick<User, 'id' | 'first_name' | 'last_name' | 'avatar_url'>;
  students: ObservationStudent[];
  outcomes: ObservationOutcome[];
  media: ObservationMedia[];
}
// ============================================================
// Mastery
// ============================================================

export interface StudentMastery {
  id: string;
  tenant_id: string;
  student_id: string;
  curriculum_node_id: string;
  status: MasteryStatus;
  date_achieved: string | null;
  assessed_by: string | null;
  notes: string | null;
}

export interface MasteryHistoryEntry {
  id: string;
  tenant_id: string;
  student_mastery_id: string;
  student_id: string;
  curriculum_node_id: string;
  previous_status: MasteryStatus | null;
  new_status: MasteryStatus;
  changed_by: string | null;
  changed_at: string;
}

// ============================================================
// Students & SIS
// ============================================================

export interface Student {
  id: string;
  tenant_id: string;
  first_name: string;
  last_name: string;
  preferred_name: string | null;
  dob: string | null;
  gender: string | null;
  photo_url: string | null;
  enrollment_status: EnrollmentStatus;
  notes: string | null;
  // âœ… add these
  created_at: string;
  updated_at: string;
}

export interface StudentWithDetails extends Student {
  enrollments: EnrollmentWithClass[];
  guardians: GuardianWithUser[];
  medical_conditions: MedicalCondition[];
  emergency_contacts: EmergencyContact[];
  custody_restrictions: CustodyRestriction[];
}

export interface Class {
  id: string;
  tenant_id: string;
  name: string;
  room: string | null;
  cycle_level: string | null;
  curriculum_instance_id: string | null;
  is_active: boolean;
}

// Class with computed enrollment count â€” returned by listClasses
export interface ClassWithCounts extends Class {
  active_enrollment_count: number;
}

export interface Enrollment {
  id: string;
  tenant_id: string;
  student_id: string;
  class_id: string;
  start_date: string;
  end_date: string | null;
  status: string;
}

// Enrollment with nested class â€” used in student detail view
export interface EnrollmentWithClass extends Enrollment {
  class: Class;
}

// Enrollment with nested student â€” used in class roster view
export interface EnrollmentWithStudent extends Enrollment {
  student: Student;
}

export interface Guardian {
  id: string;
  tenant_id: string;
  user_id: string;
  student_id: string;
  relationship: string;
  is_primary: boolean;
  is_emergency_contact: boolean;
  pickup_authorized: boolean;
  phone: string | null;
  media_consent: boolean;
  directory_consent: boolean;
}

// Guardian with nested user profile â€” used in student detail view
export interface GuardianWithUser extends Guardian {
  user: Pick<User, 'id' | 'email' | 'first_name' | 'last_name' | 'avatar_url'>;
}

export interface MedicalCondition {
  id: string;
  tenant_id: string;
  student_id: string;
  condition_type: string;
  condition_name: string;
  severity: MedicalSeverity;
  description: string | null;
  action_plan: string | null;
  action_plan_doc_url: string | null;
  requires_medication: boolean;
  medication_name: string | null;
  medication_location: string | null;
  expiry_date: string | null;
}

export interface EmergencyContact {
  id: string;
  tenant_id: string;
  student_id: string;
  name: string;
  relationship: string;
  phone_primary: string;
  phone_secondary: string | null;
  email: string | null;
  priority_order: number;
  notes: string | null;
}

export interface CustodyRestriction {
  id: string;
  tenant_id: string;
  student_id: string;
  restricted_person_name: string;
  restriction_type: RestrictionType;
  court_order_reference: string | null;
  court_order_doc_url: string | null;
  effective_date: string;
  expiry_date: string | null;
  notes: string | null;
}

// ============================================================
// Attendance
// ============================================================

export interface AttendanceRecord {
  id: string;
  tenant_id: string;
  student_id: string;
  class_id: string | null;
  date: string;
  status: AttendanceStatus;
  check_in_at: string | null;
  check_out_at: string | null;
  notes: string | null;
  recorded_by: string | null;
}

export interface PickupAuthorization {
  id: string;
  tenant_id: string;
  student_id: string;
  authorized_name: string;
  relationship: string | null;
  phone: string | null;
  photo_url: string | null;
  is_permanent: boolean;
  valid_from: string | null;
  valid_until: string | null;
  authorized_by: string | null;
}

// ============================================================
// Reporting
// ============================================================

export interface ReportTemplate {
  id: string;
  tenant_id: string;
  name: string;
  content: Record<string, unknown>;
  cycle_level: string | null;
  is_active: boolean;
}

export interface StudentReport {
  id: string;
  tenant_id: string;
  student_id: string;
  template_id: string | null;
  author_id: string;
  term: string | null;
  content: Record<string, unknown>;
  status: ReportStatus;
  published_at: string | null;
  google_doc_id: string | null;
  pdf_storage_path: string | null;
}

// ============================================================
// Audit
// ============================================================

export interface AuditLog {
  id: string;
  tenant_id: string;
  user_id: string | null;
  action: string;
  entity_type: string;
  entity_id: string | null;
  metadata: Record<string, unknown>;
  created_at: string;
}

// ============================================================
// ADDITIONS TO src/types/domain.ts
// ============================================================
// Add these types at the bottom of domain.ts, after the
// Reporting section and before the Audit section.
//
//   
// ============================================================

// ============================================================
// Communications
// ============================================================

export interface Announcement {
  id: string;
  tenant_id: string;
  author_id: string;
  title: string;
  content: string;
  priority: AnnouncementPriority;
  target_type: AnnouncementTargetType;
  target_class_id: string | null;
  is_pinned: boolean;
  published_at: string;
  created_at: string;
  updated_at: string;
}

// Announcement with author info â€” used in feed display
export interface AnnouncementWithAuthor extends Announcement {
  author: Pick<User, 'id' | 'first_name' | 'last_name' | 'avatar_url'>;
  target_class: Pick<Class, 'id' | 'name'> | null;
  read_count?: number;
  is_read?: boolean;
}

export interface AnnouncementRead {
  id: string;
  tenant_id: string;
  announcement_id: string;
  user_id: string;
  read_at: string;
}

export interface MessageThread {
  id: string;
  tenant_id: string;
  subject: string | null;
  thread_type: MessageThreadType;
  class_id: string | null;
  created_by: string;
  created_at: string;
  updated_at: string;
}

// Thread with preview info â€” used in inbox list
export interface MessageThreadWithPreview extends MessageThread {
  creator: Pick<User, 'id' | 'first_name' | 'last_name' | 'avatar_url'>;
  target_class: Pick<Class, 'id' | 'name'> | null;
  last_message: Pick<Message, 'id' | 'content' | 'sent_at' | 'sender_id'> | null;
  last_message_sender: Pick<User, 'id' | 'first_name' | 'last_name'> | null;
  unread_count: number;
  recipient_count: number;
}

export interface Message {
  id: string;
  tenant_id: string;
  thread_id: string;
  sender_id: string;
  content: string;
  sent_at: string;
  created_at: string;
}

// Message with sender info â€” used in thread view
export interface MessageWithSender extends Message {
  sender: Pick<User, 'id' | 'first_name' | 'last_name' | 'avatar_url'>;
}

export interface MessageRecipient {
  id: string;
  tenant_id: string;
  thread_id: string;
  user_id: string;
  read_at: string | null;
  created_at: string;
}

// ============================================================
// DOMAIN_TYPES_ADDITIONS.ts â€” Module 8a Integration Types
// ============================================================
// Merge these into your existing src/types/domain.ts file.
// Add them after the existing Audit section.
// ============================================================

// ============================================================
// Integrations
// ============================================================

export interface IntegrationConfig {
  id: string;
  tenant_id: string;
  provider: string;
  is_enabled: boolean;
  credentials: Record<string, unknown>;
  settings: Record<string, unknown>;
  last_synced_at: string | null;
  created_at: string;
  updated_at: string;
  deleted_at: string | null;
}

export interface IntegrationSyncLog {
  id: string;
  tenant_id: string;
  provider: string;
  operation: string;
  entity_type: string | null;
  entity_id: string | null;
  status: 'success' | 'failure' | 'pending';
  request_data: Record<string, unknown>;
  response_data: Record<string, unknown>;
  error_message: string | null;
  created_at: string;
}

export interface StudentPortfolioFolder {
  id: string;
  tenant_id: string;
  student_id: string;
  drive_folder_id: string;
  drive_folder_url: string | null;
  year: number;
  created_at: string;
  updated_at: string;
  deleted_at: string | null;
}

// ============================================================
// DOMAIN_TYPES_ADDITIONS_8B.ts â€” Module 8b Billing Types
// ============================================================
// Merge these into your existing src/types/domain.ts file.
// Add them after the Integration types from Batch 8a.
// ============================================================

// ============================================================
// Billing â€” Fee Schedules
// ============================================================

export interface FeeSchedule {
  id: string;
  tenant_id: string;
  name: string;
  class_id: string | null;
  amount_cents: number;
  currency: string;
  frequency: string;
  description: string | null;
  is_active: boolean;
  effective_from: string;
  effective_until: string | null;
  created_at: string;
  updated_at: string;
  deleted_at: string | null;
}

// ============================================================
// Billing â€” Invoices
// ============================================================

export interface Invoice {
  id: string;
  tenant_id: string;
  student_id: string;
  guardian_id: string;
  invoice_number: string;
  status: string;
  subtotal_cents: number;
  discount_cents: number;
  tax_cents: number;
  total_cents: number;
  amount_paid_cents: number;
  currency: string;
  due_date: string;
  period_start: string | null;
  period_end: string | null;
  notes: string | null;
  stripe_invoice_id: string | null;
  stripe_payment_intent_id: string | null;
  stripe_hosted_url: string | null;
  sent_at: string | null;
  paid_at: string | null;
  voided_at: string | null;
  created_by: string | null;
  created_at: string;
  updated_at: string;
  deleted_at: string | null;
}

export interface InvoiceWithDetails extends Invoice {
  student: {
    id: string;
    first_name: string;
    last_name: string;
    photo_url: string | null;
  } | null;
  guardian: {
    id: string;
    user_id: string;
    relationship: string;
    user?: {
      id: string;
      first_name: string | null;
      last_name: string | null;
      email: string;
    };
  } | null;
  line_items: InvoiceLineItem[];
}

export interface InvoiceLineItem {
  id: string;
  tenant_id: string;
  invoice_id: string;
  fee_schedule_id: string | null;
  description: string;
  quantity: number;
  unit_amount_cents: number;
  total_cents: number;
  created_at: string;
}

// ============================================================
// Billing â€” Payments
// ============================================================

export interface Payment {
  id: string;
  tenant_id: string;
  invoice_id: string;
  amount_cents: number;
  currency: string;
  status: string;
  payment_method_type: string | null;
  payment_method_last4: string | null;
  stripe_payment_intent_id: string | null;
  stripe_charge_id: string | null;
  failure_reason: string | null;
  refund_amount_cents: number;
  refund_reason: string | null;
  paid_at: string | null;
  created_at: string;
}

// ============================================================
// Billing â€” Stripe Customers
// ============================================================

export interface StripeCustomer {
  id: string;
  tenant_id: string;
  guardian_id: string;
  stripe_customer_id: string;
  email: string | null;
  default_payment_method: string | null;
  created_at: string;
  updated_at: string;
}

// ============================================================
// APPEND TO: src/types/domain.ts
// ============================================================
// Add these types at the bottom of your existing domain.ts file,
// after the AuditLog interface and before the closing comments.
// ============================================================

// ============================================================
// Timesheets & Payroll (Module 9)
// ============================================================

export type PayFrequency = 'weekly' | 'fortnightly' | 'monthly';
export type PayPeriodStatus = 'open' | 'locked' | 'processed';
export type TimeEntryType =
  | 'regular'
  | 'overtime'
  | 'public_holiday'
  | 'sick_leave'
  | 'annual_leave'
  | 'unpaid_leave';
export type TimesheetStatus = 'draft' | 'submitted' | 'approved' | 'rejected' | 'synced';
export type PayrollProvider = 'xero' | 'keypay';

export interface PayPeriod {
  id: string;
  tenant_id: string;
  name: string;
  start_date: string;
  end_date: string;
  frequency: PayFrequency;
  status: PayPeriodStatus;
  locked_at: string | null;
  locked_by: string | null;
}

export interface TimeEntry {
  id: string;
  tenant_id: string;
  user_id: string;
  pay_period_id: string | null;
  date: string;
  start_time: string;
  end_time: string;
  break_minutes: number;
  total_hours: number;
  entry_type: TimeEntryType;
  class_id: string | null;
  notes: string | null;
}

export interface Timesheet {
  id: string;
  tenant_id: string;
  user_id: string;
  pay_period_id: string;
  status: TimesheetStatus;
  total_hours: number;
  regular_hours: number;
  overtime_hours: number;
  leave_hours: number;
  submitted_at: string | null;
  approved_at: string | null;
  approved_by: string | null;
  rejected_at: string | null;
  rejected_by: string | null;
  rejection_notes: string | null;
  synced_at: string | null;
  sync_reference: string | null;
}

export interface TimesheetWithEntries extends Timesheet {
  time_entries: TimeEntry[];
  user: Pick<User, 'id' | 'first_name' | 'last_name' | 'avatar_url'>;
}

export interface EmployeeMapping {
  id: string;
  tenant_id: string;
  user_id: string;
  provider: PayrollProvider;
  external_id: string;
  external_name: string | null;
  is_active: boolean;
  last_synced_at: string | null;
}

export interface PayrollSettings {
  id: string;
  tenant_id: string;
  pay_frequency: PayFrequency;
  pay_cycle_start_day: number;
  default_start_time: string;
  default_end_time: string;
  default_break_minutes: number;
  payroll_provider: PayrollProvider | null;
  provider_config: Record<string, unknown>;
  auto_create_periods: boolean;
}
